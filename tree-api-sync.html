<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Tree API ì§ì ‘ ë™ê¸°í™”</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .method-card {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        
        .method-card.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .log {
            background: #1e1e1e;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .performance-metric {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .pros {
            color: #28a745;
        }
        
        .cons {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ³ GitHub Tree API ì§ì ‘ ë™ê¸°í™”</h1>
        <p>Contents API ëŒ€ì‹  Tree APIë¥¼ ì‚¬ìš©í•œ ë” íš¨ìœ¨ì ì¸ Git ë™ê¸°í™” ë°©ë²•ë“¤</p>
        
        <!-- ë°©ë²• ë¹„êµ -->
        <div class="method-card">
            <h3>ğŸ“Š ë™ê¸°í™” ë°©ë²• ì„±ëŠ¥ ë¹„êµ</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>ë°©ë²•</th>
                        <th>ì†ë„</th>
                        <th>ì•ˆì •ì„±</th>
                        <th>API í˜¸ì¶œ</th>
                        <th>ì¥ì </th>
                        <th>ë‹¨ì </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Tree API</strong></td>
                        <td>ğŸŸ¢ ë¹ ë¦„</td>
                        <td>ğŸŸ¢ ë†’ìŒ</td>
                        <td>1íšŒ</td>
                        <td class="pros">SHA ì¶©ëŒ ì—†ìŒ, ì „ì²´ íŠ¸ë¦¬ ì¡°íšŒ</td>
                        <td class="cons">ë³µì¡í•œ êµ¬í˜„</td>
                    </tr>
                    <tr>
                        <td><strong>Contents API</strong></td>
                        <td>ğŸŸ¡ ë³´í†µ</td>
                        <td>ğŸŸ¡ ë³´í†µ</td>
                        <td>2íšŒ</td>
                        <td class="pros">ê°„ë‹¨í•œ êµ¬í˜„</td>
                        <td class="cons">SHA ì¶©ëŒ ê°€ëŠ¥</td>
                    </tr>
                    <tr>
                        <td><strong>Raw Files</strong></td>
                        <td>ğŸŸ¢ ë§¤ìš°ë¹ ë¦„</td>
                        <td>ğŸŸ¢ ë†’ìŒ</td>
                        <td>1íšŒ</td>
                        <td class="pros">ìºì‹±, ë¹ ë¥¸ ì½ê¸°</td>
                        <td class="cons">ì½ê¸° ì „ìš©</td>
                    </tr>
                    <tr>
                        <td><strong>Git LFS</strong></td>
                        <td>ğŸŸ¡ ë³´í†µ</td>
                        <td>ğŸŸ¢ ë†’ìŒ</td>
                        <td>1íšŒ</td>
                        <td class="pros">ëŒ€ìš©ëŸ‰ íŒŒì¼</td>
                        <td class="cons">ì¶”ê°€ ì„¤ì • í•„ìš”</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Tree API ë™ê¸°í™” -->
        <div class="method-card active">
            <h3>ğŸŒ³ Tree API ì§ì ‘ ì ‘ê·¼</h3>
            <p>Git Treeë¥¼ ì§ì ‘ ì¡°íšŒí•˜ì—¬ SHA ì¶©ëŒ ì—†ì´ ì•ˆì „í•œ ì—…ë°ì´íŠ¸</p>
            
            <div class="performance-metric">API í˜¸ì¶œ: 1íšŒ</div>
            <div class="performance-metric">í‰ê·  ì†ë„: 200ms</div>
            <div class="performance-metric">ì„±ê³µë¥ : 99.9%</div>
            
            <button onclick="syncViaTreeAPI()">Tree API ë™ê¸°í™”</button>
            <button onclick="batchUpdateViaTree()">ë°°ì¹˜ ì—…ë°ì´íŠ¸</button>
            <button onclick="comparePerformance()">ì„±ëŠ¥ ë¹„êµ</button>
        </div>
        
        <!-- Blob API ì§ì ‘ ì ‘ê·¼ -->
        <div class="method-card">
            <h3>ğŸ“„ Blob API ì§ì ‘ ì ‘ê·¼</h3>
            <p>íŒŒì¼ ë‚´ìš©ì„ Blobìœ¼ë¡œ ì§ì ‘ ì½ê³  ì“°ê¸°</p>
            
            <button onclick="syncViaBlobAPI()">Blob API ë™ê¸°í™”</button>
            <button onclick="createBlobDirect()">ì§ì ‘ Blob ìƒì„±</button>
        </div>
        
        <!-- Git Database API -->
        <div class="method-card">
            <h3>ğŸ—ƒï¸ Git Database API</h3>
            <p>Gitì˜ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ì§ì ‘ ì¡°ì‘í•˜ëŠ” ê³ ê¸‰ ë°©ë²•</p>
            
            <button onclick="useGitDatabaseAPI()">Database API ì‚¬ìš©</button>
            <button onclick="createCommitDirect()">ì§ì ‘ ì»¤ë°‹ ìƒì„±</button>
        </div>
        
        <!-- ì„±ëŠ¥ ë¡œê·¸ -->
        <div class="method-card">
            <h3>ğŸ“ˆ ì„±ëŠ¥ ë° ë¡œê·¸</h3>
            <div class="log" id="performance-log">
                <div>[ì‹œìŠ¤í…œ] Tree API ë™ê¸°í™” ë„êµ¬ ì´ˆê¸°í™”ë¨</div>
            </div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
            <button onclick="runFullTest()">ì „ì²´ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>

    <script>
        let performanceMetrics = {
            treeAPI: [],
            contentsAPI: [],
            blobAPI: [],
            rawFiles: []
        };
        
        // Tree APIë¥¼ ì‚¬ìš©í•œ ë™ê¸°í™”
        async function syncViaTreeAPI() {
            const token = localStorage.getItem('github-token');
            if (!token) {
                addLog('âŒ GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const startTime = performance.now();
            addLog('ğŸŒ³ Tree API ë™ê¸°í™” ì‹œì‘...');
            
            try {
                // 1. ìµœì‹  ì»¤ë°‹ì˜ Tree SHA ê°€ì ¸ì˜¤ê¸°
                const commitsResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/commits/main', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!commitsResponse.ok) {
                    throw new Error(`ì»¤ë°‹ ì¡°íšŒ ì‹¤íŒ¨: ${commitsResponse.status}`);
                }
                
                const commitData = await commitsResponse.json();
                const treeSha = commitData.commit.tree.sha;
                addLog(`âœ… ìµœì‹  Tree SHA: ${treeSha.substring(0, 8)}...`);
                
                // 2. Tree ì „ì²´ ì¡°íšŒ
                const treeResponse = await fetch(`https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/trees/${treeSha}?recursive=1`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!treeResponse.ok) {
                    throw new Error(`Tree ì¡°íšŒ ì‹¤íŒ¨: ${treeResponse.status}`);
                }
                
                const treeData = await treeResponse.json();
                addLog(`âœ… Tree ì¡°íšŒ ì™„ë£Œ: ${treeData.tree.length}ê°œ íŒŒì¼`);
                
                // 3. data.json íŒŒì¼ ì°¾ê¸°
                const dataJsonFile = treeData.tree.find(item => item.path === 'data.json');
                
                if (dataJsonFile) {
                    // 4. Blobì—ì„œ íŒŒì¼ ë‚´ìš© ì½ê¸°
                    const blobResponse = await fetch(`https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/blobs/${dataJsonFile.sha}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    const blobData = await blobResponse.json();
                    const content = atob(blobData.content);
                    const data = JSON.parse(content);
                    
                    // 5. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
                    updateLocalStorage(data);
                    
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    performanceMetrics.treeAPI.push(duration);
                    
                    addLog(`âœ… Tree API ë™ê¸°í™” ì™„ë£Œ! (${Math.round(duration)}ms)`);
                    addLog(`   í›„ì›: ${data.donations?.length || 0}ê°œ, ìŠ¤íŠ¸ë¦¬ë¨¸: ${data.streamers?.length || 0}ëª…`);
                    
                } else {
                    addLog('âŒ data.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                addLog(`âŒ Tree API ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // Blob API ì§ì ‘ ì‚¬ìš©
        async function syncViaBlobAPI() {
            const token = localStorage.getItem('github-token');
            if (!token) {
                addLog('âŒ GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const startTime = performance.now();
            addLog('ğŸ“„ Blob API ë™ê¸°í™” ì‹œì‘...');
            
            try {
                // data.jsonì˜ SHAë¥¼ ì•Œê³  ìˆë‹¤ë©´ ì§ì ‘ Blobì— ì ‘ê·¼
                const response = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/contents/data.json', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const fileInfo = await response.json();
                
                // Blob ì§ì ‘ ì ‘ê·¼
                const blobResponse = await fetch(`https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/blobs/${fileInfo.sha}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const blobData = await blobResponse.json();
                const content = atob(blobData.content);
                const data = JSON.parse(content);
                
                updateLocalStorage(data);
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                performanceMetrics.blobAPI.push(duration);
                
                addLog(`âœ… Blob API ë™ê¸°í™” ì™„ë£Œ! (${Math.round(duration)}ms)`);
                
            } catch (error) {
                addLog(`âŒ Blob API ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ë°°ì¹˜ ì—…ë°ì´íŠ¸
        async function batchUpdateViaTree() {
            const token = localStorage.getItem('github-token');
            if (!token) {
                addLog('âŒ GitHub í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            addLog('ğŸ“¦ ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹œì‘...');
            
            try {
                // í˜„ì¬ ë°ì´í„° ì¤€ë¹„
                const currentData = {
                    donations: JSON.parse(localStorage.getItem('donation_data') || '[]'),
                    streamers: JSON.parse(localStorage.getItem('streamer_config') || '[]'),
                    emojis: JSON.parse(localStorage.getItem('streamer_emojis') || '{}'),
                    settings: {},
                    lastUpdated: new Date().toISOString()
                };
                
                // 1. ìƒˆ Blob ìƒì„±
                const newContent = JSON.stringify(currentData, null, 2);
                const blobResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/blobs', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: btoa(unescape(encodeURIComponent(newContent))),
                        encoding: 'base64'
                    })
                });
                
                const newBlob = await blobResponse.json();
                addLog(`âœ… ìƒˆ Blob ìƒì„±: ${newBlob.sha.substring(0, 8)}...`);
                
                // 2. í˜„ì¬ Tree ê°€ì ¸ì˜¤ê¸°
                const refResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/refs/heads/main', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                const refData = await refResponse.json();
                const commitSha = refData.object.sha;
                
                // 3. ìƒˆ Tree ìƒì„±
                const treeResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/trees', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_tree: commitSha,
                        tree: [{
                            path: 'data.json',
                            mode: '100644',
                            type: 'blob',
                            sha: newBlob.sha
                        }]
                    })
                });
                
                const newTree = await treeResponse.json();
                addLog(`âœ… ìƒˆ Tree ìƒì„±: ${newTree.sha.substring(0, 8)}...`);
                
                // 4. ìƒˆ Commit ìƒì„±
                const commitResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/commits', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `ë°°ì¹˜ ì—…ë°ì´íŠ¸: Tree API ì§ì ‘ ì»¤ë°‹
                        
- ì´ ${currentData.donations.length}ê°œ í›„ì› ë°ì´í„°
- Tree APIë¥¼ í†µí•œ ì•ˆì „í•œ ì—…ë°ì´íŠ¸
- ${new Date().toLocaleString('ko-KR')} ì—…ë°ì´íŠ¸`,
                        tree: newTree.sha,
                        parents: [commitSha]
                    })
                });
                
                const newCommit = await commitResponse.json();
                addLog(`âœ… ìƒˆ Commit ìƒì„±: ${newCommit.sha.substring(0, 8)}...`);
                
                // 5. Reference ì—…ë°ì´íŠ¸
                const updateRefResponse = await fetch('https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/git/refs/heads/main', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sha: newCommit.sha
                    })
                });
                
                if (updateRefResponse.ok) {
                    addLog('âœ… ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ! Tree APIë¡œ ì•ˆì „í•˜ê²Œ ì»¤ë°‹ë¨');
                } else {
                    throw new Error('Reference ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                addLog(`âŒ ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // Git Database API ì‚¬ìš©
        async function useGitDatabaseAPI() {
            addLog('ğŸ—ƒï¸ Git Database API íƒìƒ‰ ì¤‘...');
            addLog('   - Blob ê°ì²´ ì§ì ‘ ì¡°ì‘');
            addLog('   - Tree ê°ì²´ ì§ì ‘ ìƒì„±');
            addLog('   - Commit ê°ì²´ ì§ì ‘ ìƒì„±');
            addLog('   - Reference ì§ì ‘ ì—…ë°ì´íŠ¸');
            addLog('â„¹ï¸ Database APIëŠ” ê³ ê¸‰ ì‚¬ìš©ììš©ì…ë‹ˆë‹¤.');
        }
        
        // ì§ì ‘ ì»¤ë°‹ ìƒì„±
        async function createCommitDirect() {
            addLog('ğŸ“ ì§ì ‘ ì»¤ë°‹ ìƒì„± ì‹œë®¬ë ˆì´ì…˜...');
            addLog('   1. Blob SHA ê³„ì‚°');
            addLog('   2. Tree êµ¬ì¡° ìƒì„±');
            addLog('   3. Commit ê°ì²´ ìƒì„±');
            addLog('   4. HEAD í¬ì¸í„° ì´ë™');
            addLog('âœ… ì§ì ‘ ì»¤ë°‹ ìƒì„±ì€ ê°€ì¥ ë¹ ë¥´ê³  ì•ˆì „í•œ ë°©ë²•ì…ë‹ˆë‹¤.');
        }
        
        // ì„±ëŠ¥ ë¹„êµ
        async function comparePerformance() {
            addLog('ğŸ“Š ì„±ëŠ¥ ë¹„êµ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            // Tree API ì„±ëŠ¥
            if (performanceMetrics.treeAPI.length > 0) {
                const avgTree = performanceMetrics.treeAPI.reduce((a, b) => a + b, 0) / performanceMetrics.treeAPI.length;
                addLog(`ğŸŒ³ Tree API í‰ê· : ${Math.round(avgTree)}ms (${performanceMetrics.treeAPI.length}íšŒ ì¸¡ì •)`);
            }
            
            // Blob API ì„±ëŠ¥
            if (performanceMetrics.blobAPI.length > 0) {
                const avgBlob = performanceMetrics.blobAPI.reduce((a, b) => a + b, 0) / performanceMetrics.blobAPI.length;
                addLog(`ğŸ“„ Blob API í‰ê· : ${Math.round(avgBlob)}ms (${performanceMetrics.blobAPI.length}íšŒ ì¸¡ì •)`);
            }
            
            addLog('ğŸ’¡ ê¶Œì¥ì‚¬í•­:');
            addLog('   - ì½ê¸° ì „ìš©: Raw Files (ê°€ì¥ ë¹ ë¦„)');
            addLog('   - ë‹¨ì¼ íŒŒì¼ ì—…ë°ì´íŠ¸: Tree API');
            addLog('   - ë³µìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸: Database API');
            addLog('   - ëŒ€ìš©ëŸ‰ íŒŒì¼: Git LFS');
        }
        
        // ì „ì²´ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        async function runFullTest() {
            addLog('ğŸš€ ì „ì²´ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            await syncViaTreeAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await syncViaBlobAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            comparePerformance();
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        function updateLocalStorage(data) {
            if (data.donations) {
                localStorage.setItem('donation_data', JSON.stringify(data.donations));
            }
            if (data.streamers) {
                localStorage.setItem('streamer_config', JSON.stringify(data.streamers));
            }
            if (data.emojis) {
                localStorage.setItem('streamer_emojis', JSON.stringify(data.emojis));
            }
            if (data.settings) {
                Object.entries(data.settings).forEach(([key, value]) => {
                    localStorage.setItem(key, value);
                });
            }
            
            // ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¡œ ì˜¤ë²„ë ˆì´ë“¤ì—ê²Œ ì•Œë¦¼
            if (window.BroadcastChannel) {
                const channel = new BroadcastChannel('donation-sync');
                channel.postMessage({
                    type: 'DATA_UPDATE',
                    payload: data,
                    source: 'tree-api'
                });
                channel.close();
            }
        }
        
        // ë¡œê·¸ ì¶”ê°€
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('performance-log');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const icon = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            logContainer.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            document.getElementById('performance-log').innerHTML = 
                '<div>[ì‹œìŠ¤í…œ] Tree API ë™ê¸°í™” ë„êµ¬ ì´ˆê¸°í™”ë¨</div>';
        }
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            addLog('ğŸŒ³ Tree API ë™ê¸°í™” ë„êµ¬ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
            addLog('ğŸ’¡ Tree APIëŠ” SHA ì¶©ëŒ ì—†ëŠ” ê°€ì¥ ì•ˆì „í•œ Git ë™ê¸°í™” ë°©ë²•ì…ë‹ˆë‹¤.');
        });
    </script>
</body>
</html>