<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”´ ì‹¤ì‹œê°„ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´ (Simple)</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>

<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 800px;
    width: 100%;
}

#donorContent {
    /* ê¸°ë³¸ê°’ - JavaScriptì—ì„œ ë®ì–´ì“¸ ì˜ˆì • */
    font-size: 24px;
    font-weight: bold;
    color: white;
    text-shadow: 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000;
    line-height: 1.5;
    white-space: pre-line;
    text-align: center;
    padding: 0;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì› */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container">
    <div id="donorContent">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
let donations = [];
let socket = null;
let isSocketConnected = false;

// í˜„ì¬ ì„¤ì •ê°’ (ê¸°ë³¸ê°’)
let currentSettings = {
    fontSize: 24,
    textAlign: 'center',
    strokeWidth: 3
};

console.log('ğŸ”´ Simple í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘...');

// Socket.io ì—°ê²° ì´ˆê¸°í™”
function initializeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isSocketConnected = true;
            console.log('ğŸ”— ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
        });
        
        socket.on('disconnect', () => {
            isSocketConnected = false;
            console.log('âŒ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
        });
        
        socket.on('initialData', (data) => {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            if (data.donations) {
                donations = data.donations || [];
            }
            if (data.settings) {
                applySettings(data.settings);
            }
            updateDisplay();
        });
        
        socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            if (data.donations) {
                donations = data.donations || [];
            }
            updateDisplay();
        });
        
        socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', settings);
            applySettings(settings);
            updateDisplay();
        });
        
    } catch (error) {
        console.error('Socket.io ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        loadFromAPI();
    }
}

// ì„œë²„ APIì—ì„œ ë°ì´í„° ë¡œë“œ
async function loadFromAPI() {
    try {
        console.log('APIì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„...');
        const response = await fetch('/api/data');
        
        if (response.ok) {
            const data = await response.json();
            console.log('API ë°ì´í„° ìˆ˜ì‹ :', data);
            
            if (data.donations) {
                donations = data.donations || [];
            }
            if (data.settings) {
                applySettings(data.settings);
            }
            updateDisplay();
        }
    } catch (error) {
        console.error('API ë¡œë“œ ì‹¤íŒ¨:', error);
        updateDisplay();
    }
}

// ì„¤ì • ì ìš©
function applySettings(settings) {
    console.log('ğŸ”§ ì„¤ì • ì ìš© ì‹œì‘:', settings);
    
    // ì„¤ì •ê°’ ì—…ë°ì´íŠ¸
    if (settings['overlay-font-size']) {
        currentSettings.fontSize = parseInt(settings['overlay-font-size']) || 24;
        localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
    }
    
    if (settings['overlay-text-align']) {
        currentSettings.textAlign = settings['overlay-text-align'] || 'center';
        localStorage.setItem('overlay-text-align', currentSettings.textAlign);
    }
    
    if (settings['overlay-stroke-width']) {
        currentSettings.strokeWidth = parseInt(settings['overlay-stroke-width']) || 3;
        localStorage.setItem('overlay-stroke-width', currentSettings.strokeWidth.toString());
    }
    
    // localStorageì—ì„œë„ ë¡œë“œ (ë°±ì—…ìš©)
    const storedSize = localStorage.getItem('overlay-font-size');
    const storedAlign = localStorage.getItem('overlay-text-align');
    const storedStroke = localStorage.getItem('overlay-stroke-width');
    
    if (storedSize) currentSettings.fontSize = parseInt(storedSize) || 24;
    if (storedAlign) currentSettings.textAlign = storedAlign || 'center';
    if (storedStroke) currentSettings.strokeWidth = parseInt(storedStroke) || 3;
    
    console.log('âœ… ìµœì¢… ì„¤ì •ê°’:', currentSettings);
    
    // ì¦‰ì‹œ ìŠ¤íƒ€ì¼ ì ìš©
    applyStylesToElement();
}

// ìš”ì†Œì— ìŠ¤íƒ€ì¼ ì ìš©
function applyStylesToElement() {
    const contentEl = document.getElementById('donorContent');
    if (!contentEl) return;
    
    const { fontSize, textAlign, strokeWidth } = currentSettings;
    
    // í…ìŠ¤íŠ¸ ì„€ë„ìš° ìƒì„±
    const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`;
    
    // ê°•ë ¥í•œ ìŠ¤íƒ€ì¼ ì ìš©
    contentEl.style.cssText = `
        font-size: ${fontSize}px !important;
        text-align: ${textAlign} !important;
        font-weight: bold !important;
        color: white !important;
        line-height: 1.5 !important;
        white-space: pre-line !important;
        text-shadow: ${shadow} !important;
        padding: 0 !important;
        margin: 0 !important;
    `;
    
    console.log('ğŸ¨ ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ:', { fontSize, textAlign, strokeWidth });
}

// í™”ë©´ ì—…ë°ì´íŠ¸
function updateDisplay() {
    console.log('ğŸ¨ í™”ë©´ ì—…ë°ì´íŠ¸ ì‹œì‘');
    console.log('ğŸ“Š í›„ì› ë°ì´í„°:', donations?.length || 0, 'ê±´');
    
    const contentEl = document.getElementById('donorContent');
    
    if (!donations || donations.length === 0) {
        console.log('âš ï¸ í›„ì› ë°ì´í„° ì—†ìŒ');
        contentEl.innerHTML = 'ì‚¬ë‘í•´ìš”â™¡';
        applyStylesToElement();
        return;
    }
    
    // í›„ì›ìë³„ ê³„ì¢Œ í›„ì› ì´ì•¡ ê³„ì‚°
    const donorTotals = {};
    
    donations.forEach(d => {
        if (d.type === 'ê³„ì¢Œ') {
            // í›„ì›ìëª… ì •ë¦¬ (ì¡°ì • ë¶€ë¶„ ì œê±°)
            let cleanName = d.donor || '';
            if (cleanName.includes('(ì¡°ì •')) {
                cleanName = cleanName.replace(/\(ì¡°ì •[^)]*\)/g, '').trim();
            }
            
            const amount = parseFloat(d.amount) || 0;
            if (amount > 0 && cleanName) {
                donorTotals[cleanName] = (donorTotals[cleanName] || 0) + amount;
            }
        }
    });
    
    console.log('ğŸ’° í›„ì›ì ì´ì•¡:', donorTotals);
    
    // ê¸ˆì•¡ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedDonors = Object.entries(donorTotals)
        .filter(([name, amount]) => amount > 0 && name.trim() !== '')
        .sort(([,a], [,b]) => b - a);
    
    console.log('ğŸ† ì •ë ¬ëœ í›„ì›ì:', sortedDonors);
    
    // í‘œì‹œ í…ìŠ¤íŠ¸ ìƒì„±
    let displayText = "ì‚¬ë‘í•´ìš”â™¡\n";
    if (sortedDonors.length > 0) {
        displayText += sortedDonors.map(([name, amount]) => 
            `${name}ë‹˜ ${parseFloat(amount.toFixed(1))}ë§Œ`
        ).join('\n');
    }
    
    contentEl.innerHTML = displayText;
    console.log('âœ¨ í‘œì‹œ í…ìŠ¤íŠ¸:', displayText);
    
    // ìŠ¤íƒ€ì¼ ì ìš©
    applyStylesToElement();
    
    console.log('âœ… í™”ë©´ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

// í¬ë¡œë§ˆí‚¤ ëª¨ë“œ í† ê¸€
function toggleTransparent() {
    document.body.classList.toggle('transparent-mode');
    console.log('ğŸ­ í¬ë¡œë§ˆí‚¤ ëª¨ë“œ í† ê¸€');
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadFromAPI();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
        case '1':
            currentSettings.textAlign = 'left';
            localStorage.setItem('overlay-text-align', 'left');
            applyStylesToElement();
            console.log('ğŸ”§ ì™¼ìª½ ì •ë ¬ ì ìš©');
            break;
        case '2':
            currentSettings.textAlign = 'center';
            localStorage.setItem('overlay-text-align', 'center');
            applyStylesToElement();
            console.log('ğŸ”§ ê°€ìš´ë° ì •ë ¬ ì ìš©');
            break;
        case '3':
            currentSettings.textAlign = 'right';
            localStorage.setItem('overlay-text-align', 'right');
            applyStylesToElement();
            console.log('ğŸ”§ ì˜¤ë¥¸ìª½ ì •ë ¬ ì ìš©');
            break;
        case '+':
            currentSettings.fontSize += 2;
            localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
            applyStylesToElement();
            console.log('ğŸ”§ í°íŠ¸ í¬ê¸° ì¦ê°€:', currentSettings.fontSize);
            break;
        case '-':
            currentSettings.fontSize = Math.max(10, currentSettings.fontSize - 2);
            localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
            applyStylesToElement();
            console.log('ğŸ”§ í°íŠ¸ í¬ê¸° ê°ì†Œ:', currentSettings.fontSize);
            break;
        case 'd':
        case 'D':
            console.log('ğŸ” í˜„ì¬ ìƒíƒœ ë””ë²„ê·¸:');
            console.log('- currentSettings:', currentSettings);
            console.log('- localStorage ì„¤ì •:', {
                fontSize: localStorage.getItem('overlay-font-size'),
                textAlign: localStorage.getItem('overlay-text-align'),
                strokeWidth: localStorage.getItem('overlay-stroke-width')
            });
            const el = document.getElementById('donorContent');
            if (el) {
                const computed = window.getComputedStyle(el);
                console.log('- ì ìš©ëœ ìŠ¤íƒ€ì¼:', {
                    fontSize: computed.fontSize,
                    textAlign: computed.textAlign,
                    fontWeight: computed.fontWeight,
                    color: computed.color
                });
            }
            break;
    }
});

// ì‹œìŠ¤í…œ ì‹œì‘
console.log('ğŸš€ Simple ì˜¤ë²„ë ˆì´ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');
initializeConnection();

// ë°±ì—…ìš© ìë™ ìƒˆë¡œê³ ì¹¨
setInterval(() => {
    if (!isSocketConnected) {
        console.log('ì‹¤ì‹œê°„ ì—°ê²° ì—†ìŒ, APIë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
        loadFromAPI();
    }
}, 15000);

// ì£¼ê¸°ì ìœ¼ë¡œ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© (ì„¤ì • ìœ ì§€)
setInterval(() => {
    applyStylesToElement();
}, 2000);

// localStorage ë³€ê²½ ê°ì§€
window.addEventListener('storage', (e) => {
    if (e.key && e.key.startsWith('overlay-')) {
        console.log('ğŸ“± localStorage ë³€ê²½ ê°ì§€:', e.key, e.newValue);
        applySettings({
            [e.key]: e.newValue
        });
    }
});

console.log('âœ… Simple ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™” ì™„ë£Œ');
</script>

</body>
</html>