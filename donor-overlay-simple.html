<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔴 실시간 후원자별 총액 오버레이 (Simple)</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>

<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 800px;
    width: 100%;
}

#donorContent {
    /* 기본값 - JavaScript에서 덮어쓸 예정 */
    font-size: 24px;
    font-weight: bold;
    color: white;
    text-shadow: 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000;
    line-height: 1.5;
    white-space: pre-line;
    text-align: center;
    padding: 0;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
}

/* 크로마키 지원 */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container">
    <div id="donorContent">
        <div class="loading">데이터를 불러오는 중...</div>
    </div>
</div>

<script>
let donations = [];
let socket = null;
let isSocketConnected = false;

// 현재 설정값 (기본값)
let currentSettings = {
    fontSize: 24,
    textAlign: 'center',
    strokeWidth: 3
};

console.log('🔴 Simple 후원자 오버레이 시작...');

// Socket.io 연결 초기화
function initializeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isSocketConnected = true;
            console.log('🔗 실시간 서버 연결됨');
        });
        
        socket.on('disconnect', () => {
            isSocketConnected = false;
            console.log('❌ 실시간 서버 연결 끊어짐');
        });
        
        socket.on('initialData', (data) => {
            console.log('📊 초기 데이터 수신:', data);
            if (data.donations) {
                donations = data.donations || [];
            }
            if (data.settings) {
                applySettings(data.settings);
            }
            updateDisplay();
        });
        
        socket.on('dataUpdate', (data) => {
            console.log('🔄 데이터 업데이트 수신:', data);
            if (data.donations) {
                donations = data.donations || [];
            }
            updateDisplay();
        });
        
        socket.on('settingsUpdate', (settings) => {
            console.log('⚙️ 설정 업데이트 수신:', settings);
            applySettings(settings);
            updateDisplay();
        });
        
    } catch (error) {
        console.error('Socket.io 초기화 실패:', error);
        loadFromAPI();
    }
}

// 서버 API에서 데이터 로드
async function loadFromAPI() {
    try {
        console.log('API에서 데이터 로드 시도...');
        const response = await fetch('/api/data');
        
        if (response.ok) {
            const data = await response.json();
            console.log('API 데이터 수신:', data);
            
            if (data.donations) {
                donations = data.donations || [];
            }
            if (data.settings) {
                applySettings(data.settings);
            }
            updateDisplay();
        }
    } catch (error) {
        console.error('API 로드 실패:', error);
        updateDisplay();
    }
}

// 설정 적용
function applySettings(settings) {
    console.log('🔧 설정 적용 시작:', settings);
    
    // 설정값 업데이트
    if (settings['overlay-font-size']) {
        currentSettings.fontSize = parseInt(settings['overlay-font-size']) || 24;
        localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
    }
    
    if (settings['overlay-text-align']) {
        currentSettings.textAlign = settings['overlay-text-align'] || 'center';
        localStorage.setItem('overlay-text-align', currentSettings.textAlign);
    }
    
    if (settings['overlay-stroke-width']) {
        currentSettings.strokeWidth = parseInt(settings['overlay-stroke-width']) || 3;
        localStorage.setItem('overlay-stroke-width', currentSettings.strokeWidth.toString());
    }
    
    // localStorage에서도 로드 (백업용)
    const storedSize = localStorage.getItem('overlay-font-size');
    const storedAlign = localStorage.getItem('overlay-text-align');
    const storedStroke = localStorage.getItem('overlay-stroke-width');
    
    if (storedSize) currentSettings.fontSize = parseInt(storedSize) || 24;
    if (storedAlign) currentSettings.textAlign = storedAlign || 'center';
    if (storedStroke) currentSettings.strokeWidth = parseInt(storedStroke) || 3;
    
    console.log('✅ 최종 설정값:', currentSettings);
    
    // 즉시 스타일 적용
    applyStylesToElement();
}

// 요소에 스타일 적용
function applyStylesToElement() {
    const contentEl = document.getElementById('donorContent');
    if (!contentEl) return;
    
    const { fontSize, textAlign, strokeWidth } = currentSettings;
    
    // 텍스트 섀도우 생성
    const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`;
    
    // 강력한 스타일 적용
    contentEl.style.cssText = `
        font-size: ${fontSize}px !important;
        text-align: ${textAlign} !important;
        font-weight: bold !important;
        color: white !important;
        line-height: 1.5 !important;
        white-space: pre-line !important;
        text-shadow: ${shadow} !important;
        padding: 0 !important;
        margin: 0 !important;
    `;
    
    console.log('🎨 스타일 적용 완료:', { fontSize, textAlign, strokeWidth });
}

// 화면 업데이트
function updateDisplay() {
    console.log('🎨 화면 업데이트 시작');
    console.log('📊 후원 데이터:', donations?.length || 0, '건');
    
    const contentEl = document.getElementById('donorContent');
    
    if (!donations || donations.length === 0) {
        console.log('⚠️ 후원 데이터 없음');
        contentEl.innerHTML = '사랑해요♡';
        applyStylesToElement();
        return;
    }
    
    // 후원자별 계좌 후원 총액 계산
    const donorTotals = {};
    
    donations.forEach(d => {
        if (d.type === '계좌') {
            // 후원자명 정리 (조정 부분 제거)
            let cleanName = d.donor || '';
            if (cleanName.includes('(조정')) {
                cleanName = cleanName.replace(/\(조정[^)]*\)/g, '').trim();
            }
            
            const amount = parseFloat(d.amount) || 0;
            if (amount > 0 && cleanName) {
                donorTotals[cleanName] = (donorTotals[cleanName] || 0) + amount;
            }
        }
    });
    
    console.log('💰 후원자 총액:', donorTotals);
    
    // 금액순으로 정렬
    const sortedDonors = Object.entries(donorTotals)
        .filter(([name, amount]) => amount > 0 && name.trim() !== '')
        .sort(([,a], [,b]) => b - a);
    
    console.log('🏆 정렬된 후원자:', sortedDonors);
    
    // 표시 텍스트 생성
    let displayText = "사랑해요♡\n";
    if (sortedDonors.length > 0) {
        displayText += sortedDonors.map(([name, amount]) => 
            `${name}님 ${parseFloat(amount.toFixed(1))}만`
        ).join('\n');
    }
    
    contentEl.innerHTML = displayText;
    console.log('✨ 표시 텍스트:', displayText);
    
    // 스타일 적용
    applyStylesToElement();
    
    console.log('✅ 화면 업데이트 완료');
}

// 크로마키 모드 토글
function toggleTransparent() {
    document.body.classList.toggle('transparent-mode');
    console.log('🎭 크로마키 모드 토글');
}

// 키보드 단축키
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadFromAPI();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
        case '1':
            currentSettings.textAlign = 'left';
            localStorage.setItem('overlay-text-align', 'left');
            applyStylesToElement();
            console.log('🔧 왼쪽 정렬 적용');
            break;
        case '2':
            currentSettings.textAlign = 'center';
            localStorage.setItem('overlay-text-align', 'center');
            applyStylesToElement();
            console.log('🔧 가운데 정렬 적용');
            break;
        case '3':
            currentSettings.textAlign = 'right';
            localStorage.setItem('overlay-text-align', 'right');
            applyStylesToElement();
            console.log('🔧 오른쪽 정렬 적용');
            break;
        case '+':
            currentSettings.fontSize += 2;
            localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
            applyStylesToElement();
            console.log('🔧 폰트 크기 증가:', currentSettings.fontSize);
            break;
        case '-':
            currentSettings.fontSize = Math.max(10, currentSettings.fontSize - 2);
            localStorage.setItem('overlay-font-size', currentSettings.fontSize.toString());
            applyStylesToElement();
            console.log('🔧 폰트 크기 감소:', currentSettings.fontSize);
            break;
        case 'd':
        case 'D':
            console.log('🔍 현재 상태 디버그:');
            console.log('- currentSettings:', currentSettings);
            console.log('- localStorage 설정:', {
                fontSize: localStorage.getItem('overlay-font-size'),
                textAlign: localStorage.getItem('overlay-text-align'),
                strokeWidth: localStorage.getItem('overlay-stroke-width')
            });
            const el = document.getElementById('donorContent');
            if (el) {
                const computed = window.getComputedStyle(el);
                console.log('- 적용된 스타일:', {
                    fontSize: computed.fontSize,
                    textAlign: computed.textAlign,
                    fontWeight: computed.fontWeight,
                    color: computed.color
                });
            }
            break;
    }
});

// 시스템 시작
console.log('🚀 Simple 오버레이 시스템 초기화...');
initializeConnection();

// 백업용 자동 새로고침
setInterval(() => {
    if (!isSocketConnected) {
        console.log('실시간 연결 없음, API로 데이터 새로고침');
        loadFromAPI();
    }
}, 15000);

// 주기적으로 스타일 강제 적용 (설정 유지)
setInterval(() => {
    applyStylesToElement();
}, 2000);

// localStorage 변경 감지
window.addEventListener('storage', (e) => {
    if (e.key && e.key.startsWith('overlay-')) {
        console.log('📱 localStorage 변경 감지:', e.key, e.newValue);
        applySettings({
            [e.key]: e.newValue
        });
    }
});

console.log('✅ Simple 오버레이 초기화 완료');
</script>

</body>
</html>