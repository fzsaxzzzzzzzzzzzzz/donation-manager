<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹¤ì‹œê°„ ë°©ì†¡ í›„ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
    background: #f0f2f5; 
    min-height: 100vh; 
    color: #333; 
}

.header {
    background: #1877f2;
    color: white;
    padding: 15px 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 { font-size: 1.5rem; margin-bottom: 5px; }
.header .status {
    font-size: 0.9rem;
    opacity: 0.9;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #42b72a;
    animation: pulse 2s infinite;
}

.status-dot.disconnected {
    background: #fa383e;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.panel {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.panel h2 {
    margin-bottom: 20px;
    color: #1877f2;
    font-size: 1.3rem;
    border-bottom: 2px solid #e9ebee;
    padding-bottom: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #606770;
}

.form-row {
    display: grid;
    grid-template-columns: 2fr 2fr 1fr 1fr;
    gap: 10px;
    align-items: end;
}

.form-input, .form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ebee;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #1877f2;
    box-shadow: 0 0 0 3px rgba(24,119,242,0.1);
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #1877f2;
    color: white;
}

.btn-success {
    background: #42b72a;
    color: white;
}

.btn-danger {
    background: #fa383e;
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.table-container {
    max-height: 500px;
    overflow-y: auto;
    border-radius: 8px;
    border: 1px solid #e9ebee;
}

.table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.table th {
    background: #f5f6f7;
    padding: 12px 8px;
    text-align: center;
    font-weight: 600;
    border-bottom: 2px solid #e9ebee;
    position: sticky;
    top: 0;
    z-index: 10;
}

.table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid #e9ebee;
}

.table tr:nth-child(even) {
    background: #f9f9f9;
}

.table .amount {
    font-weight: 600;
    color: #42b72a;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.realtime-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #42b72a;
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification {
    position: fixed;
    top: 80px;
    right: 20px;
    background: #42b72a;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    z-index: 1001;
    animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
}

/* ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • ìŠ¤íƒ€ì¼ */
.settings-section {
    margin-bottom: 20px;
}

.settings-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 15px;
}

.checkbox-label, .radio-label {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.4;
}

.checkbox-label.indent {
    margin-left: 20px;
    color: #666;
    font-size: 13px;
}

.checkbox-label input, .radio-label input {
    margin-top: 2px;
}

.checkbox-label small {
    display: block;
    color: #666;
    font-size: 12px;
    margin-top: 4px;
}

.radio-group {
    display: flex;
    gap: 20px;
}

.slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #ddd;
    outline: none;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #1877f2;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #1877f2;
    cursor: pointer;
    border: none;
}

@keyframes fadeOut {
    to { opacity: 0; transform: translateX(100%); }
}

@media (max-width: 1000px) {
    .container {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>
</head>
<body>

<div class="header">
    <h1>ğŸ¬ ì‹¤ì‹œê°„ ë°©ì†¡ í›„ì› ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
    <div class="status">
        <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionText">ì—°ê²° ì¤‘...</span>
        </div>
        <span>|</span>
        <span>ì ‘ì†ì: <strong id="userCount">-</strong>ëª…</span>
        <span>|</span>
        <span>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></span>
    </div>
</div>

<div class="container">
    <div class="panel">
        <h2>ğŸ’° í›„ì› ì…ë ¥</h2>
        
        <form id="donationForm">
            <div class="form-group">
                <div class="form-row">
                    <div>
                        <label class="form-label">í›„ì›ì</label>
                        <input type="text" id="donorInput" class="form-input" placeholder="í›„ì›ì ì´ë¦„" required>
                    </div>
                    <div>
                        <label class="form-label">ìŠ¤íŠ¸ë¦¬ë¨¸</label>
                        <select id="streamerSelect" class="form-select" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">ê¸ˆì•¡</label>
                        <input type="number" id="amountInput" class="form-input" placeholder="0" step="0.1" min="0" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="stats-grid" id="statsContainer">
            <div class="stat-card">
                <div class="stat-value" id="totalDonations">0</div>
                <div class="stat-label">ì´ í›„ì› ê±´ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAmount">â‚©0</div>
                <div class="stat-label">ì´ í›„ì› ê¸ˆì•¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="topStreamer">-</div>
                <div class="stat-label">ìµœê³  ìˆ˜ìµ ìŠ¤íŠ¸ë¦¬ë¨¸</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>ğŸ“Š ì‹¤ì‹œê°„ í›„ì› í˜„í™©</h2>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>ì‹œê°„</th>
                        <th>í›„ì›ì</th>
                        <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                        <th>ê¸ˆì•¡</th>
                        <th>êµ¬ë¶„</th>
                    </tr>
                </thead>
                <tbody id="donationTable">
                    <tr>
                        <td colspan="5">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- YouTube ì±—ë´‡ íŒ¨ë„ -->
    <div class="panel">
        <h2>ğŸ¤– YouTube ì‹¤ì‹œê°„ ì±—ë´‡</h2>
        
        <!-- ì±—ë´‡ ëª¨ë“œ ì„ íƒ -->
        <div class="form-group">
            <label class="form-label">ğŸ¯ ì±—ë´‡ ëª¨ë“œ ì„ íƒ</label>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e9ebee; border-radius: 8px; flex: 1;">
                    <input type="radio" name="chatbot-mode" value="youtube" onchange="chatBot.changeBotMode('youtube')">
                    <span>ğŸ“º YouTube ì±„íŒ…</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 2px solid #e9ebee; border-radius: 8px; flex: 1;">
                    <input type="radio" name="chatbot-mode" value="browser" onchange="chatBot.changeBotMode('browser')" checked>
                    <span>ğŸŒ ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´</span>
                </label>
            </div>
        </div>
        
        <!-- ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´ ëª¨ë“œ (ê¸°ë³¸) -->
        <div class="form-group" id="browser-mode-section">
            <div class="oauth-status" id="browser-status" style="padding: 12px; background: #e8f5e8; color: #2d5a2d; border-radius: 8px; margin-bottom: 10px;">
                ğŸŒ ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´ ëª¨ë“œ (API ì—†ìŒ)
            </div>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                <strong>ğŸ“‹ ì‚¬ìš©ë²•:</strong><br>
                1. YouTube ë¼ì´ë¸Œ ë°©ì†¡ í˜ì´ì§€ë¥¼ <strong>ìƒˆ íƒ­</strong>ì—ì„œ ì—´ê¸°<br>
                2. ì•„ë˜ "ğŸš€ ì±—ë´‡ ì‹œì‘" ë²„íŠ¼ í´ë¦­<br>
                3. ìë™ìœ¼ë¡œ ì±„íŒ…ì°½ì„ ì°¾ì•„ì„œ ì‘ë‹µ ì‹œì‘!
            </div>
            <button type="button" onclick="chatBot.openYouTubeTab()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">
                ğŸ¬ YouTube ë¼ì´ë¸Œ ë°©ì†¡ ì—´ê¸°
            </button>
        </div>
        
        <!-- YouTube API ëª¨ë“œ -->
        <div class="form-group" id="youtube-mode-section" style="display: none;">
            <div class="oauth-status" id="oauth-status">
                ğŸ” YouTube API ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" onclick="chatBot.signIn()" class="btn btn-primary" id="oauth-signin-btn">
                    ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸
                </button>
                <button type="button" onclick="chatBot.signOut()" class="btn btn-danger" id="oauth-signout-btn" style="display: none;">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
            <div style="margin-top: 10px;">
                <label class="form-label">ğŸ“º YouTube ë¼ì´ë¸Œ URL</label>
                <div style="display: flex; gap: 10px;">
                    <input type="url" id="youtube-live-url" class="form-input" 
                           placeholder="https://www.youtube.com/watch?v=VIDEO_ID" style="flex: 1;">
                    <button type="button" onclick="chatBot.connectToChat()" class="btn btn-primary" id="connect-chat-btn" disabled>
                        ğŸ”— ì—°ê²°
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ì±—ë´‡ ìƒíƒœ -->
        <div class="form-group">
            <div class="chatbot-status" id="chatbot-status" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                <span class="status-dot" style="background: #666; width: 10px; height: 10px; border-radius: 50%;"></span>
                <span>ì±—ë´‡ ë¹„í™œì„±í™”ë¨</span>
            </div>
            <button type="button" onclick="chatBot.toggleBot()" class="btn btn-success" id="chatbot-toggle-btn" style="width: 100%;" disabled>
                ğŸš€ ì±—ë´‡ ì‹œì‘
            </button>
        </div>
        
        <!-- ìë™ ì‘ë‹µ ì„¤ì • -->
        <div class="form-group">
            <label class="form-label">ğŸ’¬ ìë™ ì‘ë‹µ ì„¤ì •</label>
            <div class="response-list" id="response-list" style="margin-bottom: 10px;">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="new-trigger" class="form-input" placeholder="íŠ¸ë¦¬ê±° (ì˜ˆ: !ì•ˆë…•)" style="flex: 1;">
                <input type="text" id="new-response" class="form-input" placeholder="ì‘ë‹µ ë©”ì‹œì§€" style="flex: 2;">
                <button type="button" onclick="chatBot.addResponse()" class="btn btn-primary">â•</button>
            </div>
        </div>
        
        <!-- ì±„íŒ… ë¡œê·¸ -->
        <div class="form-group">
            <label class="form-label">ğŸ“ ì±„íŒ… ë¡œê·¸ <span id="chat-log-count">(0)</span></label>
            <div class="chat-log" id="chat-log" style="max-height: 200px; overflow-y: auto; border: 1px solid #e9ebee; border-radius: 8px; padding: 10px; background: #f8f9fa; font-size: 12px;">
                <div class="chat-log-empty" style="text-align: center; color: #666; padding: 20px;">ì•„ì§ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button type="button" onclick="chatBot.clearLog()" class="btn btn-danger" style="flex: 1;">
                    ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°
                </button>
                <button type="button" onclick="chatBot.testMessage()" class="btn btn-success" style="flex: 1;" id="test-message-btn" disabled>
                    ğŸ“¤ í…ŒìŠ¤íŠ¸ ì „ì†¡
                </button>
                <button type="button" onclick="chatBot.manualTrigger()" class="btn btn-primary" style="flex: 1;" id="manual-trigger-btn" disabled>
                    ğŸ¯ ìˆ˜ë™ íŠ¸ë¦¬ê±°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • íŒ¨ë„ -->
<div class="container" style="grid-template-columns: 1fr;">
    <div class="panel">
        <h2>ğŸ“Š ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì •</h2>
        
        <div class="form-group">
            <div class="settings-section">
                <h3 style="margin-bottom: 15px; color: #1877f2; font-size: 1.1rem;">í‘œì‹œ ì˜µì…˜</h3>
                
                <div class="settings-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="totalOverlay-showRankNames"> ìˆœìœ„ëª… ë³´ì´ê¸°
                        <small>ì²´í¬ì‹œ ì»¤ìŠ¤í…€ ìˆœìœ„ëª…(ğŸ‘‘ì™•ì, ğŸ¤´ê·€ì¡± ë“±) í‘œì‹œ</small>
                    </label>
                </div>
                
                <div class="settings-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="totalOverlay-showEomsamyong"> ì—„ì‚¼ìš© ë³´ì´ê¸°
                    </label>
                    <label class="checkbox-label indent">
                        <input type="checkbox" id="totalOverlay-fixEomsamyongFirst"> â”” 1ë“± ê³ ì •
                    </label>
                </div>
                
                <div class="settings-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="totalOverlay-showOkgi"> ì˜¥ê¸” ë³´ì´ê¸°
                    </label>
                    <label class="checkbox-label indent">
                        <input type="checkbox" id="totalOverlay-fixOkgiLast"> â”” ê¼´ì§€ ê³ ì •
                    </label>
                </div>
                
                <div class="settings-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="totalOverlay-hideGukgo"> êµ­ê³  ë³´ì´ê¸° ë§ê¸°
                    </label>
                    <label class="checkbox-label indent">
                        <input type="checkbox" id="totalOverlay-fixGukgoLast"> â”” êµ­ê³  ê¼´ì§€ ê³ ì •
                    </label>
                </div>
                
                <div class="settings-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="showKakaoBank"> ì¹´ì¹´ì˜¤ë±…í¬ ê³„ì¢Œ í‘œì‹œ
                        <small>ì²´í¬ì‹œ í›„ì›ì ì˜¤ë²„ë ˆì´ì— ì¹´ì¹´ì˜¤ë±…í¬ ê³„ì¢Œì •ë³´ í‘œì‹œ</small>
                    </label>
                </div>
            </div>
            
            <div class="settings-section" style="margin-top: 25px;">
                <h3 style="margin-bottom: 15px; color: #1877f2; font-size: 1.1rem;">ì¹´ì¹´ì˜¤ë±…í¬ ì„¤ì •</h3>
                <div class="form-group">
                    <label for="kakaoBankSize" class="form-label">í¬ê¸° ì¡°ì ˆ: <span id="kakaoBankSizeValue">100</span>%</label>
                    <input type="range" id="kakaoBankSize" min="50" max="200" value="100" class="slider">
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="kakaoBankLineHeight" class="form-label">ì¤„ê°„ê²© ì¡°ì ˆ: <span id="kakaoBankLineHeightValue">1.2</span></label>
                    <input type="range" id="kakaoBankLineHeight" min="0.8" max="2.0" step="0.1" value="1.2" class="slider">
                </div>
            </div>
            
            <div class="settings-section" style="margin-top: 25px;">
                <h3 style="margin-bottom: 15px; color: #1877f2; font-size: 1.1rem;">ë‹¨ìœ„ ì„¤ì •</h3>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="totalOverlay-currency" value="won" id="totalOverlay-currencyWon"> ì› ë‹¨ìœ„
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="totalOverlay-currency" value="manwon" id="totalOverlay-currencyManwon" checked> ë§Œì› ë‹¨ìœ„
                    </label>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #1877f2;">
                <strong>ğŸ’¡ ì•ˆë‚´:</strong> ì´ ì„¤ì •ë“¤ì€ ì´ì•¡ë§Œ í‘œì‹œë˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ ì˜¤ë²„ë ˆì´(total-only-overlay.html)ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>
</div>

<div class="realtime-indicator">
    ğŸ”´ ì‹¤ì‹œê°„ ì—°ê²°ë¨
</div>

<script>
class RealtimeDonationManager {
    constructor() {
        this.socket = io();
        this.data = null;
        this.isConnected = false;
        
        this.initializeSocketEvents();
        this.initializeForm();
        this.initializeTotalOverlaySettings();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('ì„œë²„ì— ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            console.log('ì„œë²„ ì—°ê²° ëŠì–´ì§');
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.renderAll();
        });

        this.socket.on('dataUpdate', (data) => {
            this.data = data;
            this.renderAll();
            this.showNotification('ìƒˆ í›„ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
        });
    }

    initializeForm() {
        const form = document.getElementById('donationForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.addDonation();
        });
    }

    initializeTotalOverlaySettings() {
        // ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • ì´ˆê¸°í™”
        this.totalOverlaySettings = {
            showRankNames: localStorage.getItem('total-overlay-showRankNames') === 'true',
            showEomsamyong: localStorage.getItem('total-overlay-showEomsamyong') === 'true',
            fixEomsamyongFirst: localStorage.getItem('total-overlay-fixEomsamyongFirst') === 'true',
            showOkgi: localStorage.getItem('total-overlay-showOkgi') === 'true',
            fixOkgiLast: localStorage.getItem('total-overlay-fixOkgiLast') === 'true',
            hideGukgo: localStorage.getItem('total-overlay-hideGukgo') === 'true',
            fixGukgoLast: localStorage.getItem('total-overlay-fixGukgoLast') === 'true',
            currency: localStorage.getItem('total-overlay-currency') || 'manwon',
            showKakaoBank: localStorage.getItem('showKakaoBank') === 'true',
            kakaoBankSize: parseInt(localStorage.getItem('kakaoBankSize') || '100'),
            kakaoBankLineHeight: parseFloat(localStorage.getItem('kakaoBankLineHeight') || '1.2')
        };

        // UIì— í˜„ì¬ ì„¤ì • ë°˜ì˜
        document.getElementById('totalOverlay-showRankNames').checked = this.totalOverlaySettings.showRankNames;
        document.getElementById('totalOverlay-showEomsamyong').checked = this.totalOverlaySettings.showEomsamyong;
        document.getElementById('totalOverlay-fixEomsamyongFirst').checked = this.totalOverlaySettings.fixEomsamyongFirst;
        document.getElementById('totalOverlay-showOkgi').checked = this.totalOverlaySettings.showOkgi;
        document.getElementById('totalOverlay-fixOkgiLast').checked = this.totalOverlaySettings.fixOkgiLast;
        document.getElementById('totalOverlay-hideGukgo').checked = this.totalOverlaySettings.hideGukgo;
        document.getElementById('totalOverlay-fixGukgoLast').checked = this.totalOverlaySettings.fixGukgoLast;
        document.getElementById(`totalOverlay-currency${this.totalOverlaySettings.currency === 'won' ? 'Won' : 'Manwon'}`).checked = true;
        document.getElementById('showKakaoBank').checked = this.totalOverlaySettings.showKakaoBank;
        document.getElementById('kakaoBankSize').value = this.totalOverlaySettings.kakaoBankSize;
        document.getElementById('kakaoBankSizeValue').textContent = this.totalOverlaySettings.kakaoBankSize;
        document.getElementById('kakaoBankLineHeight').value = this.totalOverlaySettings.kakaoBankLineHeight;
        document.getElementById('kakaoBankLineHeightValue').textContent = this.totalOverlaySettings.kakaoBankLineHeight;

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.attachTotalOverlayEvents();
    }

    attachTotalOverlayEvents() {
        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ë“¤
        const checkboxes = [
            'showRankNames', 'showEomsamyong', 'fixEomsamyongFirst',
            'showOkgi', 'fixOkgiLast', 'hideGukgo', 'fixGukgoLast'
        ];

        checkboxes.forEach(setting => {
            document.getElementById(`totalOverlay-${setting}`).addEventListener('change', (e) => {
                this.updateTotalOverlaySetting(setting, e.target.checked);
            });
        });

        // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('input[name="totalOverlay-currency"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.updateTotalOverlaySetting('currency', e.target.value);
                }
            });
        });

        // ì¹´ì¹´ì˜¤ë±…í¬ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.getElementById('showKakaoBank').addEventListener('change', (e) => {
            this.updateKakaoBankSetting('showKakaoBank', e.target.checked);
        });

        // ì¹´ì¹´ì˜¤ë±…í¬ í¬ê¸° ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        document.getElementById('kakaoBankSize').addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            document.getElementById('kakaoBankSizeValue').textContent = value;
            this.updateKakaoBankSetting('kakaoBankSize', value);
        });

        // ì¹´ì¹´ì˜¤ë±…í¬ ì¤„ê°„ê²© ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        document.getElementById('kakaoBankLineHeight').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('kakaoBankLineHeightValue').textContent = value;
            this.updateKakaoBankSetting('kakaoBankLineHeight', value);
        });
    }

    updateTotalOverlaySetting(key, value) {
        // ë‚´ë¶€ ì„¤ì • ì—…ë°ì´íŠ¸
        this.totalOverlaySettings[key] = value;
        
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
        localStorage.setItem(`total-overlay-${key}`, value);
        
        // ì†Œì¼“ì„ í†µí•´ ì´ì•¡ ì˜¤ë²„ë ˆì´ì— ì„¤ì • ì „ì†¡
        this.socket.emit('updateTotalOverlaySettings', this.totalOverlaySettings);
        
        console.log(`ğŸ”§ ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • ì—…ë°ì´íŠ¸: ${key} = ${value}`);
        
        // ì•Œë¦¼ í‘œì‹œ
        this.showNotification('ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“Š');
    }

    updateKakaoBankSetting(key, value) {
        // ë‚´ë¶€ ì„¤ì • ì—…ë°ì´íŠ¸
        this.totalOverlaySettings[key] = value;
        
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
        localStorage.setItem(key, value);
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ì„¤ì •ì„ í›„ì›ì ì˜¤ë²„ë ˆì´ì— ì „ì†¡
        const kakaoBankSettings = {
            showKakaoBank: this.totalOverlaySettings.showKakaoBank,
            kakaoBankSize: this.totalOverlaySettings.kakaoBankSize,
            kakaoBankLineHeight: this.totalOverlaySettings.kakaoBankLineHeight
        };
        
        this.socket.emit('updateKakaoBankSettings', kakaoBankSettings);
        
        console.log(`ğŸ”§ ì¹´ì¹´ì˜¤ë±…í¬ ì„¤ì • ì—…ë°ì´íŠ¸: ${key} = ${value}`);
        
        // ì•Œë¦¼ í‘œì‹œ
        this.showNotification('ì¹´ì¹´ì˜¤ë±…í¬ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¦');
    }

    updateConnectionStatus() {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        
        if (this.isConnected) {
            dot.classList.remove('disconnected');
            text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
        } else {
            dot.classList.add('disconnected');
            text.textContent = 'ì—°ê²° ëŠì–´ì§';
        }
    }

    async addDonation() {
        const donor = document.getElementById('donorInput').value.trim();
        const streamer = document.getElementById('streamerSelect').value;
        const amount = parseFloat(document.getElementById('amountInput').value);

        if (!donor || !streamer || !amount) {
            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch('/api/donations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    donor,
                    streamer,
                    type: 'ê³„ì¢Œ',
                    amount
                })
            });

            if (response.ok) {
                // í¼ ì´ˆê¸°í™”
                document.getElementById('donorInput').value = '';
                document.getElementById('amountInput').value = '';
                document.getElementById('donorInput').focus();
            }
        } catch (error) {
            console.error('í›„ì› ì¶”ê°€ ì‹¤íŒ¨:', error);
            alert('í›„ì› ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    renderAll() {
        if (!this.data) return;
        
        this.renderStreamers();
        this.renderDonationTable();
        this.renderStats();
        this.updateLastUpdate();
    }

    renderStreamers() {
        const select = document.getElementById('streamerSelect');
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        
        if (this.data.streamers) {
            this.data.streamers.forEach(streamer => {
                const option = document.createElement('option');
                option.value = streamer;
                option.textContent = `${this.data.emojis?.[streamer] || ''} ${streamer}`;
                select.appendChild(option);
            });
        }
        
        // ì´ì „ ì„ íƒê°’ ë³µì›
        select.value = currentValue;
    }

    renderDonationTable() {
        const tbody = document.getElementById('donationTable');
        
        if (!this.data.donations || this.data.donations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        tbody.innerHTML = this.data.donations.slice(0, 50).map(donation => `
            <tr>
                <td>${new Date(donation.time).toLocaleString('ko-KR')}</td>
                <td>${donation.donor}</td>
                <td>${this.data.emojis?.[donation.streamer] || ''} ${donation.streamer}</td>
                <td class="amount">â‚©${donation.amount.toLocaleString()}</td>
                <td>${donation.type}</td>
            </tr>
        `).join('');
    }

    renderStats() {
        if (!this.data.donations) return;

        const totalDonations = this.data.donations.length;
        const totalAmount = this.data.donations.reduce((sum, d) => sum + d.amount, 0);
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡ ê³„ì‚°
        const streamerTotals = {};
        this.data.donations.forEach(donation => {
            streamerTotals[donation.streamer] = (streamerTotals[donation.streamer] || 0) + donation.amount;
        });
        
        const topStreamer = Object.keys(streamerTotals).reduce((a, b) => 
            (streamerTotals[a] || 0) > (streamerTotals[b] || 0) ? a : b, 
            '-'
        );

        document.getElementById('totalDonations').textContent = totalDonations.toLocaleString();
        document.getElementById('totalAmount').textContent = `â‚©${totalAmount.toLocaleString()}`;
        document.getElementById('topStreamer').textContent = topStreamer === '-' ? '-' : 
            `${this.data.emojis?.[topStreamer] || ''} ${topStreamer}`;
    }

    updateLastUpdate() {
        if (this.data?.lastUpdated) {
            document.getElementById('lastUpdate').textContent = 
                new Date(this.data.lastUpdated).toLocaleTimeString('ko-KR');
        }
    }

    showNotification(message) {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();

        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    window.donationManager = new RealtimeDonationManager();
    window.chatBot = new YouTubeChatBot();
});

// YouTube ì±—ë´‡ í´ë˜ìŠ¤
class YouTubeChatBot {
    constructor() {
        this.mode = 'browser'; // 'browser' ë˜ëŠ” 'youtube'
        this.isSignedIn = false;
        this.liveChatId = null;
        this.botEnabled = false;
        this.responses = this.getDefaultResponses();
        this.chatLog = [];
        this.pollInterval = null;
        this.youtubeTab = null; // ìƒˆ íƒ­ ì°¸ì¡°
        this.lastProcessedCount = 0;
        
        this.init();
    }
    
    async init() {
        // ì„¤ì • ë¡œë“œ
        this.loadSettings();
        
        // UI ì—…ë°ì´íŠ¸
        this.updateUI();
        
        console.log('ğŸ¤– YouTube ì±—ë´‡ ì´ˆê¸°í™” ì™„ë£Œ (ë¸Œë¼ìš°ì € ëª¨ë“œ)');
    }
    
    loadGoogleAPI() {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                gapi.load('auth2:client', {
                    callback: () => {
                        gapi.client.init({
                            apiKey: 'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4',
                            clientId: '1051344172738-7u18q2jnrjmrmq6j9hcr8s1g8gfs9l6r.apps.googleusercontent.com',
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'],
                            scope: 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl'
                        }).then(() => {
                            console.log('âœ… Google API ì´ˆê¸°í™” ì™„ë£Œ');
                            this.checkSignInStatus();
                            resolve();
                        }).catch(reject);
                    },
                    onerror: reject
                });
            };
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }
    
    getDefaultResponses() {
        return {
            '!ì•ˆë…•': 'ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹',
            '!ì‹œê°„': () => `í˜„ì¬ ì‹œê°„: ${new Date().toLocaleTimeString('ko-KR')} ğŸ•`,
            '!ë´‡': 'ë„¤, ì €ëŠ” ìë™ ì‘ë‹µ ë´‡ì…ë‹ˆë‹¤! ğŸ¤–',
            '!ëª…ë ¹ì–´': 'ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: !ì•ˆë…•, !ì‹œê°„, !ë´‡, !ëª…ë ¹ì–´, !í›„ì› ğŸ“',
            '!í›„ì›': 'í›„ì›í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ’',
            'ì•ˆë…•': 'ì•ˆë…•í•˜ì„¸ìš”~ ğŸ˜Š',
            'ê³ ë§ˆì›Œ': 'ì²œë§Œì—ìš”! ğŸ˜„',
            'êµ¿': 'ğŸ‘ êµ¿!',
            'ã…‹ã…‹': 'ã…‹ã…‹ã…‹ ğŸ˜‚'
        };
    }
    
    checkSignInStatus() {
        const authInstance = gapi.auth2.getAuthInstance();
        if (authInstance) {
            this.isSignedIn = authInstance.isSignedIn.get();
            this.updateUI();
        }
    }
    
    async signIn() {
        try {
            const authInstance = gapi.auth2.getAuthInstance();
            await authInstance.signIn();
            this.isSignedIn = true;
            this.updateUI();
            console.log('âœ… OAuth ë¡œê·¸ì¸ ì„±ê³µ');
        } catch (error) {
            console.error('âŒ OAuth ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
            alert('Google ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    async signOut() {
        try {
            const authInstance = gapi.auth2.getAuthInstance();
            await authInstance.signOut();
            this.isSignedIn = false;
            this.liveChatId = null;
            this.stopBot();
            this.updateUI();
            console.log('ğŸšª ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
        } catch (error) {
            console.error('âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        }
    }
    
    async testAPI() {
        try {
            const response = await gapi.client.youtube.search.list({
                part: 'snippet',
                q: 'test',
                maxResults: 1
            });
            
            if (response.result.items.length > 0) {
                alert('âœ… YouTube API ì—°ê²° ì„±ê³µ!');
                console.log('âœ… API í…ŒìŠ¤íŠ¸ ì„±ê³µ:', response.result);
            } else {
                throw new Error('API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
            alert('âŒ YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
        }
    }
    
    async connectToChat() {
        const url = document.getElementById('youtube-live-url').value.trim();
        if (!url) {
            alert('YouTube ë¼ì´ë¸Œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        try {
            // URLì—ì„œ Video ID ì¶”ì¶œ
            const videoId = this.extractVideoId(url);
            if (!videoId) {
                throw new Error('ì˜¬ë°”ë¥¸ YouTube URLì´ ì•„ë‹™ë‹ˆë‹¤.');
            }
            
            // ë¹„ë””ì˜¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const videoResponse = await gapi.client.youtube.videos.list({
                part: 'liveStreamingDetails',
                id: videoId
            });
            
            const video = videoResponse.result.items[0];
            if (!video || !video.liveStreamingDetails || !video.liveStreamingDetails.activeLiveChatId) {
                throw new Error('ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë°ì´ í™œì„±í™”ë˜ì§€ ì•Šì€ ì˜ìƒì…ë‹ˆë‹¤.');
            }
            
            this.liveChatId = video.liveStreamingDetails.activeLiveChatId;
            console.log('âœ… ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°:', this.liveChatId);
            
            this.updateUI();
            alert('âœ… ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
        } catch (error) {
            console.error('âŒ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨:', error);
            alert('âŒ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨: ' + error.message);
        }
    }
    
    extractVideoId(url) {
        const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }
    
    changeBotMode(mode) {
        this.mode = mode;
        
        // UI ì„¹ì…˜ í† ê¸€
        const browserSection = document.getElementById('browser-mode-section');
        const youtubeSection = document.getElementById('youtube-mode-section');
        
        if (mode === 'browser') {
            browserSection.style.display = 'block';
            youtubeSection.style.display = 'none';
        } else {
            browserSection.style.display = 'none';
            youtubeSection.style.display = 'block';
            
            // API ëª¨ë“œì¼ ë•Œë§Œ Google API ë¡œë“œ
            if (!window.gapi) {
                this.loadGoogleAPI();
            }
        }
        
        this.stopBot(); // ëª¨ë“œ ë³€ê²½ì‹œ ë´‡ ì¤‘ì§€
        this.updateUI();
        this.addLogMessage(`ğŸ”„ ëª¨ë“œ ë³€ê²½: ${mode === 'browser' ? 'ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´' : 'YouTube API'}`);
    }
    
    openYouTubeTab() {
        const url = prompt('YouTube ë¼ì´ë¸Œ ë°©ì†¡ URLì„ ì…ë ¥í•˜ì„¸ìš”:', 'https://www.youtube.com/watch?v=');
        if (url && url.includes('youtube.com')) {
            this.youtubeTab = window.open(url, '_blank');
            this.addLogMessage('ğŸ¬ ìƒˆ íƒ­ì—ì„œ YouTube ì—´ë¦¼');
            
            // 3ì´ˆ í›„ ì±„íŒ… ìš”ì†Œ í™•ì¸
            setTimeout(() => {
                this.checkYouTubeTab();
            }, 3000);
        }
    }
    
    checkYouTubeTab() {
        if (!this.youtubeTab || this.youtubeTab.closed) {
            this.addLogMessage('âŒ YouTube íƒ­ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        try {
            // ì±„íŒ… ìš”ì†Œ ì¡´ì¬ í™•ì¸ (Cross-origin ì œí•œìœ¼ë¡œ ì‹¤ì œ ì ‘ê·¼ì€ ë¶ˆê°€)
            this.addLogMessage('âœ… YouTube íƒ­ ì—°ê²°ë¨ - ì±—ë´‡ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        } catch (error) {
            this.addLogMessage('âš ï¸ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì œí•œìœ¼ë¡œ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€ - ìˆ˜ë™ ì œì–´ ëª¨ë“œë¡œ ì‘ë™', 'warning');
        }
    }
    
    toggleBot() {
        if (this.botEnabled) {
            this.stopBot();
        } else {
            this.startBot();
        }
    }
    
    startBot() {
        if (this.mode === 'youtube' && (!this.isSignedIn || !this.liveChatId)) {
            alert('ë¨¼ì € Google ë¡œê·¸ì¸ í›„ ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        if (this.mode === 'browser' && (!this.youtubeTab || this.youtubeTab.closed)) {
            alert('ë¨¼ì € YouTube ë¼ì´ë¸Œ ë°©ì†¡ íƒ­ì„ ì—´ì–´ì£¼ì„¸ìš”.');
            return;
        }
        
        this.botEnabled = true;
        this.startChatPolling();
        this.updateUI();
        
        const modeText = this.mode === 'browser' ? 'ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´' : 'YouTube API';
        this.addLogMessage(`ğŸš€ ì±—ë´‡ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. (${modeText} ëª¨ë“œ)`);
        console.log('ğŸ¤– ì±—ë´‡ ì‹œì‘ë¨ -', modeText);
    }
    
    stopBot() {
        this.botEnabled = false;
        if (this.pollInterval) {
            clearInterval(this.pollInterval);
            this.pollInterval = null;
        }
        this.updateUI();
        this.addLogMessage('ğŸ›‘ ì±—ë´‡ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        console.log('ğŸ›‘ ì±—ë´‡ ì¤‘ì§€ë¨');
    }
    
    startChatPolling() {
        if (this.mode === 'browser') {
            // ë¸Œë¼ìš°ì € ì§ì ‘ ì œì–´ ëª¨ë“œ: ì‹œë®¬ë ˆì´ì…˜ ëª¨ë‹ˆí„°ë§
            this.pollInterval = setInterval(() => {
                this.simulateChatMonitoring();
            }, 3000);
        } else {
            // YouTube API ëª¨ë“œ
            this.pollInterval = setInterval(async () => {
                try {
                    await this.checkNewMessages();
                } catch (error) {
                    console.error('âŒ ì±„íŒ… í™•ì¸ ì‹¤íŒ¨:', error);
                }
            }, 5000);
        }
    }
    
    simulateChatMonitoring() {
        if (!this.botEnabled || !this.youtubeTab || this.youtubeTab.closed) {
            return;
        }
        
        // ì‹¤ì œë¡œëŠ” ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°í•´ì•¼ í•¨
        // ì—¬ê¸°ì„œëŠ” ë°ëª¨ìš© ì‹œë®¬ë ˆì´ì…˜
        if (Math.random() > 0.95) { // 5% í™•ë¥ ë¡œ ì‹œë®¬ë ˆì´ì…˜ ë©”ì‹œì§€
            const sampleMessages = [
                { author: 'ì‹œì²­ì1', text: '!ì•ˆë…•' },
                { author: 'ì‹œì²­ì2', text: '!ì‹œê°„' },
                { author: 'ì‹œì²­ì3', text: 'ê³ ë§ˆì›Œ' },
                { author: 'ì‹œì²­ì4', text: 'ã…‹ã…‹ã…‹' },
                { author: 'ì‹œì²­ì5', text: '!ë´‡' }
            ];
            
            const randomMsg = sampleMessages[Math.floor(Math.random() * sampleMessages.length)];
            this.simulateMessageReceived(randomMsg.author, randomMsg.text);
        }
    }
    
    simulateMessageReceived(author, messageText) {
        // ë¡œê·¸ ì¶”ê°€
        this.addLogMessage(`ğŸ‘¤ ${author}: ${messageText}`);
        
        // ìë™ ì‘ë‹µ í™•ì¸
        const response = this.findResponse(messageText.toLowerCase());
        if (response) {
            this.simulateSendMessage(response);
            this.addLogMessage(`ğŸ¤– ë´‡: ${response}`, 'bot');
        }
    }
    
    simulateSendMessage(text) {
        // ì‹¤ì œ ë¸Œë¼ìš°ì € ëª¨ë“œì—ì„œëŠ” ì—¬ê¸°ì„œ ë‹¤ë¥¸ íƒ­ì˜ ì±„íŒ…ì°½ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•´ì•¼ í•¨
        // ë¸Œë¼ìš°ì € ë³´ì•ˆìƒ ì§ì ‘ ì œì–´ëŠ” ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ, ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
        
        // ì•Œë¦¼ í‘œì‹œ (ì‹¤ì œë¡œëŠ” ì‚¬ìš©ìê°€ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°)
        if (confirm(`ğŸ“¤ ë‹¤ìŒ ë©”ì‹œì§€ë¥¼ YouTube ì±„íŒ…ì— ì „ì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n"${text}"\n\ní™•ì¸ì„ ëˆ„ë¥´ë©´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤.`)) {
            // í´ë¦½ë³´ë“œì— ë³µì‚¬
            navigator.clipboard.writeText(text).then(() => {
                this.addLogMessage(`ğŸ“‹ ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: "${text}"`, 'success');
                
                // YouTube íƒ­ì— í¬ì»¤ìŠ¤ (ê°€ëŠ¥í•˜ë©´)
                try {
                    this.youtubeTab.focus();
                } catch (error) {
                    console.log('íƒ­ í¬ì»¤ìŠ¤ ì‹¤íŒ¨ (ë³´ì•ˆ ì œí•œ)');
                }
            }).catch(() => {
                this.addLogMessage(`âŒ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: "${text}"`, 'error');
            });
        }
        
        console.log('ğŸ“¤ ì‹œë®¬ë ˆì´ì…˜ ë©”ì‹œì§€ ì „ì†¡:', text);
    }
    
    async checkNewMessages() {
        if (!this.liveChatId || !this.botEnabled) return;
        
        try {
            const response = await gapi.client.youtube.liveChatMessages.list({
                liveChatId: this.liveChatId,
                part: 'snippet'
            });
            
            const messages = response.result.items || [];
            const newMessages = messages.filter(msg => !this.processedMessages?.includes(msg.id));
            
            if (!this.processedMessages) {
                this.processedMessages = [];
            }
            
            for (const message of newMessages) {
                this.processedMessages.push(message.id);
                await this.handleMessage(message);
            }
            
            // ì²˜ë¦¬ëœ ë©”ì‹œì§€ ID ëª©ë¡ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ì œí•œ
            if (this.processedMessages.length > 100) {
                this.processedMessages = this.processedMessages.slice(-50);
            }
            
        } catch (error) {
            console.error('âŒ ë©”ì‹œì§€ í™•ì¸ ì‹¤íŒ¨:', error);
        }
    }
    
    async handleMessage(message) {
        const messageText = message.snippet.textMessageDetails?.messageText?.toLowerCase() || '';
        const authorName = message.snippet.authorDetails?.displayName || 'ìµëª…';
        
        // ë¡œê·¸ ì¶”ê°€
        this.addLogMessage(`ğŸ‘¤ ${authorName}: ${messageText}`);
        
        // ìë™ ì‘ë‹µ í™•ì¸
        const response = this.findResponse(messageText);
        if (response) {
            await this.sendMessage(response);
            this.addLogMessage(`ğŸ¤– ë´‡: ${response}`, 'bot');
        }
    }
    
    findResponse(messageText) {
        for (const [trigger, response] of Object.entries(this.responses)) {
            if (messageText.includes(trigger.toLowerCase())) {
                return typeof response === 'function' ? response() : response;
            }
        }
        return null;
    }
    
    async sendMessage(text) {
        if (!this.liveChatId || !this.isSignedIn) return;
        
        try {
            await gapi.client.youtube.liveChatMessages.insert({
                part: 'snippet',
                resource: {
                    snippet: {
                        liveChatId: this.liveChatId,
                        type: 'textMessageEvent',
                        textMessageDetails: {
                            messageText: text
                        }
                    }
                }
            });
            
            console.log('ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡:', text);
            
        } catch (error) {
            console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            this.addLogMessage(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    addResponse() {
        const trigger = document.getElementById('new-trigger').value.trim();
        const response = document.getElementById('new-response').value.trim();
        
        if (!trigger || !response) {
            alert('íŠ¸ë¦¬ê±°ì™€ ì‘ë‹µì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        this.responses[trigger] = response;
        this.saveSettings();
        this.updateResponseList();
        
        document.getElementById('new-trigger').value = '';
        document.getElementById('new-response').value = '';
        
        console.log('â• ì‘ë‹µ ì¶”ê°€:', trigger, 'â†’', response);
    }
    
    removeResponse(trigger) {
        delete this.responses[trigger];
        this.saveSettings();
        this.updateResponseList();
        console.log('â– ì‘ë‹µ ì‚­ì œ:', trigger);
    }
    
    addLogMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        this.chatLog.unshift({ timestamp, message, type });
        
        // ë¡œê·¸ê°€ 100ê°œë¥¼ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ
        if (this.chatLog.length > 100) {
            this.chatLog = this.chatLog.slice(0, 100);
        }
        
        this.updateChatLog();
    }
    
    clearLog() {
        this.chatLog = [];
        this.updateChatLog();
        console.log('ğŸ—‘ï¸ ì±„íŒ… ë¡œê·¸ ì§€ì›€');
    }
    
    async testMessage() {
        const testMsg = 'ğŸ¤– í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ - ' + new Date().toLocaleTimeString('ko-KR');
        
        if (this.mode === 'browser') {
            this.simulateSendMessage(testMsg);
        } else {
            await this.sendMessage(testMsg);
        }
        
        this.addLogMessage(`ğŸ“¤ í…ŒìŠ¤íŠ¸: ${testMsg}`, 'test');
    }
    
    manualTrigger() {
        const message = prompt('ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‹œë®¬ë ˆì´ì…˜ìš©):', '!ì•ˆë…•');
        if (message) {
            const author = prompt('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ì‹œì²­ì');
            if (author) {
                this.simulateMessageReceived(author, message);
            }
        }
    }
    
    updateUI() {
        // OAuth ìƒíƒœ
        const oauthStatus = document.getElementById('oauth-status');
        const signinBtn = document.getElementById('oauth-signin-btn');
        const signoutBtn = document.getElementById('oauth-signout-btn');
        const testBtn = document.getElementById('test-api-btn');
        
        if (this.isSignedIn) {
            oauthStatus.textContent = 'âœ… YouTube API ì¸ì¦ ì™„ë£Œ';
            oauthStatus.style.color = '#42b72a';
            signinBtn.style.display = 'none';
            signoutBtn.style.display = 'block';
            testBtn.style.display = 'block';
        } else {
            oauthStatus.textContent = 'ğŸ” YouTube API ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤';
            oauthStatus.style.color = '#666';
            signinBtn.style.display = 'block';
            signoutBtn.style.display = 'none';
            testBtn.style.display = 'none';
        }
        
        // ì—°ê²° ë²„íŠ¼
        const connectBtn = document.getElementById('connect-chat-btn');
        connectBtn.disabled = !this.isSignedIn;
        
        // ì±—ë´‡ ìƒíƒœ
        const status = document.getElementById('chatbot-status');
        const toggleBtn = document.getElementById('chatbot-toggle-btn');
        const testMsgBtn = document.getElementById('test-message-btn');
        
        if (this.botEnabled) {
            status.innerHTML = '<span class="status-dot" style="background: #42b72a; width: 10px; height: 10px; border-radius: 50%;"></span><span>ì±—ë´‡ í™œì„±í™”ë¨</span>';
            toggleBtn.textContent = 'ğŸ›‘ ì±—ë´‡ ì¤‘ì§€';
            toggleBtn.className = 'btn btn-danger';
        } else {
            status.innerHTML = '<span class="status-dot" style="background: #666; width: 10px; height: 10px; border-radius: 50%;"></span><span>ì±—ë´‡ ë¹„í™œì„±í™”ë¨</span>';
            toggleBtn.textContent = 'ğŸš€ ì±—ë´‡ ì‹œì‘';
            toggleBtn.className = 'btn btn-success';
        }
        
        // ë²„íŠ¼ í™œì„±í™” ì¡°ê±´
        const manualTriggerBtn = document.getElementById('manual-trigger-btn');
        
        if (this.mode === 'browser') {
            toggleBtn.disabled = !this.youtubeTab || this.youtubeTab.closed;
            testMsgBtn.disabled = false; // ë¸Œë¼ìš°ì € ëª¨ë“œì—ì„œëŠ” í•­ìƒ ê°€ëŠ¥
            manualTriggerBtn.disabled = false; // ìˆ˜ë™ íŠ¸ë¦¬ê±°ëŠ” í•­ìƒ ê°€ëŠ¥
        } else {
            toggleBtn.disabled = !this.isSignedIn || !this.liveChatId;
            testMsgBtn.disabled = !this.isSignedIn || !this.liveChatId;
            manualTriggerBtn.disabled = true; // API ëª¨ë“œì—ì„œëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±° ë¶ˆí•„ìš”
        }
        
        this.updateResponseList();
    }
    
    updateResponseList() {
        const responseList = document.getElementById('response-list');
        responseList.innerHTML = '';
        
        Object.entries(this.responses).forEach(([trigger, response]) => {
            const responseText = typeof response === 'function' ? 'ë™ì  ì‘ë‹µ' : response;
            const shortResponse = responseText.length > 30 ? responseText.substring(0, 30) + '...' : responseText;
            
            const item = document.createElement('div');
            item.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; background: #e9f3ff; border-radius: 6px; margin-bottom: 5px; font-size: 13px;';
            
            const triggerSpan = document.createElement('span');
            triggerSpan.textContent = trigger;
            triggerSpan.style.cssText = 'background: #1877f2; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; min-width: 60px; text-align: center;';
            
            const arrow = document.createElement('span');
            arrow.textContent = 'â†’';
            arrow.style.color = '#666';
            
            const responseSpan = document.createElement('span');
            responseSpan.textContent = shortResponse;
            responseSpan.style.flex = '1';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'âŒ';
            deleteBtn.style.cssText = 'background: none; border: none; cursor: pointer; padding: 4px;';
            deleteBtn.onclick = () => this.removeResponse(trigger);
            
            item.appendChild(triggerSpan);
            item.appendChild(arrow);
            item.appendChild(responseSpan);
            item.appendChild(deleteBtn);
            
            responseList.appendChild(item);
        });
    }
    
    updateChatLog() {
        const chatLog = document.getElementById('chat-log');
        const logCount = document.getElementById('chat-log-count');
        
        logCount.textContent = `(${this.chatLog.length})`;
        
        if (this.chatLog.length === 0) {
            chatLog.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ì•„ì§ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        chatLog.innerHTML = this.chatLog.slice(0, 20).map(log => {
            let color = '#333';
            if (log.type === 'bot') color = '#1877f2';
            if (log.type === 'error') color = '#fa383e';
            if (log.type === 'test') color = '#42b72a';
            if (log.type === 'success') color = '#28a745';
            if (log.type === 'warning') color = '#ffc107';
            
            return `
                <div style="margin-bottom: 8px; padding: 6px; border-left: 3px solid ${color}; background: rgba(0,0,0,0.02);">
                    <span style="color: #666; font-size: 11px;">[${log.timestamp}]</span>
                    <span style="color: ${color}; margin-left: 8px;">${log.message}</span>
                </div>
            `;
        }).join('');
    }
    
    loadSettings() {
        const saved = localStorage.getItem('youtubeChatBotSettings');
        if (saved) {
            try {
                const settings = JSON.parse(saved);
                this.responses = { ...this.getDefaultResponses(), ...settings.responses };
                console.log('ğŸ“± ì±—ë´‡ ì„¤ì • ë¡œë“œë¨');
            } catch (error) {
                console.error('âŒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
    }
    
    saveSettings() {
        const settings = {
            responses: this.responses
        };
        localStorage.setItem('youtubeChatBotSettings', JSON.stringify(settings));
        console.log('ğŸ’¾ ì±—ë´‡ ì„¤ì • ì €ì¥ë¨');
    }
}
</script>

</body>
</html>