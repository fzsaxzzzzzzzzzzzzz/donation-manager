<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í›„ì›ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¯</text></svg>">
<script src="/socket.io/socket.io.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<style>
:root {
  --c-primary: #4f46e5; --c-primary-h: #4338ca; --c-primary-l: #eef2ff;
  --c-success: #10b981; --c-success-h: #059669;
  --c-warning: #f59e0b; --c-error: #ef4444; --c-error-h: #dc2626; --c-info: #3b82f6;
  --bg: #e8e8e8; --bg-s: #f0f0f0; --bg-sh: #eaeaea; --bg-side: #1e293b; --bg-input: #f5f5f5;
  --tx: #1a1a1a; --tx2: #555; --tx3: #888; --tx-inv: #f8fafc; --tx-side: #cbd5e1; --tx-side-a: #fff;
  --bd: #d0d0d0; --bd-focus: #4f46e5;
  --r-sm: 6px; --r-md: 8px; --r-lg: 12px;
  --sh-sm: 0 1px 2px rgba(0,0,0,.05); --sh-md: 0 4px 6px -1px rgba(0,0,0,.1); --sh-lg: 0 10px 15px -3px rgba(0,0,0,.1);
  --sidebar-w: 180px; --tr: .2s ease;
}
[data-theme="dark"] {
  --bg: #0f172a; --bg-s: #1e293b; --bg-sh: #334155; --bg-side: #0f172a; --bg-input: #334155;
  --tx: #f1f5f9; --tx2: #94a3b8; --tx3: #64748b; --tx-side: #94a3b8;
  --bd: #334155; --c-primary-l: #1e1b4b;
  --sh-sm: 0 1px 2px rgba(0,0,0,.3); --sh-md: 0 4px 6px rgba(0,0,0,.3);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--tx);line-height:1.6;min-height:100vh;font-size:16px}
a{color:var(--c-primary);text-decoration:none}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--tx3);border-radius:3px}

/* Layout */
.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);background:var(--bg-side);display:flex;flex-direction:column;flex-shrink:0;z-index:100;transition:width .2s ease}
.sidebar.mini{width:52px}
.sidebar.mini .side-hd h1{display:none}
.sidebar.mini .side-hd{padding:10px 8px;justify-content:center}
.sidebar.mini .nav-i{padding:12px 0;justify-content:center;gap:0}
.sidebar.mini .nav-i .lb{display:none}
.sidebar.mini .side-ft{padding:6px 4px}
.sidebar.mini .theme-tog span:last-child{display:none}
.sidebar.mini .theme-tog{justify-content:center;padding:6px 0}
.sidebar.mini .side-collapse span{transform:rotate(180deg)}
.side-hd{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px}
.side-hd h1{font-size:20px;color:var(--tx-inv);font-weight:700;white-space:nowrap;overflow:hidden}
.side-nav{flex:1;overflow-y:auto;padding:8px 0}
.nav-i{display:flex;align-items:center;gap:12px;padding:12px 18px;color:var(--tx-side);cursor:pointer;transition:all var(--tr);border-left:3px solid transparent;font-size:16px}
.nav-i:hover{background:rgba(255,255,255,.05);color:var(--tx-side-a)}
.nav-i.active{background:rgba(79,70,229,.15);color:var(--tx-side-a);border-left-color:var(--c-primary)}
.nav-i .ic{width:22px;text-align:center;font-size:18px}
.side-ft{padding:10px 16px;border-top:1px solid rgba(255,255,255,.1)}
.theme-tog{display:flex;align-items:center;gap:10px;cursor:pointer;color:var(--tx-side);font-size:15px;padding:10px 0}
.theme-tog:hover{color:var(--tx-side-a)}
.side-collapse{display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tx-side);padding:8px 0;font-size:14px;opacity:.6;transition:opacity .2s}
.side-collapse:hover{opacity:1}
.side-collapse span{display:inline-block;transition:transform .2s}

.main{flex:1;display:flex;gap:8px;padding:8px;overflow-x:auto}
.panel{background:var(--bg-s);border-radius:var(--r-sm);box-shadow:var(--sh-sm);display:flex;flex-direction:column;min-width:420px;flex:1}
.p-hd{padding:14px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.p-hd h2{font-size:20px;font-weight:600}
.p-body{flex:1;overflow-y:auto;padding:20px}

/* Components */
.card{border:1px solid var(--bd);border-radius:var(--r-md);padding:20px;margin-bottom:14px}
.card-t{font-size:18px;font-weight:600;margin-bottom:14px;display:flex;align-items:center;gap:10px}
.str-chip{transition:opacity .3s}
.str-chip.inactive{opacity:.4}
.fold-t{cursor:pointer;user-select:none;justify-content:space-between}
.fold-t:hover{opacity:.8}
.fold-arrow{font-size:12px;color:var(--tx3);transition:transform .2s}
.fold-body{overflow:hidden;transition:all .2s ease}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 22px;border:none;border-radius:var(--r-sm);font-size:16px;font-weight:500;cursor:pointer;transition:all var(--tr);white-space:nowrap}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-p{background:var(--c-primary);color:#fff}.btn-p:hover:not(:disabled){background:var(--c-primary-h)}
.btn-s{background:var(--c-success);color:#fff}.btn-s:hover:not(:disabled){background:var(--c-success-h)}
.btn-e{background:var(--c-error);color:#fff}.btn-e:hover:not(:disabled){background:var(--c-error-h)}
.btn-w{background:var(--c-warning);color:#fff}
.btn-o{background:transparent;border:1px solid var(--bd);color:var(--tx2)}.btn-o:hover{background:var(--bg-sh)}
.btn-sm{padding:7px 14px;font-size:14px}
.btn-blk{width:100%}
.btn-g{display:flex;gap:8px;flex-wrap:wrap}

.fg{margin-bottom:14px}
.fl{display:block;font-size:14px;font-weight:500;color:var(--tx2);margin-bottom:5px}
.fi,.fs{width:100%;padding:11px 14px;border:1px solid var(--bd);border-radius:var(--r-sm);font-size:16px;background:var(--bg-input);color:var(--tx);transition:border-color var(--tr)}
.fi:focus,.fs:focus{outline:none;border-color:var(--bd-focus);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.fchk{display:flex;align-items:center;gap:10px;font-size:16px}
.fchk input[type="checkbox"]{width:20px;height:20px;accent-color:var(--c-primary)}

.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:15px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--bd)}
th{background:var(--bg-sh);font-weight:600;font-size:13px;text-transform:uppercase;color:var(--tx2);position:sticky;top:0;z-index:1}
tr:hover{background:var(--bg-sh)}

.tab-bar{display:flex;gap:2px;border-bottom:1px solid var(--bd);padding:0 10px;overflow-x:auto;flex-shrink:0}
.tab-b{padding:12px 20px;border:none;background:none;font-size:17px;color:var(--tx2);cursor:pointer;border-bottom:2px solid transparent;transition:all var(--tr);white-space:nowrap}
.tab-b:hover{color:var(--tx)}
.tab-b.active{color:var(--c-primary);border-bottom-color:var(--c-primary);font-weight:600}
.tc{display:none}.tc.active{display:block}

.toast-c{position:fixed;top:14px;right:14px;z-index:10000;display:flex;flex-direction:column;gap:6px}
.toast{padding:14px 24px;border-radius:var(--r-md);font-size:16px;font-weight:500;color:#fff;box-shadow:var(--sh-lg);animation:tIn .3s ease;max-width:440px}
.toast.success{background:var(--c-success)}.toast.error{background:var(--c-error)}.toast.warning{background:var(--c-warning)}.toast.info{background:var(--c-info)}.toast.saved{background:var(--c-primary)}
.toast-x{animation:tOut .3s ease forwards}
@keyframes tIn{from{opacity:0;transform:translateX(80px)}}
@keyframes tOut{to{opacity:0;transform:translateX(80px)}}

.badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;font-size:14px;font-weight:600}
.badge-p{background:var(--c-primary-l);color:var(--c-primary)}
.badge-s{background:#d1fae5;color:#065f46}
.badge-w{background:#fef3c7;color:#92400e}
.badge-e{background:#fee2e2;color:#991b1b}

.status{padding:10px 14px;border-radius:var(--r-sm);font-size:15px;margin:10px 0}
.status-success{background:#d1fae5;color:#065f46}
.status-warning{background:#fef3c7;color:#92400e}
.status-error{background:#fee2e2;color:#991b1b}
.status-info{background:#dbeafe;color:#1e40af}

.view{display:none}.view.active{display:block}

.ac-wrap{position:relative}
.ac-list{position:absolute;top:100%;left:0;right:0;background:var(--bg-s);border:1px solid var(--bd);border-radius:var(--r-sm);max-height:180px;overflow-y:auto;z-index:50;box-shadow:var(--sh-md);display:none}
.ac-item{padding:9px 12px;cursor:pointer;font-size:14px}
.ac-item:hover,.ac-item.sel{background:var(--c-primary-l)}

.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal-ov.active{display:flex}
.modal{background:var(--bg-s);border-radius:var(--r-lg);padding:28px;max-width:600px;width:95%;box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}
.modal h3{margin-bottom:16px;font-size:20px}

.rk-box{background:var(--c-primary-l);padding:12px;border-radius:var(--r-md);margin-bottom:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.rk-box .st{font-size:13px;color:var(--tx2)}.rk-box .sv{font-weight:600;color:var(--tx)}
.rk-item{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--bd)}
.rk-medal{font-size:22px;width:32px;text-align:center}
.rk-rank{width:32px;text-align:center;font-weight:600;color:var(--tx2);font-size:15px}
.rk-info{flex:1;min-width:0}.rk-name{font-weight:500;font-size:16px}.rk-detail{font-size:13px;color:var(--tx3)}
.rk-bar-bg{height:4px;background:var(--bd);border-radius:2px;margin-top:4px}
.rk-bar{height:100%;background:var(--c-primary);border-radius:2px;transition:width .5s ease}
.rk-amt{font-weight:600;font-size:17px;white-space:nowrap}
.rk-empty{padding:16px;text-align:center;color:var(--tx3);font-size:14px}

.sl-g{display:flex;align-items:center;gap:6px}
.sl-g input[type="range"]{flex:1;accent-color:var(--c-primary)}
.sl-v{font-size:14px;color:var(--tx2);min-width:44px;text-align:right}

.ov-card{border:1px solid var(--bd);border-radius:var(--r-md);padding:10px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:6px}
.ov-info{flex:1}.ov-name{font-weight:600;font-size:16px}.ov-desc{font-size:13px;color:var(--tx3)}

.pg-bar{height:22px;background:var(--bd);border-radius:11px;overflow:hidden;margin:8px 0}
.pg-fill{height:100%;background:linear-gradient(90deg,var(--c-primary),var(--c-info));border-radius:11px;transition:width .5s ease;display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;font-weight:600}

.sett-p{display:none;border:1px solid var(--bd);border-radius:var(--r-md);padding:14px;margin-top:10px;background:var(--bg-sh)}
.sett-p.open{display:block}

.str-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:var(--c-primary-l);border-radius:999px;font-size:16px;margin:4px}
.str-chip .del{cursor:pointer;opacity:.6;font-size:16px}.str-chip .del:hover{opacity:1}

.mis-card{border:1px solid var(--bd);border-radius:var(--r-md);padding:14px;margin-bottom:12px}
.mis-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.mis-title{font-weight:600;font-size:17px}

.qa-row{display:flex;gap:4px;padding:6px;border-bottom:1px solid var(--bd);background:var(--bg-sh)}
.qa-row input,.qa-row select{padding:7px 10px;border:1px solid var(--bd);border-radius:var(--r-sm);font-size:15px;background:var(--bg-input);color:var(--tx)}
.qa-row input{flex:1;min-width:0}.qa-row select{width:auto}

.empty-msg{padding:30px;text-align:center;color:var(--tx3);font-size:16px}

@media(max-width:1200px) and (min-width:769px){.main .panel:last-child{display:none}}
@media(max-width:768px){
  .sidebar{position:fixed;bottom:0;left:0;right:0;width:100%;height:auto;flex-direction:row;z-index:100;padding:0 4px}
  .side-hd{display:none}
  .side-ft{display:flex;position:absolute;right:8px;top:50%;transform:translateY(-50%)}
  .side-ft .theme-tog{padding:4px 8px;font-size:12px;gap:2px}
  .side-ft .theme-tog span:last-child{display:none}
  .side-nav{display:flex;overflow-x:auto;padding:0;flex:1}
  .nav-i{flex-direction:column;gap:2px;padding:8px 10px;font-size:9px;border-left:none;border-top:2px solid transparent;text-align:center;min-width:fit-content}
  .nav-i.active{border-left-color:transparent;border-top-color:var(--c-primary)}
  .nav-i .lb{display:none}
  .mob-panel-tabs{display:flex!important;position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:2px solid var(--bd);margin-bottom:6px}
  .mob-panel-tabs button{flex:1;padding:10px 6px;border:none;background:none;font-size:14px;font-weight:600;color:var(--tx3);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s}
  .mob-panel-tabs button.active{color:var(--c-primary);border-bottom-color:var(--c-primary)}
  .main{display:flex;flex-direction:column;padding:0 4px 65px;gap:0;overflow-x:hidden}
  .main .panel{display:none!important;min-width:0;width:100%}
  .main .panel.mob-active{display:block!important}
}
.mt-s{margin-top:6px}.mt-m{margin-top:10px}.mb-s{margin-bottom:6px}.mb-m{margin-bottom:10px}
.hidden{display:none!important}
</style>
</head>
<body>
<div class="toast-c" id="toast-container"></div>

<div class="app">
<!-- Sidebar -->
<nav class="sidebar">
  <div class="side-hd"><span style="font-size:20px">ğŸ“‹</span><h1>í›„ì›ê´€ë¦¬</h1><span class="side-collapse" onclick="toggleSidebar()" style="margin-left:auto"><span>â—€</span></span></div>
  <div class="side-nav" id="sidebar-nav">
    <div class="nav-i active" data-view="donation"><span class="ic">ğŸ’°</span><span class="lb">í›„ì›ë“±ë¡</span></div>
    <div class="nav-i" data-view="streamer"><span class="ic">ğŸ‘¥</span><span class="lb">ìŠ¤íŠ¸ë¦¬ë¨¸</span></div>
    <div class="nav-i" data-view="mission"><span class="ic">ğŸ¯</span><span class="lb">í€ë”©</span></div>
    <div class="nav-i" data-view="overlay"><span class="ic">ğŸ–¥ï¸</span><span class="lb">ì˜¤ë²„ë ˆì´</span></div>
    <div class="nav-i" data-view="chatbot"><span class="ic">ğŸ¤–</span><span class="lb">ì±—ë´‡</span></div>
    <div class="nav-i" data-view="adjustment"><span class="ic">âš–ï¸</span><span class="lb">ì¡°ì •</span></div>
    <div class="nav-i" data-view="data"><span class="ic">ğŸ’¾</span><span class="lb">ë°ì´í„°</span></div>
    <div class="nav-i" data-view="settings"><span class="ic">âš™ï¸</span><span class="lb">ì„¤ì •</span></div>
  </div>
  <div class="side-ft">
    <div class="theme-tog" onclick="toggleTheme()"><span id="theme-icon">ğŸŒ™</span><span>ë‹¤í¬ëª¨ë“œ</span></div>
  </div>
</nav>
<div class="main">
<!-- Mobile Panel Tabs -->
<div class="mob-panel-tabs" style="display:none">
  <button class="active" onclick="switchMobPanel(0, this)">ğŸ“ ê´€ë¦¬</button>
  <button onclick="switchMobPanel(1, this)">ğŸ“Š ìš”ì•½</button>
  <button onclick="switchMobPanel(2, this)">ğŸ“‹ ë‚´ì—­</button>
</div>

<!-- Panel 1: Management -->
<div class="panel">
  <div class="p-hd"><h2 id="panel1-title">í›„ì›ë“±ë¡</h2><span class="badge badge-p" id="connection-badge">ì—°ê²°ì¤‘...</span></div>
  <div class="p-body" id="panel1-body">

    <!-- í›„ì›ë“±ë¡ -->
    <div class="view active" id="view-donation">
      <div class="card">
        <div class="card-t">ğŸ“ í›„ì› ë“±ë¡</div>
        <div class="fg ac-wrap">
          <label class="fl">í›„ì›ìëª…</label>
          <input type="text" class="fi" id="donor-input" placeholder="í›„ì›ì ì´ë¦„" autocomplete="off">
          <div class="ac-list" id="donor-autocomplete"></div>
        </div>
        <div class="fg">
          <label class="fl">í›„ì› íƒ€ì…</label>
          <div style="display:flex;gap:15px;font-size:15px">
            <label><input type="radio" name="paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label>
            <label><input type="radio" name="paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label>
            <label><input type="radio" name="paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label>
          </div>
        </div>
        <div class="fg">
          <label class="fl">ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡ (ë§Œì›)</label>
          <div class="streamer-grid" id="streamer-inputs" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px"></div>
        </div>
        <button class="btn btn-p btn-blk" onclick="addDonation()">âœ¨ ë“±ë¡</button>
        <div class="fchk mt-s"><input type="checkbox" id="auto-chat-notify"><label for="auto-chat-notify">í›„ì›ì‹œ ì±—ë´‡ ìë™ ì•Œë¦¼</label></div>
      </div>
    </div>

    <!-- ìŠ¤íŠ¸ë¦¬ë¨¸ -->
    <div class="view" id="view-streamer">
      <div class="card">
        <div class="card-t">ğŸ‘¥ ìŠ¤íŠ¸ë¦¬ë¨¸ ê´€ë¦¬</div>
        <div id="streamer-list" class="mb-m" style="display:flex;flex-wrap:wrap;gap:4px"></div>
        <div class="fr" style="grid-template-columns:1fr auto auto">
          <input type="text" class="fi" id="new-streamer-name" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„">
          <input type="text" class="fi" id="new-streamer-emoji" placeholder="ì´ëª¨ì§€" style="width:60px">
          <button class="btn btn-p" onclick="addStreamer()">ì¶”ê°€</button>
        </div>
      </div>
    </div>

    <!-- í€ë”© -->
    <div class="view" id="view-mission">
      <div class="card">
        <div class="card-t">ğŸ¯ í€ë”© ìƒì„±</div>
        <div class="fr">
          <div class="fg"><label class="fl">ìŠ¤íŠ¸ë¦¬ë¨¸</label><select class="fs" id="mission-streamer"></select></div>
          <div class="fg"><label class="fl">ëª©í‘œì•¡ (ë§Œì›)</label><input type="number" class="fi" id="mission-target" step="1" min="1"></div>
        </div>
        <div class="fr">
          <div class="fg"><label class="fl">ì‹œì‘ê¸ˆì•¡ (ë§Œì›)</label><input type="number" class="fi" id="mission-initial" value="0" step="0.1"></div>
          <div class="fg"><label class="fl">ì„¤ëª…</label><input type="text" class="fi" id="mission-description" placeholder="í€ë”© ì„¤ëª…"></div>
        </div>
        <button class="btn btn-p btn-blk" onclick="createMission()">í€ë”© ì‹œì‘</button>
      </div>
      <div class="card">
        <div class="card-t">ğŸ“‹ ì§„í–‰ì¤‘ì¸ í€ë”©</div>
        <div id="running-missions-list"><div class="empty-msg">ì§„í–‰ì¤‘ì¸ í€ë”©ì´ ì—†ìŠµë‹ˆë‹¤</div></div>
      </div>
    </div>

    <!-- ì˜¤ë²„ë ˆì´ -->
    <div class="view" id="view-overlay">
      <!-- OBS ì˜¤ë²„ë ˆì´ ë§í¬ -->
      <div class="card">
        <div class="card-t fold-t" onclick="toggleFold(this)">ğŸ–¥ï¸ OBS ì˜¤ë²„ë ˆì´ <span class="fold-arrow">â–¼</span></div>
        <div class="fold-body">
          <div id="overlay-cards"></div>
          <div class="btn-g mt-s">
            <button class="btn btn-o btn-sm" onclick="openAllOverlays()">ì „ì²´ ì—´ê¸°</button>
          </div>
        </div>
      </div>
      <!-- í›„ì›ì ì˜¤ë²„ë ˆì´ ì„¤ì • -->
      <div class="card">
        <div class="card-t fold-t" onclick="toggleFold(this)">ğŸ¨ í›„ì›ì ì˜¤ë²„ë ˆì´ ì„¤ì • <span class="fold-arrow">â–¶</span></div>
        <div class="fold-body" style="display:none">
          <div class="fg"><label class="fl">í°íŠ¸ í¬ê¸°</label>
            <div class="sl-g"><input type="range" id="overlay-font-size" min="12" max="48" value="24"><span class="sl-v" id="overlay-font-size-val">24px</span></div>
          </div>
          <div class="fg"><label class="fl">ì™¸ê³½ì„  ë‘ê»˜</label>
            <div class="sl-g"><input type="range" id="overlay-stroke-width" min="0" max="10" step="0.1" value="2.6"><span class="sl-v" id="overlay-stroke-width-val">2.6px</span></div>
          </div>
          <div class="fg"><label class="fl">ì •ë ¬</label>
            <select class="fs" id="overlay-text-align"><option value="left">ì™¼ìª½</option><option value="center">ê°€ìš´ë°</option><option value="right">ì˜¤ë¥¸ìª½</option></select>
          </div>
          <div class="fg"><label class="fl">ì¤„ ê°„ê²©</label>
            <div class="sl-g"><input type="range" id="overlay-line-height" min="1" max="3" step="0.1" value="1.5"><span class="sl-v" id="overlay-line-height-val">1.5</span></div>
          </div>
          <div class="fg"><label class="fl">í›„ì›ì ê¸€ì ìƒ‰ìƒ</label><input type="color" class="fi" id="overlay-text-color" value="#ffffff" style="padding:2px;height:32px"></div>
          <div class="fchk"><input type="checkbox" id="showKakaoBank"><label for="showKakaoBank">ì¹´ì¹´ì˜¤ë±…í¬ ê³„ì¢Œ í‘œì‹œ</label></div>
          <div id="kakao-settings" class="mt-s" style="display:none">
            <div class="fg"><label class="fl">ê³„ì¢Œ ì •ë³´</label><input type="text" class="fi" id="kakaoBankAccount" value="ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O"></div>
            <div class="fr">
              <div class="fg"><label class="fl">í¬ê¸°</label><input type="number" class="fi" id="kakaoBankSize" value="34" min="10" max="60"></div>
              <div class="fg"><label class="fl">ì¤„ê°„ê²©</label><input type="number" class="fi" id="kakaoBankLineHeight" value="1" min="0.5" max="3" step="0.1"></div>
            </div>
          </div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--bd)">
            <div class="fchk"><input type="checkbox" id="donor-overlay-show-goal"><label for="donor-overlay-show-goal">ì´ì•¡ ê·¸ë˜í”„ í•©ì³ ë³´ì´ê¸°</label></div>
            <div id="donor-goal-settings" class="mt-s" style="display:none">
              <div class="fr">
                <div class="fg"><label class="fl">ìœ„ì¹˜</label>
                  <select class="fs" id="donor-overlay-goal-position"><option value="top">ìœ„</option><option value="bottom">ì•„ë˜</option></select>
                </div>
                <div class="fg"><label class="fl">ì •ë ¬</label>
                  <select class="fs" id="donor-overlay-goal-align"><option value="left">ì™¼ìª½</option><option value="center">ê°€ìš´ë°</option><option value="right">ì˜¤ë¥¸ìª½</option></select>
                </div>
              </div>
              <div class="fg"><label class="fl">ë„“ì´ (%)</label>
                <div class="sl-g"><input type="range" id="donor-overlay-goal-width" min="10" max="100" value="100"><span class="sl-v" id="donor-overlay-goal-width-val">100%</span></div>
              </div>
            </div>
          </div>
          <button class="btn btn-p btn-blk mt-s" onclick="saveOverlaySettings()">ì„¤ì • ì €ì¥</button>
        </div>
      </div>
      <!-- í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì • -->
      <div class="card">
        <div class="card-t fold-t" onclick="toggleFold(this)">ğŸ“Š í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì • <span class="fold-arrow">â–¶</span></div>
        <div class="fold-body" style="display:none">
          <div class="fr">
            <div class="fg"><label class="fl">íˆ¬ëª…ë„ (%)</label><input type="number" class="fi" id="table-opacity" value="85" min="0" max="100"></div>
            <div class="fg"><label class="fl">ë²ˆí˜¸ í¬ê¸°</label><input type="number" class="fi" id="table-number-size" value="16" min="8" max="30"></div>
          </div>
          <div class="fr">
            <div class="fg"><label class="fl">í°íŠ¸ í¬ê¸°</label><input type="number" class="fi" id="table-font-size" value="14" min="8" max="30"></div>
            <div class="fg"><label class="fl">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</label><input type="color" class="fi" id="table-text-color" value="#ffffff" style="padding:2px;height:32px"></div>
          </div>
          <div class="fg"><label class="fl">ì œëª©</label><input type="text" class="fi" id="table-title" value="ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†"></div>
          <div class="fg"><label class="fl">ìƒ‰ìƒ í”„ë¦¬ì…‹</label>
            <select class="fs" id="table-color-preset"><option value="blue">ë¸”ë£¨</option><option value="green">ê·¸ë¦°</option><option value="purple">í¼í”Œ</option><option value="red">ë ˆë“œ</option><option value="dark">ë‹¤í¬</option></select>
          </div>
          <div class="fr">
            <div class="fchk"><input type="checkbox" id="show-total-row" checked><label for="show-total-row">í•©ê³„ í‘œì‹œ</label></div>
            <div class="fchk"><input type="checkbox" id="show-update-time"><label for="show-update-time">ì—…ë°ì´íŠ¸ ì‹œê°„</label></div>
          </div>
          <div class="fg"><label class="fl">ê·¸ë£¹ ì„ê³„ê°’ (ë§Œì›)</label><input type="number" class="fi" id="groupThreshold" value="9" min="0"></div>
          <div class="fchk"><input type="checkbox" id="includeSuperchat"><label for="includeSuperchat">ìŠˆí¼ì±— í¬í•¨</label></div>
          <button class="btn btn-p btn-blk mt-s" onclick="saveTableSettings()">í…Œì´ë¸” ì„¤ì • ì €ì¥</button>
        </div>
      </div>
      <!-- ì´ì•¡ ëª©í‘œ ì„¤ì • -->
      <div class="card">
        <div class="card-t fold-t" onclick="toggleFold(this)">ğŸ“ˆ ì´ì•¡ ëª©í‘œ ì„¤ì • <span class="fold-arrow">â–¶</span></div>
        <div class="fold-body" style="display:none">
          <div class="fr">
            <div class="fg"><label class="fl">ëª©í‘œì•¡ (ë§Œì›)</label><input type="number" class="fi" id="daily-goal-target" min="1"></div>
            <div class="fg"><label class="fl">ì—°ì¥ì•¡ (ë§Œì›)</label><input type="number" class="fi" id="extend-amount" value="50" disabled></div>
          </div>
          <div class="fchk"><input type="checkbox" id="auto-extend-enabled"><label for="auto-extend-enabled">ìë™ ì—°ì¥</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="total-goal-show-title"><label for="total-goal-show-title">ì œëª© í‘œì‹œ</label></div>
          <div class="fg mt-s"><label class="fl">ì»¤ìŠ¤í…€ ì œëª©</label><input type="text" class="fi" id="total-goal-custom-title"></div>
          <div class="fr">
            <div class="fg"><label class="fl">ë°°ê²½ íˆ¬ëª…ë„</label>
              <div class="sl-g"><input type="range" id="total-goal-bg-opacity" min="0" max="100" value="0"><span class="sl-v" id="bg-opacity-value">0%</span></div>
            </div>
            <div class="fg"><label class="fl">ë°°ê²½ìƒ‰</label><input type="color" class="fi" id="total-goal-bg-color" value="#000000" style="padding:2px;height:32px"></div>
          </div>
          <div class="fr">
            <div class="fg"><label class="fl">ì™¸ê³½ì„  ë‘ê»˜</label>
              <div class="sl-g"><input type="range" id="total-goal-text-outline-width" min="0" max="10" step="0.5" value="1"><span class="sl-v" id="text-outline-width-value">1px</span></div>
            </div>
            <div class="fg"><label class="fl">ì™¸ê³½ì„  ìƒ‰</label><input type="color" class="fi" id="total-goal-text-outline-color" value="#000000" style="padding:2px;height:32px"></div>
          </div>
          <div class="fchk"><input type="checkbox" id="total-goal-show-top-stats" checked><label for="total-goal-show-top-stats">ìƒë‹¨ í†µê³„ í‘œì‹œ</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="total-goal-text-switch-enabled"><label for="total-goal-text-switch-enabled">í…ìŠ¤íŠ¸ ì „í™˜</label></div>
          <div class="fg mt-s"><label class="fl">ì „í™˜ ê°„ê²© (ì´ˆ)</label><input type="number" class="fi" id="total-goal-text-switch-interval" value="5" disabled></div>
          <div class="fr">
            <div class="fg"><label class="fl">ì œëª© í¬ê¸°</label><input type="number" class="fi" id="total-goal-title-size" value="24" min="10" max="48"></div>
            <div class="fg"><label class="fl">í†µê³„ í¬ê¸°</label><input type="number" class="fi" id="total-goal-stats-size" value="20" min="10" max="48"></div>
          </div>
          <div class="fr">
            <div class="fg"><label class="fl">ë°” ë†’ì´</label><input type="number" class="fi" id="total-goal-progress-height" value="30" min="10" max="60"></div>
            <div class="fg"><label class="fl">ë°” í…ìŠ¤íŠ¸ í¬ê¸°</label><input type="number" class="fi" id="total-goal-progress-text-size" value="16" min="8" max="30"></div>
          </div>
          <div class="fg"><label class="fl">ìˆ«ì í‘œì‹œ</label>
            <select class="fs" id="total-goal-decimal-display" onchange="updateTotalGoalDecimalDisplay(this.value)">
              <option value="auto">ì •ìˆ˜ì¼ ë•Œ ì†Œìˆ˜ì  ìƒëµ</option><option value="always">í•­ìƒ ì†Œìˆ˜ì  í‘œì‹œ</option>
            </select>
          </div>
          <div class="btn-g mt-m">
            <button class="btn btn-p" onclick="applyTotalGoalSettings()">ì €ì¥</button>
            <button class="btn btn-o" onclick="resetTotalGoalSettings()">ì´ˆê¸°í™”</button>
          </div>
          <!-- í€ë”© ê·¸ë˜í”„ ì˜µì…˜ (ì„œë¸Œì„¹ì…˜) -->
          <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--bd)">
            <div class="fold-t" onclick="toggleFold(this)" style="font-size:16px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none">
              ğŸ¯ í€ë”© ê·¸ë˜í”„ ì˜µì…˜ <span class="fold-arrow">â–¶</span>
            </div>
            <div class="fold-body" style="display:none">
              <div class="fr">
                <div class="fg"><label class="fl">íˆ¬ëª…ë„</label>
                  <div class="sl-g"><input type="range" id="graph-opacity" min="0" max="100" value="85"><span class="sl-v" id="graph-opacity-value">85%</span></div>
                </div>
                <div class="fg"><label class="fl">ë°°ê²½ìƒ‰</label><input type="color" class="fi" id="graph-bg-color" value="#000000" style="padding:2px;height:32px"></div>
              </div>
              <div class="fr">
                <div class="fg"><label class="fl">í…Œë‘ë¦¬ ìƒ‰</label><input type="color" class="fi" id="graph-border-color" value="#42b72a" style="padding:2px;height:32px"></div>
                <div class="fg"><label class="fl">í…Œë‘ë¦¬ ë‘ê»˜</label>
                  <div class="sl-g"><input type="range" id="graph-border-width" min="0" max="5" value="2"><span class="sl-v" id="graph-border-width-value">2px</span></div>
                </div>
              </div>
              <div class="fr">
                <div class="fg"><label class="fl">ì œëª© í¬ê¸°</label>
                  <div class="sl-g"><input type="range" id="title-font-size" min="10" max="40" value="20"><span class="sl-v" id="title-font-size-value">20px</span></div>
                </div>
                <div class="fg"><label class="fl">í†µê³„ í¬ê¸°</label>
                  <div class="sl-g"><input type="range" id="stats-font-size" min="10" max="40" value="16"><span class="sl-v" id="stats-font-size-value">16px</span></div>
                </div>
              </div>
              <div class="fg"><label class="fl">ë°” ë†’ì´</label>
                <div class="sl-g"><input type="range" id="progress-height" min="10" max="50" value="20"><span class="sl-v" id="progress-height-value">20px</span></div>
              </div>
              <div class="fr">
                <div class="fg"><label class="fl">ë°” ë°°ê²½</label><input type="color" class="fi" id="progress-bg-color" value="#2c2c2c" style="padding:2px;height:32px"></div>
                <div class="fg"><label class="fl">ë°” ì‹œì‘ìƒ‰</label><input type="color" class="fi" id="progress-start-color" value="#42b72a" style="padding:2px;height:32px"></div>
              </div>
              <div class="fr">
                <div class="fg"><label class="fl">ë°” ëìƒ‰</label><input type="color" class="fi" id="progress-end-color" value="#6bd464" style="padding:2px;height:32px"></div>
                <div class="fg"><label class="fl">ì™„ë£Œ ì‹œì‘ìƒ‰</label><input type="color" class="fi" id="complete-start-color" value="#ffd700" style="padding:2px;height:32px"></div>
              </div>
              <div class="fg"><label class="fl">ì™„ë£Œ ëìƒ‰</label><input type="color" class="fi" id="complete-end-color" value="#fff176" style="padding:2px;height:32px"></div>
              <div class="btn-g mt-m">
                <button class="btn btn-p" onclick="applyMissionGraphSettings()">ì €ì¥</button>
                <button class="btn btn-o" onclick="resetMissionGraphSettings()">ì´ˆê¸°í™”</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„¤ì • -->
      <div class="card">
        <div class="card-t fold-t" onclick="toggleFold(this)">ğŸ“Š ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„¤ì • <span class="fold-arrow">â–¶</span></div>
        <div class="fold-body" style="display:none">
          <div class="fchk"><input type="checkbox" id="totalOnly-showRankNames"><label>ë­í¬ ì´ë¦„ í‘œì‹œ</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-showEomsamyong"><label>ì—„ì‚¼ìš© í‘œì‹œ</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-fixEomsamyongFirst"><label>ì—„ì‚¼ìš© 1ìœ„ ê³ ì •</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-showOkgi"><label>ì˜¥ê¸” í‘œì‹œ</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-fixOkgiLast"><label>ì˜¥ê¸” ê¼´ì°Œ ê³ ì •</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-hideGukgo"><label>êµ­ê³  ìˆ¨ê¸°ê¸°</label></div>
          <div class="fchk mt-s"><input type="checkbox" id="totalOnly-fixGukgoLast"><label>êµ­ê³  ê¼´ì°Œ ê³ ì •</label></div>
          <div class="fg mt-m"><label class="fl">ë‹¨ìœ„</label>
            <div class="fchk"><input type="radio" name="totalOnly-currency" id="totalOnly-currencyManwon" value="manwon" checked><label>ë§Œì›</label></div>
            <div class="fchk"><input type="radio" name="totalOnly-currency" id="totalOnly-currencyWon" value="won"><label>ì›</label></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì±—ë´‡ -->
    <div class="view" id="view-chatbot">
      <div class="card">
        <div class="card-t">ğŸ¤– YouTube ì±—ë´‡</div>
        <div id="chatbot-steps">
          <!-- Step 1: ì¸ì¦ -->
          <div class="mb-m">
            <div class="fl" style="font-weight:600">1ë‹¨ê³„: ì¸ì¦</div>
            <div class="btn-g">
              <button class="btn btn-p btn-sm" id="google-oauth-btn" onclick="signInGoogleOAuth()">Google OAuth ë¡œê·¸ì¸</button>
              <button class="btn btn-o btn-sm" id="google-signout-btn" onclick="signOutGoogleOAuth()" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="google-auth-status" class="status status-info mt-s">ë¡œê·¸ì¸ í•„ìš”</div>
            <div class="mt-s">
              <button class="btn btn-o btn-sm" onclick="document.getElementById('api-key-section').style.display=document.getElementById('api-key-section').style.display==='none'?'block':'none'">API í‚¤ ë°©ì‹ (ëŒ€ì•ˆ)</button>
              <div id="api-key-section" style="display:none" class="mt-s">
                <div class="fg"><label class="fl">YouTube API í‚¤</label><input type="text" class="fi" id="youtube-api-key" placeholder="API í‚¤ ì…ë ¥"></div>
                <div class="btn-g"><button class="btn btn-sm btn-p" onclick="saveApiKey()">ì €ì¥</button><button class="btn btn-sm btn-o" onclick="testApiKey()">í…ŒìŠ¤íŠ¸</button></div>
              </div>
            </div>
          </div>
          <!-- Step 2: ë¼ì´ë¸Œ ì—°ê²° -->
          <div class="mb-m">
            <div class="fl" style="font-weight:600">2ë‹¨ê³„: ë¼ì´ë¸Œ ì—°ê²°</div>
            <div class="fg"><label class="fl">YouTube ì˜ìƒ ID</label><input type="text" class="fi" id="youtube-video-id" placeholder="ì˜ìƒ ID"></div>
            <div class="btn-g">
              <button class="btn btn-sm btn-p" onclick="connectToLiveChat()">ì—°ê²°</button>
              <button class="btn btn-sm btn-o" onclick="connectToLiveChatOAuth()">OAuth ì—°ê²°</button>
            </div>
            <div id="livechat-status" class="status status-info mt-s">ë¯¸ì—°ê²°</div>
          </div>
          <!-- Step 3: ë©”ì‹œì§€ ì „ì†¡ -->
          <div class="mb-m">
            <div class="fl" style="font-weight:600">3ë‹¨ê³„: ë©”ì‹œì§€ ì „ì†¡</div>
            <div class="fg"><textarea class="fi" id="chat-message" rows="2" placeholder="ì „ì†¡í•  ë©”ì‹œì§€"></textarea></div>
            <div class="btn-g">
              <button class="btn btn-sm btn-p" onclick="sendToYouTube()">ì „ì†¡</button>
              <button class="btn btn-sm btn-s" onclick="sendToYouTubeOAuth(document.getElementById('chat-message').value)">OAuth ì „ì†¡</button>
            </div>
          </div>
          <!-- ìë™ ì „ì†¡ -->
          <div class="mb-m">
            <div class="fl" style="font-weight:600">ìë™ ìš”ì•½ ì „ì†¡</div>
            <div class="btn-g">
              <button class="btn btn-sm btn-p" id="streamer-summary-chatbot-btn" onclick="sendStreamerSummaryToChatbot()">ğŸ“¤ ì´ì•¡ ì „ì†¡</button>
              <button class="btn btn-sm btn-p" id="mission-summary-chatbot-btn" onclick="sendMissionSummaryToChatbot()">ğŸ“¤ í€ë”© ì „ì†¡</button>
            </div>
            <div class="fchk mt-s">
              <input type="checkbox" id="chatbot-auto-notify" onchange="syncAutoNotifySettings()">
              <label>í›„ì› ìë™ ì•Œë¦¼</label>
            </div>
            <div id="auto-notify-status" class="status status-info mt-s">ë¹„í™œì„±í™”</div>
            <button class="btn btn-sm btn-o mt-s" id="quick-admin-btn" onclick="quickEnableAdmin()">ğŸ”“ ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”</button>
          </div>
        </div>
      </div>
    </div>


    <!-- ì¡°ì • -->
    <div class="view" id="view-adjustment">
      <div class="card">
        <div class="card-t">âš–ï¸ ìŠ¤íŠ¸ë¦¬ë¨¸ ê¸ˆì•¡ ì¡°ì •</div>
        <div class="fr">
          <div class="fg"><label class="fl">ìŠ¤íŠ¸ë¦¬ë¨¸</label><select class="fs" id="adjust-streamer"></select></div>
          <div class="fg"><label class="fl">ì¡°ì •ì•¡ (ë§Œì›)</label><input type="number" class="fi" id="adjust-amount" step="0.1" placeholder="ì–‘ìˆ˜=ì¶”ê°€, ìŒìˆ˜=ì°¨ê°"></div>
        </div>
        <div class="fg"><label class="fl">ì‚¬ìœ </label><input type="text" class="fi" id="adjust-reason" placeholder="ì¡°ì • ì‚¬ìœ "></div>
        <button class="btn btn-w btn-blk" onclick="adjustStreamerAmount()">ê¸ˆì•¡ ì¡°ì •</button>
      </div>
      <div class="card">
        <div class="card-t">ğŸ‘¤ í›„ì›ì ê¸ˆì•¡ ì¡°ì •</div>
        <div class="fg"><label class="fl">í›„ì›ìëª…</label><input type="text" class="fi" id="adjust-donor" placeholder="í›„ì›ì ì´ë¦„"></div>
        <div class="fg">
          <label class="fl">í›„ì› íƒ€ì…</label>
          <div style="display:flex;gap:15px;font-size:15px">
            <label><input type="radio" name="donor-paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label>
            <label><input type="radio" name="donor-paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label>
            <label><input type="radio" name="donor-paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label>
          </div>
        </div>
        <div class="fg"><label class="fl">ì¡°ì •ì•¡ (ë§Œì›)</label><input type="number" class="fi" id="adjust-donor-amount" step="0.1" placeholder="ì˜ˆ: +2.0 ë˜ëŠ” -1.0"></div>
        <button class="btn btn-w btn-blk" onclick="adjustDonorAmount()">ğŸ’ í›„ì›ì ê¸ˆì•¡ ì¡°ì •</button>
      </div>
    </div>

    <!-- ë°ì´í„° -->
    <div class="view" id="view-data">
      <div class="card">
        <div class="card-t">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</div>
        <div class="btn-g">
          <button class="btn btn-p" onclick="exportData()">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button>
          <button class="btn btn-o" onclick="document.getElementById('import-file').click()">ğŸ“¤ ê°€ì ¸ì˜¤ê¸°</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
        </div>
      </div>
      <div class="card">
        <div class="card-t">â˜ï¸ Google ë°±ì—…</div>
        <div class="btn-g">
          <button class="btn btn-p btn-sm" onclick="backupToGoogleDrive()">Drive ë°±ì—…</button>
          <button class="btn btn-o btn-sm" onclick="backupToGoogleSheet()">Sheets ë°±ì—…</button>
          <button class="btn btn-o btn-sm" onclick="restoreFromGoogleSheet()">Sheets ë³µì›</button>
        </div>
        <div class="fg mt-m"><label class="fl">Google Sheet ID</label>
          <div style="display:flex;gap:4px"><input type="text" class="fi" id="google-sheet-id" placeholder="Sheet ID"><button class="btn btn-sm btn-o" onclick="saveSheetId()">ì €ì¥</button></div>
        </div>
      </div>
      <div class="card">
        <div class="card-t">ğŸ”„ ì´ˆê¸°í™”</div>
        <button class="btn btn-e" onclick="showResetDialog()">ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- ì„¤ì • -->
    <div class="view" id="view-settings">
      <div class="card">
        <div class="card-t">ğŸ” ê´€ë¦¬ì ì„¤ì •</div>
        <div class="fchk"><input type="checkbox" id="admin-verified" onchange="toggleAdminMode()"><label for="admin-verified">ê´€ë¦¬ì ëª¨ë“œ</label></div>
        <div id="admin-password-section" class="mt-m" style="display:none">
          <div class="fg"><label class="fl">ë¹„ë°€ë²ˆí˜¸</label><input type="password" class="fi" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"></div>
          <button class="btn btn-p" onclick="verifyPassword()">í™•ì¸</button>
        </div>
      </div>
      <div class="card admin-only" style="display:none">
        <div class="card-t">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
        <div class="fg"><label class="fl">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" class="fi" id="new-password"></div>
        <div class="fg"><label class="fl">í™•ì¸</label><input type="password" class="fi" id="confirm-password"></div>
        <button class="btn btn-p" onclick="changePassword()">ë³€ê²½</button>
      </div>
      <div class="card">
        <div class="card-t">ğŸ¨ ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ë­í¬ ì„¤ì •</div>
        <div class="fg"><label class="fl">ë­í¬ í”„ë¦¬ì…‹</label>
          <select class="fs" id="rank-preset" onchange="setRankPreset(this.value)">
            <option value="">ì‚¬ìš©ì ì§€ì •</option>
            <option value="default">ê¸°ë³¸ (1ìœ„, 2ìœ„...)</option>
            <option value="medal">ë©”ë‹¬ (ğŸ¥‡ğŸ¥ˆğŸ¥‰)</option>
            <option value="crown">ì™•ê´€ (ğŸ‘‘ğŸ–ï¸ğŸ…)</option>
          </select>
        </div>
        <div id="rank-inputs"></div>
        <button class="btn btn-p mt-s" onclick="saveTableSettings()">ë­í¬ ì„¤ì • ì €ì¥</button>
      </div>
    </div>

  </div>
</div>

<!-- Panel 2: Summary -->
<div class="panel">
  <div class="tab-bar">
    <button class="tab-b active" data-tab="tab-summary">ìš”ì•½</button>
    <button class="tab-b" data-tab="tab-table">í…Œì´ë¸”</button>
    <button class="tab-b" data-tab="tab-ranking">ë­í‚¹</button>
    <button class="tab-b" data-tab="tab-settlement">ì •ì‚°</button>
  </div>
  <div class="p-body">
    <!-- ê¸°ë³¸ ìš”ì•½ -->
    <div class="tc active" id="tab-summary">
      <!-- ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="card-t" style="margin:0">ğŸ“Š ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡</div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm btn-o" onclick="toggleStreamerSummarySettings()">âš™ï¸ ì„¤ì •</button>
            <button class="btn btn-sm btn-o" onclick="copyText('summary-output')">ë³µì‚¬</button>
            <button class="btn btn-sm btn-p" id="streamer-summary-chatbot-btn" onclick="sendStreamerSummaryToChatbot()">ğŸ“¤ ì´ì•¡ ì „ì†¡</button>
          </div>
        </div>
        <div id="streamer-summary-settings" style="display:none;margin-bottom:10px;padding:10px;border:1px solid var(--bd);border-radius:8px;background:var(--bg2)">
          <div style="margin-bottom:8px">
            <label class="fl">ë¨¸ë¦¿ê¸€:</label>
            <input type="text" id="streamer-summary-header" class="fi" placeholder="ì˜ˆ: ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥" value="ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥">
          </div>
          <div style="margin-bottom:8px">
            <label class="fl">ê¼¬ë¦¿ê¸€:</label>
            <input type="text" id="streamer-summary-footer" class="fi" placeholder="ì˜ˆ: ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!" value="ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!">
          </div>
          <div style="margin-bottom:8px">
            <label style="font-size:15px"><input type="checkbox" id="exclude-gukgo"> êµ­ê³  ì œì™¸í•˜ê³  ê³„ì‚°</label>
          </div>
          <div style="display:flex;gap:5px">
            <button onclick="saveStreamerSummarySettings()" class="btn btn-sm btn-p">ì €ì¥</button>
            <button onclick="resetStreamerSummarySettings()" class="btn btn-sm btn-o">ê¸°ë³¸ê°’</button>
          </div>
        </div>
        <div id="summary-output" style="white-space:pre-wrap;font-size:15px;line-height:1.7;padding:8px;background:var(--bg2);border-radius:6px;min-height:40px"></div>
      </div>
      <!-- í€ë”© í˜„í™© -->
      <div class="card">
        <div class="card-t">ğŸ¯ í€ë”© í˜„í™©</div>
        <div id="mission-summary-output" class="text-sm">ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
      <!-- í›„ì›ìë³„ ì´ì•¡ -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="card-t" style="margin:0">ğŸ‘¥ í›„ì›ìë³„ ì´ì•¡</div>
          <button class="btn btn-sm btn-o" onclick="copyText('donor-total')">ë³µì‚¬</button>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;font-size:15px">
          <span>ê°™ì€ ê¸ˆì•¡ ë¬¶ê¸° (</span>
          <input type="number" id="group-threshold" value="2" min="1" class="fi" style="width:60px">
          <span>ëª… ì´ìƒ)</span>
          <button onclick="updateSummary()" class="btn btn-sm btn-p">ì ìš©</button>
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-bottom:6px">
          <label style="font-size:15px"><input type="checkbox" id="include-superchat"> ìŠˆí¼ì±— í¬í•¨</label>
        </div>
        <div id="donor-total" style="white-space:pre-wrap;font-size:15px;line-height:1.7;padding:8px;background:var(--bg2);border-radius:6px;min-height:40px"></div>
      </div>
      <!-- ìµœê·¼ ì…ê¸ˆ ë‚´ì—­ -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="card-t" style="margin:0">ğŸ’ ìµœê·¼ ì…ê¸ˆ ë‚´ì—­</div>
          <button class="btn btn-sm btn-o" onclick="copyText('recent-log')">ë³µì‚¬</button>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:6px;font-size:15px">
          <input type="number" id="recent-minutes" value="5" class="fi" style="width:70px">
          <span>ë¶„ ì´ë‚´</span>
          <button onclick="updateSummary()" class="btn btn-sm btn-p">ì¡°íšŒ</button>
        </div>
        <div id="recent-log" style="white-space:pre-wrap;font-size:15px;line-height:1.7;padding:8px;background:var(--bg2);border-radius:6px;min-height:40px"></div>
      </div>
    </div>
    <!-- ìƒì„¸ í…Œì´ë¸” -->
    <div class="tc" id="tab-table">
      <div class="tw"><table><thead><tr><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>ê³„ì¢Œì´ì²´</th><th>ìŠˆí¼ì±—</th><th>ê¸°íƒ€</th><th>í•©ê³„</th></tr></thead><tbody id="detailed-table-body"></tbody></table></div>
    </div>
    <!-- ë­í‚¹ -->
    <div class="tc" id="tab-ranking">
      <div class="fg">
        <div style="display:flex;gap:4px">
          <input type="text" class="fi" id="ranking-search-input" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ë˜ëŠ” í›„ì›ì ê²€ìƒ‰" onkeyup="searchRanking()">
          <button class="btn btn-sm btn-o" onclick="document.getElementById('ranking-search-input').value='';searchRanking()">ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div id="ranking-tabs" class="btn-g mb-m" style="display:none">
        <button class="btn btn-sm btn-p rank-tab active" onclick="switchRankingMode('streamer',event)">ìŠ¤íŠ¸ë¦¬ë¨¸ë³„</button>
        <button class="btn btn-sm btn-o rank-tab" onclick="switchRankingMode('donor',event)">í›„ì›ìë³„</button>
      </div>
      <div id="ranking-result"></div>
    </div>
    <!-- ì •ì‚° -->
    <div class="tc" id="tab-settlement">
      <div class="card">
        <div class="card-t">ğŸ’° ì •ì‚° ë‚´ì—­</div>
        <div class="fg">
          <label class="fl">ê¸°ë³¸ ìˆ˜ìˆ˜ë£Œ (%)</label>
          <div style="display:flex;gap:4px">
            <input type="number" class="fi" id="settlement-default-fee" value="10" min="0" max="100" step="0.1">
            <button class="btn btn-sm btn-o" onclick="applyDefaultFeeAll()">ì „ì²´ ì ìš©</button>
          </div>
        </div>
        <div class="tw">
          <table><thead><tr><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>ì´ í›„ì›ê¸ˆ</th><th>ìˆ˜ìˆ˜ë£Œ(%)</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ì •ì‚°ì•¡</th></tr></thead>
          <tbody id="settlement-table-body"></tbody></table>
        </div>
        <div style="margin-top:10px;padding:10px;background:var(--bg-sh);border-radius:var(--r-md);font-size:12px">
          <div style="display:flex;justify-content:space-between"><span>ì´ í›„ì›ê¸ˆ</span><span id="settlement-total-donation" style="font-weight:600">â‚©0</span></div>
          <div style="display:flex;justify-content:space-between"><span>ì´ ìˆ˜ìˆ˜ë£Œ</span><span id="settlement-total-fee" style="color:var(--c-error)">-â‚©0</span></div>
          <div style="display:flex;justify-content:space-between;border-top:1px solid var(--bd);padding-top:6px;margin-top:6px"><span style="font-weight:600">ì´ ì •ì‚°ì•¡</span><span id="settlement-total-amount" style="font-weight:700;color:var(--c-success)">â‚©0</span></div>
        </div>
        <div class="btn-g mt-m">
          <button class="btn btn-sm btn-p" onclick="exportSettlementCSV()">ğŸ“¥ CSV</button>
          <button class="btn btn-sm btn-o" onclick="copySettlementText()">ğŸ“‹ ë³µì‚¬</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Panel 3: History -->
<div class="panel">
  <div class="p-hd">
    <h2>í›„ì› ë‚´ì—­ (<span id="donation-count">0</span>)</h2>
    <div style="display:flex;gap:4px">
      <button class="btn btn-sm btn-e" onclick="deleteSelected()">ì‚­ì œ</button>
    </div>
  </div>
  <div class="qa-row">
    <input type="text" id="quick-donor" placeholder="í›„ì›ì">
    <select id="quick-streamer"></select>
    <select id="quick-type"><option value="ê³„ì¢Œ">ê³„ì¢Œ</option><option value="íˆ¬ë„¤">íˆ¬ë„¤</option><option value="ìŠˆí¼ì±—">ìŠˆì±—</option></select>
    <input type="number" id="quick-amount" placeholder="ë§Œì›" step="0.1" style="width:60px">
    <button class="btn btn-sm btn-p" onclick="quickAddDonation()">+</button>
  </div>
  <div style="padding:6px;border-bottom:1px solid var(--bd)">
    <div style="display:flex;gap:4px">
      <input type="text" class="fi" id="donation-search" placeholder="ê²€ìƒ‰..." oninput="filterDonationTable()" style="padding:4px 8px;font-size:11px">
      <button class="btn btn-sm btn-o" onclick="clearDonationSearch()">X</button>
    </div>
    <div id="donation-search-count" style="display:none;font-size:10px;color:var(--tx2);margin-top:3px"></div>
  </div>
  <div style="flex:1;overflow-y:auto">
    <table><thead><tr><th style="width:30px"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th><th>#</th><th>í›„ì›ì</th><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ì‹œê°„</th></tr></thead>
    <tbody id="data-table-body"></tbody></table>
  </div>
</div>
</div><!-- /main -->

<!-- Reset Modal -->
<div class="modal-ov" id="reset-modal">
  <div class="modal">
    <h3>ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</h3>
    <p style="font-size:13px;color:var(--tx2);margin-bottom:14px">ëª¨ë“  í›„ì› ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ë°±ì—… í›„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="btn-g" style="justify-content:flex-end">
      <button class="btn btn-o" onclick="closeResetModal()">ì·¨ì†Œ</button>
      <button class="btn btn-w" onclick="backupAndReset()">ë°±ì—… í›„ ì´ˆê¸°í™”</button>
      <button class="btn btn-e" onclick="confirmReset()">ë°”ë¡œ ì´ˆê¸°í™”</button>
    </div>
  </div>
</div>

<script>
// ==================== SECTION 1: CONFIG ====================
const CONFIG = {
  GOOGLE: { CLIENT_ID: '493287022430-cnkrjl4ssesgvqje6aa4d323hh9pnub4.apps.googleusercontent.com', API_KEY: 'AIzaSyDe02l9470H3LIf3IB3D3zSfQFuNS9Sgfw', SCOPES: 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets' },
  STORAGE_KEYS: { DONATIONS: 'donation_data', STREAMERS: 'streamer_config', EMOJIS: 'streamer_emojis', MISSIONS: 'mission_data', PASSWORD: 'admin_password', YOUTUBE_API_KEY: 'youtube_api_key', YOUTUBE_VIDEO_ID: 'youtube_video_id' },
  OVERLAYS: [
    { id: 'donor', name: 'í›„ì›ì ëª©ë¡', file: 'donor-overlay.html', desc: 'ì‹¤ì‹œê°„ í›„ì›ì ëª©ë¡' },
    { id: 'table', name: 'ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸”', file: 'streamer-table-overlay.html', desc: 'ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™©' },
    { id: 'total', name: 'ì´ì•¡ ëª©í‘œ', file: 'total-goal-overlay.html', desc: 'ì´ì•¡ ë‹¬ì„± ê·¸ë˜í”„' },
    { id: 'mission', name: 'ë¯¸ì…˜ ê·¸ë˜í”„', file: 'mission-graph-overlay.html', desc: 'í€ë”© ë¯¸ì…˜ ì§„í–‰ë¥ ' },
    { id: 'mobile', name: 'ëª¨ë°”ì¼ í›„ì›ì', file: 'mobile-donor-overlay.html', desc: 'ëª¨ë°”ì¼ìš© í›„ì›ì ëª©ë¡' }
  ]
};

// ==================== SECTION 2: STATE ====================
let donations = [], streamers = [], emojis = {}, missions = [], runningMissions = [], missionAdjustments = [];
let currentData = { settings: {} };
let socket = null, isAdminVerified = false, isSuperAdmin = false;
let liveChatId = null, isOAuthSignedIn = false, autoSendInterval = null;
let currentRankingMode = 'streamer';
let autoCompletedMissions = new Set();
let apiKeys = [], currentKeyIndex = 0;

// ==================== SECTION 3: CORE ====================
// Global fetch wrapper - always include credentials for session auth
const _origFetch = window.fetch;
window.fetch = function(url, opts = {}) {
  if (typeof url === 'string' && url.startsWith('/')) {
    opts.credentials = 'include';
  }
  return _origFetch.call(this, url, opts);
};

function initializeApp() {
  try {
    loadFromLocalStorage();
    initActiveStreamers();
    if (localStorage.getItem('sidebar-mini') === 'true') document.querySelector('.sidebar').classList.add('mini');
    connectSocket();
    setupRouter();
    initMobilePanels();
    setupTabBar();
    setupAutoComplete();
    populateStreamerSelects();
    renderOverlayCards();
    bindOverlaySliders();
    bindTotalOnlyEvents();
    updateAllUI();
    initializeAutoNotifySync();
    loadYouTubeSettings();
    loadOverlaySettings();
    loadTableSettingsFromServer();
    updateWebhookURL();
    initGoogleAPI();
  } catch(e) { console.error('Init error:', e); }
}

function connectSocket() {
  socket = io();
  socket.on('connect', () => { showToast('ì„œë²„ ì—°ê²°ë¨', 'success'); updateBadge('connected'); });
  socket.on('disconnect', () => { showToast('ì„œë²„ ì—°ê²° ëŠê¹€', 'error'); updateBadge('disconnected'); });
  socket.on('initialData', (data) => { applyServerData(data); updateAllUI(); });
  socket.on('dataUpdate', (data) => { applyServerData(data); updateAllUI(); });
}

function applyServerData(data) {
  if (!data) return;
  donations = data.donations || [];
  streamers = data.streamers || [];
  emojis = data.emojis || {};
  missions = data.missions || [];
  runningMissions = data.runningMissions || [];
  missionAdjustments = data.missionAdjustments || [];
  currentData = data;
  currentData.settings = data.settings || {};
  saveToLocalStorage();
  applyServerSettingsToUI(currentData.settings);
}

function updateBadge(state) {
  const b = document.getElementById('connection-badge');
  if (state === 'connected') { b.textContent = 'ì—°ê²°ë¨'; b.className = 'badge badge-s'; }
  else { b.textContent = 'ì—°ê²°ëŠê¹€'; b.className = 'badge badge-e'; }
}

function saveToLocalStorage() {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEYS.DONATIONS, JSON.stringify(donations));
    localStorage.setItem(CONFIG.STORAGE_KEYS.STREAMERS, JSON.stringify(streamers));
    localStorage.setItem(CONFIG.STORAGE_KEYS.EMOJIS, JSON.stringify(emojis));
    localStorage.setItem(CONFIG.STORAGE_KEYS.MISSIONS, JSON.stringify(missions));
  } catch(e) {}
}

function loadFromLocalStorage() {
  try {
    const d = localStorage.getItem(CONFIG.STORAGE_KEYS.DONATIONS);
    const s = localStorage.getItem(CONFIG.STORAGE_KEYS.STREAMERS);
    const e = localStorage.getItem(CONFIG.STORAGE_KEYS.EMOJIS);
    const m = localStorage.getItem(CONFIG.STORAGE_KEYS.MISSIONS);
    if (d) donations = JSON.parse(d);
    if (s) streamers = JSON.parse(s);
    if (e) emojis = JSON.parse(e);
    if (m) missions = JSON.parse(m);
  } catch(e) {}
}

async function syncToServer() {
  try {
    const res = await fetch('/api/data');
    if (res.ok) { const data = await res.json(); applyServerData(data); updateAllUI(); }
  } catch(e) {}
}

// ==================== SECTION 4: UI HELPERS ====================
function showToast(msg, type = 'info', duration = 3000) {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.classList.add('toast-x'); setTimeout(() => t.remove(), 300); }, duration);
}

// Keep backward compat with showStatus
function showStatus(msg, type) { showToast(msg.replace(/[âœ…âŒâš ï¸ğŸ”„ğŸ“¤ğŸ“ŠğŸ’°ğŸ¨ğŸ”§ğŸ¯ğŸ”¢ğŸ“‹ğŸ”“]/g, '').trim(), type === 'saved' ? 'saved' : type); }

function debounce(fn, ms = 300) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }

function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? 'light' : 'dark');
  document.getElementById('theme-icon').textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('theme', isDark ? 'light' : 'dark');
}

function togglePanel(id) { document.getElementById(id).classList.toggle('open'); }
function toggleSidebar() {
  const sb = document.querySelector('.sidebar');
  sb.classList.toggle('mini');
  localStorage.setItem('sidebar-mini', sb.classList.contains('mini'));
}
function toggleFold(titleEl) {
  const body = titleEl.nextElementSibling;
  const arrow = titleEl.querySelector('.fold-arrow');
  if (!body) return;
  const isHidden = body.style.display === 'none';
  body.style.display = isHidden ? '' : 'none';
  if (arrow) arrow.textContent = isHidden ? 'â–¼' : 'â–¶';
}

// ==================== MOBILE PANEL TABS ====================
function initMobilePanels() {
  const mq = window.matchMedia('(max-width:768px)');
  function apply() {
    const panels = document.querySelectorAll('.main > .panel');
    if (mq.matches) {
      panels.forEach((p, i) => p.classList.toggle('mob-active', i === 0));
    } else {
      panels.forEach(p => p.classList.remove('mob-active'));
    }
  }
  mq.addEventListener('change', apply);
  apply();
}

function switchMobPanel(idx, btn) {
  document.querySelectorAll('.mob-panel-tabs button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.main > .panel').forEach((p, i) => p.classList.toggle('mob-active', i === idx));
}

// ==================== SECTION 5: ROUTER ====================
function setupRouter() {
  document.querySelectorAll('#sidebar-nav .nav-i').forEach(item => {
    item.addEventListener('click', () => {
      const view = item.dataset.view;
      document.querySelectorAll('#sidebar-nav .nav-i').forEach(n => n.classList.remove('active'));
      item.classList.add('active');
      document.querySelectorAll('#panel1-body .view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + view).classList.add('active');
      document.getElementById('panel1-title').textContent = item.querySelector('.lb').textContent;
      if (view === 'overlay') { renderOverlayCards(); loadOverlaySettings(); }
      if (view === 'streamer') updateStreamerList();
      if (view === 'mission') updateRunningMissionsList();
    });
  });
  // Load saved theme
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); document.getElementById('theme-icon').textContent = 'â˜€ï¸'; }
}

function setupTabBar() {
  document.querySelectorAll('.tab-bar .tab-b').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      const bar = btn.parentElement;
      const body = bar.nextElementSibling;
      bar.querySelectorAll('.tab-b').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      body.querySelectorAll('.tc').forEach(t => t.classList.remove('active'));
      body.querySelector('#' + tab).classList.add('active');
      if (tab === 'tab-settlement') updateSettlementTable();
    });
  });
}

// ==================== SECTION 6: DONATION ====================
const activeStreamers = new Set(); // ì¶œì²µëœ ìŠ¤íŠ¸ë¦¬ë¨¸

function initActiveStreamers() {
  const saved = JSON.parse(localStorage.getItem('active-streamers') || 'null');
  if (saved && Array.isArray(saved)) saved.forEach(s => activeStreamers.add(s));
  else (streamers || []).forEach(s => activeStreamers.add(s)); // ê¸°ë³¸: ì „ì²´ í™œì„±
}

function saveActiveStreamers() {
  localStorage.setItem('active-streamers', JSON.stringify([...activeStreamers]));
}

function toggleStreamerActive(name) {
  if (activeStreamers.has(name)) activeStreamers.delete(name);
  else activeStreamers.add(name);
  saveActiveStreamers();
  updateAllUI();
}

function updateStreamerInputs() {
  const container = document.getElementById('streamer-inputs');
  if (!container) return;
  container.innerHTML = (streamers || []).filter(s => activeStreamers.has(s)).map(s =>
    `<div style="display:flex;flex-direction:column;gap:2px">
      <label style="font-size:14px;font-weight:600">${emojis[s] || ''}${s}</label>
      <input type="number" min="0" step="0.1" data-streamer="${s}" placeholder="0" class="fi" style="padding:6px 8px">
    </div>`
  ).join('');
}

function addDonation() {
  const donor = document.getElementById('donor-input').value.trim();
  if (!donor) { showToast('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  const inputs = document.querySelectorAll('#streamer-inputs input[type="number"]');
  const type = document.querySelector('input[name="paytype"]:checked').value;
  const newDons = [];
  inputs.forEach(input => {
    const amount = parseFloat(input.value);
    if (!isNaN(amount) && amount > 0) {
      newDons.push({ donor, streamer: input.dataset.streamer, type, amount, time: new Date() });
    }
  });
  if (newDons.length > 0) {
    document.getElementById('donor-input').value = '';
    inputs.forEach(input => input.value = '');
    handleNewDonations(newDons);
  } else {
    showToast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning');
  }
}

async function handleNewDonations(newDonations) {
  if (!newDonations || newDonations.length === 0) return;
  donations.unshift(...newDonations);
  donations.sort((a, b) => new Date(b.time) - new Date(a.time));
  updateAllUI();

  try {
    for (const donation of newDonations) {
      const res = await fetch('/api/donations', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ donor: donation.donor, streamer: donation.streamer, type: donation.type, amount: donation.amount })
      });
      if (!res.ok) showToast('ì„œë²„ ì „ì†¡ ì‹¤íŒ¨', 'error');
    }
    showToast('í›„ì› ë“±ë¡ ì™„ë£Œ', 'success');
  } catch(e) {
    showToast('ì„œë²„ ì˜¤ë¥˜ (ë¡œì»¬ ì €ì¥ë¨)', 'error');
  }

  if (document.getElementById('auto-chat-notify')?.checked && liveChatId) {
    sendDonationNotification(newDonations);
  }
}

function quickAddDonation() {
  const donor = document.getElementById('quick-donor').value.trim();
  const streamer = document.getElementById('quick-streamer').value;
  const type = document.getElementById('quick-type').value;
  const amount = parseFloat(document.getElementById('quick-amount').value);
  if (!donor || !streamer || !amount) { showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  const newDons = [{ donor, streamer, type, amount, time: new Date() }];
  document.getElementById('quick-donor').value = '';
  document.getElementById('quick-amount').value = '';
  handleNewDonations(newDons);
}

async function deleteSelected() {
  const checked = document.querySelectorAll('#data-table-body input[type="checkbox"]:checked');
  if (checked.length === 0) { showToast('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”', 'warning'); return; }
  if (!confirm(`${checked.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  let deleted = 0;
  for (const cb of checked) {
    const id = cb.dataset.id;
    if (!id || id === 'undefined') continue;
    try {
      const res = await fetch(`/api/donations/${encodeURIComponent(id)}`, { method: 'DELETE' });
      if (res.ok) deleted++;
    } catch(e) {}
  }
  showToast(`${deleted}ê°œ ì‚­ì œë¨`, 'success');
}

function toggleSelectAll() {
  const all = document.getElementById('select-all').checked;
  document.querySelectorAll('#data-table-body input[type="checkbox"]').forEach(c => c.checked = all);
}

// ==================== SECTION 7: STREAMER ====================
function addStreamer() {
  const name = document.getElementById('new-streamer-name').value.trim();
  const emoji = document.getElementById('new-streamer-emoji').value.trim();
  if (!name) { showToast('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (streamers.includes(name)) { showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤', 'warning'); return; }

  fetch('/api/streamers', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, emoji })
  }).then(r => r.json()).then(data => {
    if (data.success) {
      showToast(`${emoji} ${name} ì¶”ê°€ë¨`, 'success');
      document.getElementById('new-streamer-name').value = '';
      document.getElementById('new-streamer-emoji').value = '';
    } else { showToast('ì¶”ê°€ ì‹¤íŒ¨: ' + (data.error || ''), 'error'); }
  }).catch(() => showToast('ì„œë²„ ì˜¤ë¥˜', 'error'));
}

function deleteStreamer(name) {
  if (!confirm(`${name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  fetch(`/api/streamers/${encodeURIComponent(name)}`, { method: 'DELETE' })
    .then(r => r.json()).then(data => {
      if (data.success) showToast(`${name} ì‚­ì œë¨`, 'success');
      else showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
    }).catch(() => showToast('ì„œë²„ ì˜¤ë¥˜', 'error'));
}

function updateStreamerList() {
  const el = document.getElementById('streamer-list');
  el.innerHTML = streamers.map(s => {
    const isActive = activeStreamers.has(s);
    return `<span class="str-chip${isActive ? '' : ' inactive'}">
      <label style="cursor:pointer;display:flex;align-items:center;gap:4px">
        <input type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleStreamerActive('${s}')">
        ${emojis[s] || ''} ${s}
      </label>
      <span class="del" onclick="deleteStreamer('${s}')">&times;</span>
    </span>`;
  }).join('');
}

function populateStreamerSelects() {
  const active = streamers.filter(s => activeStreamers.has(s));
  const selects = ['mission-streamer', 'quick-streamer', 'adjust-streamer'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    const val = sel.value;
    sel.innerHTML = active.map(s => `<option value="${s}">${emojis[s] || ''} ${s}</option>`).join('');
    if (val && active.includes(val)) sel.value = val;
  });
}

// ==================== SECTION 8: UPDATE UI ====================
function updateAllUI() {
  populateStreamerSelects();
  updateStreamerInputs();
  updateTable();
  updateSummary();
  updateMissionSummary();
  updateDetailedSummaryTable();
  updateRunningMissionsList();
  updateSettlementTable();
  updateStreamerList();
  document.getElementById('donation-count').textContent = donations.length;
}

function updateTable() {
  const tbody = document.getElementById('data-table-body');
  if (!tbody) return;
  const frag = document.createDocumentFragment();
  const sorted = [...donations].reverse();
  sorted.forEach((d, i) => {
    const tr = document.createElement('tr');
    const time = d.time ? new Date(d.time).toLocaleString('ko-KR', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit' }) : '';
    tr.innerHTML = `<td><input type="checkbox" data-id="${d.time}"></td><td>${donations.length - i}</td><td>${d.donor||''}</td><td>${emojis[d.streamer]||''} ${d.streamer||''}</td><td>${d.type||''}</td><td>${d.amount||0}</td><td style="font-size:10px;color:var(--tx3)">${time}</td>`;
    tr.querySelectorAll('td').forEach((td, ci) => {
      if (ci >= 2 && ci <= 5) td.ondblclick = () => makeCellEditable(td, d, ['donor','streamer','type','amount'][ci-2]);
    });
    frag.appendChild(tr);
  });
  tbody.innerHTML = '';
  tbody.appendChild(frag);
}

function makeCellEditable(td, donation, field) {
  const original = td.textContent.trim();
  if (field === 'streamer') {
    const sel = document.createElement('select');
    sel.className = 'fs';
    sel.style.cssText = 'padding:2px;font-size:11px';
    streamers.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = `${emojis[s]||''} ${s}`; sel.appendChild(o); });
    sel.value = donation.streamer;
    td.innerHTML = '';
    td.appendChild(sel);
    sel.focus();
    const save = () => { donation[field] = sel.value; saveBulkUpdate(donation); };
    sel.onchange = save;
    sel.onblur = save;
  } else if (field === 'type') {
    const sel = document.createElement('select');
    sel.className = 'fs';
    sel.style.cssText = 'padding:2px;font-size:11px';
    ['ê³„ì¢Œì´ì²´','ìŠˆí¼ì±—','íˆ¬ë„¤ì´ì…˜','ë³„í’ì„ ','ì¹˜ì¦ˆ','ê¸°íƒ€'].forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o); });
    sel.value = donation.type;
    td.innerHTML = '';
    td.appendChild(sel);
    sel.focus();
    const save = () => { donation[field] = sel.value; saveBulkUpdate(donation); };
    sel.onchange = save;
    sel.onblur = save;
  } else {
    const inp = document.createElement('input');
    inp.className = 'fi';
    inp.style.cssText = 'padding:2px;font-size:11px';
    inp.type = field === 'amount' ? 'number' : 'text';
    inp.value = field === 'amount' ? donation.amount : original;
    td.innerHTML = '';
    td.appendChild(inp);
    inp.focus();
    inp.select();
    const save = () => {
      donation[field] = field === 'amount' ? parseFloat(inp.value) || 0 : inp.value.trim();
      saveBulkUpdate(donation);
    };
    inp.onblur = save;
    inp.onkeydown = (e) => { if (e.key === 'Enter') save(); if (e.key === 'Escape') updateTable(); };
  }
}

async function saveBulkUpdate(donation) {
  try {
    await fetch('/api/donations/bulk', {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ donations: [donation] })
    });
  } catch(e) { showToast('ìˆ˜ì • ì‹¤íŒ¨', 'error'); }
}

let isApplyingServerSettings = false;

function updateSummary() {
  let streamerTotals = {}, totalAmount = 0;
  (streamers || []).forEach(s => streamerTotals[s] = 0);
  if (!streamerTotals.hasOwnProperty('êµ­ê³ ')) streamerTotals['êµ­ê³ '] = 0;

  let donorAccountTotals = {};

  donations.forEach(d => {
    const amount = parseFloat(d.amount) || 0;
    if (d.excludeFromTotal || d.isMissionAdjustment) return;
    if (streamerTotals.hasOwnProperty(d.streamer)) {
      streamerTotals[d.streamer] += amount;
    } else {
      streamerTotals['êµ­ê³ '] = (streamerTotals['êµ­ê³ '] || 0) + amount;
    }
    totalAmount += amount;

    const includeSuperchat = document.getElementById('include-superchat')?.checked;
    const shouldInclude = d.type === 'ê³„ì¢Œ' || (includeSuperchat && d.type === 'ìŠˆí¼ì±—');
    if (shouldInclude) {
      if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') return;
      let cleanDonorName = d.donor;
      if (cleanDonorName.includes('(ì¡°ì •')) cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '');
      if (cleanDonorName === 'ê³„ì¢Œí›„ì›ìë‹˜' || cleanDonorName === 'ê³„ì¢Œí›„ì›ì') cleanDonorName = 'ê³„ì¢Œí›„ì›ìë‹˜';
      donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
    }
  });

  // ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì • ë¡œë“œ
  const headerText = localStorage.getItem('streamer-summary-header') || 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
  const footerText = localStorage.getItem('streamer-summary-footer') || 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
  const excludeGukgoValue = localStorage.getItem('exclude-gukgo');
  const excludeGukgo = excludeGukgoValue === null ? false : excludeGukgoValue === 'true';

  // ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë¨¸ ë°ì´í„° ê³„ì‚°
  const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
  const summaryStreamers = (streamers || []).filter(s => s !== 'í›„ì›ìì¡°ì •' && !hiddenStreamers.includes(s) && activeStreamers.has(s));
  const streamerDetailData = {};
  summaryStreamers.forEach(s => { streamerDetailData[s] = { name: s, account: 0, toonation: 0, total: 0 }; });
  donations.forEach(d => {
    if (streamerDetailData.hasOwnProperty(d.streamer)) {
      const amount = parseFloat(d.amount) || 0;
      if (d.type === 'ê³„ì¢Œ') streamerDetailData[d.streamer].account += amount;
      else if (d.type === 'íˆ¬ë„¤') streamerDetailData[d.streamer].toonation += amount;
      else if (d.type === 'ìŠˆí¼ì±—' && d.streamer === 'êµ­ê³ ') streamerDetailData[d.streamer].account += amount;
    }
  });

  // ì´ì•¡ ê³„ì‚° í›„ ì •ë ¬ (êµ­ê³  ì œì™¸í•˜ê³  ì •ë ¬)
  let sortedDetailStreamers = Object.values(streamerDetailData).filter(data => data.name !== 'êµ­ê³ ').map(data => {
    data.total = data.account + data.toonation;
    return data;
  }).sort((a, b) => b.total - a.total);

  // ì—„ì‚¼ìš© ìš°ì„  ë°°ì¹˜
  if (sortedDetailStreamers.find(s => s.name === 'ì—„ì‚¼ìš©')) {
    const samyongData = sortedDetailStreamers.find(s => s.name === 'ì—„ì‚¼ìš©');
    sortedDetailStreamers = sortedDetailStreamers.filter(s => s.name !== 'ì—„ì‚¼ìš©');
    sortedDetailStreamers.unshift(samyongData);
  }

  const samyongSchool = sortedDetailStreamers.map(s => `${emojis[s.name] || ''}${s.name}(${parseFloat(s.total.toFixed(1))})`).join(' ');

  // êµ­ê³  ë°ì´í„° ê³„ì‚°
  const gukgoData = streamerDetailData['êµ­ê³ '] || { account: 0, toonation: 0, total: 0 };
  gukgoData.total = gukgoData.account + gukgoData.toonation;

  // ì´í•© ê³„ì‚° (êµ­ê³  ì œì™¸ ì˜µì…˜ì— ë”°ë¼)
  const streamerOnlyTotal = sortedDetailStreamers.reduce((sum, s) => sum + s.total, 0);
  const displayTotalAmount = excludeGukgo ? streamerOnlyTotal : streamerOnlyTotal + gukgoData.total;

  // í€ë”© ì„±ê³µ ê²°ê³¼ í…ìŠ¤íŠ¸ ìƒì„±
  let missionResultText = '';
  const activeMissions = runningMissions.filter(m => m.status === 'running' || m.status === 'completed' || m.status === 'success');

  if (activeMissions.length > 0) {
    const missionWithInfo = activeMissions.map(mission => {
      const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
      const missionAdjustments = (window.currentData?.missionAdjustments || []).filter(adj =>
        adj.streamer === mission.streamer && new Date(adj.time) >= new Date(mission.startTime)
      );
      const adjustmentAmount = missionAdjustments.reduce((sum, adj) => sum + (parseFloat(adj.amount) || 0), 0);
      const donationAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
      const currentAmount = donationAmount + adjustmentAmount;
      const remaining = (parseFloat(mission.target) || 0) - currentAmount;

      if (remaining <= 0 && mission.status === 'running') {
        mission.status = 'success';
        mission.completedTime = Date.now();
        autoCompleteMission(mission.id);
      }

      return { ...mission, currentAmount, remaining, isSuccess: mission.status === 'success' || remaining <= 0 };
    });

    const successMissions = missionWithInfo.filter(m => m.isSuccess);
    if (successMissions.length > 0) {
      const successTexts = successMissions.map(m => `${emojis[m.streamer] || ''}${m.streamer}(ì„±ê³µ!)`);
      missionResultText = ` ğŸ„í€ë”©ğŸ„ ${successTexts.join(' ')}`;
    }
  }

  // ì¶œë ¥ í˜•ì‹
  let summaryText = `${headerText} ${samyongSchool}`;
  if (!excludeGukgo) summaryText += ` ğŸ¦êµ­ê³ (${parseFloat(gukgoData.total.toFixed(1))})`;
  summaryText += ` ğŸ’µì´í•©(${parseFloat(displayTotalAmount.toFixed(1))}) ${footerText}${missionResultText}`;

  document.getElementById('summary-output').textContent = summaryText;

  // í›„ì›ìë³„ ì´ì•¡ (donor-total)
  const groupThreshold = parseInt(document.getElementById('group-threshold')?.value, 10) || 2;
  const includeSuperchat = document.getElementById('include-superchat')?.checked;

  localStorage.setItem('group-threshold', groupThreshold.toString());
  localStorage.setItem('include-superchat', (!!includeSuperchat).toString());

  if (!isApplyingServerSettings) {
    try {
      fetch('/api/settings', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings: { groupThreshold, includeSuperchat: !!includeSuperchat } })
      }).catch(() => {});
    } catch(e) {}
  }

  const amountGroups = {};
  for (const donor in donorAccountTotals) {
    const amount = donorAccountTotals[donor];
    if (amount > 0) {
      if (!amountGroups[amount]) amountGroups[amount] = [];
      amountGroups[amount].push(donor);
    }
  }

  const filteredGroups = Object.entries(amountGroups).filter(([amount]) => parseFloat(amount) >= 0.1);
  const sortedGroups = filteredGroups.sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
  const donorTotalText = sortedGroups.flatMap(([amount, donors]) => {
    const amountStr = `${parseFloat(amount).toFixed(1)}ë§Œ`;
    if (donors.length >= groupThreshold) {
      return [`${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`];
    } else {
      return donors.map(d => `${d}ë‹˜ ${amountStr}`);
    }
  }).join('\n');

  const finalText = donorTotalText ? `ì‚¬ë‘í•´ìš˜â™¡\n${donorTotalText}` : 'ì‚¬ë‘í•´ìš˜â™¡\ní›„ì›ìê°€ ì—†ìŠµë‹ˆë‹¤';
  document.getElementById('donor-total').textContent = finalText;

  // ìµœê·¼ ì…ê¸ˆ ë‚´ì—­ (recent-log)
  const minutes = parseInt(document.getElementById('recent-minutes')?.value, 10) || 5;
  const recentDonations = (donations || []).filter(d => (Date.now() - new Date(d.time).getTime()) < minutes * 60 * 1000);
  const groupedDonations = recentDonations.reduce((acc, d) => {
    const key = `${d.donor}-${new Date(d.time).getTime()}`;
    if (!acc[key]) acc[key] = { donor: d.donor, donations: [], time: d.time };
    acc[key].donations.push(d);
    return acc;
  }, {});
  document.getElementById('recent-log').textContent = Object.values(groupedDonations).sort((a, b) => b.time - a.time).map(group => {
    const donationTexts = group.donations.map(d => {
      const totalForStreamer = parseFloat((streamerTotals[d.streamer] || 0).toFixed(1));
      return `${emojis[d.streamer] || ''}${d.streamer} (+${parseFloat(d.amount).toFixed(1)}/${totalForStreamer})`;
    }).join(', ');
    const types = [...new Set(group.donations.map(d => d.type))].join('/');
    return `ğŸ’ ${group.donor}ë‹˜(${types}) > ${donationTexts} ê°ì‚¬í•©ë‹ˆë‹¤!`;
  }).join('\n');

  updateMissionSummary();
  updateDetailedSummaryTable();
  updateSettlementTable();
}

// í…ìŠ¤íŠ¸ ë³µì‚¬ í•¨ìˆ˜
function copyText(elementId) {
  const el = document.getElementById(elementId);
  if (!el) return;
  const text = el.textContent || el.innerText;
  navigator.clipboard.writeText(text).then(() => showToast('ë³µì‚¬ë¨!', 'success')).catch(() => showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error'));
}

// ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì • í† ê¸€
function toggleStreamerSummarySettings() {
  const el = document.getElementById('streamer-summary-settings');
  if (!el) return;
  const isHidden = el.style.display === 'none';
  el.style.display = isHidden ? 'block' : 'none';
  if (isHidden) {
    const h = document.getElementById('streamer-summary-header');
    const f = document.getElementById('streamer-summary-footer');
    const g = document.getElementById('exclude-gukgo');
    if (h) h.value = localStorage.getItem('streamer-summary-header') || 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
    if (f) f.value = localStorage.getItem('streamer-summary-footer') || 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
    if (g) g.checked = localStorage.getItem('exclude-gukgo') === 'true';
  }
}

function saveStreamerSummarySettings() {
  const h = document.getElementById('streamer-summary-header')?.value;
  const f = document.getElementById('streamer-summary-footer')?.value;
  const g = document.getElementById('exclude-gukgo')?.checked;
  if (h !== undefined) localStorage.setItem('streamer-summary-header', h);
  if (f !== undefined) localStorage.setItem('streamer-summary-footer', f);
  localStorage.setItem('exclude-gukgo', (!!g).toString());
  updateSummary();
  showToast('ì„¤ì • ì €ì¥ë¨', 'success');
}

function resetStreamerSummarySettings() {
  localStorage.setItem('streamer-summary-header', 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥');
  localStorage.setItem('streamer-summary-footer', 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!');
  localStorage.setItem('exclude-gukgo', 'false');
  const h = document.getElementById('streamer-summary-header');
  const f = document.getElementById('streamer-summary-footer');
  const g = document.getElementById('exclude-gukgo');
  if (h) h.value = 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
  if (f) f.value = 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
  if (g) g.checked = false;
  updateSummary();
  showToast('ê¸°ë³¸ê°’ ë³µì›ë¨', 'success');
}

function updateMissionSummary() {
  const el = document.getElementById('mission-summary-output');
  if (!el) return;
  const running = runningMissions.filter(m => m.status === 'running');
  if (running.length === 0) { el.innerHTML = 'ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }

  const valid = donations.filter(d => !d.excludeFromTotal && !d.isMissionAdjustment);
  let html = '';
  running.forEach(m => {
    const streamerDonations = valid.filter(d => d.streamer === m.streamer);
    const totalAmount = streamerDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0) + (m.initialAmount || 0);
    const target = m.target || 100;
    const pct = Math.min(100, (totalAmount / target * 100)).toFixed(1);
    const emoji = emojis[m.streamer] || '';
    html += `<div style="margin-bottom:8px"><div style="font-size:12px;font-weight:600">${emoji} ${m.description || m.streamer + ' í€ë”©'}</div>`;
    html += `<div style="font-size:11px;color:var(--tx2)">${parseFloat(totalAmount.toFixed(1))}/${target}ë§Œì› (${pct}%)</div>`;
    html += `<div class="pg-bar"><div class="pg-fill" style="width:${pct}%">${pct}%</div></div></div>`;
    if (totalAmount >= target) autoCompleteMission(m.id);
  });
  el.innerHTML = html;
}

function updateDetailedSummaryTable() {
  const tbody = document.getElementById('detailed-table-body');
  if (!tbody) return;
  const valid = donations.filter(d => !d.excludeFromTotal && !d.isMissionAdjustment);
  const data = {};
  streamers.forEach(s => data[s] = { account: 0, superchat: 0, other: 0, total: 0 });
  valid.forEach(d => {
    if (!data[d.streamer]) return;
    const amt = parseFloat(d.amount) || 0;
    if (d.type === 'ê³„ì¢Œì´ì²´') data[d.streamer].account += amt;
    else if (d.type === 'ìŠˆí¼ì±—') data[d.streamer].superchat += amt;
    else data[d.streamer].other += amt;
    data[d.streamer].total += amt;
  });
  const sorted = Object.entries(data).sort((a,b) => b[1].total - a[1].total);
  let grandTotal = { account:0, superchat:0, other:0, total:0 };
  let html = '';
  sorted.forEach(([s, d]) => {
    const e = emojis[s] || '';
    html += `<tr><td>${e} ${s}</td><td class="text-right">${d.account.toFixed(1)}</td><td class="text-right">${d.superchat.toFixed(1)}</td><td class="text-right">${d.other.toFixed(1)}</td><td class="text-right" style="font-weight:600">${d.total.toFixed(1)}</td></tr>`;
    grandTotal.account += d.account; grandTotal.superchat += d.superchat; grandTotal.other += d.other; grandTotal.total += d.total;
  });
  html += `<tr style="font-weight:700;border-top:2px solid var(--bd)"><td>í•©ê³„</td><td class="text-right">${grandTotal.account.toFixed(1)}</td><td class="text-right">${grandTotal.superchat.toFixed(1)}</td><td class="text-right">${grandTotal.other.toFixed(1)}</td><td class="text-right">${grandTotal.total.toFixed(1)}</td></tr>`;
  tbody.innerHTML = html;
}

// ==================== SECTION 9: MISSION ====================
async function createMission() {
  const streamer = document.getElementById('mission-streamer').value;
  const target = document.getElementById('mission-target').value;
  const initialAmount = parseFloat(document.getElementById('mission-initial').value) || 0;
  const description = document.getElementById('mission-description').value;
  if (!streamer || !target) { showToast('ìŠ¤íŠ¸ë¦¬ë¨¸ì™€ ëª©í‘œì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  try {
    const res = await fetch('/api/missions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ streamer, target, initialAmount, description }) });
    const data = await res.json();
    if (data.success) {
      showToast(`${streamer} í€ë”© ì‹œì‘! (ëª©í‘œ: ${target}ë§Œì›)`, 'success');
      ['mission-streamer','mission-target','mission-description'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('mission-initial').value = '0';
    } else { showToast('ë¯¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + (data.error || ''), 'error'); }
  } catch(e) { showToast('ì„œë²„ ì˜¤ë¥˜', 'error'); }
}

async function completeMission(id) {
  if (!confirm('ì´ í€ë”©ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch(`/api/missions/${id}/complete`, { method: 'PUT' });
    const data = await res.json();
    if (data.success) { showToast('ë¯¸ì…˜ ì™„ë£Œ!', 'success'); updateAllUI(); }
    else showToast('ì™„ë£Œ ì‹¤íŒ¨: ' + (data.error || ''), 'error');
  } catch(e) { showToast('ì„œë²„ ì˜¤ë¥˜', 'error'); }
}

async function autoCompleteMission(id) {
  if (autoCompletedMissions.has(id)) return;
  try {
    const res = await fetch(`/api/missions/${id}/complete`, { method: 'PUT' });
    const data = await res.json();
    if (data.success) autoCompletedMissions.add(id);
  } catch(e) {}
}

async function deleteMission(id) {
  if (!confirm('ì´ í€ë”©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch(`/api/missions/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) showToast('í€ë”© ì‚­ì œë¨', 'success');
    else showToast('ì‚­ì œ ì‹¤íŒ¨', 'error');
  } catch(e) { showToast('ì„œë²„ ì˜¤ë¥˜', 'error'); }
}

function updateRunningMissionsList() {
  const el = document.getElementById('running-missions-list');
  if (!el) return;
  const running = runningMissions.filter(m => m.status === 'running');
  if (running.length === 0) { el.innerHTML = '<div class="empty-msg">ì§„í–‰ì¤‘ì¸ í€ë”©ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  const valid = donations.filter(d => !d.excludeFromTotal && !d.isMissionAdjustment);
  let html = '';
  running.forEach(m => {
    const amt = valid.filter(d => d.streamer === m.streamer).reduce((s, d) => s + (parseFloat(d.amount) || 0), 0) + (m.initialAmount || 0);
    const pct = Math.min(100, (amt / m.target * 100)).toFixed(1);
    const e = emojis[m.streamer] || '';
    html += `<div class="mis-card"><div class="mis-hd"><span class="mis-title">${e} ${m.description || m.streamer}</span><span class="badge ${parseFloat(pct)>=100?'badge-s':'badge-p'}">${pct}%</span></div>`;
    html += `<div style="font-size:11px;color:var(--tx2)">${parseFloat(amt.toFixed(1))}/${m.target}ë§Œì›</div>`;
    html += `<div class="pg-bar"><div class="pg-fill" style="width:${pct}%"></div></div>`;
    html += `<div class="btn-g mt-s"><button class="btn btn-sm btn-s" onclick="completeMission('${m.id}')">ì™„ë£Œ</button><button class="btn btn-sm btn-e" onclick="deleteMission('${m.id}')">ì‚­ì œ</button></div></div>`;
  });
  el.innerHTML = html;
}

// ==================== SECTION 10: SETTLEMENT ====================
function updateSettlementTable() {
  const tbody = document.getElementById('settlement-table-body');
  if (!tbody) return;
  const sTotals = {};
  (streamers || []).forEach(s => sTotals[s] = 0);
  (donations || []).forEach(d => {
    if (d.excludeFromTotal || d.isMissionAdjustment) return;
    if (sTotals.hasOwnProperty(d.streamer)) sTotals[d.streamer] += (parseFloat(d.amount) || 0) * 10000;
  });
  const feeSettings = JSON.parse(localStorage.getItem('settlement-fees') || '{}');
  const defaultFee = parseFloat(document.getElementById('settlement-default-fee')?.value || 10);
  let tDon = 0, tFee = 0, tSet = 0;
  const rows = (streamers || []).map(s => {
    const total = Math.round(sTotals[s] || 0);
    const fp = feeSettings[s] !== undefined ? feeSettings[s] : defaultFee;
    const fa = Math.round(total * fp / 100);
    const sett = total - fa;
    tDon += total; tFee += fa; tSet += sett;
    return `<tr><td>${emojis[s]||''} ${s}</td><td class="text-right">â‚©${total.toLocaleString()}</td><td><input type="number" class="fi" style="width:60px;padding:3px;text-align:center;font-size:11px" value="${fp}" min="0" max="100" step="0.1" onchange="updateStreamerSettlementFee('${s}',this.value)"></td><td class="text-right" style="color:var(--c-error)">-â‚©${fa.toLocaleString()}</td><td class="text-right" style="font-weight:600;color:var(--c-success)">â‚©${sett.toLocaleString()}</td></tr>`;
  }).join('');
  tbody.innerHTML = rows || '<tr><td colspan="5" class="text-center">ë°ì´í„° ì—†ìŒ</td></tr>';
  document.getElementById('settlement-total-donation').textContent = `â‚©${tDon.toLocaleString()}`;
  document.getElementById('settlement-total-fee').textContent = `-â‚©${tFee.toLocaleString()}`;
  document.getElementById('settlement-total-amount').textContent = `â‚©${tSet.toLocaleString()}`;
}

function updateStreamerSettlementFee(streamer, fp) {
  const fs = JSON.parse(localStorage.getItem('settlement-fees') || '{}');
  fs[streamer] = parseFloat(fp);
  localStorage.setItem('settlement-fees', JSON.stringify(fs));
  updateSettlementTable();
  showToast(`${streamer} ìˆ˜ìˆ˜ë£Œ ${fp}%`, 'saved');
}

function applyDefaultFeeAll() {
  const df = parseFloat(document.getElementById('settlement-default-fee')?.value || 10);
  const fs = {};
  streamers.forEach(s => fs[s] = df);
  localStorage.setItem('settlement-fees', JSON.stringify(fs));
  updateSettlementTable();
  showToast(`ì „ì²´ ìˆ˜ìˆ˜ë£Œ ${df}% ì ìš©`, 'success');
}

function exportSettlementCSV() {
  const feeSettings = JSON.parse(localStorage.getItem('settlement-fees') || '{}');
  const df = parseFloat(document.getElementById('settlement-default-fee')?.value || 10);
  const sTotals = {};
  streamers.forEach(s => sTotals[s] = 0);
  donations.forEach(d => { if (!d.excludeFromTotal && !d.isMissionAdjustment && sTotals.hasOwnProperty(d.streamer)) sTotals[d.streamer] += (parseFloat(d.amount)||0)*10000; });
  let csv = '\uFEFFìŠ¤íŠ¸ë¦¬ë¨¸,ì´ í›„ì›ê¸ˆ(ì›),ìˆ˜ìˆ˜ë£Œ(%),ìˆ˜ìˆ˜ë£Œ ê¸ˆì•¡(ì›),ì •ì‚° ê¸ˆì•¡(ì›)\n';
  let tD=0,tF=0,tS=0;
  streamers.forEach(s => {
    const t = Math.round(sTotals[s]||0);
    const fp = feeSettings[s] !== undefined ? feeSettings[s] : df;
    const fa = Math.round(t*fp/100); const se = t-fa;
    tD+=t;tF+=fa;tS+=se;
    csv += `${s},${t},${fp},${fa},${se}\n`;
  });
  csv += `í•©ê³„,${tD},-,${tF},${tS}\n`;
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob); link.download = `ì •ì‚°_${new Date().toISOString().split('T')[0]}.csv`; link.click();
  showToast('CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
}

function copySettlementText() {
  const feeSettings = JSON.parse(localStorage.getItem('settlement-fees') || '{}');
  const df = parseFloat(document.getElementById('settlement-default-fee')?.value || 10);
  const sTotals = {};
  streamers.forEach(s => sTotals[s] = 0);
  donations.forEach(d => { if (!d.excludeFromTotal && !d.isMissionAdjustment && sTotals.hasOwnProperty(d.streamer)) sTotals[d.streamer] += (parseFloat(d.amount)||0)*10000; });
  let text = 'ğŸ“Š ìŠ¤íŠ¸ë¦¬ë¨¸ ì •ì‚° ë‚´ì—­\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  let tS = 0;
  streamers.forEach(s => {
    const t = Math.round(sTotals[s]||0);
    const fp = feeSettings[s] !== undefined ? feeSettings[s] : df;
    const fa = Math.round(t*fp/100); const se = t-fa; tS+=se;
    text += `${emojis[s]||''} ${s}\n  ì´ì•¡: â‚©${t.toLocaleString()}\n  ìˆ˜ìˆ˜ë£Œ(${fp}%): -â‚©${fa.toLocaleString()}\n  ì •ì‚°: â‚©${se.toLocaleString()}\n\n`;
  });
  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ì´ ì •ì‚° í•©ê³„: â‚©${tS.toLocaleString()}`;
  navigator.clipboard.writeText(text).then(() => showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨', 'success')).catch(() => showToast('ë³µì‚¬ ì‹¤íŒ¨', 'error'));
}

// ==================== SECTION 11: RANKING & SEARCH ====================
function searchRanking() {
  const q = document.getElementById('ranking-search-input').value.trim().toLowerCase();
  const resultEl = document.getElementById('ranking-result');
  const tabsEl = document.getElementById('ranking-tabs');
  if (!q) { resultEl.innerHTML = ''; tabsEl.style.display = 'none'; return; }
  tabsEl.style.display = 'flex';
  renderRanking(q);
}

function switchRankingMode(mode, event) {
  currentRankingMode = mode;
  document.querySelectorAll('#ranking-tabs .rank-tab').forEach(t => t.classList.remove('active', 'btn-p'));
  document.querySelectorAll('#ranking-tabs .rank-tab').forEach(t => t.classList.add('btn-o'));
  event.currentTarget.classList.add('active', 'btn-p');
  event.currentTarget.classList.remove('btn-o');
  const q = document.getElementById('ranking-search-input').value.trim().toLowerCase();
  if (q) renderRanking(q);
}

function renderRanking(q) {
  const el = document.getElementById('ranking-result');
  const valid = donations.filter(d => !d.excludeFromTotal && !d.isMissionAdjustment);
  if (currentRankingMode === 'streamer') renderStreamerRanking(q, valid, el);
  else renderDonorRanking(q, valid, el);
}

function getMedal(r) { return r===1?'ğŸ¥‡':r===2?'ğŸ¥ˆ':r===3?'ğŸ¥‰':''; }

function renderStreamerRanking(q, valid, el) {
  const matched = streamers.filter(s => s.toLowerCase().includes(q));
  if (!matched.length) { el.innerHTML = '<div class="rk-empty">ì¼ì¹˜í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  let html = '';
  matched.forEach(s => {
    const e = emojis[s]||'';
    const sd = valid.filter(d => d.streamer === s);
    const dt = {};
    let ta = 0;
    sd.forEach(d => { const a = parseFloat(d.amount)||0; if(!dt[d.donor]) dt[d.donor]={amount:0,count:0,types:new Set()}; dt[d.donor].amount+=a; dt[d.donor].count++; dt[d.donor].types.add(d.type); ta+=a; });
    const sorted = Object.entries(dt).map(([n,d])=>({name:n,...d,types:Array.from(d.types)})).sort((a,b)=>b.amount-a.amount);
    const max = sorted.length>0?sorted[0].amount:1;
    html += `<div class="rk-box"><strong>${e} ${s}</strong><span class="st">í›„ì›ì <span class="sv">${sorted.length}ëª…</span></span><span class="st">ì´ì•¡ <span class="sv">${parseFloat(ta.toFixed(1))}ë§Œì›</span></span><span class="st">ê±´ìˆ˜ <span class="sv">${sd.length}ê±´</span></span></div>`;
    sorted.forEach((item,i) => {
      const r=i+1, m=getMedal(r), bw=(item.amount/max*100).toFixed(1);
      html += `<div class="rk-item">${m?`<div class="rk-medal">${m}</div>`:`<div class="rk-rank">${r}</div>`}<div class="rk-info"><div class="rk-name">${item.name}</div><div class="rk-detail">${item.count}ê±´ | ${item.types.join(', ')}</div><div class="rk-bar-bg"><div class="rk-bar" style="width:${bw}%"></div></div></div><div class="rk-amt">${parseFloat(item.amount.toFixed(1))}ë§Œ</div></div>`;
    });
  });
  el.innerHTML = html;
}

function renderDonorRanking(q, valid, el) {
  const allDonors = [...new Set(valid.map(d=>d.donor))];
  const matched = allDonors.filter(d=>d.toLowerCase().includes(q));
  if (!matched.length) { el.innerHTML = '<div class="rk-empty">ì¼ì¹˜í•˜ëŠ” í›„ì›ìê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  let html = '';
  matched.forEach(donor => {
    const dd = valid.filter(d=>d.donor===donor);
    const st = {};
    let ta = 0;
    dd.forEach(d => { const a=parseFloat(d.amount)||0; if(!st[d.streamer]) st[d.streamer]={amount:0,count:0,types:new Set()}; st[d.streamer].amount+=a; st[d.streamer].count++; st[d.streamer].types.add(d.type); ta+=a; });
    const sorted = Object.entries(st).map(([n,d])=>({name:n,emoji:emojis[n]||'',...d,types:Array.from(d.types)})).sort((a,b)=>b.amount-a.amount);
    const max = sorted.length>0?sorted[0].amount:1;
    html += `<div class="rk-box"><strong>${donor}</strong><span class="st">ìŠ¤íŠ¸ë¦¬ë¨¸ <span class="sv">${sorted.length}ëª…</span></span><span class="st">ì´ì•¡ <span class="sv">${parseFloat(ta.toFixed(1))}ë§Œì›</span></span><span class="st">ê±´ìˆ˜ <span class="sv">${dd.length}ê±´</span></span></div>`;
    sorted.forEach((item,i) => {
      const r=i+1, m=getMedal(r), bw=(item.amount/max*100).toFixed(1);
      html += `<div class="rk-item">${m?`<div class="rk-medal">${m}</div>`:`<div class="rk-rank">${r}</div>`}<div class="rk-info"><div class="rk-name">${item.emoji} ${item.name}</div><div class="rk-detail">${item.count}ê±´ | ${item.types.join(', ')}</div><div class="rk-bar-bg"><div class="rk-bar" style="width:${bw}%"></div></div></div><div class="rk-amt">${parseFloat(item.amount.toFixed(1))}ë§Œ</div></div>`;
    });
  });
  el.innerHTML = html;
}

function filterDonationTable() {
  const q = document.getElementById('donation-search').value.trim().toLowerCase();
  const rows = document.querySelectorAll('#data-table-body tr');
  const countEl = document.getElementById('donation-search-count');
  if (!q) { rows.forEach(r=>r.style.display=''); countEl.style.display='none'; return; }
  let matched = 0;
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length<7) return;
    const text = [cells[2],cells[3],cells[4],cells[5]].map(c=>(c?.textContent||'').toLowerCase()).join(' ');
    if (text.includes(q)) { row.style.display=''; matched++; } else { row.style.display='none'; }
  });
  countEl.style.display='block';
  countEl.textContent=`ê²€ìƒ‰: ${matched}ê±´ / ì „ì²´ ${rows.length}ê±´`;
}

function clearDonationSearch() { document.getElementById('donation-search').value=''; filterDonationTable(); }

// ==================== SECTION 12: OVERLAY ====================
function renderOverlayCards() {
  const el = document.getElementById('overlay-cards');
  if (!el) return;
  el.innerHTML = CONFIG.OVERLAYS.map(o => `<div class="ov-card"><div class="ov-info"><div class="ov-name">${o.name}</div><div class="ov-desc">${o.desc}</div></div><div class="btn-g"><button class="btn btn-sm btn-p" onclick="openOverlay('${o.file}')">ì—´ê¸°</button><button class="btn btn-sm btn-o" onclick="copyOverlayURL('${o.file}')">URL</button></div></div>`).join('');
}

function getOverlayURL(file) { return `${location.origin}/${file}`; }
function openOverlay(file) { window.open(getOverlayURL(file), '_blank', 'width=800,height=600'); }
function copyOverlayURL(file) { navigator.clipboard.writeText(getOverlayURL(file)).then(() => showToast('URL ë³µì‚¬ë¨', 'saved')); }
function openAllOverlays() { CONFIG.OVERLAYS.forEach(o => openOverlay(o.file)); }

function bindOverlaySliders() {
  const sliders = [
    { id: 'overlay-font-size', valId: 'overlay-font-size-val', suffix: 'px' },
    { id: 'overlay-stroke-width', valId: 'overlay-stroke-width-val', suffix: 'px' },
    { id: 'overlay-line-height', valId: 'overlay-line-height-val', suffix: '' }
  ];
  sliders.forEach(s => {
    const input = document.getElementById(s.id);
    const val = document.getElementById(s.valId);
    if (input && val) {
      val.textContent = input.value + s.suffix;
      input.addEventListener('input', () => { val.textContent = input.value + s.suffix; });
    }
  });
  // KakaoBank toggle
  const kb = document.getElementById('showKakaoBank');
  if (kb) kb.addEventListener('change', () => { document.getElementById('kakao-settings').style.display = kb.checked ? 'block' : 'none'; });
  // Auto-extend toggle
  const ae = document.getElementById('auto-extend-enabled');
  if (ae) ae.addEventListener('change', () => { document.getElementById('extend-amount').disabled = !ae.checked; });
  // Text switch toggle
  const ts = document.getElementById('total-goal-text-switch-enabled');
  if (ts) ts.addEventListener('change', () => { document.getElementById('total-goal-text-switch-interval').disabled = !ts.checked; });
  // Donor overlay goal toggle
  const dg = document.getElementById('donor-overlay-show-goal');
  if (dg) dg.addEventListener('change', () => { document.getElementById('donor-goal-settings').style.display = dg.checked ? 'block' : 'none'; });
  // Donor overlay goal width slider
  const gw = document.getElementById('donor-overlay-goal-width');
  if (gw) gw.addEventListener('input', () => { document.getElementById('donor-overlay-goal-width-val').textContent = gw.value + '%'; });
}

function saveOverlaySettings() {
  const settings = {
    'overlay-font-size': document.getElementById('overlay-font-size').value,
    'overlay-stroke-width': document.getElementById('overlay-stroke-width').value,
    'overlay-text-align': document.getElementById('overlay-text-align').value,
    'overlay-line-height': document.getElementById('overlay-line-height').value,
    'overlay-text-color': document.getElementById('overlay-text-color').value,
    'showKakaoBank': document.getElementById('showKakaoBank').checked,
    'kakaoBankAccount': document.getElementById('kakaoBankAccount').value,
    'kakaoBankSize': parseInt(document.getElementById('kakaoBankSize').value),
    'kakaoBankLineHeight': parseFloat(document.getElementById('kakaoBankLineHeight').value),
    'donor-overlay-show-goal': document.getElementById('donor-overlay-show-goal').checked,
    'donor-overlay-goal-position': document.getElementById('donor-overlay-goal-position').value,
    'donor-overlay-goal-align': document.getElementById('donor-overlay-goal-align').value,
    'donor-overlay-goal-width': parseInt(document.getElementById('donor-overlay-goal-width').value)
  };
  fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings}) })
    .then(r=>r.json()).then(d => { if(d.success) showToast('ì˜¤ë²„ë ˆì´ ì„¤ì • ì €ì¥ë¨', 'saved'); else showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); })
    .catch(()=>showToast('ì„œë²„ ì˜¤ë¥˜', 'error'));
}

function saveTableSettings() {
  const settings = {
    'table-opacity': document.getElementById('table-opacity').value,
    'table-number-size': document.getElementById('table-number-size').value,
    'table-font-size': document.getElementById('table-font-size').value,
    'table-text-color': document.getElementById('table-text-color').value,
    'table-title': document.getElementById('table-title').value,
    'table-color-preset': document.getElementById('table-color-preset').value,
    'show-total-row': document.getElementById('show-total-row').checked ? 'true' : 'false',
    'show-update-time': document.getElementById('show-update-time').checked ? 'true' : 'false',
    'groupThreshold': parseInt(document.getElementById('groupThreshold').value),
    'includeSuperchat': document.getElementById('includeSuperchat').checked
  };
  fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings}) })
    .then(r=>r.json()).then(d => { if(d.success) showToast('í…Œì´ë¸” ì„¤ì • ì €ì¥ë¨', 'saved'); else showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); })
    .catch(()=>showToast('ì„œë²„ ì˜¤ë¥˜', 'error'));
}

function loadOverlaySettings() {
  const s = currentData.settings || {};
  const setVal = (id, val) => { const el = document.getElementById(id); if(el && val !== undefined) el.value = val; };
  const setChk = (id, val) => { const el = document.getElementById(id); if(el) el.checked = !!val; };
  setVal('overlay-font-size', s['overlay-font-size']);
  setVal('overlay-stroke-width', s['overlay-stroke-width']);
  setVal('overlay-text-align', s['overlay-text-align']);
  setVal('overlay-line-height', s['overlay-line-height']);
  setVal('overlay-text-color', s['overlay-text-color'] || '#ffffff');
  setChk('showKakaoBank', s['showKakaoBank']);
  setVal('kakaoBankAccount', s['kakaoBankAccount']);
  setVal('kakaoBankSize', s['kakaoBankSize']);
  setVal('kakaoBankLineHeight', s['kakaoBankLineHeight']);
  if (s['showKakaoBank']) document.getElementById('kakao-settings').style.display = 'block';
  setChk('donor-overlay-show-goal', s['donor-overlay-show-goal']);
  setVal('donor-overlay-goal-position', s['donor-overlay-goal-position']);
  setVal('donor-overlay-goal-align', s['donor-overlay-goal-align']);
  setVal('donor-overlay-goal-width', s['donor-overlay-goal-width'] || 100);
  const dgs = document.getElementById('donor-goal-settings');
  if (dgs) dgs.style.display = s['donor-overlay-show-goal'] ? 'block' : 'none';
  // Trigger slider value updates
  document.querySelectorAll('#view-overlay input[type="range"]').forEach(i => i.dispatchEvent(new Event('input')));
}

function loadTableSettingsFromServer() {
  const s = currentData.settings || {};
  const setVal = (id, val) => { const el = document.getElementById(id); if(el && val !== undefined) el.value = val; };
  const setChk = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val === 'true' || val === true; };
  setVal('table-opacity', s['table-opacity']);
  setVal('table-number-size', s['table-number-size']);
  setVal('table-font-size', s['table-font-size']);
  setVal('table-text-color', s['table-text-color']);
  setVal('table-title', s['table-title']);
  setVal('table-color-preset', s['table-color-preset']);
  setChk('show-total-row', s['show-total-row']);
  setChk('show-update-time', s['show-update-time']);
  setVal('group-threshold', s['groupThreshold']);
  setChk('include-superchat', s['includeSuperchat']);
}

function applyServerSettingsToUI(s) {
  if (!s) return;
  isApplyingServerSettings = true;
  loadTableSettingsFromServer();
  loadOverlaySettings();
  // Total Goal
  const setVal = (id, val) => { const el = document.getElementById(id); if(el && val !== undefined && val !== null) el.value = val; };
  const setChk = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val === true || val === 'true'; };
  if (s.dailyGoal) {
    setVal('daily-goal-target', s.dailyGoal.target);
    setChk('auto-extend-enabled', s.dailyGoal.autoExtend);
    setVal('extend-amount', s.dailyGoal.extendAmount || 50);
    const extEl = document.getElementById('extend-amount'); if(extEl) extEl.disabled = !s.dailyGoal.autoExtend;
  }
  setChk('total-goal-show-title', s['total-goal-show-title']);
  setVal('total-goal-custom-title', s['total-goal-custom-title']);
  setVal('total-goal-bg-opacity', s['total-goal-bg-opacity']);
  setVal('total-goal-bg-color', s['total-goal-bg-color']);
  setVal('total-goal-text-outline-width', s['total-goal-text-outline-width']);
  setVal('total-goal-text-outline-color', s['total-goal-text-outline-color']);
  setChk('total-goal-show-top-stats', s['total-goal-show-top-stats'] !== false);
  setChk('total-goal-text-switch-enabled', s['total-goal-text-switch-enabled']);
  setVal('total-goal-text-switch-interval', s['total-goal-text-switch-interval']);
  const tsi = document.getElementById('total-goal-text-switch-interval'); if(tsi) tsi.disabled = !s['total-goal-text-switch-enabled'];
  setVal('total-goal-title-size', s['total-goal-title-font-size']);
  setVal('total-goal-stats-size', s['total-goal-stats-font-size']);
  setVal('total-goal-progress-height', s['total-goal-progress-height']);
  setVal('total-goal-progress-text-size', s['total-goal-progress-text-size']);
  // Mission Graph
  setVal('graph-opacity', s['mission-graph-opacity']);
  setVal('graph-bg-color', s['mission-graph-bg-color']);
  setVal('graph-border-color', s['mission-graph-border-color']);
  setVal('graph-border-width', s['mission-graph-border-width']);
  setVal('title-font-size', s['mission-title-font-size']);
  setVal('stats-font-size', s['mission-stats-font-size']);
  setVal('progress-height', s['mission-progress-height']);
  setVal('progress-bg-color', s['mission-progress-bg-color']);
  setVal('progress-start-color', s['mission-progress-start-color']);
  setVal('progress-end-color', s['mission-progress-end-color']);
  setVal('complete-start-color', s['mission-complete-start-color']);
  setVal('complete-end-color', s['mission-complete-end-color']);
  // Slider value display update
  document.querySelectorAll('input[type="range"]').forEach(i => i.dispatchEvent(new Event('input')));
  isApplyingServerSettings = false;
}

// Total Goal Settings
function applyTotalGoalSettings() {
  const settings = {
    dailyGoal: { target: parseFloat(document.getElementById('daily-goal-target').value)||50, autoExtend: document.getElementById('auto-extend-enabled').checked, extendAmount: parseFloat(document.getElementById('extend-amount').value)||50 },
    'total-goal-show-title': document.getElementById('total-goal-show-title').checked,
    'total-goal-custom-title': document.getElementById('total-goal-custom-title').value.trim(),
    'total-goal-bg-opacity': document.getElementById('total-goal-bg-opacity').value,
    'total-goal-bg-color': document.getElementById('total-goal-bg-color').value,
    'total-goal-text-outline-width': document.getElementById('total-goal-text-outline-width').value,
    'total-goal-text-outline-color': document.getElementById('total-goal-text-outline-color').value,
    'total-goal-show-top-stats': document.getElementById('total-goal-show-top-stats').checked,
    'total-goal-text-switch-enabled': document.getElementById('total-goal-text-switch-enabled')?.checked || false,
    'total-goal-text-switch-interval': document.getElementById('total-goal-text-switch-interval').value,
    'total-goal-title-font-size': document.getElementById('total-goal-title-size').value,
    'total-goal-stats-font-size': document.getElementById('total-goal-stats-size').value,
    'total-goal-progress-height': document.getElementById('total-goal-progress-height').value,
    'total-goal-progress-text-size': document.getElementById('total-goal-progress-text-size').value
  };
  fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings}) })
    .then(r=>r.json()).then(d => { if(d.success) { showToast('ì´ì•¡ ëª©í‘œ ì„¤ì • ì €ì¥ë¨', 'saved'); togglePanel('total-goal-settings'); } else showToast('ì €ì¥ ì‹¤íŒ¨', 'error'); })
    .catch(()=>showToast('ì„œë²„ ì˜¤ë¥˜', 'error'));
}

function resetTotalGoalSettings() {
  if (!confirm('ì´ì•¡ ëª©í‘œ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  document.getElementById('daily-goal-target').value = '50';
  document.getElementById('auto-extend-enabled').checked = false;
  document.getElementById('extend-amount').value = '50';
  document.getElementById('extend-amount').disabled = true;
  document.getElementById('total-goal-show-title').checked = false;
  document.getElementById('total-goal-custom-title').value = '';
  document.getElementById('total-goal-bg-opacity').value = '0';
  document.getElementById('total-goal-bg-color').value = '#000000';
  document.getElementById('total-goal-text-outline-width').value = '1';
  document.getElementById('total-goal-text-outline-color').value = '#000000';
  document.getElementById('total-goal-show-top-stats').checked = true;
  document.getElementById('total-goal-text-switch-enabled').checked = false;
  document.getElementById('total-goal-text-switch-interval').value = '5';
  document.getElementById('total-goal-text-switch-interval').disabled = true;
  document.querySelectorAll('#total-goal-settings input[type="range"]').forEach(i => i.dispatchEvent(new Event('input')));
  showToast('ì„¤ì • ì´ˆê¸°í™”ë¨', 'success');
}

function updateTotalGoalDecimalDisplay(mode) {
  localStorage.setItem('total-goal-decimal-display', mode);
  fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings:{'total-goal-decimal-display':mode}}) })
    .then(r=>r.json()).then(d => { if(d.success) showToast(`ìˆ«ì í‘œì‹œ: ${mode==='always'?'í•­ìƒ ì†Œìˆ˜ì ':'ì •ìˆ˜ì‹œ ìƒëµ'}`, 'saved'); });
}

// Mission Graph Settings
function applyMissionGraphSettings() {
  const settings = {
    'mission-graph-opacity': document.getElementById('graph-opacity').value,
    'mission-graph-bg-color': document.getElementById('graph-bg-color').value,
    'mission-graph-border-color': document.getElementById('graph-border-color').value,
    'mission-graph-border-width': document.getElementById('graph-border-width').value,
    'mission-title-font-size': document.getElementById('title-font-size').value,
    'mission-stats-font-size': document.getElementById('stats-font-size').value,
    'mission-progress-height': document.getElementById('progress-height').value,
    'mission-progress-bg-color': document.getElementById('progress-bg-color').value,
    'mission-progress-start-color': document.getElementById('progress-start-color').value,
    'mission-progress-end-color': document.getElementById('progress-end-color').value,
    'mission-complete-start-color': document.getElementById('complete-start-color').value,
    'mission-complete-end-color': document.getElementById('complete-end-color').value
  };
  fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings}) })
    .then(r=>r.json()).then(d => { if(d.success) showToast('ë¯¸ì…˜ ê·¸ë˜í”„ ì„¤ì • ì €ì¥ë¨', 'saved'); });
}

function resetMissionGraphSettings() {
  if (!confirm('ë¯¸ì…˜ ê·¸ë˜í”„ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const defaults = { 'graph-opacity':85, 'graph-bg-color':'#000000', 'graph-border-color':'#42b72a', 'graph-border-width':2, 'title-font-size':20, 'stats-font-size':16, 'progress-height':20, 'progress-bg-color':'#2c2c2c', 'progress-start-color':'#42b72a', 'progress-end-color':'#6bd464', 'complete-start-color':'#ffd700', 'complete-end-color':'#fff176' };
  Object.entries(defaults).forEach(([id,v]) => { const el = document.getElementById(id); if(el) el.value = v; });
  document.querySelectorAll('#mission-graph-settings input[type="range"]').forEach(i => i.dispatchEvent(new Event('input')));
  showToast('ë¯¸ì…˜ ê·¸ë˜í”„ ì„¤ì • ì´ˆê¸°í™”ë¨', 'success');
}

// Total Only Overlay Settings
function bindTotalOnlyEvents() {
  ['showRankNames','showEomsamyong','fixEomsamyongFirst','showOkgi','fixOkgiLast','hideGukgo','fixGukgoLast'].forEach(key => {
    const el = document.getElementById(`totalOnly-${key}`);
    if (el) el.addEventListener('change', e => updateTotalOnlySetting(key, e.target.checked));
  });
  document.querySelectorAll('input[name="totalOnly-currency"]').forEach(r => {
    r.addEventListener('change', e => { if(e.target.checked) updateTotalOnlySetting('currency', e.target.value); });
  });
}

function updateTotalOnlySetting(key, value) {
  localStorage.setItem(`total-overlay-${key}`, value);
  const overlaySettings = {};
  ['showRankNames','showEomsamyong','fixEomsamyongFirst','showOkgi','fixOkgiLast','hideGukgo','fixGukgoLast'].forEach(k => {
    overlaySettings[k] = localStorage.getItem(`total-overlay-${k}`) === 'true';
  });
  overlaySettings.currency = localStorage.getItem('total-overlay-currency') || 'manwon';
  if (socket && socket.connected) { socket.emit('updateTotalOverlaySettings', overlaySettings); showToast('ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • ì—…ë°ì´íŠ¸ë¨', 'saved'); }
}

// ==================== SECTION 13: ADJUSTMENT ====================
async function adjustStreamerAmount() {
  const streamer = document.getElementById('adjust-streamer').value;
  const amount = parseFloat(document.getElementById('adjust-amount').value);
  const reason = document.getElementById('adjust-reason').value.trim();
  if (!streamer || !amount) { showToast('ìŠ¤íŠ¸ë¦¬ë¨¸ì™€ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  try {
    const res = await fetch('/api/donations', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ donor: `[ì¡°ì •] ${reason||'ê¸ˆì•¡ì¡°ì •'}`, streamer, type: 'ê¸°íƒ€', amount, isMissionAdjustment: false })
    });
    const data = await res.json();
    if (data.success) { showToast(`${streamer} ${amount>0?'+':''}${amount}ë§Œì› ì¡°ì •`, 'success'); document.getElementById('adjust-amount').value=''; document.getElementById('adjust-reason').value=''; }
  } catch(e) { showToast('ì„œë²„ ì˜¤ë¥˜', 'error'); }
}

function adjustDonorAmount() {
  const donor = document.getElementById('adjust-donor').value.trim();
  const amount = parseFloat(document.getElementById('adjust-donor-amount').value);
  const type = document.querySelector('input[name="donor-paytype"]:checked').value;
  if (!donor) { showToast('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (!amount || amount === 0) { showToast('ì¡°ì •í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }

  const adjustmentDonation = {
    donor: `${donor}(ì¡°ì •${amount > 0 ? '+' : ''}${amount})`,
    streamer: 'í›„ì›ìì¡°ì •',
    type,
    amount,
    time: new Date()
  };

  document.getElementById('adjust-donor').value = '';
  document.getElementById('adjust-donor-amount').value = '';
  handleNewDonations([adjustmentDonation]);
  showToast(`${donor}ë‹˜ ${amount > 0 ? '+' : ''}${amount}ë§Œì› ì¡°ì •ë¨`, 'success');
}

// ==================== SECTION 14: CHATBOT ====================
function loadYouTubeSettings() {
  const key = localStorage.getItem(CONFIG.STORAGE_KEYS.YOUTUBE_API_KEY);
  const vid = localStorage.getItem(CONFIG.STORAGE_KEYS.YOUTUBE_VIDEO_ID);
  if (key) document.getElementById('youtube-api-key').value = key;
  if (vid) document.getElementById('youtube-video-id').value = vid;
}

function saveApiKey() {
  const key = document.getElementById('youtube-api-key').value.trim();
  if (!key) { showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  localStorage.setItem(CONFIG.STORAGE_KEYS.YOUTUBE_API_KEY, key);
  apiKeys = [key];
  showToast('API í‚¤ ì €ì¥ë¨', 'saved');
}

async function testApiKey() {
  const key = document.getElementById('youtube-api-key').value.trim();
  if (!key) { showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&maxResults=1&key=${key}`);
    if (res.ok) showToast('API í‚¤ ìœ íš¨!', 'success');
    else showToast('API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
  } catch(e) { showToast('API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error'); }
}

async function connectToLiveChat() {
  const vid = document.getElementById('youtube-video-id').value.trim();
  const key = localStorage.getItem(CONFIG.STORAGE_KEYS.YOUTUBE_API_KEY);
  if (!vid) { showToast('ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (!key) { showToast('API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤', 'warning'); return; }
  try {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${vid}&key=${key}`);
    const data = await res.json();
    if (data.items && data.items[0]?.liveStreamingDetails?.activeLiveChatId) {
      liveChatId = data.items[0].liveStreamingDetails.activeLiveChatId;
      localStorage.setItem(CONFIG.STORAGE_KEYS.YOUTUBE_VIDEO_ID, vid);
      document.getElementById('livechat-status').className = 'status status-success';
      document.getElementById('livechat-status').textContent = 'ì—°ê²°ë¨!';
      showToast('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°ë¨', 'success');
    } else { showToast('ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë¨', 'error'); }
  } catch(e) { showToast('ì—°ê²° ì‹¤íŒ¨', 'error'); }
}

async function sendToYouTube() {
  const msg = document.getElementById('chat-message').value.trim();
  if (!msg) { showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (!liveChatId) { showToast('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'warning'); return; }
  try { await sendMessageToYouTube(msg); showToast('ë©”ì‹œì§€ ì „ì†¡ë¨', 'success'); document.getElementById('chat-message').value = ''; }
  catch(e) { showToast('ì „ì†¡ ì‹¤íŒ¨: ' + e.message, 'error'); }
}

async function sendMessageToYouTube(message) {
  const key = localStorage.getItem(CONFIG.STORAGE_KEYS.YOUTUBE_API_KEY);
  if (!key || !liveChatId) throw new Error('API í‚¤ ë˜ëŠ” ì±„íŒ… ID ì—†ìŒ');
  const res = await fetch(`https://www.googleapis.com/youtube/v3/liveChat/messages?part=snippet&key=${key}`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ snippet: { liveChatId, type: 'textMessageEvent', textMessageDetails: { messageText: message } } })
  });
  if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || 'ì „ì†¡ ì‹¤íŒ¨'); }
  return true;
}

async function sendDonationNotification(newDonations) {
  if (!liveChatId || !Array.isArray(newDonations)) return;
  try {
    const donorGroups = {};
    newDonations.forEach(d => {
      if (!donorGroups[d.donor]) donorGroups[d.donor] = [];
      donorGroups[d.donor].push(d);
    });

    const messages = [];
    for (const [donor, dons] of Object.entries(donorGroups)) {
      const texts = dons.map(d => {
        const sTotal = donations.filter(x => x.streamer === d.streamer).reduce((s, x) => s + (parseFloat(x.amount)||0), 0);
        return `${emojis[d.streamer]||''}${d.streamer} (+${parseFloat(d.amount).toFixed(1)}ë§Œ/${sTotal.toFixed(1)}ë§Œ)`;
      }).join(', ');
      messages.push(`ğŸ’ ${donor}ë‹˜ > ${texts} ê°ì‚¬í•©ë‹ˆë‹¤!`);
    }

    for (let i = 0; i < messages.length; i++) {
      if (isOAuthSignedIn) await sendToYouTubeOAuth(messages[i]);
      else await sendMessageToYouTube(messages[i]);
      if (i < messages.length - 1) await new Promise(r => setTimeout(r, 2000));
    }
  } catch(e) {
    try { await fetch('/api/youtube-chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message: 'í›„ì› ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨'}) }); } catch(e2) {}
  }
}

// YouTube OAuth functions
async function connectToLiveChatOAuth() {
  if (!isOAuthSignedIn) { showToast('ë¨¼ì € Google OAuth ë¡œê·¸ì¸í•˜ì„¸ìš”', 'warning'); return; }
  const vid = document.getElementById('youtube-video-id').value.trim();
  if (!vid) { showToast('ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  try {
    if (!gapi.client.youtube) await gapi.client.load('youtube', 'v3');
    const res = await gapi.client.youtube.videos.list({ part: 'liveStreamingDetails', id: vid });
    const item = res.result.items?.[0];
    if (item?.liveStreamingDetails?.activeLiveChatId) {
      liveChatId = item.liveStreamingDetails.activeLiveChatId;
      localStorage.setItem(CONFIG.STORAGE_KEYS.YOUTUBE_VIDEO_ID, vid);
      document.getElementById('livechat-status').className = 'status status-success';
      document.getElementById('livechat-status').textContent = 'OAuth ì—°ê²°ë¨!';
      showToast('OAuth ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°ë¨', 'success');
    } else { showToast('ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹˜', 'error'); }
  } catch(e) { showToast('OAuth ì—°ê²° ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message), 'error'); }
}

async function sendToYouTubeOAuth(message) {
  if (!isOAuthSignedIn || !liveChatId) return false;
  try {
    if (!message?.trim()) return false;
    if (!gapi.client.youtube) await gapi.client.load('youtube', 'v3');
    const res = await gapi.client.youtube.liveChatMessages.insert({
      part: 'snippet', resource: { snippet: { liveChatId, type: 'textMessageEvent', textMessageDetails: { messageText: message } } }
    });
    return res.status === 200;
  } catch(e) { showToast('OAuth ì „ì†¡ ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message), 'error'); return false; }
}

async function testYouTubeOAuth() {
  if (!isOAuthSignedIn) { showToast('ë¨¼ì € OAuth ë¡œê·¸ì¸í•˜ì„¸ìš”', 'warning'); return; }
  try {
    if (!gapi.client.youtube) await gapi.client.load('youtube', 'v3');
    const res = await gapi.client.youtube.search.list({ part:'snippet', q:'test', maxResults:1 });
    if (res.status===200) showToast('YouTube API OAuth ì—°ê²° ì„±ê³µ!', 'success');
  } catch(e) { showToast('OAuth í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error'); }
}

async function sendStreamerSummaryToChatbot() {
  const btn = document.getElementById('streamer-summary-chatbot-btn');
  if (!liveChatId) { showToast('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'warning'); return; }
  btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘...';
  try {
    const msg = document.getElementById('summary-output').textContent.trim();
    if (!msg) { showToast('ì „ì†¡í•  ë°ì´í„° ì—†ìŒ', 'warning'); return; }
    if (isOAuthSignedIn) { const ok = await sendToYouTubeOAuth(msg); if (ok) { showToast('ì´ì•¡ ì „ì†¡ë¨', 'success'); return; } }
    await sendMessageToYouTube(msg);
    showToast('ì´ì•¡ ì „ì†¡ë¨', 'success');
  } catch(e) { showToast('ì „ì†¡ ì‹¤íŒ¨: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = 'ğŸ“¤ ì´ì•¡ ì „ì†¡'; }
}

async function sendMissionSummaryToChatbot() {
  const btn = document.getElementById('mission-summary-chatbot-btn');
  if (!liveChatId) { showToast('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'warning'); return; }
  btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘...';
  try {
    const msg = document.getElementById('mission-summary-output').textContent.trim();
    if (!msg || msg === 'ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.') { showToast('ì „ì†¡í•  í€ë”© ì—†ìŒ', 'warning'); return; }
    if (isOAuthSignedIn) { const ok = await sendToYouTubeOAuth(msg); if (ok) { showToast('í€ë”© ì „ì†¡ë¨', 'success'); return; } }
    await sendMessageToYouTube(msg);
    showToast('í€ë”© ì „ì†¡ë¨', 'success');
  } catch(e) { showToast('ì „ì†¡ ì‹¤íŒ¨: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = 'ğŸ“¤ í€ë”© ì „ì†¡'; }
}

// Auto notify sync
function syncAutoNotifySettings() {
  const cb = document.getElementById('chatbot-auto-notify');
  const orig = document.getElementById('auto-chat-notify');
  const status = document.getElementById('auto-notify-status');
  if (cb && orig) {
    orig.checked = cb.checked;
    if (cb.checked) {
      const hasPerm = isAdminVerified || isOAuthSignedIn || localStorage.getItem(CONFIG.STORAGE_KEYS.YOUTUBE_API_KEY);
      if (hasPerm && liveChatId) { status.textContent = 'ìë™ ì•Œë¦¼ í™œì„±í™”ë¨'; status.className = 'status status-success'; }
      else if (!hasPerm) { status.textContent = 'ê¶Œí•œ í•„ìš” (OAuth ë˜ëŠ” API í‚¤)'; status.className = 'status status-warning'; }
      else { status.textContent = 'ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° í•„ìš”'; status.className = 'status status-warning'; }
    } else { status.textContent = 'ìë™ ì•Œë¦¼ ë¹„í™œì„±í™”'; status.className = 'status status-info'; }
  }
}

function initializeAutoNotifySync() {
  const cb = document.getElementById('chatbot-auto-notify');
  const orig = document.getElementById('auto-chat-notify');
  if (cb && orig) { cb.checked = orig.checked; syncAutoNotifySettings(); }
  updateQuickAdminButton();
}

function quickEnableAdmin() {
  const btn = document.getElementById('quick-admin-btn');
  if (!isAdminVerified) {
    isAdminVerified = true;
    document.getElementById('admin-verified').checked = true;
    btn.textContent = 'ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”ë¨'; btn.className = 'btn btn-s btn-sm'; btn.disabled = true;
    showToast('ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”ë¨', 'success');
    syncAutoNotifySettings();
  }
}

function updateQuickAdminButton() {
  const btn = document.getElementById('quick-admin-btn');
  if (btn) {
    if (isAdminVerified) { btn.textContent = 'ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”ë¨'; btn.className = 'btn btn-s btn-sm'; btn.disabled = true; }
    else { btn.textContent = 'ğŸ”“ ê´€ë¦¬ì ê¶Œí•œ í™œì„±í™”'; btn.className = 'btn btn-o btn-sm'; btn.disabled = false; }
  }
}

// ==================== SECTION 15: GOOGLE API ====================
function initGoogleAPI() {
  if (typeof gapi === 'undefined') return;
  gapi.load('client', async () => {
    try {
      await gapi.client.init({ apiKey: CONFIG.GOOGLE.API_KEY });
      // ê°œë³„ ë¡œë“œ - ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ APIì— ì˜í–¥ ì—†ìŒ
      try { await gapi.client.load('sheets', 'v4'); console.log('âœ… Sheets API ë¡œë“œë¨'); } catch(e) { console.warn('âš ï¸ Sheets API ë¡œë“œ ì‹¤íŒ¨:', e); }
      try { await gapi.client.load('youtube', 'v3'); console.log('âœ… YouTube API ë¡œë“œë¨'); } catch(e) { console.warn('âš ï¸ YouTube API ë¡œë“œ ì‹¤íŒ¨:', e); }
    } catch(e) { console.error('âŒ Google API ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
  });
}

function signInGoogleOAuth() {
  if (typeof google === 'undefined') { showToast('Google API ë¡œë“œ ì‹¤íŒ¨', 'error'); return; }
  const client = google.accounts.oauth2.initTokenClient({
    client_id: CONFIG.GOOGLE.CLIENT_ID, scope: CONFIG.GOOGLE.SCOPES,
    callback: (response) => {
      if (response.access_token) {
        isOAuthSignedIn = true;
        gapi.client.setToken({ access_token: response.access_token });
        document.getElementById('google-auth-status').textContent = 'Google OAuth ë¡œê·¸ì¸ë¨';
        document.getElementById('google-auth-status').className = 'status status-success';
        document.getElementById('google-oauth-btn').style.display = 'none';
        document.getElementById('google-signout-btn').style.display = 'inline-flex';
        showToast('Google OAuth ë¡œê·¸ì¸ ì„±ê³µ', 'success');
        syncAutoNotifySettings();
      }
    }
  });
  client.requestAccessToken();
}

function signOutGoogleOAuth() {
  const token = gapi.client.getToken();
  if (token) { google.accounts.oauth2.revoke(token.access_token); gapi.client.setToken(null); }
  isOAuthSignedIn = false;
  document.getElementById('google-auth-status').textContent = 'ë¡œê·¸ì¸ í•„ìš”';
  document.getElementById('google-auth-status').className = 'status status-info';
  document.getElementById('google-oauth-btn').style.display = 'inline-flex';
  document.getElementById('google-signout-btn').style.display = 'none';
  showToast('ë¡œê·¸ì•„ì›ƒë¨', 'info');
}

async function backupToGoogleDrive() {
  if (!isOAuthSignedIn) { showToast('ë¨¼ì € Google OAuth ë¡œê·¸ì¸í•˜ì„¸ìš”', 'warning'); return; }
  try {
    const data = JSON.stringify({ donations, streamers, emojis, missions, runningMissions, missionAdjustments, settings: currentData.settings });
    const blob = new Blob([data], { type: 'application/json' });
    const metadata = { name: `donation-backup-${new Date().toISOString().split('T')[0]}.json`, mimeType: 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', blob);
    const token = gapi.client.getToken();
    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST', headers: { Authorization: `Bearer ${token.access_token}` }, body: form
    });
    if (res.ok) showToast('Google Drive ë°±ì—… ì™„ë£Œ', 'success');
    else showToast('Drive ë°±ì—… ì‹¤íŒ¨', 'error');
  } catch(e) { showToast('Drive ë°±ì—… ì˜¤ë¥˜: ' + e.message, 'error'); }
}

async function backupToGoogleSheet() {
  if (!isOAuthSignedIn) { showToast('ë¨¼ì € Google OAuth ë¡œê·¸ì¸í•˜ì„¸ìš”', 'warning'); return; }
  const sheetId = document.getElementById('google-sheet-id').value.trim();
  if (!sheetId) { showToast('Sheet IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  try {
    const values = [['ë²ˆí˜¸','í›„ì›ì','ìŠ¤íŠ¸ë¦¬ë¨¸','ìœ í˜•','ê¸ˆì•¡','ì‹œê°„']];
    donations.forEach((d,i) => { values.push([i+1, d.donor, d.streamer, d.type, d.amount, d.time]); });
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId: sheetId, range: 'Sheet1!A1', valueInputOption: 'RAW', resource: { values }
    });
    showToast('Google Sheets ë°±ì—… ì™„ë£Œ', 'success');
  } catch(e) { showToast('Sheets ë°±ì—… ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message), 'error'); }
}

async function restoreFromGoogleSheet() {
  if (!isOAuthSignedIn) { showToast('ë¨¼ì € Google OAuth ë¡œê·¸ì¸í•˜ì„¸ìš”', 'warning'); return; }
  const sheetId = document.getElementById('google-sheet-id').value.trim();
  if (!sheetId) { showToast('Sheet IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ Sheetì—ì„œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: sheetId, range: 'Sheet1!A2:F9999' });
    const rows = res.result.values || [];
    const restored = rows.map(r => ({ id: Date.now().toString() + Math.random().toString(36).substr(2,5), donor:r[1]||'', streamer:r[2]||'', type:r[3]||'', amount:parseFloat(r[4])||0, time:r[5]||new Date().toISOString() }));
    const bulkRes = await fetch('/api/donations/bulk', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({donations:restored, replace:true}) });
    const data = await bulkRes.json();
    if (data.success) showToast(`${restored.length}ê±´ ë³µì› ì™„ë£Œ`, 'success');
    else showToast('ë³µì› ì‹¤íŒ¨', 'error');
  } catch(e) { showToast('ë³µì› ì˜¤ë¥˜: ' + (e.result?.error?.message || e.message), 'error'); }
}

function saveSheetId() {
  const id = document.getElementById('google-sheet-id').value.trim();
  if (id) { localStorage.setItem('google_sheet_id', id); showToast('Sheet ID ì €ì¥ë¨', 'saved'); }
}

// ==================== SECTION 16: DATA MANAGEMENT ====================
function exportData() {
  const data = JSON.stringify({ donations, streamers, emojis, missions, runningMissions, missionAdjustments, settings: currentData.settings, lastUpdated: new Date().toISOString() }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `donation-backup-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  showToast('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.donations) {
        const res = await fetch('/api/donations/bulk', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({donations:data.donations, replace:true}) });
        const result = await res.json();
        if (result.success) showToast(`${data.donations.length}ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`, 'success');
        else showToast('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', 'error');
      }
    } catch(err) { showToast('íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜', 'error'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function showResetDialog() { document.getElementById('reset-modal').classList.add('active'); }
function closeResetModal() { document.getElementById('reset-modal').classList.remove('active'); }

async function backupAndReset() {
  exportData();
  setTimeout(() => confirmReset(), 500);
}

async function confirmReset() {
  if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  try {
    const res = await fetch('/api/donations/bulk', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({donations:[], replace:true}) });
    const data = await res.json();
    if (data.success) { showToast('ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ', 'success'); closeResetModal(); }
    else showToast('ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
  } catch(e) { showToast('ì„œë²„ ì˜¤ë¥˜', 'error'); }
}

// ==================== SECTION 17: SETTINGS ====================
function toggleAdminMode() {
  const cb = document.getElementById('admin-verified');
  if (cb.checked) {
    document.getElementById('admin-password-section').style.display = 'block';
  } else {
    isAdminVerified = false; isSuperAdmin = false;
    document.getElementById('admin-password-section').style.display = 'none';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
  }
}

function verifyPassword() {
  const pw = document.getElementById('admin-password').value;
  if (pw === '2749') {
    isAdminVerified = true; isSuperAdmin = true;
    document.getElementById('admin-password-section').style.display = 'none';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
    showToast('ìŠˆí¼ê´€ë¦¬ì ì¸ì¦ë¨', 'success');
  } else if (pw === '1130') {
    isAdminVerified = true;
    document.getElementById('admin-password-section').style.display = 'none';
    showToast('ê´€ë¦¬ì ì¸ì¦ë¨', 'success');
  } else { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤', 'error'); }
  document.getElementById('admin-password').value = '';
}

function changePassword() {
  const np = document.getElementById('new-password').value;
  const cp = document.getElementById('confirm-password').value;
  if (!np) { showToast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'warning'); return; }
  if (np !== cp) { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'warning'); return; }
  localStorage.setItem(CONFIG.STORAGE_KEYS.PASSWORD, np);
  showToast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  document.getElementById('new-password').value = '';
  document.getElementById('confirm-password').value = '';
}

function setRankPreset(preset) {
  // Rank presets are saved via table settings
  showToast(`ë­í¬ í”„ë¦¬ì…‹: ${preset}`, 'saved');
}

// ==================== SECTION 18: WEBHOOK ====================
function updateWebhookURL() {
  const el = document.getElementById('webhook-url-display');
  if (el) el.textContent = `${location.origin}/api/webhook/toonation`;
}

async function testWebhook() {
  const donor = document.getElementById('webhook-test-donor').value.trim() || 'í…ŒìŠ¤íŠ¸';
  const amount = parseInt(document.getElementById('webhook-test-amount').value) || 10000;
  try {
    const res = await fetch('/api/webhook/toonation', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nickname: donor, amount, comment: 'ì›¹í›… í…ŒìŠ¤íŠ¸' })
    });
    const data = await res.json();
    if (data.success) showToast('ì›¹í›… í…ŒìŠ¤íŠ¸ ì„±ê³µ', 'success');
    else showToast('ì›¹í›… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
  } catch(e) { showToast('ì›¹í›… ì˜¤ë¥˜', 'error'); }
}

// ==================== SECTION 19: AUTOCOMPLETE ====================
function setupAutoComplete() {
  const input = document.getElementById('donor-input');
  const list = document.getElementById('donor-autocomplete');
  if (!input || !list) return;

  input.addEventListener('input', () => {
    const val = input.value.trim().toLowerCase();
    if (val.length < 1) { list.style.display = 'none'; return; }
    const donors = [...new Set(donations.map(d => d.donor))].filter(d => d.toLowerCase().includes(val));
    if (donors.length === 0) { list.style.display = 'none'; return; }
    list.innerHTML = donors.slice(0, 10).map(d => `<div class="ac-item" data-val="${d}">${d}</div>`).join('');
    list.style.display = 'block';
    list.querySelectorAll('.ac-item').forEach(item => {
      item.addEventListener('click', () => { input.value = item.dataset.val; list.style.display = 'none'; });
    });
  });

  document.addEventListener('click', (e) => { if (!e.target.closest('.ac-wrap')) list.style.display = 'none'; });
}

// ==================== SECTION 20: BOOTSTRAP ====================
document.addEventListener('DOMContentLoaded', initializeApp);

// Load saved sheet ID
window.addEventListener('load', () => {
  const sheetId = localStorage.getItem('google_sheet_id');
  if (sheetId) document.getElementById('google-sheet-id').value = sheetId;
});
</script>
</body>
</html>
