<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>🔴 실시간 방송 후원 정산 시스템</title>

<!-- Google API & Identity Services -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>

<style>
/* CSS는 이전과 동일합니다. */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; color: #333; margin: 0; padding: 0; overflow-x: hidden; }
#app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
#app-loader .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #1877f2; animation: spin 1s ease infinite; }
#app-loader p { margin-top: 20px; font-weight: 500; color: #606770; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.container { display: none; width: 100%; max-width: none; margin: 0; padding: 15px; grid-template-columns: 1.2fr 1.2fr 1.6fr; gap: 15px; min-height: calc(100vh - 30px); }
.container.loaded { display: grid; }
.panel { background: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); min-height: calc(100vh - 100px); overflow-y: auto; resize: horizontal; }
.panel h2 { margin: -20px -20px 15px -20px; padding: 15px 20px; color: #333; border-bottom: 1px solid #e0e0e0; font-size: 1.1rem; background-color: #fafafa; border-radius: 8px 8px 0 0;}
.btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin: 2px; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
.btn-primary { background-color: #1877f2; color: white; border-color: #1877f2;}
.btn-success { background-color: #42b72a; color: white; border-color: #42b72a;}
.btn-danger { background-color: #fa383e; color: white; border-color: #fa383e;}
.btn-secondary { background-color: #e4e6eb; color: #4b4f56; border-color: #dddfe2;}
.btn-warning { background-color: #f5c33b; color: #1c1e21; border-color: #f5c33b;}
.btn:hover { opacity: 0.9; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #606770; font-size: 0.9rem; }
.form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 14px; }
.form-input:focus, .form-select:focus { outline: none; }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
.table th, .table td { border: 1px solid #e9ebee; padding: 8px; text-align: center; }
.table th { background-color: #f5f6f7; font-weight: 600; }
#data-table-body td[data-field] { cursor: pointer; transition: background-color 0.2s; }
#data-table-body td[data-field]:hover { background-color: #e7f3ff; }
.copy-box { background-color: #f5f6f7; border-radius: 6px; padding: 10px; margin: 10px 0; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; word-break: break-all; min-height: 60px; white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto; border: 1px solid #e9ebee; }
.status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: 500; }
.status-success { background-color: #e9f6ec; color: #348a47; border: 1px solid #cce8d2; }
.status-error { background-color: #fde9e9; color: #a52828; border: 1px solid #f8d0d1; }
.status-info { background-color: #e7f3ff; color: #185a9d; border: 1px solid #cbe3ff; }
.status-warning { background-color: #fffbe6; color: #664d03; border: 1px solid #ffe58f; }
.management-nav { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;}
.tab-button { padding: 8px 12px; border: none; background: transparent; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-size: 14px; font-weight: 600; color: #606770; }
.tab-button.active { color: #1877f2; border-bottom-color: #1877f2; }
.tab-content { display: none; padding-top: 15px;}
.tab-content.active { display: block; }
.summary-tab-content { display: none; }
.summary-tab-content.active { display: block; }
.streamer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; }
.user-info { background-color: #e7f3ff; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; text-align: center; }
.admin { background-color: #fde9e9; color: #a52828; font-weight: 600; }
.autocomplete-container { position: relative; flex: 2; }
.donor-autocomplete { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dddfe2; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
.donor-autocomplete .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
.donor-autocomplete .autocomplete-item:hover, .donor-autocomplete .autocomplete-item.selected { background-color: #1877f2; color: white; }
.save-status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; transition: all 0.5s; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.save-status.saving { background-color: #f5c33b; color: #1c1e21; }
.save-status.saved { background-color: #42b72a; color: white; }
.save-status.error { background-color: #fa383e; color: white; }
.summary-header { display: flex; justify-content: space-between; align-items: center; }
.summary-header h4 { margin: 0; }

/* 퇴근미션 진행도 바 */
.mission-progress-container {
    width: 100%;
    height: 20px;
    background-color: #f0f2f5;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #dddfe2;
}
.mission-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #42b72a 0%, #56c946 50%, #6bd464 100%);
    width: 0%;
    transition: width 0.8s ease-in-out;
    border-radius: 10px;
    position: relative;
}
.mission-progress-bar.completed {
    background: linear-gradient(90deg, #ffd700 0%, #ffed4e 50%, #fff176 100%);
    animation: pulse-gold 2s infinite;
}
@keyframes pulse-gold {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}
.summary-actions .btn { font-size:12px; padding:4px 8px; margin-left: 5px; }

/* 챗봇 관련 스타일 */
.chatbot-step { margin-bottom: 25px; }
.btn-outline { background: transparent; border: 1px solid #1877f2; color: #1877f2; }
.btn-outline:hover { background: #1877f2; color: white; }
#advanced-settings { transition: all 0.3s ease; }
.chatbot-step .status { font-size: 14px; }
.chatbot-step h5 { color: #1877f2; font-weight: 600; }

@media (max-width: 1200px) { .container { grid-template-columns: 1fr 1fr; } }
@media (max-width: 900px) { .container { grid-template-columns: 1fr !important; } .panel { min-height: auto !important; resize: none !important; } }
</style>
</head>
<body>
<div id="app-loader">
<div class="spinner"></div>
<p>애플리케이션을 불러오는 중...</p>
</div>
<div id="save-status" style="display: none;"></div>
<div class="container" id="app-container">
<div class="panel">
<h2>관리</h2>
<div class="management-nav">
<button class="tab-button active" onclick="switchTab(event, 'donation')">후원등록</button>
<button class="tab-button" onclick="switchTab(event, 'streamer')">스트리머</button>
<button class="tab-button" onclick="switchTab(event, 'mission')">🎄 퇴근미션</button>
<button class="tab-button" onclick="switchTab(event, 'overlay')">🎨 오버레이</button>
<button class="tab-button" onclick="switchTab(event, 'password')" id="password-tab-btn" style="display: none;">비밀번호</button>
<button class="tab-button" onclick="switchTab(event, 'data')">데이터</button>
<button class="tab-button" onclick="switchTab(event, 'chatbot')">🤖 챗봇</button>
<button class="tab-button" onclick="switchTab(event, 'simple')" id="simple-tab-btn">🎯 조정</button>
</div>
<div id="main-content">
<div class="tab-content active" id="donation-tab">
<div id="password-section" style="display: none; margin-bottom:15px;">
<div style="display: flex; gap: 5px;"><input type="password" id="password-input" placeholder="4자리 비밀번호" maxlength="4" class="form-input"><button onclick="verifyPassword()" class="btn btn-primary">확인</button></div>
</div>
<div class="form-group"><label class="form-label">후원자명</label><div class="autocomplete-container" style="flex:auto;"><input type="text" id="donor-input" class="form-input" autocomplete="off"><div id="donor-autocomplete" class="donor-autocomplete"></div></div></div>
<div class="form-group"><label class="form-label">후원 타입</label><div style="display: flex; gap: 15px;"><label><input type="radio" name="paytype" value="계좌" checked> 계좌</label><label><input type="radio" name="paytype" value="투네"> 투네</label><label><input type="radio" name="paytype" value="슈퍼챗"> 슈퍼챗</label></div></div>
<div class="form-group"><label class="form-label">스트리머별 금액(만)</label><div class="streamer-grid" id="streamer-inputs"></div></div>
<button onclick="addDonation()" class="btn btn-primary" id="add-btn" style="width:100%;">✨ 등록</button>
</div>
<div class="tab-content" id="streamer-tab">
<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<h4 style="margin: 0 0 15px 0; color: #495057;">👤 새 스트리머 추가</h4>

<div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; align-items: end;">
<div>
<label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 5px; font-weight: bold;">스트리머 이름</label>
<input type="text" id="new-streamer-name" placeholder="예: 엄삼용" class="form-input" style="width: 100%;">
</div>

<div>
<label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 5px; font-weight: bold;">이모지</label>
<input type="text" id="new-streamer-emoji" placeholder="🫅" class="form-input" style="width: 100%; text-align: center;">
</div>

<button onclick="addStreamer()" class="btn btn-success" id="add-streamer-btn" 
        style="height: 40px; padding: 0 20px; font-weight: bold; font-size: 16px; white-space: nowrap; min-width: 100px;">
✨ 추가
</button>
</div>

<!-- 간단한 백업 레이아웃 (항상 보이는 추가 버튼) -->
<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
<input type="text" id="backup-streamer-name" placeholder="스트리머 이름" class="form-input" style="flex: 1; min-width: 120px;">
<input type="text" id="backup-streamer-emoji" placeholder="🫅" class="form-input" style="width: 80px; text-align: center;">
<button onclick="addStreamerBackup()" class="btn btn-success" style="padding: 8px 16px; font-weight: bold; background-color: #28a745 !important; border: none !important;">
➕ 추가
</button>
</div>
</div>

<!-- 모바일용 세로 레이아웃 -->
<div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
<h5 style="margin: 0 0 15px 0; color: #0d6efd;">📱 모바일용 간편 추가</h5>
<div style="margin-bottom: 10px;">
<input type="text" id="simple-streamer-name" placeholder="스트리머 이름" class="form-input" style="width: 100%;">
</div>
<div style="margin-bottom: 10px;">
<input type="text" id="simple-streamer-emoji" placeholder="이모지 (예: 🫅)" class="form-input" style="width: 100%; text-align: center;">
</div>
<button onclick="addStreamerSimple()" class="btn btn-primary" 
        style="width: 100%; padding: 12px; font-weight: bold; font-size: 16px; background-color: #0d6efd !important;">
✨ 스트리머 추가하기
</button>
</div>
</div>

<div style="background: white; border-radius: 8px; border: 1px solid #e9ecef;">
<h4 style="margin: 0; padding: 15px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">📋 스트리머 목록</h4>
<div id="streamer-list" style="min-height: 200px; padding: 15px;"></div>
</div>

<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px;">
<h4 style="margin: 0 0 10px 0; color: #856404;">🔧 이모지 복원</h4>
<button onclick="restoreEmojis()" class="btn btn-warning">이모지 즉시 복원</button>
<p style="font-size: 12px; color: #856404; margin: 5px 0 0 0;">이모지가 안 보이면 이 버튼을 눌러주세요</p>
</div>
</div>
<div class="tab-content" id="mission-tab">
<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 15px;">🎯 퇴근미션 관리</h4>

<!-- 새 미션 생성 -->
<div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
<h5 style="margin-bottom: 10px;">🎄 새 퇴근미션 생성</h5>
<div style="display: flex; gap: 10px; align-items: end;">
<div style="flex: 1;">
<label style="display: block; margin-bottom: 5px; font-weight: 600;">스트리머</label>
<select id="mission-streamer" class="form-select">
<option value="">선택하세요</option>
</select>
</div>
<div style="flex: 1;">
<label style="display: block; margin-bottom: 5px; font-weight: 600;">목표액 (만원)</label>
<input type="number" id="mission-target" class="form-input" placeholder="100" step="1" min="1">
</div>
<div style="flex: 2;">
<label style="display: block; margin-bottom: 5px; font-weight: 600;">설명 (선택사항)</label>
<input type="text" id="mission-description" class="form-input" placeholder="퇴근미션 설명">
</div>
<button onclick="createMission()" class="btn btn-success" style="height: 40px;">➕ 생성</button>
</div>
</div>


<!-- 진행중인 미션 목록 -->
<div style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px;">
<div style="background: #495057; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0;">
<h5 style="margin: 0;">🎯 퇴근미션 현황</h5>
</div>
<div id="running-missions-list" style="padding: 15px;">
<div class="no-missions" style="text-align: center; color: #6c757d; padding: 20px;">
퇴근미션이 없습니다.
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="overlay-tab">
<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">📺 방송용 오버레이</h4>

<!-- 후원자 오버레이 섹션 -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>💝 후원자별 총액 오버레이</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('donor')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">🔗 열기</button>
<button onclick="copyOverlayURL('donor')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">📋 URL 복사</button>
<button onclick="showQRCode('donor')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">📱 QR코드</button>
</div>
</div>
<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="donor-overlay-url">https://donation-manager-ufm1.onrender.com/donor-overlay.html</span>
</div>
</div>

<!-- 스트리머 테이블 섹션 -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>🏆 스트리머 테이블 오버레이</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('table')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">🔗 열기</button>
<button onclick="copyOverlayURL('table')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">📋 URL 복사</button>
<button onclick="showQRCode('table')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">📱 QR코드</button>
</div>
</div>

<!-- 총액만 표시 설정 -->
<div style="margin-bottom: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; border: 1px solid #b3d9ff;">
<label style="display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1877f2; cursor: pointer;">
<input type="checkbox" id="overlay-total-only-mode" style="width: 16px; height: 16px; cursor: pointer;"> 총액만 표시 (계좌/투네 열 숨기기)
</label>
<p style="font-size: 12px; color: #666; margin: 5px 0 0 24px;">체크하면 오버레이에서 계좌후원/투네후원 열이 숨겨지고 총합만 표시됩니다.</p>
</div>

<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="table-overlay-url">https://donation-manager-ufm1.onrender.com/streamer-table-overlay.html</span>
</div>
</div>

<!-- 총액만 전용 오버레이 섹션 -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f0f8ff;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>💰 총액만 전용 오버레이 <span style="color: #42b72a; font-size: 12px; font-weight: normal;">[NEW]</span></strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('total-only')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">🔗 열기</button>
<button onclick="copyOverlayURL('total-only')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">📋 URL 복사</button>
<button onclick="showQRCode('total-only')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">📱 QR코드</button>
</div>
</div>

<div style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 12px; color: #2d5a2d;">
<strong>✨ 추천!</strong> 복잡한 설정 없이 바로 사용할 수 있는 총액만 표시 전용 오버레이입니다.
</div>

<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="total-only-overlay-url">https://donation-manager-ufm1.onrender.com/total-only-overlay.html</span>
</div>
</div>

<!-- 퇴근미션 그래프 섹션 -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>🎯 퇴근미션 그래프 오버레이</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('graph')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">🔗 열기</button>
<button onclick="copyOverlayURL('graph')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">📋 URL 복사</button>
<button onclick="showQRCode('graph')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">📱 QR코드</button>
<button onclick="showMissionGraphSettings()" class="btn btn-warning" style="font-size: 12px; padding: 5px 10px;">🎨 설정</button>
</div>
</div>
<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="graph-overlay-url">https://donation-manager-ufm1.onrender.com/mission-graph-overlay.html</span>
</div>

<!-- 총액 목표 그래프 오버레이 섹션 -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f0f8ff;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>🎯 총액 목표 그래프 오버레이</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('total-goal')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">🔗 열기</button>
<button onclick="copyOverlayURL('total-goal')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">📋 URL 복사</button>
<button onclick="showQRCode('total-goal')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">📱 QR코드</button>
<button onclick="showTotalGoalSettings()" class="btn btn-warning" style="font-size: 12px; padding: 5px 10px;">🎨 설정</button>
</div>
</div>
<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="total-goal-overlay-url">https://donation-manager-ufm1.onrender.com/total-goal-overlay.html</span>
</div>

<!-- 총액 목표 설정 패널 -->
<div id="total-goal-settings" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px;">
<h5 style="margin-bottom: 15px; color: #2e7d32;">💰 총액 목표 설정</h5>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
<!-- 목표 금액 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">일일 목표액 (만원)</label>
<input type="number" id="daily-goal-target" placeholder="예: 100" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
</div>

<!-- 자동 연장 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">
<input type="checkbox" id="auto-extend-enabled" style="margin-right: 5px;"> 자동 목표 연장
</label>
<input type="number" id="extend-amount" placeholder="50" value="50" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" disabled>
<small style="color: #666;">추가 금액 (만원)</small>
</div>
</div>

<!-- 배경 및 텍스트 설정 -->
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">배경 투명도: <span id="bg-opacity-value">0%</span></label>
<input type="range" id="total-goal-bg-opacity" min="0" max="100" value="0" style="width: 100%;">
</div>
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">배경 색상</label>
<input type="color" id="total-goal-bg-color" value="#000000" style="width: 100%; height: 30px;">
</div>
</div>

<!-- 텍스트 테두리 설정 -->
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">글자 테두리 두께: <span id="text-outline-width-value">1px</span></label>
<input type="range" id="total-goal-text-outline-width" min="0" max="5" value="1" style="width: 100%;">
</div>
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">글자 테두리 색상</label>
<input type="color" id="total-goal-text-outline-color" value="#000000" style="width: 100%; height: 30px;">
</div>
</div>

<!-- 표시 옵션 -->
<div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
<h6 style="margin: 0 0 15px 0; color: #333;">📋 표시 옵션</h6>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
<label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
<input type="checkbox" id="total-goal-show-top-stats" checked style="margin-right: 8px; transform: scale(1.2);">
진행바 위 글자 표시 (현재액 / 목표액 %)
</label>
</div>

<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
<label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
<input type="checkbox" id="total-goal-text-switch-enabled" style="margin-right: 8px; transform: scale(1.2);">
진행바 텍스트 자동 전환 (퍼센트 ⟷ 남은금액)
</label>
</div>

<div style="display: flex; align-items: center; gap: 10px;">
<label style="font-weight: 500;">전환 간격: <span id="text-switch-interval-value">5초</span></label>
<input type="range" id="total-goal-text-switch-interval" min="3" max="30" value="5" style="flex: 1;" disabled>
</div>
</div>

<!-- 크기 설정 -->
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">제목 크기: <span id="total-goal-title-size-value">24px</span></label>
<input type="range" id="total-goal-title-size" min="16" max="40" value="24" style="width: 100%;">
</div>
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">숫자 크기: <span id="total-goal-stats-size-value">20px</span></label>
<input type="range" id="total-goal-stats-size" min="14" max="32" value="20" style="width: 100%;">
</div>
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행바 높이: <span id="total-goal-progress-height-value">30px</span></label>
<input type="range" id="total-goal-progress-height" min="15" max="50" value="30" style="width: 100%;">
</div>
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행바 글자 크기: <span id="total-goal-progress-text-size-value">16px</span></label>
<input type="range" id="total-goal-progress-text-size" min="12" max="24" value="16" style="width: 100%;">
</div>
</div>

<div style="display: flex; gap: 10px;">
<button onclick="saveTotalGoalSettings()" class="btn btn-success">적용</button>
<button onclick="resetTotalGoalSettings()" class="btn btn-secondary">기본값 복원</button>
<button onclick="hideTotalGoalSettings()" class="btn btn-danger">닫기</button>
</div>
</div>
</div>

<!-- 미션 그래프 설정 패널 (숨김) -->
<div id="mission-graph-settings" style="display: none; margin-top: 15px; padding: 15px; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px;">
<h5 style="margin-bottom: 15px; color: #1565c0;">🎨 미션 그래프 오버레이 설정</h5>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<!-- 배경 설정 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">배경 투명도</label>
<input type="range" id="graph-opacity" min="0" max="100" value="85" style="width: 100%;">
<span id="graph-opacity-value">85%</span>
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">배경 색상</label>
<input type="color" id="graph-bg-color" value="#000000" style="width: 100%; height: 30px;">
</div>

<!-- 테두리 설정 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">테두리 색상</label>
<input type="color" id="graph-border-color" value="#42b72a" style="width: 100%; height: 30px;">
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">테두리 두께</label>
<input type="range" id="graph-border-width" min="0" max="10" value="2" style="width: 100%;">
<span id="graph-border-width-value">2px</span>
</div>

<!-- 폰트 설정 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">제목 크기</label>
<input type="range" id="title-font-size" min="14" max="30" value="20" style="width: 100%;">
<span id="title-font-size-value">20px</span>
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">숫자 크기</label>
<input type="range" id="stats-font-size" min="12" max="24" value="16" style="width: 100%;">
<span id="stats-font-size-value">16px</span>
</div>

<!-- 진행도 바 설정 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행도 바 높이</label>
<input type="range" id="progress-height" min="15" max="40" value="20" style="width: 100%;">
<span id="progress-height-value">20px</span>
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행도 바 배경</label>
<input type="color" id="progress-bg-color" value="#2c2c2c" style="width: 100%; height: 30px;">
</div>

<!-- 진행 중 색상 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행중 시작색</label>
<input type="color" id="progress-start-color" value="#42b72a" style="width: 100%; height: 30px;">
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">진행중 끝색</label>
<input type="color" id="progress-end-color" value="#6bd464" style="width: 100%; height: 30px;">
</div>

<!-- 완료 색상 -->
<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">완료 시작색</label>
<input type="color" id="complete-start-color" value="#ffd700" style="width: 100%; height: 30px;">
</div>

<div>
<label style="display: block; font-weight: 600; margin-bottom: 5px;">완료 끝색</label>
<input type="color" id="complete-end-color" value="#fff176" style="width: 100%; height: 30px;">
</div>
</div>

<div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
<button onclick="applyMissionGraphSettings()" class="btn btn-success">✅ 적용</button>
<button onclick="resetMissionGraphSettings()" class="btn btn-secondary">🔄 초기화</button>
<button onclick="hideMissionGraphSettings()" class="btn btn-secondary">❌ 닫기</button>
</div>
</div>
</div>

<!-- 실시간 미리보기 토글 -->
<div style="margin-bottom: 15px; text-align: center;">
<button onclick="togglePreview()" class="btn btn-info" id="preview-toggle">👁️ 실시간 미리보기 켜기</button>
<button onclick="openAllOverlays()" class="btn btn-warning" style="margin-left: 10px;">🔗 모든 오버레이 한번에 열기</button>
</div>

<!-- 미리보기 영역 -->
<div id="preview-area" style="display: none; border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: #f8f9ff; margin-bottom: 15px;">
<h5 style="margin: 0 0 10px 0; color: #667eea;">🔴 실시간 미리보기 (설정 변경 시 즉시 반영)</h5>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div style="background: black; border-radius: 4px; min-height: 100px; padding: 10px; position: relative;">
<iframe id="donor-preview" src="" style="width: 100%; height: 100px; border: none; transform: scale(0.5); transform-origin: top left; width: 200%; height: 200px;"></iframe>
<div style="position: absolute; bottom: 5px; left: 5px; color: white; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px;">후원자 오버레이</div>
</div>
<div style="background: black; border-radius: 4px; min-height: 100px; padding: 10px; position: relative;">
<iframe id="table-preview" src="" style="width: 100%; height: 100px; border: none; transform: scale(0.5); transform-origin: top left; width: 200%; height: 200px;"></iframe>
<div style="position: absolute; bottom: 5px; left: 5px; color: white; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px;">테이블 오버레이</div>
</div>
</div>
</div>

<div style="background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
<p style="font-size: 13px; margin: 0; color: #0c5460;">
💡 <strong>사용 방법:</strong><br>
• <strong>OBS:</strong> 브라우저 소스 추가 → URL 붙여넣기 → 너비: 1920, 높이: 1080<br>
• <strong>모바일:</strong> QR코드로 스캔하여 바로 접속<br>
• <strong>다른 PC:</strong> URL을 복사해서 브라우저에서 열기<br>
• 설정 변경 시 모든 기기에 실시간 반영됩니다
</p>
</div>
</div>

<div style="border-top: 1px solid #ddd; padding-top: 20px;">
<h4 style="margin-bottom: 15px;">🎨 후원자별 총액 오버레이 설정</h4>

<div style="margin-bottom: 15px;">
<label class="form-label">글자 크기: <span id="overlay-font-size-value">16px</span></label>
<input type="range" id="overlay-font-size-range" min="12" max="150" value="16" 
       onInput="updateOverlayFontSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">외각선 두께: <span id="overlay-stroke-width-value">2px</span></label>
<input type="range" id="overlay-stroke-width-range" min="0" max="10" step="0.2" value="2" 
       onInput="updateOverlayStrokeWidth(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">텍스트 정렬:</label>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<button onclick="setOverlayTextAlign('left')" class="btn btn-secondary" id="overlay-align-left">⬅️ 왼쪽</button>
<button onclick="setOverlayTextAlign('center')" class="btn btn-secondary" id="overlay-align-center">⏺️ 가운데</button>
<button onclick="setOverlayTextAlign('right')" class="btn btn-secondary" id="overlay-align-right">➡️ 오른쪽</button>
</div>
</div>

<div style="margin-bottom: 20px;">
<button onclick="applyOverlaySettings()" class="btn btn-success">적용</button>
<button onclick="resetOverlaySettings()" class="btn btn-secondary">기본값 복원</button>
</div>
</div>

<div style="border-top: 1px solid #ddd; padding-top: 20px;">
<h4 style="margin-bottom: 15px;">🏆 스트리머 테이블 오버레이 설정</h4>

<div style="margin-bottom: 15px;">
<label class="form-label">배경 투명도: <span id="table-opacity-value">85%</span></label>
<input type="range" id="table-opacity-range" min="0" max="100" value="85" 
       onInput="updateTableOpacity(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">숫자 크기: <span id="table-number-size-value">16px</span></label>
<input type="range" id="table-number-size-range" min="12" max="60" value="16" 
       onInput="updateTableNumberSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">전체 글자 크기: <span id="table-font-size-value">14px</span></label>
<input type="range" id="table-font-size-range" min="10" max="30" value="14" 
       onInput="updateTableFontSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">글자 색상:</label>
<div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
<button onclick="setTableTextColor('white')" class="btn btn-secondary" style="background: #fff; color: #000; border: 2px solid #ddd;">흰색</button>
<button onclick="setTableTextColor('#FFD700')" class="btn btn-secondary" style="background: #FFD700; color: #000;">금색</button>
<button onclick="setTableTextColor('#87CEEB')" class="btn btn-secondary" style="background: #87CEEB; color: #000;">하늘색</button>
<button onclick="setTableTextColor('#90EE90')" class="btn btn-secondary" style="background: #90EE90; color: #000;">연두색</button>
<button onclick="setTableTextColor('#FFB6C1')" class="btn btn-secondary" style="background: #FFB6C1; color: #000;">핑크</button>
<button onclick="setTableTextColor('#DDA0DD')" class="btn btn-secondary" style="background: #DDA0DD; color: #000;">보라색</button>
</div>
</div>


<div style="margin-bottom: 15px;">
<label class="form-label">배경 색상 프리셋:</label>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<button onclick="setTableColorPreset('dark')" class="btn btn-secondary" style="background: linear-gradient(135deg, #000, #1e1e1e); color: white;">다크</button>
<button onclick="setTableColorPreset('blue')" class="btn btn-secondary" style="background: linear-gradient(135deg, #191970, #4169e1); color: white;">블루</button>
<button onclick="setTableColorPreset('purple')" class="btn btn-secondary" style="background: linear-gradient(135deg, #8b008b, #4b0082); color: white;">퍼플</button>
<button onclick="setTableColorPreset('green')" class="btn btn-secondary" style="background: linear-gradient(135deg, #006400, #228b22); color: white;">그린</button>
<button onclick="setTableColorPreset('brown')" class="btn btn-secondary" style="background: linear-gradient(135deg, #8b4513, #a0522d); color: white;">브라운</button>
</div>
</div>

<div style="margin-bottom: 20px;">
<button onclick="applyTableSettings()" class="btn btn-success">적용</button>
<button onclick="resetTableSettings()" class="btn btn-secondary">기본값 복원</button>
</div>
</div>
</div>
<div class="tab-content" id="password-tab">
<div style="margin-bottom: 20px; padding: 15px; border: 2px solid #dc3545; border-radius: 8px; background: #f8d7da;">
<h4 style="color: #721c24; margin: 0 0 10px 0;">🔒 관리자 전용</h4>
<div style="margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 10px; color: #721c24;">
<input type="checkbox" id="admin-verified" onchange="toggleAdminMode()" style="transform: scale(1.2);">
<strong>관리자 인증 완료</strong>
</label>
</div>
<div style="font-size: 12px; color: #6c757d;">
⚠️ 관리자만 체크할 수 있습니다. 체크 시 모든 관리 기능 사용 가능
</div>
</div>

<div style="margin-bottom: 20px; padding: 15px; border: 2px solid #17a2b8; border-radius: 8px; background: #d1ecf1;">
<h4 style="color: #0c5460; margin: 0 0 10px 0;">🎯 간단 모드 설정</h4>
<div style="margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 10px; color: #0c5460;">
<input type="checkbox" id="simple-mode-only" onchange="toggleSimpleModeOnly()" style="transform: scale(1.2);">
<strong>조정 탭만 보이기</strong>
</label>
</div>
<div style="font-size: 12px; color: #6c757d;">
💡 체크하면 다른 사람이 볼 때 조정 탭만 표시됩니다. 관리자는 모든 탭을 볼 수 있습니다.
</div>
</div>
</div>
<div class="tab-content" id="data-tab">
<button onclick="showAdminPassword()" class="btn btn-secondary" id="pwd-btn" style="display:none;">🔑 비번조회</button>
<div style="display: flex; flex-wrap: wrap; gap: 10px;"><button onclick="exportData()" class="btn btn-primary">📄 데이터 내보내기</button><button onclick="saveData()" class="btn btn-success" id="save-btn">💾 일간저장</button><button onclick="showResetDialog()" class="btn btn-warning" id="reset-btn">🔄 초기화</button><button onclick="importData()" class="btn btn-secondary" id="import-btn">📂 데이터 가져오기</button></div>

<div style="margin-top: 20px; padding: 15px; border: 2px solid #4285f4; border-radius: 8px; background: #f8f9ff;">
<h4 style="color: #4285f4; margin: 0 0 15px 0;">☁️ 구글 드라이브 백업</h4>
<div id="google-drive-status" class="status status-info" style="margin-bottom: 15px;">
🔑 구글 계정으로 로그인하면 자동 백업이 가능합니다
</div>

<div style="display: flex; flex-wrap: wrap; gap: 10px;">
<button onclick="signInGoogle()" class="btn btn-primary" id="google-signin-btn">🔑 구글 로그인</button>
<button onclick="signOutGoogle()" class="btn btn-secondary" id="google-signout-btn" style="display: none;">🚪 로그아웃</button>
<button onclick="backupToGoogleDrive()" class="btn btn-success" id="google-backup-btn" style="display: none;">☁️ 구글 드라이브 백업</button>
<button onclick="toggleAutoBackup()" class="btn btn-warning" id="auto-backup-btn" style="display: none;">⏰ 자동백업 OFF</button>
</div>

<div id="google-user-info" style="margin-top: 10px; font-size: 13px; color: #666; display: none;">
📧 로그인된 계정: <span id="user-email"></span>
</div>
</div>
<input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleFileImport(event)">
</div>

<div class="tab-content" id="chatbot-tab">
<!-- 단계별 설정 -->
<div class="chatbot-step" id="step-1">
<div class="status status-info" style="margin-bottom: 20px;">
<strong>1단계:</strong> 🔐 Google 계정 로그인
</div>
<div id="google-auth-status" class="status status-warning">
🔐 <strong>Google 로그인 필요</strong>: YouTube API 사용을 위해 로그인하세요.
</div>
</div>

<div class="chatbot-step" id="step-2" style="display: none;">
<div class="status status-info" style="margin-bottom: 20px;">
<strong>2단계:</strong> 📺 YouTube 라이브 방송 연결
</div>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="text" id="youtube-video-id" placeholder="YouTube 영상 ID 입력" class="form-input" style="flex: 1;">
<button onclick="connectToLiveChatOAuth()" class="btn btn-success">연결</button>
</div>
<p style="font-size: 12px; color: #666; margin-bottom: 20px;">
💡 YouTube 라이브 방송 URL: youtube.com/watch?v=<strong>여기부분</strong> ← 이 ID를 복사하세요
</p>
</div>

<div class="chatbot-step" id="step-3" style="display: none;">
<div class="status status-success" style="margin-bottom: 20px;">
<strong>3단계:</strong> 🚀 메시지 전송하기
</div>

<!-- 빠른 메시지 버튼들 -->
<div class="form-group">
<label class="form-label">⚡ 빠른 메시지</label>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
<button onclick="generateQuickMessage('welcome')" class="btn btn-outline">👋 인사</button>
<button onclick="generateQuickMessage('thanks')" class="btn btn-outline">💝 감사</button>
<button onclick="generateQuickMessage('goal')" class="btn btn-outline">🎯 목표</button>
<button onclick="generateQuickMessage('mission')" class="btn btn-outline">🎄 미션</button>
</div>
</div>

<!-- 메시지 입력 -->
<div class="form-group">
<label for="manual-message" class="form-label">💬 메시지 내용</label>
<textarea id="manual-message" class="form-input" rows="3" placeholder="메시지를 직접 입력하거나 위 버튼으로 자동 생성"></textarea>
</div>

<!-- 전송 버튼 -->
<div style="display: flex; gap: 10px; margin-bottom: 20px;">
<button onclick="sendToYouTube()" class="btn btn-success" style="flex: 1;" id="youtube-send-btn">🚀 전송</button>
<button onclick="clearMessage()" class="btn btn-secondary">🗑️</button>
</div>

<!-- 실시간 후원 현황 -->
<div class="form-group">
<label class="form-label">🔥 실시간 후원 현황</label>
<div class="copy-box" id="live-summary" style="min-height: 60px; font-size: 14px;"></div>
<div style="display: flex; gap: 10px; margin-top: 10px;">
<button onclick="updateLiveSummary()" class="btn btn-primary" style="flex: 1;">🔄 업데이트</button>
<button onclick="sendCurrentSummary()" class="btn btn-success" style="flex: 1;">📤 전송</button>
</div>
</div>

<!-- 후원시 자동 알림 설정 -->
<div class="form-group" style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7; margin-bottom: 20px;">
<label class="form-label" style="margin-bottom: 15px;">🔔 후원 등록시 자동 알림</label>
<div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
<input type="checkbox" id="chatbot-auto-notify" onchange="syncAutoNotifySettings()" style="transform: scale(1.3);">
<span style="font-weight: 500;">후원 등록하면 바로 챗봇에 알림 전송</span>
</label>
</div>

<!-- 빠른 권한 활성화 -->
<div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
<button onclick="quickEnableAdmin()" class="btn btn-primary" style="flex: 1;" id="quick-admin-btn">
🔓 관리자 권한 활성화
</button>
</div>

<div id="auto-notify-status" class="status status-warning" style="font-size: 12px; margin: 0;">
후원 자동 알림이 비활성화되어 있습니다.
</div>
</div>

<!-- 자동 전송 설정 -->
<div class="form-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
<label class="form-label" style="margin-bottom: 15px;">⏰ 자동 총액 전송</label>
<div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
<select id="auto-interval-select" class="form-input" style="flex: 1;">
<option value="30">30초마다</option>
<option value="45">45초마다</option>
<option value="60">1분마다</option>
<option value="120">2분마다</option>
<option value="180">3분마다</option>
<option value="300" selected>5분마다</option>
<option value="600">10분마다</option>
<option value="900">15분마다</option>
<option value="1200">20분마다</option>
<option value="1800">30분마다</option>
<option value="3600">1시간마다</option>
</select>
<button onclick="toggleAutoSend()" class="btn btn-success" id="auto-send-toggle">🚀 시작</button>
</div>
<div id="auto-send-status" class="status status-info" style="font-size: 12px; margin: 0;">
자동 전송이 비활성화되어 있습니다.
</div>
</div>
</div>

<!-- 고급 설정 (접기/펼치기) -->
<div style="margin-top: 30px;">
<button onclick="toggleAdvancedSettings()" class="btn btn-secondary" style="width: 100%;" id="advanced-toggle">
⚙️ 고급 설정 표시
</button>
</div>

<div id="advanced-settings" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
<h4 style="margin: 0 0 15px 0;">🔧 고급 설정</h4>

<!-- API 키 방식 (백업용) -->
<div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
<h5 style="margin: 0 0 10px 0;">🔑 API 키 방식 (백업)</h5>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="password" id="youtube-api-key" placeholder="YouTube API 키" class="form-input" style="flex: 1;">
<button onclick="testApiKey()" class="btn btn-secondary">테스트</button>
</div>
</div>

<!-- 자동 전송 설정 (구버전) -->
<div style="margin-bottom: 20px;">
<h5 style="margin: 0 0 10px 0;">🔄 자동 전송 (레거시)</h5>
<div style="display: flex; gap: 10px; align-items: center;">
<input type="number" id="auto-send-interval" placeholder="간격(초)" class="form-input" style="width: 100px;" min="30" value="300">
<button onclick="startAutoSend()" class="btn btn-success" id="auto-start-btn">시작</button>
<button onclick="stopAutoSend()" class="btn btn-danger" id="auto-stop-btn" disabled>중지</button>
</div>
<p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">⚠️ 위의 새로운 자동 전송 기능을 사용하세요.</p>
</div>

<!-- 디버그 도구 -->
<div>
<h5 style="margin: 0 0 10px 0;">🔧 테스트 도구</h5>
<button onclick="testYouTubeOAuth()" class="btn btn-outline">API 연결 테스트</button>
</div>
</div>
</div>

<div class="tab-content" id="simple-tab">
<div id="simple-mode-status" class="status status-info" style="margin-bottom: 15px;">
🎯 <strong>조정 모드</strong>: 스트리머별 또는 후원자별로 금액을 단독 조정할 수 있습니다
</div>

<div class="form-group">
<label class="form-label">🎯 조정 모드 선택</label>
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button onclick="switchSimpleMode('streamer')" id="streamer-mode-btn" class="btn btn-secondary" style="flex: 1;">
        🎬 스트리머별 조정
    </button>
    <button onclick="switchSimpleMode('donor')" id="donor-mode-btn" class="btn btn-secondary" style="flex: 1;">
        💝 후원자별 조정
    </button>
</div>
</div>

<!-- 스트리머별 조정 모드 -->
<div id="streamer-mode-panel" class="form-group" style="display: none;">
<label class="form-label">🎬 스트리머별 금액 조정</label>
<div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border: 1px solid #87ceeb;">
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">스트리머 선택</label>
        <select id="streamer-mode-select" class="form-input">
            <option value="">스트리머 선택</option>
        </select>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">후원 타입</label>
        <div style="display: flex; gap: 15px;">
            <label><input type="radio" name="streamer-paytype" value="계좌" checked> 계좌</label>
            <label><input type="radio" name="streamer-paytype" value="투네"> 투네</label>
            <label><input type="radio" name="streamer-paytype" value="슈퍼챗"> 슈퍼챗</label>
        </div>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">조정 금액 (만원)</label>
        <input type="number" id="streamer-amount-input" class="form-input" placeholder="예: +1.5 또는 -0.5" step="0.1">
    </div>
    
    <button onclick="adjustStreamerAmount()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
        🎬 스트리머 금액 조정
    </button>
</div>
</div>

<!-- 후원자별 조정 모드 -->
<div id="donor-mode-panel" class="form-group" style="display: none;">
<label class="form-label">💝 후원자별 금액 조정</label>
<div style="background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #ffc0cb;">
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">후원자명</label>
        <input type="text" id="donor-mode-input" class="form-input" placeholder="후원자 이름 입력">
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">후원 타입</label>
        <div style="display: flex; gap: 15px;">
            <label><input type="radio" name="donor-paytype" value="계좌" checked> 계좌</label>
            <label><input type="radio" name="donor-paytype" value="투네"> 투네</label>
            <label><input type="radio" name="donor-paytype" value="슈퍼챗"> 슈퍼챗</label>
        </div>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">조정 금액 (만원)</label>
        <input type="number" id="donor-amount-input" class="form-input" placeholder="예: +2.0 또는 -1.0" step="0.1">
    </div>
    
    <button onclick="adjustDonorAmount()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
        💝 후원자 금액 조정
    </button>
</div>
</div>

<div class="form-group">
<label class="form-label">📝 최근 등록 내역</label>
<div id="simple-recent-list" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 13px;">
    <div style="color: #666; text-align: center; padding: 20px;">등록된 후원이 없습니다</div>
</div>
</div>
</div>
</div>
</div>
<div class="panel">
<h2>정산 요약</h2>
<div class="management-nav" style="margin-bottom: 0;">
<button class="tab-button active" onclick="switchSummaryTab(event, 'basic-summary')">기본 요약</button>
<button class="tab-button" onclick="switchSummaryTab(event, 'table-summary')">상세 테이블</button>
</div>
<div id="basic-summary" class="summary-tab-content active" style="padding-top: 15px;">
<div>
<div class="summary-header">
<h4>스트리머 총액</h4>
<div class="summary-actions">
<button onclick="toggleStreamerSummarySettings()" class="btn btn-secondary">⚙️ 설정</button>
<button onclick="copyText('summary-output')" class="btn btn-secondary">복사</button>
<button onclick="sendStreamerSummaryToChatbot()" class="btn btn-success" id="streamer-summary-chatbot-btn">📤 챗봇 전송</button>
</div>
</div>

<div id="streamer-summary-settings" style="display: none; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
<div style="margin-bottom: 10px;">
<label class="form-label">머릿글:</label>
<input type="text" id="streamer-summary-header" class="form-input" placeholder="예: 🔥🏫삼용스쿨🏫🔥" value="🔥🏫삼용스쿨🏫🔥">
</div>
<div style="margin-bottom: 10px;">
<label class="form-label">꼬릿글:</label>
<input type="text" id="streamer-summary-footer" class="form-input" placeholder="예: 🏧투네/계좌 [8:2] 🎉슈퍼챗은 국고로~!" value="🏧투네/계좌 [8:2] 🎉슈퍼챗은 국고로~!">
</div>
<div style="margin-bottom: 10px;">
<label><input type="checkbox" id="exclude-gukgo"> 국고 제외하고 계산</label>
</div>
<div style="display: flex; gap: 5px;">
<button onclick="saveStreamerSummarySettings()" class="btn btn-primary">저장</button>
<button onclick="resetStreamerSummarySettings()" class="btn btn-secondary">기본값</button>
</div>
</div>

<div class="copy-box" id="summary-output"></div>
</div>
<div>
<div class="summary-header">
    <h4>후원자별 총액</h4>
    <div class="summary-actions">
        <button onclick="copyText('donor-total')" class="btn btn-secondary">복사</button>
    </div>
</div>
<div style="display: flex; gap: 5px; align-items: center; margin-bottom: 5px;">
    <span style="font-size: 14px;">같은 금액 묶기 (</span>
    <input type="number" id="group-threshold" value="2" min="1" class="form-input" style="width: 60px;">
    <span style="font-size: 14px;">명 이상)</span>
    <button onclick="updateSummary()" class="btn btn-primary" style="font-size:12px; padding:4px 8px;">적용</button>
</div>
<div style="display: flex; gap: 10px; align-items: center; margin-bottom: 5px;">
    <label style="font-size: 14px;"><input type="checkbox" id="include-superchat"> 슈퍼챗 포함</label>
</div>
<div class="copy-box" id="donor-total"></div>
</div>
<div>
<div class="summary-header">
<h4>최근 입금 내역</h4>
<div class="summary-actions">
<button onclick="copyText('recent-log')" class="btn btn-secondary">복사</button>
</div>
</div>
<div style="display: flex; gap: 5px; align-items: center; margin-bottom: 5px;">
<input type="number" id="recent-minutes" value="5" class="form-input" style="width: 70px;">
<span style="font-size: 14px;">분 이내</span>
<button onclick="updateSummary()" class="btn btn-primary" style="font-size:12px; padding:4px 8px;">조회</button>
</div>
<div class="copy-box" id="recent-log"></div>
</div>
<div>
<div class="summary-header">
<h4>🎄 퇴근미션 현황</h4>
<div class="summary-actions">
<button onclick="copyText('mission-summary-output')" class="btn btn-secondary">복사</button>
<button onclick="sendMissionSummaryToChatbot()" class="btn btn-success" id="mission-summary-chatbot-btn">📤 챗봇 전송</button>
</div>
</div>
<!-- 목표치 진행도 그래프 -->
<div style="margin-bottom: 15px;">
    <div style="text-align: center; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #495057;">
        <span id="mission-remaining-text">목표까지 0만원 남음</span>
    </div>
    <div class="mission-progress-container">
        <div class="mission-progress-bar" id="mission-progress-bar"></div>
    </div>
</div>

<div class="copy-box" id="mission-summary-output">진행 중인 미션이 없습니다.</div>
</div>
</div>
<div id="table-summary" class="summary-tab-content" style="padding-top: 15px;">

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
<h4 style="margin: 0;" id="table-title-display">🏆 스트리머별 후원 현황 🏆</h4>
<button onclick="toggleTableSettings()" class="btn btn-secondary">⚙️ 테이블 설정</button>
</div>

<div id="table-settings" style="display: none; margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
<div style="margin-bottom: 15px;">
<label class="form-label">테이블 제목:</label>
<input type="text" id="table-title-input" class="form-input" placeholder="예: 🏆 스트리머별 후원 현황 🏆" value="🏆 스트리머별 후원 현황 🏆">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">순번명 설정:</label>
<div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
<span style="font-size: 14px;">순위 개수:</span>
<input type="number" id="rank-count" class="form-input" style="width: 80px;" min="1" max="20" value="10" onchange="updateRankInputs()">
<span style="font-size: 12px; color: #666;">(최대 20개)</span>
</div>

<div id="rank-inputs-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
<!-- 동적으로 생성될 순번명 입력 필드들 -->
</div>

<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<button onclick="setRankPreset('royalty')" class="btn btn-secondary">👑 왕족</button>
<button onclick="setRankPreset('flowers')" class="btn btn-secondary">🌸 꽃이름</button>
<button onclick="setRankPreset('animals')" class="btn btn-secondary">🐾 동물</button>
<button onclick="setRankPreset('numbers')" class="btn btn-secondary">🔢 숫자</button>
</div>
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">표시 옵션:</label>
<div style="display: flex; gap: 15px; margin-top: 5px;">
<label><input type="checkbox" id="show-total-row" checked> 총합계 행 표시</label>
<label><input type="checkbox" id="show-update-time"> 업데이트 시간 표시</label>
</div>
</div>

<div style="display: flex; gap: 5px;">
<button onclick="saveTableSettings()" class="btn btn-primary">저장</button>
<button onclick="resetTableSettings()" class="btn btn-secondary">기본값</button>
</div>
</div>

<div class="table-container" style="max-height: calc(100vh - 300px); overflow-y: auto;">
</div>

<div id="table-update-time" style="display: none; text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
마지막 업데이트: --:--
</div>

</div>
</div>
<div class="panel">
<h2>후원내역</h2>
<div class="user-info" id="user-info">로컬 웹페이지 모드</div>
<div style="display: flex; gap: 5px; flex-wrap: wrap; align-items: center; margin-bottom:10px;">
<button onclick="loadData()" class="btn btn-success">🔄 새로고침</button>
<button onclick="deleteSelected()" class="btn btn-danger" id="delete-btn">🗑️ 선택삭제</button>
<label><input type="checkbox" id="auto-save-toggle" checked> 자동저장</label>
<label><input type="checkbox" id="auto-chat-notify" checked> 🤖 후원시 챗봇알림</label>
<span id="chatbot-permission-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
</div>
<div id="quick-add-form" style="display: flex; gap: 5px; margin-bottom: 15px; align-items: center;">
<div class="autocomplete-container"><input type="text" id="quick-donor" placeholder="후원자" class="form-input" autocomplete="off"><div id="quick-donor-autocomplete" class="donor-autocomplete"></div></div>
<select id="quick-streamer" class="form-select" style="flex: 2;"></select>
<input type="number" id="quick-amount" placeholder="금액(만)" class="form-input" style="flex: 1;" step="0.1">
<select id="quick-type" class="form-select" style="flex: 1;"><option value="계좌">계좌</option><option value="투네">투네</option><option value="슈퍼챗">슈퍼챗</option></select>
<button onclick="quickAddDonation()" id="quick-add-btn" class="btn btn-primary">추가</button>
</div>
<div id="status-container"></div>
<div class="table-container" style="max-height: calc(100vh - 280px); overflow-y: auto;">
<table class="table" id="data-table">
<thead><tr><th style="width: 40px;"><input type="checkbox" id="select-all"></th><th>#</th><th>후원자</th><th>스트리머</th><th>타입</th><th>금액(만)</th><th>시간</th></tr></thead>
<tbody id="data-table-body"></tbody>
</table>
</div>
</div>
</div>
<div id="reset-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display:flex; align-items:center; justify-content:center;">
<div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
<h3 style="margin:0 0 10px 0;">⚠️ 데이터 초기화</h3><p style="font-size:14px; margin-bottom:15px;">모든 후원 데이터가 삭제됩니다. 이 작업은 되돌릴 수 없습니다.</p>
<input type="password" id="reset-password" placeholder="비밀번호 입력" class="form-input"><div style="display: flex; gap: 10px; justify-content: flex-end; margin-top:20px;"><button onclick="closeResetDialog()" class="btn btn-secondary">취소</button><button onclick="confirmReset()" class="btn btn-danger">초기화</button></div>
</div>
</div>
<script>
// --- 전역 변수 ---
let streamers = ['엄삼용','손덕배','연기','주옥','불곰','이효팔','동동','남붕','옥긔','국고'];
let emojis = {'엄삼용': '🫅', '손덕배':'🌺', '연기': '🐧', '동동': '😎', '주옥': '👺', '불곰':'🎬', '이효팔': '🏝', '남붕': '🤠', '옥긔':'🦆', '국고':'🏦'};
let donations = [], missionData = {}, user = { email: 'local@user.com', isAdmin: false };
let currentData = { missions: [], runningMissions: [] };
let currentPassword = '2749'; // 관리자 전용 비밀번호
let isAdminVerified = false; // 관리자 인증 상태
let autoSaveEnabled = true, selectedRows = new Set(), todayDonors = new Set();
let activeAutocompleteIndex = -1;
let currentlyEditing = null;
let isBusy = false;
let autoRefreshInterval = null;

// 🔴 실시간 Socket.io 연결
let socket = null;
let isSocketConnected = false;

function initializeRealtimeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isSocketConnected = true;
            console.log('🔗 [관리자] 실시간 서버 연결됨');
            showStatus('🔴 실시간 서버 연결됨 - 공동작업 가능!', 'success');
            updateConnectionUI(true);
            
            // 연결 성공 시 즉시 데이터 요청
            console.log('📡 [관리자] 초기 데이터 요청 중...');
        });
        
        socket.on('disconnect', () => {
            isSocketConnected = false;
            console.log('❌ [관리자] 실시간 서버 연결 끊어짐');
            showStatus('⚠️ 실시간 연결 끊어짐 - 로컬 모드로 전환', 'warning');
            updateConnectionUI(false);
        });
        
        socket.on('initialData', (data) => {
            console.log('📊 [관리자] 초기 데이터 수신:', data);
            console.log('📊 [관리자] 수신된 후원 데이터:', data.donations?.length || 0, '건');
            donations = data.donations || [];
            streamers = data.streamers || streamers;
            emojis = data.emojis || emojis;
            currentData = data; // 전체 데이터 저장
            
            // 서버 설정을 UI에 적용
            if (data.settings) {
                console.log('⚙️ [관리자] 서버 설정 적용 중:', data.settings);
                applyServerSettingsToUI(data.settings);
            }
            
            updateAllUI();
            console.log('✅ [관리자] 초기 UI 업데이트 완료');
        });
        
        socket.on('dataUpdate', (data) => {
            console.log('🔄 [관리자] 실시간 데이터 업데이트 수신:', data);
            console.log('🔄 [관리자] 수신된 후원 데이터:', data.donations?.length || 0, '건');
            donations = data.donations || [];
            currentData = data; // 전체 데이터 저장 (미션 포함)
            
            // 설정도 함께 업데이트 (중복 이벤트 방지)
            if (data.settings) {
                applyServerSettingsToUI(data.settings);
            }
            
            updateAllUI();
            showStatus('✨ 새 후원 데이터 동기화!', 'success', 2000);
            
            // 선택된 행들 초기화 (삭제된 항목들이 포함될 수 있음)
            selectedRows.clear();
            
            // localStorage도 최신 데이터로 동기화 (로컬모드에서 데이터 부활 방지)
            saveToLocalStorage();
            
            console.log('✅ [관리자] 실시간 UI 업데이트 완료');
        });
        
        // settingsUpdate 이벤트는 dataUpdate에서 함께 처리하므로 제거
        
    } catch (error) {
        console.error('Socket.io 초기화 실패:', error);
        showStatus('❌ 실시간 연결 실패 - 로컬 모드로 동작', 'warning');
        updateConnectionUI(false);
    }
}

// 연결 상태 UI 업데이트
function updateConnectionUI(connected) {
    // 제목에 연결 상태 표시
    const title = document.querySelector('title');
    if (title) {
        if (connected) {
            title.textContent = '🔴 실시간 방송 후원 정산 시스템 (연결됨)';
        } else {
            title.textContent = '⚪ 방송 후원 정산 시스템 (로컬모드)';
        }
    }
    
    // 연결 상태 표시 요소가 있다면 업데이트
    const statusElements = document.querySelectorAll('[data-connection-status]');
    statusElements.forEach(el => {
        if (connected) {
            el.textContent = '🔴 실시간 연결';
            el.className = 'status-success';
        } else {
            el.textContent = '⚪ 로컬 모드';
            el.className = 'status-warning';
        }
    });
}

// YouTube API 관련 변수
let youtubeApiKey = '';
let liveChatId = '';

// 백업 API 키들 (할당량 초과시 자동 전환)
let backupApiKeys = [
    'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4', // 메인 YouTube API 키 (업데이트됨)
    'AIzaSyCTTBeP7zWHyuP5FuuQlOOity-2_hPjHmM'  // 백업 키
];
let currentKeyIndex = 0;

// Google Drive API 관련 변수
let isGoogleSignedIn = false;
let googleUser = null;
let autoBackupEnabled = false;
let autoBackupInterval = null;
let autoSendInterval = null;
let isAutoSending = false;

// --- 로컬 스토리지 키 ---
const STORAGE_KEYS = {
    DONATIONS: 'donation_data',
    STREAMERS: 'streamer_config',
    EMOJIS: 'streamer_emojis',  
    MISSIONS: 'mission_data',
    PASSWORD: 'admin_password',
    YOUTUBE_API_KEY: 'youtube_api_key',
    YOUTUBE_VIDEO_ID: 'youtube_video_id'
};

// --- 앱 시작 ---
document.addEventListener('DOMContentLoaded', initializeApp);

// 안전한 DOM 조작 헬퍼 함수들
function safeGetElement(id) {
    try {
        return document.getElementById(id);
    } catch (error) {
        console.error(`요소 ${id} 접근 실패:`, error);
        return null;
    }
}

function safeSetProperty(element, property, value) {
    try {
        if (element && element[property] !== undefined) {
            element[property] = value;
            return true;
        }
        return false;
    } catch (error) {
        console.error(`속성 ${property} 설정 실패:`, error);
        return false;
    }
}

function safeAddClass(element, className) {
    try {
        if (element && element.classList) {
            element.classList.add(className);
            return true;
        }
        return false;
    } catch (error) {
        console.error(`클래스 ${className} 추가 실패:`, error);
        return false;
    }
}

// --- 핵심 로직 (초기화 및 동기화 제어) ---
async function initializeApp() {
    const loader = safeGetElement('app-loader');
    
    try {
        console.log("안전한 초기화 시작...");
        
        // 각 초기화 단계를 안전하게 실행
        try { initEventListeners(); } catch (e) { console.error('이벤트 리스너 초기화 실패:', e); }
        try { loadFromLocalStorage(); } catch (e) { console.error('로컬 스토리지 로드 실패:', e); }
        try { loadYouTubeSettings(); } catch (e) { console.error('YouTube 설정 로드 실패:', e); }
        try { loadOverlaySettings(); } catch (e) { console.error('오버레이 설정 로드 실패:', e); }
        try { initializeOverlayControls(); } catch (e) { console.error('오버레이 컨트롤 초기화 실패:', e); }
        try { await loadTableSettings(); } catch (e) { console.error('테이블 설정 로드 실패:', e); }
        
        try { 
            await updateUserInfo(); 
        } catch (e) { 
            console.error('사용자 정보 업데이트 실패:', e);
        }
        
        // 🔴 실시간 Socket.io 연결 초기화
        try {
            initializeRealtimeConnection();
        } catch (e) {
            console.error('실시간 연결 초기화 실패:', e); 
        }
        
        try { updateAllUI(); } catch (e) { console.error('UI 업데이트 실패:', e); }
        try { updateAdminElements(); } catch (e) { console.error('관리자 요소 업데이트 실패:', e); }
        try { updateTabVisibility(); } catch (e) { console.error('탭 가시성 업데이트 실패:', e); }
        
        // 챗봇 자동 알림 설정 동기화
        try { initializeAutoNotifySync(); } catch (e) { console.error('자동 알림 설정 동기화 실패:', e); }
        
        // 조정 모드 기본값 설정 (안전하게)
        setTimeout(() => {
            try {
                switchSimpleMode('streamer');
            } catch (e) {
                console.error('조정 모드 설정 실패:', e);
            }
        }, 100);
        
        // 앱 컨테이너 로딩 완료 처리 (완전히 안전하게)
        setTimeout(() => {
            const appContainer = safeGetElement('app-container');
            if (appContainer) {
                safeAddClass(appContainer, 'loaded');
                console.log('앱 컨테이너 로딩 완료');
            } else {
                console.warn('app-container 요소를 찾을 수 없습니다 - 강제로 표시합니다');
                // 대체 방법: CSS를 직접 수정
                const style = document.createElement('style');
                style.textContent = '.container { display: grid !important; }';
                document.head.appendChild(style);
            }
            
            if (loader) {
                safeSetProperty(loader.style, 'display', 'none');
            }
        }, 200);
        
        console.log("Application loaded successfully.");
        
        // Google API 초기화 (안전하게)
        setTimeout(() => {
            try {
                initGoogleAPI();
            } catch (e) {
                console.error('Google API 초기화 실패:', e);
            }
        }, 300);
        
    } catch (error) {
        console.error("Critical initialization error:", error);
        
        // 오류 발생 시 안전 모드 활성화
        try {
            if (loader) {
                const spinner = loader.querySelector('.spinner');
                const message = loader.querySelector('p');
                
                if (spinner) spinner.style.display = 'none';
                if (message) message.textContent = `앱 로딩 실패: ${error.message} - 안전 모드로 계속...`;
            }
            
            // 강제로 앱 표시
            setTimeout(() => {
                const style = document.createElement('style');
                style.textContent = `
                    #app-loader { display: none !important; }
                    .container { display: grid !important; }
                `;
                document.head.appendChild(style);
                console.log('안전 모드로 앱을 강제 표시했습니다');
            }, 1000);
            
        } catch (fallbackError) {
            console.error("Even fallback failed:", fallbackError);
        }
    }
}

// --- 로컬 스토리지 관리 ---
function saveToLocalStorage() {
    try {
        localStorage.setItem(STORAGE_KEYS.DONATIONS, JSON.stringify(donations));
        localStorage.setItem(STORAGE_KEYS.STREAMERS, JSON.stringify(streamers));
        localStorage.setItem(STORAGE_KEYS.EMOJIS, JSON.stringify(emojis));
        localStorage.setItem(STORAGE_KEYS.MISSIONS, JSON.stringify(missionData));
        localStorage.setItem(STORAGE_KEYS.PASSWORD, currentPassword);
    } catch (error) {
        console.error('로컬 스토리지 저장 실패:', error);
    }
}

function loadFromLocalStorage() {
    try {
        const savedDonations = localStorage.getItem(STORAGE_KEYS.DONATIONS);
        const savedStreamers = localStorage.getItem(STORAGE_KEYS.STREAMERS);
        const savedEmojis = localStorage.getItem(STORAGE_KEYS.EMOJIS);
        const savedMissions = localStorage.getItem(STORAGE_KEYS.MISSIONS);
        const savedPassword = localStorage.getItem(STORAGE_KEYS.PASSWORD);

        if (savedDonations) {
            donations = JSON.parse(savedDonations).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
        }
        if (savedStreamers) streamers = JSON.parse(savedStreamers);
        if (savedEmojis) emojis = JSON.parse(savedEmojis);
        if (savedMissions) missionData = JSON.parse(savedMissions);
        if (savedPassword) currentPassword = savedPassword;

        // 후원자 목록 재구성
        todayDonors = new Set(donations.map(d => d.donor));
    } catch (error) {
        console.error('로컬 스토리지 로드 실패:', error);
    }
}

async function performSafeWrite(actionDescription, writeFunction) {
    if (isBusy) {
        showStatus('이전 작업이 아직 처리 중입니다.', 'warning');
        return;
    }
    
    isBusy = true;
    showSaveStatus(actionDescription, 'saving');

    try {
        const result = await writeFunction();
        saveToLocalStorage();
        showSaveStatus('완료', 'saved');
        return result;
    } catch (error) {
        showSaveStatus('실패', 'error');
        showStatus(error.message, 'error');
        throw error;
    } finally {
        isBusy = false;
        updateAllUI();
    }
}

// --- 데이터 로드 및 처리 ---
async function loadData(isSilent = false) {
    loadFromLocalStorage();
    donations.sort((a, b) => b.time - a.time);
    updateAllUI();
    if (!isSilent) {
        showSaveStatus('로딩 완료', 'saved');
    }
}

function addDonation() {
    const donor = document.getElementById('donor-input').value.trim();
    if (!donor) return showStatus('후원자명을 입력하세요', 'error');
    const inputs = document.querySelectorAll('#streamer-inputs input[type="number"]');
    const newDons = [];
    inputs.forEach(input => {
        const amount = parseFloat(input.value);
        if (!isNaN(amount) && amount > 0) {
            const streamerName = input.dataset.streamer;
            newDons.push({ donor, streamer: streamerName, type: document.querySelector('input[name="paytype"]:checked').value, amount, time: new Date() });
        }
    });
    if (newDons.length > 0) {
        document.getElementById('donor-input').value = '';
        inputs.forEach(input => input.value = '');
        handleNewDonations(newDons);
    } else {
        showStatus('금액을 입력하세요', 'error');
    }
}

// 조정 모드 전환
function switchSimpleMode(mode) {
    const streamerPanel = document.getElementById('streamer-mode-panel');
    const donorPanel = document.getElementById('donor-mode-panel');
    const streamerBtn = document.getElementById('streamer-mode-btn');
    const donorBtn = document.getElementById('donor-mode-btn');
    
    if (mode === 'streamer') {
        streamerPanel.style.display = 'block';
        donorPanel.style.display = 'none';
        streamerBtn.classList.remove('btn-secondary');
        streamerBtn.classList.add('btn-primary');
        donorBtn.classList.remove('btn-primary');
        donorBtn.classList.add('btn-secondary');
        updateStreamerModeSelect();
        
        // 스트리머별 조정 모드: 스트리머 요약만 보이기
        updateSummaryVisibility('streamer');
        
    } else if (mode === 'donor') {
        streamerPanel.style.display = 'none';
        donorPanel.style.display = 'block';
        donorBtn.classList.remove('btn-secondary');
        donorBtn.classList.add('btn-primary');
        streamerBtn.classList.remove('btn-primary');
        streamerBtn.classList.add('btn-secondary');
        
        // 후원자별 조정 모드: 후원자 요약만 보이기
        updateSummaryVisibility('donor');
    }
}

// 요약 영역 표시/숨김
function updateSummaryVisibility(mode) {
    // 간단 모드 전용일 때만 적용
    const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
    const isAdmin = isAdminVerified;
    
    // 간단 모드가 아니거나 관리자인 경우 모든 요약 보이기
    if (!isSimpleModeOnly || isAdmin) {
        showAllSummaries();
        return;
    }
    
    // 요약 섹션들
    const streamerSummary = document.querySelector('#basic-summary > div:nth-child(1)'); // 스트리머 총액
    const donorSummary = document.querySelector('#basic-summary > div:nth-child(2)'); // 후원자별 총액
    const recentSummary = document.querySelector('#basic-summary > div:nth-child(3)'); // 최근 입금 내역
    
    if (mode === 'streamer') {
        // 스트리머별 조정: 스트리머 요약만 보이기
        if (streamerSummary) streamerSummary.style.display = 'block';
        if (donorSummary) donorSummary.style.display = 'none';
        if (recentSummary) recentSummary.style.display = 'none';
    } else if (mode === 'donor') {
        // 후원자별 조정: 후원자 요약만 보이기
        if (streamerSummary) streamerSummary.style.display = 'none';
        if (donorSummary) donorSummary.style.display = 'block';
        if (recentSummary) recentSummary.style.display = 'none';
    }
}

// 모든 요약 보이기 (관리자 모드)
function showAllSummaries() {
    const streamerSummary = document.querySelector('#basic-summary > div:nth-child(1)');
    const donorSummary = document.querySelector('#basic-summary > div:nth-child(2)');
    const recentSummary = document.querySelector('#basic-summary > div:nth-child(3)');
    
    if (streamerSummary) streamerSummary.style.display = 'block';
    if (donorSummary) donorSummary.style.display = 'block';
    if (recentSummary) recentSummary.style.display = 'block';
}

// 스트리머별 금액 조정
function adjustStreamerAmount() {
    const streamer = document.getElementById('streamer-mode-select').value;
    const amount = parseFloat(document.getElementById('streamer-amount-input').value);
    const type = document.querySelector('input[name="streamer-paytype"]:checked').value;
    
    if (!streamer) return showStatus('스트리머를 선택하세요', 'error');
    if (!amount || amount === 0) return showStatus('조정할 금액을 입력하세요', 'error');
    
    const adjustmentDonation = {
        donor: `조정(${amount > 0 ? '+' : ''}${amount})`,
        streamer,
        type,
        amount,
        time: new Date()
    };
    
    // 입력 필드 초기화
    document.getElementById('streamer-amount-input').value = '';
    
    handleNewDonations([adjustmentDonation]);
    updateSimpleRecentList();
    showStatus(`${streamer} ${amount > 0 ? '+' : ''}${amount}만원 조정되었습니다`, 'success');
}

// 후원자별 금액 조정
function adjustDonorAmount() {
    const donor = document.getElementById('donor-mode-input').value.trim();
    const amount = parseFloat(document.getElementById('donor-amount-input').value);
    const type = document.querySelector('input[name="donor-paytype"]:checked').value;
    
    if (!donor) return showStatus('후원자명을 입력하세요', 'error');
    if (!amount || amount === 0) return showStatus('조정할 금액을 입력하세요', 'error');
    
    // 후원자별 조정은 가상 스트리머에 배정 (스트리머 총액에 영향 안줌)
    const adjustmentDonation = {
        donor: `${donor}(조정${amount > 0 ? '+' : ''}${amount})`,
        streamer: '후원자조정', // 가상 스트리머
        type,
        amount,
        time: new Date()
    };
    
    // 입력 필드 초기화
    document.getElementById('donor-mode-input').value = '';
    document.getElementById('donor-amount-input').value = '';
    
    handleNewDonations([adjustmentDonation]);
    updateSimpleRecentList();
    showStatus(`${donor}님 ${amount > 0 ? '+' : ''}${amount}만원 조정되었습니다`, 'success');
}

// 기본 스트리머 찾기 (가장 최근에 사용된 스트리머 또는 첫 번째)
function getDefaultStreamer() {
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s) && s !== '국고');
    
    if (visibleStreamers.length === 0) return '국고';
    
    // 최근 후원에서 가장 많이 사용된 스트리머 찾기
    if (donations && donations.length > 0) {
        const recentDonations = donations.slice(-20); // 최근 20개
        const streamerCounts = {};
        
        recentDonations.forEach(d => {
            if (visibleStreamers.includes(d.streamer)) {
                streamerCounts[d.streamer] = (streamerCounts[d.streamer] || 0) + 1;
            }
        });
        
        const mostUsed = Object.keys(streamerCounts).reduce((a, b) => 
            streamerCounts[a] > streamerCounts[b] ? a : b, visibleStreamers[0]);
        
        return mostUsed;
    }
    
    return visibleStreamers[0];
}

function quickAddDonation() {
    const d = document.getElementById('quick-donor'), s = document.getElementById('quick-streamer'), a = document.getElementById('quick-amount'), t = document.getElementById('quick-type');
    const donor = d.value.trim();
    const amount = parseFloat(a.value);
    if (!donor || isNaN(amount) || amount <= 0) return showStatus('후원자명과 금액(만)을 올바르게 입력하세요.', 'error');
    handleNewDonations([{ donor, streamer: s.value, type: t.value, amount, time: new Date() }]);
    a.value = '';
    d.focus();
    d.select();
}

async function handleNewDonations(newDonations) {
    if (!newDonations || newDonations.length === 0) return;

    donations.unshift(...newDonations);
    donations.sort((a, b) => b.time - a.time);
    newDonations.forEach(d => todayDonors.add(d.donor));
    
    // 🔴 즉시 로컬 화면 업데이트 (반응성 향상)
    updateAllUI();
    
    // 🔴 실시간 서버로 데이터 전송
    if (isSocketConnected && socket) {
        try {
            for (const donation of newDonations) {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        donor: donation.donor,
                        streamer: donation.streamer,
                        type: donation.type,
                        amount: donation.amount
                    })
                });
                
                if (response.ok) {
                    console.log('✅ [관리자] 실시간 서버로 후원 전송 성공:', donation);
                    console.log('📡 [관리자] 서버 응답 상태:', response.status);
                } else {
                    console.error('❌ [관리자] 실시간 서버 전송 실패:', response.statusText);
                    console.error('📡 [관리자] 서버 응답 상태:', response.status);
                    // 실시간 전송 실패해도 로컬은 업데이트됨
                }
            }
            showSaveStatus('🔴 실시간 동기화 완료', 'saved');
        } catch (error) {
            console.error('실시간 전송 오류:', error);
            showSaveStatus('⚠️ 실시간 전송 실패 (로컬 저장됨)', 'warning');
            // 실시간 실패해도 로컬 작업은 계속
        }
    } else {
        console.log('⚠️ 실시간 연결 없음, 로컬 모드로 동작');
        showSaveStatus('💾 로컬 모드로 저장', 'warning');
    }
    
    // 로컬 저장 (백업용)
    if (autoSaveEnabled) {
        saveToLocalStorage();
    }
    
    // 🤖 후원시 챗봇 자동 알림
    if (document.getElementById('auto-chat-notify') && document.getElementById('auto-chat-notify').checked) {
        sendDonationNotification(newDonations);
    }
}

async function deleteSelected() {
    if (selectedRows.size === 0 || !confirm(`${selectedRows.size}개 항목을 삭제하시겠습니까?`)) return;
    
    const indicesToDelete = Array.from(selectedRows).sort((a, b) => b - a);
    let deleteCount = 0;
    
    // 서버에서 삭제 시도
    for (const index of indicesToDelete) {
        const donation = donations[index];
        console.log('삭제 시도하는 후원:', donation);
        
        if (donation && donation.time) {
            try {
                if (isSocketConnected) {
                    // 서버에 삭제 요청
                    console.log(`서버 삭제 API 호출: /api/donations/${donation.time}`);
                    const response = await fetch(`/api/donations/${donation.time}`, {
                        method: 'DELETE'
                    });
                    
                    console.log('서버 응답 상태:', response.status, response.statusText);
                    
                    if (response.ok) {
                        deleteCount++;
                        console.log('✅ 서버에서 후원 삭제 성공:', donation.donor);
                        // 서버 삭제 성공 시에는 dataUpdate 이벤트로 UI가 자동 업데이트됨
                    } else {
                        console.error('❌ 서버 삭제 실패:', donation.donor);
                        // 서버 삭제 실패 시에만 로컬에서 삭제
                        donations.splice(index, 1);
                        deleteCount++;
                    }
                } else {
                    // 연결 없으면 로컬에서만 삭제
                    donations.splice(index, 1);
                    deleteCount++;
                }
            } catch (error) {
                console.error('삭제 중 오류:', error);
                // 오류 시 로컬에서라도 삭제
                donations.splice(index, 1);
                deleteCount++;
            }
        }
    }
    
    selectedRows.clear();
    
    // 서버 연결이 없거나 실패한 경우에만 로컬 저장
    if (!isSocketConnected) {
        saveToLocalStorage();
        updateAllUI();
    }
    
    showStatus(`${deleteCount}개 항목이 삭제되었습니다`, 'success');
}

// --- 서버 동기화 함수 ---
async function syncToServer() {
    if (!isSocketConnected) {
        console.log('⚠️ 서버 연결 없음, 동기화 생략');
        return;
    }
    
    try {
        console.log('🔄 서버 동기화 시작...');
        const response = await fetch('/api/donations/bulk', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ donations })
        });
        
        if (response.ok) {
            console.log('✅ 서버 동기화 성공');
        } else {
            console.error('❌ 서버 동기화 실패:', response.status);
        }
    } catch (error) {
        console.error('❌ 서버 동기화 오류:', error);
    }
}

// --- UI 업데이트 함수 ---
function updateAllUI() {
    updateStreamerInputs();
    updateStreamerList();
    updateMissionSettingsUI();
    updateRunningMissionsList();
    updateMissionSummary();
    updateTable();
    updateSummary();
    updateQuickAddForm();
    updateSimpleMode();
}

// 간단 모드 UI 업데이트
function updateSimpleMode() {
    updateStreamerModeSelect();
    updateSimpleRecentList();
}

function updateStreamerModeSelect() {
    const select = document.getElementById('streamer-mode-select');
    if (select) {
        const currentVal = select.value;
        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s));
        
        select.innerHTML = '<option value="">스트리머 선택</option>' + 
            visibleStreamers.map(str => `<option value="${str}">${emojis[str] || ''}${str}</option>`).join('');
        
        if (visibleStreamers.includes(currentVal)) {
            select.value = currentVal;
        }
    }
}

function updateSimpleRecentList() {
    const listContainer = document.getElementById('simple-recent-list');
    if (!listContainer) return;
    
    if (!donations || donations.length === 0) {
        listContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">등록된 후원이 없습니다</div>';
        return;
    }
    
    // 최근 10개만 표시
    const recentDonations = donations.slice(-10).reverse();
    const listHtml = recentDonations.map(d => {
        const timeStr = new Date(d.time).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        const emoji = emojis[d.streamer] || '';
        return `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">
            <span style="font-weight: bold;">${d.donor}</span> →
            <span style="color: #666;">${emoji}${d.streamer}</span>
            <span style="color: #e74c3c; font-weight: bold;">${d.amount}만</span>
            <span style="color: #999; font-size: 11px;">(${d.type}, ${timeStr})</span>
        </div>`;
    }).join('');
    
    listContainer.innerHTML = listHtml;
}

function updateTable() {
    const tableBody = document.getElementById('data-table-body');
    if (!tableBody) return;
    
    selectedRows.clear();
    const selectAllCheckbox = document.getElementById('select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    tableBody.innerHTML = (donations || []).map((d, i) => `
    <tr data-index="${i}">
        <td><input type="checkbox" onchange="toggleRowSelection(${i}, this.checked)"></td>
        <td>${donations.length - i}</td>
        <td data-field="donor" ondblclick="makeCellEditable(this, ${i})">${d.donor}</td>
        <td data-field="streamer" ondblclick="makeCellEditable(this, ${i})">${emojis[d.streamer] || ''}${d.streamer}</td>
        <td data-field="type" ondblclick="makeCellEditable(this, ${i})">${d.type}</td>
        <td data-field="amount" ondblclick="makeCellEditable(this, ${i})">${parseFloat(d.amount)}</td>
        <td data-field="time">${d.time ? new Date(d.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</td>
    </tr>`).join('') || `<tr><td colspan="7">데이터 없음</td></tr>`;
}

function updateSummary() {
    let streamerTotals = {}, totalAmount = 0;
    (streamers || []).forEach(s => streamerTotals[s] = 0);
    if (!streamerTotals.hasOwnProperty('국고')) {
        streamerTotals['국고'] = 0;
    }

    let donorAccountTotals = {}; 

    donations.forEach(d => {
        const amount = parseFloat(d.amount) || 0;
        
        // 퇴근미션 조정은 총액 계산에서 제외 (excludeFromTotal 플래그 확인)
        if (d.excludeFromTotal || d.isMissionAdjustment) {
            return;
        }
        
        if (streamerTotals.hasOwnProperty(d.streamer)) {
            streamerTotals[d.streamer] += amount;
        } else {
            streamerTotals['국고'] = (streamerTotals['국고'] || 0) + amount;
        }
        totalAmount += amount;

        // 슈퍼챗 포함 옵션 확인
        const includeSuperchat = document.getElementById('include-superchat').checked;
        const shouldInclude = d.type === '계좌' || (includeSuperchat && d.type === '슈퍼챗');
        
        if (shouldInclude) {
            // 스트리머별 조정은 제외, 후원자별 조정은 포함
            if (d.donor.includes('조정(') && d.streamer !== '후원자조정') {
                // 스트리머별 조정 → 제외
                return;
            }
            
            // 후원자명에서 (조정+금액) 부분 제거
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(조정')) {
                cleanDonorName = cleanDonorName.replace(/\(조정[^)]*\)/g, '');
            }
            
            // 계좌후원자님은 그대로 표시 (특별 처리)
            if (cleanDonorName === '계좌후원자님' || cleanDonorName === '계좌후원자') {
                cleanDonorName = '계좌후원자님';
            }
            
            donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
        }
    });

    // 스트리머 총액 설정 로드
    const headerText = localStorage.getItem('streamer-summary-header') || '🔥🏫삼용스쿨🏫🔥';
    const footerText = localStorage.getItem('streamer-summary-footer') || '🏧투네/계좌 [8:2] 🎉슈퍼챗은 국고로~!';
    const excludeGukgoValue = localStorage.getItem('exclude-gukgo');
    const excludeGukgo = excludeGukgoValue === null ? false : excludeGukgoValue === 'true'; // 기본값: false (국고 포함)
    console.log('🔍 excludeGukgo 디버그:', { excludeGukgoValue, excludeGukgo }); // 디버깅용
    
    // 상세 테이블과 동일한 로직으로 스트리머 데이터 계산 (국고 포함)
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const summaryStreamers = (streamers || []).filter(s => s !== '후원자조정' && !hiddenStreamers.includes(s));
    const streamerDetailData = {};
    summaryStreamers.forEach(s => { streamerDetailData[s] = { name: s, account: 0, toonation: 0, total: 0 }; });
    donations.forEach(d => {
        if (streamerDetailData.hasOwnProperty(d.streamer)) {
            const amount = parseFloat(d.amount) || 0;
            if (d.type === '계좌') streamerDetailData[d.streamer].account += amount;
            else if (d.type === '투네') streamerDetailData[d.streamer].toonation += amount;
            else if (d.type === '슈퍼챗' && d.streamer === '국고') streamerDetailData[d.streamer].account += amount; // 슈퍼챗은 국고로
        }
    });
    
    // 총액 계산 후 정렬 (국고 제외하고 정렬)
    let sortedDetailStreamers = Object.values(streamerDetailData).filter(data => data.name !== '국고').map(data => { 
        data.total = data.account + data.toonation; 
        return data; 
    }).sort((a, b) => b.total - a.total);
    
    // 엄삼용 우선 배치 (있는 경우)
    if (sortedDetailStreamers.find(s => s.name === '엄삼용')) {
        const samyongData = sortedDetailStreamers.find(s => s.name === '엄삼용');
        sortedDetailStreamers = sortedDetailStreamers.filter(s => s.name !== '엄삼용');
        sortedDetailStreamers.unshift(samyongData);
    }
    
    const samyongSchool = sortedDetailStreamers.map(s => `${emojis[s.name] || ''}${s.name}(${s.total})`).join(' ');
    
    // 국고 데이터 계산
    const gukgoData = streamerDetailData['국고'] || { account: 0, toonation: 0, total: 0 };
    gukgoData.total = gukgoData.account + gukgoData.toonation;
    console.log('🔍 국고 데이터 디버그:', { gukgoData, streamerDetailData: Object.keys(streamerDetailData) }); // 디버깅용
    
    // 총합 계산 (국고 제외 옵션에 따라)
    const streamerOnlyTotal = sortedDetailStreamers.reduce((sum, s) => sum + s.total, 0);
    const displayTotalAmount = excludeGukgo ? streamerOnlyTotal : streamerOnlyTotal + gukgoData.total;
    
    // 퇴근 미션 성공 결과 텍스트 생성
    let missionResultText = '';
    const runningMissions = (currentData && currentData.missions) ? 
        currentData.missions.filter(m => m.status === 'running' || m.status === 'completed') : 
        Object.values(missionData).filter(m => streamers.includes(m.streamer) && (m.status === 'running' || m.status === 'success'));
    
    if (runningMissions.length > 0) {
        const missionWithInfo = runningMissions.map(mission => {
            const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
            
            // 퇴근미션 조정 금액도 포함 (미션 시작 시간 이후의 조정만)
            const missionAdjustments = (window.currentData?.missionAdjustments || []).filter(adj => 
                adj.streamer === mission.streamer && new Date(adj.time) >= new Date(mission.startTime)
            );
            const adjustmentAmount = missionAdjustments.reduce((sum, adj) => sum + (parseFloat(adj.amount) || 0), 0);
            
            const donationAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
            const currentAmount = donationAmount + adjustmentAmount;
            const remaining = (parseFloat(mission.target) || 0) - currentAmount;
            
            if (remaining <= 0 && mission.status === 'running') { 
                mission.status = 'success'; 
                mission.completedTime = Date.now(); 
            }
            
            return {
                ...mission,
                currentAmount,
                remaining,
                isSuccess: mission.status === 'success' || remaining <= 0
            };
        });
        
        const successMissions = missionWithInfo.filter(m => m.isSuccess);
        if (successMissions.length > 0) {
            const successTexts = successMissions.map(m => `${emojis[m.streamer] || ''}${m.streamer}(성공!)`);
            missionResultText = ` 🎄퇴근미션🎄 ${successTexts.join(' ')}`;
        }
    }
    
    // 출력 형식 (국고 포함 여부에 따른 출력)
    let summaryText = `${headerText} ${samyongSchool}`;
    
    // 국고 표시 (excludeGukgo가 false일 때 항상 표시, 0원이어도)
    if (!excludeGukgo) {
        summaryText += ` 🏦국고(${gukgoData.total})`;
    }
    
    summaryText += ` 💵총합(${displayTotalAmount}) ${footerText}${missionResultText}`;
    
    document.getElementById('summary-output').textContent = summaryText;
    
    const groupThreshold = parseInt(document.getElementById('group-threshold').value, 10) || 2;
    const includeSuperchat = document.getElementById('include-superchat').checked;
    
    // 설정을 localStorage에 저장 (오버레이에서 사용)
    localStorage.setItem('group-threshold', groupThreshold.toString());
    localStorage.setItem('include-superchat', includeSuperchat.toString());
    
    // 서버에도 그룹화 임계값 저장 (서버 설정 적용 중이 아닐 때만)
    if (!isApplyingServerSettings) {
        try {
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    settings: { 
                        groupThreshold: groupThreshold,
                        includeSuperchat: includeSuperchat
                    }
                })
            }).catch(error => console.log('설정 서버 저장 실패:', error));
        } catch (error) {
            console.log('그룹화 설정 서버 저장 실패:', error);
        }
    }
    const amountGroups = {};
    for (const donor in donorAccountTotals) {
        const amount = donorAccountTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    // 소액 필터링 (0.1만원 미만 제외)
    const filteredGroups = Object.entries(amountGroups).filter(([amount]) => parseFloat(amount) >= 0.1);
    const sortedGroups = filteredGroups.sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    const donorTotalText = sortedGroups.flatMap(([amount, donors]) => {
        const amountStr = `${parseFloat(amount)}만`;
        if (donors.length >= groupThreshold) {
            return [`${donors.map(d => d + '님').join(', ')} ${amountStr}`];
        } else {
            return donors.map(d => `${d}님 ${amountStr}`);
        }
    }).join('\n');
    
    // "사랑해요♡" 인사말과 함께 표시
    const finalText = donorTotalText ? `사랑해요♡\n${donorTotalText}` : '사랑해요♡\n후원자가 없습니다';
    document.getElementById('donor-total').textContent = finalText;

    const minutes = parseInt(document.getElementById('recent-minutes').value, 10);
    const recentDonations = (donations || []).filter(d => (Date.now() - new Date(d.time).getTime()) < minutes * 60 * 1000);
    const groupedDonations = recentDonations.reduce((acc, d) => {
        const key = `${d.donor}-${new Date(d.time).getTime()}`;
        if (!acc[key]) { acc[key] = { donor: d.donor, donations: [], time: d.time }; }
        acc[key].donations.push(d); return acc;
    }, {});
    document.getElementById('recent-log').textContent = Object.values(groupedDonations).sort((a,b) => b.time - a.time).map(group => {
        const donationTexts = group.donations.map(d => {
            const totalForStreamer = parseFloat(streamerTotals[d.streamer] || 0);
            return `${emojis[d.streamer] || ''}${d.streamer} (+${parseFloat(d.amount)}/${totalForStreamer})`;
        }).join(', ');
        return `${group.donor} > ${donationTexts}`;
    }).join('\n');

    updateMissionSummary();
    updateDetailedSummaryTable();
}

function updateStreamerInputs() {
    const container = document.getElementById('streamer-inputs');
    if(container) container.innerHTML = (streamers || []).map((s) => {
      return `<div><label>${emojis[s] || ''}${s}</label><input type="number" min="0" step="0.1" data-streamer="${s}" placeholder="0" class="form-input"></div>`;
    }).join('');
}

function updateStreamerList() {
    const container = document.getElementById('streamer-list');
    if(container) {
        if (!streamers || streamers.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                    <p style="margin: 0; font-size: 16px;">등록된 스트리머가 없습니다</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">위에서 새 스트리머를 추가해주세요</p>
                </div>
            `;
            return;
        }

        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        container.innerHTML = (streamers || []).map((s, index) => {
            const isHidden = hiddenStreamers.includes(s);
            const emoji = emojis[s] || '👤';
            return `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #e9ecef; ${isHidden ? 'opacity: 0.5;' : ''}" ${isHidden ? 'title="임시 숨김 상태"' : ''}>
                    <div style="display: flex; align-items: center; flex-grow: 1;">
                        <div style="display: flex; align-items: center; margin-right: 15px;">
                            <input type="checkbox" onchange="toggleStreamerVisibility('${s}')" ${isHidden ? '' : 'checked'} 
                                   style="margin-right: 10px; transform: scale(1.2);">
                            <span style="background: #f8f9fa; border-radius: 20px; padding: 2px 8px; font-size: 12px; color: #495057;">
                                ${index + 1}
                            </span>
                        </div>
                        <div>
                            <span style="font-size: 24px; margin-right: 8px;">${emoji}</span>
                            <span style="font-size: 16px; font-weight: 500;">${s}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="editStreamer('${s}')" class="btn btn-secondary" 
                                style="font-size: 12px; padding: 4px 8px; background: #6c757d;">
                            ✏️ 수정
                        </button>
                        <button onclick="deleteStreamer('${s}')" class="btn btn-danger" 
                                style="font-size: 12px; padding: 4px 8px;">
                            🗑️ 삭제
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function toggleStreamerVisibility(streamerName) {
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const index = hiddenStreamers.indexOf(streamerName);
    
    if (index > -1) {
        // 현재 숨김 상태 → 보이기
        hiddenStreamers.splice(index, 1);
        showStatus(`${streamerName}이(가) 다시 표시됩니다`, 'info');
    } else {
        // 현재 보임 상태 → 숨기기
        hiddenStreamers.push(streamerName);
        showStatus(`${streamerName}이(가) 임시로 숨겨집니다`, 'warning');
    }
    
    localStorage.setItem('hidden-streamers', JSON.stringify(hiddenStreamers));
    updateStreamerList();
    updateAllUI(); // 모든 UI 업데이트
}

function updateQuickAddForm() {
    const select = document.getElementById('quick-streamer');
    if (select) {
        const currentVal = select.value;
        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s));
        select.innerHTML = visibleStreamers.map(str => `<option value="${str}">${emojis[str] || ''}${str}</option>`).join('');
        if (visibleStreamers.includes(currentVal)) { select.value = currentVal; }
    }
}

function updateDetailedSummaryTable() {
    const tableContainer = document.querySelector('#table-summary .table-container');
    if (!tableContainer) return;
    
    // 설정 로드
    const showTotalRow = localStorage.getItem('show-total-row') !== 'false'; // 기본값: true
    const showUpdateTime = localStorage.getItem('show-update-time') === 'true'; // 기본값: false
    const tableTitle = localStorage.getItem('table-title') || '🏆 스트리머별 후원 현황 🏆';
    
    // 테이블 제목 업데이트
    document.getElementById('table-title-display').textContent = tableTitle;
    
    // 업데이트 시간 표시/숨기기
    const updateTimeEl = document.getElementById('table-update-time');
    if (showUpdateTime && updateTimeEl) {
        updateTimeEl.style.display = 'block';
        updateTimeEl.textContent = `마지막 업데이트: ${new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}`;
    } else if (updateTimeEl) {
        updateTimeEl.style.display = 'none';
    }
    
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const summaryStreamers = (streamers || []).filter(s => s !== '국고' && s !== '후원자조정' && !hiddenStreamers.includes(s));
    const streamerData = {};
    summaryStreamers.forEach(s => { streamerData[s] = { name: s, account: 0, toonation: 0, total: 0, missionStatus: '없음' }; });
    donations.forEach(d => {
        if (streamerData.hasOwnProperty(d.streamer)) {
            const amountInWon = (parseFloat(d.amount) || 0) * 10000; // 만원 → 원 변환
            if (d.type === '계좌') streamerData[d.streamer].account += amountInWon;
            else if (d.type === '투네') streamerData[d.streamer].toonation += amountInWon;
        }
    });
    
    // 퇴근미션 상태 계산
    const runningMissions = (currentData && currentData.missions) ? 
        currentData.missions.filter(m => m.status === 'running' || m.status === 'completed') : 
        Object.values(missionData).filter(m => streamers.includes(m.streamer) && (m.status === 'running' || m.status === 'success'));
        
    runningMissions.forEach(mission => {
        if (streamerData[mission.streamer]) {
            const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
            const missionAdjustments = (window.currentData?.missionAdjustments || []).filter(adj => 
                adj.streamer === mission.streamer && new Date(adj.time) >= new Date(mission.startTime)
            );
            const adjustmentAmount = missionAdjustments.reduce((sum, adj) => sum + (parseFloat(adj.amount) || 0), 0);
            const donationAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
            const currentAmount = donationAmount + adjustmentAmount;
            const target = parseFloat(mission.target) || 0;
            const remaining = target - currentAmount;
            
            if (mission.status === 'success' || remaining <= 0) {
                streamerData[mission.streamer].missionStatus = `✅완료(${currentAmount}/${target})`;
            } else {
                streamerData[mission.streamer].missionStatus = `🎯진행중(${currentAmount}/${target})`;
            }
        }
    });
    
    let sortedStreamers = Object.values(streamerData).map(data => { data.total = data.account + data.toonation; return data; }).sort((a, b) => b.total - a.total);
    
    // 커스텀 순번명 적용
    function getRankName(index) {
        const rankCount = parseInt(localStorage.getItem('rank-count') || '10');
        const rankNumber = index + 1;
        
        // 설정된 순번명이 있는지 확인
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            return customRankName.trim();
        }
        
        // 설정되지 않은 경우 숫자로 표시
        return rankNumber.toString();
    }
    
    const headerHtml = `<tr><th>순위</th><th>스트리머</th><th>계좌후원</th><th>투네후원</th><th>총 후원</th><th>퇴근미션</th></tr>`;
    const bodyHtml = sortedStreamers.map((data, index) => { 
        const rankName = getRankName(index);
        return `<tr><td>${rankName}</td><td>${emojis[data.name] || ''} ${data.name}</td><td>${data.account.toLocaleString('ko-KR')}</td><td>${data.toonation.toLocaleString('ko-KR')}</td><td>${data.total.toLocaleString('ko-KR')}</td><td style="font-size: 12px;">${data.missionStatus}</td></tr>`; 
    }).join('');
    
    // 총합계 행 추가 (옵션에 따라)
    let totalRowHtml = '';
    if (showTotalRow) {
        const totalAccount = sortedStreamers.reduce((sum, s) => sum + s.account, 0);
        const totalToonation = sortedStreamers.reduce((sum, s) => sum + s.toonation, 0);
        const grandTotal = totalAccount + totalToonation;
        const completedMissions = runningMissions.filter(m => m.status === 'success' || 
            (streamerData[m.streamer] && streamerData[m.streamer].missionStatus.includes('✅'))).length;
        const totalMissions = runningMissions.length;
        const missionSummary = totalMissions > 0 ? `${completedMissions}/${totalMissions}완료` : '없음';
        
        totalRowHtml = `<tr class="total-row" style="background: rgba(64,64,64,0.6); border-top: 2px solid rgba(255,255,255,0.3); font-weight: bold;">
            <td colspan="2"><strong>🏆 총 합계</strong></td>
            <td><strong>${totalAccount.toLocaleString('ko-KR')}</strong></td>
            <td><strong>${totalToonation.toLocaleString('ko-KR')}</strong></td>
            <td><strong>${grandTotal.toLocaleString('ko-KR')}</strong></td>
            <td style="font-size: 11px;"><strong>${missionSummary}</strong></td>
        </tr>`;
    }
    
    const finalBodyHtml = bodyHtml.trim() === '' ? 
        `<tr><td colspan="6">계좌/투네 후원 내역이 없습니다.</td></tr>` : 
        bodyHtml + totalRowHtml;
    
    tableContainer.innerHTML = `<p style="font-size: 13px; color: #606770; margin-bottom: 10px;">※ 슈퍼챗(국고)을 제외한 후원 내역입니다.</p><table class="table"><thead>${headerHtml}</thead><tbody>${finalBodyHtml}</tbody></table>`;
}

function updateMissionSettingsUI() { 
    // 스트리머 선택 드롭다운 업데이트 (미션 생성용)
    const missionStreamerSelect = document.getElementById('mission-streamer');
    if (missionStreamerSelect) {
        const currentValue = missionStreamerSelect.value;
        missionStreamerSelect.innerHTML = '<option value="">선택하세요</option>' + 
            streamers.map(streamer => 
                `<option value="${streamer}">${emojis[streamer] || ''}${streamer}</option>`
            ).join('');
        if (streamers.includes(currentValue)) {
            missionStreamerSelect.value = currentValue;
        }
    }
    
}

function updateMissionSummary() {
    const container = document.getElementById('mission-summary-output'); if (!container) return;
    
    // 새로운 API 형식의 미션 데이터 사용 (완료된 미션도 포함)
    const runningMissions = (currentData && currentData.missions) ? 
        currentData.missions.filter(m => m.status === 'running' || m.status === 'completed') : 
        Object.values(missionData).filter(m => streamers.includes(m.streamer) && (m.status === 'running' || m.status === 'success'));
    
    if (runningMissions.length === 0) { container.textContent = '진행 중인 미션이 없습니다.'; return; }
    
    const totalMissionAmount = runningMissions.reduce((total, mission) => {
        const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
        return total + missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
    }, 0);

    // 미션 정보를 계산하고 성공/진행중으로 분리
    const missionWithInfo = runningMissions.map(mission => {
        const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
        
        // 퇴근미션 조정 금액도 포함 (미션 시작 시간 이후의 조정만)
        const missionAdjustments = (window.currentData?.missionAdjustments || []).filter(adj => 
            adj.streamer === mission.streamer && new Date(adj.time) >= new Date(mission.startTime)
        );
        const adjustmentAmount = missionAdjustments.reduce((sum, adj) => sum + (parseFloat(adj.amount) || 0), 0);
        
        const donationAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        const currentAmount = donationAmount + adjustmentAmount;
        const remaining = (parseFloat(mission.target) || 0) - currentAmount;
        
        if (remaining <= 0 && mission.status === 'running') { 
            mission.status = 'success'; 
            mission.completedTime = Date.now(); 
        }
        
        const currentAmountStr = parseFloat(currentAmount);
        const remainingStr = parseFloat(remaining > 0 ? remaining : 0);
        
        return {
            ...mission,
            currentAmount,
            remaining,
            text: mission.status === 'success' 
                ? `${emojis[mission.streamer] || ''}${mission.streamer}(${currentAmountStr}/${parseFloat(mission.target)}✅)` 
                : `${emojis[mission.streamer] || ''}${mission.streamer}(${currentAmountStr}/-${remainingStr})`
        };
    });
    
    // 진행중인 미션을 앞에, 성공한 미션을 뒤에 배치
    const sortedMissions = missionWithInfo.sort((a, b) => {
        if (a.status === 'success' && b.status !== 'success') return 1;
        if (a.status !== 'success' && b.status === 'success') return -1;
        return 0; // 같은 상태끼리는 원래 순서 유지
    });
    
    // 진행중과 성공으로 분리
    const activeMissions = sortedMissions.filter(m => m.status !== 'success');
    const successMissions = sortedMissions.filter(m => m.status === 'success');
    
    const parts = [];
    if (activeMissions.length > 0) {
        parts.push(activeMissions.map(m => m.text).join(' '));
    }
    if (successMissions.length > 0) {
        parts.push(successMissions.map(m => m.text).join(' '));
    }
    
    container.textContent = `🎄퇴근미션🎄 ${parts.join(' ')}`;
    
    // 목표치 그래프 업데이트
    updateMissionProgressGraph(sortedMissions);
}

// 진행중인 미션 목록 업데이트
function updateRunningMissionsList() {
    const container = document.getElementById('running-missions-list');
    if (!container) return;
    
    // 서버에서 받은 미션 데이터 사용 (완료된 미션도 포함)
    const runningMissions = (currentData && currentData.missions) ? 
        currentData.missions.filter(m => m.status === 'running' || m.status === 'completed') : [];
    
    if (runningMissions.length === 0) {
        container.innerHTML = `
            <div class="no-missions" style="text-align: center; color: #6c757d; padding: 20px;">
                퇴근미션이 없습니다.
            </div>`;
        return;
    }
    
    container.innerHTML = runningMissions.map(mission => {
        // 해당 미션의 후원 계산
        const missionDonations = donations.filter(d => 
            d.streamer === mission.streamer && 
            new Date(d.time) >= new Date(mission.startTime)
        );
        const currentAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        const progressPercent = Math.min((currentAmount / mission.target) * 100, 100);
        const remaining = Math.max(0, mission.target - currentAmount);
        const isCompleted = mission.status === 'completed' || progressPercent >= 100;
        const completedIcon = mission.status === 'completed' ? ' ✅' : (progressPercent >= 100 ? ' 🎉' : '');
        const borderColor = isCompleted ? '#28a745' : '#dee2e6';
        const backgroundColor = isCompleted ? '#d4edda' : '#f8f9fa';
        
        return `
            <div style="background: ${backgroundColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong style="font-size: 16px;">${emojis[mission.streamer] || ''}${mission.streamer}${completedIcon}</strong>
                        <div style="font-size: 12px; color: #6c757d;">${mission.description || '퇴근미션'}</div>
                    </div>
                    <button onclick="deleteMission('${mission.id}')" class="btn btn-danger btn-sm">
                        🗑️ 삭제
                    </button>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 14px;">
                        <span>현재: ${currentAmount}만원</span>
                        <span>목표: ${mission.target}만원</span>
                    </div>
                    <div style="font-size: 12px; color: #28a745;">진행률: ${Math.round(progressPercent)}%</div>
                </div>
                
                <div style="background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                </div>
                
                ${remaining > 0 ? 
                    `<div style="font-size: 12px; color: #dc3545; margin-top: 5px;">${remaining}만원 남음</div>` : 
                    `<div style="font-size: 12px; color: #28a745; margin-top: 5px;">✅ 목표 달성!</div>`
                }
            </div>`;
    }).join('');
}

// 퇴근미션 목표치 그래프 업데이트
function updateMissionProgressGraph(missions) {
    const totalTarget = missions.reduce((sum, mission) => sum + (parseFloat(mission.target) || 0), 0);
    const totalCurrent = missions.reduce((sum, mission) => sum + (mission.currentAmount || 0), 0);
    
    const progressPercentage = totalTarget > 0 ? Math.min((totalCurrent / totalTarget) * 100, 100) : 0;
    const isCompleted = progressPercentage >= 100;
    const remainingAmount = Math.max(0, totalTarget - totalCurrent);
    
    // 남은 금액 텍스트 업데이트
    const remainingText = document.getElementById('mission-remaining-text');
    if (remainingText) {
        if (isCompleted) {
            remainingText.textContent = '🎉 미션 완료!';
        } else if (totalTarget === 0) {
            remainingText.textContent = '진행중인 미션 없음';
        } else {
            remainingText.textContent = `목표까지 ${remainingAmount}만원 남음`;
        }
    }
    
    // 진행도 바 업데이트
    const progressBar = document.getElementById('mission-progress-bar');
    if (progressBar) {
        progressBar.style.width = `${progressPercentage}%`;
        
        // 완료 시 특별 효과
        if (isCompleted && !progressBar.classList.contains('completed')) {
            progressBar.classList.add('completed');
        } else if (!isCompleted) {
            progressBar.classList.remove('completed');
        }
    }
}

// --- 유틸리티 및 이벤트 핸들러 ---
function formatAmount(num) { const number = parseFloat(num); if (isNaN(number)) return '0'; return parseFloat(number.toFixed(1)).toString(); }

function initEventListeners() {
    document.getElementById('auto-save-toggle').addEventListener('change', e => autoSaveEnabled = e.target.checked);
    document.getElementById('select-all').addEventListener('change', e => { document.querySelectorAll('#data-table-body input[type="checkbox"]').forEach(cb => { cb.checked = e.target.checked; toggleRowSelection(parseInt(cb.closest('tr').dataset.index, 10), e.target.checked); }); });
    document.addEventListener('click', (e) => { if (!e.target.closest('.autocomplete-container')) { document.querySelectorAll('.donor-autocomplete').forEach(list => list.style.display = 'none'); } if (currentlyEditing && !currentlyEditing.cell.contains(e.target)) { cancelCurrentEdit(); } });
    setupDonorAutocomplete('donor-input', 'donor-autocomplete');
    setupDonorAutocomplete('quick-donor', 'quick-donor-autocomplete');
    document.getElementById('quick-add-form').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('quick-add-btn').click(); } });
}

function showStatus(msg, type = 'info', duration = 3000) { const c = document.getElementById('status-container'); if (!c) return; c.innerHTML = `<div class="status status-${type}">${msg}</div>`; if (duration > 0) setTimeout(() => c.innerHTML = '', duration); }
function showSaveStatus(msg, type = 'saving') { 
    const el = document.getElementById('save-status'); 
    if (!el) {
        console.warn('save-status 요소를 찾을 수 없습니다.');
        return;
    }
    try {
        el.textContent = msg; 
        el.className = `save-status ${type}`; 
        el.style.display = 'block'; 
        if (type === 'saved' || type === 'error') {
            setTimeout(() => {
                if (el) el.style.display = 'none';
            }, 3000); 
        }
    } catch (error) {
        console.error('Save status 업데이트 실패:', error);
    }
}
function cancelCurrentEdit() { if (currentlyEditing) { currentlyEditing.cell.innerHTML = currentlyEditing.originalContent; currentlyEditing = null; } }

function makeCellEditable(cell, index) {
    if (currentlyEditing) {
        cancelCurrentEdit();
    }
    
    const field = cell.dataset.field;
    const donation = donations[index];
    const originalValue = donation[field];
    currentlyEditing = { cell, index, field, originalContent: cell.innerHTML };
    
    let inputElement;

    switch (field) {
        case 'donor':
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.className = 'form-input';
            inputElement.value = originalValue;
            break;

        case 'streamer':
            inputElement = document.createElement('select');
            inputElement.className = 'form-select';
            inputElement.innerHTML = (streamers || [])
                .map(s => `<option value="${s}" ${s === originalValue ? 'selected' : ''}>${emojis[s] || ''}${s}</option>`)
                .join('');
            break;

        case 'type':
            inputElement = document.createElement('select');
            inputElement.className = 'form-select';
            const types = ['계좌', '투네', '슈퍼챗'];
            inputElement.innerHTML = types.map(t => `<option value="${t}" ${t === originalValue ? 'selected' : ''}>${t}</option>`).join('');
            break;

        case 'amount':
            inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.step = '0.1';
            inputElement.className = 'form-input';
            inputElement.value = originalValue;
            break;

        default:
            currentlyEditing = null;
            return;
    }
    
    cell.innerHTML = '';
    cell.appendChild(inputElement);
    inputElement.focus();
    
    const saveEdit = () => {
        let newValue = inputElement.value;
        
        if (field === 'amount') {
            const parsedAmount = parseFloat(newValue);
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                showStatus('유효한 금액을 입력하세요.', 'error');
                cancelCurrentEdit();
                return;
            }
            newValue = parsedAmount;
        }

        if (String(originalValue) === String(newValue)) {
            cancelCurrentEdit();
            return;
        }
        
        donations[index][field] = newValue;
        saveToLocalStorage();
        updateAllUI();
        showStatus('수정이 저장되었습니다.', 'success');
        currentlyEditing = null;
        
        // 실시간 서버 동기화
        syncToServer();
    };
    
    inputElement.addEventListener('blur', saveEdit);
    inputElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            cancelCurrentEdit();
        }
    });
}

function switchTab(event, tabName) { document.querySelectorAll('#main-content .tab-button').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('#main-content .tab-content').forEach(content => content.classList.remove('active')); document.getElementById(tabName + '-tab').classList.add('active'); }
function switchSummaryTab(event, tabName) { const panel = event.currentTarget.closest('.panel'); panel.querySelectorAll('.management-nav .tab-button').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active'); panel.querySelectorAll('.summary-tab-content').forEach(content => content.classList.remove('active')); document.getElementById(tabName).classList.add('active'); }

async function updateUserInfo() { 
    const statusText = isAdminVerified ? '관리자 인증됨' : '일반 사용자';
    const statusClass = isAdminVerified ? 'admin' : '';
    document.getElementById('user-info').innerHTML = `<span class="${statusClass}">로컬 웹페이지 모드 (${statusText})</span>`;
    updateChatbotPermissionUI(); // 챗봇 권한 상태도 함께 업데이트
}

async function verifyPassword() { 
    const pw = document.getElementById('password-input').value; 
    if (pw === currentPassword) {
        isAdminVerified = true;
        showStatus('관리자 권한이 확인되었습니다', 'success'); 
        document.getElementById('password-section').style.display = 'none';
        document.getElementById('admin-verified').checked = true;
        updateUserInfo(); // 권한 상태 UI 업데이트
        updateChatbotPermissionUI(); // 챗봇 권한 상태 업데이트
        updateAdminElements(); // 관리자 요소 표시 업데이트
    } else {
        showStatus('잘못된 관리자 비밀번호입니다', 'error');
    }
}

function toggleAdminMode() {
    const checkbox = document.getElementById('admin-verified');
    
    if (checkbox.checked) {
        // 체크 시 비밀번호 확인
        const password = prompt('관리자 비밀번호를 입력하세요:');
        if (password === currentPassword) {
            isAdminVerified = true;
            showStatus('관리자 모드가 활성화되었습니다', 'success');
            updateUserInfo();
            updateChatbotPermissionUI();
            updateAdminElements();
            showAllSummaries(); // 관리자는 모든 요약 보기
        } else {
            checkbox.checked = false;
            showStatus('잘못된 비밀번호입니다. 관리자 모드를 사용할 수 없습니다.', 'error', 5000);
        }
    } else {
        // 체크 해제 시
        isAdminVerified = false;
        showStatus('관리자 모드가 비활성화되었습니다', 'info');
        updateUserInfo();
        updateChatbotPermissionUI();
        updateAdminElements();
        
        // 간단 모드 전용인 경우 다시 제한된 요약만 보이기
        const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
        if (isSimpleModeOnly) {
            setTimeout(() => switchSimpleMode('streamer'), 100);
        }
    }
}

function updateAdminElements() {
    // 관리자 전용 요소들 표시/숨김
    const adminElements = [
        'save-btn', 'reset-btn', 'import-btn', 'pwd-btn',
        'add-streamer-btn', 'save-mission-btn', 'stop-all-missions-btn'
    ];
    
    adminElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = isAdminVerified ? 'inline-block' : 'none';
        }
    });
    
    // 비밀번호 탭 표시/숨김
    const passwordTabBtn = document.getElementById('password-tab-btn');
    if (passwordTabBtn) {
        passwordTabBtn.style.display = isAdminVerified ? 'inline-block' : 'none';
    }
    
    // 간단 모드 전용 설정에 따라 탭 표시/숨김
    updateTabVisibility();
}

function toggleSimpleModeOnly() {
    const checkbox = document.getElementById('simple-mode-only');
    const isSimpleModeOnly = checkbox.checked;
    
    localStorage.setItem('simple-mode-only', isSimpleModeOnly.toString());
    updateTabVisibility();
    
    if (isSimpleModeOnly) {
        showStatus('조정 탭만 보이기 모드가 활성화되었습니다', 'success');
        // 조정 탭으로 자동 전환
        switchTab(null, 'simple');
        // 기본 모드로 스트리머별 조정 설정
        setTimeout(() => switchSimpleMode('streamer'), 100);
    } else {
        showStatus('전체 탭 보기 모드로 변경되었습니다', 'info');
        // 모든 요약 다시 보이기
        showAllSummaries();
    }
}

function updateTabVisibility() {
    const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
    const isAdmin = isAdminVerified;
    
    // 간단 모드 전용이고 관리자가 아닌 경우 조정 탭만 표시
    const shouldShowOnlySimple = isSimpleModeOnly && !isAdmin;
    
    const allTabs = [
        'donation-tab', 'streamer-tab', 'mission-tab', 'overlay-tab', 
        'password-tab', 'data-tab', 'chatbot-tab'
    ];
    
    const allTabButtons = document.querySelectorAll('.tab-button');
    
    allTabButtons.forEach((btn, index) => {
        if (shouldShowOnlySimple) {
            // 조정 탭만 표시
            if (btn.textContent.includes('🎯 조정')) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        } else {
            // 관리자이거나 간단 모드가 아닌 경우 모든 탭 표시 (기존 로직)
            if (btn.id === 'password-tab-btn') {
                btn.style.display = isAdmin ? 'inline-block' : 'none';
            } else {
                btn.style.display = 'inline-block';
            }
        }
    });
    
    // 간단 모드 전용 체크박스 상태 로드
    const checkbox = document.getElementById('simple-mode-only');
    if (checkbox) {
        checkbox.checked = isSimpleModeOnly;
    }
}

async function changePassword() { 
    const newPw = document.getElementById('new-password').value; 
    if (!/^\d{4}$/.test(newPw)) return showStatus('비밀번호는 4자리 숫자여야 합니다', 'error'); 
    currentPassword = newPw;
    saveToLocalStorage();
    document.getElementById('current-password').textContent = newPw;
    document.getElementById('new-password').value = '';
    showStatus('비밀번호가 변경되었습니다', 'success');
}

function showAdminPassword() { 
    alert(`현재 비밀번호: ${currentPassword}`); 
}

function refreshPassword() { 
    document.getElementById('current-password').textContent = currentPassword;
}

async function addStreamer() { 
    const name = document.getElementById('new-streamer-name').value.trim();
    const emoji = document.getElementById('new-streamer-emoji').value.trim(); 
    
    console.log('🔧 [DEBUG] 스트리머 추가 시작:', { name, emoji });
    
    if (!name) {
        console.log('🔧 [DEBUG] 이름 없음');
        return showStatus('이름을 입력해주세요', 'error');
    }
    if (streamers.includes(name)) {
        console.log('🔧 [DEBUG] 중복된 이름:', name);
        return showStatus('이미 존재하는 스트리머입니다', 'error');
    }
    
    // 버튼 비활성화
    const addBtn = document.getElementById('add-streamer-btn');
    const originalText = addBtn.textContent;
    addBtn.disabled = true;
    addBtn.textContent = '추가 중...';
    
    console.log('🔧 [DEBUG] 로컬 추가 시작');
    
    // 로컬에 먼저 추가 (확실한 방법)
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    console.log('🔧 [DEBUG] 로컬 추가 완료, UI 업데이트 시작');
    
    // UI 업데이트
    saveToLocalStorage();
    updateAllUI();
    
    // 입력 필드 초기화
    document.getElementById('new-streamer-name').value = ''; 
    document.getElementById('new-streamer-emoji').value = '';
    
    console.log('🔧 [DEBUG] 현재 스트리머 목록:', streamers);
    console.log('🔧 [DEBUG] 현재 이모지:', emojis);
    
    showStatus(`스트리머 "${name}" ${emoji}이 추가되었습니다!`, 'success');
    
    // 서버 동기화 시도 (백그라운드)
    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, emoji })
        });
        
        if (response.ok) {
            console.log('✅ [관리자] 서버 동기화 성공:', name, emoji);
        } else {
            console.log('⚠️ [관리자] 서버 동기화 실패, 로컬만 저장됨');
        }
    } catch (error) {
        console.log('⚠️ [관리자] 서버 동기화 실패:', error.message);
    }
    
    // 버튼 복원
    addBtn.disabled = false;
    addBtn.textContent = originalText;
    
    console.log('🔧 [DEBUG] 스트리머 추가 완료');
}

async function deleteStreamer(streamerName) {
    if (!confirm(`'${streamerName}'님을 목록에서 삭제하시겠습니까?`)) return;
    
    console.log('🔧 [DEBUG] 스트리머 삭제 시작:', streamerName);
    
    // 로컬에서 먼저 삭제 (확실한 방법)
    streamers = streamers.filter(s => s !== streamerName);
    delete emojis[streamerName];
    
    console.log('🔧 [DEBUG] 로컬 삭제 완료, UI 업데이트');
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`스트리머 "${streamerName}"이 삭제되었습니다`, 'success');
    
    console.log('🔧 [DEBUG] 현재 스트리머 목록:', streamers);
    
    // 서버 동기화 시도 (백그라운드)
    try {
        const response = await fetch(`/api/streamers/${encodeURIComponent(streamerName)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            console.log('✅ [관리자] 서버 동기화 성공:', streamerName);
        } else {
            console.log('⚠️ [관리자] 서버 동기화 실패, 로컬만 삭제됨');
        }
    } catch (error) {
        console.log('⚠️ [관리자] 서버 동기화 실패:', error.message);
    }
    
    console.log('🔧 [DEBUG] 스트리머 삭제 완료');
}

async function editStreamer(streamerName) {
    const currentEmoji = emojis[streamerName] || '';
    const newName = prompt(`스트리머 이름을 수정하세요:`, streamerName);
    if (!newName || newName.trim() === '') return;
    
    const trimmedNewName = newName.trim();
    if (trimmedNewName === streamerName) {
        // 이름이 같다면 이모지만 수정
        const newEmoji = prompt(`${streamerName}의 이모지를 수정하세요:`, currentEmoji);
        if (newEmoji !== null) {
            emojis[streamerName] = newEmoji.trim();
            saveToLocalStorage();
            updateAllUI();
            showStatus(`${streamerName}의 이모지가 수정되었습니다!`, 'success');
        }
        return;
    }
    
    // 이름이 바뀌는 경우 중복 체크
    if (streamers.includes(trimmedNewName)) {
        alert('이미 존재하는 스트리머 이름입니다.');
        return;
    }
    
    const newEmoji = prompt(`${trimmedNewName}의 이모지를 설정하세요:`, currentEmoji);
    if (newEmoji === null) return; // 취소
    
    // 기존 스트리머 삭제
    streamers = streamers.filter(s => s !== streamerName);
    delete emojis[streamerName];
    
    // 새 스트리머 추가
    streamers.push(trimmedNewName);
    emojis[trimmedNewName] = newEmoji.trim();
    
    // 후원 데이터에서도 스트리머 이름 변경
    donations = donations.map(d => {
        if (d.streamer === streamerName) {
            return { ...d, streamer: trimmedNewName };
        }
        return d;
    });
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`${streamerName}이(가) ${trimmedNewName}으로 수정되었습니다!`, 'success');
    
    // 서버 동기화 시도
    try {
        // 기존 삭제
        await fetch(`/api/streamers/${encodeURIComponent(streamerName)}`, { method: 'DELETE' });
        // 새로 추가
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: trimmedNewName, emoji: newEmoji.trim() })
        });
    } catch (error) {
        console.log('⚠️ [관리자] 서버 동기화 실패:', error.message);
    }
}

// 모바일용 스트리머 추가 함수
async function addStreamerMobile() {
    const name = document.getElementById('new-streamer-name-mobile').value.trim();
    const emoji = document.getElementById('new-streamer-emoji-mobile').value.trim();
    
    if (!name) {
        alert('이름을 입력해주세요!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('이미 존재하는 스트리머입니다!');
        return;
    }
    
    // addStreamer 함수와 동일한 로직
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('new-streamer-name-mobile').value = '';
    document.getElementById('new-streamer-emoji-mobile').value = '';
    
    showStatus(`스트리머 "${name}" ${emoji}이 추가되었습니다!`, 'success');
    
    // 서버 동기화 시도
    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
        
        if (response.ok) {
            console.log('✅ [관리자] 서버 동기화 성공:', name, emoji);
        }
    } catch (error) {
        console.log('⚠️ [관리자] 서버 동기화 실패:', error.message);
    }
}

// 백업용 스트리머 추가 함수 (간단한 레이아웃)
async function addStreamerBackup() {
    const name = document.getElementById('backup-streamer-name').value.trim();
    const emoji = document.getElementById('backup-streamer-emoji').value.trim();
    
    if (!name) {
        alert('스트리머 이름을 입력해주세요!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('이미 존재하는 스트리머입니다!');
        return;
    }
    
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('backup-streamer-name').value = '';
    document.getElementById('backup-streamer-emoji').value = '';
    
    showStatus(`✅ "${name}" ${emoji} 추가 완료!`, 'success');
    
    // 서버 동기화
    try {
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
    } catch (error) {
        console.log('⚠️ 서버 동기화 실패:', error.message);
    }
}

// 간편 스트리머 추가 함수 (세로 레이아웃)
async function addStreamerSimple() {
    const name = document.getElementById('simple-streamer-name').value.trim();
    const emoji = document.getElementById('simple-streamer-emoji').value.trim();
    
    if (!name) {
        alert('스트리머 이름을 입력해주세요!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('이미 존재하는 스트리머입니다!');
        return;
    }
    
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('simple-streamer-name').value = '';
    document.getElementById('simple-streamer-emoji').value = '';
    
    showStatus(`🎉 "${name}" ${emoji} 스트리머가 성공적으로 추가되었습니다!`, 'success');
    
    // 서버 동기화
    try {
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
        console.log('✅ 서버 동기화 성공');
    } catch (error) {
        console.log('⚠️ 서버 동기화 실패:', error.message);
    }
}


// === 간단한 스트리머 관리 함수들 ===
function simpleAddStreamer() {
    const name = document.getElementById('new-streamer-name').value.trim();
    const emoji = document.getElementById('new-streamer-emoji').value.trim();
    
    if (!name) {
        alert('이름을 입력해주세요');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('이미 존재하는 스트리머입니다');
        return;
    }
    
    // 즉시 추가
    streamers.push(name);
    emojis[name] = emoji || '⭐';
    
    // 저장 및 업데이트
    try {
        saveToLocalStorage();
        updateAllUI();
    } catch (e) {
        // 함수가 없으면 직접 처리
        localStorage.setItem('streamers', JSON.stringify(streamers));
        localStorage.setItem('emojis', JSON.stringify(emojis));
        location.reload();
    }
    
    // 입력창 초기화
    document.getElementById('new-streamer-name').value = '';
    document.getElementById('new-streamer-emoji').value = '';
    
    alert(`✅ ${name} ${emoji} 추가 완료!`);
}

function restoreEmojis() {
    // 이모지 강제 복원
    emojis = {
        "엄삼용": "🫅", 
        "손덕배": "🌺", 
        "연기": "🐧", 
        "동동": "😎", 
        "주옥": "👺", 
        "불곰": "🎬", 
        "이효팔": "🏝", 
        "남붕": "🤠", 
        "옥긔": "🦆", 
        "국고": "🏦"
    };
    
    // 저장
    try {
        saveToLocalStorage();
        updateAllUI();
    } catch (e) {
        localStorage.setItem('emojis', JSON.stringify(emojis));
        location.reload();
    }
    
    alert('✅ 이모지 복원 완료!');
}

function setupDonorAutocomplete(inputId, listId) {
    const input = document.getElementById(inputId); const list = document.getElementById(listId);
    input.addEventListener('input', () => {
        const value = input.value.toLowerCase(); activeAutocompleteIndex = -1; if (!value) { list.style.display = 'none'; return; }
        const filteredDonors = Array.from(todayDonors).filter(donor => donor.toLowerCase().includes(value));
        if (filteredDonors.length > 0) { list.innerHTML = filteredDonors.slice(0, 8).map(item => `<div class="autocomplete-item">${item}</div>`).join(''); addAutocompleteListeners(list, input); list.style.display = 'block'; } else { list.style.display = 'none'; }
    });
    input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.autocomplete-item'); if (list.style.display !== 'block' || items.length === 0) return;
        switch (e.key) {
            case 'ArrowDown': e.preventDefault(); activeAutocompleteIndex = (activeAutocompleteIndex + 1) % items.length; highlightItem(items, activeAutocompleteIndex); break;
            case 'ArrowUp': e.preventDefault(); activeAutocompleteIndex = (activeAutocompleteIndex - 1 + items.length) % items.length; highlightItem(items, activeAutocompleteIndex); break;
            case 'Enter': e.preventDefault(); if (activeAutocompleteIndex > -1) items[activeAutocompleteIndex].dispatchEvent(new MouseEvent('mousedown', { bubbles: true })); else { list.style.display = 'none'; } break;
            case 'Escape': list.style.display = 'none'; break;
        }
    });
}

function addAutocompleteListeners(list, input) { const items = list.querySelectorAll('.autocomplete-item'); items.forEach((item, index) => { item.addEventListener('mousedown', (e) => { e.preventDefault(); input.value = item.textContent; list.style.display = 'none'; }); item.addEventListener('mouseenter', () => { highlightItem(items, index); activeAutocompleteIndex = index; }); }); }
function highlightItem(items, index) { items.forEach((item, i) => { if (i === index) { item.classList.add('selected'); item.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); } else { item.classList.remove('selected'); } }); }

function toggleRowSelection(index, isSelected) { if (isSelected) selectedRows.add(index); else selectedRows.delete(index); }
function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => showStatus('복사되었습니다!', 'success'));}

async function saveData() { 
    if(!confirm('일간 정산을 저장하시겠습니까?')) return; 
    
    const today = new Date().toLocaleDateString('ko-KR');
    const summaryData = {
        date: today,
        totalAmount: donations.reduce((sum, d) => sum + parseFloat(d.amount), 0),
        totalCount: donations.length,
        donorCount: new Set(donations.map(d => d.donor)).size
    };
    
    // 일간 정산 데이터를 로컬 스토리지에 저장
    const dailySummaries = JSON.parse(localStorage.getItem('daily_summaries') || '[]');
    const existingIndex = dailySummaries.findIndex(s => s.date === today);
    
    if (existingIndex >= 0) {
        dailySummaries[existingIndex] = summaryData;
    } else {
        dailySummaries.push(summaryData);
    }
    
    localStorage.setItem('daily_summaries', JSON.stringify(dailySummaries));
    showStatus('일간 정산이 저장되었습니다', 'success');
}

function showResetDialog() { document.getElementById('reset-dialog').style.display = 'flex'; }
function closeResetDialog() { document.getElementById('reset-dialog').style.display = 'none'; document.getElementById('reset-password').value = ''; }

async function confirmReset() {
    const passwordInput = document.getElementById('reset-password');
    const password = passwordInput.value;

    if (password !== currentPassword) {
        showStatus('잘못된 비밀번호입니다.', 'error');
        passwordInput.focus();
        return;
    }

    // 🔴 완전 초기화 - 모든 데이터 소스 정리
    console.log('🔄 완전 데이터 초기화 시작...');
    
    // 1. 로컬 데이터 초기화
    donations = [];
    selectedRows.clear();
    todayDonors.clear();
    
    // 2. localStorage 완전 정리
    try {
        localStorage.removeItem('donation_data');
        localStorage.removeItem('streamer_data');
        localStorage.removeItem('emoji_data');
        console.log('✅ localStorage 완전 정리 완료');
    } catch (error) {
        console.error('localStorage 정리 실패:', error);
    }
    
    // 3. 서버 데이터도 완전 초기화
    if (isSocketConnected) {
        try {
            const response = await fetch('/api/donations/bulk', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ donations: [] })
            });
            
            if (response.ok) {
                console.log('✅ 서버 데이터 완전 초기화 성공');
            } else {
                console.error('❌ 서버 초기화 실패');
            }
        } catch (error) {
            console.error('서버 초기화 요청 실패:', error);
        }
    }
    
    // 4. UI 업데이트
    updateAllUI();
    closeResetDialog();
    showStatus('🔴 모든 데이터가 완전히 초기화되었습니다 (서버+로컬+캐시)', 'success');
    
    // 5. 페이지 새로고침으로 모든 캐시 정리
    setTimeout(() => {
        if (confirm('초기화를 완전히 적용하려면 페이지를 새로고침해야 합니다. 새로고침하시겠습니까?')) {
            location.reload();
        }
    }, 1000);
}

// --- 데이터 내보내기/가져오기 ---
function exportData() {
    const data = {
        donations: donations,
        streamers: streamers,
        emojis: emojis,
        missionData: missionData,
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donation-data-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus('데이터가 내보내졌습니다', 'success');
}

function importData() {
    document.getElementById('import-file').click();
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.donations && Array.isArray(data.donations)) {
                donations = data.donations.map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
            }
            
            if (data.streamers && Array.isArray(data.streamers)) {
                streamers = data.streamers;
            }
            
            if (data.emojis && typeof data.emojis === 'object') {
                emojis = data.emojis;
            }
            
            if (data.missionData && typeof data.missionData === 'object') {
                missionData = data.missionData;
            }
            
            todayDonors = new Set(donations.map(d => d.donor));
            saveToLocalStorage();
            updateAllUI();
            showStatus('데이터를 성공적으로 가져왔습니다', 'success');
            
        } catch (error) {
            showStatus('파일 형식이 올바르지 않습니다', 'error');
        }
    };
    reader.readAsText(file);
    
    // 파일 입력 초기화
    event.target.value = '';
}

// --- 후원 알림 관련 함수 ---
async function sendDonationNotification(newDonations) {
    // 챗봇이 연결된 상태면 자동 알림 허용
    if (!liveChatId) {
        console.log('라이브 채팅이 연결되지 않아 알림을 보낼 수 없습니다.');
        return;
    }
    
    // OAuth 로그인이 되어있거나 API 키가 설정되어 있으면 권한 체크 생략
    const hasYouTubeAccess = isOAuthSignedIn || localStorage.getItem('youtube_api_key');
    if (!hasWritePermission() && !hasYouTubeAccess) {
        console.log('챗봇 자동 알림 권한이 없습니다. (관리자이거나 비밀번호 입력 필요)');
        showStatus('💡 챗봇 자동 알림: Google OAuth 로그인 또는 관리자 권한이 필요합니다.', 'info', 3000);
        return;
    }
    
    try {
        // 후원 알림 메시지 생성
        let notificationMessages = [];
        
        // 후원자별로 그룹화
        const donorGroups = {};
        newDonations.forEach(d => {
            if (!donorGroups[d.donor]) {
                donorGroups[d.donor] = [];
            }
            donorGroups[d.donor].push(d);
        });
        
        // 각 후원자별로 메시지 생성
        for (const [donor, donations] of Object.entries(donorGroups)) {
            const donationTexts = donations.map(d => {
                // 해당 스트리머 현재 총액 계산
                const streamerTotal = getDonationsForStreamer(d.streamer).reduce((sum, donation) => sum + parseFloat(donation.amount), 0);
                return `${emojis[d.streamer] || ''}${d.streamer} (+${formatAmount(d.amount)}만/${formatAmount(streamerTotal)}만)`;
            }).join(', ');
            
            notificationMessages.push(`💝 ${donor}님 > ${donationTexts} 감사합니다!`);
        }
        
        // 메시지들을 순차적으로 전송 (너무 빨리 보내면 API 제한에 걸림)
        for (let i = 0; i < notificationMessages.length; i++) {
            const message = notificationMessages[i];
            
            // 메시지 전송 (OAuth 방식 우선)
            if (isOAuthSignedIn) {
                await sendToYouTubeOAuth(message);
            } else {
                await sendMessageToYouTube(message);
            }
            
            // 다음 메시지 전송까지 약간의 지연 (API 제한 방지)
            if (i < notificationMessages.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        
        console.log(`${notificationMessages.length}개의 후원 알림을 전송했습니다.`);
        
    } catch (error) {
        console.error('후원 알림 전송 실패:', error);
        showStatus(`챗봇 알림 전송 실패: ${error.message}`, 'warning', 3000);
    }
}

function getDonationsForStreamer(streamerName) {
    return donations.filter(d => d.streamer === streamerName);
}

// --- Google Drive 백업 기능 ---
const GOOGLE_CONFIG = {
    CLIENT_ID: '493287022430-4mmnh4stu22p13lr0sjgvpg0nbkouova.apps.googleusercontent.com', // OAuth 2.0 클라이언트 ID (새로 생성됨)
    API_KEY: 'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4', // YouTube Data API v3 키 (업데이트됨)
    DISCOVERY_DOCS: [
        // Drive API 제거 - 502 에러 원인
        'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'
    ],
    // Drive 권한 제거하여 권한 요청 단순화
    SCOPES: 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl'
};

// OAuth 관련 변수
let isOAuthSignedIn = false;
let authInstance = null;

// API 로딩 상태 추적
let apiLoadAttempts = 0;
const MAX_LOAD_ATTEMPTS = 5;

// 안전한 오류 메시지 추출
function getErrorMessage(error) {
    if (!error) return 'Unknown error (null/undefined)';
    if (typeof error === 'string') return error;
    if (error.message) return error.message;
    if (error.error) return error.error;
    if (error.details) return error.details;
    return `Unknown error type: ${typeof error}`;
}

// 안전 모드 활성화
async function enableSafeMode(errorReason = 'Unknown') {
    console.log('🛡️ 안전 모드 활성화:', errorReason);
    
    try {
        // 상태 업데이트
        updateGoogleDriveStatus(`API 초기화 실패 - 안전 모드 (${errorReason})`, 'warning');
        
        // 사용자에게 친화적인 메시지
        setTimeout(() => {
            const statusElement = safeGetElement('google-auth-status');
            if (statusElement) {
                statusElement.className = 'status status-info';
                statusElement.innerHTML = `
                    ⚠️ <strong>Google API 연결 문제</strong><br>
                    네트워크나 일시적 서버 문제일 수 있습니다.<br>
                    <button onclick="retryGoogleAPI()" class="btn btn-primary" style="margin-top:10px;">🔄 다시 시도</button>
                    <br><small style="color:#666;">또는 아래 API 키 방식을 사용하세요</small>
                `;
            }
        }, 500);
        
        console.log('✅ 안전 모드 설정 완료 - API 키 방식을 사용할 수 있습니다');
        
    } catch (error) {
        console.error('안전 모드 설정 실패:', error);
    }
}

// 수동 재시도 함수
function retryGoogleAPI() {
    console.log('🔄 사용자가 수동으로 재시도를 요청했습니다');
    apiLoadAttempts = 0; // 재시도 카운터 리셋
    
    const statusElement = safeGetElement('google-auth-status');
    if (statusElement) {
        statusElement.className = 'status status-info';
        statusElement.innerHTML = '🔄 <strong>Google API 재연결 시도 중...</strong>';
    }
    
    setTimeout(initGoogleAPI, 1000);
}

async function waitForGapi() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const checkGapi = () => {
            attempts++;
            if (typeof gapi !== 'undefined') {
                console.log(`gapi 로드 확인 완료 (시도 ${attempts}회)`);
                resolve();
            } else if (attempts >= 20) { // 10초 대기
                reject(new Error('gapi 로딩 시간 초과'));
            } else {
                setTimeout(checkGapi, 500);
            }
        };
        checkGapi();
    });
}

async function initGoogleAPI() {
    try {
        console.log('🚀 간소화된 Google API 초기화 시작...');
        
        // 기본 환경 검사
        console.log('환경 체크:', {
            gapi: typeof gapi,
            google: typeof google?.accounts?.oauth2
        });
        
        // Google 서비스가 로드될 때까지 대기
        if (typeof gapi === 'undefined') {
            throw new Error('Google API가 로드되지 않았습니다');
        }
        
        if (typeof google === 'undefined' || !google.accounts) {
            throw new Error('Google Identity Services가 로드되지 않았습니다');
        }
        
        // Drive API 초기화 비활성화 (502 에러 방지)
        console.log('ℹ️ Google Drive API 초기화 건너뜀 (챗봇 기능만 사용)');
        
        // ✅ 새로운 Google Identity Services만 사용 (구식 OAuth2 제거)
        console.log('✅ Google Identity Services 준비 완료');
        console.log('💡 구식 gapi.auth2 대신 google.accounts.oauth2 사용');
        
        // 기본 gapi.client 초기화 (YouTube API 호출용)
        try {
            await new Promise((resolve, reject) => {
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.API_KEY,
                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest']
                        });
                        console.log('✅ gapi.client 초기화 완료 (YouTube API용)');
                        console.log('✅ YouTube API v3 discoveryDoc 로드 완료');
                        resolve();
                    } catch (error) {
                        console.warn('gapi.client 초기화 실패:', error);
                        resolve(); // 실패해도 계속 진행
                    }
                });
            });
        } catch (error) {
            console.warn('gapi.client 초기화 실패, 계속 진행:', error);
        }
        
        console.log('🎉 Google API 초기화 성공!');
        apiLoadAttempts = 0; // 성공 시 재시도 카운터 리셋
        
        // 초기화 완료 - 상태 업데이트
        setTimeout(() => {
            updateGoogleAuthStatus();
        }, 100);
        
        console.log('🎉 간소화된 Google API 초기화 완료!');
        
    } catch (error) {
        // 오류 정보 안전하게 추출
        const errorMessage = getErrorMessage(error);
        console.error(`Google API 초기화 실패 (시도 ${apiLoadAttempts}/${MAX_LOAD_ATTEMPTS}):`, errorMessage, error);
        
        if (apiLoadAttempts < MAX_LOAD_ATTEMPTS) {
            console.log(`${5}초 후 재시도합니다... (오류: ${errorMessage})`);
            setTimeout(initGoogleAPI, 5000);
            return;
        }
        
        // 최종 실패 시 - 완전히 안전한 모드로 전환
        console.log('🔄 최종 실패 - 안전 모드 활성화');
        try {
            await enableSafeMode(errorMessage);
        } catch (safeModeError) {
            console.error('안전 모드 활성화도 실패:', safeModeError);
        }
        
        // OAuth 상태도 안전하게 처리
        setTimeout(() => {
            try {
                updateGoogleAuthStatus();
            } catch (authStatusError) {
                console.error('OAuth 상태 업데이트 실패:', authStatusError);
            }
        }, 200);
        
        // 사용자에게 대안 제시
        console.log('💡 대안: API 키 방식을 사용해보세요');
    }
}

// 대체 OAuth 초기화 방법
// fallbackOAuthInit 함수 제거됨 - 더 이상 필요없음

function signInGoogle() {
    try {
        console.log('🔐 Google 로그인 시작...');
        
        // 팝업 차단 방지: 사용자 액션에서 직접 호출
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
            showStatus('❌ Google 로그인 서비스를 사용할 수 없습니다. 페이지를 새로고침해주세요.', 'error');
            return;
        }

        // 직접 로그인 버튼 렌더링 (더 안정적)
        const signinContainer = document.getElementById('google-signin-btn');
        if (!signinContainer) {
            showStatus('❌ 로그인 버튼을 찾을 수 없습니다.', 'error');
            return;
        }

        // 기존 버튼 내용 클리어
        signinContainer.innerHTML = '';
        
        // 새 로그인 버튼 렌더링
        google.accounts.id.renderButton(signinContainer, {
            theme: 'filled_blue',
            size: 'large',
            text: 'signin_with',
            shape: 'rectangular',
            width: 200
        });
        
        showStatus('🔐 위의 파란색 "Google로 로그인" 버튼을 클릭하세요.', 'info');
        
        // 추가: prompt 방식도 시도 (백업)
        setTimeout(() => {
            try {
                google.accounts.id.prompt((notification) => {
                    console.log('Google 로그인 알림:', notification);
                    if (notification.isNotDisplayed()) {
                        console.log('⚠️ 로그인 프롬프트가 표시되지 않음 - 버튼 방식 사용');
                    } else if (notification.isSkippedMoment()) {
                        console.log('⚠️ 로그인 프롬프트가 건너뜀 - 버튼 방식 사용');
                    }
                });
            } catch (promptError) {
                console.log('프롬프트 방식 실패, 버튼 방식만 사용:', promptError);
            }
        }, 1000);
        
    } catch (error) {
        console.error('Google 로그인 초기화 실패:', error);
        showStatus(`❌ Google 로그인 실패: ${error.message}`, 'error');
        
        // 대안 제시
        setTimeout(() => {
            showStatus('💡 해결방법: 1) 페이지 새로고침, 2) 팝업 차단 해제, 3) 시크릿 모드 시도', 'warning', 10000);
        }, 2000);
    }
}

function handleGoogleSignIn(response) {
    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        googleUser = {
            email: payload.email,
            name: payload.name,
            picture: payload.picture
        };
        
        isGoogleSignedIn = true;
        updateGoogleUI();
        updateGoogleDriveStatus(`✅ ${googleUser.email}로 로그인되었습니다`, 'success');
        
        // 자동 백업 설정 로드
        const savedAutoBackup = localStorage.getItem('google-auto-backup');
        if (savedAutoBackup === 'true') {
            enableAutoBackup();
        }
        
    } catch (error) {
        console.error('Google 로그인 처리 실패:', error);
        showStatus('Google 로그인 처리에 실패했습니다', 'error');
    }
}

function signOutGoogle() {
    google.accounts.id.disableAutoSelect();
    isGoogleSignedIn = false;
    googleUser = null;
    
    // 자동 백업 중지
    if (autoBackupInterval) {
        clearInterval(autoBackupInterval);
        autoBackupInterval = null;
        autoBackupEnabled = false;
    }
    
    updateGoogleUI();
    updateGoogleDriveStatus('로그아웃되었습니다', 'info');
    showStatus('Google 계정에서 로그아웃되었습니다', 'info');
}

function updateGoogleUI() {
    const signinBtn = document.getElementById('google-signin-btn');
    const signoutBtn = document.getElementById('google-signout-btn');
    const backupBtn = document.getElementById('google-backup-btn');
    const autoBackupBtn = document.getElementById('auto-backup-btn');
    const userInfo = document.getElementById('google-user-info');
    const userEmail = document.getElementById('user-email');
    
    if (isGoogleSignedIn && googleUser) {
        signinBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        backupBtn.style.display = 'inline-block';
        autoBackupBtn.style.display = 'inline-block';
        userInfo.style.display = 'block';
        userEmail.textContent = googleUser.email;
        
        // 자동 백업 버튼 상태 업데이트
        autoBackupBtn.textContent = autoBackupEnabled ? '⏰ 자동백업 ON' : '⏰ 자동백업 OFF';
        if (autoBackupBtn) {
            autoBackupBtn.className = autoBackupEnabled ? 'btn btn-success' : 'btn btn-warning';
        }
    } else {
        signinBtn.style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        backupBtn.style.display = 'none';
        autoBackupBtn.style.display = 'none';
        userInfo.style.display = 'none';
    }
}

async function backupToGoogleDrive() {
    if (!isGoogleSignedIn) {
        showStatus('먼저 Google 계정에 로그인하세요', 'error');
        return;
    }
    
    try {
        updateGoogleDriveStatus('Google Drive로 백업 중...', 'info');
        
        // 백업 데이터 생성
        const backupData = {
            donations: donations || [],
            streamers: streamers || [],
            emojis: emojis || {},
            settings: {
                streamerSummaryHeader: localStorage.getItem('streamer-summary-header'),
                streamerSummaryFooter: localStorage.getItem('streamer-summary-footer'),
                excludeGukgo: localStorage.getItem('exclude-gukgo'),
                hiddenStreamers: localStorage.getItem('hidden-streamers'),
                simpleModeOnly: localStorage.getItem('simple-mode-only'),
                tableTitle: localStorage.getItem('table-title'),
                showTotalRow: localStorage.getItem('show-total-row'),
                showUpdateTime: localStorage.getItem('show-update-time')
            },
            backupDate: new Date().toISOString(),
            version: '1.0'
        };
        
        // 파일명 생성
        const now = new Date();
        const fileName = `donation-backup-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.json`;
        
        // Google Drive에 업로드
        const fileMetadata = {
            name: fileName,
            parents: ['appDataFolder'] // 앱 전용 폴더에 저장
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        form.append('file', new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'}));
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
            }),
            body: form
        });
        
        if (response.ok) {
            const result = await response.json();
            updateGoogleDriveStatus(`✅ 백업 완료: ${fileName}`, 'success');
            showStatus('Google Drive 백업이 완료되었습니다', 'success');
        } else {
            throw new Error('업로드 실패');
        }
        
    } catch (error) {
        console.error('Google Drive 백업 실패:', error);
        updateGoogleDriveStatus('❌ 백업 실패', 'error');
        showStatus('Google Drive 백업에 실패했습니다', 'error');
    }
}

function toggleAutoBackup() {
    if (!isGoogleSignedIn) {
        showStatus('먼저 Google 계정에 로그인하세요', 'error');
        return;
    }
    
    if (autoBackupEnabled) {
        // 자동 백업 비활성화
        if (autoBackupInterval) {
            clearInterval(autoBackupInterval);
            autoBackupInterval = null;
        }
        autoBackupEnabled = false;
        localStorage.setItem('google-auto-backup', 'false');
        updateGoogleDriveStatus('자동 백업이 비활성화되었습니다', 'info');
    } else {
        // 자동 백업 활성화 (매일 오후 11시)
        enableAutoBackup();
        localStorage.setItem('google-auto-backup', 'true');
        updateGoogleDriveStatus('자동 백업이 활성화되었습니다 (매일 밤 11시)', 'success');
    }
    
    updateGoogleUI();
}

function enableAutoBackup() {
    autoBackupEnabled = true;
    
    // 매일 밤 11시에 자동 백업
    const scheduleBackup = () => {
        const now = new Date();
        const targetTime = new Date();
        targetTime.setHours(23, 0, 0, 0); // 밤 11시
        
        if (now > targetTime) {
            targetTime.setDate(targetTime.getDate() + 1); // 다음날
        }
        
        const timeUntilBackup = targetTime - now;
        
        setTimeout(() => {
            if (autoBackupEnabled && isGoogleSignedIn) {
                backupToGoogleDrive();
            }
            // 다음 백업 스케줄
            autoBackupInterval = setInterval(() => {
                if (autoBackupEnabled && isGoogleSignedIn) {
                    backupToGoogleDrive();
                }
            }, 24 * 60 * 60 * 1000); // 24시간마다
        }, timeUntilBackup);
    };
    
    scheduleBackup();
}

function updateGoogleDriveStatus(message, type = 'info') {
    const statusEl = document.getElementById('google-drive-status');
    if (!statusEl) {
        console.warn('google-drive-status 요소를 찾을 수 없습니다.');
        return;
    }
    try {
        statusEl.className = `status status-${type}`;
        statusEl.textContent = message;
    } catch (error) {
        console.error('Google Drive 상태 업데이트 실패:', error);
    }
}

async function sendMessageToYouTube(message, retryCount = 0) {
    if (!liveChatId || !youtubeApiKey) {
        throw new Error('YouTube 연결이 설정되지 않았습니다.');
    }
    
    try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/liveChat/messages?part=snippet&key=${youtubeApiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${youtubeApiKey}`
            },
            body: JSON.stringify({
                snippet: {
                    liveChatId: liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            const errorMessage = error.error?.message || '메시지 전송 실패';
            
            // API 키 관련 에러시 백업 키로 자동 전환
            if ((errorMessage.includes('quota') || errorMessage.includes('invalid') || errorMessage.includes('blocked')) 
                && retryCount < backupApiKeys.length - 1) {
                
                console.log(`API 키 에러로 백업 키로 전환: ${errorMessage}`);
                currentKeyIndex = (currentKeyIndex + 1) % backupApiKeys.length;
                youtubeApiKey = backupApiKeys[currentKeyIndex];
                
                showStatus(`⚠️ API 키 자동 전환됨 (${currentKeyIndex + 1}/${backupApiKeys.length})`, 'warning');
                
                // 백업 키로 재시도
                return await sendMessageToYouTube(message, retryCount + 1);
            }
            
            throw new Error(errorMessage);
        }
        
        return response.json();
        
    } catch (networkError) {
        if (retryCount < backupApiKeys.length - 1) {
            console.log(`네트워크 에러로 백업 키로 전환: ${networkError.message}`);
            currentKeyIndex = (currentKeyIndex + 1) % backupApiKeys.length;
            youtubeApiKey = backupApiKeys[currentKeyIndex];
            
            showStatus(`⚠️ 네트워크 에러로 API 키 전환됨`, 'warning');
            
            return await sendMessageToYouTube(message, retryCount + 1);
        }
        
        throw networkError;
    }
}

// --- YouTube API 관련 함수 ---
function loadYouTubeSettings() {
    const savedApiKey = localStorage.getItem(STORAGE_KEYS.YOUTUBE_API_KEY);
    const savedVideoId = localStorage.getItem(STORAGE_KEYS.YOUTUBE_VIDEO_ID);
    
    if (savedApiKey) {
        youtubeApiKey = savedApiKey;
        document.getElementById('youtube-api-key').value = savedApiKey;
    }
    if (savedVideoId) {
        document.getElementById('youtube-video-id').value = savedVideoId;
    }
    
    updateYouTubeUI();
}

function updateYouTubeUI() {
    const hasApiKey = youtubeApiKey.length > 0;
    const hasLiveChat = liveChatId.length > 0;
    
    document.getElementById('youtube-send-btn').disabled = !hasLiveChat;
    document.getElementById('auto-start-btn').disabled = !hasLiveChat;
    
    const statusEl = document.getElementById('chatbot-status');
    if (hasLiveChat) {
        statusEl.className = 'status status-success';
        statusEl.innerHTML = '✅ <strong>연결됨</strong>: 유튜브 라이브 채팅에 메시지를 전송할 수 있습니다!';
    } else if (hasApiKey) {
        statusEl.className = 'status status-warning';
        statusEl.innerHTML = '⚠️ <strong>API 키 설정됨</strong>: 영상 ID를 입력하고 라이브 연결을 해주세요.';
    } else {
        statusEl.className = 'status status-warning';
        statusEl.innerHTML = '🤖 <strong>설정 필요</strong>: API 키를 입력하면 자동 전송이 가능합니다!';
    }
}

async function testApiKey() {
    const apiKey = document.getElementById('youtube-api-key').value.trim();
    if (!apiKey) {
        showStatus('API 키를 입력하세요', 'error');
        return;
    }
    
    try {
        showStatus('API 키 테스트 중...', 'info');
        const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&key=${apiKey}&maxResults=1`);
        
        if (response.ok) {
            showStatus('✅ API 키가 유효합니다!', 'success');
        } else {
            const error = await response.json();
            console.log('YouTube API 에러 상세:', error);
            
            let errorMessage = error.error?.message || 'API 키 에러';
            let suggestion = '';
            
            // 구체적인 에러 처리와 해결책 제공
            if (errorMessage.includes('API key not valid') || errorMessage.includes('invalid')) {
                suggestion = '\n\n💡 해결방법:\n1. Google Cloud Console에서 새 API 키 생성\n2. YouTube Data API v3 활성화 확인\n3. OAuth 방식 사용 (더 안전함)';
            } else if (errorMessage.includes('quota') || errorMessage.includes('exceeded')) {
                suggestion = '\n\n💡 해결방법:\n1. 내일 다시 시도 (할당량 리셋)\n2. 새 Google Cloud 프로젝트 생성\n3. OAuth 방식 사용';
            } else if (errorMessage.includes('blocked') || errorMessage.includes('restricted')) {
                suggestion = '\n\n💡 해결방법:\n1. OAuth 방식 사용 (donation-manager-oauth.html)\n2. 새 IP/도메인에서 접근\n3. Google Cloud 프로젝트 설정 확인';
            } else if (errorMessage.includes('forbidden') || errorMessage.includes('403')) {
                suggestion = '\n\n💡 해결방법:\n1. API 키에 YouTube 권한 추가\n2. 프로젝트에서 YouTube Data API v3 활성화\n3. OAuth 방식 사용';
            }
            
            showStatus(`❌ ${errorMessage}${suggestion}`, 'error');
        }
    } catch (error) {
        console.error('API 테스트 에러:', error);
        showStatus(`❌ 네트워크 에러: ${error.message}\n\n💡 OAuth 버전(donation-manager-oauth.html)을 사용해보세요!`, 'error');
    }
}

function saveApiKey() {
    const apiKey = document.getElementById('youtube-api-key').value.trim();
    if (!apiKey) {
        showStatus('API 키를 입력하세요', 'error');
        return;
    }
    
    youtubeApiKey = apiKey;
    localStorage.setItem(STORAGE_KEYS.YOUTUBE_API_KEY, apiKey);
    updateYouTubeUI();
    showStatus('API 키가 저장되었습니다', 'success');
}

async function connectToLiveChat() {
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('유튜브 영상 ID를 입력하세요', 'error');
        return;
    }
    
    if (!youtubeApiKey) {
        showStatus('먼저 API 키를 저장하세요', 'error');
        return;
    }
    
    try {
        showStatus('라이브 채팅 연결 중...', 'info');
        
        // 영상 정보 가져오기
        const videoResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${youtubeApiKey}`);
        const videoData = await videoResponse.json();
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('영상을 찾을 수 없습니다. 영상 ID를 확인하세요.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('현재 라이브 방송이 아니거나 채팅이 비활성화되어 있습니다.');
        }
        
        liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem(STORAGE_KEYS.YOUTUBE_VIDEO_ID, videoId);
        updateYouTubeUI();
        showStatus('✅ 라이브 채팅에 성공적으로 연결되었습니다!', 'success');
        
    } catch (error) {
        showStatus(`❌ 연결 실패: ${error.message}`, 'error');
        liveChatId = '';
        updateYouTubeUI();
    }
}

async function sendToYouTube() {
    const message = document.getElementById('manual-message').value.trim();
    if (!message) {
        showStatus('전송할 메시지를 입력하세요', 'error');
        return;
    }
    
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return;
    }
    
    try {
        showStatus('유튜브로 전송 중...', 'info');
        
        // OAuth 방식 우선 시도
        if (isOAuthSignedIn) {
            const success = await sendToYouTubeOAuth(message);
            if (success) {
                showStatus('✅ OAuth 방식으로 메시지가 전송되었습니다!', 'success');
                document.getElementById('manual-message').value = '';
                return;
            }
        }
        
        // 백업으로 API 키 방식 시도
        await sendMessageToYouTube(message);
        showStatus('✅ API 키 방식으로 메시지가 전송되었습니다!', 'success');
        document.getElementById('manual-message').value = '';
        
    } catch (error) {
        console.error('YouTube 전송 실패:', error);
        showStatus(`❌ 전송 실패: ${error.message}`, 'error');
        
        // OAuth 로그인 안내
        if (!isOAuthSignedIn) {
            showStatus('💡 Google OAuth 로그인을 하면 더 안정적으로 전송됩니다.', 'info', 5000);
        }
    }
}

function startAutoSend() {
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return;
    }
    
    const interval = parseInt(document.getElementById('auto-send-interval').value) * 1000;
    if (interval < 30000) {
        showStatus('자동 전송 간격은 최소 30초여야 합니다', 'error');
        return;
    }
    
    isAutoSending = true;
    document.getElementById('auto-start-btn').disabled = true;
    document.getElementById('auto-stop-btn').disabled = false;
    
    autoSendInterval = setInterval(() => {
        updateLiveSummary();
        const summaryMessage = document.getElementById('live-summary').textContent;
        document.getElementById('manual-message').value = summaryMessage;
        sendToYouTube();
    }, interval);
    
    showStatus(`✅ 자동 전송이 시작되었습니다 (${interval/1000}초 간격)`, 'success');
}

function stopAutoSend() {
    if (autoSendInterval) {
        clearInterval(autoSendInterval);
        autoSendInterval = null;
    }
    
    isAutoSending = false;
    document.getElementById('auto-start-btn').disabled = false;
    document.getElementById('auto-stop-btn').disabled = true;
    
    showStatus('자동 전송이 중지되었습니다', 'info');
}

// --- 챗봇 관련 함수 ---
function updateLiveSummary() {
    const summaryText = document.getElementById('summary-output').textContent;
    document.getElementById('live-summary').textContent = summaryText;
    if (!isAutoSending) {
        showStatus('실시간 현황이 업데이트되었습니다', 'success');
    }
}

function generateQuickMessage(type) {
    let message = '';
    const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
    const donorCount = new Set(donations.map(d => d.donor)).size;
    
    switch(type) {
        case 'welcome':
            message = `🔥🏫삼용스쿨에 오신 것을 환영합니다🏫🔥 현재 총 ${formatAmount(totalAmount)}만원이 모였습니다! 감사합니다💕`;
            break;
        case 'thanks':
            message = `💝 ${donorCount}분의 후원자님들 덕분에 총 ${formatAmount(totalAmount)}만원이 모였습니다! 정말 감사해요🙏✨`;
            break;
        case 'goal':
            const runningMissions = Object.values(missionData).filter(m => m.status === 'running');
            if (runningMissions.length > 0) {
                const missionTexts = runningMissions.map(mission => {
                    const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
                    const currentAmount = missionDonations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
                    const remaining = Math.max(0, parseFloat(mission.target) - currentAmount);
                    return `${emojis[mission.streamer] || ''}${mission.streamer} ${formatAmount(remaining)}만 남음`;
                }).join(', ');
                message = `🎯 퇴근미션 진행중! ${missionTexts} 화이팅!🔥`;
            } else {
                message = `🎯 현재 진행중인 퇴근미션이 없습니다. 스트리머들 화이팅!🔥`;
            }
            break;
        case 'mission':
            const missionSummary = document.getElementById('mission-summary-output').textContent;
            message = missionSummary !== '진행 중인 미션이 없습니다.' ? missionSummary : '🎄 새로운 퇴근미션을 기다려주세요! 🎄';
            break;
    }
    
    document.getElementById('manual-message').value = message;
    showStatus(`${type} 메시지가 생성되었습니다`, 'success');
}

function copyMessageToClipboard() {
    const message = document.getElementById('manual-message').value.trim();
    if (!message) {
        showStatus('복사할 메시지가 없습니다', 'error');
        return;
    }
    
    navigator.clipboard.writeText(message).then(() => {
        showStatus('메시지가 클립보드에 복사되었습니다! 채팅에 붙여넣으세요 (Ctrl+V)', 'success', 5000);
    }).catch(() => {
        // 복사 실패시 텍스트 선택
        const textarea = document.getElementById('manual-message');
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        showStatus('메시지를 선택했습니다. Ctrl+C로 복사하세요', 'warning');
    });
}

function clearMessage() {
    document.getElementById('manual-message').value = '';
    showStatus('메시지가 지워졌습니다', 'info');
}

// --- 권한 관리 함수 ---
function updateChatbotPermissionUI() {
    const statusEl = document.getElementById('chatbot-permission-status');
    if (!statusEl) {
        console.warn('chatbot-permission-status 요소를 찾을 수 없습니다.');
        return;
    }
    
    try {
        const hasPermission = user.isAdmin || currentPassword;
        
        if (hasPermission) {
            statusEl.innerHTML = '✅ <span style="color: #42b72a;">권한있음</span>';
            statusEl.title = '챗봇 자동 알림을 사용할 수 있습니다';
        } else {
            statusEl.innerHTML = '🔒 <span style="color: #fa383e;">권한필요</span>';
            statusEl.title = '챗봇 자동 알림을 사용하려면 비밀번호를 입력하세요';
        }
    } catch (error) {
        console.error('챗봇 권한 UI 업데이트 실패:', error);
    }
}

function hasWritePermission() {
    return isAdminVerified;
}

// --- 미션 관련 함수 ---
async function toggleMission(streamer) {
    const mission = missionData[streamer] || { streamer, status: 'stopped', target: 0 };
    const targetAmount = parseFloat(document.getElementById(`mission-target-${streamer}`).value);

    const isRunning = mission.status === 'running';
    if (!isRunning && (isNaN(targetAmount) || targetAmount <= 0)) {
        return showStatus('목표 금액을 먼저 올바르게 설정해주세요.', 'error');
    }

    mission.status = isRunning ? 'stopped' : 'running';
    if (mission.status === 'running') {
        mission.startTime = Date.now();
        mission.target = targetAmount;
        mission.completedTime = null;
    }
    
    missionData[streamer] = mission;
    saveToLocalStorage();
    updateMissionSettingsUI();
    updateMissionSummary();
    
    showStatus(`${streamer}의 미션이 ${mission.status === 'running' ? '시작' : '중지'}되었습니다`, 'success');
}

async function saveAllMissions() {
    const missionStreamers = (streamers || []).filter(s => s !== '국고');
    for (const streamer of missionStreamers) {
        const targetAmountInput = document.getElementById(`mission-target-${streamer}`);
        if(targetAmountInput) {
            const targetAmount = parseFloat(targetAmountInput.value) || 0;
            if (!missionData[streamer]) {
                missionData[streamer] = { streamer: streamer, status: 'stopped', target: 0 };
            }
            missionData[streamer].target = targetAmount;
        }
    }
    
    saveToLocalStorage();
    updateMissionSettingsUI();
    showStatus('모든 미션 목표가 저장되었습니다', 'success');
}

async function stopAllMissions() {
    if (!confirm('현재 진행 중인 모든 미션을 중지하시겠습니까?')) return;

    Object.values(missionData).forEach(mission => {
        if (mission.status === 'running') {
            mission.status = 'stopped';
        }
    });
    
    saveToLocalStorage();
    updateMissionSettingsUI();
    updateMissionSummary();
    showStatus('모든 미션이 중지되었습니다', 'success');
}

// --- 오버레이 관리 함수 ---

// 서버 설정 적용 중인지 확인하는 플래그
let isApplyingServerSettings = false;

// 서버 설정을 UI에 적용하는 함수
function applyServerSettingsToUI(settings) {
    if (!settings) return;
    
    // 무한 루프 방지를 위한 플래그 설정
    isApplyingServerSettings = true;
    
    try {
        // 후원자 오버레이 설정
        if (settings['overlay-font-size']) {
            const fontSize = String(settings['overlay-font-size']);
            document.getElementById('overlay-font-size-range').value = fontSize;
            document.getElementById('overlay-font-size-value').textContent = fontSize + 'px';
        }
        
        if (settings['overlay-stroke-width']) {
            const strokeWidth = String(settings['overlay-stroke-width']);
            document.getElementById('overlay-stroke-width-range').value = strokeWidth;
            document.getElementById('overlay-stroke-width-value').textContent = strokeWidth + 'px';
        }
        
        if (settings['overlay-text-align']) {
            const textAlign = settings['overlay-text-align'];
            // 정렬 버튼 상태 업데이트
            document.getElementById('overlay-align-left').style.background = '';
            document.getElementById('overlay-align-center').style.background = '';
            document.getElementById('overlay-align-right').style.background = '';
            
            const selectedButton = document.getElementById(`overlay-align-${textAlign}`);
            if (selectedButton) {
                selectedButton.style.background = '#1877f2';
                selectedButton.style.color = 'white';
            }
        }
        
        // 테이블 오버레이 설정
        if (settings['table-opacity']) {
            const opacity = String(settings['table-opacity']);
            document.getElementById('table-opacity-range').value = opacity;
            document.getElementById('table-opacity-value').textContent = opacity + '%';
        }
        
        if (settings['table-number-size']) {
            const numberSize = String(settings['table-number-size']);
            document.getElementById('table-number-size-range').value = numberSize;
            document.getElementById('table-number-size-value').textContent = numberSize + 'px';
        }
        
        if (settings['table-font-size']) {
            const fontSize = String(settings['table-font-size']);
            document.getElementById('table-font-size-range').value = fontSize;
            document.getElementById('table-font-size-value').textContent = fontSize + 'px';
        }
        
        // 같은 금액 묶기 설정 (중요: 무한루프 방지)
        if (settings.groupThreshold !== undefined) {
            const groupThreshold = String(settings.groupThreshold);
            document.getElementById('group-threshold').value = groupThreshold;
            localStorage.setItem('group-threshold', groupThreshold);
        }
        
        console.log('✅ [관리자] 서버 설정이 UI에 적용되었습니다:', settings);
        
    } catch (error) {
        console.error('❌ [관리자] 서버 설정 UI 적용 실패:', error);
    } finally {
        // 플래그 해제
        isApplyingServerSettings = false;
    }
}

function openOverlay(type) {
    const overlayUrl = getOverlayURL(type);
    if (overlayUrl) {
        window.open(overlayUrl, '_blank', 'width=800,height=600');
    }
}

// 오버레이 URL 생성
function getOverlayURL(type) {
    const baseUrl = 'https://donation-manager-ufm1.onrender.com/';
    
    if (type === 'donor') {
        return baseUrl + 'donor-overlay.html';
    } else if (type === 'table') {
        return baseUrl + 'streamer-table-overlay.html';
    } else if (type === 'total-only') {
        return baseUrl + 'total-only-overlay.html';
    } else if (type === 'graph') {
        return baseUrl + 'mission-graph-overlay.html';
    } else if (type === 'total-goal') {
        return baseUrl + 'total-goal-overlay.html';
    }
    return '';
}

// URL 복사 기능
async function copyOverlayURL(type) {
    const url = getOverlayURL(type);
    
    try {
        await navigator.clipboard.writeText(url);
        showStatus(`${type === 'donor' ? '후원자' : '테이블'} 오버레이 URL이 클립보드에 복사되었습니다!`, 'success');
    } catch (err) {
        // 클립보드 API가 안 되면 텍스트 선택
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showStatus(`${type === 'donor' ? '후원자' : '테이블'} 오버레이 URL이 복사되었습니다!`, 'success');
    }
}

// QR코드 생성 및 표시
function showQRCode(type) {
    const url = getOverlayURL(type);
    const typeName = type === 'donor' ? '후원자별 총액' : 
                     type === 'table' ? '스트리머 테이블' : 
                     type === 'total-only' ? '총액만 전용' :
                     type === 'graph' ? '퇴근미션 그래프' : 
                     type === 'total-goal' ? '총액 목표' : '오버레이';
    
    // QR코드 생성 (Google Charts API 사용)
    const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent(url)}`;
    
    // 모달 생성
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
        align-items: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">📱 ${typeName} 오버레이</h3>
            <img src="${qrUrl}" alt="QR Code" style="width: 250px; height: 250px; border: 1px solid #ddd; border-radius: 8px;">
            <p style="margin: 15px 0 10px 0; font-size: 12px; color: #666; word-break: break-all;">${url}</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="copyOverlayURL('${type}')" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">📋 URL 복사</button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">닫기</button>
            </div>
        </div>
    `;
    
    // 배경 클릭 시 모달 닫기
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

// 모든 오버레이 한번에 열기
function openAllOverlays() {
    openOverlay('donor');
    setTimeout(() => openOverlay('table'), 500);
    setTimeout(() => openOverlay('total-only'), 750);
    setTimeout(() => openOverlay('graph'), 1000);
    showStatus('모든 오버레이가 새 창에서 열렸습니다!', 'info');
}

// 실시간 미리보기 토글
let previewEnabled = false;
function togglePreview() {
    const previewArea = document.getElementById('preview-area');
    const toggleButton = document.getElementById('preview-toggle');
    
    previewEnabled = !previewEnabled;
    
    if (previewEnabled) {
        previewArea.style.display = 'block';
        toggleButton.textContent = '👁️ 실시간 미리보기 끄기';
        toggleButton.className = 'btn btn-danger';
        
        // iframe 소스 설정
        document.getElementById('donor-preview').src = getOverlayURL('donor');
        document.getElementById('table-preview').src = getOverlayURL('table');
        
        showStatus('실시간 미리보기가 활성화되었습니다', 'info');
    } else {
        previewArea.style.display = 'none';
        toggleButton.textContent = '👁️ 실시간 미리보기 켜기';
        toggleButton.className = 'btn btn-info';
        
        // iframe 소스 제거 (성능 향상)
        document.getElementById('donor-preview').src = '';
        document.getElementById('table-preview').src = '';
        
        showStatus('실시간 미리보기가 비활성화되었습니다', 'info');
    }
}

function updateOverlayFontSize(value) {
    document.getElementById('overlay-font-size-value').textContent = value + 'px';
    updateServerSettings({ 'overlay-font-size': value });
}

function updateOverlayStrokeWidth(value) {
    document.getElementById('overlay-stroke-width-value').textContent = value + 'px';
    updateServerSettings({ 'overlay-stroke-width': value });
}

function setOverlayTextAlign(align) {
    // 모든 정렬 버튼의 스타일 초기화
    document.getElementById('overlay-align-left').style.background = '';
    document.getElementById('overlay-align-center').style.background = '';
    document.getElementById('overlay-align-right').style.background = '';
    
    // 선택된 버튼 강조
    document.getElementById(`overlay-align-${align}`).style.background = '#1877f2';
    document.getElementById(`overlay-align-${align}`).style.color = 'white';
    
    // 실시간 적용 - 서버로만 전송
    updateServerSettings({ 'overlay-text-align': align });
}

function updateTableOpacity(value) {
    document.getElementById('table-opacity-value').textContent = value + '%';
    updateServerSettings({ 'table-opacity': value });
}

function updateTableNumberSize(value) {
    document.getElementById('table-number-size-value').textContent = value + 'px';
    updateServerSettings({ 'table-number-size': value });
}

function updateTableFontSize(value) {
    document.getElementById('table-font-size-value').textContent = value + 'px';
    updateServerSettings({ 'table-font-size': value });
}

function setTableTextColor(color) {
    updateServerSettings({ 'table-text-color': color });
    showStatus(`테이블 글자 색상이 변경되었습니다`, 'success');
}

// 서버에 설정 업데이트 전송
async function updateServerSettings(settings) {
    // 서버 설정 적용 중이면 무한 루프 방지
    if (isApplyingServerSettings) {
        console.log('🚫 [관리자] 서버 설정 적용 중이므로 업데이트 건너뜀:', settings);
        return;
    }
    
    try {
        console.log('⚙️ [관리자] 서버 설정 업데이트 전송:', settings);
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ settings })
        });
        
        if (response.ok) {
            console.log('✅ [관리자] 서버 설정 업데이트 성공');
        } else {
            console.warn('⚠️ [관리자] 서버 설정 업데이트 실패');
        }
    } catch (error) {
        console.error('❌ [관리자] 서버 설정 업데이트 오류:', error);
    }
}

function applyOverlaySettings() {
    showStatus('후원자별 총액 오버레이 설정이 적용되었습니다 (실시간 반영)', 'success');
}

function resetOverlaySettings() {
    document.getElementById('overlay-font-size-range').value = '16';
    document.getElementById('overlay-stroke-width-range').value = '2';
    updateOverlayFontSize('16');
    updateOverlayStrokeWidth('2');
    setOverlayTextAlign('left');
    
    // 기본값으로 서버 설정 업데이트
    updateServerSettings({ 
        'overlay-font-size': '16',
        'overlay-stroke-width': '2',
        'overlay-text-align': 'left'
    });
    
    showStatus('후원자별 총액 오버레이 설정이 기본값으로 복원되었습니다', 'info');
}

function setTableColorPreset(preset) {
    updateServerSettings({ 'table-color-preset': preset });
    showStatus(`테이블 색상이 ${preset}로 설정되었습니다`, 'success');
}

function applyTableSettings() {
    showStatus('스트리머 테이블 오버레이 설정이 적용되었습니다 (실시간 반영)', 'success');
}

function resetTableSettings() {
    document.getElementById('table-opacity-range').value = '85';
    document.getElementById('table-number-size-range').value = '16';
    document.getElementById('table-font-size-range').value = '14';
    updateTableOpacity('85');
    updateTableNumberSize('16');
    updateTableFontSize('14');
    
    // 기본값으로 서버 설정 업데이트
    updateServerSettings({
        'table-opacity': '85',
        'table-number-size': '16', 
        'table-font-size': '14',
        'table-text-color': 'white',
        'table-color-preset': 'dark'
    });
    
    showStatus('스트리머 테이블 오버레이 설정이 기본값으로 복원되었습니다', 'info');
}

function loadOverlaySettings() {
    // 서버 설정이 Socket.IO를 통해 로드되므로 기본값만 설정
    // 실제 값은 socket.on('initialData') 에서 처리됨
    
    // 후원자별 총액 오버레이 기본값
    document.getElementById('overlay-font-size-range').value = '18';
    document.getElementById('overlay-stroke-width-range').value = '3';
    document.getElementById('overlay-font-size-value').textContent = '18px';
    document.getElementById('overlay-stroke-width-value').textContent = '3px';
    setOverlayTextAlign('left');
    
    // 스트리머 테이블 오버레이 기본값
    document.getElementById('table-opacity-range').value = '85';
    document.getElementById('table-number-size-range').value = '16';
    document.getElementById('table-font-size-range').value = '14';
    document.getElementById('table-opacity-value').textContent = '85%';
    document.getElementById('table-number-size-value').textContent = '16px';
    document.getElementById('table-font-size-value').textContent = '14px';
    
    // 그룹화 임계값은 loadTableSettings에서 처리
    
    // 스트리머 총액 설정 로드
    loadStreamerSummarySettings();
    
    // 테이블 설정 로드
    loadTableSettings();
}

// --- 오버레이 컨트롤 초기화 ---
function initializeOverlayControls() {
    const totalOnlyCheckbox = document.getElementById('overlay-total-only-mode');
    if (!totalOnlyCheckbox) return;
    
    // 로컬스토리지에서 설정 복원
    const savedMode = localStorage.getItem('overlayTotalOnlyMode');
    if (savedMode === 'true') {
        totalOnlyCheckbox.checked = true;
    }
    
    // 체크박스 이벤트 바인딩
    totalOnlyCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        
        // 로컬스토리지에 저장
        localStorage.setItem('overlayTotalOnlyMode', isChecked.toString());
        
        // Socket.IO로 모든 오버레이에 설정 전송
        if (window.socket && window.socket.connected) {
            window.socket.emit('overlayTotalOnlyMode', isChecked);
            console.log('오버레이 총액만 모드:', isChecked);
        }
        
        showStatus(
            isChecked ? '오버레이가 총액만 표시 모드로 변경되었습니다.' : '오버레이가 전체 보기 모드로 변경되었습니다.', 
            'success'
        );
    });
}

// --- 스트리머 총액 설정 관련 함수 ---
function toggleStreamerSummarySettings() {
    const settingsDiv = document.getElementById('streamer-summary-settings');
    const isVisible = settingsDiv.style.display !== 'none';
    settingsDiv.style.display = isVisible ? 'none' : 'block';
}

function loadStreamerSummarySettings() {
    const savedHeader = localStorage.getItem('streamer-summary-header') || '🔥🏫삼용스쿨🏫🔥';
    const savedFooter = localStorage.getItem('streamer-summary-footer') || '🏧투네/계좌 [8:2] 🎉슈퍼챗은 국고로~!';
    const savedExcludeGukgo = localStorage.getItem('exclude-gukgo') === null ? false : localStorage.getItem('exclude-gukgo') === 'true'; // 기본값: false (국고 포함)
    
    document.getElementById('streamer-summary-header').value = savedHeader;
    document.getElementById('streamer-summary-footer').value = savedFooter;
    document.getElementById('exclude-gukgo').checked = savedExcludeGukgo;
}

function saveStreamerSummarySettings() {
    const headerText = document.getElementById('streamer-summary-header').value.trim();
    const footerText = document.getElementById('streamer-summary-footer').value.trim();
    const excludeGukgo = document.getElementById('exclude-gukgo').checked;
    
    localStorage.setItem('streamer-summary-header', headerText);
    localStorage.setItem('streamer-summary-footer', footerText);
    localStorage.setItem('exclude-gukgo', excludeGukgo.toString());
    
    // 설정 적용을 위해 요약 업데이트
    updateSummary();
    
    showStatus('스트리머 총액 설정이 저장되었습니다', 'success');
}

function resetStreamerSummarySettings() {
    document.getElementById('streamer-summary-header').value = '🔥🏫삼용스쿨🏫🔥';
    document.getElementById('streamer-summary-footer').value = '🏧투네/계좌 [8:2] 🎉슈퍼챗은 국고로~!';
    document.getElementById('exclude-gukgo').checked = false; // 기본값: 국고 포함
    
    localStorage.removeItem('streamer-summary-header');
    localStorage.removeItem('streamer-summary-footer');
    localStorage.removeItem('exclude-gukgo');
    
    // 강제로 국고 포함 설정 (기존 사용자 대응)
    localStorage.setItem('exclude-gukgo', 'false');
    
    // 설정 적용을 위해 요약 업데이트
    updateSummary();
    
    showStatus('스트리머 총액 설정이 기본값으로 복원되었습니다 (국고 포함)', 'info');
}

// --- 테이블 설정 관련 함수 ---
function toggleTableSettings() {
    const settingsDiv = document.getElementById('table-settings');
    const isVisible = settingsDiv.style.display !== 'none';
    settingsDiv.style.display = isVisible ? 'none' : 'block';
}

async function loadTableSettings() {
    // 먼저 서버에서 설정 로드 시도
    let serverSettings = null;
    try {
        const response = await fetch('/api/data');
        const data = await response.json();
        serverSettings = data.settings || {};
    } catch (error) {
        console.log('서버 설정 로드 실패, 로컬 설정 사용:', error);
    }
    
    // 서버 설정이 있으면 우선 사용, 없으면 로컬 설정 사용
    const savedTitle = serverSettings?.tableTitle || localStorage.getItem('table-title') || '🏆 스트리머별 후원 현황 🏆';
    const savedShowTotalRow = serverSettings?.showTotalRow ?? (localStorage.getItem('show-total-row') !== 'false'); // 기본값: true
    const savedShowUpdateTime = serverSettings?.showUpdateTime ?? (localStorage.getItem('show-update-time') === 'true'); // 기본값: false
    const savedRankCount = serverSettings?.rankCount || parseInt(localStorage.getItem('rank-count') || '10');
    
    document.getElementById('table-title-input').value = savedTitle;
    document.getElementById('show-total-row').checked = savedShowTotalRow;
    document.getElementById('show-update-time').checked = savedShowUpdateTime;
    document.getElementById('rank-count').value = savedRankCount;
    
    // 서버에서 순번명도 로드
    if (serverSettings?.rankNames) {
        for (const [rank, name] of Object.entries(serverSettings.rankNames)) {
            localStorage.setItem(`rank-${rank}-name`, name); // 로컬에도 백업
        }
    }
    
    // 그룹화 임계값 로드 (서버 설정 우선)
    const savedGroupThreshold = serverSettings?.groupThreshold || parseInt(localStorage.getItem('group-threshold') || '2');
    document.getElementById('group-threshold').value = savedGroupThreshold;
    localStorage.setItem('group-threshold', savedGroupThreshold.toString()); // 로컬에도 백업
    
    // 슈퍼챗 포함 설정 로드 (서버 설정 우선)
    const savedIncludeSuperchat = serverSettings?.includeSuperchat !== undefined ? 
        serverSettings.includeSuperchat : (localStorage.getItem('include-superchat') === 'true');
    document.getElementById('include-superchat').checked = savedIncludeSuperchat;
    localStorage.setItem('include-superchat', savedIncludeSuperchat.toString()); // 로컬에도 백업
    
    // 순번명 입력 필드 생성 및 로드
    updateRankInputs();
}

function updateRankInputs() {
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    const container = document.getElementById('rank-inputs-container');
    
    // 기존 입력 필드들 제거
    container.innerHTML = '';
    
    // 새로운 입력 필드들 생성
    for (let i = 1; i <= rankCount; i++) {
        const savedRankName = localStorage.getItem(`rank-${i}-name`) || i.toString();
        
        const inputDiv = document.createElement('div');
        inputDiv.innerHTML = `
            <input type="text" 
                   id="rank-${i}-name" 
                   class="form-input" 
                   placeholder="${i}등 (예: ${getRankPresetExample('royalty', i)})" 
                   value="${savedRankName}">
        `;
        container.appendChild(inputDiv);
    }
}

function getRankPresetExample(preset, rank) {
    const presets = {
        'royalty': ['왕자', '귀족', '기사', '농민', '거지', '벌레', '개미', '먼지', '흙', '돌'],
        'flowers': ['장미', '벚꽃', '해바라기', '튤립', '데이지', '풀', '이끼', '잡초', '민들레', '클로버'],
        'animals': ['사자', '호랑이', '늑대', '여우', '토끼', '다람쥐', '햄스터', '벌레', '개미', '바퀴벌레']
    };
    
    const presetArray = presets[preset] || [];
    return presetArray[rank - 1] || `${rank}등`;
}

async function saveTableSettings() {
    const tableTitle = document.getElementById('table-title-input').value.trim();
    const showTotalRow = document.getElementById('show-total-row').checked;
    const showUpdateTime = document.getElementById('show-update-time').checked;
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    
    // 로컬에도 저장 (호환성)
    localStorage.setItem('table-title', tableTitle);
    localStorage.setItem('show-total-row', showTotalRow.toString());
    localStorage.setItem('show-update-time', showUpdateTime.toString());
    localStorage.setItem('rank-count', rankCount.toString());
    
    // 순번명 수집
    const rankNames = {};
    for (let i = 1; i <= rankCount; i++) {
        const rankInput = document.getElementById(`rank-${i}-name`);
        if (rankInput) {
            const rankName = rankInput.value.trim();
            localStorage.setItem(`rank-${i}-name`, rankName); // 로컬에도 저장
            if (rankName) {
                rankNames[i] = rankName;
            }
        }
    }
    
    // 서버에 설정 저장
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                settings: {
                    tableTitle: tableTitle,
                    showTotalRow: showTotalRow,
                    showUpdateTime: showUpdateTime,
                    rankCount: rankCount,
                    rankNames: rankNames
                }
            })
        });
        
        if (response.ok) {
            showStatus('테이블 설정이 서버에 저장되었습니다', 'success');
        } else {
            showStatus('서버 저장 실패, 로컬에만 저장되었습니다', 'warning');
        }
    } catch (error) {
        console.error('서버 설정 저장 실패:', error);
        showStatus('서버 저장 실패, 로컬에만 저장되었습니다', 'warning');
    }
    
    // 설정 적용을 위해 테이블 업데이트
    updateDetailedSummaryTable();
}

function resetTableSettings() {
    document.getElementById('table-title-input').value = '🏆 스트리머별 후원 현황 🏆';
    document.getElementById('show-total-row').checked = true;
    document.getElementById('show-update-time').checked = false;
    document.getElementById('rank-count').value = '10';
    
    // 기존 순번명 설정 모두 제거
    for (let i = 1; i <= 20; i++) {
        localStorage.removeItem(`rank-${i}-name`);
    }
    
    localStorage.removeItem('table-title');
    localStorage.removeItem('show-total-row');
    localStorage.removeItem('show-update-time');
    localStorage.removeItem('rank-count');
    
    // 순번명 입력 필드 재생성
    updateRankInputs();
    
    // 설정 적용을 위해 테이블 업데이트
    updateDetailedSummaryTable();
    
    showStatus('테이블 설정이 기본값으로 복원되었습니다', 'info');
}

function setRankPreset(preset) {
    const presets = {
        'royalty': ['👑왕자', '🤴귀족', '🧙‍♂️기사', '👨‍🌾농민', '🥺거지', '🐛벌레', '🐜개미', '💨먼지', '🪨흙', '⚫돌', '🕳️구멍', '👻유령', '💀해골', '🦴뼈', '🗑️쓰레기', '💩똥', '🦠세균', '⚛️원자', '🔬분자', '〰️허공'],
        'flowers': ['🌹장미', '🌸벚꽃', '🌻해바라기', '🌷튤립', '🌼데이지', '🌿풀', '🍀클로버', '🌱새싹', '🌾벼', '🎋대나무', '🌵선인장', '🌰도토리', '🍄버섯', '🦠세균', '🏔️돌', '⚫흙', '💨바람', '〰️공기', '🕳️빈공간', '👻무'],
        'animals': ['🦁사자', '🐅호랑이', '🐺늑대', '🦊여우', '🐰토끼', '🐿️다람쥐', '🐹햄스터', '🐛벌레', '🐜개미', '🪳바퀴벌레', '🦗귀뚜라미', '🕷️거미', '🦟모기', '🪰파리', '🐌달팽이', '🐛애벌레', '🦠세균', '⚛️원자', '〰️무', '🕳️없음'],
        'numbers': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']
    };
    
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    const presetArray = presets[preset] || [];
    
    for (let i = 1; i <= rankCount; i++) {
        const rankInput = document.getElementById(`rank-${i}-name`);
        if (rankInput) {
            const presetValue = presetArray[i - 1] || i.toString();
            rankInput.value = presetValue;
        }
    }
    
    const presetNames = {
        'royalty': '👑 왕족',
        'flowers': '🌸 꽃이름',
        'animals': '🐾 동물',
        'numbers': '🔢 숫자'
    };
    
    showStatus(`${presetNames[preset]} 프리셋이 적용되었습니다. 저장 버튼을 눌러주세요.`, 'info');
}

// --- OAuth 관련 함수들 ---
// Google OAuth 로그인/로그아웃
async function signInGoogleOAuth() {
    try {
        console.log('🔐 새로운 Google Identity Services 로그인 시도...');
        showStatus('Google 로그인 중...', 'info');
        
        // 기존 OAuth2 방식 대신 Google Identity Services 사용
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
            throw new Error('Google Identity Services가 로드되지 않았습니다');
        }
        
        // 새로운 방식의 OAuth 토큰 요청
        const tokenResponse = await new Promise((resolve, reject) => {
            const client = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.CLIENT_ID,
                scope: GOOGLE_CONFIG.SCOPES,
                callback: (response) => {
                    if (response.error) {
                        reject(response);
                    } else {
                        resolve(response);
                    }
                },
                error_callback: (error) => {
                    reject(error);
                }
            });
            
            // 토큰 요청
            client.requestAccessToken({
                prompt: 'consent',
                hint: 'Select your Google account'
            });
        });
        
        console.log('✅ OAuth 토큰 획득 성공:', tokenResponse);
        
        // YouTube API 키와 토큰 저장
        window.accessToken = tokenResponse.access_token;
        isOAuthSignedIn = true;
        
        // 사용자 정보 가져오기 (선택사항)
        try {
            const userInfoResponse = await fetch(`https://www.googleapis.com/oauth2/v2/userinfo?access_token=${tokenResponse.access_token}`);
            const userInfo = await userInfoResponse.json();
            console.log('✅ 사용자 정보:', userInfo);
        } catch (userError) {
            console.warn('사용자 정보 가져오기 실패:', userError);
        }
        
        updateGoogleAuthStatus();
        showStatus('✅ Google OAuth 로그인 성공! YouTube API 사용 가능합니다.', 'success');
        
    } catch (error) {
        // 상세한 에러 정보 로깅
        console.error('🚨 Google OAuth 로그인 실패 - 상세 정보:');
        console.error('에러 타입:', typeof error);
        console.error('에러 객체:', error);
        console.error('에러 문자열:', JSON.stringify(error, null, 2));
        
        // 에러 속성들 개별 확인
        if (error) {
            console.error('error.error:', error.error);
            console.error('error.message:', error.message);
            console.error('error.details:', error.details);
            console.error('error.code:', error.code);
            console.error('error.status:', error.status);
        }
        
        // authInstance 상태 확인
        console.error('authInstance 상태:', {
            exists: !!authInstance,
            isSignedIn: authInstance ? authInstance.isSignedIn.get() : 'N/A',
            currentUser: authInstance ? authInstance.currentUser.get() : 'N/A'
        });
        
        // 더 자세한 오류 정보 제공
        let errorMessage = 'OAuth 로그인 실패';
        let errorType = 'error';
        
        if (error?.error === 'popup_closed_by_user' || error?.message?.includes('closed_by_user')) {
            errorMessage = '❌ 로그인 팝업이 닫혔습니다. 다시 시도해주세요.';
            errorType = 'warning';
        } else if (error?.error === 'access_denied' || error?.message?.includes('access_denied')) {
            errorMessage = '❌ 접근이 거부되었습니다. 권한을 다시 확인해주세요.';
            errorType = 'error';
        } else if (error?.error === 'popup_blocked' || error?.message?.includes('popup')) {
            errorMessage = '❌ 팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용해주세요.';
            errorType = 'warning';
        } else if (error?.error === 'network_error' || error?.message?.includes('network')) {
            errorMessage = '❌ 네트워크 연결 문제가 발생했습니다. 인터넷 연결을 확인해주세요.';
            errorType = 'warning';
        } else {
            // 일반적인 오류 메시지
            const errorText = error?.error || error?.message || error?.toString() || 'Unknown error';
            errorMessage = `❌ OAuth 로그인 실패: ${errorText}`;
        }
        
        showStatus(errorMessage, errorType);
        
        // 해결방법 안내
        setTimeout(() => {
            showStatus('💡 해결방법: 1) 팝업 허용, 2) 시크릿 모드 시도, 3) 다른 브라우저 사용, 4) 페이지 새로고침', 'info', 15000);
        }, 3000);
        
        // OAuth 상태 업데이트
        isOAuthSignedIn = false;
        updateGoogleAuthStatus();
    }
}

async function signOutGoogleOAuth() {
    try {
        if (!authInstance) {
            showStatus('Google API가 초기화되지 않았습니다', 'error');
            return;
        }
        
        await authInstance.signOut();
        showStatus('Google OAuth 로그아웃되었습니다', 'info');
        
    } catch (error) {
        console.error('Google OAuth 로그아웃 실패:', error);
        showStatus(`Google OAuth 로그아웃 실패: ${error.message}`, 'error');
    }
}

// Google OAuth 상태 업데이트
function updateGoogleAuthStatus() {
    const statusElement = document.getElementById('google-auth-status');
    if (!statusElement) {
        console.log('google-auth-status 요소를 찾을 수 없습니다. 챗봇 탭이 로드되지 않았을 수 있습니다.');
        return;
    }
    
    try {
        if (isOAuthSignedIn) {
            statusElement.className = 'status status-success';
            statusElement.innerHTML = '✅ <strong>Google OAuth 로그인됨</strong>: 다음 단계로 진행하세요! <button onclick="signOutGoogleOAuth()" class="btn btn-secondary" style="margin-left:10px;">로그아웃</button>';
            // 2단계로 이동
            showChatbotStep(2);
        } else {
            statusElement.className = 'status status-warning';
            statusElement.innerHTML = '🔐 <strong>Google OAuth 로그인 필요</strong>: YouTube API 사용을 위해 로그인하세요. <button onclick="signInGoogleOAuth()" class="btn btn-primary" style="margin-left:10px;">로그인</button>';
            // 1단계로 이동
            showChatbotStep(1);
        }
    } catch (error) {
        console.error('Google Auth 상태 업데이트 실패:', error);
    }
}

// 챗봇 단계별 UI 전환
function showChatbotStep(step) {
    // 모든 단계 숨기기
    for (let i = 1; i <= 3; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
            stepElement.style.display = 'none';
        }
    }
    
    // 현재 단계까지 보이기
    for (let i = 1; i <= step; i++) {
        const stepElement = document.getElementById(`step-${i}`);
        if (stepElement) {
            stepElement.style.display = 'block';
        }
    }
}

// 고급 설정 토글
function toggleAdvancedSettings() {
    const settingsDiv = document.getElementById('advanced-settings');
    const toggleBtn = document.getElementById('advanced-toggle');
    
    if (settingsDiv.style.display === 'none') {
        settingsDiv.style.display = 'block';
        toggleBtn.innerHTML = '⚙️ 고급 설정 숨기기';
    } else {
        settingsDiv.style.display = 'none';
        toggleBtn.innerHTML = '⚙️ 고급 설정 표시';
    }
}

// 현재 총액 바로 전송
async function sendCurrentSummary() {
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return;
    }
    
    try {
        // 최신 총액 업데이트
        updateLiveSummary();
        
        // 총액 메시지 가져오기
        const summaryElement = document.getElementById('live-summary');
        const summaryMessage = summaryElement.textContent.trim();
        
        if (!summaryMessage) {
            showStatus('전송할 총액 데이터가 없습니다', 'warning');
            return;
        }
        
        showStatus('총액 전송 중...', 'info');
        
        // OAuth 방식 우선 시도
        if (isOAuthSignedIn) {
            const success = await sendToYouTubeOAuth(summaryMessage);
            if (success) {
                showStatus('✅ 총액이 성공적으로 전송되었습니다!', 'success');
                return;
            }
        }
        
        // 백업으로 API 키 방식 시도
        await sendMessageToYouTube(summaryMessage);
        showStatus('✅ 총액이 성공적으로 전송되었습니다!', 'success');
        
    } catch (error) {
        console.error('총액 전송 실패:', error);
        showStatus(`❌ 총액 전송 실패: ${error.message}`, 'error');
    }
}

// 자동 전송 토글
let autoSendTimer = null;
let isAutoSendActive = false;

function toggleAutoSend() {
    const toggleBtn = document.getElementById('auto-send-toggle');
    const statusDiv = document.getElementById('auto-send-status');
    const intervalSelect = document.getElementById('auto-interval-select');
    
    if (isAutoSendActive) {
        // 자동 전송 중지
        if (autoSendTimer) {
            clearInterval(autoSendTimer);
            autoSendTimer = null;
        }
        
        isAutoSendActive = false;
        toggleBtn.innerHTML = '🚀 시작';
        toggleBtn.className = 'btn btn-success';
        statusDiv.innerHTML = '자동 전송이 비활성화되어 있습니다.';
        statusDiv.className = 'status status-info';
        
        intervalSelect.disabled = false;
        
        showStatus('⏸️ 자동 전송이 중지되었습니다', 'info');
        
    } else {
        // 자동 전송 시작
        if (!liveChatId) {
            showStatus('먼저 라이브 채팅에 연결하세요', 'error');
            return;
        }
        
        const intervalSeconds = parseInt(intervalSelect.value);
        const intervalMs = intervalSeconds * 1000;
        
        isAutoSendActive = true;
        toggleBtn.innerHTML = '⏹️ 중지';
        toggleBtn.className = 'btn btn-danger';
        
        // 시간 표시 로직 개선
        let intervalText;
        if (intervalSeconds >= 3600) {
            intervalText = `${Math.floor(intervalSeconds / 3600)}시간`;
        } else if (intervalSeconds >= 60) {
            intervalText = `${Math.floor(intervalSeconds / 60)}분`;
        } else {
            intervalText = `${intervalSeconds}초`;
        }
        
        statusDiv.innerHTML = `자동 전송 활성화 중 (${intervalText}마다 전송)`;
        statusDiv.className = 'status status-success';
        
        intervalSelect.disabled = true;
        
        // 즉시 한 번 전송
        sendCurrentSummary();
        
        // 주기적 전송 시작
        autoSendTimer = setInterval(() => {
            sendCurrentSummary();
        }, intervalMs);
        
        showStatus(`▶️ 자동 전송 시작 (${intervalText}마다)`, 'success');
    }
}

// 자동 알림 설정 동기화
function syncAutoNotifySettings() {
    const chatbotCheckbox = document.getElementById('chatbot-auto-notify');
    const originalCheckbox = document.getElementById('auto-chat-notify');
    const statusDiv = document.getElementById('auto-notify-status');
    
    if (chatbotCheckbox && originalCheckbox) {
        // 챗봇 탭의 체크박스와 원본 체크박스 동기화
        originalCheckbox.checked = chatbotCheckbox.checked;
        
        // 상태 표시 업데이트
        if (chatbotCheckbox.checked) {
            // 권한 체크
            const hasYouTubeAccess = isOAuthSignedIn || localStorage.getItem('youtube_api_key');
            const hasPermission = isAdminVerified || hasYouTubeAccess;
            
            if (hasPermission && liveChatId) {
                statusDiv.innerHTML = '✅ 후원 등록시 챗봇으로 자동 알림이 전송됩니다.';
                statusDiv.className = 'status status-success';
            } else if (!hasPermission) {
                statusDiv.innerHTML = '⚠️ 자동 알림을 위해 관리자 권한 또는 Google OAuth 로그인이 필요합니다.';
                statusDiv.className = 'status status-warning';
            } else if (!liveChatId) {
                statusDiv.innerHTML = '⚠️ 자동 알림을 위해 라이브 채팅 연결이 필요합니다.';
                statusDiv.className = 'status status-warning';
            }
        } else {
            statusDiv.innerHTML = '후원 자동 알림이 비활성화되어 있습니다.';
            statusDiv.className = 'status status-info';
        }
    }
}

// 페이지 로드시 설정 동기화
function initializeAutoNotifySync() {
    const chatbotCheckbox = document.getElementById('chatbot-auto-notify');
    const originalCheckbox = document.getElementById('auto-chat-notify');
    
    if (chatbotCheckbox && originalCheckbox) {
        // 기존 설정을 챗봇 탭에 반영
        chatbotCheckbox.checked = originalCheckbox.checked;
        syncAutoNotifySettings();
    }
    
    // 관리자 버튼 상태 업데이트
    updateQuickAdminButton();
}

// 빠른 관리자 권한 활성화
function quickEnableAdmin() {
    const adminCheckbox = document.getElementById('admin-verified');
    const quickAdminBtn = document.getElementById('quick-admin-btn');
    
    if (adminCheckbox) {
        if (!isAdminVerified) {
            // 관리자 권한 활성화
            adminCheckbox.checked = true;
            isAdminVerified = true;
            
            quickAdminBtn.innerHTML = '✅ 관리자 권한 활성화됨';
            quickAdminBtn.className = 'btn btn-success';
            quickAdminBtn.disabled = true;
            
            showStatus('✅ 관리자 권한이 활성화되었습니다!', 'success');
            
            // 자동 알림 상태도 업데이트
            syncAutoNotifySettings();
            
        } else {
            showStatus('이미 관리자 권한이 활성화되어 있습니다.', 'info');
        }
    } else {
        showStatus('관리자 체크박스를 찾을 수 없습니다.', 'error');
    }
}

// 빠른 관리자 버튼 상태 업데이트
function updateQuickAdminButton() {
    const quickAdminBtn = document.getElementById('quick-admin-btn');
    
    if (quickAdminBtn) {
        if (isAdminVerified) {
            quickAdminBtn.innerHTML = '✅ 관리자 권한 활성화됨';
            quickAdminBtn.className = 'btn btn-success';
            quickAdminBtn.disabled = true;
        } else {
            quickAdminBtn.innerHTML = '🔓 관리자 권한 활성화';
            quickAdminBtn.className = 'btn btn-primary';
            quickAdminBtn.disabled = false;
        }
    }
}

// 스트리머 총액을 챗봇으로 전송
async function sendStreamerSummaryToChatbot() {
    const btn = document.getElementById('streamer-summary-chatbot-btn');
    
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return;
    }
    
    try {
        // 버튼 비활성화
        btn.disabled = true;
        btn.innerHTML = '📤 전송 중...';
        
        // 스트리머 총액 메시지 가져오기
        const summaryElement = document.getElementById('summary-output');
        let summaryMessage = summaryElement.textContent.trim();
        
        if (!summaryMessage) {
            updateSummary(); // 총액 업데이트 시도
            summaryMessage = summaryElement.textContent.trim();
        }
        
        if (!summaryMessage) {
            showStatus('전송할 스트리머 총액 데이터가 없습니다', 'warning');
            return;
        }
        
        showStatus('스트리머 총액 전송 중...', 'info');
        
        // OAuth 방식 우선 시도
        if (isOAuthSignedIn) {
            const success = await sendToYouTubeOAuth(summaryMessage);
            if (success) {
                showStatus('✅ 스트리머 총액이 성공적으로 전송되었습니다!', 'success');
                return;
            }
        }
        
        // 백업으로 API 키 방식 시도
        await sendMessageToYouTube(summaryMessage);
        showStatus('✅ 스트리머 총액이 성공적으로 전송되었습니다!', 'success');
        
    } catch (error) {
        console.error('스트리머 총액 전송 실패:', error);
        showStatus(`❌ 스트리머 총액 전송 실패: ${error.message}`, 'error');
    } finally {
        // 버튼 복원
        btn.disabled = false;
        btn.innerHTML = '📤 챗봇 전송';
    }
}

// 퇴근미션을 챗봇으로 전송
async function sendMissionSummaryToChatbot() {
    const btn = document.getElementById('mission-summary-chatbot-btn');
    
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return;
    }
    
    try {
        // 버튼 비활성화
        btn.disabled = true;
        btn.innerHTML = '📤 전송 중...';
        
        // 퇴근미션 메시지 가져오기
        const missionElement = document.getElementById('mission-summary-output');
        let missionMessage = missionElement.textContent.trim();
        
        if (!missionMessage) {
            updateMissionSummary(); // 미션 업데이트 시도
            missionMessage = missionElement.textContent.trim();
        }
        
        if (!missionMessage || missionMessage === '진행 중인 미션이 없습니다.') {
            showStatus('현재 진행중인 퇴근미션이 없습니다', 'warning');
            return;
        }
        
        showStatus('퇴근미션 전송 중...', 'info');
        
        // OAuth 방식 우선 시도
        if (isOAuthSignedIn) {
            const success = await sendToYouTubeOAuth(missionMessage);
            if (success) {
                showStatus('✅ 퇴근미션이 성공적으로 전송되었습니다!', 'success');
                return;
            }
        }
        
        // 백업으로 API 키 방식 시도
        await sendMessageToYouTube(missionMessage);
        showStatus('✅ 퇴근미션이 성공적으로 전송되었습니다!', 'success');
        
    } catch (error) {
        console.error('퇴근미션 전송 실패:', error);
        showStatus(`❌ 퇴근미션 전송 실패: ${error.message}`, 'error');
    } finally {
        // 버튼 복원
        btn.disabled = false;
        btn.innerHTML = '📤 챗봇 전송';
    }
}

// OAuth 방식 YouTube API 테스트
async function testYouTubeOAuth() {
    try {
        if (!isOAuthSignedIn) {
            showStatus('먼저 Google OAuth 로그인이 필요합니다', 'error');
            return;
        }
        
        showStatus('YouTube API 테스트 중...', 'info');
        
        // YouTube API 클라이언트가 로드되지 않았다면 다시 로드
        if (!gapi.client.youtube) {
            console.log('YouTube API 클라이언트 재로드 중...');
            await gapi.client.load('youtube', 'v3');
            console.log('✅ YouTube API v3 클라이언트 로드 완료');
        }
        
        const response = await gapi.client.youtube.search.list({
            part: 'snippet',
            q: 'test',
            maxResults: 1
        });
        
        if (response.status === 200) {
            showStatus('✅ YouTube API OAuth 연결 성공!', 'success');
        } else {
            throw new Error('YouTube API 호출 실패');
        }
        
    } catch (error) {
        console.error('YouTube API OAuth 테스트 실패:', error);
        showStatus(`❌ YouTube API OAuth 테스트 실패: ${error.message}`, 'error');
    }
}

// OAuth 방식으로 라이브 채팅 연결
async function connectToLiveChatOAuth() {
    if (!isOAuthSignedIn) {
        showStatus('먼저 Google OAuth 로그인이 필요합니다', 'error');
        return;
    }
    
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('YouTube 영상 ID를 입력하세요', 'error');
        return;
    }
    
    try {
        showStatus('라이브 채팅 연결 중...', 'info');
        
        // YouTube API 클라이언트가 로드되지 않았다면 다시 로드
        if (!gapi.client.youtube) {
            console.log('YouTube API 클라이언트 재로드 중...');
            await gapi.client.load('youtube', 'v3');
            console.log('✅ YouTube API v3 클라이언트 로드 완료');
        }
        
        const response = await gapi.client.youtube.videos.list({
            part: 'liveStreamingDetails',
            id: videoId
        });
        
        const videoData = response.result;
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('영상을 찾을 수 없습니다. 영상 ID를 확인하세요.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('현재 라이브 방송이 아니거나 채팅이 비활성화되어 있습니다.');
        }
        
        liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem('youtube_video_id', videoId);
        
        showStatus('✅ OAuth 방식으로 라이브 채팅에 연결되었습니다!', 'success');
        updateChatbotPermissionUI();
        
        // 3단계로 이동
        showChatbotStep(3);
        
    } catch (error) {
        console.error('OAuth 라이브 채팅 연결 실패:', error);
        let errorMessage = error.message;
        
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube API 권한이 부족합니다. 다시 로그인해보세요.';
            } else if (apiError.code === 404) {
                errorMessage = '영상을 찾을 수 없습니다. 영상 ID를 확인하세요.';
            } else {
                errorMessage = `YouTube API 오류 (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`OAuth 라이브 채팅 연결 실패: ${errorMessage}`, 'error');
    }
}

// OAuth 방식으로 YouTube 채팅에 메시지 전송
async function sendToYouTubeOAuth(message) {
    if (!isOAuthSignedIn) {
        showStatus('먼저 Google OAuth 로그인이 필요합니다', 'error');
        return false;
    }
    
    if (!liveChatId) {
        showStatus('먼저 라이브 채팅에 연결하세요', 'error');
        return false;
    }
    
    try {
        if (!message.trim()) {
            showStatus('전송할 메시지가 없습니다', 'warning');
            return false;
        }
        
        showStatus('YouTube 채팅에 전송 중...', 'info');
        
        // YouTube API 클라이언트가 로드되지 않았다면 다시 로드
        if (!gapi.client.youtube) {
            console.log('YouTube API 클라이언트 재로드 중...');
            await gapi.client.load('youtube', 'v3');
            console.log('✅ YouTube API v3 클라이언트 로드 완료');
        }
        
        const response = await gapi.client.youtube.liveChatMessages.insert({
            part: 'snippet',
            resource: {
                snippet: {
                    liveChatId: liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            }
        });
        
        if (response.status === 200) {
            showStatus('✅ OAuth 방식으로 YouTube 채팅에 전송되었습니다!', 'success');
            return true;
        } else {
            throw new Error('메시지 전송 실패');
        }
        
    } catch (error) {
        console.error('OAuth YouTube 전송 실패:', error);
        let errorMessage = error.message;
        
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube 채팅 권한이 부족합니다. 채널 소유자인지 확인하세요.';
            } else if (apiError.code === 400) {
                errorMessage = '잘못된 요청입니다. 채팅 ID를 다시 확인하세요.';
            } else {
                errorMessage = `YouTube API 오류 (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`OAuth YouTube 전송 실패: ${errorMessage}`, 'error');
        return false;
    }
}

// 미션 그래프 설정 관리
function showMissionGraphSettings() {
    const panel = document.getElementById('mission-graph-settings');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    
    // 슬라이더 값 업데이트 함수 바인딩
    bindSliderUpdates();
}

// 총액 목표 설정 패널 표시/숨김
function showTotalGoalSettings() {
    const panel = document.getElementById('total-goal-settings');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    
    // 기존 설정 값 로드
    loadTotalGoalSettings();
    
    // 슬라이더 값 업데이트 함수 바인딩
    bindTotalGoalSliderUpdates();
}

function hideTotalGoalSettings() {
    document.getElementById('total-goal-settings').style.display = 'none';
}

function loadTotalGoalSettings() {
    // 서버에서 현재 설정 로드
    const settings = currentData.settings || {};
    
    // 목표 설정 로드
    if (settings.dailyGoal) {
        document.getElementById('daily-goal-target').value = settings.dailyGoal.target || '';
        document.getElementById('auto-extend-enabled').checked = settings.dailyGoal.autoExtend || false;
        document.getElementById('extend-amount').value = settings.dailyGoal.extendAmount || 50;
        document.getElementById('extend-amount').disabled = !settings.dailyGoal.autoExtend;
    }
    
    // 배경 및 텍스트 설정 로드
    document.getElementById('total-goal-bg-opacity').value = settings['total-goal-bg-opacity'] || 0;
    document.getElementById('total-goal-bg-color').value = settings['total-goal-bg-color'] || '#000000';
    document.getElementById('total-goal-text-outline-width').value = settings['total-goal-text-outline-width'] || 1;
    document.getElementById('total-goal-text-outline-color').value = settings['total-goal-text-outline-color'] || '#000000';
    
    // 표시 옵션 로드
    document.getElementById('total-goal-show-top-stats').checked = settings['total-goal-show-top-stats'] !== false; // 기본값: true
    document.getElementById('total-goal-text-switch-enabled').checked = settings['total-goal-text-switch-enabled'] || false; // 기본값: false
    document.getElementById('total-goal-text-switch-interval').value = settings['total-goal-text-switch-interval'] || 5;
    document.getElementById('total-goal-text-switch-interval').disabled = !settings['total-goal-text-switch-enabled'];
    
    // 크기 설정 로드
    document.getElementById('total-goal-title-size').value = parseInt(settings['total-goal-title-font-size']) || 24;
    document.getElementById('total-goal-stats-size').value = parseInt(settings['total-goal-stats-font-size']) || 20;
    document.getElementById('total-goal-progress-height').value = parseInt(settings['total-goal-progress-height']) || 30;
    document.getElementById('total-goal-progress-text-size').value = parseInt(settings['total-goal-progress-text-size']) || 16;
}

function bindTotalGoalSliderUpdates() {
    const sliders = [
        { id: 'total-goal-bg-opacity', suffix: '%', valueId: 'bg-opacity-value' },
        { id: 'total-goal-text-outline-width', suffix: 'px', valueId: 'text-outline-width-value' },
        { id: 'total-goal-text-switch-interval', suffix: '초', valueId: 'text-switch-interval-value' },
        { id: 'total-goal-title-size', suffix: 'px', valueId: 'total-goal-title-size-value' },
        { id: 'total-goal-stats-size', suffix: 'px', valueId: 'total-goal-stats-size-value' },
        { id: 'total-goal-progress-height', suffix: 'px', valueId: 'total-goal-progress-height-value' },
        { id: 'total-goal-progress-text-size', suffix: 'px', valueId: 'total-goal-progress-text-size-value' }
    ];
    
    sliders.forEach(slider => {
        const element = document.getElementById(slider.id);
        const valueDisplay = document.getElementById(slider.valueId);
        
        if (element && valueDisplay) {
            // 초기값 설정
            valueDisplay.textContent = element.value + slider.suffix;
            
            // 슬라이더 변경 이벤트
            element.addEventListener('input', function() {
                valueDisplay.textContent = this.value + slider.suffix;
            });
        }
    });
    
    // 자동 연장 체크박스 이벤트
    const autoExtendCheckbox = document.getElementById('auto-extend-enabled');
    const extendAmountInput = document.getElementById('extend-amount');
    
    if (autoExtendCheckbox && extendAmountInput) {
        autoExtendCheckbox.addEventListener('change', function() {
            extendAmountInput.disabled = !this.checked;
        });
    }
    
    // 텍스트 전환 체크박스 이벤트
    const textSwitchCheckbox = document.getElementById('total-goal-text-switch-enabled');
    const textSwitchIntervalInput = document.getElementById('total-goal-text-switch-interval');
    
    if (textSwitchCheckbox && textSwitchIntervalInput) {
        textSwitchCheckbox.addEventListener('change', function() {
            textSwitchIntervalInput.disabled = !this.checked;
        });
    }
}

function saveTotalGoalSettings() {
    try {
        // 목표 설정 수집
        const target = parseFloat(document.getElementById('daily-goal-target').value);
        const autoExtend = document.getElementById('auto-extend-enabled').checked;
        const extendAmount = parseFloat(document.getElementById('extend-amount').value) || 50;
        
        if (!target || target <= 0) {
            showStatus('⚠️ 올바른 목표액을 입력해주세요', 'warning');
            return;
        }
        
        const settings = {
            // 일일 목표 설정
            dailyGoal: {
                target: target,
                autoExtend: autoExtend,
                extendAmount: extendAmount,
                createdDate: new Date().toISOString().split('T')[0]
            },
            
            // 시각 설정
            'total-goal-bg-opacity': document.getElementById('total-goal-bg-opacity').value,
            'total-goal-bg-color': document.getElementById('total-goal-bg-color').value,
            'total-goal-text-outline-width': document.getElementById('total-goal-text-outline-width').value,
            'total-goal-text-outline-color': document.getElementById('total-goal-text-outline-color').value,
            'total-goal-show-top-stats': document.getElementById('total-goal-show-top-stats').checked,
            'total-goal-text-switch-enabled': document.getElementById('total-goal-text-switch-enabled').checked,
            'total-goal-text-switch-interval': document.getElementById('total-goal-text-switch-interval').value,
            'total-goal-title-font-size': document.getElementById('total-goal-title-size').value,
            'total-goal-stats-font-size': document.getElementById('total-goal-stats-size').value,
            'total-goal-progress-height': document.getElementById('total-goal-progress-height').value,
            'total-goal-progress-text-size': document.getElementById('total-goal-progress-text-size').value
        };
        
        console.log('💰 총액 목표 설정 저장:', settings);
        
        // 서버에 설정 저장
        fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(`✅ 총액 목표 설정이 저장되었습니다: ${target}만원`, 'success');
                console.log('✅ 총액 목표 설정 저장 성공:', data);
            } else {
                showStatus('❌ 설정 저장 실패: ' + (data.error || '알 수 없는 오류'), 'error');
            }
        })
        .catch(error => {
            console.error('❌ 총액 목표 설정 저장 실패:', error);
            showStatus('❌ 네트워크 오류로 설정 저장에 실패했습니다', 'error');
        });
        
    } catch (error) {
        console.error('❌ 총액 목표 설정 수집 실패:', error);
        showStatus('❌ 설정 데이터 처리 중 오류가 발생했습니다', 'error');
    }
}

function resetTotalGoalSettings() {
    if (confirm('🔄 총액 목표 설정을 기본값으로 초기화하시겠습니까?')) {
        // 기본값으로 초기화
        document.getElementById('daily-goal-target').value = '';
        document.getElementById('auto-extend-enabled').checked = false;
        document.getElementById('extend-amount').value = 50;
        document.getElementById('extend-amount').disabled = true;
        document.getElementById('total-goal-bg-opacity').value = 0;
        document.getElementById('total-goal-bg-color').value = '#000000';
        document.getElementById('total-goal-text-outline-width').value = 1;
        document.getElementById('total-goal-text-outline-color').value = '#000000';
        document.getElementById('total-goal-show-top-stats').checked = true;
        document.getElementById('total-goal-text-switch-enabled').checked = false;
        document.getElementById('total-goal-text-switch-interval').value = 5;
        document.getElementById('total-goal-text-switch-interval').disabled = true;
        document.getElementById('total-goal-title-size').value = 24;
        document.getElementById('total-goal-stats-size').value = 20;
        document.getElementById('total-goal-progress-height').value = 30;
        document.getElementById('total-goal-progress-text-size').value = 16;
        
        // 슬라이더 값 업데이트
        document.querySelectorAll('#total-goal-settings input[type="range"]').forEach(input => {
            input.dispatchEvent(new Event('input'));
        });
        
        showStatus('🔄 총액 목표 설정이 초기화되었습니다', 'success');
    }
}

function hideMissionGraphSettings() {
    document.getElementById('mission-graph-settings').style.display = 'none';
}

function bindSliderUpdates() {
    const sliders = [
        { id: 'graph-opacity', suffix: '%' },
        { id: 'graph-border-width', suffix: 'px' },
        { id: 'title-font-size', suffix: 'px' },
        { id: 'stats-font-size', suffix: 'px' },
        { id: 'progress-height', suffix: 'px' }
    ];
    
    sliders.forEach(slider => {
        const input = document.getElementById(slider.id);
        const valueSpan = document.getElementById(`${slider.id}-value`);
        
        if (input && valueSpan) {
            input.addEventListener('input', () => {
                valueSpan.textContent = input.value + slider.suffix;
            });
        }
    });
}

function applyMissionGraphSettings() {
    const settings = {
        'mission-graph-opacity': document.getElementById('graph-opacity').value,
        'mission-graph-bg-color': document.getElementById('graph-bg-color').value,
        'mission-graph-border-color': document.getElementById('graph-border-color').value,
        'mission-graph-border-width': document.getElementById('graph-border-width').value,
        'mission-title-font-size': document.getElementById('title-font-size').value,
        'mission-stats-font-size': document.getElementById('stats-font-size').value,
        'mission-progress-height': document.getElementById('progress-height').value,
        'mission-progress-bg-color': document.getElementById('progress-bg-color').value,
        'mission-progress-start-color': document.getElementById('progress-start-color').value,
        'mission-progress-end-color': document.getElementById('progress-end-color').value,
        'mission-complete-start-color': document.getElementById('complete-start-color').value,
        'mission-complete-end-color': document.getElementById('complete-end-color').value
    };
    
    // 서버에 설정 저장
    saveMissionGraphSettings(settings);
    showStatus('🎨 미션 그래프 설정이 적용되었습니다!', 'success');
}

function resetMissionGraphSettings() {
    if (confirm('미션 그래프 설정을 초기화하시겠습니까?')) {
        document.getElementById('graph-opacity').value = 85;
        document.getElementById('graph-bg-color').value = '#000000';
        document.getElementById('graph-border-color').value = '#42b72a';
        document.getElementById('graph-border-width').value = 2;
        document.getElementById('title-font-size').value = 20;
        document.getElementById('stats-font-size').value = 16;
        document.getElementById('progress-height').value = 20;
        document.getElementById('progress-bg-color').value = '#2c2c2c';
        document.getElementById('progress-start-color').value = '#42b72a';
        document.getElementById('progress-end-color').value = '#6bd464';
        document.getElementById('complete-start-color').value = '#ffd700';
        document.getElementById('complete-end-color').value = '#fff176';
        
        // 값 표시 업데이트
        bindSliderUpdates();
        document.querySelectorAll('#mission-graph-settings input[type="range"]').forEach(input => {
            input.dispatchEvent(new Event('input'));
        });
        
        showStatus('🔄 미션 그래프 설정이 초기화되었습니다', 'success');
    }
}

async function saveMissionGraphSettings(newSettings) {
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings: newSettings })
        });
        
        if (!response.ok) {
            throw new Error('서버 응답 오류');
        }
        
        const result = await response.json();
        if (result.success) {
            console.log('✅ 미션 그래프 설정 저장 성공:', newSettings);
        }
    } catch (error) {
        console.error('❌ 미션 그래프 설정 저장 실패:', error);
        showStatus('설정 저장에 실패했습니다', 'error');
    }
}

// 미션 관리 함수들
async function createMission() {
    const streamer = document.getElementById('mission-streamer').value;
    const target = document.getElementById('mission-target').value;
    const description = document.getElementById('mission-description').value;
    
    if (!streamer || !target) {
        showStatus('스트리머와 목표액을 입력하세요', 'error');
        return;
    }
    
    if (parseFloat(target) <= 0) {
        showStatus('목표액은 0보다 커야 합니다', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/missions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ streamer, target, description })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus(`✅ ${streamer}의 퇴근미션이 시작되었습니다! (목표: ${target}만원)`, 'success');
            // 입력 필드 초기화
            document.getElementById('mission-streamer').value = '';
            document.getElementById('mission-target').value = '';
            document.getElementById('mission-description').value = '';
        } else {
            showStatus(`❌ 미션 생성 실패: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('미션 생성 실패:', error);
        showStatus('❌ 서버 오류로 미션 생성에 실패했습니다', 'error');
    }
}


async function deleteMission(missionId) {
    if (!confirm('정말로 이 퇴근미션을 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/missions/${missionId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('✅ 퇴근미션이 삭제되었습니다', 'success');
        } else {
            showStatus(`❌ 미션 삭제 실패: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('미션 삭제 실패:', error);
        showStatus('❌ 서버 오류로 미션 삭제에 실패했습니다', 'error');
    }
}

</script>
</body>
</html>