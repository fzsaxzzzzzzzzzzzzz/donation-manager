<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ğŸ”´ ì‹¤ì‹œê°„ ë°©ì†¡ í›„ì› ì •ì‚° ì‹œìŠ¤í…œ</title>

<!-- Google Drive API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>

<style>
/* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; color: #333; margin: 0; padding: 0; overflow-x: hidden; }
#app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
#app-loader .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #1877f2; animation: spin 1s ease infinite; }
#app-loader p { margin-top: 20px; font-weight: 500; color: #606770; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.container { display: none; width: 100%; max-width: none; margin: 0; padding: 15px; grid-template-columns: 1.2fr 1.2fr 1.6fr; gap: 15px; min-height: calc(100vh - 30px); }
.container.loaded { display: grid; }
.panel { background: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); min-height: calc(100vh - 100px); overflow-y: auto; resize: horizontal; }
.panel h2 { margin: -20px -20px 15px -20px; padding: 15px 20px; color: #333; border-bottom: 1px solid #e0e0e0; font-size: 1.1rem; background-color: #fafafa; border-radius: 8px 8px 0 0;}
.btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin: 2px; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
.btn-primary { background-color: #1877f2; color: white; border-color: #1877f2;}
.btn-success { background-color: #42b72a; color: white; border-color: #42b72a;}
.btn-danger { background-color: #fa383e; color: white; border-color: #fa383e;}
.btn-secondary { background-color: #e4e6eb; color: #4b4f56; border-color: #dddfe2;}
.btn-warning { background-color: #f5c33b; color: #1c1e21; border-color: #f5c33b;}
.btn:hover { opacity: 0.9; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #606770; font-size: 0.9rem; }
.form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 14px; }
.form-input:focus, .form-select:focus { outline: none; }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
.table th, .table td { border: 1px solid #e9ebee; padding: 8px; text-align: center; }
.table th { background-color: #f5f6f7; font-weight: 600; }
#data-table-body td[data-field] { cursor: pointer; transition: background-color 0.2s; }
#data-table-body td[data-field]:hover { background-color: #e7f3ff; }
.copy-box { background-color: #f5f6f7; border-radius: 6px; padding: 10px; margin: 10px 0; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; word-break: break-all; min-height: 60px; white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto; border: 1px solid #e9ebee; }
.status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: 500; }
.status-success { background-color: #e9f6ec; color: #348a47; border: 1px solid #cce8d2; }
.status-error { background-color: #fde9e9; color: #a52828; border: 1px solid #f8d0d1; }
.status-info { background-color: #e7f3ff; color: #185a9d; border: 1px solid #cbe3ff; }
.status-warning { background-color: #fffbe6; color: #664d03; border: 1px solid #ffe58f; }
.management-nav { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;}
.tab-button { padding: 8px 12px; border: none; background: transparent; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-size: 14px; font-weight: 600; color: #606770; }
.tab-button.active { color: #1877f2; border-bottom-color: #1877f2; }
.tab-content { display: none; padding-top: 15px;}
.tab-content.active { display: block; }
.summary-tab-content { display: none; }
.summary-tab-content.active { display: block; }
.streamer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; }
.user-info { background-color: #e7f3ff; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; text-align: center; }
.admin { background-color: #fde9e9; color: #a52828; font-weight: 600; }
.autocomplete-container { position: relative; flex: 2; }
.donor-autocomplete { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dddfe2; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
.donor-autocomplete .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
.donor-autocomplete .autocomplete-item:hover, .donor-autocomplete .autocomplete-item.selected { background-color: #1877f2; color: white; }
.save-status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; transition: all 0.5s; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.save-status.saving { background-color: #f5c33b; color: #1c1e21; }
.save-status.saved { background-color: #42b72a; color: white; }
.save-status.error { background-color: #fa383e; color: white; }
.summary-header { display: flex; justify-content: space-between; align-items: center; }
.summary-header h4 { margin: 0; }
.summary-actions .btn { font-size:12px; padding:4px 8px; margin-left: 5px; }
@media (max-width: 1200px) { .container { grid-template-columns: 1fr 1fr; } }
@media (max-width: 900px) { .container { grid-template-columns: 1fr !important; } .panel { min-height: auto !important; resize: none !important; } }
</style>
</head>
<body>
<div id="app-loader">
<div class="spinner"></div>
<p>ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>
<div id="save-status" style="display: none;"></div>
<div class="container" id="app-container">
<div class="panel">
<h2>ê´€ë¦¬</h2>
<div class="management-nav">
<button class="tab-button active" onclick="switchTab(event, 'donation')">í›„ì›ë“±ë¡</button>
<button class="tab-button" onclick="switchTab(event, 'streamer')">ìŠ¤íŠ¸ë¦¬ë¨¸</button>
<button class="tab-button" onclick="switchTab(event, 'mission')">ğŸ„ í‡´ê·¼ë¯¸ì…˜</button>
<button class="tab-button" onclick="switchTab(event, 'overlay')">ğŸ¨ ì˜¤ë²„ë ˆì´</button>
<button class="tab-button" onclick="switchTab(event, 'password')" id="password-tab-btn" style="display: none;">ë¹„ë°€ë²ˆí˜¸</button>
<button class="tab-button" onclick="switchTab(event, 'data')">ë°ì´í„°</button>
<button class="tab-button" onclick="switchTab(event, 'debug')">ğŸ”§ ë””ë²„ê·¸</button>
<button class="tab-button" onclick="switchTab(event, 'chatbot')">ğŸ¤– ì±—ë´‡</button>
<button class="tab-button" onclick="switchTab(event, 'simple')" id="simple-tab-btn">ğŸ¯ ì¡°ì •</button>
</div>
<div id="main-content">
<div class="tab-content active" id="donation-tab">
<div id="password-section" style="display: none; margin-bottom:15px;">
<div style="display: flex; gap: 5px;"><input type="password" id="password-input" placeholder="4ìë¦¬ ë¹„ë°€ë²ˆí˜¸" maxlength="4" class="form-input"><button onclick="verifyPassword()" class="btn btn-primary">í™•ì¸</button></div>
</div>
<div class="form-group"><label class="form-label">í›„ì›ìëª…</label><div class="autocomplete-container" style="flex:auto;"><input type="text" id="donor-input" class="form-input" autocomplete="off"><div id="donor-autocomplete" class="donor-autocomplete"></div></div></div>
<div class="form-group"><label class="form-label">í›„ì› íƒ€ì…</label><div style="display: flex; gap: 15px;"><label><input type="radio" name="paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label><label><input type="radio" name="paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label><label><input type="radio" name="paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label></div></div>
<div class="form-group"><label class="form-label">ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡(ë§Œ)</label><div class="streamer-grid" id="streamer-inputs"></div></div>
<button onclick="addDonation()" class="btn btn-primary" id="add-btn" style="width:100%;">âœ¨ ë“±ë¡</button>
</div>
<div class="tab-content" id="streamer-tab">
<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
<h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ‘¤ ìƒˆ ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€</h4>

<div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 15px; align-items: end;">
<div>
<label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 5px; font-weight: bold;">ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„</label>
<input type="text" id="new-streamer-name" placeholder="ì˜ˆ: ì—„ì‚¼ìš©" class="form-input" style="width: 100%;">
</div>

<div>
<label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 5px; font-weight: bold;">ì´ëª¨ì§€</label>
<input type="text" id="new-streamer-emoji" placeholder="ğŸ«…" class="form-input" style="width: 100%; text-align: center;">
</div>

<button onclick="addStreamer()" class="btn btn-success" id="add-streamer-btn" 
        style="height: 40px; padding: 0 20px; font-weight: bold; font-size: 16px; white-space: nowrap; min-width: 100px;">
âœ¨ ì¶”ê°€
</button>
</div>

<!-- ê°„ë‹¨í•œ ë°±ì—… ë ˆì´ì•„ì›ƒ (í•­ìƒ ë³´ì´ëŠ” ì¶”ê°€ ë²„íŠ¼) -->
<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6;">
<div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
<input type="text" id="backup-streamer-name" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„" class="form-input" style="flex: 1; min-width: 120px;">
<input type="text" id="backup-streamer-emoji" placeholder="ğŸ«…" class="form-input" style="width: 80px; text-align: center;">
<button onclick="addStreamerBackup()" class="btn btn-success" style="padding: 8px 16px; font-weight: bold; background-color: #28a745 !important; border: none !important;">
â• ì¶”ê°€
</button>
</div>
</div>

<!-- ëª¨ë°”ì¼ìš© ì„¸ë¡œ ë ˆì´ì•„ì›ƒ -->
<div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
<h5 style="margin: 0 0 15px 0; color: #0d6efd;">ğŸ“± ëª¨ë°”ì¼ìš© ê°„í¸ ì¶”ê°€</h5>
<div style="margin-bottom: 10px;">
<input type="text" id="simple-streamer-name" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„" class="form-input" style="width: 100%;">
</div>
<div style="margin-bottom: 10px;">
<input type="text" id="simple-streamer-emoji" placeholder="ì´ëª¨ì§€ (ì˜ˆ: ğŸ«…)" class="form-input" style="width: 100%; text-align: center;">
</div>
<button onclick="addStreamerSimple()" class="btn btn-primary" 
        style="width: 100%; padding: 12px; font-weight: bold; font-size: 16px; background-color: #0d6efd !important;">
âœ¨ ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€í•˜ê¸°
</button>
</div>
</div>

<div style="background: white; border-radius: 8px; border: 1px solid #e9ecef;">
<h4 style="margin: 0; padding: 15px; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">ğŸ“‹ ìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡</h4>
<div id="streamer-list" style="min-height: 200px; padding: 15px;"></div>
</div>

<div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px;">
<h4 style="margin: 0 0 10px 0; color: #856404;">ğŸ”§ ì´ëª¨ì§€ ë³µì›</h4>
<button onclick="restoreEmojis()" class="btn btn-warning">ì´ëª¨ì§€ ì¦‰ì‹œ ë³µì›</button>
<p style="font-size: 12px; color: #856404; margin: 5px 0 0 0;">ì´ëª¨ì§€ê°€ ì•ˆ ë³´ì´ë©´ ì´ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
</div>
</div>
<div class="tab-content" id="mission-tab">
<div id="mission-settings" style="max-height: 400px; overflow-y: auto; padding-right: 5px;"></div>
<div style="display: flex; gap: 10px; margin-top: 15px;">
<button onclick="saveAllMissions()" class="btn btn-primary" id="save-mission-btn" style="flex: 1;">ëª¨ë“  ëª©í‘œ ì €ì¥</button>
<button onclick="stopAllMissions()" class="btn btn-danger" id="stop-all-missions-btn" style="flex: 1;">ğŸ›‘ ì¼ê´„ ì¤‘ì§€</button>
</div>
</div>
<div class="tab-content" id="overlay-tab">
<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ“º ë°©ì†¡ìš© ì˜¤ë²„ë ˆì´</h4>

<!-- í›„ì›ì ì˜¤ë²„ë ˆì´ ì„¹ì…˜ -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>ğŸ’ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('donor')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">ğŸ”— ì—´ê¸°</button>
<button onclick="copyOverlayURL('donor')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">ğŸ“‹ URL ë³µì‚¬</button>
<button onclick="showQRCode('donor')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">ğŸ“± QRì½”ë“œ</button>
</div>
</div>
<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="donor-overlay-url">https://donation-manager-ufm1.onrender.com/donor-overlay.html</span>
</div>
</div>

<!-- ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì„¹ì…˜ -->
<div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
<strong>ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´</strong>
<div style="display: flex; gap: 8px;">
<button onclick="openOverlay('table')" class="btn btn-primary" style="font-size: 12px; padding: 5px 10px;">ğŸ”— ì—´ê¸°</button>
<button onclick="copyOverlayURL('table')" class="btn btn-success" style="font-size: 12px; padding: 5px 10px;">ğŸ“‹ URL ë³µì‚¬</button>
<button onclick="showQRCode('table')" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">ğŸ“± QRì½”ë“œ</button>
</div>
</div>
<div style="font-size: 11px; color: #666; word-break: break-all; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
<span id="table-overlay-url">https://donation-manager-ufm1.onrender.com/streamer-table-overlay.html</span>
</div>
</div>

<!-- ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° í† ê¸€ -->
<div style="margin-bottom: 15px; text-align: center;">
<button onclick="togglePreview()" class="btn btn-info" id="preview-toggle">ğŸ‘ï¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì¼œê¸°</button>
<button onclick="openAllOverlays()" class="btn btn-warning" style="margin-left: 10px;">ğŸ”— ëª¨ë“  ì˜¤ë²„ë ˆì´ í•œë²ˆì— ì—´ê¸°</button>
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
<div id="preview-area" style="display: none; border: 2px solid #667eea; border-radius: 8px; padding: 15px; background: #f8f9ff; margin-bottom: 15px;">
<h5 style="margin: 0 0 10px 0; color: #667eea;">ğŸ”´ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (ì„¤ì • ë³€ê²½ ì‹œ ì¦‰ì‹œ ë°˜ì˜)</h5>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div style="background: black; border-radius: 4px; min-height: 100px; padding: 10px; position: relative;">
<iframe id="donor-preview" src="" style="width: 100%; height: 100px; border: none; transform: scale(0.5); transform-origin: top left; width: 200%; height: 200px;"></iframe>
<div style="position: absolute; bottom: 5px; left: 5px; color: white; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px;">í›„ì›ì ì˜¤ë²„ë ˆì´</div>
</div>
<div style="background: black; border-radius: 4px; min-height: 100px; padding: 10px; position: relative;">
<iframe id="table-preview" src="" style="width: 100%; height: 100px; border: none; transform: scale(0.5); transform-origin: top left; width: 200%; height: 200px;"></iframe>
<div style="position: absolute; bottom: 5px; left: 5px; color: white; font-size: 10px; background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 3px;">í…Œì´ë¸” ì˜¤ë²„ë ˆì´</div>
</div>
</div>
</div>

<div style="background: #e8f4f8; border: 1px solid #bee5eb; border-radius: 4px; padding: 10px; margin-bottom: 15px;">
<p style="font-size: 13px; margin: 0; color: #0c5460;">
ğŸ’¡ <strong>ì‚¬ìš© ë°©ë²•:</strong><br>
â€¢ <strong>OBS:</strong> ë¸Œë¼ìš°ì € ì†ŒìŠ¤ ì¶”ê°€ â†’ URL ë¶™ì—¬ë„£ê¸° â†’ ë„ˆë¹„: 1920, ë†’ì´: 1080<br>
â€¢ <strong>ëª¨ë°”ì¼:</strong> QRì½”ë“œë¡œ ìŠ¤ìº”í•˜ì—¬ ë°”ë¡œ ì ‘ì†<br>
â€¢ <strong>ë‹¤ë¥¸ PC:</strong> URLì„ ë³µì‚¬í•´ì„œ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ê¸°<br>
â€¢ ì„¤ì • ë³€ê²½ ì‹œ ëª¨ë“  ê¸°ê¸°ì— ì‹¤ì‹œê°„ ë°˜ì˜ë©ë‹ˆë‹¤
</p>
</div>
</div>

<div style="border-top: 1px solid #ddd; padding-top: 20px;">
<h4 style="margin-bottom: 15px;">ğŸ¨ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì •</h4>

<div style="margin-bottom: 15px;">
<label class="form-label">ê¸€ì í¬ê¸°: <span id="overlay-font-size-value">16px</span></label>
<input type="range" id="overlay-font-size-range" min="12" max="150" value="16" 
       onInput="updateOverlayFontSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">ì™¸ê°ì„  ë‘ê»˜: <span id="overlay-stroke-width-value">2px</span></label>
<input type="range" id="overlay-stroke-width-range" min="0" max="10" step="0.2" value="2" 
       onInput="updateOverlayStrokeWidth(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">í…ìŠ¤íŠ¸ ì •ë ¬:</label>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<button onclick="setOverlayTextAlign('left')" class="btn btn-secondary" id="overlay-align-left">â¬…ï¸ ì™¼ìª½</button>
<button onclick="setOverlayTextAlign('center')" class="btn btn-secondary" id="overlay-align-center">âºï¸ ê°€ìš´ë°</button>
<button onclick="setOverlayTextAlign('right')" class="btn btn-secondary" id="overlay-align-right">â¡ï¸ ì˜¤ë¥¸ìª½</button>
</div>
</div>

<div style="margin-bottom: 20px;">
<button onclick="applyOverlaySettings()" class="btn btn-success">ì ìš©</button>
<button onclick="resetOverlaySettings()" class="btn btn-secondary">ê¸°ë³¸ê°’ ë³µì›</button>
</div>
</div>

<div style="border-top: 1px solid #ddd; padding-top: 20px;">
<h4 style="margin-bottom: 15px;">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì •</h4>

<div style="margin-bottom: 15px;">
<label class="form-label">ë°°ê²½ íˆ¬ëª…ë„: <span id="table-opacity-value">85%</span></label>
<input type="range" id="table-opacity-range" min="0" max="100" value="85" 
       onInput="updateTableOpacity(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">ìˆ«ì í¬ê¸°: <span id="table-number-size-value">16px</span></label>
<input type="range" id="table-number-size-range" min="12" max="60" value="16" 
       onInput="updateTableNumberSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">ì „ì²´ ê¸€ì í¬ê¸°: <span id="table-font-size-value">14px</span></label>
<input type="range" id="table-font-size-range" min="10" max="30" value="14" 
       onInput="updateTableFontSize(this.value)" class="form-input" style="width: 100%;">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">ê¸€ì ìƒ‰ìƒ:</label>
<div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
<button onclick="setTableTextColor('white')" class="btn btn-secondary" style="background: #fff; color: #000; border: 2px solid #ddd;">í°ìƒ‰</button>
<button onclick="setTableTextColor('#FFD700')" class="btn btn-secondary" style="background: #FFD700; color: #000;">ê¸ˆìƒ‰</button>
<button onclick="setTableTextColor('#87CEEB')" class="btn btn-secondary" style="background: #87CEEB; color: #000;">í•˜ëŠ˜ìƒ‰</button>
<button onclick="setTableTextColor('#90EE90')" class="btn btn-secondary" style="background: #90EE90; color: #000;">ì—°ë‘ìƒ‰</button>
<button onclick="setTableTextColor('#FFB6C1')" class="btn btn-secondary" style="background: #FFB6C1; color: #000;">í•‘í¬</button>
<button onclick="setTableTextColor('#DDA0DD')" class="btn btn-secondary" style="background: #DDA0DD; color: #000;">ë³´ë¼ìƒ‰</button>
</div>
</div>


<div style="margin-bottom: 15px;">
<label class="form-label">ë°°ê²½ ìƒ‰ìƒ í”„ë¦¬ì…‹:</label>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<button onclick="setTableColorPreset('dark')" class="btn btn-secondary" style="background: linear-gradient(135deg, #000, #1e1e1e); color: white;">ë‹¤í¬</button>
<button onclick="setTableColorPreset('blue')" class="btn btn-secondary" style="background: linear-gradient(135deg, #191970, #4169e1); color: white;">ë¸”ë£¨</button>
<button onclick="setTableColorPreset('purple')" class="btn btn-secondary" style="background: linear-gradient(135deg, #8b008b, #4b0082); color: white;">í¼í”Œ</button>
<button onclick="setTableColorPreset('green')" class="btn btn-secondary" style="background: linear-gradient(135deg, #006400, #228b22); color: white;">ê·¸ë¦°</button>
<button onclick="setTableColorPreset('brown')" class="btn btn-secondary" style="background: linear-gradient(135deg, #8b4513, #a0522d); color: white;">ë¸Œë¼ìš´</button>
</div>
</div>

<div style="margin-bottom: 20px;">
<button onclick="applyTableSettings()" class="btn btn-success">ì ìš©</button>
<button onclick="resetTableSettings()" class="btn btn-secondary">ê¸°ë³¸ê°’ ë³µì›</button>
</div>
</div>
</div>
<div class="tab-content" id="password-tab">
<div style="margin-bottom: 20px; padding: 15px; border: 2px solid #dc3545; border-radius: 8px; background: #f8d7da;">
<h4 style="color: #721c24; margin: 0 0 10px 0;">ğŸ”’ ê´€ë¦¬ì ì „ìš©</h4>
<div style="margin-bottom: 15px;">
<strong style="color: #721c24;">ê³ ì • ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:</strong>
<div id="current-password" style="font-size:18px; font-weight:bold; margin:5px 0; color: #721c24;">2749</div>
</div>
<div style="margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 10px; color: #721c24;">
<input type="checkbox" id="admin-verified" onchange="toggleAdminMode()" style="transform: scale(1.2);">
<strong>ê´€ë¦¬ì ì¸ì¦ ì™„ë£Œ</strong>
</label>
</div>
<div style="font-size: 12px; color: #6c757d;">
âš ï¸ ê´€ë¦¬ìë§Œ ì²´í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²´í¬ ì‹œ ëª¨ë“  ê´€ë¦¬ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥
</div>
</div>

<div style="margin-bottom: 20px; padding: 15px; border: 2px solid #17a2b8; border-radius: 8px; background: #d1ecf1;">
<h4 style="color: #0c5460; margin: 0 0 10px 0;">ğŸ¯ ê°„ë‹¨ ëª¨ë“œ ì„¤ì •</h4>
<div style="margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 10px; color: #0c5460;">
<input type="checkbox" id="simple-mode-only" onchange="toggleSimpleModeOnly()" style="transform: scale(1.2);">
<strong>ì¡°ì • íƒ­ë§Œ ë³´ì´ê¸°</strong>
</label>
</div>
<div style="font-size: 12px; color: #6c757d;">
ğŸ’¡ ì²´í¬í•˜ë©´ ë‹¤ë¥¸ ì‚¬ëŒì´ ë³¼ ë•Œ ì¡°ì • íƒ­ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” ëª¨ë“  íƒ­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</div>
</div>
</div>
<div class="tab-content" id="data-tab">
<button onclick="showAdminPassword()" class="btn btn-secondary" id="pwd-btn" style="display:none;">ğŸ”‘ ë¹„ë²ˆì¡°íšŒ</button>
<div style="display: flex; flex-wrap: wrap; gap: 10px;"><button onclick="exportData()" class="btn btn-primary">ğŸ“„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button><button onclick="saveData()" class="btn btn-success" id="save-btn">ğŸ’¾ ì¼ê°„ì €ì¥</button><button onclick="showResetDialog()" class="btn btn-warning" id="reset-btn">ğŸ”„ ì´ˆê¸°í™”</button><button onclick="importData()" class="btn btn-secondary" id="import-btn">ğŸ“‚ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button></div>

<div style="margin-top: 20px; padding: 15px; border: 2px solid #4285f4; border-radius: 8px; background: #f8f9ff;">
<h4 style="color: #4285f4; margin: 0 0 15px 0;">â˜ï¸ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°±ì—…</h4>
<div id="google-drive-status" class="status status-info" style="margin-bottom: 15px;">
ğŸ”‘ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´ ìë™ ë°±ì—…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤
</div>

<div style="display: flex; flex-wrap: wrap; gap: 10px;">
<button onclick="signInGoogle()" class="btn btn-primary" id="google-signin-btn">ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸</button>
<button onclick="signOutGoogle()" class="btn btn-secondary" id="google-signout-btn" style="display: none;">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
<button onclick="backupToGoogleDrive()" class="btn btn-success" id="google-backup-btn" style="display: none;">â˜ï¸ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë°±ì—…</button>
<button onclick="toggleAutoBackup()" class="btn btn-warning" id="auto-backup-btn" style="display: none;">â° ìë™ë°±ì—… OFF</button>
</div>

<div id="google-user-info" style="margin-top: 10px; font-size: 13px; color: #666; display: none;">
ğŸ“§ ë¡œê·¸ì¸ëœ ê³„ì •: <span id="user-email"></span>
</div>
</div>
<input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleFileImport(event)">
</div>
<div class="tab-content" id="debug-tab">
<div style="margin-bottom: 20px;">
<h4>ğŸ”§ ì„œë²„ ìƒíƒœ ë””ë²„ê·¸</h4>
<button onclick="checkServerData()" class="btn btn-primary">ì„œë²„ ë°ì´í„° í™•ì¸</button>
<button onclick="forceInitEmojis()" class="btn btn-warning">ì´ëª¨ì§€ ê°•ì œ ì´ˆê¸°í™”</button>
<button onclick="testStreamerAdd()" class="btn btn-success">ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ í…ŒìŠ¤íŠ¸</button>
</div>

<div id="debug-output" style="background: #f5f6f7; padding: 15px; border-radius: 6px; margin-top: 15px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
</div>

<div class="tab-content" id="chatbot-tab">
<div id="google-auth-status" class="status status-warning">
ğŸ” <strong>Google ë¡œê·¸ì¸ í•„ìš”</strong>: YouTube API ì‚¬ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”.
</div>

<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ”§ YouTube API í…ŒìŠ¤íŠ¸</h4>
<button onclick="testYouTubeOAuth()" class="btn btn-primary">API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
</div>

<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ“º ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°</h4>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="text" id="youtube-video-id" placeholder="YouTube ì˜ìƒ ID" class="form-input">
<button onclick="connectToLiveChatOAuth()" class="btn btn-success">ì—°ê²°</button>
</div>
<p style="font-size: 12px; color: #666; margin: 0;">
ğŸ’¡ YouTube ë¼ì´ë¸Œ ë°©ì†¡ URLì—ì„œ watch?v= ë’¤ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
</p>
</div>

<!-- API ì„¤ì • ì„¹ì…˜ (ê¸°ì¡´ API í‚¤ ë°©ì‹ ìœ ì§€) -->
<div class="form-group" style="border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f9f9f9; margin-top: 20px;">
<h4 style="margin: 0 0 15px 0;">ğŸ”‘ YouTube API í‚¤ ë°©ì‹ (ëŒ€ì•ˆ)</h4>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="password" id="youtube-api-key" placeholder="YouTube API í‚¤ ì…ë ¥" class="form-input" style="flex: 2;">
<button onclick="testApiKey()" class="btn btn-secondary">ğŸ§ª í…ŒìŠ¤íŠ¸</button>
<button onclick="saveApiKey()" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
</div>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="text" id="youtube-video-id" placeholder="ìœ íŠœë¸Œ ì˜ìƒ ID (ì˜ˆ: dQw4w9WgXcQ)" class="form-input" style="flex: 2;">
<button onclick="connectToLiveChat()" class="btn btn-success">ğŸ”— ë¼ì´ë¸Œ ì—°ê²°</button>
</div>
<div style="display: flex; gap: 10px;">
<input type="number" id="auto-send-interval" placeholder="ìë™ì „ì†¡ ê°„ê²©(ì´ˆ)" class="form-input" style="flex: 1;" min="30" value="300">
<button onclick="startAutoSend()" class="btn btn-success" id="auto-start-btn">ğŸš€ ìë™ì‹œì‘</button>
<button onclick="stopAutoSend()" class="btn btn-danger" id="auto-stop-btn" disabled>ğŸ›‘ ìë™ì¤‘ì§€</button>
</div>
</div>

<div class="form-group">
<label class="form-label">ğŸ”¥ ì‹¤ì‹œê°„ í›„ì› í˜„í™© ë©”ì‹œì§€</label>
<div class="copy-box" id="live-summary" style="min-height: 80px;"></div>
<button onclick="updateLiveSummary()" class="btn btn-primary" style="width: 100%; margin-top: 5px;">ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</button>
</div>

<div class="form-group">
<label class="form-label">âš¡ ë¹ ë¥¸ ë©”ì‹œì§€ í…œí”Œë¦¿</label>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
<button onclick="generateQuickMessage('welcome')" class="btn btn-secondary">ğŸ‘‹ ì¸ì‚¬</button>
<button onclick="generateQuickMessage('thanks')" class="btn btn-secondary">ğŸ’ ê°ì‚¬</button>
<button onclick="generateQuickMessage('goal')" class="btn btn-secondary">ğŸ¯ ëª©í‘œ</button>
<button onclick="generateQuickMessage('mission')" class="btn btn-secondary">ğŸ„ ë¯¸ì…˜</button>
</div>
</div>

<div class="form-group">
<label for="manual-message" class="form-label">ğŸ“ ì»¤ìŠ¤í…€ ë©”ì‹œì§€</label>
<textarea id="manual-message" class="form-input" rows="4" placeholder="ì§ì ‘ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì˜ ë²„íŠ¼ìœ¼ë¡œ ìë™ ìƒì„±í•˜ì„¸ìš”"></textarea>
</div>

<div style="display: flex; gap: 10px;">
<button onclick="sendToYouTube()" class="btn btn-success" style="flex: 1;" id="youtube-send-btn" disabled>ğŸš€ ìœ íŠœë¸Œ ì „ì†¡</button>
<button onclick="copyMessageToClipboard()" class="btn btn-secondary">ğŸ“‹ ë³µì‚¬</button>
<button onclick="clearMessage()" class="btn btn-secondary">ğŸ§¹ ì§€ìš°ê¸°</button>
</div>

<div class="status status-info" style="margin-top: 15px; font-size: 12px;">
ğŸ’¡ <strong>API í‚¤ ë°œê¸‰:</strong> Google Cloud Console â†’ YouTube Data API v3 í™œì„±í™” â†’ API í‚¤ ìƒì„±<br>
ğŸ”— <strong>ì˜ìƒ ID:</strong> youtube.com/watch?v=<strong>dQw4w9WgXcQ</strong> â† ì´ ë¶€ë¶„
</div>
</div>

<div class="tab-content" id="simple-tab">
<div id="simple-mode-status" class="status status-info" style="margin-bottom: 15px;">
ğŸ¯ <strong>ì¡°ì • ëª¨ë“œ</strong>: ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ë˜ëŠ” í›„ì›ìë³„ë¡œ ê¸ˆì•¡ì„ ë‹¨ë… ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
</div>

<div class="form-group">
<label class="form-label">ğŸ¯ ì¡°ì • ëª¨ë“œ ì„ íƒ</label>
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button onclick="switchSimpleMode('streamer')" id="streamer-mode-btn" class="btn btn-secondary" style="flex: 1;">
        ğŸ¬ ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •
    </button>
    <button onclick="switchSimpleMode('donor')" id="donor-mode-btn" class="btn btn-secondary" style="flex: 1;">
        ğŸ’ í›„ì›ìë³„ ì¡°ì •
    </button>
</div>
</div>

<!-- ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ëª¨ë“œ -->
<div id="streamer-mode-panel" class="form-group" style="display: none;">
<label class="form-label">ğŸ¬ ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡ ì¡°ì •</label>
<div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border: 1px solid #87ceeb;">
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</label>
        <select id="streamer-mode-select" class="form-input">
            <option value="">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</option>
        </select>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">í›„ì› íƒ€ì…</label>
        <div style="display: flex; gap: 15px;">
            <label><input type="radio" name="streamer-paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label>
            <label><input type="radio" name="streamer-paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label>
            <label><input type="radio" name="streamer-paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label>
        </div>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">ì¡°ì • ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="streamer-amount-input" class="form-input" placeholder="ì˜ˆ: +1.5 ë˜ëŠ” -0.5" step="0.1">
    </div>
    
    <button onclick="adjustStreamerAmount()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
        ğŸ¬ ìŠ¤íŠ¸ë¦¬ë¨¸ ê¸ˆì•¡ ì¡°ì •
    </button>
</div>
</div>

<!-- í›„ì›ìë³„ ì¡°ì • ëª¨ë“œ -->
<div id="donor-mode-panel" class="form-group" style="display: none;">
<label class="form-label">ğŸ’ í›„ì›ìë³„ ê¸ˆì•¡ ì¡°ì •</label>
<div style="background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #ffc0cb;">
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">í›„ì›ìëª…</label>
        <input type="text" id="donor-mode-input" class="form-input" placeholder="í›„ì›ì ì´ë¦„ ì…ë ¥">
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">í›„ì› íƒ€ì…</label>
        <div style="display: flex; gap: 15px;">
            <label><input type="radio" name="donor-paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label>
            <label><input type="radio" name="donor-paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label>
            <label><input type="radio" name="donor-paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label>
        </div>
    </div>
    
    <div class="form-group">
        <label style="font-size: 14px; margin-bottom: 5px;">ì¡°ì • ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="donor-amount-input" class="form-input" placeholder="ì˜ˆ: +2.0 ë˜ëŠ” -1.0" step="0.1">
    </div>
    
    <button onclick="adjustDonorAmount()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
        ğŸ’ í›„ì›ì ê¸ˆì•¡ ì¡°ì •
    </button>
</div>
</div>

<div class="form-group">
<label class="form-label">ğŸ“ ìµœê·¼ ë“±ë¡ ë‚´ì—­</label>
<div id="simple-recent-list" style="max-height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 6px; font-size: 13px;">
    <div style="color: #666; text-align: center; padding: 20px;">ë“±ë¡ëœ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
</div>
</div>
</div>
</div>
</div>
<div class="panel">
<h2>ì •ì‚° ìš”ì•½</h2>
<div class="management-nav" style="margin-bottom: 0;">
<button class="tab-button active" onclick="switchSummaryTab(event, 'basic-summary')">ê¸°ë³¸ ìš”ì•½</button>
<button class="tab-button" onclick="switchSummaryTab(event, 'table-summary')">ìƒì„¸ í…Œì´ë¸”</button>
</div>
<div id="basic-summary" class="summary-tab-content active" style="padding-top: 15px;">
<div>
<div class="summary-header">
<h4>ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡</h4>
<div class="summary-actions">
<button onclick="toggleStreamerSummarySettings()" class="btn btn-secondary">âš™ï¸ ì„¤ì •</button>
<button onclick="copyText('summary-output')" class="btn btn-secondary">ë³µì‚¬</button>
</div>
</div>

<div id="streamer-summary-settings" style="display: none; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
<div style="margin-bottom: 10px;">
<label class="form-label">ë¨¸ë¦¿ê¸€:</label>
<input type="text" id="streamer-summary-header" class="form-input" placeholder="ì˜ˆ: ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥" value="ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥">
</div>
<div style="margin-bottom: 10px;">
<label class="form-label">ê¼¬ë¦¿ê¸€:</label>
<input type="text" id="streamer-summary-footer" class="form-input" placeholder="ì˜ˆ: ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!" value="ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!">
</div>
<div style="margin-bottom: 10px;">
<label><input type="checkbox" id="exclude-gukgo" checked> êµ­ê³  ì œì™¸í•˜ê³  ê³„ì‚°</label>
</div>
<div style="display: flex; gap: 5px;">
<button onclick="saveStreamerSummarySettings()" class="btn btn-primary">ì €ì¥</button>
<button onclick="resetStreamerSummarySettings()" class="btn btn-secondary">ê¸°ë³¸ê°’</button>
</div>
</div>

<div class="copy-box" id="summary-output"></div>
</div>
<div>
<div class="summary-header">
    <h4>í›„ì›ìë³„ ì´ì•¡</h4>
    <div class="summary-actions">
        <button onclick="copyText('donor-total')" class="btn btn-secondary">ë³µì‚¬</button>
    </div>
</div>
<div style="display: flex; gap: 5px; align-items: center; margin-bottom: 5px;">
    <span style="font-size: 14px;">ê°™ì€ ê¸ˆì•¡ ë¬¶ê¸° (</span>
    <input type="number" id="group-threshold" value="2" class="form-input" style="width: 60px;">
    <span style="font-size: 14px;">ëª… ì´ìƒ)</span>
    <button onclick="updateSummary()" class="btn btn-primary" style="font-size:12px; padding:4px 8px;">ì ìš©</button>
</div>
<div class="copy-box" id="donor-total"></div>
</div>
<div>
<div class="summary-header">
<h4>ìµœê·¼ ì…ê¸ˆ ë‚´ì—­</h4>
<div class="summary-actions">
<button onclick="copyText('recent-log')" class="btn btn-secondary">ë³µì‚¬</button>
</div>
</div>
<div style="display: flex; gap: 5px; align-items: center; margin-bottom: 5px;">
<input type="number" id="recent-minutes" value="5" class="form-input" style="width: 70px;">
<span style="font-size: 14px;">ë¶„ ì´ë‚´</span>
<button onclick="updateSummary()" class="btn btn-primary" style="font-size:12px; padding:4px 8px;">ì¡°íšŒ</button>
</div>
<div class="copy-box" id="recent-log"></div>
</div>
<div>
<div class="summary-header">
<h4>ğŸ„ í‡´ê·¼ë¯¸ì…˜ í˜„í™©</h4>
<div class="summary-actions">
<button onclick="copyText('mission-summary-output')" class="btn btn-secondary">ë³µì‚¬</button>
</div>
</div>
<div class="copy-box" id="mission-summary-output">ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>
</div>
</div>
<div id="table-summary" class="summary-tab-content" style="padding-top: 15px;">

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
<h4 style="margin: 0;" id="table-title-display">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</h4>
<button onclick="toggleTableSettings()" class="btn btn-secondary">âš™ï¸ í…Œì´ë¸” ì„¤ì •</button>
</div>

<div id="table-settings" style="display: none; margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9;">
<div style="margin-bottom: 15px;">
<label class="form-label">í…Œì´ë¸” ì œëª©:</label>
<input type="text" id="table-title-input" class="form-input" placeholder="ì˜ˆ: ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†" value="ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†">
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">ìˆœë²ˆëª… ì„¤ì •:</label>
<div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
<span style="font-size: 14px;">ìˆœìœ„ ê°œìˆ˜:</span>
<input type="number" id="rank-count" class="form-input" style="width: 80px;" min="1" max="20" value="10" onchange="updateRankInputs()">
<span style="font-size: 12px; color: #666;">(ìµœëŒ€ 20ê°œ)</span>
</div>

<div id="rank-inputs-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
<!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ìˆœë²ˆëª… ì…ë ¥ í•„ë“œë“¤ -->
</div>

<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<button onclick="setRankPreset('royalty')" class="btn btn-secondary">ğŸ‘‘ ì™•ì¡±</button>
<button onclick="setRankPreset('flowers')" class="btn btn-secondary">ğŸŒ¸ ê½ƒì´ë¦„</button>
<button onclick="setRankPreset('animals')" class="btn btn-secondary">ğŸ¾ ë™ë¬¼</button>
<button onclick="setRankPreset('numbers')" class="btn btn-secondary">ğŸ”¢ ìˆ«ì</button>
</div>
</div>

<div style="margin-bottom: 15px;">
<label class="form-label">í‘œì‹œ ì˜µì…˜:</label>
<div style="display: flex; gap: 15px; margin-top: 5px;">
<label><input type="checkbox" id="show-total-row" checked> ì´í•©ê³„ í–‰ í‘œì‹œ</label>
<label><input type="checkbox" id="show-update-time"> ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ</label>
</div>
</div>

<div style="display: flex; gap: 5px;">
<button onclick="saveTableSettings()" class="btn btn-primary">ì €ì¥</button>
<button onclick="resetTableSettings()" class="btn btn-secondary">ê¸°ë³¸ê°’</button>
</div>
</div>

<div class="table-container" style="max-height: calc(100vh - 300px); overflow-y: auto;">
</div>

<div id="table-update-time" style="display: none; text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --:--
</div>

</div>
</div>
<div class="panel">
<h2>í›„ì›ë‚´ì—­</h2>
<div class="user-info" id="user-info">ë¡œì»¬ ì›¹í˜ì´ì§€ ëª¨ë“œ</div>
<div style="display: flex; gap: 5px; flex-wrap: wrap; align-items: center; margin-bottom:10px;">
<button onclick="loadData()" class="btn btn-success">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
<button onclick="deleteSelected()" class="btn btn-danger" id="delete-btn">ğŸ—‘ï¸ ì„ íƒì‚­ì œ</button>
<label><input type="checkbox" id="auto-save-toggle" checked> ìë™ì €ì¥</label>
<label><input type="checkbox" id="auto-chat-notify" checked> ğŸ¤– í›„ì›ì‹œ ì±—ë´‡ì•Œë¦¼</label>
<span id="chatbot-permission-status" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
</div>
<div id="quick-add-form" style="display: flex; gap: 5px; margin-bottom: 15px; align-items: center;">
<div class="autocomplete-container"><input type="text" id="quick-donor" placeholder="í›„ì›ì" class="form-input" autocomplete="off"><div id="quick-donor-autocomplete" class="donor-autocomplete"></div></div>
<select id="quick-streamer" class="form-select" style="flex: 2;"></select>
<input type="number" id="quick-amount" placeholder="ê¸ˆì•¡(ë§Œ)" class="form-input" style="flex: 1;" step="0.1">
<select id="quick-type" class="form-select" style="flex: 1;"><option value="ê³„ì¢Œ">ê³„ì¢Œ</option><option value="íˆ¬ë„¤">íˆ¬ë„¤</option><option value="ìŠˆí¼ì±—">ìŠˆí¼ì±—</option></select>
<button onclick="quickAddDonation()" id="quick-add-btn" class="btn btn-primary">ì¶”ê°€</button>
</div>
<div id="status-container"></div>
<div class="table-container" style="max-height: calc(100vh - 280px); overflow-y: auto;">
<table class="table" id="data-table">
<thead><tr><th style="width: 40px;"><input type="checkbox" id="select-all"></th><th>#</th><th>í›„ì›ì</th><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>íƒ€ì…</th><th>ê¸ˆì•¡(ë§Œ)</th><th>ì‹œê°„</th></tr></thead>
<tbody id="data-table-body"></tbody>
</table>
</div>
</div>
</div>
<div id="reset-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display:flex; align-items:center; justify-content:center;">
<div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
<h3 style="margin:0 0 10px 0;">âš ï¸ ë°ì´í„° ì´ˆê¸°í™”</h3><p style="font-size:14px; margin-bottom:15px;">ëª¨ë“  í›„ì› ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
<input type="password" id="reset-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="form-input"><div style="display: flex; gap: 10px; justify-content: flex-end; margin-top:20px;"><button onclick="closeResetDialog()" class="btn btn-secondary">ì·¨ì†Œ</button><button onclick="confirmReset()" class="btn btn-danger">ì´ˆê¸°í™”</button></div>
</div>
</div>
<script>
// --- ì „ì—­ ë³€ìˆ˜ ---
let streamers = ['ì—„ì‚¼ìš©','ì†ë•ë°°','ì—°ê¸°','ì£¼ì˜¥','ë¶ˆê³°','ì´íš¨íŒ”','ë™ë™','ë‚¨ë¶•','ì˜¥ê¸”','êµ­ê³ '];
let emojis = {'ì—„ì‚¼ìš©': 'ğŸ«…', 'ì†ë•ë°°':'ğŸŒº', 'ì—°ê¸°': 'ğŸ§', 'ë™ë™': 'ğŸ˜', 'ì£¼ì˜¥': 'ğŸ‘º', 'ë¶ˆê³°':'ğŸ¬', 'ì´íš¨íŒ”': 'ğŸ', 'ë‚¨ë¶•': 'ğŸ¤ ', 'ì˜¥ê¸”':'ğŸ¦†', 'êµ­ê³ ':'ğŸ¦'};
let donations = [], missionData = {}, user = { email: 'local@user.com', isAdmin: false };
let currentPassword = '2749'; // ê´€ë¦¬ì ì „ìš© ê³ ì • ë¹„ë°€ë²ˆí˜¸
let isAdminVerified = false; // ê´€ë¦¬ì ì¸ì¦ ìƒíƒœ
let autoSaveEnabled = true, selectedRows = new Set(), todayDonors = new Set();
let activeAutocompleteIndex = -1;
let currentlyEditing = null;
let isBusy = false;
let autoRefreshInterval = null;

// ğŸ”´ ì‹¤ì‹œê°„ Socket.io ì—°ê²°
let socket = null;
let isSocketConnected = false;

function initializeRealtimeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isSocketConnected = true;
            console.log('ğŸ”— [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
            showStatus('ğŸ”´ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨ - ê³µë™ì‘ì—… ê°€ëŠ¥!', 'success');
            updateConnectionUI(true);
            
            // ì—°ê²° ì„±ê³µ ì‹œ ì¦‰ì‹œ ë°ì´í„° ìš”ì²­
            console.log('ğŸ“¡ [ê´€ë¦¬ì] ì´ˆê¸° ë°ì´í„° ìš”ì²­ ì¤‘...');
        });
        
        socket.on('disconnect', () => {
            isSocketConnected = false;
            console.log('âŒ [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            showStatus('âš ï¸ ì‹¤ì‹œê°„ ì—°ê²° ëŠì–´ì§ - ë¡œì»¬ ëª¨ë“œë¡œ ì „í™˜', 'warning');
            updateConnectionUI(false);
        });
        
        socket.on('initialData', (data) => {
            console.log('ğŸ“Š [ê´€ë¦¬ì] ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            console.log('ğŸ“Š [ê´€ë¦¬ì] ìˆ˜ì‹ ëœ í›„ì› ë°ì´í„°:', data.donations?.length || 0, 'ê±´');
            donations = data.donations || [];
            streamers = data.streamers || streamers;
            emojis = data.emojis || emojis;
            
            // ì„œë²„ ì„¤ì •ì„ UIì— ì ìš©
            if (data.settings) {
                console.log('âš™ï¸ [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • ì ìš© ì¤‘:', data.settings);
                applyServerSettingsToUI(data.settings);
            }
            
            updateAllUI();
            console.log('âœ… [ê´€ë¦¬ì] ì´ˆê¸° UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        });
        
        socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            console.log('ğŸ”„ [ê´€ë¦¬ì] ìˆ˜ì‹ ëœ í›„ì› ë°ì´í„°:', data.donations?.length || 0, 'ê±´');
            donations = data.donations || [];
            updateAllUI();
            showStatus('âœ¨ ìƒˆ í›„ì› ë°ì´í„° ë™ê¸°í™”!', 'success', 2000);
            
            // ì„ íƒëœ í–‰ë“¤ ì´ˆê¸°í™” (ì‚­ì œëœ í•­ëª©ë“¤ì´ í¬í•¨ë  ìˆ˜ ìˆìŒ)
            selectedRows.clear();
            
            // localStorageë„ ìµœì‹  ë°ì´í„°ë¡œ ë™ê¸°í™” (ë¡œì»¬ëª¨ë“œì—ì„œ ë°ì´í„° ë¶€í™œ ë°©ì§€)
            saveToLocalStorage();
            
            console.log('âœ… [ê´€ë¦¬ì] ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        });
        
        socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', settings);
            applyServerSettingsToUI(settings);
            showStatus('âš™ï¸ ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'info', 2000);
        });
        
    } catch (error) {
        console.error('Socket.io ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showStatus('âŒ ì‹¤ì‹œê°„ ì—°ê²° ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘', 'warning');
        updateConnectionUI(false);
    }
}

// ì—°ê²° ìƒíƒœ UI ì—…ë°ì´íŠ¸
function updateConnectionUI(connected) {
    // ì œëª©ì— ì—°ê²° ìƒíƒœ í‘œì‹œ
    const title = document.querySelector('title');
    if (title) {
        if (connected) {
            title.textContent = 'ğŸ”´ ì‹¤ì‹œê°„ ë°©ì†¡ í›„ì› ì •ì‚° ì‹œìŠ¤í…œ (ì—°ê²°ë¨)';
        } else {
            title.textContent = 'âšª ë°©ì†¡ í›„ì› ì •ì‚° ì‹œìŠ¤í…œ (ë¡œì»¬ëª¨ë“œ)';
        }
    }
    
    // ì—°ê²° ìƒíƒœ í‘œì‹œ ìš”ì†Œê°€ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
    const statusElements = document.querySelectorAll('[data-connection-status]');
    statusElements.forEach(el => {
        if (connected) {
            el.textContent = 'ğŸ”´ ì‹¤ì‹œê°„ ì—°ê²°';
            el.className = 'status-success';
        } else {
            el.textContent = 'âšª ë¡œì»¬ ëª¨ë“œ';
            el.className = 'status-warning';
        }
    });
}

// YouTube API ê´€ë ¨ ë³€ìˆ˜
let youtubeApiKey = '';
let liveChatId = '';

// ë°±ì—… API í‚¤ë“¤ (í• ë‹¹ëŸ‰ ì´ˆê³¼ì‹œ ìë™ ì „í™˜)
let backupApiKeys = [
    'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4', // ë©”ì¸ YouTube API í‚¤ (ì—…ë°ì´íŠ¸ë¨)
    'AIzaSyCTTBeP7zWHyuP5FuuQlOOity-2_hPjHmM'  // ë°±ì—… í‚¤
];
let currentKeyIndex = 0;

// Google Drive API ê´€ë ¨ ë³€ìˆ˜
let isGoogleSignedIn = false;
let googleUser = null;
let autoBackupEnabled = false;
let autoBackupInterval = null;
let autoSendInterval = null;
let isAutoSending = false;

// --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ---
const STORAGE_KEYS = {
    DONATIONS: 'donation_data',
    STREAMERS: 'streamer_config',
    EMOJIS: 'streamer_emojis',  
    MISSIONS: 'mission_data',
    PASSWORD: 'admin_password',
    YOUTUBE_API_KEY: 'youtube_api_key',
    YOUTUBE_VIDEO_ID: 'youtube_video_id'
};

// --- ì•± ì‹œì‘ ---
document.addEventListener('DOMContentLoaded', initializeApp);

// ì•ˆì „í•œ DOM ì¡°ì‘ í—¬í¼ í•¨ìˆ˜ë“¤
function safeGetElement(id) {
    try {
        return document.getElementById(id);
    } catch (error) {
        console.error(`ìš”ì†Œ ${id} ì ‘ê·¼ ì‹¤íŒ¨:`, error);
        return null;
    }
}

function safeSetProperty(element, property, value) {
    try {
        if (element && element[property] !== undefined) {
            element[property] = value;
            return true;
        }
        return false;
    } catch (error) {
        console.error(`ì†ì„± ${property} ì„¤ì • ì‹¤íŒ¨:`, error);
        return false;
    }
}

function safeAddClass(element, className) {
    try {
        if (element && element.classList) {
            element.classList.add(className);
            return true;
        }
        return false;
    } catch (error) {
        console.error(`í´ë˜ìŠ¤ ${className} ì¶”ê°€ ì‹¤íŒ¨:`, error);
        return false;
    }
}

// --- í•µì‹¬ ë¡œì§ (ì´ˆê¸°í™” ë° ë™ê¸°í™” ì œì–´) ---
async function initializeApp() {
    const loader = safeGetElement('app-loader');
    
    try {
        console.log("ì•ˆì „í•œ ì´ˆê¸°í™” ì‹œì‘...");
        
        // ê° ì´ˆê¸°í™” ë‹¨ê³„ë¥¼ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
        try { initEventListeners(); } catch (e) { console.error('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
        try { loadFromLocalStorage(); } catch (e) { console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', e); }
        try { loadYouTubeSettings(); } catch (e) { console.error('YouTube ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e); }
        try { loadOverlaySettings(); } catch (e) { console.error('ì˜¤ë²„ë ˆì´ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e); }
        
        try { 
            await updateUserInfo(); 
        } catch (e) { 
            console.error('ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
        }
        
        // ğŸ”´ ì‹¤ì‹œê°„ Socket.io ì—°ê²° ì´ˆê¸°í™”
        try {
            initializeRealtimeConnection();
        } catch (e) {
            console.error('ì‹¤ì‹œê°„ ì—°ê²° ì´ˆê¸°í™” ì‹¤íŒ¨:', e); 
        }
        
        try { updateAllUI(); } catch (e) { console.error('UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
        try { updateAdminElements(); } catch (e) { console.error('ê´€ë¦¬ì ìš”ì†Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
        try { updateTabVisibility(); } catch (e) { console.error('íƒ­ ê°€ì‹œì„± ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e); }
        
        // ì¡°ì • ëª¨ë“œ ê¸°ë³¸ê°’ ì„¤ì • (ì•ˆì „í•˜ê²Œ)
        setTimeout(() => {
            try {
                switchSimpleMode('streamer');
            } catch (e) {
                console.error('ì¡°ì • ëª¨ë“œ ì„¤ì • ì‹¤íŒ¨:', e);
            }
        }, 100);
        
        // ì•± ì»¨í…Œì´ë„ˆ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬ (ì™„ì „íˆ ì•ˆì „í•˜ê²Œ)
        setTimeout(() => {
            const appContainer = safeGetElement('app-container');
            if (appContainer) {
                safeAddClass(appContainer, 'loaded');
                console.log('ì•± ì»¨í…Œì´ë„ˆ ë¡œë”© ì™„ë£Œ');
            } else {
                console.warn('app-container ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - ê°•ì œë¡œ í‘œì‹œí•©ë‹ˆë‹¤');
                // ëŒ€ì²´ ë°©ë²•: CSSë¥¼ ì§ì ‘ ìˆ˜ì •
                const style = document.createElement('style');
                style.textContent = '.container { display: grid !important; }';
                document.head.appendChild(style);
            }
            
            if (loader) {
                safeSetProperty(loader.style, 'display', 'none');
            }
        }, 200);
        
        console.log("Application loaded successfully.");
        
        // Google API ì´ˆê¸°í™” (ì•ˆì „í•˜ê²Œ)
        setTimeout(() => {
            try {
                initGoogleAPI();
            } catch (e) {
                console.error('Google API ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
            }
        }, 300);
        
    } catch (error) {
        console.error("Critical initialization error:", error);
        
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì•ˆì „ ëª¨ë“œ í™œì„±í™”
        try {
            if (loader) {
                const spinner = loader.querySelector('.spinner');
                const message = loader.querySelector('p');
                
                if (spinner) spinner.style.display = 'none';
                if (message) message.textContent = `ì•± ë¡œë”© ì‹¤íŒ¨: ${error.message} - ì•ˆì „ ëª¨ë“œë¡œ ê³„ì†...`;
            }
            
            // ê°•ì œë¡œ ì•± í‘œì‹œ
            setTimeout(() => {
                const style = document.createElement('style');
                style.textContent = `
                    #app-loader { display: none !important; }
                    .container { display: grid !important; }
                `;
                document.head.appendChild(style);
                console.log('ì•ˆì „ ëª¨ë“œë¡œ ì•±ì„ ê°•ì œ í‘œì‹œí–ˆìŠµë‹ˆë‹¤');
            }, 1000);
            
        } catch (fallbackError) {
            console.error("Even fallback failed:", fallbackError);
        }
    }
}

// --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ---
function saveToLocalStorage() {
    try {
        localStorage.setItem(STORAGE_KEYS.DONATIONS, JSON.stringify(donations));
        localStorage.setItem(STORAGE_KEYS.STREAMERS, JSON.stringify(streamers));
        localStorage.setItem(STORAGE_KEYS.EMOJIS, JSON.stringify(emojis));
        localStorage.setItem(STORAGE_KEYS.MISSIONS, JSON.stringify(missionData));
        localStorage.setItem(STORAGE_KEYS.PASSWORD, currentPassword);
    } catch (error) {
        console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

function loadFromLocalStorage() {
    try {
        const savedDonations = localStorage.getItem(STORAGE_KEYS.DONATIONS);
        const savedStreamers = localStorage.getItem(STORAGE_KEYS.STREAMERS);
        const savedEmojis = localStorage.getItem(STORAGE_KEYS.EMOJIS);
        const savedMissions = localStorage.getItem(STORAGE_KEYS.MISSIONS);
        const savedPassword = localStorage.getItem(STORAGE_KEYS.PASSWORD);

        if (savedDonations) {
            donations = JSON.parse(savedDonations).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
        }
        if (savedStreamers) streamers = JSON.parse(savedStreamers);
        if (savedEmojis) emojis = JSON.parse(savedEmojis);
        if (savedMissions) missionData = JSON.parse(savedMissions);
        if (savedPassword) currentPassword = savedPassword;

        // í›„ì›ì ëª©ë¡ ì¬êµ¬ì„±
        todayDonors = new Set(donations.map(d => d.donor));
    } catch (error) {
        console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

async function performSafeWrite(actionDescription, writeFunction) {
    if (isBusy) {
        showStatus('ì´ì „ ì‘ì—…ì´ ì•„ì§ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.', 'warning');
        return;
    }
    
    isBusy = true;
    showSaveStatus(actionDescription, 'saving');

    try {
        const result = await writeFunction();
        saveToLocalStorage();
        showSaveStatus('ì™„ë£Œ', 'saved');
        return result;
    } catch (error) {
        showSaveStatus('ì‹¤íŒ¨', 'error');
        showStatus(error.message, 'error');
        throw error;
    } finally {
        isBusy = false;
        updateAllUI();
    }
}

// --- ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬ ---
async function loadData(isSilent = false) {
    loadFromLocalStorage();
    donations.sort((a, b) => b.time - a.time);
    updateAllUI();
    if (!isSilent) {
        showSaveStatus('ë¡œë”© ì™„ë£Œ', 'saved');
    }
}

function addDonation() {
    const donor = document.getElementById('donor-input').value.trim();
    if (!donor) return showStatus('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    const inputs = document.querySelectorAll('#streamer-inputs input[type="number"]');
    const newDons = [];
    inputs.forEach(input => {
        const amount = parseFloat(input.value);
        if (!isNaN(amount) && amount > 0) {
            const streamerName = input.dataset.streamer;
            newDons.push({ donor, streamer: streamerName, type: document.querySelector('input[name="paytype"]:checked').value, amount, time: new Date() });
        }
    });
    if (newDons.length > 0) {
        document.getElementById('donor-input').value = '';
        inputs.forEach(input => input.value = '');
        handleNewDonations(newDons);
    } else {
        showStatus('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    }
}

// ì¡°ì • ëª¨ë“œ ì „í™˜
function switchSimpleMode(mode) {
    const streamerPanel = document.getElementById('streamer-mode-panel');
    const donorPanel = document.getElementById('donor-mode-panel');
    const streamerBtn = document.getElementById('streamer-mode-btn');
    const donorBtn = document.getElementById('donor-mode-btn');
    
    if (mode === 'streamer') {
        streamerPanel.style.display = 'block';
        donorPanel.style.display = 'none';
        streamerBtn.classList.remove('btn-secondary');
        streamerBtn.classList.add('btn-primary');
        donorBtn.classList.remove('btn-primary');
        donorBtn.classList.add('btn-secondary');
        updateStreamerModeSelect();
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ëª¨ë“œ: ìŠ¤íŠ¸ë¦¬ë¨¸ ìš”ì•½ë§Œ ë³´ì´ê¸°
        updateSummaryVisibility('streamer');
        
    } else if (mode === 'donor') {
        streamerPanel.style.display = 'none';
        donorPanel.style.display = 'block';
        donorBtn.classList.remove('btn-secondary');
        donorBtn.classList.add('btn-primary');
        streamerBtn.classList.remove('btn-primary');
        streamerBtn.classList.add('btn-secondary');
        
        // í›„ì›ìë³„ ì¡°ì • ëª¨ë“œ: í›„ì›ì ìš”ì•½ë§Œ ë³´ì´ê¸°
        updateSummaryVisibility('donor');
    }
}

// ìš”ì•½ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
function updateSummaryVisibility(mode) {
    // ê°„ë‹¨ ëª¨ë“œ ì „ìš©ì¼ ë•Œë§Œ ì ìš©
    const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
    const isAdmin = isAdminVerified;
    
    // ê°„ë‹¨ ëª¨ë“œê°€ ì•„ë‹ˆê±°ë‚˜ ê´€ë¦¬ìì¸ ê²½ìš° ëª¨ë“  ìš”ì•½ ë³´ì´ê¸°
    if (!isSimpleModeOnly || isAdmin) {
        showAllSummaries();
        return;
    }
    
    // ìš”ì•½ ì„¹ì…˜ë“¤
    const streamerSummary = document.querySelector('#basic-summary > div:nth-child(1)'); // ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡
    const donorSummary = document.querySelector('#basic-summary > div:nth-child(2)'); // í›„ì›ìë³„ ì´ì•¡
    const recentSummary = document.querySelector('#basic-summary > div:nth-child(3)'); // ìµœê·¼ ì…ê¸ˆ ë‚´ì—­
    
    if (mode === 'streamer') {
        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •: ìŠ¤íŠ¸ë¦¬ë¨¸ ìš”ì•½ë§Œ ë³´ì´ê¸°
        if (streamerSummary) streamerSummary.style.display = 'block';
        if (donorSummary) donorSummary.style.display = 'none';
        if (recentSummary) recentSummary.style.display = 'none';
    } else if (mode === 'donor') {
        // í›„ì›ìë³„ ì¡°ì •: í›„ì›ì ìš”ì•½ë§Œ ë³´ì´ê¸°
        if (streamerSummary) streamerSummary.style.display = 'none';
        if (donorSummary) donorSummary.style.display = 'block';
        if (recentSummary) recentSummary.style.display = 'none';
    }
}

// ëª¨ë“  ìš”ì•½ ë³´ì´ê¸° (ê´€ë¦¬ì ëª¨ë“œ)
function showAllSummaries() {
    const streamerSummary = document.querySelector('#basic-summary > div:nth-child(1)');
    const donorSummary = document.querySelector('#basic-summary > div:nth-child(2)');
    const recentSummary = document.querySelector('#basic-summary > div:nth-child(3)');
    
    if (streamerSummary) streamerSummary.style.display = 'block';
    if (donorSummary) donorSummary.style.display = 'block';
    if (recentSummary) recentSummary.style.display = 'block';
}

// ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡ ì¡°ì •
function adjustStreamerAmount() {
    const streamer = document.getElementById('streamer-mode-select').value;
    const amount = parseFloat(document.getElementById('streamer-amount-input').value);
    const type = document.querySelector('input[name="streamer-paytype"]:checked').value;
    
    if (!streamer) return showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error');
    if (!amount || amount === 0) return showStatus('ì¡°ì •í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    
    const adjustmentDonation = {
        donor: `ì¡°ì •(${amount > 0 ? '+' : ''}${amount})`,
        streamer,
        type,
        amount,
        time: new Date()
    };
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('streamer-amount-input').value = '';
    
    handleNewDonations([adjustmentDonation]);
    updateSimpleRecentList();
    showStatus(`${streamer} ${amount > 0 ? '+' : ''}${amount}ë§Œì› ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

// í›„ì›ìë³„ ê¸ˆì•¡ ì¡°ì •
function adjustDonorAmount() {
    const donor = document.getElementById('donor-mode-input').value.trim();
    const amount = parseFloat(document.getElementById('donor-amount-input').value);
    const type = document.querySelector('input[name="donor-paytype"]:checked').value;
    
    if (!donor) return showStatus('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    if (!amount || amount === 0) return showStatus('ì¡°ì •í•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    
    // í›„ì›ìë³„ ì¡°ì •ì€ ê°€ìƒ ìŠ¤íŠ¸ë¦¬ë¨¸ì— ë°°ì • (ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ì— ì˜í–¥ ì•ˆì¤Œ)
    const adjustmentDonation = {
        donor: `${donor}(ì¡°ì •${amount > 0 ? '+' : ''}${amount})`,
        streamer: 'í›„ì›ìì¡°ì •', // ê°€ìƒ ìŠ¤íŠ¸ë¦¬ë¨¸
        type,
        amount,
        time: new Date()
    };
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('donor-mode-input').value = '';
    document.getElementById('donor-amount-input').value = '';
    
    handleNewDonations([adjustmentDonation]);
    updateSimpleRecentList();
    showStatus(`${donor}ë‹˜ ${amount > 0 ? '+' : ''}${amount}ë§Œì› ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

// ê¸°ë³¸ ìŠ¤íŠ¸ë¦¬ë¨¸ ì°¾ê¸° (ê°€ì¥ ìµœê·¼ì— ì‚¬ìš©ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ ë˜ëŠ” ì²« ë²ˆì§¸)
function getDefaultStreamer() {
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s) && s !== 'êµ­ê³ ');
    
    if (visibleStreamers.length === 0) return 'êµ­ê³ ';
    
    // ìµœê·¼ í›„ì›ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ ì°¾ê¸°
    if (donations && donations.length > 0) {
        const recentDonations = donations.slice(-20); // ìµœê·¼ 20ê°œ
        const streamerCounts = {};
        
        recentDonations.forEach(d => {
            if (visibleStreamers.includes(d.streamer)) {
                streamerCounts[d.streamer] = (streamerCounts[d.streamer] || 0) + 1;
            }
        });
        
        const mostUsed = Object.keys(streamerCounts).reduce((a, b) => 
            streamerCounts[a] > streamerCounts[b] ? a : b, visibleStreamers[0]);
        
        return mostUsed;
    }
    
    return visibleStreamers[0];
}

function quickAddDonation() {
    const d = document.getElementById('quick-donor'), s = document.getElementById('quick-streamer'), a = document.getElementById('quick-amount'), t = document.getElementById('quick-type');
    const donor = d.value.trim();
    const amount = parseFloat(a.value);
    if (!donor || isNaN(amount) || amount <= 0) return showStatus('í›„ì›ìëª…ê³¼ ê¸ˆì•¡(ë§Œ)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.', 'error');
    handleNewDonations([{ donor, streamer: s.value, type: t.value, amount, time: new Date() }]);
    a.value = '';
    d.focus();
    d.select();
}

async function handleNewDonations(newDonations) {
    if (!newDonations || newDonations.length === 0) return;

    donations.unshift(...newDonations);
    donations.sort((a, b) => b.time - a.time);
    newDonations.forEach(d => todayDonors.add(d.donor));
    
    // ğŸ”´ ì¦‰ì‹œ ë¡œì»¬ í™”ë©´ ì—…ë°ì´íŠ¸ (ë°˜ì‘ì„± í–¥ìƒ)
    updateAllUI();
    
    // ğŸ”´ ì‹¤ì‹œê°„ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
    if (isSocketConnected && socket) {
        try {
            for (const donation of newDonations) {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        donor: donation.donor,
                        streamer: donation.streamer,
                        type: donation.type,
                        amount: donation.amount
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ì„œë²„ë¡œ í›„ì› ì „ì†¡ ì„±ê³µ:', donation);
                    console.log('ğŸ“¡ [ê´€ë¦¬ì] ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                } else {
                    console.error('âŒ [ê´€ë¦¬ì] ì‹¤ì‹œê°„ ì„œë²„ ì „ì†¡ ì‹¤íŒ¨:', response.statusText);
                    console.error('ğŸ“¡ [ê´€ë¦¬ì] ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                    // ì‹¤ì‹œê°„ ì „ì†¡ ì‹¤íŒ¨í•´ë„ ë¡œì»¬ì€ ì—…ë°ì´íŠ¸ë¨
                }
            }
            showSaveStatus('ğŸ”´ ì‹¤ì‹œê°„ ë™ê¸°í™” ì™„ë£Œ', 'saved');
        } catch (error) {
            console.error('ì‹¤ì‹œê°„ ì „ì†¡ ì˜¤ë¥˜:', error);
            showSaveStatus('âš ï¸ ì‹¤ì‹œê°„ ì „ì†¡ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ë¨)', 'warning');
            // ì‹¤ì‹œê°„ ì‹¤íŒ¨í•´ë„ ë¡œì»¬ ì‘ì—…ì€ ê³„ì†
        }
    } else {
        console.log('âš ï¸ ì‹¤ì‹œê°„ ì—°ê²° ì—†ìŒ, ë¡œì»¬ ëª¨ë“œë¡œ ë™ì‘');
        showSaveStatus('ğŸ’¾ ë¡œì»¬ ëª¨ë“œë¡œ ì €ì¥', 'warning');
    }
    
    // ë¡œì»¬ ì €ì¥ (ë°±ì—…ìš©)
    if (autoSaveEnabled) {
        saveToLocalStorage();
    }
    
    // ğŸ¤– í›„ì›ì‹œ ì±—ë´‡ ìë™ ì•Œë¦¼
    if (document.getElementById('auto-chat-notify') && document.getElementById('auto-chat-notify').checked) {
        sendDonationNotification(newDonations);
    }
}

async function deleteSelected() {
    if (selectedRows.size === 0 || !confirm(`${selectedRows.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    const indicesToDelete = Array.from(selectedRows).sort((a, b) => b - a);
    let deleteCount = 0;
    
    // ì„œë²„ì—ì„œ ì‚­ì œ ì‹œë„
    for (const index of indicesToDelete) {
        const donation = donations[index];
        console.log('ì‚­ì œ ì‹œë„í•˜ëŠ” í›„ì›:', donation);
        
        if (donation && donation.time) {
            try {
                if (isSocketConnected) {
                    // ì„œë²„ì— ì‚­ì œ ìš”ì²­
                    console.log(`ì„œë²„ ì‚­ì œ API í˜¸ì¶œ: /api/donations/${donation.time}`);
                    const response = await fetch(`/api/donations/${donation.time}`, {
                        method: 'DELETE'
                    });
                    
                    console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
                    
                    if (response.ok) {
                        deleteCount++;
                        console.log('âœ… ì„œë²„ì—ì„œ í›„ì› ì‚­ì œ ì„±ê³µ:', donation.donor);
                        // ì„œë²„ ì‚­ì œ ì„±ê³µ ì‹œì—ëŠ” dataUpdate ì´ë²¤íŠ¸ë¡œ UIê°€ ìë™ ì—…ë°ì´íŠ¸ë¨
                    } else {
                        console.error('âŒ ì„œë²„ ì‚­ì œ ì‹¤íŒ¨:', donation.donor);
                        // ì„œë²„ ì‚­ì œ ì‹¤íŒ¨ ì‹œì—ë§Œ ë¡œì»¬ì—ì„œ ì‚­ì œ
                        donations.splice(index, 1);
                        deleteCount++;
                    }
                } else {
                    // ì—°ê²° ì—†ìœ¼ë©´ ë¡œì»¬ì—ì„œë§Œ ì‚­ì œ
                    donations.splice(index, 1);
                    deleteCount++;
                }
            } catch (error) {
                console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ì‹œ ë¡œì»¬ì—ì„œë¼ë„ ì‚­ì œ
                donations.splice(index, 1);
                deleteCount++;
            }
        }
    }
    
    selectedRows.clear();
    
    // ì„œë²„ ì—°ê²°ì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ë¡œì»¬ ì €ì¥
    if (!isSocketConnected) {
        saveToLocalStorage();
        updateAllUI();
    }
    
    showStatus(`${deleteCount}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

// --- ì„œë²„ ë™ê¸°í™” í•¨ìˆ˜ ---
async function syncToServer() {
    if (!isSocketConnected) {
        console.log('âš ï¸ ì„œë²„ ì—°ê²° ì—†ìŒ, ë™ê¸°í™” ìƒëµ');
        return;
    }
    
    try {
        console.log('ğŸ”„ ì„œë²„ ë™ê¸°í™” ì‹œì‘...');
        const response = await fetch('/api/donations/bulk', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ donations })
        });
        
        if (response.ok) {
            console.log('âœ… ì„œë²„ ë™ê¸°í™” ì„±ê³µ');
        } else {
            console.error('âŒ ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', response.status);
        }
    } catch (error) {
        console.error('âŒ ì„œë²„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
    }
}

// --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
function updateAllUI() {
    updateStreamerInputs();
    updateStreamerList();
    updateMissionSettingsUI();
    updateTable();
    updateSummary();
    updateQuickAddForm();
    updateSimpleMode();
}

// ê°„ë‹¨ ëª¨ë“œ UI ì—…ë°ì´íŠ¸
function updateSimpleMode() {
    updateStreamerModeSelect();
    updateSimpleRecentList();
}

function updateStreamerModeSelect() {
    const select = document.getElementById('streamer-mode-select');
    if (select) {
        const currentVal = select.value;
        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s));
        
        select.innerHTML = '<option value="">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</option>' + 
            visibleStreamers.map(str => `<option value="${str}">${emojis[str] || ''}${str}</option>`).join('');
        
        if (visibleStreamers.includes(currentVal)) {
            select.value = currentVal;
        }
    }
}

function updateSimpleRecentList() {
    const listContainer = document.getElementById('simple-recent-list');
    if (!listContainer) return;
    
    if (!donations || donations.length === 0) {
        listContainer.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ë“±ë¡ëœ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }
    
    // ìµœê·¼ 10ê°œë§Œ í‘œì‹œ
    const recentDonations = donations.slice(-10).reverse();
    const listHtml = recentDonations.map(d => {
        const timeStr = new Date(d.time).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
        const emoji = emojis[d.streamer] || '';
        return `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">
            <span style="font-weight: bold;">${d.donor}</span> â†’
            <span style="color: #666;">${emoji}${d.streamer}</span>
            <span style="color: #e74c3c; font-weight: bold;">${d.amount}ë§Œ</span>
            <span style="color: #999; font-size: 11px;">(${d.type}, ${timeStr})</span>
        </div>`;
    }).join('');
    
    listContainer.innerHTML = listHtml;
}

function updateTable() {
    const tableBody = document.getElementById('data-table-body');
    if (!tableBody) return;
    
    selectedRows.clear();
    const selectAllCheckbox = document.getElementById('select-all');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;

    tableBody.innerHTML = (donations || []).map((d, i) => `
    <tr data-index="${i}">
        <td><input type="checkbox" onchange="toggleRowSelection(${i}, this.checked)"></td>
        <td>${donations.length - i}</td>
        <td data-field="donor" ondblclick="makeCellEditable(this, ${i})">${d.donor}</td>
        <td data-field="streamer" ondblclick="makeCellEditable(this, ${i})">${emojis[d.streamer] || ''}${d.streamer}</td>
        <td data-field="type" ondblclick="makeCellEditable(this, ${i})">${d.type}</td>
        <td data-field="amount" ondblclick="makeCellEditable(this, ${i})">${parseFloat(d.amount)}</td>
        <td data-field="time">${d.time ? new Date(d.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : 'N/A'}</td>
    </tr>`).join('') || `<tr><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>`;
}

function updateSummary() {
    let streamerTotals = {}, totalAmount = 0;
    (streamers || []).forEach(s => streamerTotals[s] = 0);
    if (!streamerTotals.hasOwnProperty('êµ­ê³ ')) {
        streamerTotals['êµ­ê³ '] = 0;
    }

    let donorAccountTotals = {}; 

    donations.forEach(d => {
        const amount = parseFloat(d.amount) || 0;
        
        if (streamerTotals.hasOwnProperty(d.streamer)) {
            streamerTotals[d.streamer] += amount;
        } else {
            streamerTotals['êµ­ê³ '] = (streamerTotals['êµ­ê³ '] || 0) + amount;
        }
        totalAmount += amount;

        if (d.type === 'ê³„ì¢Œ') {
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •ì€ ì œì™¸, í›„ì›ìë³„ ì¡°ì •ì€ í¬í•¨
            if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • â†’ ì œì™¸
                return;
            }
            
            // í›„ì›ìëª…ì—ì„œ (ì¡°ì •+ê¸ˆì•¡) ë¶€ë¶„ ì œê±°
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(ì¡°ì •')) {
                cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '');
            }
            
            // ê³„ì¢Œí›„ì›ìë‹˜ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ (íŠ¹ë³„ ì²˜ë¦¬)
            if (cleanDonorName === 'ê³„ì¢Œí›„ì›ìë‹˜' || cleanDonorName === 'ê³„ì¢Œí›„ì›ì') {
                cleanDonorName = 'ê³„ì¢Œí›„ì›ìë‹˜';
            }
            
            donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
        }
    });

    // ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì • ë¡œë“œ
    const headerText = localStorage.getItem('streamer-summary-header') || 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
    const footerText = localStorage.getItem('streamer-summary-footer') || 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
    const excludeGukgo = localStorage.getItem('exclude-gukgo') !== 'false'; // ê¸°ë³¸ê°’: true
    
    // ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë¨¸ ë°ì´í„° ê³„ì‚°
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const summaryStreamers = (streamers || []).filter(s => s !== 'êµ­ê³ ' && s !== 'í›„ì›ìì¡°ì •' && !hiddenStreamers.includes(s));
    const streamerDetailData = {};
    summaryStreamers.forEach(s => { streamerDetailData[s] = { name: s, account: 0, toonation: 0, total: 0 }; });
    donations.forEach(d => {
        if (streamerDetailData.hasOwnProperty(d.streamer)) {
            const amount = parseFloat(d.amount) || 0;
            if (d.type === 'ê³„ì¢Œ') streamerDetailData[d.streamer].account += amount;
            else if (d.type === 'íˆ¬ë„¤') streamerDetailData[d.streamer].toonation += amount;
        }
    });
    
    // ì´ì•¡ ê³„ì‚° í›„ ì •ë ¬ (ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼)
    let sortedDetailStreamers = Object.values(streamerDetailData).map(data => { 
        data.total = data.account + data.toonation; 
        return data; 
    }).sort((a, b) => b.total - a.total);
    
    // ì—„ì‚¼ìš© ìš°ì„  ë°°ì¹˜ (ìˆëŠ” ê²½ìš°)
    if (sortedDetailStreamers.find(s => s.name === 'ì—„ì‚¼ìš©')) {
        const samyongData = sortedDetailStreamers.find(s => s.name === 'ì—„ì‚¼ìš©');
        sortedDetailStreamers = sortedDetailStreamers.filter(s => s.name !== 'ì—„ì‚¼ìš©');
        sortedDetailStreamers.unshift(samyongData);
    }
    
    const samyongSchool = sortedDetailStreamers.map(s => `${emojis[s.name] || ''}${s.name}(${s.total})`).join(' ');
    
    // ì´í•© ê³„ì‚° (ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼ - êµ­ê³  í•­ìƒ ì œì™¸)
    const displayTotalAmount = sortedDetailStreamers.reduce((sum, s) => sum + s.total, 0);
    
    // ì¶œë ¥ í˜•ì‹ (êµ­ê³  ì œì™¸ ì˜µì…˜ ë¬´ì‹œ - ìƒì„¸ í…Œì´ë¸”ê³¼ ì¼ì¹˜)
    let summaryText = `${headerText}| ${samyongSchool} | ğŸ’µì´í•©(${displayTotalAmount}) | ${footerText}`;
    
    document.getElementById('summary-output').textContent = summaryText;
    
    const groupThreshold = parseInt(document.getElementById('group-threshold').value, 10) || 1;
    
    // ê·¸ë£¹í™” ì„ê³„ê°’ì„ localStorageì— ì €ì¥ (ì˜¤ë²„ë ˆì´ì—ì„œ ì‚¬ìš©)
    localStorage.setItem('group-threshold', groupThreshold.toString());
    const amountGroups = {};
    for (const donor in donorAccountTotals) {
        const amount = donorAccountTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    // ì†Œì•¡ í•„í„°ë§ (0.1ë§Œì› ë¯¸ë§Œ ì œì™¸)
    const filteredGroups = Object.entries(amountGroups).filter(([amount]) => parseFloat(amount) >= 0.1);
    const sortedGroups = filteredGroups.sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    const donorTotalText = sortedGroups.map(([amount, donors]) => {
        const amountStr = `${parseFloat(amount)}ë§Œ`;
        if (donors.length >= groupThreshold && groupThreshold > 1) {
            return `${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`;
        } else {
            return donors.map(d => `${d}ë‹˜ ${amountStr}`).join('\n');
        }
    }).join('\n');
    
    // "ì‚¬ë‘í•´ìš”â™¡" ì¸ì‚¬ë§ê³¼ í•¨ê»˜ í‘œì‹œ
    const finalText = donorTotalText ? `ì‚¬ë‘í•´ìš”â™¡\n${donorTotalText}` : 'ì‚¬ë‘í•´ìš”â™¡\ní›„ì›ìê°€ ì—†ìŠµë‹ˆë‹¤';
    document.getElementById('donor-total').textContent = finalText;

    const minutes = parseInt(document.getElementById('recent-minutes').value, 10);
    const recentDonations = (donations || []).filter(d => (Date.now() - new Date(d.time).getTime()) < minutes * 60 * 1000);
    const groupedDonations = recentDonations.reduce((acc, d) => {
        const key = `${d.donor}-${new Date(d.time).getTime()}`;
        if (!acc[key]) { acc[key] = { donor: d.donor, donations: [], time: d.time }; }
        acc[key].donations.push(d); return acc;
    }, {});
    document.getElementById('recent-log').textContent = Object.values(groupedDonations).sort((a,b) => b.time - a.time).map(group => {
        const donationTexts = group.donations.map(d => {
            const totalForStreamer = parseFloat(streamerTotals[d.streamer] || 0);
            return `${emojis[d.streamer] || ''}${d.streamer} (+${parseFloat(d.amount)}/${totalForStreamer})`;
        }).join(', ');
        return `${group.donor} > ${donationTexts}`;
    }).join('\n');

    updateMissionSummary();
    updateDetailedSummaryTable();
}

function updateStreamerInputs() {
    const container = document.getElementById('streamer-inputs');
    if(container) container.innerHTML = (streamers || []).map((s) => {
      return `<div><label>${emojis[s] || ''}${s}</label><input type="number" min="0" step="0.1" data-streamer="${s}" placeholder="0" class="form-input"></div>`;
    }).join('');
}

function updateStreamerList() {
    const container = document.getElementById('streamer-list');
    if(container) {
        if (!streamers || streamers.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                    <p style="margin: 0; font-size: 16px;">ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">ìœ„ì—ì„œ ìƒˆ ìŠ¤íŠ¸ë¦¬ë¨¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
                </div>
            `;
            return;
        }

        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        container.innerHTML = (streamers || []).map((s, index) => {
            const isHidden = hiddenStreamers.includes(s);
            const emoji = emojis[s] || 'ğŸ‘¤';
            return `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #e9ecef; ${isHidden ? 'opacity: 0.5;' : ''}" ${isHidden ? 'title="ì„ì‹œ ìˆ¨ê¹€ ìƒíƒœ"' : ''}>
                    <div style="display: flex; align-items: center; flex-grow: 1;">
                        <div style="display: flex; align-items: center; margin-right: 15px;">
                            <input type="checkbox" onchange="toggleStreamerVisibility('${s}')" ${isHidden ? '' : 'checked'} 
                                   style="margin-right: 10px; transform: scale(1.2);">
                            <span style="background: #f8f9fa; border-radius: 20px; padding: 2px 8px; font-size: 12px; color: #495057;">
                                ${index + 1}
                            </span>
                        </div>
                        <div>
                            <span style="font-size: 24px; margin-right: 8px;">${emoji}</span>
                            <span style="font-size: 16px; font-weight: 500;">${s}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="editStreamer('${s}')" class="btn btn-secondary" 
                                style="font-size: 12px; padding: 4px 8px; background: #6c757d;">
                            âœï¸ ìˆ˜ì •
                        </button>
                        <button onclick="deleteStreamer('${s}')" class="btn btn-danger" 
                                style="font-size: 12px; padding: 4px 8px;">
                            ğŸ—‘ï¸ ì‚­ì œ
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function toggleStreamerVisibility(streamerName) {
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const index = hiddenStreamers.indexOf(streamerName);
    
    if (index > -1) {
        // í˜„ì¬ ìˆ¨ê¹€ ìƒíƒœ â†’ ë³´ì´ê¸°
        hiddenStreamers.splice(index, 1);
        showStatus(`${streamerName}ì´(ê°€) ë‹¤ì‹œ í‘œì‹œë©ë‹ˆë‹¤`, 'info');
    } else {
        // í˜„ì¬ ë³´ì„ ìƒíƒœ â†’ ìˆ¨ê¸°ê¸°
        hiddenStreamers.push(streamerName);
        showStatus(`${streamerName}ì´(ê°€) ì„ì‹œë¡œ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤`, 'warning');
    }
    
    localStorage.setItem('hidden-streamers', JSON.stringify(hiddenStreamers));
    updateStreamerList();
    updateAllUI(); // ëª¨ë“  UI ì—…ë°ì´íŠ¸
}

function updateQuickAddForm() {
    const select = document.getElementById('quick-streamer');
    if (select) {
        const currentVal = select.value;
        const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
        const visibleStreamers = (streamers || []).filter(s => !hiddenStreamers.includes(s));
        select.innerHTML = visibleStreamers.map(str => `<option value="${str}">${emojis[str] || ''}${str}</option>`).join('');
        if (visibleStreamers.includes(currentVal)) { select.value = currentVal; }
    }
}

function updateDetailedSummaryTable() {
    const tableContainer = document.querySelector('#table-summary .table-container');
    if (!tableContainer) return;
    
    // ì„¤ì • ë¡œë“œ
    const showTotalRow = localStorage.getItem('show-total-row') !== 'false'; // ê¸°ë³¸ê°’: true
    const showUpdateTime = localStorage.getItem('show-update-time') === 'true'; // ê¸°ë³¸ê°’: false
    const tableTitle = localStorage.getItem('table-title') || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
    
    // í…Œì´ë¸” ì œëª© ì—…ë°ì´íŠ¸
    document.getElementById('table-title-display').textContent = tableTitle;
    
    // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ/ìˆ¨ê¸°ê¸°
    const updateTimeEl = document.getElementById('table-update-time');
    if (showUpdateTime && updateTimeEl) {
        updateTimeEl.style.display = 'block';
        updateTimeEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}`;
    } else if (updateTimeEl) {
        updateTimeEl.style.display = 'none';
    }
    
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const summaryStreamers = (streamers || []).filter(s => s !== 'êµ­ê³ ' && s !== 'í›„ì›ìì¡°ì •' && !hiddenStreamers.includes(s));
    const streamerData = {};
    summaryStreamers.forEach(s => { streamerData[s] = { name: s, account: 0, toonation: 0, total: 0 }; });
    donations.forEach(d => {
        if (streamerData.hasOwnProperty(d.streamer)) {
            const amountInWon = (parseFloat(d.amount) || 0) * 10000; // ë§Œì› â†’ ì› ë³€í™˜
            if (d.type === 'ê³„ì¢Œ') streamerData[d.streamer].account += amountInWon;
            else if (d.type === 'íˆ¬ë„¤') streamerData[d.streamer].toonation += amountInWon;
        }
    });
    
    let sortedStreamers = Object.values(streamerData).map(data => { data.total = data.account + data.toonation; return data; }).sort((a, b) => b.total - a.total);
    
    // ì»¤ìŠ¤í…€ ìˆœë²ˆëª… ì ìš©
    function getRankName(index) {
        const rankCount = parseInt(localStorage.getItem('rank-count') || '10');
        const rankNumber = index + 1;
        
        // ì„¤ì •ëœ ìˆœë²ˆëª…ì´ ìˆëŠ”ì§€ í™•ì¸
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            return customRankName.trim();
        }
        
        // ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ«ìë¡œ í‘œì‹œ
        return rankNumber.toString();
    }
    
    const headerHtml = `<tr><th>ìˆœìœ„</th><th>ìŠ¤íŠ¸ë¦¬ë¨¸</th><th>ê³„ì¢Œí›„ì›</th><th>íˆ¬ë„¤í›„ì›</th><th>ì´ í›„ì›</th></tr>`;
    const bodyHtml = sortedStreamers.map((data, index) => { 
        const rankName = getRankName(index);
        return `<tr><td>${rankName}</td><td>${emojis[data.name] || ''} ${data.name}</td><td>${data.account.toLocaleString('ko-KR')}</td><td>${data.toonation.toLocaleString('ko-KR')}</td><td>${data.total.toLocaleString('ko-KR')}</td></tr>`; 
    }).join('');
    
    // ì´í•©ê³„ í–‰ ì¶”ê°€ (ì˜µì…˜ì— ë”°ë¼)
    let totalRowHtml = '';
    if (showTotalRow) {
        const totalAccount = sortedStreamers.reduce((sum, s) => sum + s.account, 0);
        const totalToonation = sortedStreamers.reduce((sum, s) => sum + s.toonation, 0);
        const grandTotal = totalAccount + totalToonation;
        totalRowHtml = `<tr class="total-row" style="background: rgba(64,64,64,0.6); border-top: 2px solid rgba(255,255,255,0.3); font-weight: bold;">
            <td colspan="2"><strong>ğŸ† ì´ í•©ê³„</strong></td>
            <td><strong>${totalAccount.toLocaleString('ko-KR')}</strong></td>
            <td><strong>${totalToonation.toLocaleString('ko-KR')}</strong></td>
            <td><strong>${grandTotal.toLocaleString('ko-KR')}</strong></td>
        </tr>`;
    }
    
    const finalBodyHtml = bodyHtml.trim() === '' ? 
        `<tr><td colspan="5">ê³„ì¢Œ/íˆ¬ë„¤ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>` : 
        bodyHtml + totalRowHtml;
    
    tableContainer.innerHTML = `<p style="font-size: 13px; color: #606770; margin-bottom: 10px;">â€» ìŠˆí¼ì±—(êµ­ê³ )ì„ ì œì™¸í•œ í›„ì› ë‚´ì—­ì…ë‹ˆë‹¤.</p><table class="table"><thead>${headerHtml}</thead><tbody>${finalBodyHtml}</tbody></table>`;
}

function updateMissionSettingsUI() { 
    const container = document.getElementById('mission-settings'); 
    if (!container) return; 
    const missionStreamers = (streamers || []).filter(s => s !== 'êµ­ê³ '); 
    container.innerHTML = missionStreamers.map(streamer => { 
        const mission = missionData[streamer] || {}; 
        const isRunning = mission.status === 'running'; 
        return `<div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 10px;"><label class="form-label" style="font-weight: bold;">${emojis[streamer] || ''} ${streamer}</label><div style="display: flex; gap: 10px; align-items: center;"><input type="number" step="0.1" class="form-input" id="mission-target-${streamer}" placeholder="ëª©í‘œì•¡(ë§Œ)" value="${mission.target || ''}" style="flex: 1;"><button class="btn ${isRunning ? 'btn-danger' : 'btn-success'}" onclick="toggleMission('${streamer}')">${isRunning ? 'ğŸ›‘ ì¤‘ì§€' : 'ğŸš€ ì‹œì‘'}</button></div></div>`; 
    }).join(''); 
}

function updateMissionSummary() {
    const container = document.getElementById('mission-summary-output'); if (!container) return;
    const runningMissions = Object.values(missionData).filter(m => streamers.includes(m.streamer) && (m.status === 'running' || m.status === 'success'));
    if (runningMissions.length === 0) { container.textContent = 'ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
    
    const totalMissionAmount = runningMissions.reduce((total, mission) => {
        const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
        return total + missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
    }, 0);

    const missionTexts = runningMissions.map(mission => {
        const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
        const currentAmount = missionDonations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        const remaining = (parseFloat(mission.target) || 0) - currentAmount;
        
        if (remaining <= 0 && mission.status === 'running') { 
            mission.status = 'success'; 
            mission.completedTime = Date.now(); 
        }
        const currentAmountStr = parseFloat(currentAmount);
        if (mission.status === 'success') { return `${emojis[mission.streamer] || ''}${mission.streamer}(${currentAmountStr}/ì„±ê³µ!)`; }
        const remainingStr = parseFloat(remaining > 0 ? remaining : 0);
        return `${emojis[mission.streamer] || ''}${mission.streamer}(${currentAmountStr}/-${remainingStr})`;
    });
    container.textContent = `ğŸ„í‡´ê·¼ë¯¸ì…˜(${parseFloat(totalMissionAmount)}ë§Œ)ğŸ„ | ${missionTexts.join(' | ')}`;
}

// --- ìœ í‹¸ë¦¬í‹° ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
function formatAmount(num) { const number = parseFloat(num); if (isNaN(number)) return '0'; return parseFloat(number.toFixed(1)).toString(); }

function initEventListeners() {
    document.getElementById('auto-save-toggle').addEventListener('change', e => autoSaveEnabled = e.target.checked);
    document.getElementById('select-all').addEventListener('change', e => { document.querySelectorAll('#data-table-body input[type="checkbox"]').forEach(cb => { cb.checked = e.target.checked; toggleRowSelection(parseInt(cb.closest('tr').dataset.index, 10), e.target.checked); }); });
    document.addEventListener('click', (e) => { if (!e.target.closest('.autocomplete-container')) { document.querySelectorAll('.donor-autocomplete').forEach(list => list.style.display = 'none'); } if (currentlyEditing && !currentlyEditing.cell.contains(e.target)) { cancelCurrentEdit(); } });
    setupDonorAutocomplete('donor-input', 'donor-autocomplete');
    setupDonorAutocomplete('quick-donor', 'quick-donor-autocomplete');
    document.getElementById('quick-add-form').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('quick-add-btn').click(); } });
}

function showStatus(msg, type = 'info', duration = 3000) { const c = document.getElementById('status-container'); if (!c) return; c.innerHTML = `<div class="status status-${type}">${msg}</div>`; if (duration > 0) setTimeout(() => c.innerHTML = '', duration); }
function showSaveStatus(msg, type = 'saving') { 
    const el = document.getElementById('save-status'); 
    if (!el) {
        console.warn('save-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    try {
        el.textContent = msg; 
        el.className = `save-status ${type}`; 
        el.style.display = 'block'; 
        if (type === 'saved' || type === 'error') {
            setTimeout(() => {
                if (el) el.style.display = 'none';
            }, 3000); 
        }
    } catch (error) {
        console.error('Save status ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}
function cancelCurrentEdit() { if (currentlyEditing) { currentlyEditing.cell.innerHTML = currentlyEditing.originalContent; currentlyEditing = null; } }

function makeCellEditable(cell, index) {
    if (currentlyEditing) {
        cancelCurrentEdit();
    }
    
    const field = cell.dataset.field;
    const donation = donations[index];
    const originalValue = donation[field];
    currentlyEditing = { cell, index, field, originalContent: cell.innerHTML };
    
    let inputElement;

    switch (field) {
        case 'donor':
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.className = 'form-input';
            inputElement.value = originalValue;
            break;

        case 'streamer':
            inputElement = document.createElement('select');
            inputElement.className = 'form-select';
            inputElement.innerHTML = (streamers || [])
                .map(s => `<option value="${s}" ${s === originalValue ? 'selected' : ''}>${emojis[s] || ''}${s}</option>`)
                .join('');
            break;

        case 'type':
            inputElement = document.createElement('select');
            inputElement.className = 'form-select';
            const types = ['ê³„ì¢Œ', 'íˆ¬ë„¤', 'ìŠˆí¼ì±—'];
            inputElement.innerHTML = types.map(t => `<option value="${t}" ${t === originalValue ? 'selected' : ''}>${t}</option>`).join('');
            break;

        case 'amount':
            inputElement = document.createElement('input');
            inputElement.type = 'number';
            inputElement.step = '0.1';
            inputElement.className = 'form-input';
            inputElement.value = originalValue;
            break;

        default:
            currentlyEditing = null;
            return;
    }
    
    cell.innerHTML = '';
    cell.appendChild(inputElement);
    inputElement.focus();
    
    const saveEdit = () => {
        let newValue = inputElement.value;
        
        if (field === 'amount') {
            const parsedAmount = parseFloat(newValue);
            if (isNaN(parsedAmount) || parsedAmount < 0) {
                showStatus('ìœ íš¨í•œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                cancelCurrentEdit();
                return;
            }
            newValue = parsedAmount;
        }

        if (String(originalValue) === String(newValue)) {
            cancelCurrentEdit();
            return;
        }
        
        donations[index][field] = newValue;
        saveToLocalStorage();
        updateAllUI();
        showStatus('ìˆ˜ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        currentlyEditing = null;
        
        // ì‹¤ì‹œê°„ ì„œë²„ ë™ê¸°í™”
        syncToServer();
    };
    
    inputElement.addEventListener('blur', saveEdit);
    inputElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            cancelCurrentEdit();
        }
    });
}

function switchTab(event, tabName) { document.querySelectorAll('#main-content .tab-button').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active'); document.querySelectorAll('#main-content .tab-content').forEach(content => content.classList.remove('active')); document.getElementById(tabName + '-tab').classList.add('active'); }
function switchSummaryTab(event, tabName) { const panel = event.currentTarget.closest('.panel'); panel.querySelectorAll('.management-nav .tab-button').forEach(btn => btn.classList.remove('active')); event.currentTarget.classList.add('active'); panel.querySelectorAll('.summary-tab-content').forEach(content => content.classList.remove('active')); document.getElementById(tabName).classList.add('active'); }

async function updateUserInfo() { 
    const statusText = isAdminVerified ? 'ê´€ë¦¬ì ì¸ì¦ë¨' : 'ì¼ë°˜ ì‚¬ìš©ì';
    const statusClass = isAdminVerified ? 'admin' : '';
    document.getElementById('user-info').innerHTML = `<span class="${statusClass}">ë¡œì»¬ ì›¹í˜ì´ì§€ ëª¨ë“œ (${statusText})</span>`;
    updateChatbotPermissionUI(); // ì±—ë´‡ ê¶Œí•œ ìƒíƒœë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
}

async function verifyPassword() { 
    const pw = document.getElementById('password-input').value; 
    if (pw === currentPassword) {
        isAdminVerified = true;
        showStatus('ê´€ë¦¬ì ê¶Œí•œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success'); 
        document.getElementById('password-section').style.display = 'none';
        document.getElementById('admin-verified').checked = true;
        updateUserInfo(); // ê¶Œí•œ ìƒíƒœ UI ì—…ë°ì´íŠ¸
        updateChatbotPermissionUI(); // ì±—ë´‡ ê¶Œí•œ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateAdminElements(); // ê´€ë¦¬ì ìš”ì†Œ í‘œì‹œ ì—…ë°ì´íŠ¸
    } else {
        showStatus('ì˜ëª»ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤', 'error');
    }
}

function toggleAdminMode() {
    const checkbox = document.getElementById('admin-verified');
    
    if (checkbox.checked) {
        // ì²´í¬ ì‹œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (password === currentPassword) {
            isAdminVerified = true;
            showStatus('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            updateUserInfo();
            updateChatbotPermissionUI();
            updateAdminElements();
            showAllSummaries(); // ê´€ë¦¬ìëŠ” ëª¨ë“  ìš”ì•½ ë³´ê¸°
        } else {
            checkbox.checked = false;
            showStatus('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤. ê´€ë¦¬ì ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error', 5000);
        }
    } else {
        // ì²´í¬ í•´ì œ ì‹œ
        isAdminVerified = false;
        showStatus('ê´€ë¦¬ì ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        updateUserInfo();
        updateChatbotPermissionUI();
        updateAdminElements();
        
        // ê°„ë‹¨ ëª¨ë“œ ì „ìš©ì¸ ê²½ìš° ë‹¤ì‹œ ì œí•œëœ ìš”ì•½ë§Œ ë³´ì´ê¸°
        const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
        if (isSimpleModeOnly) {
            setTimeout(() => switchSimpleMode('streamer'), 100);
        }
    }
}

function updateAdminElements() {
    // ê´€ë¦¬ì ì „ìš© ìš”ì†Œë“¤ í‘œì‹œ/ìˆ¨ê¹€
    const adminElements = [
        'save-btn', 'reset-btn', 'import-btn', 'pwd-btn',
        'add-streamer-btn', 'save-mission-btn', 'stop-all-missions-btn'
    ];
    
    adminElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = isAdminVerified ? 'inline-block' : 'none';
        }
    });
    
    // ë¹„ë°€ë²ˆí˜¸ íƒ­ í‘œì‹œ/ìˆ¨ê¹€
    const passwordTabBtn = document.getElementById('password-tab-btn');
    if (passwordTabBtn) {
        passwordTabBtn.style.display = isAdminVerified ? 'inline-block' : 'none';
    }
    
    // ê°„ë‹¨ ëª¨ë“œ ì „ìš© ì„¤ì •ì— ë”°ë¼ íƒ­ í‘œì‹œ/ìˆ¨ê¹€
    updateTabVisibility();
}

function toggleSimpleModeOnly() {
    const checkbox = document.getElementById('simple-mode-only');
    const isSimpleModeOnly = checkbox.checked;
    
    localStorage.setItem('simple-mode-only', isSimpleModeOnly.toString());
    updateTabVisibility();
    
    if (isSimpleModeOnly) {
        showStatus('ì¡°ì • íƒ­ë§Œ ë³´ì´ê¸° ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        // ì¡°ì • íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
        switchTab(null, 'simple');
        // ê¸°ë³¸ ëª¨ë“œë¡œ ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ì„¤ì •
        setTimeout(() => switchSimpleMode('streamer'), 100);
    } else {
        showStatus('ì „ì²´ íƒ­ ë³´ê¸° ëª¨ë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        // ëª¨ë“  ìš”ì•½ ë‹¤ì‹œ ë³´ì´ê¸°
        showAllSummaries();
    }
}

function updateTabVisibility() {
    const isSimpleModeOnly = localStorage.getItem('simple-mode-only') === 'true';
    const isAdmin = isAdminVerified;
    
    // ê°„ë‹¨ ëª¨ë“œ ì „ìš©ì´ê³  ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš° ì¡°ì • íƒ­ë§Œ í‘œì‹œ
    const shouldShowOnlySimple = isSimpleModeOnly && !isAdmin;
    
    const allTabs = [
        'donation-tab', 'streamer-tab', 'mission-tab', 'overlay-tab', 
        'password-tab', 'data-tab', 'chatbot-tab'
    ];
    
    const allTabButtons = document.querySelectorAll('.tab-button');
    
    allTabButtons.forEach((btn, index) => {
        if (shouldShowOnlySimple) {
            // ì¡°ì • íƒ­ë§Œ í‘œì‹œ
            if (btn.textContent.includes('ğŸ¯ ì¡°ì •')) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        } else {
            // ê´€ë¦¬ìì´ê±°ë‚˜ ê°„ë‹¨ ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš° ëª¨ë“  íƒ­ í‘œì‹œ (ê¸°ì¡´ ë¡œì§)
            if (btn.id === 'password-tab-btn') {
                btn.style.display = isAdmin ? 'inline-block' : 'none';
            } else {
                btn.style.display = 'inline-block';
            }
        }
    });
    
    // ê°„ë‹¨ ëª¨ë“œ ì „ìš© ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë¡œë“œ
    const checkbox = document.getElementById('simple-mode-only');
    if (checkbox) {
        checkbox.checked = isSimpleModeOnly;
    }
}

async function changePassword() { 
    const newPw = document.getElementById('new-password').value; 
    if (!/^\d{4}$/.test(newPw)) return showStatus('ë¹„ë°€ë²ˆí˜¸ëŠ” 4ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤', 'error'); 
    currentPassword = newPw;
    saveToLocalStorage();
    document.getElementById('current-password').textContent = newPw;
    document.getElementById('new-password').value = '';
    showStatus('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function showAdminPassword() { 
    alert(`í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: ${currentPassword}`); 
}

function refreshPassword() { 
    document.getElementById('current-password').textContent = currentPassword;
}

async function addStreamer() { 
    const name = document.getElementById('new-streamer-name').value.trim();
    const emoji = document.getElementById('new-streamer-emoji').value.trim(); 
    
    console.log('ğŸ”§ [DEBUG] ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ ì‹œì‘:', { name, emoji });
    
    if (!name) {
        console.log('ğŸ”§ [DEBUG] ì´ë¦„ ì—†ìŒ');
        return showStatus('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
    }
    if (streamers.includes(name)) {
        console.log('ğŸ”§ [DEBUG] ì¤‘ë³µëœ ì´ë¦„:', name);
        return showStatus('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤', 'error');
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    const addBtn = document.getElementById('add-streamer-btn');
    const originalText = addBtn.textContent;
    addBtn.disabled = true;
    addBtn.textContent = 'ì¶”ê°€ ì¤‘...';
    
    console.log('ğŸ”§ [DEBUG] ë¡œì»¬ ì¶”ê°€ ì‹œì‘');
    
    // ë¡œì»¬ì— ë¨¼ì € ì¶”ê°€ (í™•ì‹¤í•œ ë°©ë²•)
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    console.log('ğŸ”§ [DEBUG] ë¡œì»¬ ì¶”ê°€ ì™„ë£Œ, UI ì—…ë°ì´íŠ¸ ì‹œì‘');
    
    // UI ì—…ë°ì´íŠ¸
    saveToLocalStorage();
    updateAllUI();
    
    // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.getElementById('new-streamer-name').value = ''; 
    document.getElementById('new-streamer-emoji').value = '';
    
    console.log('ğŸ”§ [DEBUG] í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡:', streamers);
    console.log('ğŸ”§ [DEBUG] í˜„ì¬ ì´ëª¨ì§€:', emojis);
    
    showStatus(`ìŠ¤íŠ¸ë¦¬ë¨¸ "${name}" ${emoji}ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    
    // ì„œë²„ ë™ê¸°í™” ì‹œë„ (ë°±ê·¸ë¼ìš´ë“œ)
    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, emoji })
        });
        
        if (response.ok) {
            console.log('âœ… [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì„±ê³µ:', name, emoji);
        } else {
            console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨, ë¡œì»¬ë§Œ ì €ì¥ë¨');
        }
    } catch (error) {
        console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
    
    // ë²„íŠ¼ ë³µì›
    addBtn.disabled = false;
    addBtn.textContent = originalText;
    
    console.log('ğŸ”§ [DEBUG] ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ ì™„ë£Œ');
}

async function deleteStreamer(streamerName) {
    if (!confirm(`'${streamerName}'ë‹˜ì„ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    console.log('ğŸ”§ [DEBUG] ìŠ¤íŠ¸ë¦¬ë¨¸ ì‚­ì œ ì‹œì‘:', streamerName);
    
    // ë¡œì»¬ì—ì„œ ë¨¼ì € ì‚­ì œ (í™•ì‹¤í•œ ë°©ë²•)
    streamers = streamers.filter(s => s !== streamerName);
    delete emojis[streamerName];
    
    console.log('ğŸ”§ [DEBUG] ë¡œì»¬ ì‚­ì œ ì™„ë£Œ, UI ì—…ë°ì´íŠ¸');
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`ìŠ¤íŠ¸ë¦¬ë¨¸ "${streamerName}"ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
    
    console.log('ğŸ”§ [DEBUG] í˜„ì¬ ìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡:', streamers);
    
    // ì„œë²„ ë™ê¸°í™” ì‹œë„ (ë°±ê·¸ë¼ìš´ë“œ)
    try {
        const response = await fetch(`/api/streamers/${encodeURIComponent(streamerName)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            console.log('âœ… [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì„±ê³µ:', streamerName);
        } else {
            console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨, ë¡œì»¬ë§Œ ì‚­ì œë¨');
        }
    } catch (error) {
        console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
    
    console.log('ğŸ”§ [DEBUG] ìŠ¤íŠ¸ë¦¬ë¨¸ ì‚­ì œ ì™„ë£Œ');
}

async function editStreamer(streamerName) {
    const currentEmoji = emojis[streamerName] || '';
    const newName = prompt(`ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”:`, streamerName);
    if (!newName || newName.trim() === '') return;
    
    const trimmedNewName = newName.trim();
    if (trimmedNewName === streamerName) {
        // ì´ë¦„ì´ ê°™ë‹¤ë©´ ì´ëª¨ì§€ë§Œ ìˆ˜ì •
        const newEmoji = prompt(`${streamerName}ì˜ ì´ëª¨ì§€ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:`, currentEmoji);
        if (newEmoji !== null) {
            emojis[streamerName] = newEmoji.trim();
            saveToLocalStorage();
            updateAllUI();
            showStatus(`${streamerName}ì˜ ì´ëª¨ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
        }
        return;
    }
    
    // ì´ë¦„ì´ ë°”ë€ŒëŠ” ê²½ìš° ì¤‘ë³µ ì²´í¬
    if (streamers.includes(trimmedNewName)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì…ë‹ˆë‹¤.');
        return;
    }
    
    const newEmoji = prompt(`${trimmedNewName}ì˜ ì´ëª¨ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”:`, currentEmoji);
    if (newEmoji === null) return; // ì·¨ì†Œ
    
    // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¬ë¨¸ ì‚­ì œ
    streamers = streamers.filter(s => s !== streamerName);
    delete emojis[streamerName];
    
    // ìƒˆ ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€
    streamers.push(trimmedNewName);
    emojis[trimmedNewName] = newEmoji.trim();
    
    // í›„ì› ë°ì´í„°ì—ì„œë„ ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ ë³€ê²½
    donations = donations.map(d => {
        if (d.streamer === streamerName) {
            return { ...d, streamer: trimmedNewName };
        }
        return d;
    });
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`${streamerName}ì´(ê°€) ${trimmedNewName}ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    
    // ì„œë²„ ë™ê¸°í™” ì‹œë„
    try {
        // ê¸°ì¡´ ì‚­ì œ
        await fetch(`/api/streamers/${encodeURIComponent(streamerName)}`, { method: 'DELETE' });
        // ìƒˆë¡œ ì¶”ê°€
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: trimmedNewName, emoji: newEmoji.trim() })
        });
    } catch (error) {
        console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
}

// ëª¨ë°”ì¼ìš© ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ í•¨ìˆ˜
async function addStreamerMobile() {
    const name = document.getElementById('new-streamer-name-mobile').value.trim();
    const emoji = document.getElementById('new-streamer-emoji-mobile').value.trim();
    
    if (!name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤!');
        return;
    }
    
    // addStreamer í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('new-streamer-name-mobile').value = '';
    document.getElementById('new-streamer-emoji-mobile').value = '';
    
    showStatus(`ìŠ¤íŠ¸ë¦¬ë¨¸ "${name}" ${emoji}ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    
    // ì„œë²„ ë™ê¸°í™” ì‹œë„
    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
        
        if (response.ok) {
            console.log('âœ… [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì„±ê³µ:', name, emoji);
        }
    } catch (error) {
        console.log('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
}

// ë°±ì—…ìš© ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ í•¨ìˆ˜ (ê°„ë‹¨í•œ ë ˆì´ì•„ì›ƒ)
async function addStreamerBackup() {
    const name = document.getElementById('backup-streamer-name').value.trim();
    const emoji = document.getElementById('backup-streamer-emoji').value.trim();
    
    if (!name) {
        alert('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤!');
        return;
    }
    
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('backup-streamer-name').value = '';
    document.getElementById('backup-streamer-emoji').value = '';
    
    showStatus(`âœ… "${name}" ${emoji} ì¶”ê°€ ì™„ë£Œ!`, 'success');
    
    // ì„œë²„ ë™ê¸°í™”
    try {
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
    } catch (error) {
        console.log('âš ï¸ ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
}

// ê°„í¸ ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ í•¨ìˆ˜ (ì„¸ë¡œ ë ˆì´ì•„ì›ƒ)
async function addStreamerSimple() {
    const name = document.getElementById('simple-streamer-name').value.trim();
    const emoji = document.getElementById('simple-streamer-emoji').value.trim();
    
    if (!name) {
        alert('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤!');
        return;
    }
    
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    saveToLocalStorage();
    updateAllUI();
    
    document.getElementById('simple-streamer-name').value = '';
    document.getElementById('simple-streamer-emoji').value = '';
    
    showStatus(`ğŸ‰ "${name}" ${emoji} ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    
    // ì„œë²„ ë™ê¸°í™”
    try {
        await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
        console.log('âœ… ì„œë²„ ë™ê¸°í™” ì„±ê³µ');
    } catch (error) {
        console.log('âš ï¸ ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', error.message);
    }
}

// === ë””ë²„ê·¸ í•¨ìˆ˜ë“¤ ===
function debugLog(message) {
    const output = document.getElementById('debug-output');
    if (output) {
        const timestamp = new Date().toLocaleTimeString();
        output.textContent += `[${timestamp}] ${message}\n`;
        output.scrollTop = output.scrollHeight;
    }
    console.log(`[ë””ë²„ê·¸] ${message}`);
}

async function checkServerData() {
    debugLog('ì„œë²„ ë°ì´í„° í™•ì¸ ì‹œì‘...');
    
    try {
        const response = await fetch('/api/data');
        const data = await response.json();
        
        debugLog(`âœ… ì„œë²„ ì‘ë‹µ ì„±ê³µ`);
        debugLog(`ğŸ“Š ìŠ¤íŠ¸ë¦¬ë¨¸ ìˆ˜: ${data.streamers?.length || 0}`);
        debugLog(`ğŸ˜€ ì´ëª¨ì§€ ìˆ˜: ${Object.keys(data.emojis || {}).length}`);
        debugLog(`ğŸ’¸ í›„ì› ìˆ˜: ${data.donations?.length || 0}`);
        
        if (data.emojis && Object.keys(data.emojis).length > 0) {
            debugLog('ğŸ‰ ì´ëª¨ì§€ ë°ì´í„° ì¡´ì¬í•¨:');
            Object.entries(data.emojis).forEach(([name, emoji]) => {
                debugLog(`  ${name}: ${emoji}`);
            });
        } else {
            debugLog('âŒ ì´ëª¨ì§€ ë°ì´í„° ì—†ìŒ');
        }
        
        if (data.streamers) {
            debugLog('ğŸ‘¤ ìŠ¤íŠ¸ë¦¬ë¨¸ ëª©ë¡:');
            data.streamers.forEach(name => {
                debugLog(`  - ${name}`);
            });
        }
        
    } catch (error) {
        debugLog(`âŒ ì„œë²„ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
    }
}

async function forceInitEmojis() {
    debugLog('ì´ëª¨ì§€ ê°•ì œ ì´ˆê¸°í™” ì‹œì‘...');
    
    const emojiData = {
        "ì—„ì‚¼ìš©": "ğŸ«…", 
        "ì†ë•ë°°": "ğŸŒº", 
        "ì—°ê¸°": "ğŸ§", 
        "ë™ë™": "ğŸ˜", 
        "ì£¼ì˜¥": "ğŸ‘º", 
        "ë¶ˆê³°": "ğŸ¬", 
        "ì´íš¨íŒ”": "ğŸ", 
        "ë‚¨ë¶•": "ğŸ¤ ", 
        "ì˜¥ê¸”": "ğŸ¦†", 
        "êµ­ê³ ": "ğŸ¦"
    };
    
    try {
        // ë¡œì»¬ì— ë¨¼ì € ì„¤ì •
        emojis = { ...emojiData };
        saveToLocalStorage();
        debugLog('âœ… ë¡œì»¬ ì´ëª¨ì§€ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
        
        updateAllUI();
        debugLog('ğŸ”„ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        
        showStatus('ì´ëª¨ì§€ ë°ì´í„°ê°€ ê°•ì œë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        
    } catch (error) {
        debugLog(`âŒ ì´ëª¨ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
    }
}

async function testStreamerAdd() {
    debugLog('ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
    
    const testName = 'TEST' + Math.floor(Math.random() * 100);
    const testEmoji = 'ğŸ§ª';
    
    debugLog(`í…ŒìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë¨¸: ${testName} ${testEmoji}`);
    
    try {
        // ë¨¼ì € ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€ API ì‹œë„
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: testName, emoji: testEmoji })
        });
        
        if (response.ok) {
            const result = await response.json();
            debugLog('âœ… ì„œë²„ API ì¶”ê°€ ì„±ê³µ');
            debugLog(`ì‘ë‹µ: ${JSON.stringify(result)}`);
        } else {
            debugLog('âŒ ì„œë²„ API ì¶”ê°€ ì‹¤íŒ¨, ë¡œì»¬ë§Œ ì¶”ê°€');
            // ë¡œì»¬ì—ë§Œ ì¶”ê°€
            if (!streamers.includes(testName)) {
                streamers.push(testName);
                emojis[testName] = testEmoji;
                saveToLocalStorage();
                updateAllUI();
            }
        }
        
    } catch (error) {
        debugLog(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
        // ë¡œì»¬ì—ë§Œ ì¶”ê°€
        if (!streamers.includes(testName)) {
            streamers.push(testName);
            emojis[testName] = testEmoji;
            saveToLocalStorage();
            updateAllUI();
            debugLog('âœ… ë¡œì»¬ì—ë§Œ ì¶”ê°€ ì™„ë£Œ');
        }
    }
}

// === ê°„ë‹¨í•œ ìŠ¤íŠ¸ë¦¬ë¨¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ===
function simpleAddStreamer() {
    const name = document.getElementById('new-streamer-name').value.trim();
    const emoji = document.getElementById('new-streamer-emoji').value.trim();
    
    if (!name) {
        alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }
    
    if (streamers.includes(name)) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤');
        return;
    }
    
    // ì¦‰ì‹œ ì¶”ê°€
    streamers.push(name);
    emojis[name] = emoji || 'â­';
    
    // ì €ì¥ ë° ì—…ë°ì´íŠ¸
    try {
        saveToLocalStorage();
        updateAllUI();
    } catch (e) {
        // í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì§ì ‘ ì²˜ë¦¬
        localStorage.setItem('streamers', JSON.stringify(streamers));
        localStorage.setItem('emojis', JSON.stringify(emojis));
        location.reload();
    }
    
    // ì…ë ¥ì°½ ì´ˆê¸°í™”
    document.getElementById('new-streamer-name').value = '';
    document.getElementById('new-streamer-emoji').value = '';
    
    alert(`âœ… ${name} ${emoji} ì¶”ê°€ ì™„ë£Œ!`);
}

function restoreEmojis() {
    // ì´ëª¨ì§€ ê°•ì œ ë³µì›
    emojis = {
        "ì—„ì‚¼ìš©": "ğŸ«…", 
        "ì†ë•ë°°": "ğŸŒº", 
        "ì—°ê¸°": "ğŸ§", 
        "ë™ë™": "ğŸ˜", 
        "ì£¼ì˜¥": "ğŸ‘º", 
        "ë¶ˆê³°": "ğŸ¬", 
        "ì´íš¨íŒ”": "ğŸ", 
        "ë‚¨ë¶•": "ğŸ¤ ", 
        "ì˜¥ê¸”": "ğŸ¦†", 
        "êµ­ê³ ": "ğŸ¦"
    };
    
    // ì €ì¥
    try {
        saveToLocalStorage();
        updateAllUI();
    } catch (e) {
        localStorage.setItem('emojis', JSON.stringify(emojis));
        location.reload();
    }
    
    alert('âœ… ì´ëª¨ì§€ ë³µì› ì™„ë£Œ!');
}

function setupDonorAutocomplete(inputId, listId) {
    const input = document.getElementById(inputId); const list = document.getElementById(listId);
    input.addEventListener('input', () => {
        const value = input.value.toLowerCase(); activeAutocompleteIndex = -1; if (!value) { list.style.display = 'none'; return; }
        const filteredDonors = Array.from(todayDonors).filter(donor => donor.toLowerCase().includes(value));
        if (filteredDonors.length > 0) { list.innerHTML = filteredDonors.slice(0, 8).map(item => `<div class="autocomplete-item">${item}</div>`).join(''); addAutocompleteListeners(list, input); list.style.display = 'block'; } else { list.style.display = 'none'; }
    });
    input.addEventListener('keydown', (e) => {
        const items = list.querySelectorAll('.autocomplete-item'); if (list.style.display !== 'block' || items.length === 0) return;
        switch (e.key) {
            case 'ArrowDown': e.preventDefault(); activeAutocompleteIndex = (activeAutocompleteIndex + 1) % items.length; highlightItem(items, activeAutocompleteIndex); break;
            case 'ArrowUp': e.preventDefault(); activeAutocompleteIndex = (activeAutocompleteIndex - 1 + items.length) % items.length; highlightItem(items, activeAutocompleteIndex); break;
            case 'Enter': e.preventDefault(); if (activeAutocompleteIndex > -1) items[activeAutocompleteIndex].dispatchEvent(new MouseEvent('mousedown', { bubbles: true })); else { list.style.display = 'none'; } break;
            case 'Escape': list.style.display = 'none'; break;
        }
    });
}

function addAutocompleteListeners(list, input) { const items = list.querySelectorAll('.autocomplete-item'); items.forEach((item, index) => { item.addEventListener('mousedown', (e) => { e.preventDefault(); input.value = item.textContent; list.style.display = 'none'; }); item.addEventListener('mouseenter', () => { highlightItem(items, index); activeAutocompleteIndex = index; }); }); }
function highlightItem(items, index) { items.forEach((item, i) => { if (i === index) { item.classList.add('selected'); item.scrollIntoView({ block: 'nearest', behavior: 'smooth' }); } else { item.classList.remove('selected'); } }); }

function toggleRowSelection(index, isSelected) { if (isSelected) selectedRows.add(index); else selectedRows.delete(index); }
function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).textContent).then(() => showStatus('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success'));}

async function saveData() { 
    if(!confirm('ì¼ê°„ ì •ì‚°ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; 
    
    const today = new Date().toLocaleDateString('ko-KR');
    const summaryData = {
        date: today,
        totalAmount: donations.reduce((sum, d) => sum + parseFloat(d.amount), 0),
        totalCount: donations.length,
        donorCount: new Set(donations.map(d => d.donor)).size
    };
    
    // ì¼ê°„ ì •ì‚° ë°ì´í„°ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
    const dailySummaries = JSON.parse(localStorage.getItem('daily_summaries') || '[]');
    const existingIndex = dailySummaries.findIndex(s => s.date === today);
    
    if (existingIndex >= 0) {
        dailySummaries[existingIndex] = summaryData;
    } else {
        dailySummaries.push(summaryData);
    }
    
    localStorage.setItem('daily_summaries', JSON.stringify(dailySummaries));
    showStatus('ì¼ê°„ ì •ì‚°ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function showResetDialog() { document.getElementById('reset-dialog').style.display = 'flex'; }
function closeResetDialog() { document.getElementById('reset-dialog').style.display = 'none'; document.getElementById('reset-password').value = ''; }

async function confirmReset() {
    const passwordInput = document.getElementById('reset-password');
    const password = passwordInput.value;

    if (password !== currentPassword) {
        showStatus('ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
        passwordInput.focus();
        return;
    }

    // ğŸ”´ ì™„ì „ ì´ˆê¸°í™” - ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ ì •ë¦¬
    console.log('ğŸ”„ ì™„ì „ ë°ì´í„° ì´ˆê¸°í™” ì‹œì‘...');
    
    // 1. ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
    donations = [];
    selectedRows.clear();
    todayDonors.clear();
    
    // 2. localStorage ì™„ì „ ì •ë¦¬
    try {
        localStorage.removeItem('donation_data');
        localStorage.removeItem('streamer_data');
        localStorage.removeItem('emoji_data');
        console.log('âœ… localStorage ì™„ì „ ì •ë¦¬ ì™„ë£Œ');
    } catch (error) {
        console.error('localStorage ì •ë¦¬ ì‹¤íŒ¨:', error);
    }
    
    // 3. ì„œë²„ ë°ì´í„°ë„ ì™„ì „ ì´ˆê¸°í™”
    if (isSocketConnected) {
        try {
            const response = await fetch('/api/donations/bulk', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ donations: [] })
            });
            
            if (response.ok) {
                console.log('âœ… ì„œë²„ ë°ì´í„° ì™„ì „ ì´ˆê¸°í™” ì„±ê³µ');
            } else {
                console.error('âŒ ì„œë²„ ì´ˆê¸°í™” ì‹¤íŒ¨');
            }
        } catch (error) {
            console.error('ì„œë²„ ì´ˆê¸°í™” ìš”ì²­ ì‹¤íŒ¨:', error);
        }
    }
    
    // 4. UI ì—…ë°ì´íŠ¸
    updateAllUI();
    closeResetDialog();
    showStatus('ğŸ”´ ëª¨ë“  ë°ì´í„°ê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤ (ì„œë²„+ë¡œì»¬+ìºì‹œ)', 'success');
    
    // 5. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ëª¨ë“  ìºì‹œ ì •ë¦¬
    setTimeout(() => {
        if (confirm('ì´ˆê¸°í™”ë¥¼ ì™„ì „íˆ ì ìš©í•˜ë ¤ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì•¼ í•©ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            location.reload();
        }
    }, 1000);
}

// --- ë°ì´í„° ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ---
function exportData() {
    const data = {
        donations: donations,
        streamers: streamers,
        emojis: emojis,
        missionData: missionData,
        exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `donation-data-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showStatus('ë°ì´í„°ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤', 'success');
}

function importData() {
    document.getElementById('import-file').click();
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (data.donations && Array.isArray(data.donations)) {
                donations = data.donations.map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
            }
            
            if (data.streamers && Array.isArray(data.streamers)) {
                streamers = data.streamers;
            }
            
            if (data.emojis && typeof data.emojis === 'object') {
                emojis = data.emojis;
            }
            
            if (data.missionData && typeof data.missionData === 'object') {
                missionData = data.missionData;
            }
            
            todayDonors = new Set(donations.map(d => d.donor));
            saveToLocalStorage();
            updateAllUI();
            showStatus('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤', 'success');
            
        } catch (error) {
            showStatus('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
        }
    };
    reader.readAsText(file);
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
}

// --- í›„ì› ì•Œë¦¼ ê´€ë ¨ í•¨ìˆ˜ ---
async function sendDonationNotification(newDonations) {
    // ê¶Œí•œ ì²´í¬: ê´€ë¦¬ìì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ëœ ê²½ìš°ë§Œ ìë™ ì•Œë¦¼ í—ˆìš©
    if (!hasWritePermission()) {
        console.log('ì±—ë´‡ ìë™ ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ìì´ê±°ë‚˜ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ìš”)');
        showStatus('ğŸ”’ ì±—ë´‡ ìë™ ì•Œë¦¼ì€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning', 5000);
        return;
    }
    
    if (!liveChatId) {
        console.log('ë¼ì´ë¸Œ ì±„íŒ…ì´ ì—°ê²°ë˜ì§€ ì•Šì•„ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        // í›„ì› ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
        let notificationMessages = [];
        
        // í›„ì›ìë³„ë¡œ ê·¸ë£¹í™”
        const donorGroups = {};
        newDonations.forEach(d => {
            if (!donorGroups[d.donor]) {
                donorGroups[d.donor] = [];
            }
            donorGroups[d.donor].push(d);
        });
        
        // ê° í›„ì›ìë³„ë¡œ ë©”ì‹œì§€ ìƒì„±
        for (const [donor, donations] of Object.entries(donorGroups)) {
            const donationTexts = donations.map(d => {
                // í•´ë‹¹ ìŠ¤íŠ¸ë¦¬ë¨¸ í˜„ì¬ ì´ì•¡ ê³„ì‚°
                const streamerTotal = getDonationsForStreamer(d.streamer).reduce((sum, donation) => sum + parseFloat(donation.amount), 0);
                return `${emojis[d.streamer] || ''}${d.streamer} (+${formatAmount(d.amount)}ë§Œ/${formatAmount(streamerTotal)}ë§Œ)`;
            }).join(', ');
            
            notificationMessages.push(`ğŸ’ ${donor}ë‹˜ > ${donationTexts} ê°ì‚¬í•©ë‹ˆë‹¤!`);
        }
        
        // ë©”ì‹œì§€ë“¤ì„ ìˆœì°¨ì ìœ¼ë¡œ ì „ì†¡ (ë„ˆë¬´ ë¹¨ë¦¬ ë³´ë‚´ë©´ API ì œí•œì— ê±¸ë¦¼)
        for (let i = 0; i < notificationMessages.length; i++) {
            const message = notificationMessages[i];
            
            // ë©”ì‹œì§€ ì „ì†¡
            await sendMessageToYouTube(message);
            
            // ë‹¤ìŒ ë©”ì‹œì§€ ì „ì†¡ê¹Œì§€ ì•½ê°„ì˜ ì§€ì—° (API ì œí•œ ë°©ì§€)
            if (i < notificationMessages.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        
        console.log(`${notificationMessages.length}ê°œì˜ í›„ì› ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.`);
        
    } catch (error) {
        console.error('í›„ì› ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
        showStatus(`ì±—ë´‡ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'warning', 3000);
    }
}

function getDonationsForStreamer(streamerName) {
    return donations.filter(d => d.streamer === streamerName);
}

// --- Google Drive ë°±ì—… ê¸°ëŠ¥ ---
const GOOGLE_CONFIG = {
    CLIENT_ID: '493287022430-4mmnh4stu22p13lr0sjgvpg0nbkouova.apps.googleusercontent.com', // OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID (ìƒˆë¡œ ìƒì„±ë¨)
    API_KEY: 'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4', // YouTube Data API v3 í‚¤ (ì—…ë°ì´íŠ¸ë¨)
    DISCOVERY_DOCS: [
        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
        'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'
    ],
    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl'
};

// OAuth ê´€ë ¨ ë³€ìˆ˜
let isOAuthSignedIn = false;
let authInstance = null;

// API ë¡œë”© ìƒíƒœ ì¶”ì 
let apiLoadAttempts = 0;
const MAX_LOAD_ATTEMPTS = 5;

// ì•ˆì „í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ì¶œ
function getErrorMessage(error) {
    if (!error) return 'Unknown error (null/undefined)';
    if (typeof error === 'string') return error;
    if (error.message) return error.message;
    if (error.error) return error.error;
    if (error.details) return error.details;
    return `Unknown error type: ${typeof error}`;
}

// ì•ˆì „ ëª¨ë“œ í™œì„±í™”
async function enableSafeMode(errorReason = 'Unknown') {
    console.log('ğŸ›¡ï¸ ì•ˆì „ ëª¨ë“œ í™œì„±í™”:', errorReason);
    
    try {
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        updateGoogleDriveStatus(`API ì´ˆê¸°í™” ì‹¤íŒ¨ - ì•ˆì „ ëª¨ë“œ (${errorReason})`, 'warning');
        
        // ì‚¬ìš©ìì—ê²Œ ì¹œí™”ì ì¸ ë©”ì‹œì§€
        setTimeout(() => {
            const statusElement = safeGetElement('google-auth-status');
            if (statusElement) {
                statusElement.className = 'status status-info';
                statusElement.innerHTML = `
                    âš ï¸ <strong>Google API ì—°ê²° ë¬¸ì œ</strong><br>
                    ë„¤íŠ¸ì›Œí¬ë‚˜ ì¼ì‹œì  ì„œë²„ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    <button onclick="retryGoogleAPI()" class="btn btn-primary" style="margin-top:10px;">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
                    <br><small style="color:#666;">ë˜ëŠ” ì•„ë˜ API í‚¤ ë°©ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”</small>
                `;
            }
        }, 500);
        
        console.log('âœ… ì•ˆì „ ëª¨ë“œ ì„¤ì • ì™„ë£Œ - API í‚¤ ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
        
    } catch (error) {
        console.error('ì•ˆì „ ëª¨ë“œ ì„¤ì • ì‹¤íŒ¨:', error);
    }
}

// ìˆ˜ë™ ì¬ì‹œë„ í•¨ìˆ˜
function retryGoogleAPI() {
    console.log('ğŸ”„ ì‚¬ìš©ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì¬ì‹œë„ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤');
    apiLoadAttempts = 0; // ì¬ì‹œë„ ì¹´ìš´í„° ë¦¬ì…‹
    
    const statusElement = safeGetElement('google-auth-status');
    if (statusElement) {
        statusElement.className = 'status status-info';
        statusElement.innerHTML = 'ğŸ”„ <strong>Google API ì¬ì—°ê²° ì‹œë„ ì¤‘...</strong>';
    }
    
    setTimeout(initGoogleAPI, 1000);
}

async function waitForGapi() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const checkGapi = () => {
            attempts++;
            if (typeof gapi !== 'undefined') {
                console.log(`gapi ë¡œë“œ í™•ì¸ ì™„ë£Œ (ì‹œë„ ${attempts}íšŒ)`);
                resolve();
            } else if (attempts >= 20) { // 10ì´ˆ ëŒ€ê¸°
                reject(new Error('gapi ë¡œë”© ì‹œê°„ ì´ˆê³¼'));
            } else {
                setTimeout(checkGapi, 500);
            }
        };
        checkGapi();
    });
}

async function initGoogleAPI() {
    try {
        apiLoadAttempts++;
        console.log(`Google API ì´ˆê¸°í™” ì‹œì‘... (ì‹œë„ ${apiLoadAttempts}/${MAX_LOAD_ATTEMPTS})`);
        
        // Google API ë¡œë”© ëŒ€ê¸° ë° í™˜ê²½ ê²€ì‚¬
        console.log('í˜„ì¬ í™˜ê²½ ì²´í¬:', {
            gapi: typeof gapi,
            google: typeof google,
            location: window.location.href,
            userAgent: navigator.userAgent.substring(0, 100)
        });
        
        try {
            await waitForGapi();
        } catch (error) {
            const errorMsg = getErrorMessage(error);
            console.error('gapi ë¡œë”© ì‹¤íŒ¨:', errorMsg);
            
            if (apiLoadAttempts < MAX_LOAD_ATTEMPTS) {
                console.warn(`gapi ë¡œë”© ì‹¤íŒ¨, ${3}ì´ˆ í›„ ì¬ì‹œë„... (${apiLoadAttempts}/${MAX_LOAD_ATTEMPTS}) - ${errorMsg}`);
                setTimeout(initGoogleAPI, 3000);
                return;
            } else {
                throw new Error(`Google API ìŠ¤í¬ë¦½íŠ¸ ë¡œë”© ì‹¤íŒ¨: ${errorMsg}. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ë‚˜ ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`);
            }
        }
        
        // Drive API ì´ˆê¸°í™” (ê°„ì†Œí™”)
        try {
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('Drive API ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼')), 10000);
                
                gapi.load('client', async () => {
                    try {
                        clearTimeout(timeout);
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.API_KEY,
                            discoveryDocs: [GOOGLE_CONFIG.DISCOVERY_DOCS[0]]
                        });
                        console.log('âœ… Google Drive API ì´ˆê¸°í™” ì™„ë£Œ');
                        resolve();
                    } catch (error) {
                        clearTimeout(timeout);
                        console.error('Drive API ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        resolve(); // Drive API ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
                    }
                });
            });
        } catch (error) {
            console.warn('Drive API ì´ˆê¸°í™” ì‹¤íŒ¨, OAuthë§Œ ì§„í–‰:', error);
        }
        
        // OAuth ì´ˆê¸°í™” (YouTube APIìš©) - ë” ì•ˆì „í•˜ê²Œ
        try {
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('OAuth ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼')), 15000);
                
                gapi.load('client:auth2', async () => {
                    try {
                        clearTimeout(timeout);
                        
                        // ë‹¨ê³„ë³„ ì´ˆê¸°í™”
                        await gapi.client.init({
                            apiKey: GOOGLE_CONFIG.API_KEY,
                            clientId: GOOGLE_CONFIG.CLIENT_ID,
                            discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
                            scope: GOOGLE_CONFIG.SCOPES
                        });
                        
                        console.log('âœ… Google OAuth API ì´ˆê¸°í™” ì™„ë£Œ');
                        resolve();
                    } catch (error) {
                        clearTimeout(timeout);
                        console.error('OAuth API ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        reject(error);
                    }
                });
            });
        } catch (error) {
            console.error('OAuth ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            // OAuth ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°©ë²• ì‹œë„
            console.log('ëŒ€ì²´ ì´ˆê¸°í™” ë°©ë²• ì‹œë„ ì¤‘...');
            await fallbackOAuthInit();
        }
        
        // authInstance ì„¤ì • (ì•ˆì „í•˜ê³  ìƒì„¸í•œ ë¡œê¹…)
        try {
            console.log('ğŸ”§ OAuth ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì‹œì‘...');
            
            // gapi.auth2 ìƒíƒœ í™•ì¸
            if (!gapi.auth2) {
                throw new Error('gapi.auth2ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            }
            
            authInstance = gapi.auth2.getAuthInstance();
            console.log('authInstance ê°ì²´:', authInstance);
            
            if (authInstance) {
                // í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                isOAuthSignedIn = authInstance.isSignedIn.get();
                const currentUser = authInstance.currentUser.get();
                
                console.log('âœ… OAuth ì´ˆê¸° ìƒíƒœ:', {
                    isSignedIn: isOAuthSignedIn,
                    hasCurrentUser: !!currentUser,
                    userProfile: currentUser ? currentUser.getBasicProfile()?.getName() : 'N/A',
                    grantedScopes: currentUser ? currentUser.getGrantedScopes() : 'N/A'
                });
                
                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
                authInstance.isSignedIn.listen((signedIn) => {
                    isOAuthSignedIn = signedIn;
                    console.log('ğŸ”„ OAuth ì¸ì¦ ìƒíƒœ ë³€ê²½:', {
                        newState: signedIn ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨',
                        timestamp: new Date().toISOString()
                    });
                    
                    setTimeout(() => {
                        updateGoogleAuthStatus();
                    }, 100);
                });
                
                console.log('âœ… OAuth ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì™„ë£Œ');
            } else {
                console.error('âŒ OAuth ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                console.error('gapi.auth2 ìƒíƒœ:', typeof gapi.auth2);
                console.error('ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ì†Œë“œ:', gapi.auth2 ? Object.getOwnPropertyNames(gapi.auth2) : 'N/A');
            }
        } catch (error) {
            console.error('ğŸš¨ OAuth ì¸ìŠ¤í„´ìŠ¤ ì„¤ì • ì‹¤íŒ¨ - ìƒì„¸ ì •ë³´:');
            console.error('ì—ëŸ¬ íƒ€ì…:', typeof error);
            console.error('ì—ëŸ¬ ê°ì²´:', error);
            console.error('gapi ìƒíƒœ:', {
                gapi: typeof gapi,
                'gapi.auth2': typeof gapi?.auth2,
                'gapi.client': typeof gapi?.client
            });
        }
        
        console.log('ğŸ‰ Google API ì´ˆê¸°í™” ì„±ê³µ!');
        apiLoadAttempts = 0; // ì„±ê³µ ì‹œ ì¬ì‹œë„ ì¹´ìš´í„° ë¦¬ì…‹
        
        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ì— ìƒíƒœ ì—…ë°ì´íŠ¸
        setTimeout(() => {
            updateGoogleAuthStatus();
        }, 100);
        
        // Google Sign-In ì´ˆê¸°í™” (ê°œì„ ëœ ì•ˆì •ì„±)
        try {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {
                // ë” ê´€ëŒ€í•œ ì„¤ì •ìœ¼ë¡œ ì´ˆê¸°í™”
                google.accounts.id.initialize({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                    callback: handleGoogleSignIn,
                    auto_select: false,
                    cancel_on_tap_outside: false,
                    use_fedcm_for_prompt: false,
                    // ì¶”ê°€ ì•ˆì •ì„± ì˜µì…˜
                    itp_support: true,
                    ux_mode: 'popup'  // íŒì—… ëª¨ë“œ ëª…ì‹œì  ì§€ì •
                });
                console.log('âœ… Google Sign-In ì´ˆê¸°í™” ì™„ë£Œ (ê°œì„ ëœ ì„¤ì •)');
                
                // ì´ˆê¸°í™” ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    const authStatus = document.getElementById('google-auth-status');
                    if (authStatus && authStatus.innerHTML.includes('Google ë¡œê·¸ì¸ í•„ìš”')) {
                        authStatus.className = 'status status-info';
                        authStatus.innerHTML = 'ğŸ” <strong>Google ë¡œê·¸ì¸ ì¤€ë¹„ë¨</strong>: ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
                    }
                }, 500);
                
            } else {
                console.warn('âš ï¸ Google Sign-In APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                // ëŒ€ì²´ ë°©ì•ˆ ì•ˆë‚´
                setTimeout(() => {
                    const authStatus = document.getElementById('google-auth-status');
                    if (authStatus) {
                        authStatus.className = 'status status-warning';
                        authStatus.innerHTML = 'âš ï¸ <strong>Google API ë¡œë”© ì‹¤íŒ¨</strong><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    }
                }, 1000);
            }
        } catch (signInError) {
            console.error('Google Sign-In ì´ˆê¸°í™” ì‹¤íŒ¨:', signInError);
        }
        
    } catch (error) {
        // ì˜¤ë¥˜ ì •ë³´ ì•ˆì „í•˜ê²Œ ì¶”ì¶œ
        const errorMessage = getErrorMessage(error);
        console.error(`Google API ì´ˆê¸°í™” ì‹¤íŒ¨ (ì‹œë„ ${apiLoadAttempts}/${MAX_LOAD_ATTEMPTS}):`, errorMessage, error);
        
        if (apiLoadAttempts < MAX_LOAD_ATTEMPTS) {
            console.log(`${5}ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì˜¤ë¥˜: ${errorMessage})`);
            setTimeout(initGoogleAPI, 5000);
            return;
        }
        
        // ìµœì¢… ì‹¤íŒ¨ ì‹œ - ì™„ì „íˆ ì•ˆì „í•œ ëª¨ë“œë¡œ ì „í™˜
        console.log('ğŸ”„ ìµœì¢… ì‹¤íŒ¨ - ì•ˆì „ ëª¨ë“œ í™œì„±í™”');
        try {
            await enableSafeMode(errorMessage);
        } catch (safeModeError) {
            console.error('ì•ˆì „ ëª¨ë“œ í™œì„±í™”ë„ ì‹¤íŒ¨:', safeModeError);
        }
        
        // OAuth ìƒíƒœë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
        setTimeout(() => {
            try {
                updateGoogleAuthStatus();
            } catch (authStatusError) {
                console.error('OAuth ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', authStatusError);
            }
        }, 200);
        
        // ì‚¬ìš©ìì—ê²Œ ëŒ€ì•ˆ ì œì‹œ
        console.log('ğŸ’¡ ëŒ€ì•ˆ: API í‚¤ ë°©ì‹ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”');
    }
}

// ëŒ€ì²´ OAuth ì´ˆê¸°í™” ë°©ë²•
async function fallbackOAuthInit() {
    try {
        console.log('ëŒ€ì²´ OAuth ì´ˆê¸°í™” ì‹œë„...');
        
        // ê¸°ë³¸ì ì¸ í´ë¼ì´ì–¸íŠ¸ë§Œ ì´ˆê¸°í™”
        await gapi.client.init({
            apiKey: GOOGLE_CONFIG.API_KEY
        });
        
        // YouTube APIë§Œ ë¡œë“œ
        await gapi.client.load('youtube', 'v3');
        
        console.log('âœ… ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ ê¸°ë³¸ API ì´ˆê¸°í™” ì™„ë£Œ');
        
        // ê¸°ë³¸ OAuth ì—†ì´ë„ API í‚¤ ë°©ì‹ì€ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤ê³  ì•Œë¦¼
        setTimeout(() => {
            updateGoogleAuthStatus();
            console.log('ğŸ’¡ OAuthëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ API í‚¤ ë°©ì‹ì€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤');
        }, 100);
        
    } catch (error) {
        console.error('ëŒ€ì²´ ì´ˆê¸°í™”ë„ ì‹¤íŒ¨:', error);
        throw error;
    }
}

function signInGoogle() {
    try {
        console.log('ğŸ” Google ë¡œê·¸ì¸ ì‹œì‘...');
        
        // íŒì—… ì°¨ë‹¨ ë°©ì§€: ì‚¬ìš©ì ì•¡ì…˜ì—ì„œ ì§ì ‘ í˜¸ì¶œ
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
            showStatus('âŒ Google ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // ì§ì ‘ ë¡œê·¸ì¸ ë²„íŠ¼ ë Œë”ë§ (ë” ì•ˆì •ì )
        const signinContainer = document.getElementById('google-signin-btn');
        if (!signinContainer) {
            showStatus('âŒ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        // ê¸°ì¡´ ë²„íŠ¼ ë‚´ìš© í´ë¦¬ì–´
        signinContainer.innerHTML = '';
        
        // ìƒˆ ë¡œê·¸ì¸ ë²„íŠ¼ ë Œë”ë§
        google.accounts.id.renderButton(signinContainer, {
            theme: 'filled_blue',
            size: 'large',
            text: 'signin_with',
            shape: 'rectangular',
            width: 200
        });
        
        showStatus('ğŸ” ìœ„ì˜ íŒŒë€ìƒ‰ "Googleë¡œ ë¡œê·¸ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
        
        // ì¶”ê°€: prompt ë°©ì‹ë„ ì‹œë„ (ë°±ì—…)
        setTimeout(() => {
            try {
                google.accounts.id.prompt((notification) => {
                    console.log('Google ë¡œê·¸ì¸ ì•Œë¦¼:', notification);
                    if (notification.isNotDisplayed()) {
                        console.log('âš ï¸ ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ - ë²„íŠ¼ ë°©ì‹ ì‚¬ìš©');
                    } else if (notification.isSkippedMoment()) {
                        console.log('âš ï¸ ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ê°€ ê±´ë„ˆëœ€ - ë²„íŠ¼ ë°©ì‹ ì‚¬ìš©');
                    }
                });
            } catch (promptError) {
                console.log('í”„ë¡¬í”„íŠ¸ ë°©ì‹ ì‹¤íŒ¨, ë²„íŠ¼ ë°©ì‹ë§Œ ì‚¬ìš©:', promptError);
            }
        }, 1000);
        
    } catch (error) {
        console.error('Google ë¡œê·¸ì¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showStatus(`âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
        
        // ëŒ€ì•ˆ ì œì‹œ
        setTimeout(() => {
            showStatus('ğŸ’¡ í•´ê²°ë°©ë²•: 1) í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨, 2) íŒì—… ì°¨ë‹¨ í•´ì œ, 3) ì‹œí¬ë¦¿ ëª¨ë“œ ì‹œë„', 'warning', 10000);
        }, 2000);
    }
}

function handleGoogleSignIn(response) {
    try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        googleUser = {
            email: payload.email,
            name: payload.name,
            picture: payload.picture
        };
        
        isGoogleSignedIn = true;
        updateGoogleUI();
        updateGoogleDriveStatus(`âœ… ${googleUser.email}ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        
        // ìë™ ë°±ì—… ì„¤ì • ë¡œë“œ
        const savedAutoBackup = localStorage.getItem('google-auto-backup');
        if (savedAutoBackup === 'true') {
            enableAutoBackup();
        }
        
    } catch (error) {
        console.error('Google ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        showStatus('Google ë¡œê·¸ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

function signOutGoogle() {
    google.accounts.id.disableAutoSelect();
    isGoogleSignedIn = false;
    googleUser = null;
    
    // ìë™ ë°±ì—… ì¤‘ì§€
    if (autoBackupInterval) {
        clearInterval(autoBackupInterval);
        autoBackupInterval = null;
        autoBackupEnabled = false;
    }
    
    updateGoogleUI();
    updateGoogleDriveStatus('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    showStatus('Google ê³„ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

function updateGoogleUI() {
    const signinBtn = document.getElementById('google-signin-btn');
    const signoutBtn = document.getElementById('google-signout-btn');
    const backupBtn = document.getElementById('google-backup-btn');
    const autoBackupBtn = document.getElementById('auto-backup-btn');
    const userInfo = document.getElementById('google-user-info');
    const userEmail = document.getElementById('user-email');
    
    if (isGoogleSignedIn && googleUser) {
        signinBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        backupBtn.style.display = 'inline-block';
        autoBackupBtn.style.display = 'inline-block';
        userInfo.style.display = 'block';
        userEmail.textContent = googleUser.email;
        
        // ìë™ ë°±ì—… ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        autoBackupBtn.textContent = autoBackupEnabled ? 'â° ìë™ë°±ì—… ON' : 'â° ìë™ë°±ì—… OFF';
        if (autoBackupBtn) {
            autoBackupBtn.className = autoBackupEnabled ? 'btn btn-success' : 'btn btn-warning';
        }
    } else {
        signinBtn.style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        backupBtn.style.display = 'none';
        autoBackupBtn.style.display = 'none';
        userInfo.style.display = 'none';
    }
}

async function backupToGoogleDrive() {
    if (!isGoogleSignedIn) {
        showStatus('ë¨¼ì € Google ê³„ì •ì— ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        updateGoogleDriveStatus('Google Driveë¡œ ë°±ì—… ì¤‘...', 'info');
        
        // ë°±ì—… ë°ì´í„° ìƒì„±
        const backupData = {
            donations: donations || [],
            streamers: streamers || [],
            emojis: emojis || {},
            settings: {
                streamerSummaryHeader: localStorage.getItem('streamer-summary-header'),
                streamerSummaryFooter: localStorage.getItem('streamer-summary-footer'),
                excludeGukgo: localStorage.getItem('exclude-gukgo'),
                hiddenStreamers: localStorage.getItem('hidden-streamers'),
                simpleModeOnly: localStorage.getItem('simple-mode-only'),
                tableTitle: localStorage.getItem('table-title'),
                showTotalRow: localStorage.getItem('show-total-row'),
                showUpdateTime: localStorage.getItem('show-update-time')
            },
            backupDate: new Date().toISOString(),
            version: '1.0'
        };
        
        // íŒŒì¼ëª… ìƒì„±
        const now = new Date();
        const fileName = `donation-backup-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.json`;
        
        // Google Driveì— ì—…ë¡œë“œ
        const fileMetadata = {
            name: fileName,
            parents: ['appDataFolder'] // ì•± ì „ìš© í´ë”ì— ì €ì¥
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
        form.append('file', new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'}));
        
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({
                'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
            }),
            body: form
        });
        
        if (response.ok) {
            const result = await response.json();
            updateGoogleDriveStatus(`âœ… ë°±ì—… ì™„ë£Œ: ${fileName}`, 'success');
            showStatus('Google Drive ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        } else {
            throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('Google Drive ë°±ì—… ì‹¤íŒ¨:', error);
        updateGoogleDriveStatus('âŒ ë°±ì—… ì‹¤íŒ¨', 'error');
        showStatus('Google Drive ë°±ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

function toggleAutoBackup() {
    if (!isGoogleSignedIn) {
        showStatus('ë¨¼ì € Google ê³„ì •ì— ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
        return;
    }
    
    if (autoBackupEnabled) {
        // ìë™ ë°±ì—… ë¹„í™œì„±í™”
        if (autoBackupInterval) {
            clearInterval(autoBackupInterval);
            autoBackupInterval = null;
        }
        autoBackupEnabled = false;
        localStorage.setItem('google-auto-backup', 'false');
        updateGoogleDriveStatus('ìë™ ë°±ì—…ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    } else {
        // ìë™ ë°±ì—… í™œì„±í™” (ë§¤ì¼ ì˜¤í›„ 11ì‹œ)
        enableAutoBackup();
        localStorage.setItem('google-auto-backup', 'true');
        updateGoogleDriveStatus('ìë™ ë°±ì—…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤ (ë§¤ì¼ ë°¤ 11ì‹œ)', 'success');
    }
    
    updateGoogleUI();
}

function enableAutoBackup() {
    autoBackupEnabled = true;
    
    // ë§¤ì¼ ë°¤ 11ì‹œì— ìë™ ë°±ì—…
    const scheduleBackup = () => {
        const now = new Date();
        const targetTime = new Date();
        targetTime.setHours(23, 0, 0, 0); // ë°¤ 11ì‹œ
        
        if (now > targetTime) {
            targetTime.setDate(targetTime.getDate() + 1); // ë‹¤ìŒë‚ 
        }
        
        const timeUntilBackup = targetTime - now;
        
        setTimeout(() => {
            if (autoBackupEnabled && isGoogleSignedIn) {
                backupToGoogleDrive();
            }
            // ë‹¤ìŒ ë°±ì—… ìŠ¤ì¼€ì¤„
            autoBackupInterval = setInterval(() => {
                if (autoBackupEnabled && isGoogleSignedIn) {
                    backupToGoogleDrive();
                }
            }, 24 * 60 * 60 * 1000); // 24ì‹œê°„ë§ˆë‹¤
        }, timeUntilBackup);
    };
    
    scheduleBackup();
}

function updateGoogleDriveStatus(message, type = 'info') {
    const statusEl = document.getElementById('google-drive-status');
    if (!statusEl) {
        console.warn('google-drive-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    try {
        statusEl.className = `status status-${type}`;
        statusEl.textContent = message;
    } catch (error) {
        console.error('Google Drive ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}

async function sendMessageToYouTube(message, retryCount = 0) {
    if (!liveChatId || !youtubeApiKey) {
        throw new Error('YouTube ì—°ê²°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }
    
    try {
        const response = await fetch(`https://www.googleapis.com/youtube/v3/liveChat/messages?part=snippet&key=${youtubeApiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${youtubeApiKey}`
            },
            body: JSON.stringify({
                snippet: {
                    liveChatId: liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            const errorMessage = error.error?.message || 'ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨';
            
            // API í‚¤ ê´€ë ¨ ì—ëŸ¬ì‹œ ë°±ì—… í‚¤ë¡œ ìë™ ì „í™˜
            if ((errorMessage.includes('quota') || errorMessage.includes('invalid') || errorMessage.includes('blocked')) 
                && retryCount < backupApiKeys.length - 1) {
                
                console.log(`API í‚¤ ì—ëŸ¬ë¡œ ë°±ì—… í‚¤ë¡œ ì „í™˜: ${errorMessage}`);
                currentKeyIndex = (currentKeyIndex + 1) % backupApiKeys.length;
                youtubeApiKey = backupApiKeys[currentKeyIndex];
                
                showStatus(`âš ï¸ API í‚¤ ìë™ ì „í™˜ë¨ (${currentKeyIndex + 1}/${backupApiKeys.length})`, 'warning');
                
                // ë°±ì—… í‚¤ë¡œ ì¬ì‹œë„
                return await sendMessageToYouTube(message, retryCount + 1);
            }
            
            throw new Error(errorMessage);
        }
        
        return response.json();
        
    } catch (networkError) {
        if (retryCount < backupApiKeys.length - 1) {
            console.log(`ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë¡œ ë°±ì—… í‚¤ë¡œ ì „í™˜: ${networkError.message}`);
            currentKeyIndex = (currentKeyIndex + 1) % backupApiKeys.length;
            youtubeApiKey = backupApiKeys[currentKeyIndex];
            
            showStatus(`âš ï¸ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë¡œ API í‚¤ ì „í™˜ë¨`, 'warning');
            
            return await sendMessageToYouTube(message, retryCount + 1);
        }
        
        throw networkError;
    }
}

// --- YouTube API ê´€ë ¨ í•¨ìˆ˜ ---
function loadYouTubeSettings() {
    const savedApiKey = localStorage.getItem(STORAGE_KEYS.YOUTUBE_API_KEY);
    const savedVideoId = localStorage.getItem(STORAGE_KEYS.YOUTUBE_VIDEO_ID);
    
    if (savedApiKey) {
        youtubeApiKey = savedApiKey;
        document.getElementById('youtube-api-key').value = savedApiKey;
    }
    if (savedVideoId) {
        document.getElementById('youtube-video-id').value = savedVideoId;
    }
    
    updateYouTubeUI();
}

function updateYouTubeUI() {
    const hasApiKey = youtubeApiKey.length > 0;
    const hasLiveChat = liveChatId.length > 0;
    
    document.getElementById('youtube-send-btn').disabled = !hasLiveChat;
    document.getElementById('auto-start-btn').disabled = !hasLiveChat;
    
    const statusEl = document.getElementById('chatbot-status');
    if (hasLiveChat) {
        statusEl.className = 'status status-success';
        statusEl.innerHTML = 'âœ… <strong>ì—°ê²°ë¨</strong>: ìœ íŠœë¸Œ ë¼ì´ë¸Œ ì±„íŒ…ì— ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
    } else if (hasApiKey) {
        statusEl.className = 'status status-warning';
        statusEl.innerHTML = 'âš ï¸ <strong>API í‚¤ ì„¤ì •ë¨</strong>: ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ê³  ë¼ì´ë¸Œ ì—°ê²°ì„ í•´ì£¼ì„¸ìš”.';
    } else {
        statusEl.className = 'status status-warning';
        statusEl.innerHTML = 'ğŸ¤– <strong>ì„¤ì • í•„ìš”</strong>: API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ ìë™ ì „ì†¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!';
    }
}

async function testApiKey() {
    const apiKey = document.getElementById('youtube-api-key').value.trim();
    if (!apiKey) {
        showStatus('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
        const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=test&key=${apiKey}&maxResults=1`);
        
        if (response.ok) {
            showStatus('âœ… API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤!', 'success');
        } else {
            const error = await response.json();
            console.log('YouTube API ì—ëŸ¬ ìƒì„¸:', error);
            
            let errorMessage = error.error?.message || 'API í‚¤ ì—ëŸ¬';
            let suggestion = '';
            
            // êµ¬ì²´ì ì¸ ì—ëŸ¬ ì²˜ë¦¬ì™€ í•´ê²°ì±… ì œê³µ
            if (errorMessage.includes('API key not valid') || errorMessage.includes('invalid')) {
                suggestion = '\n\nğŸ’¡ í•´ê²°ë°©ë²•:\n1. Google Cloud Consoleì—ì„œ ìƒˆ API í‚¤ ìƒì„±\n2. YouTube Data API v3 í™œì„±í™” í™•ì¸\n3. OAuth ë°©ì‹ ì‚¬ìš© (ë” ì•ˆì „í•¨)';
            } else if (errorMessage.includes('quota') || errorMessage.includes('exceeded')) {
                suggestion = '\n\nğŸ’¡ í•´ê²°ë°©ë²•:\n1. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„ (í• ë‹¹ëŸ‰ ë¦¬ì…‹)\n2. ìƒˆ Google Cloud í”„ë¡œì íŠ¸ ìƒì„±\n3. OAuth ë°©ì‹ ì‚¬ìš©';
            } else if (errorMessage.includes('blocked') || errorMessage.includes('restricted')) {
                suggestion = '\n\nğŸ’¡ í•´ê²°ë°©ë²•:\n1. OAuth ë°©ì‹ ì‚¬ìš© (donation-manager-oauth.html)\n2. ìƒˆ IP/ë„ë©”ì¸ì—ì„œ ì ‘ê·¼\n3. Google Cloud í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸';
            } else if (errorMessage.includes('forbidden') || errorMessage.includes('403')) {
                suggestion = '\n\nğŸ’¡ í•´ê²°ë°©ë²•:\n1. API í‚¤ì— YouTube ê¶Œí•œ ì¶”ê°€\n2. í”„ë¡œì íŠ¸ì—ì„œ YouTube Data API v3 í™œì„±í™”\n3. OAuth ë°©ì‹ ì‚¬ìš©';
            }
            
            showStatus(`âŒ ${errorMessage}${suggestion}`, 'error');
        }
    } catch (error) {
        console.error('API í…ŒìŠ¤íŠ¸ ì—ëŸ¬:', error);
        showStatus(`âŒ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${error.message}\n\nğŸ’¡ OAuth ë²„ì „(donation-manager-oauth.html)ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”!`, 'error');
    }
}

function saveApiKey() {
    const apiKey = document.getElementById('youtube-api-key').value.trim();
    if (!apiKey) {
        showStatus('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    youtubeApiKey = apiKey;
    localStorage.setItem(STORAGE_KEYS.YOUTUBE_API_KEY, apiKey);
    updateYouTubeUI();
    showStatus('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

async function connectToLiveChat() {
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('ìœ íŠœë¸Œ ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    if (!youtubeApiKey) {
        showStatus('ë¨¼ì € API í‚¤ë¥¼ ì €ì¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì¤‘...', 'info');
        
        // ì˜ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const videoResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${youtubeApiKey}`);
        const videoData = await videoResponse.json();
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('í˜„ì¬ ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }
        
        liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem(STORAGE_KEYS.YOUTUBE_VIDEO_ID, videoId);
        updateYouTubeUI();
        showStatus('âœ… ë¼ì´ë¸Œ ì±„íŒ…ì— ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        
    } catch (error) {
        showStatus(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
        liveChatId = '';
        updateYouTubeUI();
    }
}

async function sendToYouTube() {
    const message = document.getElementById('manual-message').value.trim();
    if (!message) {
        showStatus('ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    if (!liveChatId) {
        showStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('ìœ íŠœë¸Œë¡œ ì „ì†¡ ì¤‘...', 'info');
        await sendMessageToYouTube(message);
        showStatus('âœ… ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        document.getElementById('manual-message').value = '';
        
    } catch (error) {
        showStatus(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error.message}`, 'error');
        // OAuth ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš° ì•ˆë‚´
        if (error.message.includes('authentication') || error.message.includes('unauthorized')) {
            showStatus('âš ï¸ OAuth ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” ë³µì‚¬ ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”.', 'warning', 8000);
        }
    }
}

function startAutoSend() {
    if (!liveChatId) {
        showStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
        return;
    }
    
    const interval = parseInt(document.getElementById('auto-send-interval').value) * 1000;
    if (interval < 30000) {
        showStatus('ìë™ ì „ì†¡ ê°„ê²©ì€ ìµœì†Œ 30ì´ˆì—¬ì•¼ í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    isAutoSending = true;
    document.getElementById('auto-start-btn').disabled = true;
    document.getElementById('auto-stop-btn').disabled = false;
    
    autoSendInterval = setInterval(() => {
        updateLiveSummary();
        const summaryMessage = document.getElementById('live-summary').textContent;
        document.getElementById('manual-message').value = summaryMessage;
        sendToYouTube();
    }, interval);
    
    showStatus(`âœ… ìë™ ì „ì†¡ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (${interval/1000}ì´ˆ ê°„ê²©)`, 'success');
}

function stopAutoSend() {
    if (autoSendInterval) {
        clearInterval(autoSendInterval);
        autoSendInterval = null;
    }
    
    isAutoSending = false;
    document.getElementById('auto-start-btn').disabled = false;
    document.getElementById('auto-stop-btn').disabled = true;
    
    showStatus('ìë™ ì „ì†¡ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// --- ì±—ë´‡ ê´€ë ¨ í•¨ìˆ˜ ---
function updateLiveSummary() {
    const summaryText = document.getElementById('summary-output').textContent;
    document.getElementById('live-summary').textContent = summaryText;
    if (!isAutoSending) {
        showStatus('ì‹¤ì‹œê°„ í˜„í™©ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }
}

function generateQuickMessage(type) {
    let message = '';
    const totalAmount = donations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
    const donorCount = new Set(donations.map(d => d.donor)).size;
    
    switch(type) {
        case 'welcome':
            message = `ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤ğŸ«ğŸ”¥ í˜„ì¬ ì´ ${formatAmount(totalAmount)}ë§Œì›ì´ ëª¨ì˜€ìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ğŸ’•`;
            break;
        case 'thanks':
            message = `ğŸ’ ${donorCount}ë¶„ì˜ í›„ì›ìë‹˜ë“¤ ë•ë¶„ì— ì´ ${formatAmount(totalAmount)}ë§Œì›ì´ ëª¨ì˜€ìŠµë‹ˆë‹¤! ì •ë§ ê°ì‚¬í•´ìš”ğŸ™âœ¨`;
            break;
        case 'goal':
            const runningMissions = Object.values(missionData).filter(m => m.status === 'running');
            if (runningMissions.length > 0) {
                const missionTexts = runningMissions.map(mission => {
                    const missionDonations = donations.filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime));
                    const currentAmount = missionDonations.reduce((sum, d) => sum + parseFloat(d.amount), 0);
                    const remaining = Math.max(0, parseFloat(mission.target) - currentAmount);
                    return `${emojis[mission.streamer] || ''}${mission.streamer} ${formatAmount(remaining)}ë§Œ ë‚¨ìŒ`;
                }).join(', ');
                message = `ğŸ¯ í‡´ê·¼ë¯¸ì…˜ ì§„í–‰ì¤‘! ${missionTexts} í™”ì´íŒ…!ğŸ”¥`;
            } else {
                message = `ğŸ¯ í˜„ì¬ ì§„í–‰ì¤‘ì¸ í‡´ê·¼ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¤íŠ¸ë¦¬ë¨¸ë“¤ í™”ì´íŒ…!ğŸ”¥`;
            }
            break;
        case 'mission':
            const missionSummary = document.getElementById('mission-summary-output').textContent;
            message = missionSummary !== 'ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.' ? missionSummary : 'ğŸ„ ìƒˆë¡œìš´ í‡´ê·¼ë¯¸ì…˜ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”! ğŸ„';
            break;
    }
    
    document.getElementById('manual-message').value = message;
    showStatus(`${type} ë©”ì‹œì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

function copyMessageToClipboard() {
    const message = document.getElementById('manual-message').value.trim();
    if (!message) {
        showStatus('ë³µì‚¬í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    navigator.clipboard.writeText(message).then(() => {
        showStatus('ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì±„íŒ…ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (Ctrl+V)', 'success', 5000);
    }).catch(() => {
        // ë³µì‚¬ ì‹¤íŒ¨ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ
        const textarea = document.getElementById('manual-message');
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        showStatus('ë©”ì‹œì§€ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”', 'warning');
    });
}

function clearMessage() {
    document.getElementById('manual-message').value = '';
    showStatus('ë©”ì‹œì§€ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'info');
}

// --- ê¶Œí•œ ê´€ë¦¬ í•¨ìˆ˜ ---
function updateChatbotPermissionUI() {
    const statusEl = document.getElementById('chatbot-permission-status');
    if (!statusEl) {
        console.warn('chatbot-permission-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        const hasPermission = user.isAdmin || currentPassword;
        
        if (hasPermission) {
            statusEl.innerHTML = 'âœ… <span style="color: #42b72a;">ê¶Œí•œìˆìŒ</span>';
            statusEl.title = 'ì±—ë´‡ ìë™ ì•Œë¦¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
        } else {
            statusEl.innerHTML = 'ğŸ”’ <span style="color: #fa383e;">ê¶Œí•œí•„ìš”</span>';
            statusEl.title = 'ì±—ë´‡ ìë™ ì•Œë¦¼ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
        }
    } catch (error) {
        console.error('ì±—ë´‡ ê¶Œí•œ UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}

function hasWritePermission() {
    return isAdminVerified;
}

// --- ë¯¸ì…˜ ê´€ë ¨ í•¨ìˆ˜ ---
async function toggleMission(streamer) {
    const mission = missionData[streamer] || { streamer, status: 'stopped', target: 0 };
    const targetAmount = parseFloat(document.getElementById(`mission-target-${streamer}`).value);

    const isRunning = mission.status === 'running';
    if (!isRunning && (isNaN(targetAmount) || targetAmount <= 0)) {
        return showStatus('ëª©í‘œ ê¸ˆì•¡ì„ ë¨¼ì € ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
    }

    mission.status = isRunning ? 'stopped' : 'running';
    if (mission.status === 'running') {
        mission.startTime = Date.now();
        mission.target = targetAmount;
        mission.completedTime = null;
    }
    
    missionData[streamer] = mission;
    saveToLocalStorage();
    updateMissionSettingsUI();
    updateMissionSummary();
    
    showStatus(`${streamer}ì˜ ë¯¸ì…˜ì´ ${mission.status === 'running' ? 'ì‹œì‘' : 'ì¤‘ì§€'}ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

async function saveAllMissions() {
    const missionStreamers = (streamers || []).filter(s => s !== 'êµ­ê³ ');
    for (const streamer of missionStreamers) {
        const targetAmountInput = document.getElementById(`mission-target-${streamer}`);
        if(targetAmountInput) {
            const targetAmount = parseFloat(targetAmountInput.value) || 0;
            if (!missionData[streamer]) {
                missionData[streamer] = { streamer: streamer, status: 'stopped', target: 0 };
            }
            missionData[streamer].target = targetAmount;
        }
    }
    
    saveToLocalStorage();
    updateMissionSettingsUI();
    showStatus('ëª¨ë“  ë¯¸ì…˜ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

async function stopAllMissions() {
    if (!confirm('í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ëª¨ë“  ë¯¸ì…˜ì„ ì¤‘ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    Object.values(missionData).forEach(mission => {
        if (mission.status === 'running') {
            mission.status = 'stopped';
        }
    });
    
    saveToLocalStorage();
    updateMissionSettingsUI();
    updateMissionSummary();
    showStatus('ëª¨ë“  ë¯¸ì…˜ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// --- ì˜¤ë²„ë ˆì´ ê´€ë¦¬ í•¨ìˆ˜ ---

// ì„œë²„ ì„¤ì •ì„ UIì— ì ìš©í•˜ëŠ” í•¨ìˆ˜
function applyServerSettingsToUI(settings) {
    if (!settings) return;
    
    try {
        // í›„ì›ì ì˜¤ë²„ë ˆì´ ì„¤ì •
        if (settings['overlay-font-size']) {
            const fontSize = String(settings['overlay-font-size']);
            document.getElementById('overlay-font-size-range').value = fontSize;
            document.getElementById('overlay-font-size-value').textContent = fontSize + 'px';
        }
        
        if (settings['overlay-stroke-width']) {
            const strokeWidth = String(settings['overlay-stroke-width']);
            document.getElementById('overlay-stroke-width-range').value = strokeWidth;
            document.getElementById('overlay-stroke-width-value').textContent = strokeWidth + 'px';
        }
        
        if (settings['overlay-text-align']) {
            const textAlign = settings['overlay-text-align'];
            // ì •ë ¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('overlay-align-left').style.background = '';
            document.getElementById('overlay-align-center').style.background = '';
            document.getElementById('overlay-align-right').style.background = '';
            
            const selectedButton = document.getElementById(`overlay-align-${textAlign}`);
            if (selectedButton) {
                selectedButton.style.background = '#1877f2';
                selectedButton.style.color = 'white';
            }
        }
        
        // í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì •
        if (settings['table-opacity']) {
            const opacity = String(settings['table-opacity']);
            document.getElementById('table-opacity-range').value = opacity;
            document.getElementById('table-opacity-value').textContent = opacity + '%';
        }
        
        if (settings['table-number-size']) {
            const numberSize = String(settings['table-number-size']);
            document.getElementById('table-number-size-range').value = numberSize;
            document.getElementById('table-number-size-value').textContent = numberSize + 'px';
        }
        
        if (settings['table-font-size']) {
            const fontSize = String(settings['table-font-size']);
            document.getElementById('table-font-size-range').value = fontSize;
            document.getElementById('table-font-size-value').textContent = fontSize + 'px';
        }
        
        console.log('âœ… [ê´€ë¦¬ì] ì„œë²„ ì„¤ì •ì´ UIì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:', settings);
        
    } catch (error) {
        console.error('âŒ [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • UI ì ìš© ì‹¤íŒ¨:', error);
    }
}

function openOverlay(type) {
    const overlayUrl = getOverlayURL(type);
    if (overlayUrl) {
        window.open(overlayUrl, '_blank', 'width=800,height=600');
    }
}

// ì˜¤ë²„ë ˆì´ URL ìƒì„±
function getOverlayURL(type) {
    const baseUrl = 'https://donation-manager-ufm1.onrender.com/';
    
    if (type === 'donor') {
        return baseUrl + 'donor-overlay.html';
    } else if (type === 'table') {
        return baseUrl + 'streamer-table-overlay.html';
    }
    return '';
}

// URL ë³µì‚¬ ê¸°ëŠ¥
async function copyOverlayURL(type) {
    const url = getOverlayURL(type);
    
    try {
        await navigator.clipboard.writeText(url);
        showStatus(`${type === 'donor' ? 'í›„ì›ì' : 'í…Œì´ë¸”'} ì˜¤ë²„ë ˆì´ URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    } catch (err) {
        // í´ë¦½ë³´ë“œ APIê°€ ì•ˆ ë˜ë©´ í…ìŠ¤íŠ¸ ì„ íƒ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showStatus(`${type === 'donor' ? 'í›„ì›ì' : 'í…Œì´ë¸”'} ì˜¤ë²„ë ˆì´ URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
    }
}

// QRì½”ë“œ ìƒì„± ë° í‘œì‹œ
function showQRCode(type) {
    const url = getOverlayURL(type);
    const typeName = type === 'donor' ? 'í›„ì›ìë³„ ì´ì•¡' : 'ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸”';
    
    // QRì½”ë“œ ìƒì„± (Google Charts API ì‚¬ìš©)
    const qrUrl = `https://chart.googleapis.com/chart?chs=300x300&cht=qr&chl=${encodeURIComponent(url)}`;
    
    // ëª¨ë‹¬ ìƒì„±
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); display: flex; justify-content: center; 
        align-items: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
            <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ“± ${typeName} ì˜¤ë²„ë ˆì´</h3>
            <img src="${qrUrl}" alt="QR Code" style="width: 250px; height: 250px; border: 1px solid #ddd; border-radius: 8px;">
            <p style="margin: 15px 0 10px 0; font-size: 12px; color: #666; word-break: break-all;">${url}</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="copyOverlayURL('${type}')" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">ğŸ“‹ URL ë³µì‚¬</button>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
        </div>
    `;
    
    // ë°°ê²½ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    document.body.appendChild(modal);
}

// ëª¨ë“  ì˜¤ë²„ë ˆì´ í•œë²ˆì— ì—´ê¸°
function openAllOverlays() {
    openOverlay('donor');
    setTimeout(() => openOverlay('table'), 500); // ì•½ê°„ì˜ ë”œë ˆì´
    showStatus('ëª¨ë“  ì˜¤ë²„ë ˆì´ê°€ ìƒˆ ì°½ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤!', 'info');
}

// ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° í† ê¸€
let previewEnabled = false;
function togglePreview() {
    const previewArea = document.getElementById('preview-area');
    const toggleButton = document.getElementById('preview-toggle');
    
    previewEnabled = !previewEnabled;
    
    if (previewEnabled) {
        previewArea.style.display = 'block';
        toggleButton.textContent = 'ğŸ‘ï¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ë„ê¸°';
        toggleButton.className = 'btn btn-danger';
        
        // iframe ì†ŒìŠ¤ ì„¤ì •
        document.getElementById('donor-preview').src = getOverlayURL('donor');
        document.getElementById('table-preview').src = getOverlayURL('table');
        
        showStatus('ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    } else {
        previewArea.style.display = 'none';
        toggleButton.textContent = 'ğŸ‘ï¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì¼œê¸°';
        toggleButton.className = 'btn btn-info';
        
        // iframe ì†ŒìŠ¤ ì œê±° (ì„±ëŠ¥ í–¥ìƒ)
        document.getElementById('donor-preview').src = '';
        document.getElementById('table-preview').src = '';
        
        showStatus('ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
    }
}

function updateOverlayFontSize(value) {
    document.getElementById('overlay-font-size-value').textContent = value + 'px';
    updateServerSettings({ 'overlay-font-size': value });
}

function updateOverlayStrokeWidth(value) {
    document.getElementById('overlay-stroke-width-value').textContent = value + 'px';
    updateServerSettings({ 'overlay-stroke-width': value });
}

function setOverlayTextAlign(align) {
    // ëª¨ë“  ì •ë ¬ ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    document.getElementById('overlay-align-left').style.background = '';
    document.getElementById('overlay-align-center').style.background = '';
    document.getElementById('overlay-align-right').style.background = '';
    
    // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
    document.getElementById(`overlay-align-${align}`).style.background = '#1877f2';
    document.getElementById(`overlay-align-${align}`).style.color = 'white';
    
    // ì‹¤ì‹œê°„ ì ìš© - ì„œë²„ë¡œë§Œ ì „ì†¡
    updateServerSettings({ 'overlay-text-align': align });
}

function updateTableOpacity(value) {
    document.getElementById('table-opacity-value').textContent = value + '%';
    updateServerSettings({ 'table-opacity': value });
}

function updateTableNumberSize(value) {
    document.getElementById('table-number-size-value').textContent = value + 'px';
    updateServerSettings({ 'table-number-size': value });
}

function updateTableFontSize(value) {
    document.getElementById('table-font-size-value').textContent = value + 'px';
    updateServerSettings({ 'table-font-size': value });
}

function setTableTextColor(color) {
    updateServerSettings({ 'table-text-color': color });
    showStatus(`í…Œì´ë¸” ê¸€ì ìƒ‰ìƒì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

// ì„œë²„ì— ì„¤ì • ì—…ë°ì´íŠ¸ ì „ì†¡
async function updateServerSettings(settings) {
    try {
        console.log('âš™ï¸ [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸ ì „ì†¡:', settings);
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ settings })
        });
        
        if (response.ok) {
            console.log('âœ… [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸ ì„±ê³µ');
        } else {
            console.warn('âš ï¸ [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
        }
    } catch (error) {
        console.error('âŒ [ê´€ë¦¬ì] ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
}

function applyOverlaySettings() {
    showStatus('í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¤ì‹œê°„ ë°˜ì˜)', 'success');
}

function resetOverlaySettings() {
    document.getElementById('overlay-font-size-range').value = '16';
    document.getElementById('overlay-stroke-width-range').value = '2';
    updateOverlayFontSize('16');
    updateOverlayStrokeWidth('2');
    setOverlayTextAlign('left');
    
    // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸
    updateServerSettings({ 
        'overlay-font-size': '16',
        'overlay-stroke-width': '2',
        'overlay-text-align': 'left'
    });
    
    showStatus('í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

function setTableColorPreset(preset) {
    updateServerSettings({ 'table-color-preset': preset });
    showStatus(`í…Œì´ë¸” ìƒ‰ìƒì´ ${preset}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
}

function applyTableSettings() {
    showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹¤ì‹œê°„ ë°˜ì˜)', 'success');
}

function resetTableSettings() {
    document.getElementById('table-opacity-range').value = '85';
    document.getElementById('table-number-size-range').value = '16';
    document.getElementById('table-font-size-range').value = '14';
    updateTableOpacity('85');
    updateTableNumberSize('16');
    updateTableFontSize('14');
    
    // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„œë²„ ì„¤ì • ì—…ë°ì´íŠ¸
    updateServerSettings({
        'table-opacity': '85',
        'table-number-size': '16', 
        'table-font-size': '14',
        'table-text-color': 'white',
        'table-color-preset': 'dark'
    });
    
    showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

function loadOverlaySettings() {
    // ì„œë²„ ì„¤ì •ì´ Socket.IOë¥¼ í†µí•´ ë¡œë“œë˜ë¯€ë¡œ ê¸°ë³¸ê°’ë§Œ ì„¤ì •
    // ì‹¤ì œ ê°’ì€ socket.on('initialData') ì—ì„œ ì²˜ë¦¬ë¨
    
    // í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´ ê¸°ë³¸ê°’
    document.getElementById('overlay-font-size-range').value = '18';
    document.getElementById('overlay-stroke-width-range').value = '3';
    document.getElementById('overlay-font-size-value').textContent = '18px';
    document.getElementById('overlay-stroke-width-value').textContent = '3px';
    setOverlayTextAlign('left');
    
    // ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ê¸°ë³¸ê°’
    document.getElementById('table-opacity-range').value = '85';
    document.getElementById('table-number-size-range').value = '16';
    document.getElementById('table-font-size-range').value = '14';
    document.getElementById('table-opacity-value').textContent = '85%';
    document.getElementById('table-number-size-value').textContent = '16px';
    document.getElementById('table-font-size-value').textContent = '14px';
    
    // ê·¸ë£¹í™” ì„ê³„ê°’ ë¡œë“œ
    const savedGroupThreshold = localStorage.getItem('group-threshold') || '2';
    document.getElementById('group-threshold').value = savedGroupThreshold;
    
    // ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì • ë¡œë“œ
    loadStreamerSummarySettings();
    
    // í…Œì´ë¸” ì„¤ì • ë¡œë“œ
    loadTableSettings();
}

// --- ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ ---
function toggleStreamerSummarySettings() {
    const settingsDiv = document.getElementById('streamer-summary-settings');
    const isVisible = settingsDiv.style.display !== 'none';
    settingsDiv.style.display = isVisible ? 'none' : 'block';
}

function loadStreamerSummarySettings() {
    const savedHeader = localStorage.getItem('streamer-summary-header') || 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
    const savedFooter = localStorage.getItem('streamer-summary-footer') || 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
    const savedExcludeGukgo = localStorage.getItem('exclude-gukgo') !== 'false'; // ê¸°ë³¸ê°’: true
    
    document.getElementById('streamer-summary-header').value = savedHeader;
    document.getElementById('streamer-summary-footer').value = savedFooter;
    document.getElementById('exclude-gukgo').checked = savedExcludeGukgo;
}

function saveStreamerSummarySettings() {
    const headerText = document.getElementById('streamer-summary-header').value.trim();
    const footerText = document.getElementById('streamer-summary-footer').value.trim();
    const excludeGukgo = document.getElementById('exclude-gukgo').checked;
    
    localStorage.setItem('streamer-summary-header', headerText);
    localStorage.setItem('streamer-summary-footer', footerText);
    localStorage.setItem('exclude-gukgo', excludeGukgo.toString());
    
    // ì„¤ì • ì ìš©ì„ ìœ„í•´ ìš”ì•½ ì—…ë°ì´íŠ¸
    updateSummary();
    
    showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function resetStreamerSummarySettings() {
    document.getElementById('streamer-summary-header').value = 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥';
    document.getElementById('streamer-summary-footer').value = 'ğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
    document.getElementById('exclude-gukgo').checked = true;
    
    localStorage.removeItem('streamer-summary-header');
    localStorage.removeItem('streamer-summary-footer');
    localStorage.removeItem('exclude-gukgo');
    
    // ì„¤ì • ì ìš©ì„ ìœ„í•´ ìš”ì•½ ì—…ë°ì´íŠ¸
    updateSummary();
    
    showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡ ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// --- í…Œì´ë¸” ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ ---
function toggleTableSettings() {
    const settingsDiv = document.getElementById('table-settings');
    const isVisible = settingsDiv.style.display !== 'none';
    settingsDiv.style.display = isVisible ? 'none' : 'block';
}

function loadTableSettings() {
    const savedTitle = localStorage.getItem('table-title') || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
    const savedShowTotalRow = localStorage.getItem('show-total-row') !== 'false'; // ê¸°ë³¸ê°’: true
    const savedShowUpdateTime = localStorage.getItem('show-update-time') === 'true'; // ê¸°ë³¸ê°’: false
    const savedRankCount = parseInt(localStorage.getItem('rank-count') || '10');
    
    document.getElementById('table-title-input').value = savedTitle;
    document.getElementById('show-total-row').checked = savedShowTotalRow;
    document.getElementById('show-update-time').checked = savedShowUpdateTime;
    document.getElementById('rank-count').value = savedRankCount;
    
    // ìˆœë²ˆëª… ì…ë ¥ í•„ë“œ ìƒì„± ë° ë¡œë“œ
    updateRankInputs();
}

function updateRankInputs() {
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    const container = document.getElementById('rank-inputs-container');
    
    // ê¸°ì¡´ ì…ë ¥ í•„ë“œë“¤ ì œê±°
    container.innerHTML = '';
    
    // ìƒˆë¡œìš´ ì…ë ¥ í•„ë“œë“¤ ìƒì„±
    for (let i = 1; i <= rankCount; i++) {
        const savedRankName = localStorage.getItem(`rank-${i}-name`) || i.toString();
        
        const inputDiv = document.createElement('div');
        inputDiv.innerHTML = `
            <input type="text" 
                   id="rank-${i}-name" 
                   class="form-input" 
                   placeholder="${i}ë“± (ì˜ˆ: ${getRankPresetExample('royalty', i)})" 
                   value="${savedRankName}">
        `;
        container.appendChild(inputDiv);
    }
}

function getRankPresetExample(preset, rank) {
    const presets = {
        'royalty': ['ì™•ì', 'ê·€ì¡±', 'ê¸°ì‚¬', 'ë†ë¯¼', 'ê±°ì§€', 'ë²Œë ˆ', 'ê°œë¯¸', 'ë¨¼ì§€', 'í™', 'ëŒ'],
        'flowers': ['ì¥ë¯¸', 'ë²šê½ƒ', 'í•´ë°”ë¼ê¸°', 'íŠ¤ë¦½', 'ë°ì´ì§€', 'í’€', 'ì´ë¼', 'ì¡ì´ˆ', 'ë¯¼ë“¤ë ˆ', 'í´ë¡œë²„'],
        'animals': ['ì‚¬ì', 'í˜¸ë‘ì´', 'ëŠ‘ëŒ€', 'ì—¬ìš°', 'í† ë¼', 'ë‹¤ëŒì¥', 'í–„ìŠ¤í„°', 'ë²Œë ˆ', 'ê°œë¯¸', 'ë°”í€´ë²Œë ˆ']
    };
    
    const presetArray = presets[preset] || [];
    return presetArray[rank - 1] || `${rank}ë“±`;
}

function saveTableSettings() {
    const tableTitle = document.getElementById('table-title-input').value.trim();
    const showTotalRow = document.getElementById('show-total-row').checked;
    const showUpdateTime = document.getElementById('show-update-time').checked;
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    
    localStorage.setItem('table-title', tableTitle);
    localStorage.setItem('show-total-row', showTotalRow.toString());
    localStorage.setItem('show-update-time', showUpdateTime.toString());
    localStorage.setItem('rank-count', rankCount.toString());
    
    // ëª¨ë“  ìˆœë²ˆëª… ì €ì¥
    for (let i = 1; i <= rankCount; i++) {
        const rankInput = document.getElementById(`rank-${i}-name`);
        if (rankInput) {
            const rankName = rankInput.value.trim();
            localStorage.setItem(`rank-${i}-name`, rankName);
        }
    }
    
    // ì„¤ì • ì ìš©ì„ ìœ„í•´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    updateDetailedSummaryTable();
    
    showStatus('í…Œì´ë¸” ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

function resetTableSettings() {
    document.getElementById('table-title-input').value = 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
    document.getElementById('show-total-row').checked = true;
    document.getElementById('show-update-time').checked = false;
    document.getElementById('rank-count').value = '10';
    
    // ê¸°ì¡´ ìˆœë²ˆëª… ì„¤ì • ëª¨ë‘ ì œê±°
    for (let i = 1; i <= 20; i++) {
        localStorage.removeItem(`rank-${i}-name`);
    }
    
    localStorage.removeItem('table-title');
    localStorage.removeItem('show-total-row');
    localStorage.removeItem('show-update-time');
    localStorage.removeItem('rank-count');
    
    // ìˆœë²ˆëª… ì…ë ¥ í•„ë“œ ì¬ìƒì„±
    updateRankInputs();
    
    // ì„¤ì • ì ìš©ì„ ìœ„í•´ í…Œì´ë¸” ì—…ë°ì´íŠ¸
    updateDetailedSummaryTable();
    
    showStatus('í…Œì´ë¸” ì„¤ì •ì´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

function setRankPreset(preset) {
    const presets = {
        'royalty': ['ğŸ‘‘ì™•ì', 'ğŸ¤´ê·€ì¡±', 'ğŸ§™â€â™‚ï¸ê¸°ì‚¬', 'ğŸ‘¨â€ğŸŒ¾ë†ë¯¼', 'ğŸ¥ºê±°ì§€', 'ğŸ›ë²Œë ˆ', 'ğŸœê°œë¯¸', 'ğŸ’¨ë¨¼ì§€', 'ğŸª¨í™', 'âš«ëŒ', 'ğŸ•³ï¸êµ¬ë©', 'ğŸ‘»ìœ ë ¹', 'ğŸ’€í•´ê³¨', 'ğŸ¦´ë¼ˆ', 'ğŸ—‘ï¸ì“°ë ˆê¸°', 'ğŸ’©ë˜¥', 'ğŸ¦ ì„¸ê· ', 'âš›ï¸ì›ì', 'ğŸ”¬ë¶„ì', 'ã€°ï¸í—ˆê³µ'],
        'flowers': ['ğŸŒ¹ì¥ë¯¸', 'ğŸŒ¸ë²šê½ƒ', 'ğŸŒ»í•´ë°”ë¼ê¸°', 'ğŸŒ·íŠ¤ë¦½', 'ğŸŒ¼ë°ì´ì§€', 'ğŸŒ¿í’€', 'ğŸ€í´ë¡œë²„', 'ğŸŒ±ìƒˆì‹¹', 'ğŸŒ¾ë²¼', 'ğŸ‹ëŒ€ë‚˜ë¬´', 'ğŸŒµì„ ì¸ì¥', 'ğŸŒ°ë„í† ë¦¬', 'ğŸ„ë²„ì„¯', 'ğŸ¦ ì„¸ê· ', 'ğŸ”ï¸ëŒ', 'âš«í™', 'ğŸ’¨ë°”ëŒ', 'ã€°ï¸ê³µê¸°', 'ğŸ•³ï¸ë¹ˆê³µê°„', 'ğŸ‘»ë¬´'],
        'animals': ['ğŸ¦ì‚¬ì', 'ğŸ…í˜¸ë‘ì´', 'ğŸºëŠ‘ëŒ€', 'ğŸ¦Šì—¬ìš°', 'ğŸ°í† ë¼', 'ğŸ¿ï¸ë‹¤ëŒì¥', 'ğŸ¹í–„ìŠ¤í„°', 'ğŸ›ë²Œë ˆ', 'ğŸœê°œë¯¸', 'ğŸª³ë°”í€´ë²Œë ˆ', 'ğŸ¦—ê·€ëšœë¼ë¯¸', 'ğŸ•·ï¸ê±°ë¯¸', 'ğŸ¦Ÿëª¨ê¸°', 'ğŸª°íŒŒë¦¬', 'ğŸŒë‹¬íŒ½ì´', 'ğŸ›ì• ë²Œë ˆ', 'ğŸ¦ ì„¸ê· ', 'âš›ï¸ì›ì', 'ã€°ï¸ë¬´', 'ğŸ•³ï¸ì—†ìŒ'],
        'numbers': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20']
    };
    
    const rankCount = parseInt(document.getElementById('rank-count').value) || 10;
    const presetArray = presets[preset] || [];
    
    for (let i = 1; i <= rankCount; i++) {
        const rankInput = document.getElementById(`rank-${i}-name`);
        if (rankInput) {
            const presetValue = presetArray[i - 1] || i.toString();
            rankInput.value = presetValue;
        }
    }
    
    const presetNames = {
        'royalty': 'ğŸ‘‘ ì™•ì¡±',
        'flowers': 'ğŸŒ¸ ê½ƒì´ë¦„',
        'animals': 'ğŸ¾ ë™ë¬¼',
        'numbers': 'ğŸ”¢ ìˆ«ì'
    };
    
    showStatus(`${presetNames[preset]} í”„ë¦¬ì…‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'info');
}

// --- OAuth ê´€ë ¨ í•¨ìˆ˜ë“¤ ---
// Google OAuth ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
async function signInGoogleOAuth() {
    try {
        if (!authInstance) {
            showStatus('Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        showStatus('Google ë¡œê·¸ì¸ ì¤‘...', 'info');
        
        // ëª…ì‹œì ìœ¼ë¡œ ë¡œê·¸ì¸ íŒì—… ì˜µì…˜ ì„¤ì •
        const signInOptions = {
            prompt: 'select_account'
        };
        
        const user = await authInstance.signIn(signInOptions);
        console.log('OAuth ë¡œê·¸ì¸ ì‚¬ìš©ì:', user);
        showStatus('âœ… Google OAuth ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        
    } catch (error) {
        // ìƒì„¸í•œ ì—ëŸ¬ ì •ë³´ ë¡œê¹…
        console.error('ğŸš¨ Google OAuth ë¡œê·¸ì¸ ì‹¤íŒ¨ - ìƒì„¸ ì •ë³´:');
        console.error('ì—ëŸ¬ íƒ€ì…:', typeof error);
        console.error('ì—ëŸ¬ ê°ì²´:', error);
        console.error('ì—ëŸ¬ ë¬¸ìì—´:', JSON.stringify(error, null, 2));
        
        // ì—ëŸ¬ ì†ì„±ë“¤ ê°œë³„ í™•ì¸
        if (error) {
            console.error('error.error:', error.error);
            console.error('error.message:', error.message);
            console.error('error.details:', error.details);
            console.error('error.code:', error.code);
            console.error('error.status:', error.status);
        }
        
        // authInstance ìƒíƒœ í™•ì¸
        console.error('authInstance ìƒíƒœ:', {
            exists: !!authInstance,
            isSignedIn: authInstance ? authInstance.isSignedIn.get() : 'N/A',
            currentUser: authInstance ? authInstance.currentUser.get() : 'N/A'
        });
        
        // ë” ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
        let errorMessage = 'OAuth ë¡œê·¸ì¸ ì‹¤íŒ¨';
        let errorType = 'error';
        
        if (error?.error === 'popup_closed_by_user' || error?.message?.includes('closed_by_user')) {
            errorMessage = 'âŒ ë¡œê·¸ì¸ íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            errorType = 'warning';
        } else if (error?.error === 'access_denied' || error?.message?.includes('access_denied')) {
            errorMessage = 'âŒ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
            errorType = 'error';
        } else if (error?.error === 'popup_blocked' || error?.message?.includes('popup')) {
            errorMessage = 'âŒ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
            errorType = 'warning';
        } else if (error?.error === 'network_error' || error?.message?.includes('network')) {
            errorMessage = 'âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
            errorType = 'warning';
        } else {
            // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€
            const errorText = error?.error || error?.message || error?.toString() || 'Unknown error';
            errorMessage = `âŒ OAuth ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorText}`;
        }
        
        showStatus(errorMessage, errorType);
        
        // í•´ê²°ë°©ë²• ì•ˆë‚´
        setTimeout(() => {
            showStatus('ğŸ’¡ í•´ê²°ë°©ë²•: 1) íŒì—… í—ˆìš©, 2) ì‹œí¬ë¦¿ ëª¨ë“œ ì‹œë„, 3) ë‹¤ë¥¸ ë¸Œë¼ìš°ì € ì‚¬ìš©, 4) í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨', 'info', 15000);
        }, 3000);
        
        // OAuth ìƒíƒœ ì—…ë°ì´íŠ¸
        isOAuthSignedIn = false;
        updateGoogleAuthStatus();
    }
}

async function signOutGoogleOAuth() {
    try {
        if (!authInstance) {
            showStatus('Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        await authInstance.signOut();
        showStatus('Google OAuth ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        
    } catch (error) {
        console.error('Google OAuth ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        showStatus(`Google OAuth ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// Google OAuth ìƒíƒœ ì—…ë°ì´íŠ¸
function updateGoogleAuthStatus() {
    const statusElement = document.getElementById('google-auth-status');
    if (!statusElement) {
        console.log('google-auth-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì±—ë´‡ íƒ­ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    try {
        if (isOAuthSignedIn) {
            statusElement.className = 'status status-success';
            statusElement.innerHTML = 'âœ… <strong>Google OAuth ë¡œê·¸ì¸ë¨</strong>: YouTube APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! <button onclick="signOutGoogleOAuth()" class="btn btn-secondary" style="margin-left:10px;">ë¡œê·¸ì•„ì›ƒ</button>';
        } else {
            statusElement.className = 'status status-warning';
            statusElement.innerHTML = 'ğŸ” <strong>Google OAuth ë¡œê·¸ì¸ í•„ìš”</strong>: YouTube API ì‚¬ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”. <button onclick="signInGoogleOAuth()" class="btn btn-primary" style="margin-left:10px;">ë¡œê·¸ì¸</button>';
        }
    } catch (error) {
        console.error('Google Auth ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    }
}

// OAuth ë°©ì‹ YouTube API í…ŒìŠ¤íŠ¸
async function testYouTubeOAuth() {
    try {
        if (!isOAuthSignedIn) {
            showStatus('ë¨¼ì € Google OAuth ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }
        
        showStatus('YouTube API í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
        
        const response = await gapi.client.youtube.search.list({
            part: 'snippet',
            q: 'test',
            maxResults: 1
        });
        
        if (response.status === 200) {
            showStatus('âœ… YouTube API OAuth ì—°ê²° ì„±ê³µ!', 'success');
        } else {
            throw new Error('YouTube API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('YouTube API OAuth í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        showStatus(`âŒ YouTube API OAuth í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°
async function connectToLiveChatOAuth() {
    if (!isOAuthSignedIn) {
        showStatus('ë¨¼ì € Google OAuth ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('YouTube ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì¤‘...', 'info');
        
        const response = await gapi.client.youtube.videos.list({
            part: 'liveStreamingDetails',
            id: videoId
        });
        
        const videoData = response.result;
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('í˜„ì¬ ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }
        
        liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem('youtube_video_id', videoId);
        
        showStatus('âœ… OAuth ë°©ì‹ìœ¼ë¡œ ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        updateChatbotPermissionUI();
        
    } catch (error) {
        console.error('OAuth ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube API ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë³´ì„¸ìš”.';
            } else if (apiError.code === 404) {
                errorMessage = 'ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`OAuth ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨: ${errorMessage}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ YouTube ì±„íŒ…ì— ë©”ì‹œì§€ ì „ì†¡
async function sendToYouTubeOAuth(message) {
    if (!isOAuthSignedIn) {
        showStatus('ë¨¼ì € Google OAuth ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return false;
    }
    
    if (!liveChatId) {
        showStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
        return false;
    }
    
    try {
        if (!message.trim()) {
            showStatus('ì „ì†¡í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return false;
        }
        
        showStatus('YouTube ì±„íŒ…ì— ì „ì†¡ ì¤‘...', 'info');
        
        const response = await gapi.client.youtube.liveChatMessages.insert({
            part: 'snippet',
            resource: {
                snippet: {
                    liveChatId: liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            }
        });
        
        if (response.status === 200) {
            showStatus('âœ… OAuth ë°©ì‹ìœ¼ë¡œ YouTube ì±„íŒ…ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            return true;
        } else {
            throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('OAuth YouTube ì „ì†¡ ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube ì±„íŒ… ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì±„ë„ ì†Œìœ ìì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
            } else if (apiError.code === 400) {
                errorMessage = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ì±„íŒ… IDë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`OAuth YouTube ì „ì†¡ ì‹¤íŒ¨: ${errorMessage}`, 'error');
        return false;
    }
}
</script>
</body>
</html>