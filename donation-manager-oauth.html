<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ë°©ì†¡ í›„ì› ì •ì‚° ì±—ë´‡</title>

<!-- Google Drive API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<style>
/* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; color: #333; margin: 0; padding: 0; overflow-x: hidden; }
#app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
#app-loader .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #1877f2; animation: spin 1s ease infinite; }
#app-loader p { margin-top: 20px; font-weight: 500; color: #606770; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.container { display: none; width: 100%; max-width: none; margin: 0; padding: 15px; grid-template-columns: 1.2fr 1.2fr 1.6fr; gap: 15px; min-height: calc(100vh - 30px); }
.container.loaded { display: grid; }
.panel { background: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); min-height: calc(100vh - 100px); overflow-y: auto; resize: horizontal; }
.panel h2 { margin: -20px -20px 15px -20px; padding: 15px 20px; color: #333; border-bottom: 1px solid #e0e0e0; font-size: 1.1rem; background-color: #fafafa; border-radius: 8px 8px 0 0;}
.btn { padding: 8px 16px; border: 1px solid transparent; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin: 2px; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
.btn-primary { background-color: #1877f2; color: white; border-color: #1877f2;}
.btn-success { background-color: #42b72a; color: white; border-color: #42b72a;}
.btn-danger { background-color: #fa383e; color: white; border-color: #fa383e;}
.btn-secondary { background-color: #e4e6eb; color: #4b4f56; border-color: #dddfe2;}
.btn-warning { background-color: #f5c33b; color: #1c1e21; border-color: #f5c33b;}
.btn:hover { opacity: 0.9; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.form-group { margin-bottom: 15px; }
.form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #606770; font-size: 0.9rem; }
.form-input, .form-select { width: 100%; padding: 8px 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 14px; }
.form-input:focus, .form-select:focus { outline: none; border-color: #1877f2; box-shadow: 0 0 0 2px rgba(24, 119, 242, 0.2); }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
.table th, .table td { border: 1px solid #e9ebee; padding: 8px; text-align: center; }
.table th { background-color: #f5f6f7; font-weight: 600; }
#data-table-body td[data-field] { cursor: pointer; transition: background-color 0.2s; }
#data-table-body td[data-field]:hover { background-color: #e7f3ff; }
.copy-box { background-color: #f5f6f7; border-radius: 6px; padding: 10px; margin: 10px 0; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; word-break: break-all; min-height: 60px; white-space: pre-wrap; font-size: 12px; max-height: 200px; overflow-y: auto; border: 1px solid #e9ebee; }
.status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: 500; }
.status-success { background-color: #e9f6ec; color: #348a47; border: 1px solid #cce8d2; }
.status-error { background-color: #fde9e9; color: #a52828; border: 1px solid #f8d0d1; }
.status-info { background-color: #e7f3ff; color: #185a9d; border: 1px solid #cbe3ff; }
.status-warning { background-color: #fffbe6; color: #664d03; border: 1px solid #ffe58f; }
.management-nav { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;}
.tab-button { padding: 8px 12px; border: none; background: transparent; border-bottom: 2px solid transparent; border-radius: 0; cursor: pointer; font-size: 14px; font-weight: 600; color: #606770; }
.tab-button.active { color: #1877f2; border-bottom-color: #1877f2; }
.tab-content { display: none; padding-top: 15px;}
.tab-content.active { display: block; }
.summary-tab-content { display: none; }
.summary-tab-content.active { display: block; }
.streamer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; }
.user-info { background-color: #e7f3ff; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; text-align: center; }
.admin { background-color: #fde9e9; color: #a52828; font-weight: 600; }
.autocomplete-container { position: relative; flex: 2; }
.donor-autocomplete { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dddfe2; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
.donor-autocomplete .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; }
.donor-autocomplete .autocomplete-item:hover, .donor-autocomplete .autocomplete-item.selected { background-color: #1877f2; color: white; }
.save-status { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; transition: all 0.5s; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.save-status.saving { background-color: #f5c33b; color: #1c1e21; }
.save-status.saved { background-color: #42b72a; color: white; }
.save-status.error { background-color: #fa383e; color: white; }
.summary-header { display: flex; justify-content: space-between; align-items: center; }
.summary-header h4 { margin: 0; }
.summary-actions .btn { font-size:12px; padding:4px 8px; margin-left: 5px; }
@media (max-width: 1200px) { .container { grid-template-columns: 1fr 1fr; } }
@media (max-width: 900px) { .container { grid-template-columns: 1fr !important; } .panel { min-height: auto !important; resize: none !important; } }
</style>
</head>
<body>
<div id="app-loader">
<div class="spinner"></div>
<p>ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>
<div id="save-status" style="display: none;"></div>
<div class="container" id="app-container">
<div class="panel">
<h2>ê´€ë¦¬</h2>
<div class="management-nav">
<button class="tab-button active" onclick="switchTab(event, 'donation')">í›„ì›ë“±ë¡</button>
<button class="tab-button" onclick="switchTab(event, 'streamer')">ìŠ¤íŠ¸ë¦¬ë¨¸</button>
<button class="tab-button" onclick="switchTab(event, 'mission')">ğŸ„ í‡´ê·¼ë¯¸ì…˜</button>
<button class="tab-button" onclick="switchTab(event, 'overlay')">ğŸ¨ ì˜¤ë²„ë ˆì´</button>
<button class="tab-button" onclick="switchTab(event, 'password')" id="password-tab-btn" style="display: none;">ë¹„ë°€ë²ˆí˜¸</button>
<button class="tab-button" onclick="switchTab(event, 'data')">ë°ì´í„°</button>
<button class="tab-button" onclick="switchTab(event, 'chatbot')">ğŸ¤– ì±—ë´‡</button>
<button class="tab-button" onclick="switchTab(event, 'simple')" id="simple-tab-btn">ğŸ¯ ì¡°ì •</button>
</div>
<div id="main-content">
<div class="tab-content active" id="donation-tab">
<div id="password-section" style="display: none; margin-bottom:15px;">
<div style="display: flex; gap: 5px;"><input type="password" id="password-input" placeholder="4ìë¦¬ ë¹„ë°€ë²ˆí˜¸" maxlength="4" class="form-input"><button onclick="verifyPassword()" class="btn btn-primary">í™•ì¸</button></div>
</div>
<div class="form-group"><label class="form-label">í›„ì›ìëª…</label><div class="autocomplete-container" style="flex:auto;"><input type="text" id="donor-input" class="form-input" autocomplete="off"><div id="donor-autocomplete" class="donor-autocomplete"></div></div></div>
<div class="form-group"><label class="form-label">í›„ì› íƒ€ì…</label><div style="display: flex; gap: 15px;"><label><input type="radio" name="paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label><label><input type="radio" name="paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label><label><input type="radio" name="paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label></div></div>
<div class="form-group"><label class="form-label">ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡(ë§Œ)</label><div class="streamer-grid" id="streamer-inputs"></div></div>
<button onclick="addDonation()" class="btn btn-primary" id="add-btn" style="width:100%;">âœ¨ ë“±ë¡</button>
</div>

<div class="tab-content" id="chatbot-tab">
<div id="chatbot-status" class="status status-warning">
ğŸ” <strong>OAuth ë¡œê·¸ì¸ í•„ìš”</strong>: YouTube API ì‚¬ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”.
</div>

<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ”§ YouTube API í…ŒìŠ¤íŠ¸</h4>
<button onclick="testApiKey()" class="btn btn-primary">API ì—°ê²° í…ŒìŠ¤íŠ¸</button>
</div>

<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ“º ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°</h4>
<div style="display: flex; gap: 10px; margin-bottom: 10px;">
<input type="text" id="youtube-video-id" placeholder="YouTube ì˜ìƒ ID" class="form-input">
<button onclick="connectToLiveChat()" class="btn btn-success">ì—°ê²°</button>
</div>
<p style="font-size: 12px; color: #666; margin: 0;">
ğŸ’¡ YouTube ë¼ì´ë¸Œ ë°©ì†¡ URLì—ì„œ watch?v= ë’¤ì˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
</p>
</div>

<div style="margin-bottom: 20px;">
<h4 style="margin-bottom: 10px;">ğŸ’¬ ì‹¤ì‹œê°„ ìš”ì•½</h4>
<div id="live-summary" class="copy-box">
ì—¬ê¸°ì— ì‹¤ì‹œê°„ í›„ì› ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤...
</div>
<button onclick="sendToYouTube()" class="btn btn-primary">YouTube ì±„íŒ…ì— ì „ì†¡</button>
</div>
</div>

<div class="tab-content" id="streamer-tab">
<div style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="new-streamer-name" placeholder="ì´ë¦„" class="form-input"><input type="text" id="new-streamer-emoji" placeholder="ì´ëª¨ì§€" class="form-input" style="flex: 0 0 80px;"><button onclick="addStreamer()" class="btn btn-success" id="add-streamer-btn">ì¶”ê°€</button></div>
<div id="streamer-list"></div>
</div>
</div>
</div>

<div class="panel">
<h2>ë°ì´í„° ì¡°íšŒ</h2>
<div id="data-status" class="status status-info">
ğŸ“Š <strong>ë°ì´í„° ë™ê¸°í™”ë¨</strong>: Google Driveì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.
</div>
<div id="data-table-container">
<table class="table" id="data-table">
<thead>
<tr>
<th>ë‚ ì§œ</th>
<th>í›„ì›ì</th>
<th>íƒ€ì…</th>
<th>í•©ê³„</th>
</tr>
</thead>
<tbody id="data-table-body">
</tbody>
</table>
</div>
</div>

<div class="panel">
<h2>ì‹¤ì‹œê°„ ìš”ì•½</h2>
<div class="summary-header">
<h4>ğŸ“Š ì˜¤ëŠ˜ì˜ í›„ì› í˜„í™©</h4>
</div>
<div id="summary-content" class="copy-box">
í›„ì› ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
</div>
</div>
</div>

<script>
// GIS (Google Identity Services) ê¸°ë°˜ OAuth êµ¬í˜„

// Google API ì„¤ì •
const GOOGLE_CONFIG = {
    CLIENT_ID: '493287022430-4mmnh4stu22p13lr0sjgvpg0nbkouova.apps.googleusercontent.com',
    API_KEY: 'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4',
    DISCOVERY_DOCS: [
        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
        'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'
    ],
    SCOPES: 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl https://www.googleapis.com/auth/drive.file'
};

let tokenClient;
let isOAuthSignedIn = false;
let liveChatId = '';

// GIS ë¡œë“œ ëŒ€ê¸° í•¨ìˆ˜
function waitForGoogleAPI() {
    return new Promise((resolve) => {
        const checkGIS = () => {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                console.log('âœ… Google Identity Services ë¡œë“œ ì™„ë£Œ');
                resolve();
            } else {
                console.log('â³ Google Identity Services ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                setTimeout(checkGIS, 500);
            }
        };
        checkGIS();
    });
}

function waitForGAPI() {
    return new Promise((resolve) => {
        const checkGAPI = () => {
            if (typeof gapi !== 'undefined' && gapi.load) {
                console.log('âœ… Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£„');
                resolve();
            } else {
                console.log('â³ Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                setTimeout(checkGAPI, 500);
            }
        };
        checkGAPI();
    });
}

// ì•ˆì „í•œ GIS ê¸°ë°˜ Google API ì´ˆê¸°í™”
async function initGoogleAPI() {
    try {
        console.log('ğŸ”„ GIS ë°©ì‹ìœ¼ë¡œ ì´ˆê¸°í™” ì‹œë„...');
        
        // 1) Google APIs ë¡œë“œ ëŒ€ê¸°
        await waitForGAPI();
        await waitForGoogleAPI();
        
        // 2) gapi client ì´ˆê¸°í™”
        console.log('GAPI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...');
        await new Promise((resolve) => gapi.load('client', resolve));
        await gapi.client.init({
            apiKey: GOOGLE_CONFIG.API_KEY,
            discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS
        });
        
        // 3) GIS OAuth í† í° í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„
        console.log('GIS í† í° í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„ ì¤‘...');
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CONFIG.CLIENT_ID,
            scope: GOOGLE_CONFIG.SCOPES,
            callback: (response) => {
                if (response && response.access_token) {
                    gapi.client.setToken({ access_token: response.access_token });
                    isOAuthSignedIn = true;
                    updateGoogleAuthStatus();
                    showStatus('âœ… OAuth í† í° íšë“ ì™„ë£Œ', 'success');
                } else {
                    showStatus('âŒ OAuth í† í° íšë“ ì‹¤íŒ¨', 'error');
                    console.log('í† í° ì‘ë‹µ ì˜¤ë¥˜:', response);
                }
            }
        });
        
        console.log('âœ… GIS ì´ˆê¸°í™” ì„±ê³µ!');
        updateGoogleAuthStatus();
        
    } catch (error) {
        console.error('âŒ GIS ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        updateFailedStatus();
    }
}

// GIS OAuth ë¡œê·¸ì¸
function signInGoogleOAuth() {
    if (!tokenClient) {
        showStatus('OAuth ì´ˆê¸°í™” ì•ˆë¨ - ì¬ì´ˆê¸°í™” ì‹œë„', 'error');
        initGoogleAPI(); // ì¬ì´ˆê¸°í™” ì‹œë„
        return;
    }
    try {
        console.log('OAuth ë¡œê·¸ì¸ ì‹œë„...');
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } catch (error) {
        console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        showStatus('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜', 'error');
    }
}

// GIS OAuth ë¡œê·¸ì•„ì›ƒ
function signOutGoogleOAuth() {
    const token = gapi.client.getToken();
    if (token && token.access_token) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            isOAuthSignedIn = false;
            liveChatId = '';
            updateGoogleAuthStatus();
            showStatus('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
        });
    }
}

// OAuth í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (API í‚¤ ëŒ€ì‹ )
async function testYouTubeOAuth() {
    try {
        if (!isSignedIn) {
            showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }
        
        showStatus('YouTube API í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ YouTube API í˜¸ì¶œ
        const response = await gapi.client.youtube.search.list({
            part: 'snippet',
            q: 'test',
            maxResults: 1
        });
        
        if (response.status === 200) {
            showStatus('âœ… YouTube API ì—°ê²° ì„±ê³µ!', 'success');
        } else {
            throw new Error('YouTube API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        showStatus(`âŒ YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°
async function connectToLiveChatOAuth() {
    if (!isSignedIn) {
        showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('YouTube ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ ì˜ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await gapi.client.youtube.videos.list({
            part: 'liveStreamingDetails',
            id: videoId
        });
        
        const videoData = response.result;
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('í˜„ì¬ ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }
        
        window.liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem('youtube_video_id', videoId);
        
        showStatus('âœ… ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        if (typeof updateChatbotStatus === 'function') {
            updateChatbotStatus();
        }
        
    } catch (error) {
        console.error('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube API ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë³´ì„¸ìš”.';
            } else if (apiError.code === 404) {
                errorMessage = 'ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨: ${errorMessage}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ YouTube ì±„íŒ…ì— ë©”ì‹œì§€ ì „ì†¡
async function sendToYouTubeOAuth() {
    if (!isSignedIn) {
        showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    if (!window.liveChatId) {
        showStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        const message = document.getElementById('live-summary').textContent;
        if (!message.trim()) {
            showStatus('ì „ì†¡í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }
        
        showStatus('YouTube ì±„íŒ…ì— ì „ì†¡ ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        const response = await gapi.client.youtube.liveChatMessages.insert({
            part: 'snippet',
            resource: {
                snippet: {
                    liveChatId: window.liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            }
        });
        
        if (response.status === 200) {
            showStatus('âœ… YouTube ì±„íŒ…ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('YouTube ì „ì†¡ ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube ì±„íŒ… ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì±„ë„ ì†Œìœ ìì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
            } else if (apiError.code === 400) {
                errorMessage = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ì±„íŒ… IDë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`YouTube ì „ì†¡ ì‹¤íŒ¨: ${errorMessage}`, 'error');
    }
}

// ë‹¤ì‹œ ì‹œë„ í•¨ìˆ˜
async function retryGoogleAPI() {
    const statusElement = document.getElementById('chatbot-status');
    if (statusElement) {
        statusElement.className = 'status status-info';
        statusElement.innerHTML = 'ğŸ”„ <strong>Google API ì¬ì´ˆê¸°í™” ì¤‘...</strong>';
    }
    
    // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
    authInstance = null;
    isSignedIn = false;
    
    await initGoogleAPI();
}

// Google ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ - ì•ˆì „í•œ ë°©ì‹




function updateFailedStatus() {
    const statusElement = document.getElementById('chatbot-status');
    if (!statusElement) return;
    
    statusElement.className = 'status status-error';
    statusElement.innerHTML = `âŒ <strong>API ì´ˆê¸°í™” ì‹¤íŒ¨</strong>: YouTube APIì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>
        <small>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ë‚˜ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</small><br>
        <button onclick="retryGoogleAPI()" class="btn btn-warning" style="margin-top:10px;">ë‹¤ì‹œ ì‹œë„</button>`;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ê¸°ì¡´ ì•± + OAuth)
window.addEventListener('load', async () => {
    console.log('=== í˜ì´ì§€ ë¡œë“œ ì‹œì‘ ===');
    console.log(`URL: ${window.location.href}`);
    
    // Google APIs ì´ˆê¸°í™” (ì•½ê°„ ì§€ì—°)
    setTimeout(async () => {
        await initGoogleAPI();
        await initializeExistingApp();
    }, 1000);
});

// ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
async function initializeExistingApp() {
    const loader = document.getElementById('app-loader');
    try {
        console.log("Initializing existing app...");
        initEventListeners();
        loadFromLocalStorage();
        updateAllUI();
        updateAdminElements();
        updateTabVisibility();
        
        document.getElementById('app-container').classList.add('loaded');
        if (loader) loader.style.display = 'none';
        
        console.log("Existing application loaded successfully.");
        
    } catch (error) {
        if (loader) {
            const spinner = loader.querySelector('.spinner');
            const text = loader.querySelector('p');
            if (spinner) spinner.style.display = 'none';
            if (text) text.textContent = `ì•± ë¡œë”© ì‹¤íŒ¨: ${error.message}`;
        }
        console.error("Existing app initialization failed:", error.stack || error);
    }
}


// ê¸°ì¡´ í•¨ìˆ˜ë“¤ì„ ì¡°ê±´ë¶€ë¡œ ì„¤ì •
window.testApiKey = function() {
    if (window.apiKeyMode) {
        testApiKeyFunction();
    } else {
        testYouTubeOAuth();
    }
};

window.connectToLiveChat = function() {
    if (window.apiKeyMode) {
        updateGoogleStatus('âŒ ë¼ì´ë¸Œ ì±„íŒ…ì€ OAuth ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    } else {
        connectToLiveChatOAuth();
    }
};

window.sendToYouTube = function() {
    if (window.apiKeyMode) {
        updateGoogleStatus('âŒ ì±„íŒ… ì „ì†¡ì€ OAuth ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
    } else {
        sendToYouTubeOAuth();
    }
};

// --- ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤ ---

let streamers = ['ì—„ì‚¼ìš©','ì†ë•ë°°','ì—°ê¸°','ì£¼ì˜¥','ë¶ˆê³°','ì´íš¨íŒ”','ë™ë™','ë‚¨ë¶•','ì˜¥ê¸”','êµ­ê³ '];
let emojis = {'ì—„ì‚¼ìš©': 'ğŸ«…', 'ì†ë•ë°°':'ğŸŒº', 'ì—°ê¸°': 'ğŸ§', 'ë™ë™': 'ğŸ˜', 'ì£¼ì˜¥': 'ğŸ‘º', 'ë¶ˆê³°':'ğŸ¬', 'ì´íš¨íŒ”': 'ğŸ', 'ë‚¨ë¶•': 'ğŸ¤ ', 'ì˜¥ê¸”':'ğŸ¦†', 'êµ­ê³ ':'ğŸ¦'};
let donations = [], missionData = {}, user = { email: 'local@user.com', isAdmin: false };
let currentPassword = '2749'; // ê´€ë¦¬ì ì „ìš© ê³ ì • ë¹„ë°€ë²ˆí˜¸
let isAdminVerified = false; // ê´€ë¦¬ì ì¸ì¦ ìƒíƒœ
let autoSaveEnabled = true, selectedRows = new Set(), todayDonors = new Set();
let activeAutocompleteIndex = -1;
let currentlyEditing = null;
let isBusy = false;
let autoRefreshInterval = null;

// YouTube API ê´€ë ¨ ë³€ìˆ˜ (OAuth ë²„ì „ìš©)
let youtubeApiKey = '';
let liveChatId = '';

// ë°±ì—… API í‚¤ë“¤ (í• ë‹¹ëŸ‰ ì´ˆê³¼ì‹œ ìë™ ì „í™˜)
let backupApiKeys = [
    'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4', // ì‚¬ìš©ì ì œê³µ í‚¤
    'AIzaSyCTTBeP7zWHyuP5FuuQlOOity-2_hPjHmM'  // ê¸°ë³¸ ë°±ì—… í‚¤
];
let currentKeyIndex = 0;

// Google Drive API ê´€ë ¨ ë³€ìˆ˜
let isGoogleSignedIn = false;
let googleUser = null;
let autoBackupEnabled = false;
let autoBackupInterval = null;
let autoSendInterval = null;
let isAutoSending = false;

// --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ---
const ADDITIONAL_STORAGE_KEYS = {
    DONATIONS: 'donation_data',
    STREAMERS: 'streamer_config',
    EMOJIS: 'streamer_emojis',  
    MISSIONS: 'mission_data',
    PASSWORD: 'admin_password',
    YOUTUBE_API_KEY: 'youtube_api_key',
    YOUTUBE_VIDEO_ID: 'youtube_video_id'
};

// --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ---
function saveToLocalStorage() {
    try {
        localStorage.setItem(ADDITIONAL_STORAGE_KEYS.DONATIONS, JSON.stringify(donations));
        localStorage.setItem(ADDITIONAL_STORAGE_KEYS.STREAMERS, JSON.stringify(streamers));
        localStorage.setItem(ADDITIONAL_STORAGE_KEYS.EMOJIS, JSON.stringify(emojis));
        localStorage.setItem(ADDITIONAL_STORAGE_KEYS.MISSIONS, JSON.stringify(missionData));
        localStorage.setItem(ADDITIONAL_STORAGE_KEYS.PASSWORD, currentPassword);
    } catch (error) {
        console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:', error);
    }
}

function loadFromLocalStorage() {
    try {
        const savedDonations = localStorage.getItem(ADDITIONAL_STORAGE_KEYS.DONATIONS);
        const savedStreamers = localStorage.getItem(ADDITIONAL_STORAGE_KEYS.STREAMERS);
        const savedEmojis = localStorage.getItem(ADDITIONAL_STORAGE_KEYS.EMOJIS);
        const savedMissions = localStorage.getItem(ADDITIONAL_STORAGE_KEYS.MISSIONS);
        const savedPassword = localStorage.getItem(ADDITIONAL_STORAGE_KEYS.PASSWORD);

        if (savedDonations) {
            donations = JSON.parse(savedDonations).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
        }
        if (savedStreamers) streamers = JSON.parse(savedStreamers);
        if (savedEmojis) emojis = JSON.parse(savedEmojis);
        if (savedMissions) missionData = JSON.parse(savedMissions);
        if (savedPassword) currentPassword = savedPassword;

        // í›„ì›ì ëª©ë¡ ì¬êµ¬ì„±
        todayDonors = new Set(donations.map(d => d.donor));
    } catch (error) {
        console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// --- íƒ­ ì „í™˜ í•¨ìˆ˜ ---
function switchTab(event, tabId) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸ ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // í´ë¦­ëœ íƒ­ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
    event.target.classList.add('active');
    
    // í•´ë‹¹ íƒ­ ì½˜í…ì¸  ë³´ì´ê¸°
    const tabContent = document.getElementById(tabId + '-tab');
    if (tabContent) {
        tabContent.classList.add('active');
    }
}

// --- ìŠ¤íŠ¸ë¦¬ë¨¸ ê´€ë¦¬ í•¨ìˆ˜ ---
function addStreamer() {
    const nameInput = document.getElementById('new-streamer-name');
    const emojiInput = document.getElementById('new-streamer-emoji');
    const name = nameInput.value.trim();
    const emoji = emojiInput.value.trim();
    
    if (!name) {
        showStatus('ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    if (streamers.includes(name)) {
        showStatus('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤', 'warning');
        return;
    }
    
    streamers.push(name);
    if (emoji) emojis[name] = emoji;
    
    nameInput.value = '';
    emojiInput.value = '';
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`ìŠ¤íŠ¸ë¦¬ë¨¸ ${emoji}${name} ì¶”ê°€ë¨`, 'success');
}

// --- í›„ì› ë“±ë¡ í•¨ìˆ˜ ---
function addDonation() {
    const donor = document.getElementById('donor-input').value.trim();
    if (!donor) return showStatus('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    
    const inputs = document.querySelectorAll('#streamer-inputs input[type="number"]');
    const newDons = [];
    
    inputs.forEach(input => {
        const amount = parseFloat(input.value);
        if (!isNaN(amount) && amount > 0) {
            const streamerName = input.dataset.streamer;
            newDons.push({ 
                donor, 
                streamer: streamerName, 
                type: document.querySelector('input[name="paytype"]:checked').value, 
                amount, 
                time: new Date() 
            });
        }
    });
    
    if (newDons.length > 0) {
        document.getElementById('donor-input').value = '';
        inputs.forEach(input => input.value = '');
        handleNewDonations(newDons);
    } else {
        showStatus('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
    }
}

function handleNewDonations(newDonations) {
    if (!newDonations || newDonations.length === 0) return;

    donations.unshift(...newDonations);
    donations.sort((a, b) => b.time - a.time);
    newDonations.forEach(d => todayDonors.add(d.donor));
    
    if (autoSaveEnabled) {
        saveToLocalStorage();
        showSaveStatus('ì €ì¥ ì™„ë£Œ', 'saved');
    }
    
    updateAllUI();
}

// --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
function updateAllUI() {
    updateStreamerInputs();
    updateStreamerList();
    updateTable();
    updateSummary();
}

function updateStreamerInputs() {
    const container = document.getElementById('streamer-inputs');
    if (!container) return;
    
    const hiddenStreamers = JSON.parse(localStorage.getItem('hidden-streamers') || '[]');
    const visibleStreamers = streamers.filter(s => !hiddenStreamers.includes(s));
    
    container.innerHTML = visibleStreamers.map(streamer => 
        `<div style="display: flex; flex-direction: column; align-items: center;">
            <span style="margin-bottom: 5px; font-size: 12px; font-weight: 600;">
                ${emojis[streamer] || ''}${streamer}
            </span>
            <input type="number" step="0.1" min="0" data-streamer="${streamer}" 
                   class="form-input" style="text-align: center;">
        </div>`
    ).join('');
}

function updateStreamerList() {
    const container = document.getElementById('streamer-list');
    if (!container) return;
    
    container.innerHTML = streamers.map((streamer, index) => 
        `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
            <span>${emojis[streamer] || ''}${streamer}</span>
            <button onclick="removeStreamer(${index})" class="btn btn-danger" style="font-size: 12px; padding: 4px 8px;">ì‚­ì œ</button>
        </div>`
    ).join('');
}

function removeStreamer(index) {
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const streamerName = streamers[index];
    streamers.splice(index, 1);
    delete emojis[streamerName];
    
    saveToLocalStorage();
    updateAllUI();
    showStatus(`${streamerName} ì‚­ì œë¨`, 'info');
}

function updateTable() {
    const tableBody = document.getElementById('data-table-body');
    if (!tableBody) return;
    
    const recentDonations = donations.slice(0, 50); // ìµœê·¼ 50ê°œë§Œ í‘œì‹œ
    
    tableBody.innerHTML = recentDonations.map((donation, index) => 
        `<tr>
            <td>${new Date(donation.time).toLocaleDateString('ko-KR')}</td>
            <td>${donation.donor}</td>
            <td>${donation.type}</td>
            <td>${donation.amount}ë§Œ</td>
        </tr>`
    ).join('');
}

function updateSummary() {
    updateStreamerSummary();
    updateDonorSummary();
    updateRecentLog();
}

function updateStreamerSummary() {
    const container = document.getElementById('summary-output');
    if (!container) return;
    
    const today = new Date().toDateString();
    const todayDonations = donations.filter(d => new Date(d.time).toDateString() === today);
    
    const streamerTotals = {};
    todayDonations.forEach(d => {
        if (!streamerTotals[d.streamer]) {
            streamerTotals[d.streamer] = 0;
        }
        streamerTotals[d.streamer] += d.amount;
    });
    
    const sortedStreamers = Object.entries(streamerTotals)
        .sort(([,a], [,b]) => b - a)
        .filter(([name]) => name !== 'êµ­ê³ '); // êµ­ê³  ì œì™¸
    
    let summary = 'ğŸ”¥ğŸ«ì‚¼ìš©ìŠ¤ì¿¨ğŸ«ğŸ”¥\n\n';
    sortedStreamers.forEach(([name, total]) => {
        summary += `${emojis[name] || ''}${name}: ${total}ë§Œ\n`;
    });
    summary += '\nğŸ§íˆ¬ë„¤/ê³„ì¢Œ [8:2] ğŸ‰ìŠˆí¼ì±—ì€ êµ­ê³ ë¡œ~!';
    
    container.textContent = summary;
}

function updateDonorSummary() {
    const container = document.getElementById('donor-total');
    if (!container) return;
    
    const today = new Date().toDateString();
    const todayDonations = donations.filter(d => new Date(d.time).toDateString() === today);
    
    const donorTotals = {};
    todayDonations.forEach(d => {
        if (!donorTotals[d.donor]) {
            donorTotals[d.donor] = 0;
        }
        donorTotals[d.donor] += d.amount;
    });
    
    const sortedDonors = Object.entries(donorTotals).sort(([,a], [,b]) => b - a);
    
    const summary = sortedDonors.map(([name, total]) => `${name}: ${total}ë§Œ`).join('\n');
    container.textContent = summary;
}

function updateRecentLog() {
    const container = document.getElementById('recent-log');
    if (!container) return;
    
    const minutes = parseInt(document.getElementById('recent-minutes')?.value) || 5;
    const cutoffTime = new Date(Date.now() - minutes * 60 * 1000);
    
    const recentDonations = donations.filter(d => new Date(d.time) >= cutoffTime);
    
    const summary = recentDonations.map(d => 
        `${new Date(d.time).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})} ${d.donor} ${d.amount}ë§Œ (${d.type})`
    ).join('\n');
    
    container.textContent = summary || 'ìµœê·¼ ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
}

// --- ìƒíƒœ í‘œì‹œ í•¨ìˆ˜ ---
function showStatus(message, type = 'info') {
    console.log(`[${type}] ${message}`);
    // í•„ìš”ì‹œ UIì— ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
}

function showSaveStatus(message, type = 'info') {
    const statusEl = document.getElementById('save-status');
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = `save-status ${type}`;
        statusEl.style.display = 'block';
        
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    }
}

// --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
function initEventListeners() {
    // í›„ì›ì ì…ë ¥ ìë™ì™„ì„± (ê°„ë‹¨ ë²„ì „)
    const donorInput = document.getElementById('donor-input');
    if (donorInput) {
        donorInput.addEventListener('input', function() {
            // ìë™ì™„ì„± ë¡œì§ (ê°„ë‹¨ ë²„ì „)
        });
    }
}

async function updateUserInfo() {
    // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
    user.isAdmin = isAdminVerified;
}

function updateAdminElements() {
    // ê´€ë¦¬ì ìš”ì†Œ í‘œì‹œ/ìˆ¨ê¹€
}

function updateTabVisibility() {
    // íƒ­ í‘œì‹œ/ìˆ¨ê¹€ ë¡œì§
}

// --- í…ìŠ¤íŠ¸ ë³µì‚¬ í•¨ìˆ˜ ---
function copyText(elementId) {
    const element = document.getElementById(elementId);
    if (element && element.textContent) {
        navigator.clipboard.writeText(element.textContent).then(() => {
            showStatus('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }).catch(err => {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            showStatus('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        });
    }
}

</script>
</body>
</html>