<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ë°©ì†¡ í›„ì› ì •ì‚° ì±—ë´‡</title>

<!-- Google Drive API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<style>
/* ê¸°ì¡´ CSSëŠ” ë™ì¼í•˜ë¯€ë¡œ ìƒëµ... */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; min-height: 100vh; color: #333; margin: 0; padding: 0; overflow-x: hidden; }
/* ... ê¸°ì¡´ CSS ... */
</style>
</head>
<body>
<!-- ê¸°ì¡´ HTML êµ¬ì¡°ëŠ” ë™ì¼... -->

<script>
// OAuth ì¸ì¦ ë°©ì‹ìœ¼ë¡œ YouTube API ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •ëœ í•µì‹¬ í•¨ìˆ˜ë“¤

// Google API ì„¤ì • (YouTube API ì¶”ê°€)
const GOOGLE_CONFIG = {
    CLIENT_ID: '493287022430-f3flnq1h5qnc68856hap4jcmmqe2rtpu.apps.googleusercontent.com',
    DISCOVERY_DOCS: [
        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
        'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest'  // YouTube API ì¶”ê°€
    ],
    SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl'
};

let isSignedIn = false;
let authInstance = null;

// Google API ì´ˆê¸°í™” (YouTube API í¬í•¨)
async function initGoogleAPI() {
    try {
        await new Promise((resolve) => {
            gapi.load('client:auth2', resolve);
        });
        
        await gapi.client.init({
            discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS,
            clientId: GOOGLE_CONFIG.CLIENT_ID,
            scope: GOOGLE_CONFIG.SCOPES
        });
        
        authInstance = gapi.auth2.getAuthInstance();
        isSignedIn = authInstance.isSignedIn.get();
        
        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        authInstance.isSignedIn.listen((signedIn) => {
            isSignedIn = signedIn;
            updateGoogleStatus();
            console.log('ì¸ì¦ ìƒíƒœ ë³€ê²½:', signedIn ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨');
        });
        
        console.log('Google API (Drive + YouTube) ì´ˆê¸°í™” ì™„ë£Œ');
        updateGoogleStatus();
        
    } catch (error) {
        console.error('Google API ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showStatus(`Google API ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// OAuth í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (API í‚¤ ëŒ€ì‹ )
async function testYouTubeOAuth() {
    try {
        if (!isSignedIn) {
            showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
            return;
        }
        
        showStatus('YouTube API í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ YouTube API í˜¸ì¶œ
        const response = await gapi.client.youtube.search.list({
            part: 'snippet',
            q: 'test',
            maxResults: 1
        });
        
        if (response.status === 200) {
            showStatus('âœ… YouTube API ì—°ê²° ì„±ê³µ!', 'success');
        } else {
            throw new Error('YouTube API í˜¸ì¶œ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        showStatus(`âŒ YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²°
async function connectToLiveChatOAuth() {
    if (!isSignedIn) {
        showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    const videoId = document.getElementById('youtube-video-id').value.trim();
    if (!videoId) {
        showStatus('YouTube ì˜ìƒ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        showStatus('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ ì˜ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await gapi.client.youtube.videos.list({
            part: 'liveStreamingDetails',
            id: videoId
        });
        
        const videoData = response.result;
        
        if (!videoData.items || videoData.items.length === 0) {
            throw new Error('ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
        
        const liveDetails = videoData.items[0].liveStreamingDetails;
        if (!liveDetails || !liveDetails.activeLiveChatId) {
            throw new Error('í˜„ì¬ ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
        }
        
        window.liveChatId = liveDetails.activeLiveChatId;
        localStorage.setItem('youtube_video_id', videoId);
        
        showStatus('âœ… ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        if (typeof updateChatbotStatus === 'function') {
            updateChatbotStatus();
        }
        
    } catch (error) {
        console.error('ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube API ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë³´ì„¸ìš”.';
            } else if (apiError.code === 404) {
                errorMessage = 'ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨: ${errorMessage}`, 'error');
    }
}

// OAuth ë°©ì‹ìœ¼ë¡œ YouTube ì±„íŒ…ì— ë©”ì‹œì§€ ì „ì†¡
async function sendToYouTubeOAuth() {
    if (!isSignedIn) {
        showStatus('Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    if (!window.liveChatId) {
        showStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ…ì— ì—°ê²°í•˜ì„¸ìš”', 'error');
        return;
    }
    
    try {
        const message = document.getElementById('live-summary').textContent;
        if (!message.trim()) {
            showStatus('ì „ì†¡í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
            return;
        }
        
        showStatus('YouTube ì±„íŒ…ì— ì „ì†¡ ì¤‘...', 'info');
        
        // OAuth í† í°ìœ¼ë¡œ ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
        const response = await gapi.client.youtube.liveChatMessages.insert({
            part: 'snippet',
            resource: {
                snippet: {
                    liveChatId: window.liveChatId,
                    type: 'textMessageEvent',
                    textMessageDetails: {
                        messageText: message
                    }
                }
            }
        });
        
        if (response.status === 200) {
            showStatus('âœ… YouTube ì±„íŒ…ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('YouTube ì „ì†¡ ì‹¤íŒ¨:', error);
        let errorMessage = error.message;
        
        // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
        if (error.result && error.result.error) {
            const apiError = error.result.error;
            if (apiError.code === 403) {
                errorMessage = 'YouTube ì±„íŒ… ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì±„ë„ ì†Œìœ ìì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
            } else if (apiError.code === 400) {
                errorMessage = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ì±„íŒ… IDë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.';
            } else {
                errorMessage = `YouTube API ì˜¤ë¥˜ (${apiError.code}): ${apiError.message}`;
            }
        }
        
        showStatus(`YouTube ì „ì†¡ ì‹¤íŒ¨: ${errorMessage}`, 'error');
    }
}

// Google ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
async function signInGoogle() {
    try {
        if (!authInstance) {
            showStatus('Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        showStatus('Google ë¡œê·¸ì¸ ì¤‘...', 'info');
        await authInstance.signIn();
        showStatus('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        
    } catch (error) {
        console.error('Google ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
        showStatus(`Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.error || error.message}`, 'error');
    }
}

async function signOutGoogle() {
    try {
        if (!authInstance) {
            showStatus('Google APIê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
            return;
        }
        
        await authInstance.signOut();
        showStatus('Google ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        
    } catch (error) {
        console.error('Google ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        showStatus(`Google ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// Google ë¡œê·¸ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateGoogleStatus() {
    const statusElement = document.getElementById('chatbot-status');
    if (isSignedIn) {
        statusElement.className = 'status status-success';
        statusElement.innerHTML = 'âœ… <strong>Google ë¡œê·¸ì¸ë¨</strong>: YouTube APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! <button onclick="signOutGoogle()" class="btn btn-secondary" style="margin-left:10px;">ë¡œê·¸ì•„ì›ƒ</button>';
    } else {
        statusElement.className = 'status status-warning';
        statusElement.innerHTML = 'ğŸ” <strong>Google ë¡œê·¸ì¸ í•„ìš”</strong>: YouTube API ì‚¬ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”. <button onclick="signInGoogle()" class="btn btn-primary" style="margin-left:10px;">ë¡œê·¸ì¸</button>';
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', async () => {
    await initGoogleAPI();
});

// ê¸°ì¡´ í•¨ìˆ˜ë“¤ì„ OAuth ë²„ì „ìœ¼ë¡œ êµì²´
window.testApiKey = testYouTubeOAuth;
window.connectToLiveChat = connectToLiveChatOAuth;
window.sendToYouTube = sendToYouTubeOAuth;

</script>
</body>
</html>