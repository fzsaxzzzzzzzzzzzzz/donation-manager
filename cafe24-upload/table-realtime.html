<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}

.overlay-container {
    position: relative;
    margin: 20px auto;
    max-width: 800px;
    width: calc(100vw - 40px);
    min-width: 400px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease-in-out;
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 6px);
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 8px;
    text-align: center;
}

.update-time {
    text-align: center;
    font-size: calc(var(--table-font-size, 14px) - 2px);
    color: rgba(255,255,255,0.7);
    margin-bottom: 10px;
    text-shadow: 1px 1px 0 #000000;
}

.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    transition: background-color 0.3s ease;
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

.streamer-table tr.highlighted {
    background: rgba(255, 215, 0, 0.2);
    animation: highlight 2s ease-out;
}

@keyframes highlight {
    0% { background: rgba(255, 215, 0, 0.4); }
    100% { background: rgba(255, 215, 0, 0.1); }
}

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
}

.donation-count {
    font-size: calc(var(--table-font-size, 14px) - 1px);
    opacity: 0.9;
}

.total-summary {
    text-align: center;
    font-size: calc(var(--table-font-size, 14px) + 2px);
    font-weight: bold;
    color: #FFD700;
    background: rgba(255,215,0,0.1);
    padding: 10px;
    border-radius: 8px;
    border: 2px solid #FFD700;
    margin-bottom: 15px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.info-text {
    font-size: calc(var(--table-font-size, 14px) - 2px);
    color: rgba(255,255,255,0.7);
    margin-bottom: 10px;
    text-align: center;
    text-shadow: 1px 1px 0 #000000;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255,255,255,0.7);
    font-size: calc(var(--table-font-size, 14px) + 2px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="section-title" id="tableTitle">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</div>
    
    <div class="update-time" id="updateTime" style="display: none;">
        ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span>
    </div>
    
    <div class="total-summary" id="totalSummary" style="display: none;">
        ì´ í›„ì›ì•¡: â‚©0 (0ê±´)
    </div>
    
    <table class="streamer-table" id="streamerTable">
        <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                <th>í›„ì›ì•¡</th>
                <th>í›„ì› ê±´ìˆ˜</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="4" class="no-data">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</td>
            </tr>
        </tbody>
    </table>
    
    <div class="info-text">ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</div>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class RealtimeStreamerTable {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        this.previousStreamerTotals = new Map();
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('ì‹¤ì‹œê°„ ì„œë²„ì— ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderStreamerTable();
        });

        this.socket.on('dataUpdate', (data) => {
            const previousData = this.data;
            this.data = data;
            this.renderStreamerTable(previousData);
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderStreamerTable();
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS ë³€ìˆ˜ ì„¤ì •
        root.style.setProperty('--table-font-size', (this.settings['table-font-size'] || 14) + 'px');
        root.style.setProperty('--table-number-size', this.settings['table-number-size'] || 16);
        root.style.setProperty('--table-text-color', this.settings['table-text-color'] || 'white');
        root.style.setProperty('--table-opacity', this.settings['table-opacity'] || 85);

        // í…Œì´ë¸” ì œëª©
        const titleElement = document.getElementById('tableTitle');
        titleElement.textContent = this.settings['table-title'] || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
        
        // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ ì—¬ë¶€
        const showUpdateTime = this.settings['show-update-time'] === 'true';
        document.getElementById('updateTime').style.display = showUpdateTime ? 'block' : 'none';
        
        // ì´í•© í–‰ í‘œì‹œ ì—¬ë¶€
        const showTotalRow = this.settings['show-total-row'] === 'true';
        document.getElementById('totalSummary').style.display = showTotalRow ? 'block' : 'none';
    }

    renderStreamerTable(previousData = null) {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í†µê³„ ê³„ì‚°
        const streamerStats = this.calculateStreamerStats();
        
        if (streamerStats.length === 0) {
            this.showNoData();
            return;
        }

        // ìˆ¨ê²¨ì§„ ìŠ¤íŠ¸ë¦¬ë¨¸ í•„í„°ë§
        const hiddenStreamers = this.getHiddenStreamers();
        const visibleStats = streamerStats.filter(stat => 
            !hiddenStreamers.includes(stat.streamer)
        );

        // ì´ì „ ë°ì´í„°ì™€ ë¹„êµí•´ì„œ ë³€ê²½ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ ê°ì§€
        const changedStreamers = this.detectChangedStreamers(previousData, streamerStats);
        
        this.displayStreamerTable(visibleStats, changedStreamers);
        this.updateSummary(visibleStats);
        this.updateLastUpdate();
    }

    calculateStreamerStats() {
        const stats = new Map();
        
        // ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ˆê¸°í™”
        this.data.streamers.forEach(streamer => {
            stats.set(streamer, { total: 0, count: 0, donations: [] });
        });
        
        // í›„ì› ë°ì´í„° ì§‘ê³„
        this.data.donations.forEach(donation => {
            if (stats.has(donation.streamer)) {
                const stat = stats.get(donation.streamer);
                stat.total += donation.amount;
                stat.count += 1;
                stat.donations.push(donation);
            }
        });

        // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  í›„ì›ì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
        const result = Array.from(stats.entries())
            .map(([streamer, stat]) => ({
                streamer,
                total: stat.total,
                count: stat.count,
                emoji: this.data.emojis?.[streamer] || ''
            }))
            .sort((a, b) => b.total - a.total);
        
        return result;
    }

    getHiddenStreamers() {
        try {
            return JSON.parse(this.settings['hidden-streamers'] || '[]');
        } catch {
            return [];
        }
    }

    detectChangedStreamers(previousData, currentStats) {
        if (!previousData || !previousData.donations) return new Set();
        
        const changedStreamers = new Set();
        const previousTotals = new Map();
        
        // ì´ì „ ë°ì´í„°ì˜ ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡ ê³„ì‚°
        const prevStats = new Map();
        if (previousData.streamers) {
            previousData.streamers.forEach(streamer => {
                prevStats.set(streamer, 0);
            });
        }
        
        if (previousData.donations) {
            previousData.donations.forEach(donation => {
                if (prevStats.has(donation.streamer)) {
                    prevStats.set(donation.streamer, 
                        prevStats.get(donation.streamer) + donation.amount);
                }
            });
        }
        
        // í˜„ì¬ì™€ ì´ì „ ë¹„êµ
        currentStats.forEach(stat => {
            const previousTotal = prevStats.get(stat.streamer) || 0;
            if (stat.total !== previousTotal) {
                changedStreamers.add(stat.streamer);
            }
        });
        
        return changedStreamers;
    }

    displayStreamerTable(streamerStats, changedStreamers) {
        const tbody = document.getElementById('streamerTableBody');
        
        if (streamerStats.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="no-data">í‘œì‹œí•  ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        let html = '';
        streamerStats.forEach((stat, index) => {
            const rank = index + 1;
            const isChanged = changedStreamers.has(stat.streamer);
            const highlightClass = isChanged ? ' highlighted' : '';
            const rankClass = ` rank-${rank <= 3 ? rank : 'other'}`;
            
            html += `<tr class="${highlightClass}${rankClass}">`;
            html += `<td><span class="rank-number">${rank}</span></td>`;
            html += `<td class="streamer-name">${stat.emoji} ${stat.streamer}</td>`;
            html += `<td class="amount">â‚©${stat.total.toLocaleString()}</td>`;
            html += `<td class="donation-count">${stat.count}ê±´</td>`;
            html += `</tr>`;
        });
        
        tbody.innerHTML = html;
    }

    updateSummary(streamerStats) {
        if (this.settings['show-total-row'] === 'true') {
            const totalAmount = streamerStats.reduce((sum, stat) => sum + stat.total, 0);
            const totalCount = streamerStats.reduce((sum, stat) => sum + stat.count, 0);
            
            document.getElementById('totalSummary').innerHTML = 
                `ì´ í›„ì›ì•¡: <strong>â‚©${totalAmount.toLocaleString()}</strong> (${totalCount}ê±´)`;
        }
    }

    updateLastUpdate() {
        if (this.settings['show-update-time'] === 'true' && this.data?.lastUpdated) {
            document.getElementById('lastUpdate').textContent = 
                new Date(this.data.lastUpdated).toLocaleTimeString('ko-KR');
        }
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        
        document.getElementById('totalSummary').innerHTML = 'ì´ í›„ì›ì•¡: â‚©0 (0ê±´)';
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤...</td></tr>';
    }
}

// URL íŒŒë¼ë¯¸í„° í™•ì¸ (í…ŒìŠ¤íŠ¸ìš©)
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    // í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™•ì¸
    const testMode = getUrlParameter('test') === '1';
    if (testMode) {
        console.log('í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
    }
    
    window.streamerTable = new RealtimeStreamerTable();
});

// OBSì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ ì œê³µ
window.refreshTable = () => {
    if (window.streamerTable && window.streamerTable.data) {
        window.streamerTable.renderStreamerTable();
    }
};
</script>

</body>
</html>