<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth í…ŒìŠ¤íŠ¸ - ê°„ë‹¨ ë²„ì „</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 30px; 
            background: #f5f5f5; 
            max-width: 800px;
            margin: 0 auto;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            font-weight: 500;
        }
        .status-info { background: #e7f3ff; color: #185a9d; border: 1px solid #cbe3ff; }
        .status-success { background: #e9f6ec; color: #348a47; border: 1px solid #cce8d2; }
        .status-error { background: #fde9e9; color: #a52828; border: 1px solid #f8d0d1; }
        .status-warning { background: #fffbe6; color: #664d03; border: 1px solid #ffe58f; }
        .btn { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.9; }
        .form-group { margin: 15px 0; }
        .form-input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px;
        }
        .message-box { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 6px; 
            font-family: monospace; 
            white-space: pre-wrap; 
            min-height: 60px;
            margin: 15px 0;
        }
        h1 { color: #333; margin-bottom: 10px; }
        h2 { color: #555; margin: 25px 0 15px 0; }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ YouTube OAuth í…ŒìŠ¤íŠ¸</h1>
        
        <div class="warning-box">
            <strong>âš ï¸ ì¤‘ìš”:</strong> ì´ í˜ì´ì§€ëŠ” ë°˜ë“œì‹œ <code>http://localhost</code>ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.<br>
            <code>file://</code> í”„ë¡œí† ì½œì—ì„œëŠ” OAuthê°€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        
        <div id="auth-status" class="status status-warning">
            ğŸ”„ ì´ˆê¸°í™” ì¤‘...
        </div>
        
        <h2>1ï¸âƒ£ ì¸ì¦ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="signInOAuth()" class="btn btn-primary">OAuth ë¡œê·¸ì¸</button>
        <button onclick="signOutOAuth()" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
        <button onclick="testAPI()" class="btn btn-success">YouTube API í…ŒìŠ¤íŠ¸</button>
        
        <h2>2ï¸âƒ£ ë¼ì´ë¸Œ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
        <div class="form-group">
            <input type="text" id="video-id" placeholder="YouTube ì˜ìƒ ID (ì˜ˆ: dQw4w9WgXcQ)" class="form-input">
            <button onclick="connectChat()" class="btn btn-primary">ì±„íŒ… ì—°ê²°</button>
        </div>
        
        <div class="form-group">
            <input type="text" id="test-message" placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€" class="form-input">
            <button onclick="sendMessage()" class="btn btn-success">ì±„íŒ… ì „ì†¡</button>
        </div>
        
        <div class="message-box" id="log">
ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = '493287022430-4mmnh4stu22p13lr0sjgvpg0nbkouova.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBz5aGfiAQCrfi0ccydGypD0leYjLUt4t4';
        
        let tokenClient;
        let isOAuthSignedIn = false;
        let liveChatId = '';
        
        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('auth-status');
            statusEl.className = `status status-${type}`;
            statusEl.textContent = message;
            log(`ìƒíƒœ: ${message}`);
        }
        
        // GIS OAuth ì´ˆê¸°í™”
        async function initOAuth() {
            try {
                log('=== OAuth ì´ˆê¸°í™” ì‹œì‘ ===');
                
                // 1) gapi client ì´ˆê¸°í™”
                await new Promise((resolve) => gapi.load('client', resolve));
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest']
                });
                
                // 2) GIS í† í° í´ë¼ì´ì–¸íŠ¸ ì¤€ë¹„
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.force-ssl',
                    callback: (response) => {
                        if (response && response.access_token) {
                            gapi.client.setToken({ access_token: response.access_token });
                            isOAuthSignedIn = true;
                            updateStatus('âœ… OAuth ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                            log(`í† í°: ${response.access_token.substring(0, 20)}...`);
                        } else {
                            updateStatus('âŒ OAuth í† í° íšë“ ì‹¤íŒ¨', 'error');
                        }
                    }
                });
                
                updateStatus('â³ OAuth ì¤€ë¹„ ì™„ë£Œ - ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­', 'warning');
                log('OAuth ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                log(`OAuth ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                updateStatus('âŒ OAuth ì´ˆê¸°í™” ì‹¤íŒ¨', 'error');
            }
        }
        
        function signInOAuth() {
            if (!tokenClient) {
                updateStatus('OAuth ì´ˆê¸°í™” ì•ˆë¨', 'error');
                return;
            }
            log('OAuth ë¡œê·¸ì¸ ì‹œë„...');
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function signOutOAuth() {
            const token = gapi.client.getToken();
            if (token && token.access_token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    isOAuthSignedIn = false;
                    liveChatId = '';
                    updateStatus('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
                });
            }
        }
        
        async function testAPI() {
            if (!isOAuthSignedIn) {
                updateStatus('ë¨¼ì € OAuth ë¡œê·¸ì¸ í•„ìš”', 'error');
                return;
            }
            
            try {
                log('YouTube API í…ŒìŠ¤íŠ¸ ì¤‘...');
                const response = await gapi.client.youtube.search.list({
                    part: 'snippet',
                    q: 'test',
                    maxResults: 1,
                    type: 'video'
                });
                
                log(`API í…ŒìŠ¤íŠ¸ ì„±ê³µ! ê²°ê³¼: ${response.result.items.length}ê°œ`);
                updateStatus('âœ… YouTube API ì—°ê²° ì„±ê³µ!', 'success');
                
            } catch (error) {
                log(`API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                updateStatus('âŒ YouTube API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨', 'error');
            }
        }
        
        async function connectChat() {
            if (!isOAuthSignedIn) {
                updateStatus('ë¨¼ì € OAuth ë¡œê·¸ì¸ í•„ìš”', 'error');
                return;
            }
            
            const videoId = document.getElementById('video-id').value.trim();
            if (!videoId) {
                updateStatus('ì˜ìƒ ID ì…ë ¥ í•„ìš”', 'error');
                return;
            }
            
            try {
                log(`ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹œë„: ${videoId}`);
                const resp = await gapi.client.youtube.videos.list({
                    part: 'liveStreamingDetails',
                    id: videoId
                });
                
                const item = resp.result.items?.[0];
                const liveDetails = item?.liveStreamingDetails;
                
                if (!liveDetails?.activeLiveChatId) {
                    throw new Error('ë¼ì´ë¸Œ ë°©ì†¡ì´ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ…ì´ ë¹„í™œì„±í™”ë¨');
                }
                
                liveChatId = liveDetails.activeLiveChatId;
                log(`ë¼ì´ë¸Œ ì±„íŒ… ID: ${liveChatId}`);
                updateStatus('âœ… ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì„±ê³µ!', 'success');
                
            } catch (error) {
                log(`ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                updateStatus('âŒ ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° ì‹¤íŒ¨', 'error');
            }
        }
        
        async function sendMessage() {
            const message = document.getElementById('test-message').value.trim();
            if (!message) {
                updateStatus('ë©”ì‹œì§€ ì…ë ¥ í•„ìš”', 'error');
                return;
            }
            
            if (!isOAuthSignedIn) {
                updateStatus('ë¨¼ì € OAuth ë¡œê·¸ì¸ í•„ìš”', 'error');
                return;
            }
            
            if (!liveChatId) {
                updateStatus('ë¨¼ì € ë¼ì´ë¸Œ ì±„íŒ… ì—°ê²° í•„ìš”', 'error');
                return;
            }
            
            try {
                log(`ë©”ì‹œì§€ ì „ì†¡ ì‹œë„: "${message}"`);
                await gapi.client.youtube.liveChatMessages.insert({
                    part: 'snippet',
                    resource: {
                        snippet: {
                            liveChatId,
                            type: 'textMessageEvent',
                            textMessageDetails: { messageText: message }
                        }
                    }
                });
                
                log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!');
                updateStatus('âœ… ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ!', 'success');
                document.getElementById('test-message').value = '';
                
            } catch (error) {
                log(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${error.result?.error?.message || error.message}`);
                updateStatus('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', 'error');
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            log('=== í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ===');
            log(`í˜„ì¬ URL: ${window.location.href}`);
            
            if (window.location.protocol === 'file:') {
                updateStatus('âŒ file:// í”„ë¡œí† ì½œ ê°ì§€ - http://localhostì—ì„œ ì‹¤í–‰ í•„ìš”', 'error');
                log('ê²½ê³ : OAuthëŠ” file:// í”„ë¡œí† ì½œì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
            } else {
                initOAuth();
            }
        });
    </script>
</body>
</html>