<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“± ëª¨ë°”ì¼ ì „ìš© í›„ì›ì ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
    /* ëª¨ë°”ì¼ ìµœì í™”: í•˜ë“œì›¨ì–´ ê°€ì† ë¹„í™œì„±í™” */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    will-change: auto;
}

.overlay-container {
    background: transparent;
    max-width: 100vw;
    width: 100%;
    /* ëª¨ë°”ì¼ ìµœì í™”: ë¶ˆí•„ìš”í•œ íš¨ê³¼ ì œê±° */
    box-shadow: none;
    backdrop-filter: none;
    border: none;
}

.donor-content {
    font-size: var(--overlay-font-size, 16px) !important;
    font-weight: bold;
    color: white;
    text-shadow: var(--overlay-text-shadow, 2px 2px 0 #000000, -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000) !important;
    line-height: var(--overlay-line-height, 1.4);
    white-space: pre-line;
    padding: 0;
    text-align: var(--overlay-text-align, left) !important;
    /* ëª¨ë°”ì¼ ìµœì í™”: ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ì œê±° */
    transition: none;
    animation: none;
}

.no-data {
    font-size: var(--overlay-font-size, 18px) !important;
    font-weight: bold;
    color: white !important;
    text-shadow: var(--overlay-text-shadow, 2px 2px 0 #000000, -2px -2px 0 #000000) !important;
    text-align: var(--overlay-text-align, center) !important;
    padding: 20px;
    /* ëª¨ë°”ì¼ ìµœì í™”: ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    animation: none;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 14px;
    /* ëª¨ë°”ì¼ ìµœì í™”: í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ì œê±° */
    animation: none;
}

/* ì¹´ì¹´ì˜¤ë±…í¬ ì „ìš© ìŠ¤íƒ€ì¼ - ëª¨ë°”ì¼ ìµœì í™” */
.kakao-bank-info {
    margin: 0 !important;
    padding: 0 !important;
    display: block !important;
}

.kakao-bank-info div {
    margin: 0 !important;
    padding: 0 !important;
    font-weight: bold !important;
    color: #FFEB3B !important;
}

/* í›„ì›ì í•­ëª© - ë¦¬ìŠ¤íŠ¸ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
.donor-item {
    display: inline-block;
    white-space: nowrap;
    margin-right: 0.5em;
}

/* ëª¨ë°”ì¼ ìµœì í™”: ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
* {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    filter: none !important;
    backdrop-filter: none !important;
}

/* ë°°í„°ë¦¬ ì ˆì•½: GPU ê°€ì† ë¹„í™œì„±í™” */
*,
*::before,
*::after {
    will-change: auto;
    transform: none;
    -webkit-transform: none;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì› - ëª¨ë°”ì¼ ìµœì í™” */
.transparent-mode {
    background: #00FF00;
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="loading">ëª¨ë°”ì¼ ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<script>
class MobileDonorOverlay {
    constructor() {
        console.log('ğŸ“± ëª¨ë°”ì¼ ì „ìš© í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘');
        
        // ëª¨ë°”ì¼ ê°ì§€
        this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!this.isMobile) {
            console.warn('âš ï¸ ì´ ì˜¤ë²„ë ˆì´ëŠ” ëª¨ë°”ì¼ ì „ìš©ì…ë‹ˆë‹¤');
        }
        
        this.socket = io();
        this.donations = [];
        this.settings = {
            'overlay-font-size': 16,
            'overlay-stroke-width': 2,
            'overlay-text-align': 'left',
            'includeSuperchat': localStorage.getItem('include-superchat') === 'true'
        };
        this.isConnected = false;
        
        // ë°°í„°ë¦¬ ì ˆì•½ ëª¨ë“œ í™œì„±í™”
        this.enableBatterySaving();
        this.initializeSocket();
        this.setupKeyboardControls();
    }
    
    enableBatterySaving() {
        // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ìµœì†Œí™”
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ğŸ“± ì•±ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™ - ì ˆì „ ëª¨ë“œ');
                // ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” ì—…ë°ì´íŠ¸ ë¹ˆë„ ì¤„ì´ê¸°
                this.batterySaveMode = true;
            } else {
                console.log('ğŸ“± ì•±ì´ í¬ê·¸ë¼ìš´ë“œë¡œ ë³µê·€');
                this.batterySaveMode = false;
                this.updateDisplay(); // ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            }
        });
        
        // ë¶ˆí•„ìš”í•œ DOM ì¡°ì‘ ìµœì†Œí™”
        this.updateThrottle = false;
    }
    
    initializeSocket() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            console.log('ğŸ”— ëª¨ë°”ì¼ ì„œë²„ ì—°ê²°ë¨');
        });
        
        this.socket.on('disconnect', () => {
            this.isConnected = false;
            console.log('âŒ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            this.showError('ì„œë²„ ì—°ê²° ëŠì–´ì§');
        });
        
        this.socket.on('initialData', (data) => {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            this.donations = data.donations || [];
            this.settings = { ...this.settings, ...(data.settings || {}) };
            this.applySettings();
            this.updateDisplay();
        });
        
        this.socket.on('dataUpdate', (data) => {
            // ë°°í„°ë¦¬ ì ˆì•½: ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” ì—…ë°ì´íŠ¸ ìŠ¤í‚µ
            if (this.batterySaveMode) {
                console.log('ğŸ“± ì ˆì „ ëª¨ë“œ: ì—…ë°ì´íŠ¸ ìŠ¤í‚µ');
                return;
            }
            
            console.log('ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
            this.donations = data.donations || [];
            
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            
            this.throttledUpdate();
        });
        
        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
            this.settings = { ...this.settings, ...settings };
            this.applySettings();
            this.updateDisplay();
        });
    }
    
    // ë°°í„°ë¦¬ ì ˆì•½: ì—…ë°ì´íŠ¸ ì“°ë¡œí‹€ë§
    throttledUpdate() {
        if (this.updateThrottle) return;
        
        this.updateThrottle = true;
        requestAnimationFrame(() => {
            this.updateDisplay();
            this.updateThrottle = false;
        });
    }
    
    // ë‘êº¼ìš´ ì™¸ê³½ì„ ì—ì„œë„ ê¹¨ì§€ì§€ ì•ŠëŠ” text-shadow ìƒì„± í•¨ìˆ˜
    generateTextShadow(maxWidth, color = '#000000') {
        const shadows = [];
        const width = Math.ceil(maxWidth);

        // 1pxë¶€í„° maxWidthê¹Œì§€ ëª¨ë“  ë ˆì´ì–´ì— ì´˜ì´˜í•˜ê²Œ shadow ìƒì„±
        for (let i = 1; i <= width; i++) {
            // 8ë°©í–¥ shadow
            shadows.push(`${i}px 0 0 ${color}`);
            shadows.push(`-${i}px 0 0 ${color}`);
            shadows.push(`0 ${i}px 0 ${color}`);
            shadows.push(`0 -${i}px 0 ${color}`);
            shadows.push(`${i}px ${i}px 0 ${color}`);
            shadows.push(`-${i}px -${i}px 0 ${color}`);
            shadows.push(`${i}px -${i}px 0 ${color}`);
            shadows.push(`-${i}px ${i}px 0 ${color}`);
        }

        return shadows.join(', ');
    }

    applySettings() {
        const root = document.documentElement;
        const fontSize = parseInt(this.settings['overlay-font-size']) || 16;
        const strokeWidth = parseFloat(this.settings['overlay-stroke-width']) || 2;
        const textAlign = this.settings['overlay-text-align'] || 'left';
        const lineHeight = parseFloat(this.settings['overlay-line-height']) || 1.4;

        root.style.setProperty('--overlay-font-size', fontSize + 'px');
        root.style.setProperty('--overlay-text-align', textAlign);
        root.style.setProperty('--overlay-line-height', lineHeight);
        root.style.setProperty('--overlay-text-shadow', this.generateTextShadow(strokeWidth));

        console.log('ğŸ”§ ëª¨ë°”ì¼ ì„¤ì • ì ìš©:', { fontSize, strokeWidth, textAlign, lineHeight });
    }
    
    updateDisplay() {
        const contentEl = document.getElementById('donor-content');
        
        // ğŸ”¥ ì¹´ì¹´ì˜¤ë±…í¬ ê³„ì¢Œ ì •ë³´ í‘œì‹œ - í•­ìƒ trueë¡œ ê°•ì œ ì„¤ì •
        const showKakaoBank = true;
        const kakaoBankSize = this.settings.kakaoBankSize || 18;
        
        if (!this.donations || this.donations.length === 0) {
            let content = '';
            
            if (showKakaoBank) {
                const kakaoBankHtml = `<div class="kakao-bank-info" style="font-size: ${kakaoBankSize}px;">
                    <div>ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O</div>
                </div>`;
                contentEl.innerHTML = kakaoBankHtml + '<div class="donor-text">' + content + '</div>';
            } else {
                contentEl.textContent = content;
            }
            
            contentEl.className = 'no-data';
            return;
        }
        
        // í›„ì›ìë³„ ì´ì•¡ ê³„ì‚° (ìµœì í™”ëœ ë¡œì§)
        const donorAccountTotals = {};
        const includeSuperchat = this.settings.includeSuperchat !== undefined ? 
            this.settings.includeSuperchat : (localStorage.getItem('include-superchat') === 'true');
            
        this.donations.forEach(d => {
            const amount = parseFloat(d.amount) || 0;
            
            // ğŸ”¥ íˆ¬ë„¤ì´ì…˜ íƒ€ì…ì€ ë¬´ì¡°ê±´ ì œì™¸
            if (d.type === 'íˆ¬ë„¤ì´ì…˜') {
                console.log(`ğŸ“±ğŸš« íˆ¬ë„¤ì´ì…˜ ì œì™¸: ${d.donor}ë‹˜ ${amount}ë§Œì›`);
                return;
            }
            
            const shouldInclude = d.type === 'ê³„ì¢Œ' || (includeSuperchat && d.type === 'ìŠˆí¼ì±—');
            
            if (shouldInclude && amount > 0) {
                if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                    return; // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ì œì™¸
                }
                
                let cleanDonorName = d.donor.replace(/\(ì¡°ì •[^)]*\)/g, '');
                if (cleanDonorName === 'ê³„ì¢Œí›„ì›ìë‹˜' || cleanDonorName === 'ê³„ì¢Œí›„ì›ì') {
                    cleanDonorName = 'ê³„ì¢Œí›„ì›ìë‹˜';
                }
                
                donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
            }
        });

        const groupThreshold = this.settings.groupThreshold || parseInt(localStorage.getItem('group-threshold') || '2');
        
        // ê¸ˆì•¡ë³„ ê·¸ë£¹í™” (ìµœì í™”)
        const amountGroups = {};
        Object.entries(donorAccountTotals).forEach(([donor, amount]) => {
            if (amount >= 0.1) { // 0.1ë§Œì› ì´ìƒë§Œ
                if (!amountGroups[amount]) amountGroups[amount] = [];
                amountGroups[amount].push(donor);
            }
        });

        const sortedGroups = Object.entries(amountGroups).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
        
        if (sortedGroups.length === 0) {
            contentEl.textContent = '';
            contentEl.className = 'no-data';
            return;
        }
        
        // ë¦¬ìŠ¤íŠ¸ ë‹¨ìœ„ ì¤„ë°”ê¿ˆì„ ìœ„í•´ ê° í•­ëª©ì„ spanìœ¼ë¡œ ê°ì‹¸ê¸°
        const donorItems = [];
        sortedGroups.forEach(([amount, donors]) => {
            const num = parseFloat(amount);
            const amountStr = `${num % 1 === 0 ? Math.floor(num).toString() : num.toFixed(1)}`;
            if (donors.length >= groupThreshold) {
                // ê·¸ë£¹í™”ëœ í›„ì›ìë“¤ì€ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ
                donorItems.push(`<span class="donor-item">${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}</span>`);
            } else {
                // ê°œë³„ í›„ì›ìëŠ” ê°ê° í•­ëª©ìœ¼ë¡œ
                donors.forEach(d => {
                    donorItems.push(`<span class="donor-item">${d}ë‹˜ ${amountStr}</span>`);
                });
            }
        });
        const donorTotalText = donorItems.join(' ');
        
        let finalText = donorTotalText || '';
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ ì¶”ê°€
        if (showKakaoBank) {
            const kakaoBankHtml = `<div class="kakao-bank-info" style="font-size: ${kakaoBankSize}px;">
                <div>ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O</div>
            </div>`;
            contentEl.innerHTML = kakaoBankHtml + '<div class="donor-text">' + finalText + '</div>';
        } else {
            contentEl.innerHTML = '<div>' + finalText + '</div>';
        }
        contentEl.className = 'donor-content';
        
        console.log('ğŸ“± ëª¨ë°”ì¼ í™”ë©´ ì—…ë°ì´íŠ¸:', sortedGroups.length, 'ê°œ ê·¸ë£¹');
    }
    
    showError(message) {
        const contentEl = document.getElementById('donor-content');
        contentEl.textContent = message;
        contentEl.className = 'no-data';
        contentEl.style.color = '#ffcccb';
    }
    
    setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '1':
                        this.settings['overlay-text-align'] = 'left';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“± ì •ë ¬: ì™¼ìª½');
                        break;
                    case '2':
                        this.settings['overlay-text-align'] = 'center';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“± ì •ë ¬: ê°€ìš´ë°');
                        break;
                    case '3':
                        this.settings['overlay-text-align'] = 'right';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“± ì •ë ¬: ì˜¤ë¥¸ìª½');
                        break;
                    case '=':
                        this.settings['overlay-font-size'] = Math.min(40, (this.settings['overlay-font-size'] || 16) + 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“± í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                    case '-':
                        this.settings['overlay-font-size'] = Math.max(8, (this.settings['overlay-font-size'] || 16) - 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“± í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                }
                e.preventDefault();
            }
        });
    }
    
    // ğŸ”¥ ì¹´ì¹´ì˜¤ë±…í¬ ê°•ì œ ë³´í˜¸ - ì ˆëŒ€ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ê°ì‹œ  
    forceKakaoBankProtection() {
        const contentEl = document.getElementById('donor-content');
        if (!contentEl) return;
        
        const currentHTML = contentEl.innerHTML;
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ê°€ ì—†ìœ¼ë©´ ê°•ì œ ì¶”ê°€
        if (!currentHTML.includes('ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O')) {
            console.log('ğŸ“±ğŸš¨ ëª¨ë°”ì¼: ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ ì—†ìŒ ê°ì§€ - ê°•ì œ ë³µêµ¬');

            // ê¸°ì¡´ í…ìŠ¤íŠ¸ ë³´ì¡´í•˜ë©´ì„œ ì¹´ì¹´ì˜¤ë±…í¬ë§Œ ì¶”ê°€
            const existingText = contentEl.textContent || '';

            const kakaoBankHtml = `<div class="kakao-bank-info" style="font-size: 18px; font-weight: bold; color: #FFEB3B;">
                <div>ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O</div>
            </div>`;

            const cleanText = existingText.replace('ì¹´ì¹´ì˜¤ë±…í¬ 3333-25-7378436 ì—„ì‚¼O', '').trim() || '';
            
            // ì¹´ì¹´ì˜¤ë±…í¬ + ê¸°ì¡´ í…ìŠ¤íŠ¸ ì¡°í•©
            contentEl.innerHTML = kakaoBankHtml + '<div class="donor-text">' + cleanText + '</div>';
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ“± ëª¨ë°”ì¼ ì „ìš© í›„ì›ì ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”');
    const overlay = new MobileDonorOverlay();
    
    // ğŸ”¥ ì¹´ì¹´ì˜¤ë±…í¬ ê°•ì œ ë³´í˜¸ - 1ì´ˆë§ˆë‹¤ ê°ì‹œ
    setInterval(() => {
        overlay.forceKakaoBankProtection();
    }, 1000);
});
</script>

</body>
</html>