<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ í€ë”© ì˜¤ë²„ë ˆì´</title>
<script src="/socket.io/socket.io.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    padding: 15px;
    overflow: hidden;
}

.container {
    max-width: 450px;
}

.funding-card {
    background: transparent;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 12px;
    border: none;
}

.funding-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.funding-name {
    font-size: 22px;
    font-weight: bold;
    color: #fff;
    text-shadow:
        -2px -2px 0 #000, 2px -2px 0 #000,
        -2px 2px 0 #000, 2px 2px 0 #000,
        -2px 0 0 #000, 2px 0 0 #000,
        0 -2px 0 #000, 0 2px 0 #000;
}

.funding-stat {
    font-size: 20px;
    font-weight: bold;
    color: #4ade80;
    text-shadow:
        -2px -2px 0 #000, 2px -2px 0 #000,
        -2px 2px 0 #000, 2px 2px 0 #000,
        -1px 0 0 #000, 1px 0 0 #000,
        0 -1px 0 #000, 0 1px 0 #000;
}

.funding-stat.completed {
    color: #fbbf24;
}

.progress-bar {
    width: 100%;
    height: 28px;
    background: #333;
    border-radius: 14px;
    overflow: hidden;
    position: relative;
    border: 2px solid #555;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #4ade80, #86efac);
    border-radius: 12px;
    transition: width 0.5s ease;
}

.progress-fill.completed {
    background: linear-gradient(90deg, #f59e0b, #fbbf24, #fde047);
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 15px;
    font-weight: bold;
    color: #fff;
    text-shadow:
        -2px -2px 0 #000, 2px -2px 0 #000,
        -2px 2px 0 #000, 2px 2px 0 #000,
        -1px 0 0 #000, 1px 0 0 #000,
        0 -1px 0 #000, 0 1px 0 #000;
    white-space: nowrap;
    z-index: 10;
}

.progress-text.completed {
    color: #fff;
}

.funding-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    font-size: 16px;
    color: #ccc;
    text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px 1px 0 #000, 1px 1px 0 #000;
}

.funding-current {
    color: #4ade80;
    font-weight: bold;
}

.funding-target {
    color: #fff;
}

.no-funding {
    text-align: center;
    padding: 40px 20px;
    color: #888;
    font-size: 18px;
    text-shadow:
        -1px -1px 0 #000, 1px -1px 0 #000,
        -1px 1px 0 #000, 1px 1px 0 #000;
}

.title {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 15px;
    text-shadow:
        -2px -2px 0 #000, 2px -2px 0 #000,
        -2px 2px 0 #000, 2px 2px 0 #000,
        -2px 0 0 #000, 2px 0 0 #000,
        0 -2px 0 #000, 0 2px 0 #000;
}
</style>
</head>
<body>

<div class="container" id="container">
    <div class="title">ğŸ¯ í€ë”© í˜„í™©</div>
    <div class="no-funding" id="no-funding">ì§„í–‰ ì¤‘ì¸ í€ë”©ì´ ì—†ìŠµë‹ˆë‹¤</div>
    <div id="funding-list"></div>
</div>

<script>
class FundingOverlay {
    constructor() {
        this.socket = io();
        this.missions = [];
        this.donations = [];
        this.emojis = {};
        this.missionAdjustments = [];
        this.displayMode = 0; // 0: ê¸ˆì•¡+í¼ì„¼íŠ¸, 1: ë‚¨ì€ê¸ˆì•¡

        this.init();
        this.startTextSwitch();
    }

    startTextSwitch() {
        setInterval(() => {
            this.displayMode = (this.displayMode + 1) % 2;
            this.render();
        }, 3000); // 3ì´ˆë§ˆë‹¤ ì „í™˜
    }

    init() {
        this.socket.on('connect', () => {
            console.log('âœ… ì„œë²„ ì—°ê²°ë¨');
        });

        this.socket.on('initialData', (data) => {
            this.updateData(data);
        });

        this.socket.on('dataUpdate', (data) => {
            this.updateData(data);
        });
    }

    updateData(data) {
        this.missions = data.missions || data.runningMissions || [];
        this.donations = data.donations || [];
        this.emojis = data.emojis || {};
        this.missionAdjustments = data.missionAdjustments || [];

        this.render();
    }

    render() {
        const runningMissions = this.missions.filter(m =>
            m && (m.status === 'running' || m.status === 'completed')
        );

        const noFunding = document.getElementById('no-funding');
        const fundingList = document.getElementById('funding-list');

        if (runningMissions.length === 0) {
            noFunding.style.display = 'block';
            fundingList.innerHTML = '';
            return;
        }

        noFunding.style.display = 'none';

        const html = runningMissions.map(mission => {
            const target = parseFloat(mission.target) || 0;
            const initialAmount = parseFloat(mission.initialAmount) || 0;

            // ë¯¸ì…˜ ì‹œì‘ í›„ í›„ì› í•©ê³„
            const donationAmount = this.donations
                .filter(d => d.streamer === mission.streamer && new Date(d.time) >= new Date(mission.startTime))
                .reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);

            // ì¡°ì • ê¸ˆì•¡ í•©ê³„
            const adjustmentAmount = this.missionAdjustments
                .filter(adj => adj.streamer === mission.streamer && new Date(adj.time) >= new Date(mission.startTime))
                .reduce((sum, adj) => sum + (parseFloat(adj.amount) || 0), 0);

            const current = initialAmount + donationAmount + adjustmentAmount;
            const percent = target > 0 ? Math.min((current / target) * 100, 100) : 0;
            const isCompleted = percent >= 100 || mission.status === 'completed';
            const remaining = Math.max(target - current, 0);
            const emoji = this.emojis[mission.streamer] || '';

            // ì†Œìˆ˜ì  ì²˜ë¦¬
            const formatNum = (n) => n % 1 === 0 ? Math.floor(n) : n.toFixed(1);

            // ì „í™˜ ëª¨ë“œì— ë”°ë¥¸ í…ìŠ¤íŠ¸ (0: ê¸ˆì•¡+í¼ì„¼íŠ¸, 1: ë‚¨ì€ê¸ˆì•¡)
            let statsText = '';
            if (this.displayMode === 0) {
                statsText = `${formatNum(current)} / ${formatNum(target)}ë§Œì› (${Math.round(percent)}%)`;
            } else {
                statsText = isCompleted ? 'ğŸ‰ ëª©í‘œ ë‹¬ì„±!' : `${formatNum(remaining)}ë§Œì› ë‚¨ìŒ`;
            }

            return `
                <div class="funding-card">
                    <div class="funding-header">
                        <span class="funding-name">${emoji} ${mission.streamer} ${isCompleted ? 'ğŸ‰' : ''}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${isCompleted ? 'completed' : ''}" style="width: ${percent}%"></div>
                        <span class="progress-text ${isCompleted ? 'completed' : ''}">${statsText}</span>
                    </div>
                </div>
            `;
        }).join('');

        fundingList.innerHTML = html;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new FundingOverlay();
});
</script>
</body>
</html>
