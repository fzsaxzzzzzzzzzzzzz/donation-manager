<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„ë‹¨í•œ í›„ì› ê´€ë¦¬</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 500px;
        }
        
        .panel h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .streamer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .streamer-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .streamer-item input {
            width: 80px;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .status.success { background: #d4edda; color: #155724; display: block; }
        .status.error { background: #f8d7da; color: #721c24; display: block; }
        
        .donation-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .donation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .summary-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì²« ë²ˆì§¸ íŒ¨ë„: í›„ì› ë“±ë¡ -->
        <div class="panel">
            <h2>ğŸ’° í›„ì› ë“±ë¡</h2>
            
            <div class="form-group">
                <label class="form-label">í›„ì›ìëª…</label>
                <input type="text" id="donor-input" class="form-input" placeholder="í›„ì›ì ì´ë¦„">
            </div>
            
            <div class="form-group">
                <label class="form-label">í›„ì› íƒ€ì…</label>
                <div style="display: flex; gap: 15px; margin-top: 5px;">
                    <label><input type="radio" name="paytype" value="ê³„ì¢Œ" checked> ê³„ì¢Œ</label>
                    <label><input type="radio" name="paytype" value="íˆ¬ë„¤"> íˆ¬ë„¤</label>
                    <label><input type="radio" name="paytype" value="ìŠˆí¼ì±—"> ìŠˆí¼ì±—</label>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡(ë§Œì›)</label>
                <div class="streamer-grid" id="streamer-inputs">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
            
            <button onclick="addDonation()" class="btn btn-success" style="width: 100%;">âœ¨ í›„ì› ë“±ë¡</button>
            
            <div id="status" class="status"></div>
        </div>
        
        <!-- ë‘ ë²ˆì§¸ íŒ¨ë„: í›„ì› í˜„í™© -->
        <div class="panel">
            <h2>ğŸ“Š í›„ì› í˜„í™©</h2>
            
            <div class="summary-box" id="summary-output">
                ë¡œë”© ì¤‘...
            </div>
            
            <button onclick="copyToClipboard('summary-output')" class="btn btn-primary">ğŸ“‹ ë³µì‚¬</button>
            <button onclick="sendToChatbot()" class="btn btn-success">ğŸ“¤ ì±—ë´‡ ì „ì†¡</button>
            
            <div style="margin-top: 20px;">
                <h3>ğŸ„ í‡´ê·¼ë¯¸ì…˜</h3>
                <div class="summary-box" id="mission-output">
                    ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                <button onclick="sendMissionToChatbot()" class="btn btn-success">ğŸ“¤ ë¯¸ì…˜ ì „ì†¡</button>
            </div>
        </div>
        
        <!-- ì„¸ ë²ˆì§¸ íŒ¨ë„: í›„ì› ë‚´ì—­ -->
        <div class="panel">
            <h2>ğŸ“ í›„ì› ë‚´ì—­</h2>
            
            <button onclick="refreshData()" class="btn btn-primary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            
            <div class="donation-list" id="donation-list">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>
    </div>

    <script>
        let currentData = { donations: [], streamers: [], emojis: {} };
        let socket = null;
        
        // Socket.io ì—°ê²°
        function initializeSocket() {
            try {
                socket = io();
                socket.on('connect', () => {
                    console.log('âœ… ì„œë²„ ì—°ê²°ë¨');
                });
                
                socket.on('initialData', (data) => {
                    console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
                    currentData = data;
                    updateUI();
                });
                
                socket.on('dataUpdate', (data) => {
                    console.log('ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸:', data);
                    currentData = data;
                    updateUI();
                });
            } catch (error) {
                console.error('Socket ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                // ë°±ì—…: HTTPë¡œ ë°ì´í„° ë¡œë“œ
                loadDataHTTP();
            }
        }
        
        // HTTPë¡œ ë°ì´í„° ë¡œë“œ (ë°±ì—…)
        async function loadDataHTTP() {
            try {
                const response = await fetch('/api/data');
                currentData = await response.json();
                updateUI();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            updateStreamerInputs();
            updateSummary();
            updateDonationList();
        }
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ ì…ë ¥ í•„ë“œ ìƒì„±
        function updateStreamerInputs() {
            const container = document.getElementById('streamer-inputs');
            const streamers = currentData.streamers || [];
            const emojis = currentData.emojis || {};
            
            container.innerHTML = streamers.map(streamer => `
                <div class="streamer-item">
                    <span>${emojis[streamer] || ''}${streamer}</span>
                    <input type="number" id="amount-${streamer}" min="0" step="0.1" placeholder="0">
                </div>
            `).join('');
        }
        
        // ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateSummary() {
            const donations = currentData.donations || [];
            const streamers = currentData.streamers || [];
            const emojis = currentData.emojis || {};
            
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡ ê³„ì‚°
            const totals = {};
            let grandTotal = 0;
            
            donations.forEach(d => {
                if (d.excludeFromTotal || d.isMissionAdjustment) return;
                
                const amount = parseFloat(d.amount) || 0;
                if (streamers.includes(d.streamer)) {
                    totals[d.streamer] = (totals[d.streamer] || 0) + amount;
                } else {
                    totals['êµ­ê³ '] = (totals['êµ­ê³ '] || 0) + amount;
                }
                grandTotal += amount;
            });
            
            // ìš”ì•½ í…ìŠ¤íŠ¸ ìƒì„±
            const summaryParts = streamers.map(streamer => 
                `${emojis[streamer] || ''}${streamer}(${totals[streamer] || 0})`
            );
            
            const summary = `ğŸ”¥ì‚¼ìš©ìŠ¤ì¿¨ğŸ”¥ | ${summaryParts.join(' ')} | ğŸ’µì´í•©(${grandTotal})`;
            
            document.getElementById('summary-output').textContent = summary;
        }
        
        // í›„ì› ë‚´ì—­ ì—…ë°ì´íŠ¸
        function updateDonationList() {
            const donations = currentData.donations || [];
            const container = document.getElementById('donation-list');
            
            const html = donations.slice(0, 20).map((d, index) => `
                <div class="donation-item">
                    <div>
                        <strong>${d.donor}</strong> â†’ ${d.streamer} 
                        <span style="color: #666;">(${d.type})</span>
                    </div>
                    <div>
                        ${d.amount}ë§Œì›
                        <button onclick="deleteDonation('${d.time}')" class="btn btn-danger" style="padding: 2px 6px; font-size: 12px; margin-left: 10px;">ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html || '<div style="text-align: center; color: #666;">í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
        
        // í›„ì› ì¶”ê°€
        async function addDonation() {
            const donor = document.getElementById('donor-input').value.trim();
            const type = document.querySelector('input[name="paytype"]:checked').value;
            
            if (!donor) {
                showStatus('í›„ì›ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            const amounts = {};
            let totalAmount = 0;
            
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ê¸ˆì•¡ ìˆ˜ì§‘
            (currentData.streamers || []).forEach(streamer => {
                const input = document.getElementById(`amount-${streamer}`);
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    amounts[streamer] = amount;
                    totalAmount += amount;
                }
            });
            
            if (totalAmount === 0) {
                showStatus('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // ê° ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ë¡œ í›„ì› ë“±ë¡
            for (const [streamer, amount] of Object.entries(amounts)) {
                try {
                    const response = await fetch('/api/donations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ donor, streamer, type, amount })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    }
                } catch (error) {
                    showStatus(`${streamer} í›„ì› ë“±ë¡ ì‹¤íŒ¨: ${error.message}`, 'error');
                    return;
                }
            }
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('donor-input').value = '';
            document.querySelectorAll('#streamer-inputs input').forEach(input => input.value = '');
            
            showStatus('í›„ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        // í›„ì› ì‚­ì œ
        async function deleteDonation(donationId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                } else {
                    showStatus('ì‚­ì œ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showStatus('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // í´ë¦½ë³´ë“œ ë³µì‚¬
        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                showStatus('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            });
        }
        
        // ì±—ë´‡ ì „ì†¡ (ë”ë¯¸)
        function sendToChatbot() {
            const summary = document.getElementById('summary-output').textContent;
            console.log('ì±—ë´‡ìœ¼ë¡œ ì „ì†¡:', summary);
            showStatus('ì±—ë´‡ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        function sendMissionToChatbot() {
            showStatus('ë¯¸ì…˜ì´ ì±—ë´‡ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        function refreshData() {
            if (socket && socket.connected) {
                socket.emit('requestData');
            } else {
                loadDataHTTP();
            }
            showStatus('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!', 'success');
        }
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            initializeSocket();
        });
    </script>
</body>
</html>