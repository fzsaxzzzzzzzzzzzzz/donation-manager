<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎬 실시간 후원 시스템 - 통합 관리</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f5f6fa;
    color: #2c3e50;
    line-height: 1.6;
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.header h1 {
    font-size: 2rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.tabs-container {
    background: white;
    border-bottom: 3px solid #e9ecef;
    padding: 0 20px;
    overflow-x: auto;
    white-space: nowrap;
}

.tabs {
    display: flex;
    gap: 0;
    min-width: max-content;
}

.tab {
    padding: 15px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    color: #6c757d;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.tab:hover {
    color: #495057;
    background: #f8f9fa;
}

.tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
    background: #f8f9ff;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.grid-2 { grid-template-columns: 1fr 1fr; }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 768px) {
    .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
    }
}

.card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f8f9fa;
}

.card-header h3 {
    font-size: 1.3rem;
    color: #2c3e50;
    margin: 0;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.form-input, .form-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-range {
    width: 100%;
    margin: 10px 0;
}

.range-display {
    display: flex;
    align-items: center;
    gap: 10px;
}

.range-value {
    min-width: 50px;
    padding: 4px 8px;
    background: #e9ecef;
    border-radius: 4px;
    font-weight: 600;
    text-align: center;
    font-size: 0.85rem;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    justify-content: center;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-primary { background: #667eea; color: white; }
.btn-success { background: #2ed573; color: white; }
.btn-warning { background: #ffa502; color: white; }
.btn-danger { background: #ff4757; color: white; }
.btn-info { background: #3742fa; color: white; }
.btn-secondary { background: #57606f; color: white; }

.btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 20px;
}

.status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
.status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

.connection-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #2ed573;
    animation: pulse 2s infinite;
}

.connection-dot.disconnected {
    background: #ff4757;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

/* 오버레이 미리보기 */
.overlay-preview {
    background: #000;
    color: white;
    padding: 30px;
    border-radius: 12px;
    min-height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    text-shadow: 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000;
    margin: 20px 0;
    transition: all 0.3s ease;
}

.overlay-preview-text {
    font-size: 24px;
    text-align: center;
    line-height: 1.5;
    white-space: pre-line;
}

/* 로그 출력 */
.log-output {
    background: #2d3748;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    font-size: 12px;
    height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    border: 1px solid #4a5568;
}

/* 후원 리스트 */
.donation-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.donation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s ease;
}

.donation-item:hover {
    background: #f8f9fa;
}

.donation-item:last-child {
    border-bottom: none;
}

.donation-info {
    flex: 1;
}

.donation-donor {
    font-weight: 600;
    color: #2c3e50;
}

.donation-details {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 5px;
}

.donation-amount {
    font-weight: 700;
    font-size: 1.1rem;
    color: #2ed573;
}

/* 반응형 */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    .card {
        padding: 20px;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .tabs {
        flex-wrap: wrap;
    }
    
    .tab {
        flex: 1;
        min-width: 120px;
    }
}

/* 알림 메시지 */
.alert {
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    font-weight: 600;
    display: none;
}

.alert.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.floating-overlay-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #e9ecef;
    z-index: 999;
    display: none;
}

.floating-overlay-controls.show {
    display: block;
}
</style>
</head>
<body>

<div class="header">
    <h1>🎬 실시간 후원 시스템</h1>
    <div class="status-indicator status-info" id="connectionStatus">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">연결 중...</span>
    </div>
</div>

<div class="tabs-container">
    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">📊 대시보드</button>
        <button class="tab" onclick="showTab('donations')">💰 후원 관리</button>
        <button class="tab" onclick="showTab('streamers')">👥 스트리머 관리</button>
        <button class="tab" onclick="showTab('settings')">⚙️ 설정</button>
        <button class="tab" onclick="showTab('overlays')">🎥 오버레이</button>
        <button class="tab" onclick="showTab('debug')">🔧 디버그</button>
    </div>
</div>

<div class="container">
    <!-- 대시보드 탭 -->
    <div id="dashboard" class="tab-content active">
        <div class="grid grid-3">
            <div class="card">
                <div class="card-header">
                    <h3>📊 통계</h3>
                </div>
                <div id="stats">
                    <p><strong>총 후원:</strong> <span id="totalAmount">0</span>만원</p>
                    <p><strong>후원 건수:</strong> <span id="totalCount">0</span>건</p>
                    <p><strong>연결 사용자:</strong> <span id="connectedUsers">0</span>명</p>
                    <p><strong>활성 스트리머:</strong> <span id="activeStreamers">0</span>명</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>🔥 실시간 오버레이 미리보기</h3>
                </div>
                <div class="overlay-preview" id="overlayPreview">
                    <div class="overlay-preview-text" id="overlayPreviewText">
                        사랑해요♡<br>데이터 로딩 중...
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openOverlay('donor-overlay-simple.html')">🎥 오버레이 열기</button>
                    <button class="btn btn-info" onclick="testOverlaySettings()">🧪 설정 테스트</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>⚡ 빠른 작업</h3>
                </div>
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn btn-success" onclick="showTab('donations'); document.getElementById('newDonationForm').scrollIntoView();">💰 후원 추가</button>
                    <button class="btn btn-info" onclick="showTab('streamers'); document.getElementById('addStreamerForm').scrollIntoView();">👥 스트리머 추가</button>
                    <button class="btn btn-warning" onclick="showTab('settings');">⚙️ 설정 변경</button>
                    <button class="btn btn-danger" onclick="fixSettings();">🔧 설정 수정</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>📈 최근 후원 현황</h3>
            </div>
            <div id="recentDonations" class="donation-list">
                <div class="donation-item">
                    <div class="donation-info">
                        <div class="donation-donor">데이터 로딩 중...</div>
                        <div class="donation-details">잠시만 기다려주세요</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 후원 관리 탭 -->
    <div id="donations" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3>💰 새 후원 추가</h3>
                </div>
                <form id="newDonationForm">
                    <div class="form-group">
                        <label class="form-label">후원자명</label>
                        <input type="text" id="donorName" class="form-input" placeholder="후원자 이름">
                    </div>
                    <div class="form-group">
                        <label class="form-label">스트리머</label>
                        <select id="streamerSelect" class="form-select">
                            <option value="">스트리머 선택</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">후원 방식</label>
                        <select id="donationType" class="form-select">
                            <option value="계좌">계좌 이체</option>
                            <option value="투네이션">투네이션</option>
                            <option value="후원">기타 후원</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">후원 금액 (만원)</label>
                        <input type="number" id="donationAmount" class="form-input" placeholder="0" step="0.1" min="0">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">💰 후원 추가</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📋 후원 목록</h3>
                </div>
                <div id="donationsList" class="donation-list">
                    <!-- 후원 목록이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 스트리머 관리 탭 -->
    <div id="streamers" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3>👥 새 스트리머 추가</h3>
                </div>
                <form id="addStreamerForm">
                    <div class="form-group">
                        <label class="form-label">스트리머 이름</label>
                        <input type="text" id="newStreamerName" class="form-input" placeholder="스트리머 이름">
                    </div>
                    <div class="form-group">
                        <label class="form-label">이모지</label>
                        <input type="text" id="newStreamerEmoji" class="form-input" placeholder="🎮" maxlength="4">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">👥 스트리머 추가</button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>👥 스트리머 목록</h3>
                </div>
                <div id="streamersList">
                    <!-- 스트리머 목록이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 설정 탭 -->
    <div id="settings" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3>🎨 오버레이 설정</h3>
                </div>
                
                <div class="form-group">
                    <label class="form-label">폰트 크기</label>
                    <div class="range-display">
                        <input type="range" id="overlayFontSize" class="form-range" min="10" max="50" value="24">
                        <span class="range-value" id="overlayFontSizeValue">24px</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">텍스트 정렬</label>
                    <select id="overlayTextAlign" class="form-select">
                        <option value="left">왼쪽 정렬</option>
                        <option value="center">가운데 정렬</option>
                        <option value="right">오른쪽 정렬</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">텍스트 테두리 굵기</label>
                    <div class="range-display">
                        <input type="range" id="overlayStrokeWidth" class="form-range" min="0" max="10" value="3">
                        <span class="range-value" id="overlayStrokeWidthValue">3px</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="applyOverlaySettings()">💾 설정 적용</button>
                    <button class="btn btn-warning" onclick="resetOverlaySettings()">🔄 기본값 복원</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📊 테이블 설정</h3>
                </div>

                <div class="form-group">
                    <label class="form-label">테이블 투명도</label>
                    <div class="range-display">
                        <input type="range" id="tableOpacity" class="form-range" min="0" max="100" value="85">
                        <span class="range-value" id="tableOpacityValue">85%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">테이블 폰트 크기</label>
                    <div class="range-display">
                        <input type="range" id="tableFontSize" class="form-range" min="8" max="24" value="14">
                        <span class="range-value" id="tableFontSizeValue">14px</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">텍스트 색상</label>
                    <input type="color" id="tableTextColor" class="form-input" value="#ffffff">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="applyTableSettings()">💾 테이블 설정 적용</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 오버레이 탭 -->
    <div id="overlays" class="tab-content">
        <div class="grid grid-3">
            <div class="card">
                <div class="card-header">
                    <h3>🎥 후원자 오버레이</h3>
                </div>
                <p>실시간 후원자별 총액을 표시하는 오버레이입니다.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openOverlay('donor-overlay-simple.html')">🎥 Simple 오버레이</button>
                    <button class="btn btn-secondary" onclick="openOverlay('donor-overlay.html')">🎥 고급 오버레이</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📊 테이블 오버레이</h3>
                </div>
                <p>스트리머별 후원 현황을 테이블 형태로 보여주는 오버레이입니다.</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="openOverlay('streamer-table-overlay.html')">📊 테이블 오버레이</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>🧪 테스트 도구</h3>
                </div>
                <p>설정 테스트 및 디버깅을 위한 도구들입니다.</p>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="openOverlay('simple-overlay-test.html')">🧪 간단 테스트</button>
                    <button class="btn btn-warning" onclick="openOverlay('settings-debug.html')">🔧 디버그 도구</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>🎛️ 실시간 오버레이 컨트롤</h3>
            </div>
            <div class="grid grid-4">
                <button class="btn btn-primary" onclick="sendOverlayCommand('align', 'left')">← 왼쪽 정렬</button>
                <button class="btn btn-primary" onclick="sendOverlayCommand('align', 'center')">⚬ 가운데 정렬</button>
                <button class="btn btn-primary" onclick="sendOverlayCommand('align', 'right')">→ 오른쪽 정렬</button>
                <button class="btn btn-success" onclick="sendOverlayCommand('size', 'increase')">🔍 글자 크게</button>
            </div>
        </div>
    </div>

    <!-- 디버그 탭 -->
    <div id="debug" class="tab-content">
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <h3>🔧 시스템 상태</h3>
                </div>
                <div id="systemStatus">
                    <p><strong>서버 연결:</strong> <span id="serverConnection">확인 중...</span></p>
                    <p><strong>Socket.io:</strong> <span id="socketStatus">확인 중...</span></p>
                    <p><strong>데이터 동기화:</strong> <span id="syncStatus">확인 중...</span></p>
                    <p><strong>설정 상태:</strong> <span id="settingsStatus">확인 중...</span></p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-danger" onclick="fixSettings()">🔧 설정 구조 수정</button>
                    <button class="btn btn-warning" onclick="forceReload()">🔄 강제 새로고침</button>
                    <button class="btn btn-info" onclick="exportData()">💾 데이터 내보내기</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>📊 실시간 로그</h3>
                </div>
                <div id="debugLog" class="log-output"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="clearLog()">🗑️ 로그 지우기</button>
                    <button class="btn btn-info" onclick="downloadLog()">💾 로그 다운로드</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>⚡ 빠른 테스트</h3>
            </div>
            <div class="grid grid-4">
                <button class="btn btn-primary" onclick="testConnection()">🔗 연결 테스트</button>
                <button class="btn btn-success" onclick="testSettings()">⚙️ 설정 테스트</button>
                <button class="btn btn-warning" onclick="testOverlay()">🎥 오버레이 테스트</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ 모든 데이터 삭제</button>
            </div>
        </div>
    </div>
</div>

<!-- 알림 메시지 -->
<div id="alertMessage" class="alert"></div>

<!-- 플로팅 오버레이 컨트롤 -->
<div id="floatingControls" class="floating-overlay-controls">
    <h4>🎛️ 오버레이 컨트롤</h4>
    <div class="btn-group" style="flex-direction: column; gap: 5px;">
        <button class="btn btn-primary btn-sm" onclick="sendOverlayCommand('align', 'left')">← 왼쪽</button>
        <button class="btn btn-primary btn-sm" onclick="sendOverlayCommand('align', 'center')">⚬ 가운데</button>
        <button class="btn btn-primary btn-sm" onclick="sendOverlayCommand('align', 'right')">→ 오른쪽</button>
    </div>
</div>

<script>
// 전역 변수
let socket = null;
let isConnected = false;
let currentData = {
    donations: [],
    streamers: [],
    emojis: {},
    settings: {}
};
let debugLogs = [];

// Socket.io 초기화
function initializeSocket() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isConnected = true;
            updateConnectionStatus();
            log('서버 연결 성공');
        });
        
        socket.on('disconnect', () => {
            isConnected = false;
            updateConnectionStatus();
            log('서버 연결 끊김');
        });
        
        socket.on('initialData', (data) => {
            currentData = data;
            updateAllDisplays();
            log('초기 데이터 수신: ' + JSON.stringify(data, null, 2));
        });
        
        socket.on('dataUpdate', (data) => {
            currentData = data;
            updateAllDisplays();
            log('데이터 업데이트: ' + JSON.stringify(data, null, 2));
        });
        
        socket.on('settingsUpdate', (settings) => {
            currentData.settings = settings;
            updateSettingsDisplay();
            log('설정 업데이트: ' + JSON.stringify(settings, null, 2));
        });
        
        socket.on('userCount', (count) => {
            document.getElementById('connectedUsers').textContent = count;
        });
        
    } catch (error) {
        log('Socket.io 초기화 실패: ' + error.message);
        loadDataFromAPI();
    }
}

// API에서 데이터 로드
async function loadDataFromAPI() {
    try {
        const response = await fetch('/api/data');
        if (response.ok) {
            currentData = await response.json();
            updateAllDisplays();
            log('API에서 데이터 로드 성공');
        }
    } catch (error) {
        log('API 데이터 로드 실패: ' + error.message);
    }
}

// 연결 상태 업데이트
function updateConnectionStatus() {
    const dot = document.getElementById('connectionDot');
    const text = document.getElementById('connectionText');
    const status = document.getElementById('connectionStatus');
    
    if (isConnected) {
        dot.classList.remove('disconnected');
        text.textContent = '실시간 연결됨';
        status.className = 'status-indicator status-success';
    } else {
        dot.classList.add('disconnected');
        text.textContent = '연결 끊김';
        status.className = 'status-indicator status-error';
    }
}

// 모든 디스플레이 업데이트
function updateAllDisplays() {
    updateStats();
    updateDonationsList();
    updateStreamersList();
    updateSettingsDisplay();
    updateOverlayPreview();
}

// 통계 업데이트
function updateStats() {
    const donations = currentData.donations || [];
    const totalAmount = donations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
    const totalCount = donations.length;
    const activeStreamers = (currentData.streamers || []).length;
    
    document.getElementById('totalAmount').textContent = totalAmount.toFixed(1);
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('activeStreamers').textContent = activeStreamers;
}

// 후원 목록 업데이트
function updateDonationsList() {
    const donations = currentData.donations || [];
    const container = document.getElementById('donationsList');
    const recentContainer = document.getElementById('recentDonations');
    
    if (donations.length === 0) {
        const emptyHtml = '<div class="donation-item"><div class="donation-info"><div class="donation-donor">아직 후원이 없습니다</div></div></div>';
        container.innerHTML = emptyHtml;
        recentContainer.innerHTML = emptyHtml;
        return;
    }
    
    const html = donations.slice(0, 10).map(donation => `
        <div class="donation-item">
            <div class="donation-info">
                <div class="donation-donor">${donation.donor}</div>
                <div class="donation-details">${donation.streamer} • ${donation.type} • ${new Date(donation.time).toLocaleString()}</div>
            </div>
            <div class="donation-amount">${donation.amount}만원</div>
            <button class="btn btn-danger btn-sm" onclick="deleteDonation('${donation.time}')">삭제</button>
        </div>
    `).join('');
    
    container.innerHTML = html;
    recentContainer.innerHTML = donations.slice(0, 5).map(donation => `
        <div class="donation-item">
            <div class="donation-info">
                <div class="donation-donor">${donation.donor}</div>
                <div class="donation-details">${donation.streamer} • ${donation.amount}만원</div>
            </div>
        </div>
    `).join('');
}

// 스트리머 목록 업데이트
function updateStreamersList() {
    const streamers = currentData.streamers || [];
    const emojis = currentData.emojis || {};
    const container = document.getElementById('streamersList');
    const select = document.getElementById('streamerSelect');
    
    // 스트리머 목록
    if (streamers.length === 0) {
        container.innerHTML = '<p>아직 스트리머가 없습니다.</p>';
    } else {
        const html = streamers.map(streamer => `
            <div class="donation-item">
                <div class="donation-info">
                    <div class="donation-donor">${emojis[streamer] || '🎮'} ${streamer}</div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteStreamer('${streamer}')">삭제</button>
            </div>
        `).join('');
        container.innerHTML = html;
    }
    
    // 선택 옵션 업데이트
    select.innerHTML = '<option value="">스트리머 선택</option>' + 
        streamers.map(streamer => `<option value="${streamer}">${emojis[streamer] || '🎮'} ${streamer}</option>`).join('');
}

// 설정 표시 업데이트
function updateSettingsDisplay() {
    const settings = currentData.settings || {};
    
    // 오버레이 설정
    const fontSize = settings['overlay-font-size'] || '24';
    const textAlign = settings['overlay-text-align'] || 'center';
    const strokeWidth = settings['overlay-stroke-width'] || '3';
    
    document.getElementById('overlayFontSize').value = fontSize;
    document.getElementById('overlayFontSizeValue').textContent = fontSize + 'px';
    document.getElementById('overlayTextAlign').value = textAlign;
    document.getElementById('overlayStrokeWidth').value = strokeWidth;
    document.getElementById('overlayStrokeWidthValue').textContent = strokeWidth + 'px';
    
    // 테이블 설정
    const tableOpacity = settings['table-opacity'] || '85';
    const tableFontSize = settings['table-font-size'] || '14';
    const tableTextColor = settings['table-text-color'] || '#ffffff';
    
    document.getElementById('tableOpacity').value = tableOpacity;
    document.getElementById('tableOpacityValue').textContent = tableOpacity + '%';
    document.getElementById('tableFontSize').value = tableFontSize;
    document.getElementById('tableFontSizeValue').textContent = tableFontSize + 'px';
    document.getElementById('tableTextColor').value = tableTextColor;
}

// 오버레이 미리보기 업데이트
function updateOverlayPreview() {
    const donations = currentData.donations || [];
    const settings = currentData.settings || {};
    
    // 후원자별 총액 계산
    const donorTotals = {};
    donations.forEach(d => {
        if (d.type === '계좌') {
            let cleanName = d.donor.replace(/\(조정[^)]*\)/g, '').trim();
            
            // 계좌후원자님은 그대로 표시 (특별 처리)
            if (cleanName === '계좌후원자님' || cleanName === '계좌후원자') {
                cleanName = '계좌후원자님';
            }
            
            const amount = parseFloat(d.amount) || 0;
            if (amount > 0 && cleanName) {
                donorTotals[cleanName] = (donorTotals[cleanName] || 0) + amount;
            }
        }
    });
    
    // 표시 텍스트 생성
    const sortedDonors = Object.entries(donorTotals)
        .filter(([name, amount]) => amount > 0)
        .sort(([,a], [,b]) => b - a);
    
    let displayText = "사랑해요♡\n";
    if (sortedDonors.length > 0) {
        displayText += sortedDonors.slice(0, 5).map(([name, amount]) => 
            `${name}님 ${amount.toFixed(1)}만`
        ).join('\n');
    }
    
    const previewEl = document.getElementById('overlayPreviewText');
    previewEl.textContent = displayText;
    
    // 스타일 적용
    const fontSize = settings['overlay-font-size'] || '24';
    const textAlign = settings['overlay-text-align'] || 'center';
    const strokeWidth = settings['overlay-stroke-width'] || '3';
    
    const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000`;
    
    previewEl.style.fontSize = fontSize + 'px';
    previewEl.style.textAlign = textAlign;
    previewEl.style.textShadow = shadow;
}

// 탭 전환
function showTab(tabName) {
    // 모든 탭 내용 숨기기
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // 모든 탭 버튼 비활성화
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // 선택된 탭 활성화
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// 후원 추가
async function addDonation(donor, streamer, type, amount) {
    try {
        const response = await fetch('/api/donations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ donor, streamer, type, amount: parseFloat(amount) })
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('후원이 추가되었습니다!', 'success');
            log(`후원 추가: ${donor} → ${streamer} (${amount}만원)`);
        } else {
            showAlert('후원 추가 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('후원 추가 실패: ' + error.message);
    }
}

// 스트리머 추가
async function addStreamer(name, emoji) {
    try {
        const response = await fetch('/api/streamers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, emoji })
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('스트리머가 추가되었습니다!', 'success');
            log(`스트리머 추가: ${name} ${emoji}`);
        } else {
            showAlert('스트리머 추가 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('스트리머 추가 실패: ' + error.message);
    }
}

// 후원 삭제
async function deleteDonation(donationId) {
    if (!confirm('이 후원을 삭제하시겠습니까?')) return;
    
    try {
        const response = await fetch(`/api/donations/${donationId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('후원이 삭제되었습니다.', 'success');
            log(`후원 삭제: ${donationId}`);
        } else {
            showAlert('후원 삭제 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('후원 삭제 실패: ' + error.message);
    }
}

// 스트리머 삭제
async function deleteStreamer(streamerName) {
    if (!confirm(`${streamerName} 스트리머를 삭제하시겠습니까?`)) return;
    
    try {
        const response = await fetch(`/api/streamers/${encodeURIComponent(streamerName)}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('스트리머가 삭제되었습니다.', 'success');
            log(`스트리머 삭제: ${streamerName}`);
        } else {
            showAlert('스트리머 삭제 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('스트리머 삭제 실패: ' + error.message);
    }
}

// 설정 적용
async function applyOverlaySettings() {
    const settings = {
        'overlay-font-size': document.getElementById('overlayFontSize').value,
        'overlay-text-align': document.getElementById('overlayTextAlign').value,
        'overlay-stroke-width': document.getElementById('overlayStrokeWidth').value
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('오버레이 설정이 적용되었습니다!', 'success');
            log('오버레이 설정 적용: ' + JSON.stringify(settings));
        } else {
            showAlert('설정 적용 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('설정 적용 실패: ' + error.message);
    }
}

// 테이블 설정 적용
async function applyTableSettings() {
    const settings = {
        'table-opacity': document.getElementById('tableOpacity').value,
        'table-font-size': document.getElementById('tableFontSize').value,
        'table-text-color': document.getElementById('tableTextColor').value
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('테이블 설정이 적용되었습니다!', 'success');
            log('테이블 설정 적용: ' + JSON.stringify(settings));
        } else {
            showAlert('설정 적용 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('설정 적용 실패: ' + error.message);
    }
}

// 설정 구조 수정
async function fixSettings() {
    try {
        showAlert('설정 구조를 수정하는 중...', 'info');
        
        const response = await fetch('/api/fix-settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            showAlert('설정 구조가 성공적으로 수정되었습니다!', 'success');
            log('설정 구조 수정 성공');
            loadDataFromAPI(); // 데이터 다시 로드
        } else {
            showAlert('설정 구조 수정 실패: ' + result.error, 'error');
        }
    } catch (error) {
        showAlert('오류: ' + error.message, 'error');
        log('설정 구조 수정 실패: ' + error.message);
    }
}

// 오버레이 열기
function openOverlay(fileName) {
    const url = window.location.origin + '/' + fileName;
    window.open(url, '_blank', 'width=800,height=600');
    log(`오버레이 열기: ${fileName}`);
}

// 오버레이 명령 전송
async function sendOverlayCommand(type, value) {
    let settings = {};
    
    if (type === 'align') {
        settings['overlay-text-align'] = value;
    } else if (type === 'size') {
        const currentSize = parseInt(document.getElementById('overlayFontSize').value) || 24;
        const newSize = value === 'increase' ? currentSize + 2 : Math.max(10, currentSize - 2);
        settings['overlay-font-size'] = newSize.toString();
        document.getElementById('overlayFontSize').value = newSize;
        document.getElementById('overlayFontSizeValue').textContent = newSize + 'px';
    }
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ settings })
        });
        
        if (response.ok) {
            showAlert('오버레이 명령이 전송되었습니다!', 'success');
            log('오버레이 명령 전송: ' + JSON.stringify(settings));
        }
    } catch (error) {
        log('오버레이 명령 전송 실패: ' + error.message);
    }
}

// 알림 표시
function showAlert(message, type = 'info') {
    const alertEl = document.getElementById('alertMessage');
    alertEl.textContent = message;
    alertEl.className = `alert alert-${type} show`;
    
    setTimeout(() => {
        alertEl.classList.remove('show');
    }, 3000);
}

// 로그 기록
function log(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `[${timestamp}] ${message}`;
    debugLogs.push(logMessage);
    
    const logEl = document.getElementById('debugLog');
    if (logEl) {
        logEl.textContent = debugLogs.slice(-50).join('\n');
        logEl.scrollTop = logEl.scrollHeight;
    }
    
    console.log(logMessage);
}

// 로그 지우기
function clearLog() {
    debugLogs = [];
    document.getElementById('debugLog').textContent = '';
}

// 테스트 함수들
function testConnection() {
    loadDataFromAPI();
    showAlert('연결 테스트를 실행했습니다.', 'info');
}

function testSettings() {
    const testSettings = {
        'overlay-font-size': '30',
        'overlay-text-align': 'center'
    };
    
    fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings: testSettings })
    }).then(response => {
        if (response.ok) {
            showAlert('설정 테스트 성공!', 'success');
        } else {
            showAlert('설정 테스트 실패!', 'error');
        }
    });
}

function testOverlay() {
    openOverlay('simple-overlay-test.html');
    showAlert('테스트 오버레이를 열었습니다.', 'info');
}

function testOverlaySettings() {
    sendOverlayCommand('align', 'center');
    setTimeout(() => sendOverlayCommand('align', 'left'), 1000);
    setTimeout(() => sendOverlayCommand('align', 'right'), 2000);
    setTimeout(() => sendOverlayCommand('align', 'center'), 3000);
    showAlert('오버레이 설정 테스트를 실행합니다.', 'info');
}

// 이벤트 리스너
document.addEventListener('DOMContentLoaded', () => {
    // Socket 초기화
    initializeSocket();
    
    // 슬라이더 이벤트
    document.getElementById('overlayFontSize').addEventListener('input', (e) => {
        document.getElementById('overlayFontSizeValue').textContent = e.target.value + 'px';
    });
    
    document.getElementById('overlayStrokeWidth').addEventListener('input', (e) => {
        document.getElementById('overlayStrokeWidthValue').textContent = e.target.value + 'px';
    });
    
    document.getElementById('tableOpacity').addEventListener('input', (e) => {
        document.getElementById('tableOpacityValue').textContent = e.target.value + '%';
    });
    
    document.getElementById('tableFontSize').addEventListener('input', (e) => {
        document.getElementById('tableFontSizeValue').textContent = e.target.value + 'px';
    });
    
    // 폼 이벤트
    document.getElementById('newDonationForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const donor = document.getElementById('donorName').value;
        const streamer = document.getElementById('streamerSelect').value;
        const type = document.getElementById('donationType').value;
        const amount = document.getElementById('donationAmount').value;
        
        if (!donor || !streamer || !amount) {
            showAlert('모든 필드를 입력해주세요.', 'error');
            return;
        }
        
        addDonation(donor, streamer, type, amount);
        
        // 폼 리셋
        e.target.reset();
    });
    
    document.getElementById('addStreamerForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('newStreamerName').value;
        const emoji = document.getElementById('newStreamerEmoji').value;
        
        if (!name) {
            showAlert('스트리머 이름을 입력해주세요.', 'error');
            return;
        }
        
        addStreamer(name, emoji);
        
        // 폼 리셋
        e.target.reset();
    });
    
    // 키보드 단축키
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    showTab('dashboard');
                    break;
                case '2':
                    e.preventDefault();
                    showTab('donations');
                    break;
                case '3':
                    e.preventDefault();
                    showTab('streamers');
                    break;
                case '4':
                    e.preventDefault();
                    showTab('settings');
                    break;
                case '5':
                    e.preventDefault();
                    showTab('overlays');
                    break;
                case '6':
                    e.preventDefault();
                    showTab('debug');
                    break;
            }
        }
    });
    
    // 주기적 업데이트
    setInterval(() => {
        if (!isConnected) {
            loadDataFromAPI();
        }
        updateOverlayPreview();
    }, 5000);
    
    log('통합 관리 시스템 초기화 완료');
});

// 추가 유틸리티 함수들
function resetOverlaySettings() {
    document.getElementById('overlayFontSize').value = 24;
    document.getElementById('overlayFontSizeValue').textContent = '24px';
    document.getElementById('overlayTextAlign').value = 'center';
    document.getElementById('overlayStrokeWidth').value = 3;
    document.getElementById('overlayStrokeWidthValue').textContent = '3px';
    
    applyOverlaySettings();
}

function forceReload() {
    location.reload();
}

function exportData() {
    const dataStr = JSON.stringify(currentData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `donation-data-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showAlert('데이터를 내보냈습니다.', 'success');
}

function downloadLog() {
    const logStr = debugLogs.join('\n');
    const logBlob = new Blob([logStr], {type: 'text/plain'});
    const url = URL.createObjectURL(logBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `debug-log-${new Date().toISOString().split('T')[0]}.txt`;
    link.click();
    URL.revokeObjectURL(url);
    
    showAlert('로그를 다운로드했습니다.', 'success');
}

function clearAllData() {
    if (!confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        return;
    }
    
    if (!confirm('마지막 확인: 모든 후원 데이터와 설정이 삭제됩니다.')) {
        return;
    }
    
    // 실제로는 구현하지 않음 (안전상의 이유)
    showAlert('데이터 삭제 기능은 안전상의 이유로 비활성화되어 있습니다.', 'warning');
}
</script>

</body>
</html>