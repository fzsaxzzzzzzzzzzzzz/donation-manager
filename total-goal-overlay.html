<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ ì´ì•¡ ëª©í‘œ ê·¸ë˜í”„ ì˜¤ë²„ë ˆì´ (Socket.IO)</title>

<!-- Socket.IO for Real-time - ë¡œì»¬ ì„œë²„ì™€ ë™ì¼í•œ ì†ŒìŠ¤ ì‚¬ìš© -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 500px;
    width: 100%;
    margin: 0 auto;
}

.total-goal-container {
    background: rgba(0, 0, 0, 0);
    border-radius: 0px;
    padding: 20px;
    border: none;
    box-shadow: none;
    backdrop-filter: none;
}


.goal-progress-container {
    width: 100%;
    height: var(--progress-height, 30px);
    background: linear-gradient(90deg, #2c2c2c 0%, #404040 100%);
    border-radius: 15px;
    overflow: hidden;
    border: 3px solid #555;
    box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.6);
    margin-bottom: 15px;
    position: relative;
}

.goal-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff6b35 0%, #ff8a50 50%, #ffa726 100%);
    width: 0%;
    border-radius: 12px;
    position: relative;
    box-shadow: 0 3px 15px rgba(255, 107, 53, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-text {
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
    text-shadow: 1px 1px 0 #000000, -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 2px 2px 4px rgba(0, 0, 0, 0.8);
    z-index: 10;
    white-space: nowrap;
    text-align: center;
}

.goal-progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.4) 50%, transparent 100%);
    border-radius: 12px;
}

/* ë°°í„°ë¦¬ ìµœì í™”: ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
*,
*::before,
*::after {
    animation: none !important;
    transition: none !important;
    will-change: auto !important;
    backdrop-filter: none !important;
    filter: none !important;
    transform: none !important;
    -webkit-transform: none !important;
}


/* ë°˜ì‘í˜• */
@media (max-width: 600px) {
    .overlay-container {
        max-width: 90vw;
    }
    .total-goal-container {
        padding: 15px;
    }
    .goal-title {
        font-size: 20px;
    }
    .goal-stats {
        font-size: 16px;
    }
}
</style>
</head>

<body>
<script>
class TotalGoalOverlay {
    constructor() {
        console.log('ğŸ“Š ì´ì•¡ ëª©í‘œ ê·¸ë˜í”„ ì‹œì‘ (Socket.IO + ì˜ˆìœ ë””ìì¸)');

        this.donations = [];
        this.settings = {};
        this.dailyGoal = { target: 50 }; // ê¸°ë³¸ 50ë§Œì›
        this.isConnected = false;
        this.textSwitchInterval = null;
        this.currentTextMode = 'progress'; // 'progress' ë˜ëŠ” 'remaining'

        // Socket.IO ì´ˆê¸°í™”
        this.socket = io({ timeout: 5000 });
        this.initializeSocket();

        // Socket.IO ì—°ê²° ì‹¤íŒ¨ ëŒ€ë¹„ API í´ë°±
        setTimeout(() => {
            if (!this.isConnected) {
                console.log('âš¡ Socket.IO ì—°ê²° ì§€ì—° - API ëª¨ë“œë¡œ ì „í™˜');
                this.loadDataFromServer();
                this.startPeriodicUpdate();
            }
        }, 3000);
    }
    
    initializeSocket() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            console.log('ğŸ”— ì´ì•¡ ê·¸ë˜í”„ Socket.IO ì„œë²„ ì—°ê²°ë¨');
        });
        
        this.socket.on('disconnect', () => {
            this.isConnected = false;
            console.log('âŒ Socket.IO ì—°ê²° ëŠì–´ì§ - API ëª¨ë“œë¡œ ì „í™˜');
            setTimeout(() => {
                this.loadDataFromServer();
                this.startPeriodicUpdate();
            }, 2000);
        });
        
        this.socket.on('initialData', (data) => {
            console.log('ğŸ“Š Socket.IO ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            this.donations = data.donations || [];
            this.settings = data.settings || {};
            this.dailyGoal = data.settings?.dailyGoal || { target: 50 };
            this.applySettings();
            this.updateDisplay();
        });

        this.socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ Socket.IO ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
            this.donations = data.donations || [];

            if (data.settings) {
                this.settings = data.settings;
                this.dailyGoal = data.settings?.dailyGoal || { target: 50 };
                this.applySettings();
            }

            this.updateDisplay();
        });
        
        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ Socket.IO ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
            this.settings = settings;
            this.dailyGoal = settings?.dailyGoal || { target: 50 };
            this.applySettings();
            this.updateDisplay();
        });
    }

    applySettings() {
        // ì´ì•¡ ê·¸ë˜í”„ ì„¤ì •ì„ CSS ë³€ìˆ˜ë¡œ ì ìš©
        if (this.settings['total-goal-progress-height']) {
            document.documentElement.style.setProperty('--progress-height', this.settings['total-goal-progress-height'] + 'px');
        }
        if (this.settings['total-goal-title-font-size']) {
            const titleElement = document.getElementById('goal-title');
            if (titleElement) {
                titleElement.style.fontSize = this.settings['total-goal-title-font-size'] + 'px';
            }
        }
        if (this.settings['total-goal-stats-font-size']) {
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                progressText.style.fontSize = this.settings['total-goal-stats-font-size'] + 'px';
            }
        }

        // í…ìŠ¤íŠ¸ ìë™ ì „í™˜ ì„¤ì •
        this.setupTextSwitch();

        console.log('âœ… ì´ì•¡ ê·¸ë˜í”„ ì„¤ì • ì ìš©ë¨:', {
            height: this.settings['total-goal-progress-height'],
            titleSize: this.settings['total-goal-title-font-size'],
            statsSize: this.settings['total-goal-stats-font-size'],
            textSwitchEnabled: this.settings['total-goal-text-switch-enabled']
        });
    }

    setupTextSwitch() {
        // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
        if (this.textSwitchInterval) {
            clearInterval(this.textSwitchInterval);
            this.textSwitchInterval = null;
        }

        // í…ìŠ¤íŠ¸ ì „í™˜ì´ í™œì„±í™”ëœ ê²½ìš°
        if (this.settings['total-goal-text-switch-enabled']) {
            const interval = (parseInt(this.settings['total-goal-text-switch-interval']) || 5) * 1000;
            console.log(`ğŸ”„ í…ìŠ¤íŠ¸ ìë™ ì „í™˜ ì‹œì‘ (${interval / 1000}ì´ˆ ê°„ê²©)`);

            this.textSwitchInterval = setInterval(() => {
                this.currentTextMode = this.currentTextMode === 'progress' ? 'remaining' : 'progress';
                this.updateDisplay();
            }, interval);
        } else {
            // ì „í™˜ ë¹„í™œì„±í™” ì‹œ ê¸°ë³¸ ëª¨ë“œë¡œ
            this.currentTextMode = 'progress';
            console.log('â¹ï¸ í…ìŠ¤íŠ¸ ìë™ ì „í™˜ ë¹„í™œì„±í™”');
        }
    }
    
    startPeriodicUpdate() {
        // Socket.IO ì—°ê²°ì´ ì—†ì„ ë•Œë§Œ API í´ë§ ì‹œì‘
        if (this.isConnected) return;
        
        console.log('ğŸ”„ API í´ë§ ëª¨ë“œ ì‹œì‘ (10ì´ˆ ê°„ê²©)');
        this.apiPollingInterval = setInterval(() => {
            if (!this.isConnected) {
                this.loadDataFromServer();
            } else {
                clearInterval(this.apiPollingInterval);
            }
        }, 10000);
    }
    
    async loadDataFromServer() {
        try {
            const response = await fetch('/api/data');
            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“Š ì„œë²„ ë°ì´í„° ìˆ˜ì‹ :', data);

                this.donations = data.donations || [];
                this.settings = data.settings || {};
                this.dailyGoal = data.settings?.dailyGoal || { target: 50 };

                this.applySettings();
                this.updateDisplay();
            } else {
                console.log('âŒ API ì‘ë‹µ ì‹¤íŒ¨, ë”ë¯¸ ë°ì´í„° ì‚¬ìš©');
            }
        } catch (error) {
            console.log('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨, ë”ë¯¸ ë°ì´í„° ì‚¬ìš©:', error);
        }
    }
    
    getTodaysDonationTotal() {
        return this.donations
            .filter(d => !d.excludeFromTotal && !d.isMissionAdjustment)
            .reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
    }
    
    updateDisplay() {
        const donationTotal = this.getTodaysDonationTotal();
        const initialAmount = parseFloat(this.dailyGoal.initialAmount) || 0;
        const currentAmount = donationTotal + initialAmount;
        let targetAmount = parseFloat(this.dailyGoal.target) || 50;

        // ìë™ ì—°ì¥ ê¸°ëŠ¥ ì²´í¬
        if (this.dailyGoal.autoExtend && currentAmount >= targetAmount) {
            // í˜„ì¬ ê¸ˆì•¡ì´ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì„ ë•Œ ìë™ìœ¼ë¡œ ëª©í‘œ ì¦ê°€
            const extendAmount = parseFloat(this.dailyGoal.extendAmount) || 50;
            const newTarget = Math.ceil(currentAmount / extendAmount) * extendAmount + extendAmount;
            
            // ëª©í‘œê°€ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì„œë²„ì— ì—…ë°ì´íŠ¸
            if (newTarget !== targetAmount) {
                targetAmount = newTarget;
                this.dailyGoal.target = newTarget;
                
                // ì„œë²„ì— ìƒˆë¡œìš´ ëª©í‘œ ì €ì¥
                this.updateTargetOnServer(newTarget);
                console.log(`ğŸ¯ ìë™ ì—°ì¥: ${newTarget}ë§Œì›ìœ¼ë¡œ ëª©í‘œ ì¦ê°€`);
            }
        }
        
        const progressPercent = targetAmount > 0 ? Math.min((currentAmount / targetAmount) * 100, 100) : 0;
        const remainingAmount = Math.max(targetAmount - currentAmount, 0);
        
        console.log(`ğŸ’° ì´ì•¡: ${currentAmount}ë§Œì› / ${targetAmount}ë§Œì› (${progressPercent.toFixed(1)}%)`);
        
        // ì†Œìˆ˜ì  í¬ë§·íŒ… í•¨ìˆ˜ (ì„¤ì •ì— ë”°ë¼ í‘œì‹œ)
        const formatAmount = (amount) => {
            // ì„œë²„ ì„¤ì • í™•ì¸ (ê¸°ë³¸ê°’: smart)
            const decimalMode = this.settings['total-goal-decimal-display'] || 'smart';
            
            if (decimalMode === 'always') {
                return amount.toFixed(1);
            } else {
                // smart ëª¨ë“œ: ì •ìˆ˜ì¼ ë•Œ ì†Œìˆ˜ì  ìƒëµ
                return amount % 1 === 0 ? Math.floor(amount).toString() : amount.toFixed(1);
            }
        };
        
        // ì œëª© ì—…ë°ì´íŠ¸
        const titleElement = document.getElementById('goal-title');
        const customTitle = this.settings['total-goal-custom-title'] || '';
        const showTitle = this.settings['total-goal-show-title'] !== false; // ê¸°ë³¸ê°’: true
        
        if (showTitle && customTitle) {
            titleElement.style.display = 'block';
            titleElement.textContent = customTitle;
        } else {
            titleElement.style.display = 'none';
        }
        
        // UI ì—…ë°ì´íŠ¸ (ì§„í–‰ë„ ë°”)
        const progressTextElement = document.getElementById('progress-text');

        // í…ìŠ¤íŠ¸ ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ
        if (this.currentTextMode === 'remaining') {
            // ë‚¨ì€ ê¸ˆì•¡ í‘œì‹œ ëª¨ë“œ
            if (remainingAmount > 0) {
                progressTextElement.textContent = `ëª©í‘œê¹Œì§€ ${formatAmount(remainingAmount)}ë§Œì› ë‚¨ìŒ`;
            } else {
                progressTextElement.textContent = `ğŸ‰ ëª©í‘œ ë‹¬ì„±! (+${formatAmount(currentAmount - targetAmount)}ë§Œì›)`;
            }
        } else {
            // ê¸°ë³¸ ì§„í–‰ë¥  í‘œì‹œ ëª¨ë“œ
            progressTextElement.textContent = `${formatAmount(currentAmount)} / ${formatAmount(targetAmount)}ë§Œì› (${Math.round(progressPercent)}%)`;
        }

        // ì§„í–‰ë„ ë°” ì—…ë°ì´íŠ¸
        const progressBar = document.querySelector('.goal-progress-bar');
        progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
    }
    
    async updateTargetOnServer(newTarget) {
        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    settings: {
                        'dailyGoal': {
                            target: newTarget,
                            autoExtend: this.dailyGoal.autoExtend,
                            extendAmount: this.dailyGoal.extendAmount
                        }
                    }
                })
            });
            
            if (response.ok) {
                console.log('âœ… ìë™ ì—°ì¥ëœ ëª©í‘œê°€ ì„œë²„ì— ì €ì¥ë¨:', newTarget);
            }
        } catch (error) {
            console.error('âŒ ëª©í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    new TotalGoalOverlay();
});
</script>
<div class="overlay-container">
    <div class="total-goal-container">
        <div class="goal-content">
            <!-- ì‚¬ìš©ì ì •ì˜ ì œëª© -->
            <div class="goal-title" id="goal-title" style="display: none; text-align: center; margin-bottom: 10px; font-size: 18px; font-weight: bold; color: white; text-shadow: 1px 1px 0 #000000, -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 2px 2px 4px rgba(0, 0, 0, 0.8);">
                ì˜¤ëŠ˜ì˜ ëª©í‘œ
            </div>
            <div class="goal-progress-container">
                <div class="progress-text" id="progress-text">0 / 50ë§Œì› (0%)</div>
                <div class="goal-progress-bar"></div>
            </div>
        </div>
    </div>
</div>

</body>
</html><!-- Force deploy 2025ë…„ 9ì›”ì›”  4ì¼ ëª© 02:51:57 -->
