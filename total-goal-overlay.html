<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š ëª¨ë°”ì¼ ì „ìš© ì´ì•¡ ëª©í‘œ ê·¸ë˜í”„</title>

<!-- Socket.IO for Real-time - ë¡œì»¬ ì„œë²„ì™€ ë™ì¼í•œ ì†ŒìŠ¤ ì‚¬ìš© -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 15px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
    /* ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: í•˜ë“œì›¨ì–´ ê°€ì† ì™„ì „ ë¹„í™œì„±í™” */
    transform: none;
    -webkit-transform: none;
    will-change: auto;
}

.graph-container {
    background: transparent;
    max-width: 100vw;
    width: 100%;
    height: 100vh;
    position: relative;
    /* ëª¨ë°”ì¼ ìµœì í™”: ë¶ˆí•„ìš”í•œ íš¨ê³¼ ì œê±° */
    box-shadow: none;
    backdrop-filter: none;
    border: none;
}

.goal-progress {
    width: 100%;
    height: 40px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 20px;
    border: 2px solid white;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #CDDC39 100%);
    width: 0%;
    border-radius: 18px;
    /* ë°°í„°ë¦¬ ì ˆì•½: ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ì œê±° */
    transition: none;
    animation: none;
}

.progress-bar.completed {
    background: linear-gradient(90deg, #FFD700 0%, #FFC107 50%, #FF9800 100%);
}

.goal-info {
    text-align: center;
    margin-bottom: 20px;
}

.current-amount {
    font-size: var(--graph-font-size, 20px);
    font-weight: bold;
    color: #FFD700;
    text-shadow: var(--graph-text-shadow, 2px 2px 0 #000000, -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000);
    margin-bottom: 5px;
}

.goal-amount {
    font-size: var(--graph-font-size-small, 16px);
    color: white;
    text-shadow: var(--graph-text-shadow, 2px 2px 0 #000000, -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000);
}

.percentage {
    font-size: var(--graph-font-size-large, 32px);
    font-weight: bold;
    color: #4CAF50;
    text-shadow: var(--graph-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000);
    margin: 15px 0;
}

.percentage.completed {
    color: #FFD700;
}

.no-data {
    text-align: center;
    font-size: var(--graph-font-size, 18px);
    color: white;
    text-shadow: var(--graph-text-shadow, 2px 2px 0 #000000, -2px -2px 0 #000000, 2px -2px 0 #000000, -2px 2px 0 #000000);
    padding: 50px 20px;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
    /* ë°°í„°ë¦¬ ì ˆì•½: í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì œê±° */
    animation: none;
}

/* ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” */
* {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    filter: none !important;
    backdrop-filter: none !important;
}

/* ë°°í„°ë¦¬ ì ˆì•½: GPU ê°€ì† ë¹„í™œì„±í™” */
*,
*::before,
*::after {
    will-change: auto;
    transform: none;
    -webkit-transform: none;
}
</style>
</head>
<body>

<div class="graph-container">
    <div id="graph-content">
        <div class="loading">ğŸ“Š ëª¨ë°”ì¼ ê·¸ë˜í”„ ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<script>
class MobileGoalGraphOverlay {
    constructor() {
        console.log('ğŸ“Š ëª¨ë°”ì¼ ì „ìš© ì´ì•¡ ëª©í‘œ ê·¸ë˜í”„ ì‹œì‘');
        
        this.socket = io({ timeout: 5000 });
        this.donations = [];
        this.settings = {
            'graph-font-size': 20,
            'graph-font-size-small': 16,
            'graph-font-size-large': 32,
            'goal-amount': 50,
            'includeSuperchat': localStorage.getItem('include-superchat') === 'true'
        };
        this.isConnected = false;
        
        // ë¹ ë¥¸ ë¡œë”©ì„ ìœ„í•´ ì¦‰ì‹œ ë”ë¯¸ ë°ì´í„° í‘œì‹œ
        setTimeout(() => {
            if (!this.isConnected) {
                console.log('âš¡ Socket.IO ì—°ê²° ì§€ì—° - ë”ë¯¸ ë°ì´í„°ë¡œ í‘œì‹œ');
                this.loadDummyData();
            }
        }, 3000);
        
        // ëª¨ë°”ì¼ ì „ìš© ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½ ëª¨ë“œ
        this.enableBatterySaving();
        this.enableCPUThrottling();
        this.initializeSocket();
        this.setupKeyboardControls();
    }
    
    enableCPUThrottling() {
        // CPU ì‚¬ìš©ëŸ‰ ê·¹í•œ ìµœì í™”
        if ('requestIdleCallback' in window) {
            this.useIdleCallback = true;
            console.log('ğŸ“Š idle callback í™œì„±í™” - CPU ë¶€í•˜ ìµœì†Œí™”');
        }
        
        // ë°°í„°ë¦¬ API ì‚¬ìš© ê°€ëŠ¥ ì‹œ ë°°í„°ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                this.battery = battery;
                console.log(`ğŸ“Š ë°°í„°ë¦¬ ìˆ˜ì¤€: ${Math.round(battery.level * 100)}%`);
                
                // ëª¨ë°”ì¼ ì „ìš©: 20% ì´í•˜ì—ì„œ ê·¹í•œ ì ˆì•½
                if (battery.level < 0.20) {
                    this.enableUltraPowerSaveMode();
                }
                
                battery.addEventListener('levelchange', () => {
                    const level = Math.round(battery.level * 100);
                    console.log(`ğŸ“Š ë°°í„°ë¦¬ ë³€ê²½: ${level}%`);
                    
                    if (battery.level < 0.20 && !this.ultraPowerSave) {
                        this.enableUltraPowerSaveMode();
                    } else if (battery.level > 0.30 && this.ultraPowerSave) {
                        this.disableUltraPowerSaveMode();
                    }
                });
            });
        }
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œí™”
        this.minimizeMemoryUsage();
    }
    
    enableUltraPowerSaveMode() {
        console.log('ğŸ”´ ëª¨ë°”ì¼ ê·¸ë˜í”„ ê·¹í•œ ì ˆì•½ ëª¨ë“œ í™œì„±í™” - 2ì´ˆì— 1ë²ˆ');
        this.ultraPowerSave = true;
        this.maxFPS = 0.5; // 2ì´ˆì— 1ë²ˆ
        this.frameInterval = 2000;
    }
    
    disableUltraPowerSaveMode() {
        console.log('ğŸŸ¢ ëª¨ë°”ì¼ ê·¸ë˜í”„ ê·¹í•œ ì ˆì•½ ëª¨ë“œ í•´ì œ - 1fps ë³µêµ¬');
        this.ultraPowerSave = false;
        this.maxFPS = 1;
        this.frameInterval = 1000;
    }
    
    minimizeMemoryUsage() {
        // ëª¨ë°”ì¼ ì „ìš© ë©”ëª¨ë¦¬ ì •ë¦¬ - 90ì´ˆë§ˆë‹¤
        setInterval(() => {
            // ì˜¤ë˜ëœ í›„ì› ë°ì´í„° ì •ë¦¬ - 20ê°œ ì´ˆê³¼ ì‹œ
            if (this.donations && this.donations.length > 20) {
                this.donations = this.donations.slice(-10); // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
                console.log('ğŸ“Š ëª¨ë°”ì¼ ê·¸ë˜í”„ ë©”ëª¨ë¦¬ ì •ë¦¬: ìµœê·¼ 10ê°œë§Œ ìœ ì§€');
            }
        }, 90000);
    }
    
    enableBatterySaving() {
        // í™”ë©´ ìƒˆë¡œê³ ì¹¨ ìµœì†Œí™”
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ğŸ“Š ê·¸ë˜í”„ê°€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì´ë™ - ì ˆì „ ëª¨ë“œ');
                this.batterySaveMode = true;
            } else {
                console.log('ğŸ“Š ê·¸ë˜í”„ê°€ í¬ê·¸ë¼ìš´ë“œë¡œ ë³µê·€');
                this.batterySaveMode = false;
                this.updateDisplay(); // ì¦‰ì‹œ ì—…ë°ì´íŠ¸
            }
        });
        
        // ë¶ˆí•„ìš”í•œ DOM ì¡°ì‘ ìµœì†Œí™”
        this.updateThrottle = false;
        
        // ëª¨ë°”ì¼ ì „ìš© ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: ì—…ë°ì´íŠ¸ ì£¼ê¸° ëŒ€í­ ëŠ˜ë¦¬ê¸°
        this.maxFPS = 1;
        this.frameInterval = 1000;
        this.lastFrameTime = 0;
        
        // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
        this.setupMemoryOptimization();
    }
    
    setupMemoryOptimization() {
        // ëª¨ë°”ì¼ ì „ìš© ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ - 30ì´ˆë§ˆë‹¤
        setInterval(() => {
            if (window.gc && typeof window.gc === 'function') {
                window.gc();
            }
        }, 30000);
    }
    
    initializeSocket() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            console.log('ğŸ”— ëª¨ë°”ì¼ ê·¸ë˜í”„ ì„œë²„ ì—°ê²°ë¨');
        });
        
        this.socket.on('disconnect', () => {
            this.isConnected = false;
            console.log('âŒ ê·¸ë˜í”„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            this.showError('ì„œë²„ ì—°ê²° ëŠì–´ì§');
        });
        
        this.socket.on('initialData', (data) => {
            console.log('ğŸ“Š ê·¸ë˜í”„ ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            this.donations = data.donations || [];
            this.settings = { ...this.settings, ...(data.settings || {}) };
            this.applySettings();
            this.updateDisplay();
        });
        
        this.socket.on('dataUpdate', (data) => {
            // ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” ì—…ë°ì´íŠ¸ ì™„ì „ ìŠ¤í‚µ
            if (this.batterySaveMode) {
                console.log('ğŸ“Š ì ˆì „ ëª¨ë“œ: ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ ìŠ¤í‚µ');
                return;
            }
            
            console.log('ğŸ”„ ê·¸ë˜í”„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
            this.donations = data.donations || [];
            
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            
            this.throttledUpdate();
        });
        
        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ê·¸ë˜í”„ ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
            this.settings = { ...this.settings, ...settings };
            this.applySettings();
            this.updateDisplay();
        });
    }
    
    // ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: ì—…ë°ì´íŠ¸ ì“°ë¡œí‹€ë§
    throttledUpdate() {
        if (this.updateThrottle) return;
        
        const now = performance.now();
        if (now - this.lastFrameTime < this.frameInterval) {
            return; // FPS ì œí•œ
        }
        
        this.updateThrottle = true;
        this.lastFrameTime = now;
        
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” ì—…ë°ì´íŠ¸ ì™„ì „ ìŠ¤í‚µ
        if (this.batterySaveMode) {
            this.updateThrottle = false;
            return;
        }
        
        // ëª¨ë°”ì¼ ì „ìš© ê·¹í•œ ë°°í„°ë¦¬ ì ˆì•½: idle callback ìš°ì„  ì‚¬ìš©
        if (this.useIdleCallback && !this.ultraPowerSave) {
            requestIdleCallback(() => {
                this.updateDisplay();
                this.updateThrottle = false;
            }, { timeout: 2000 });
        } else {
            // ê·¹í•œ ëª¨ë“œ: setTimeoutìœ¼ë¡œ CPU ë¶€í•˜ ìµœì†Œí™”
            setTimeout(() => {
                this.updateDisplay();
                this.updateThrottle = false;
            }, 100);
        }
    }
    
    applySettings() {
        const root = document.documentElement;
        const fontSize = parseInt(this.settings['graph-font-size']) || 20;
        const fontSizeSmall = parseInt(this.settings['graph-font-size-small']) || 16;
        const fontSizeLarge = parseInt(this.settings['graph-font-size-large']) || 32;
        const strokeWidth = 2; // ê³ ì •ê°’ìœ¼ë¡œ ë°°í„°ë¦¬ ì ˆì•½
        
        root.style.setProperty('--graph-font-size', fontSize + 'px');
        root.style.setProperty('--graph-font-size-small', fontSizeSmall + 'px');
        root.style.setProperty('--graph-font-size-large', fontSizeLarge + 'px');
        root.style.setProperty('--graph-text-shadow', 
            `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000`
        );
        
        console.log('ğŸ”§ ëª¨ë°”ì¼ ì „ìš© ê·¸ë˜í”„ ì„¤ì • ì ìš©:', { fontSize, fontSizeSmall, fontSizeLarge });
    }
    
    updateDisplay() {
        const contentEl = document.getElementById('graph-content');
        const goalAmount = parseFloat(this.settings['goal-amount']) || 100;
        
        if (!this.donations || this.donations.length === 0) {
            contentEl.innerHTML = `
                <div class="no-data">
                    <div class="goal-info">
                        <div class="current-amount">0.0ë§Œì›</div>
                        <div class="goal-amount">ëª©í‘œ: ${goalAmount.toFixed(1)}ë§Œì›</div>
                    </div>
                    <div class="goal-progress">
                        <div class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="percentage">0%</div>
                </div>
            `;
            return;
        }
        
        // ì´ì•¡ ê³„ì‚° (ìµœì í™”ëœ ë¡œì§)
        const includeSuperchat = this.settings.includeSuperchat !== undefined ? 
            this.settings.includeSuperchat : (localStorage.getItem('include-superchat') === 'true');
        
        let totalAmount = 0;
        this.donations.forEach(d => {
            const amount = parseFloat(d.amount) || 0;
            
            // íˆ¬ë„¤ì´ì…˜ë„ í¬í•¨í•˜ë„ë¡ ìˆ˜ì •
            const shouldInclude = d.type === 'ê³„ì¢Œ' || d.type === 'íˆ¬ë„¤ì´ì…˜' || (includeSuperchat && d.type === 'ìŠˆí¼ì±—');
            
            if (shouldInclude && amount > 0) {
                if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                    return; // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ì œì™¸
                }
                totalAmount += amount;
            }
        });
        
        const percentage = Math.min((totalAmount / goalAmount) * 100, 100);
        const isCompleted = percentage >= 100;
        
        contentEl.innerHTML = `
            <div class="goal-info">
                <div class="current-amount">${totalAmount.toFixed(1)}ë§Œì›</div>
                <div class="goal-amount">ëª©í‘œ: ${goalAmount.toFixed(1)}ë§Œì›</div>
            </div>
            <div class="goal-progress">
                <div class="progress-bar ${isCompleted ? 'completed' : ''}" 
                     style="width: ${percentage}%"></div>
            </div>
            <div class="percentage ${isCompleted ? 'completed' : ''}">${percentage.toFixed(1)}%</div>
        `;
        
        console.log('ğŸ“Š ëª¨ë°”ì¼ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸:', `${totalAmount.toFixed(1)}/${goalAmount}ë§Œì› (${percentage.toFixed(1)}%)`);
    }
    
    showError(message) {
        const contentEl = document.getElementById('graph-content');
        contentEl.innerHTML = `<div class="no-data" style="color: #ffcccb;">${message}</div>`;
    }
    
    loadDataFromAPI() {
        console.log('ğŸ“¡ API ëª¨ë“œë¡œ ë°ì´í„° ë¡œë“œ ì‹œë„');
        
        // APIë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“Š APIì—ì„œ ë°ì´í„° ìˆ˜ì‹ :', data);
                this.donations = data.donations || [];
                this.settings = { ...this.settings, ...(data.settings || {}) };
                this.applySettings();
                this.updateDisplay();
                
                // ì„±ê³µ ì‹œ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
                this.startAPIPolling();
            })
            .catch(error => {
                console.error('âŒ API ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                this.showError('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”');
                
                // ì¬ì‹œë„ ë¡œì§
                setTimeout(() => {
                    this.loadDataFromAPI();
                }, 10000);
            });
    }
    
    startAPIPolling() {
        // Socket.IO ì—°ê²°ì´ ì—†ì„ ë•Œë§Œ polling ì‹œì‘
        if (this.isConnected) return;
        
        console.log('ğŸ”„ API í´ë§ ëª¨ë“œ ì‹œì‘ (30ì´ˆ ê°„ê²©)');
        this.apiPollingInterval = setInterval(() => {
            if (!this.isConnected) {
                this.loadDataFromAPI();
            } else {
                clearInterval(this.apiPollingInterval);
            }
        }, 30000);
    }
    
    loadDummyData() {
        console.log('ğŸ“Š ë”ë¯¸ ë°ì´í„°ë¡œ ê·¸ë˜í”„ í‘œì‹œ');
        
        // í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ í›„ì› ë°ì´í„°
        this.donations = [
            { amount: '10', type: 'ê³„ì¢Œ', donor: 'ìµëª…1' },
            { amount: '5', type: 'íˆ¬ë„¤ì´ì…˜', donor: 'ìµëª…2' },
            { amount: '15', type: 'ê³„ì¢Œ', donor: 'ìµëª…3' }
        ];
        
        this.applySettings();
        this.updateDisplay();
        
        // ì‹¤ì œ ë°ì´í„° ë¡œë“œ ê³„ì† ì‹œë„
        setTimeout(() => {
            this.loadDataFromAPI();
        }, 5000);
    }
    
    setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '=':
                        this.settings['graph-font-size'] = Math.min(40, (this.settings['graph-font-size'] || 20) + 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“Š í°íŠ¸ í¬ê¸°:', this.settings['graph-font-size']);
                        break;
                    case '-':
                        this.settings['graph-font-size'] = Math.max(12, (this.settings['graph-font-size'] || 20) - 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ğŸ“Š í°íŠ¸ í¬ê¸°:', this.settings['graph-font-size']);
                        break;
                }
                e.preventDefault();
            }
        });
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ“Š ëª¨ë°”ì¼ ì „ìš© ì´ì•¡ ëª©í‘œ ê·¸ë˜í”„ ì´ˆê¸°í™”');
    const graphOverlay = new MobileGoalGraphOverlay();
});
</script>

</body>
</html>