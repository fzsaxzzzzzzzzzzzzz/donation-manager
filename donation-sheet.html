<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”´ ì‹¤ì‹œê°„ í›„ì› ì‹œíŠ¸ (ì—‘ì…€ ìŠ¤íƒ€ì¼)</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    color: #333;
    overflow: hidden;
}

.header {
    background: #2b5cb6;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 1.3rem;
    margin: 0;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #42b72a;
    animation: pulse 2s infinite;
}

.status-dot.disconnected {
    background: #fa383e;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.toolbar {
    background: white;
    border-bottom: 1px solid #e1e5e9;
    padding: 10px 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.btn {
    padding: 6px 12px;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    background: white;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn:hover {
    background: #f6f8fa;
}

.btn-primary {
    background: #0969da;
    color: white;
    border-color: #0969da;
}

.btn-success {
    background: #1a7f37;
    color: white;
    border-color: #1a7f37;
}

.btn-danger {
    background: #cf222e;
    color: white;
    border-color: #cf222e;
}

.sheet-container {
    height: calc(100vh - 120px);
    overflow: auto;
    position: relative;
}

.sheet-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background: white;
}

.sheet-table th {
    background: #f6f8fa;
    border: 1px solid #d0d7de;
    padding: 8px;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
    min-width: 100px;
}

.sheet-table td {
    border: 1px solid #d0d7de;
    padding: 0;
    position: relative;
    min-width: 100px;
    height: 32px;
}

.sheet-cell {
    width: 100%;
    height: 100%;
    border: none;
    padding: 4px 8px;
    font-size: 13px;
    background: transparent;
    outline: none;
    display: block;
}

.sheet-cell:focus {
    background: white;
    box-shadow: inset 0 0 0 2px #0969da;
    z-index: 5;
    position: relative;
}

.sheet-cell.readonly {
    background: #f6f8fa;
    cursor: default;
}

.row-number {
    background: #f6f8fa !important;
    font-weight: 600;
    text-align: center;
    width: 50px;
    min-width: 50px;
    font-size: 11px;
    color: #656d76;
}

.selected-cell {
    background: #dbeafe !important;
}

.new-row {
    background: #f0fdf4 !important;
}

.modified-cell {
    background: #fef3c7 !important;
}

.error-cell {
    background: #fef2f2 !important;
}

.total-row {
    background: #f8fafc !important;
    font-weight: 600;
}

.total-row .sheet-cell {
    background: #f8fafc;
    font-weight: 600;
}

.context-menu {
    position: absolute;
    background: white;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    z-index: 1000;
    display: none;
    min-width: 150px;
}

.context-menu-item {
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    border-bottom: 1px solid #f6f8fa;
}

.context-menu-item:hover {
    background: #f6f8fa;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.status-bar {
    background: white;
    border-top: 1px solid #e1e5e9;
    padding: 6px 20px;
    font-size: 12px;
    color: #656d76;
    display: flex;
    justify-content: between;
    align-items: center;
}

.formula-bar {
    background: white;
    border-bottom: 1px solid #e1e5e9;
    padding: 8px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
}

.formula-input {
    flex: 1;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 13px;
}

.cell-reference {
    font-weight: 600;
    min-width: 60px;
    color: #656d76;
}

@media (max-width: 768px) {
    .toolbar {
        padding: 8px 10px;
    }
    
    .header {
        padding: 10px 15px;
    }
    
    .sheet-table th,
    .sheet-table td {
        min-width: 80px;
    }
}
</style>
</head>
<body>

<div class="header">
    <h1>ğŸ“Š ì‹¤ì‹œê°„ í›„ì› ì‹œíŠ¸</h1>
    <div class="connection-status">
        <div class="status-dot" id="connectionDot"></div>
        <span id="connectionText">ì—°ê²° ì¤‘...</span>
        <span>|</span>
        <span>ì´ <strong id="totalRows">0</strong>ê±´</span>
    </div>
</div>

<div class="formula-bar">
    <span class="cell-reference" id="cellReference">A1</span>
    <input type="text" class="formula-input" id="formulaInput" placeholder="ê°’ì„ ì…ë ¥í•˜ì„¸ìš”...">
</div>

<div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• ìƒˆ í–‰ ì¶”ê°€</button>
    <button class="btn btn-primary" onclick="saveSheet()">ğŸ’¾ ì €ì¥</button>
    <button class="btn btn-danger" onclick="deleteSelectedRows()">ğŸ—‘ï¸ ì„ íƒ í–‰ ì‚­ì œ</button>
    <div style="border-left: 1px solid #d0d7de; margin: 0 10px; height: 24px;"></div>
    <button class="btn" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn" onclick="refreshSheet()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    <div style="flex: 1;"></div>
    <span class="status-bar">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span></span>
</div>

<div class="sheet-container">
    <table class="sheet-table" id="sheetTable">
        <thead>
            <tr>
                <th class="row-number">#</th>
                <th>ì‹œê°„</th>
                <th>í›„ì›ì</th>
                <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                <th>íƒ€ì…</th>
                <th>ê¸ˆì•¡</th>
                <th>ë©”ëª¨</th>
                <th>ìƒíƒœ</th>
            </tr>
        </thead>
        <tbody id="sheetBody">
            <tr>
                <td class="row-number">ë¡œë”©ì¤‘...</td>
                <td colspan="7" style="text-align: center; padding: 20px; color: #656d76;">
                    ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editCell()">âœï¸ í¸ì§‘</div>
    <div class="context-menu-item" onclick="copyCell()">ğŸ“‹ ë³µì‚¬</div>
    <div class="context-menu-item" onclick="deleteRow()">ğŸ—‘ï¸ í–‰ ì‚­ì œ</div>
    <div class="context-menu-item" onclick="insertRowAbove()">â¬†ï¸ ìœ„ì— í–‰ ì‚½ì…</div>
    <div class="context-menu-item" onclick="insertRowBelow()">â¬‡ï¸ ì•„ë˜ í–‰ ì‚½ì…</div>
</div>

<script>
class DonationSheet {
    constructor() {
        this.socket = null;
        this.isConnected = false;
        this.donations = [];
        this.selectedCell = null;
        this.currentRow = null;
        this.currentCol = null;
        
        this.initializeRealtime();
        this.initializeEvents();
        this.renderSheet();
    }

    initializeRealtime() {
        try {
            this.socket = io();
            
            this.socket.on('connect', () => {
                this.isConnected = true;
                this.updateConnectionStatus();
                console.log('ğŸ”— ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
            });

            this.socket.on('disconnect', () => {
                this.isConnected = false;
                this.updateConnectionStatus();
                console.log('âŒ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            });

            this.socket.on('initialData', (data) => {
                console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
                this.donations = data.donations || [];
                this.renderSheet();
            });

            this.socket.on('dataUpdate', (data) => {
                console.log('ğŸ”„ [ì—‘ì…€ì‹œíŠ¸] ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
                console.log('ğŸ”„ [ì—‘ì…€ì‹œíŠ¸] í˜„ì¬ ì—°ê²° ìƒíƒœ:', this.isConnected);
                console.log('ğŸ”„ [ì—‘ì…€ì‹œíŠ¸] ìˆ˜ì‹ ëœ í›„ì› ë°ì´í„°:', data.donations?.length || 0, 'ê±´');
                
                this.donations = data.donations || [];
                console.log('ğŸ“Š [ì—‘ì…€ì‹œíŠ¸] ìƒˆ ë°ì´í„°ë¡œ ì‹œíŠ¸ ì—…ë°ì´íŠ¸:', this.donations.length, 'ê±´');
                this.renderSheet();
                this.highlightNewRows();
                
                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œê°ì  í”¼ë“œë°±
                const container = document.querySelector('.sheet-container');
                if (container) {
                    container.style.opacity = '0.8';
                    setTimeout(() => {
                        container.style.opacity = '1';
                    }, 300);
                }
            });

        } catch (error) {
            console.error('Socket.io ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            this.loadFromLocalStorage();
        }
    }

    updateConnectionStatus() {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        
        if (this.isConnected) {
            dot.classList.remove('disconnected');
            text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
            document.title = 'ğŸ”´ ì‹¤ì‹œê°„ í›„ì› ì‹œíŠ¸ (ì—°ê²°ë¨)';
        } else {
            dot.classList.add('disconnected');
            text.textContent = 'ì—°ê²° ëŠì–´ì§';
            document.title = 'âšª í›„ì› ì‹œíŠ¸ (ë¡œì»¬ëª¨ë“œ)';
        }
    }

    initializeEvents() {
        // ì…€ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('sheet-cell')) {
                this.selectCell(e.target);
            } else {
                this.hideContextMenu();
            }
        });

        // ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('sheet-cell')) {
                e.preventDefault();
                this.showContextMenu(e);
            }
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ì—‘ì…€ ìŠ¤íƒ€ì¼)
        document.addEventListener('keydown', (e) => {
            if (this.selectedCell) {
                this.handleKeyPress(e);
            }
        });

        // ìˆ˜ì‹ ì…ë ¥ì°½
        document.getElementById('formulaInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                this.commitCellEdit();
            } else if (e.key === 'Escape') {
                this.cancelCellEdit();
            }
        });
        
        // ì…€ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('sheet-cell') && e.target.dataset.new === 'true') {
                this.handleNewRowChange(e.target);
            } else if (e.target.classList.contains('sheet-cell')) {
                this.handleCellChange(e.target);
            }
        });
    }

    renderSheet() {
        const tbody = document.getElementById('sheetBody');
        
        if (!this.donations || this.donations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td class="row-number">1</td>
                    <td><input type="datetime-local" class="sheet-cell" data-field="time"></td>
                    <td><input type="text" class="sheet-cell" data-field="donor" placeholder="í›„ì›ìëª…"></td>
                    <td><select class="sheet-cell" data-field="streamer">
                        <option value="">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</option>
                        <option value="ì—„ì‚¼ìš©">ğŸ«… ì—„ì‚¼ìš©</option>
                        <option value="ì†ë•ë°°">ğŸŒº ì†ë•ë°°</option>
                        <option value="ì—°ê¸°">ğŸ§ ì—°ê¸°</option>
                        <option value="ì£¼ì˜¥">ğŸ‘º ì£¼ì˜¥</option>
                        <option value="ë¶ˆê³°">ğŸ¬ ë¶ˆê³°</option>
                        <option value="ì´íš¨íŒ”">ğŸ ì´íš¨íŒ”</option>
                        <option value="ë™ë™">ğŸ˜ ë™ë™</option>
                        <option value="ë‚¨ë¶•">ğŸ¤  ë‚¨ë¶•</option>
                        <option value="ì˜¥ê¸”">ğŸ¦† ì˜¥ê¸”</option>
                        <option value="êµ­ê³ ">ğŸ¦ êµ­ê³ </option>
                    </select></td>
                    <td><select class="sheet-cell" data-field="type">
                        <option value="ê³„ì¢Œ">ê³„ì¢Œ</option>
                        <option value="íˆ¬ë„¤">íˆ¬ë„¤</option>
                        <option value="ìŠˆí¼ì±—">ìŠˆí¼ì±—</option>
                    </select></td>
                    <td><input type="number" class="sheet-cell" data-field="amount" placeholder="0" step="0.1"></td>
                    <td><input type="text" class="sheet-cell" data-field="memo" placeholder="ë©”ëª¨..."></td>
                    <td><span class="sheet-cell readonly">ì‹ ê·œ</span></td>
                </tr>
            `;
            document.getElementById('totalRows').textContent = '0';
            return;
        }

        let html = '';
        this.donations.forEach((donation, index) => {
            html += this.createTableRow(donation, index + 1);
        });

        // ìƒˆ í–‰ ì¶”ê°€
        html += this.createNewRow(this.donations.length + 1);

        // ì´í•© í–‰
        const totalAmount = this.donations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        html += `
            <tr class="total-row">
                <td class="row-number">í•©ê³„</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">${this.donations.length}ê±´</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">â‚©${totalAmount.toLocaleString()}</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">-</td>
            </tr>
        `;

        tbody.innerHTML = html;
        document.getElementById('totalRows').textContent = this.donations.length;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    createTableRow(donation, rowNum) {
        const time = new Date(donation.time);
        const timeString = time.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
        
        return `
            <tr data-row="${rowNum}">
                <td class="row-number">${rowNum}</td>
                <td><input type="datetime-local" class="sheet-cell" data-field="time" value="${timeString}" data-id="${donation.time}"></td>
                <td><input type="text" class="sheet-cell" data-field="donor" value="${donation.donor}" data-id="${donation.time}"></td>
                <td><select class="sheet-cell" data-field="streamer" data-id="${donation.time}">
                    <option value="">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</option>
                    <option value="ì—„ì‚¼ìš©" ${donation.streamer === 'ì—„ì‚¼ìš©' ? 'selected' : ''}>ğŸ«… ì—„ì‚¼ìš©</option>
                    <option value="ì†ë•ë°°" ${donation.streamer === 'ì†ë•ë°°' ? 'selected' : ''}>ğŸŒº ì†ë•ë°°</option>
                    <option value="ì—°ê¸°" ${donation.streamer === 'ì—°ê¸°' ? 'selected' : ''}>ğŸ§ ì—°ê¸°</option>
                    <option value="ì£¼ì˜¥" ${donation.streamer === 'ì£¼ì˜¥' ? 'selected' : ''}>ğŸ‘º ì£¼ì˜¥</option>
                    <option value="ë¶ˆê³°" ${donation.streamer === 'ë¶ˆê³°' ? 'selected' : ''}>ğŸ¬ ë¶ˆê³°</option>
                    <option value="ì´íš¨íŒ”" ${donation.streamer === 'ì´íš¨íŒ”' ? 'selected' : ''}>ğŸ ì´íš¨íŒ”</option>
                    <option value="ë™ë™" ${donation.streamer === 'ë™ë™' ? 'selected' : ''}>ğŸ˜ ë™ë™</option>
                    <option value="ë‚¨ë¶•" ${donation.streamer === 'ë‚¨ë¶•' ? 'selected' : ''}>ğŸ¤  ë‚¨ë¶•</option>
                    <option value="ì˜¥ê¸”" ${donation.streamer === 'ì˜¥ê¸”' ? 'selected' : ''}>ğŸ¦† ì˜¥ê¸”</option>
                    <option value="êµ­ê³ " ${donation.streamer === 'êµ­ê³ ' ? 'selected' : ''}>ğŸ¦ êµ­ê³ </option>
                </select></td>
                <td><select class="sheet-cell" data-field="type" data-id="${donation.time}">
                    <option value="ê³„ì¢Œ" ${donation.type === 'ê³„ì¢Œ' ? 'selected' : ''}>ê³„ì¢Œ</option>
                    <option value="íˆ¬ë„¤" ${donation.type === 'íˆ¬ë„¤' ? 'selected' : ''}>íˆ¬ë„¤</option>
                    <option value="ìŠˆí¼ì±—" ${donation.type === 'ìŠˆí¼ì±—' ? 'selected' : ''}>ìŠˆí¼ì±—</option>
                </select></td>
                <td><input type="number" class="sheet-cell" data-field="amount" value="${donation.amount}" step="0.1" data-id="${donation.time}"></td>
                <td><input type="text" class="sheet-cell" data-field="memo" value="${donation.memo || ''}" data-id="${donation.time}"></td>
                <td><span class="sheet-cell readonly">ì™„ë£Œ</span></td>
            </tr>
        `;
    }

    createNewRow(rowNum) {
        return `
            <tr class="new-row" data-row="${rowNum}">
                <td class="row-number">${rowNum}</td>
                <td><input type="datetime-local" class="sheet-cell" data-field="time" data-new="true"></td>
                <td><input type="text" class="sheet-cell" data-field="donor" placeholder="í›„ì›ìëª…" data-new="true"></td>
                <td><select class="sheet-cell" data-field="streamer" data-new="true">
                    <option value="">ìŠ¤íŠ¸ë¦¬ë¨¸ ì„ íƒ</option>
                    <option value="ì—„ì‚¼ìš©">ğŸ«… ì—„ì‚¼ìš©</option>
                    <option value="ì†ë•ë°°">ğŸŒº ì†ë•ë°°</option>
                    <option value="ì—°ê¸°">ğŸ§ ì—°ê¸°</option>
                    <option value="ì£¼ì˜¥">ğŸ‘º ì£¼ì˜¥</option>
                    <option value="ë¶ˆê³°">ğŸ¬ ë¶ˆê³°</option>
                    <option value="ì´íš¨íŒ”">ğŸ ì´íš¨íŒ”</option>
                    <option value="ë™ë™">ğŸ˜ ë™ë™</option>
                    <option value="ë‚¨ë¶•">ğŸ¤  ë‚¨ë¶•</option>
                    <option value="ì˜¥ê¸”">ğŸ¦† ì˜¥ê¸”</option>
                    <option value="êµ­ê³ ">ğŸ¦ êµ­ê³ </option>
                </select></td>
                <td><select class="sheet-cell" data-field="type" data-new="true">
                    <option value="ê³„ì¢Œ">ê³„ì¢Œ</option>
                    <option value="íˆ¬ë„¤">íˆ¬ë„¤</option>
                    <option value="ìŠˆí¼ì±—">ìŠˆí¼ì±—</option>
                </select></td>
                <td><input type="number" class="sheet-cell" data-field="amount" placeholder="0" step="0.1" data-new="true"></td>
                <td><input type="text" class="sheet-cell" data-field="memo" placeholder="ë©”ëª¨..." data-new="true"></td>
                <td><span class="sheet-cell readonly">ì‹ ê·œ</span></td>
            </tr>
        `;
    }

    handleKeyPress(e) {
        const cell = this.selectedCell;
        if (!cell) return;
        
        const row = cell.closest('tr');
        const cells = Array.from(row.children);
        const currentIndex = cells.indexOf(cell.parentNode);
        const rows = Array.from(row.parentNode.children);
        const rowIndex = rows.indexOf(row);
        
        switch(e.key) {
            case 'ArrowRight':
                e.preventDefault();
                if (currentIndex + 1 < cells.length) {
                    const nextCell = cells[currentIndex + 1].querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'ArrowLeft':
                e.preventDefault();
                if (currentIndex - 1 >= 1) { // Skip row number column
                    const prevCell = cells[currentIndex - 1].querySelector('.sheet-cell');
                    if (prevCell) this.selectCell(prevCell);
                }
                break;
                
            case 'ArrowDown':
                e.preventDefault();
                if (rowIndex + 1 < rows.length) {
                    const nextRow = rows[rowIndex + 1];
                    const nextCell = nextRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (rowIndex - 1 >= 0) {
                    const prevRow = rows[rowIndex - 1];
                    const prevCell = prevRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (prevCell) this.selectCell(prevCell);
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                this.commitCellEdit();
                // Move down to next row
                if (rowIndex + 1 < rows.length) {
                    const nextRow = rows[rowIndex + 1];
                    const nextCell = nextRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                this.cancelCellEdit();
                break;
                
            case 'Delete':
            case 'Backspace':
                e.preventDefault();
                this.clearCell();
                break;
                
            case 'F2':
                e.preventDefault();
                this.startCellEdit();
                break;
                
            default:
                // Start editing with typed character
                if (e.key.length === 1 && !e.ctrlKey && !e.altKey) {
                    this.startCellEdit(e.key);
                }
                break;
        }
    }

    selectCell(cell) {
        // ì´ì „ ì„ íƒ í•´ì œ
        if (this.selectedCell) {
            this.selectedCell.classList.remove('selected-cell');
        }

        this.selectedCell = cell;
        cell.classList.add('selected-cell');

        // ì…€ ì°¸ì¡° ì—…ë°ì´íŠ¸
        const row = cell.closest('tr');
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);
        const cellIndex = Array.from(row.children).indexOf(cell.parentNode);
        
        const colName = String.fromCharCode(65 + cellIndex - 1); // A, B, C...
        document.getElementById('cellReference').textContent = colName + (rowIndex + 1);
        
        // ìˆ˜ì‹ ì…ë ¥ì°½ì— í˜„ì¬ ê°’ í‘œì‹œ
        const formulaInput = document.getElementById('formulaInput');
        formulaInput.value = cell.value || cell.textContent || '';
    }
    
    commitCellEdit() {
        const formulaInput = document.getElementById('formulaInput');
        const value = formulaInput.value;
        
        if (this.selectedCell) {
            // Update cell value
            if (this.selectedCell.tagName === 'INPUT') {
                this.selectedCell.value = value;
                // Trigger change event to save data
                this.selectedCell.dispatchEvent(new Event('change'));
            } else if (this.selectedCell.tagName === 'SELECT') {
                this.selectedCell.value = value;
                this.selectedCell.dispatchEvent(new Event('change'));
            } else {
                this.selectedCell.textContent = value;
            }
            
            // Mark as modified
            this.selectedCell.classList.add('modified-cell');
            setTimeout(() => {
                this.selectedCell.classList.remove('modified-cell');
            }, 1000);
            
            // Auto-save if connected
            this.saveChanges();
        }
    }
    
    cancelCellEdit() {
        const formulaInput = document.getElementById('formulaInput');
        if (this.selectedCell) {
            formulaInput.value = this.selectedCell.value || this.selectedCell.textContent || '';
        }
    }
    
    startCellEdit(initialValue = '') {
        if (this.selectedCell && !this.selectedCell.classList.contains('readonly')) {
            const formulaInput = document.getElementById('formulaInput');
            formulaInput.value = initialValue || this.selectedCell.value || this.selectedCell.textContent || '';
            formulaInput.focus();
            formulaInput.select();
        }
    }
    
    clearCell() {
        if (this.selectedCell && !this.selectedCell.classList.contains('readonly')) {
            if (this.selectedCell.tagName === 'INPUT') {
                this.selectedCell.value = '';
            } else if (this.selectedCell.tagName === 'SELECT') {
                this.selectedCell.selectedIndex = 0;
            } else {
                this.selectedCell.textContent = '';
            }
            
            const formulaInput = document.getElementById('formulaInput');
            formulaInput.value = '';
            
            this.selectedCell.classList.add('modified-cell');
            setTimeout(() => {
                this.selectedCell.classList.remove('modified-cell');
            }, 1000);
            
            this.saveChanges();
        }
    }
    
    async saveChanges() {
        // Collect all changes and save them
        if (this.isConnected) {
            try {
                // Auto-save functionality would go here
                console.log('âœ… ë³€ê²½ì‚¬í•­ ìë™ ì €ì¥ë¨');
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            }
        } else {
            this.saveToLocalStorage();
        }
    }
    
    handleCellChange(cell) {
        // Handle existing row cell changes
        const donationId = cell.dataset.id;
        if (donationId) {
            const field = cell.dataset.field;
            const value = cell.value || cell.textContent;
            
            // Update local data
            const donation = this.donations.find(d => d.time === donationId);
            if (donation) {
                donation[field] = field === 'amount' ? parseFloat(value) || 0 : value;
                this.saveChanges();
            }
        }
    }
    
    handleNewRowChange(cell) {
        // Handle new row cell changes - auto-add when enough data is entered
        const row = cell.closest('tr');
        const donor = row.querySelector('[data-field="donor"]').value.trim();
        const streamer = row.querySelector('[data-field="streamer"]').value;
        const amount = parseFloat(row.querySelector('[data-field="amount"]').value) || 0;
        
        // Auto-add when we have donor, streamer, and amount
        if (donor && streamer && amount > 0) {
            this.addNewRow();
        }
    }

    async addNewRow() {
        const newRow = document.querySelector('.new-row');
        if (!newRow) return;

        const donor = newRow.querySelector('[data-field="donor"]').value.trim();
        const streamer = newRow.querySelector('[data-field="streamer"]').value;
        const type = newRow.querySelector('[data-field="type"]').value;
        const amount = parseFloat(newRow.querySelector('[data-field="amount"]').value) || 0;
        const memo = newRow.querySelector('[data-field="memo"]').value.trim();

        if (!donor || !streamer || amount <= 0) {
            alert('í›„ì›ìëª…, ìŠ¤íŠ¸ë¦¬ë¨¸, ê¸ˆì•¡ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        const newDonation = {
            donor,
            streamer,
            type,
            amount,
            memo,
            time: new Date().toISOString()
        };

        try {
            if (this.isConnected) {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newDonation)
                });

                if (response.ok) {
                    console.log('âœ… ìƒˆ í›„ì› ì¶”ê°€ ì„±ê³µ');
                    // ì„œë²„ì—ì„œ dataUpdate ì´ë²¤íŠ¸ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
                } else {
                    throw new Error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
                }
            } else {
                // ë¡œì»¬ ì €ì¥
                this.donations.unshift(newDonation);
                this.renderSheet();
                this.saveToLocalStorage();
            }
        } catch (error) {
            console.error('í›„ì› ì¶”ê°€ ì‹¤íŒ¨:', error);
            alert('í›„ì› ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    highlightNewRows() {
        // ìƒˆë¡œ ì¶”ê°€ëœ í–‰ë“¤ì„ ì ì‹œ í•˜ì´ë¼ì´íŠ¸
        const rows = document.querySelectorAll('[data-row]');
        rows.forEach(row => {
            row.style.backgroundColor = '#f0fdf4';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 1000);
        });
    }

    showContextMenu(e) {
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    }

    loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem('donation_data');
            if (saved) {
                this.donations = JSON.parse(saved);
                this.renderSheet();
            }
        } catch (error) {
            console.error('ë¡œì»¬ ì €ì¥ì†Œ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem('donation_data', JSON.stringify(this.donations));
        } catch (error) {
            console.error('ë¡œì»¬ ì €ì¥ì†Œ ì €ì¥ ì‹¤íŒ¨:', error);
        }
    }
    
    async deleteDonation(donationId) {
        try {
            if (this.isConnected && donationId) {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    console.log('âœ… í›„ì› ì‚­ì œ ì„±ê³µ');
                    // ì„œë²„ì—ì„œ dataUpdate ì´ë²¤íŠ¸ë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
                } else {
                    throw new Error('ì„œë²„ ì‚­ì œ ì‹¤íŒ¨');
                }
            } else {
                // ë¡œì»¬ì—ì„œ ì‚­ì œ
                this.donations = this.donations.filter(d => d.time !== donationId);
                this.renderSheet();
                this.saveToLocalStorage();
            }
        } catch (error) {
            console.error('í›„ì› ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('í›„ì› ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

// ì „ì—­ í•¨ìˆ˜ë“¤
function addNewRow() {
    window.donationSheet.addNewRow();
}

async function saveSheet() {
    try {
        if (window.donationSheet.isConnected) {
            // ì„œë²„ì— ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥
            const response = await fetch('/api/donations/bulk', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ donations: window.donationSheet.donations })
            });
            
            if (response.ok) {
                alert('âœ… ì‹œíŠ¸ê°€ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                throw new Error('ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
            }
        } else {
            // ë¡œì»¬ ì €ì¥
            window.donationSheet.saveToLocalStorage();
            alert('âœ… ì‹œíŠ¸ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('âŒ ì‹œíŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function deleteSelectedRows() {
    const selectedCells = document.querySelectorAll('.sheet-cell.selected-cell');
    if (selectedCells.length === 0) {
        alert('ì‚­ì œí•  í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (confirm(`ì„ íƒëœ ${selectedCells.length}ê°œ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        selectedCells.forEach(cell => {
            const donationId = cell.dataset.id;
            if (donationId) {
                window.donationSheet.deleteDonation(donationId);
            }
        });
    }
}

function exportToExcel() {
    // CSV í˜•íƒœë¡œ ë‚´ë³´ë‚´ê¸°
    const csvContent = "data:text/csv;charset=utf-8," 
        + "ì‹œê°„,í›„ì›ì,ìŠ¤íŠ¸ë¦¬ë¨¸,íƒ€ì…,ê¸ˆì•¡,ë©”ëª¨\n"
        + window.donationSheet.donations.map(d => 
            `${d.time},${d.donor},${d.streamer},${d.type},${d.amount},"${d.memo || ''}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `í›„ì›ë°ì´í„°_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function refreshSheet() {
    window.donationSheet.renderSheet();
}

// ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í•¨ìˆ˜ë“¤
function editCell() {
    window.donationSheet.startCellEdit();
    window.donationSheet.hideContextMenu();
}

function copyCell() {
    if (window.donationSheet.selectedCell) {
        const value = window.donationSheet.selectedCell.value || window.donationSheet.selectedCell.textContent || '';
        navigator.clipboard.writeText(value).then(() => {
            console.log('âœ… ì…€ ë‚´ìš© ë³µì‚¬ë¨:', value);
        }).catch(err => {
            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
        });
    }
    window.donationSheet.hideContextMenu();
}

function deleteRow() {
    if (window.donationSheet.selectedCell) {
        const row = window.donationSheet.selectedCell.closest('tr');
        if (row && !row.classList.contains('total-row') && !row.classList.contains('new-row')) {
            if (confirm('ì´ í–‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const donationId = window.donationSheet.selectedCell.dataset.id;
                window.donationSheet.deleteDonation(donationId);
            }
        }
    }
    window.donationSheet.hideContextMenu();
}

function insertRowAbove() {
    window.donationSheet.addNewRow();
    window.donationSheet.hideContextMenu();
}

function insertRowBelow() {
    window.donationSheet.addNewRow();
    window.donationSheet.hideContextMenu();
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    window.donationSheet = new DonationSheet();
});
</script>

</body>
</html>