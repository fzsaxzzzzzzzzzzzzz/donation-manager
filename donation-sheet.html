<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🔴 실시간 후원 시트 (엑셀 스타일)</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    color: #333;
    overflow: hidden;
}

.header {
    background: #2b5cb6;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 1.3rem;
    margin: 0;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #42b72a;
    animation: pulse 2s infinite;
}

.status-dot.disconnected {
    background: #fa383e;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.toolbar {
    background: white;
    border-bottom: 1px solid #e1e5e9;
    padding: 10px 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.btn {
    padding: 6px 12px;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    background: white;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn:hover {
    background: #f6f8fa;
}

.btn-primary {
    background: #0969da;
    color: white;
    border-color: #0969da;
}

.btn-success {
    background: #1a7f37;
    color: white;
    border-color: #1a7f37;
}

.btn-danger {
    background: #cf222e;
    color: white;
    border-color: #cf222e;
}

.sheet-container {
    height: calc(100vh - 120px);
    overflow: auto;
    position: relative;
}

.sheet-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background: white;
}

.sheet-table th {
    background: #f6f8fa;
    border: 1px solid #d0d7de;
    padding: 8px;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
    min-width: 100px;
}

.sheet-table td {
    border: 1px solid #d0d7de;
    padding: 0;
    position: relative;
    min-width: 100px;
    height: 32px;
}

.sheet-cell {
    width: 100%;
    height: 100%;
    border: none;
    padding: 4px 8px;
    font-size: 13px;
    background: transparent;
    outline: none;
    display: block;
}

.sheet-cell:focus {
    background: white;
    box-shadow: inset 0 0 0 2px #0969da;
    z-index: 5;
    position: relative;
}

.sheet-cell.readonly {
    background: #f6f8fa;
    cursor: default;
}

.row-number {
    background: #f6f8fa !important;
    font-weight: 600;
    text-align: center;
    width: 50px;
    min-width: 50px;
    font-size: 11px;
    color: #656d76;
}

.selected-cell {
    background: #dbeafe !important;
}

.new-row {
    background: #f0fdf4 !important;
}

.modified-cell {
    background: #fef3c7 !important;
}

.error-cell {
    background: #fef2f2 !important;
}

.total-row {
    background: #f8fafc !important;
    font-weight: 600;
}

.total-row .sheet-cell {
    background: #f8fafc;
    font-weight: 600;
}

.context-menu {
    position: absolute;
    background: white;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    z-index: 1000;
    display: none;
    min-width: 150px;
}

.context-menu-item {
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    border-bottom: 1px solid #f6f8fa;
}

.context-menu-item:hover {
    background: #f6f8fa;
}

.context-menu-item:last-child {
    border-bottom: none;
}

.status-bar {
    background: white;
    border-top: 1px solid #e1e5e9;
    padding: 6px 20px;
    font-size: 12px;
    color: #656d76;
    display: flex;
    justify-content: between;
    align-items: center;
}

.formula-bar {
    background: white;
    border-bottom: 1px solid #e1e5e9;
    padding: 8px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
}

.formula-input {
    flex: 1;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 13px;
}

.cell-reference {
    font-weight: 600;
    min-width: 60px;
    color: #656d76;
}

@media (max-width: 768px) {
    .toolbar {
        padding: 8px 10px;
    }
    
    .header {
        padding: 10px 15px;
    }
    
    .sheet-table th,
    .sheet-table td {
        min-width: 80px;
    }
}
</style>
</head>
<body>

<div class="header">
    <h1>📊 실시간 후원 시트</h1>
    <div class="connection-status">
        <div class="status-dot" id="connectionDot"></div>
        <span id="connectionText">연결 중...</span>
        <span>|</span>
        <span>총 <strong id="totalRows">0</strong>건</span>
    </div>
</div>

<div class="formula-bar">
    <span class="cell-reference" id="cellReference">A1</span>
    <input type="text" class="formula-input" id="formulaInput" placeholder="값을 입력하세요...">
</div>

<div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">➕ 새 행 추가</button>
    <button class="btn btn-primary" onclick="saveSheet()">💾 저장</button>
    <button class="btn btn-danger" onclick="deleteSelectedRows()">🗑️ 선택 행 삭제</button>
    <div style="border-left: 1px solid #d0d7de; margin: 0 10px; height: 24px;"></div>
    <button class="btn" onclick="exportToExcel()">📊 엑셀 내보내기</button>
    <button class="btn" onclick="refreshSheet()">🔄 새로고침</button>
    <div style="flex: 1;"></div>
    <span class="status-bar">마지막 업데이트: <span id="lastUpdate">-</span></span>
</div>

<div class="sheet-container">
    <table class="sheet-table" id="sheetTable">
        <thead>
            <tr>
                <th class="row-number">#</th>
                <th>시간</th>
                <th>후원자</th>
                <th>스트리머</th>
                <th>타입</th>
                <th>금액</th>
                <th>메모</th>
                <th>상태</th>
            </tr>
        </thead>
        <tbody id="sheetBody">
            <tr>
                <td class="row-number">로딩중...</td>
                <td colspan="7" style="text-align: center; padding: 20px; color: #656d76;">
                    실시간 데이터를 불러오는 중...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 컨텍스트 메뉴 -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="editCell()">✏️ 편집</div>
    <div class="context-menu-item" onclick="copyCell()">📋 복사</div>
    <div class="context-menu-item" onclick="deleteRow()">🗑️ 행 삭제</div>
    <div class="context-menu-item" onclick="insertRowAbove()">⬆️ 위에 행 삽입</div>
    <div class="context-menu-item" onclick="insertRowBelow()">⬇️ 아래 행 삽입</div>
</div>

<script>
class DonationSheet {
    constructor() {
        this.socket = null;
        this.isConnected = false;
        this.donations = [];
        this.selectedCell = null;
        this.currentRow = null;
        this.currentCol = null;
        
        this.initializeRealtime();
        this.initializeEvents();
        this.renderSheet();
    }

    initializeRealtime() {
        try {
            this.socket = io();
            
            this.socket.on('connect', () => {
                this.isConnected = true;
                this.updateConnectionStatus();
                console.log('🔗 실시간 서버 연결됨');
            });

            this.socket.on('disconnect', () => {
                this.isConnected = false;
                this.updateConnectionStatus();
                console.log('❌ 실시간 서버 연결 끊어짐');
            });

            this.socket.on('initialData', (data) => {
                console.log('📊 초기 데이터 수신:', data);
                this.donations = data.donations || [];
                this.renderSheet();
            });

            this.socket.on('dataUpdate', (data) => {
                console.log('🔄 [엑셀시트] 실시간 데이터 업데이트 수신:', data);
                console.log('🔄 [엑셀시트] 현재 연결 상태:', this.isConnected);
                console.log('🔄 [엑셀시트] 수신된 후원 데이터:', data.donations?.length || 0, '건');
                
                this.donations = data.donations || [];
                console.log('📊 [엑셀시트] 새 데이터로 시트 업데이트:', this.donations.length, '건');
                this.renderSheet();
                this.highlightNewRows();
                
                // 실시간 업데이트 시각적 피드백
                const container = document.querySelector('.sheet-container');
                if (container) {
                    container.style.opacity = '0.8';
                    setTimeout(() => {
                        container.style.opacity = '1';
                    }, 300);
                }
            });

        } catch (error) {
            console.error('Socket.io 초기화 실패:', error);
            this.loadFromLocalStorage();
        }
    }

    updateConnectionStatus() {
        const dot = document.getElementById('connectionDot');
        const text = document.getElementById('connectionText');
        
        if (this.isConnected) {
            dot.classList.remove('disconnected');
            text.textContent = '실시간 연결됨';
            document.title = '🔴 실시간 후원 시트 (연결됨)';
        } else {
            dot.classList.add('disconnected');
            text.textContent = '연결 끊어짐';
            document.title = '⚪ 후원 시트 (로컬모드)';
        }
    }

    initializeEvents() {
        // 셀 클릭 이벤트
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('sheet-cell')) {
                this.selectCell(e.target);
            } else {
                this.hideContextMenu();
            }
        });

        // 우클릭 컨텍스트 메뉴
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('sheet-cell')) {
                e.preventDefault();
                this.showContextMenu(e);
            }
        });

        // 키보드 이벤트 (엑셀 스타일)
        document.addEventListener('keydown', (e) => {
            if (this.selectedCell) {
                this.handleKeyPress(e);
            }
        });

        // 수식 입력창
        document.getElementById('formulaInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                this.commitCellEdit();
            } else if (e.key === 'Escape') {
                this.cancelCellEdit();
            }
        });
        
        // 셀 변경 이벤트 리스너 추가
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('sheet-cell') && e.target.dataset.new === 'true') {
                this.handleNewRowChange(e.target);
            } else if (e.target.classList.contains('sheet-cell')) {
                this.handleCellChange(e.target);
            }
        });
    }

    renderSheet() {
        const tbody = document.getElementById('sheetBody');
        
        if (!this.donations || this.donations.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td class="row-number">1</td>
                    <td><input type="datetime-local" class="sheet-cell" data-field="time"></td>
                    <td><input type="text" class="sheet-cell" data-field="donor" placeholder="후원자명"></td>
                    <td><select class="sheet-cell" data-field="streamer">
                        <option value="">스트리머 선택</option>
                        <option value="엄삼용">🫅 엄삼용</option>
                        <option value="손덕배">🌺 손덕배</option>
                        <option value="연기">🐧 연기</option>
                        <option value="주옥">👺 주옥</option>
                        <option value="불곰">🎬 불곰</option>
                        <option value="이효팔">🏝 이효팔</option>
                        <option value="동동">😎 동동</option>
                        <option value="남붕">🤠 남붕</option>
                        <option value="옥긔">🦆 옥긔</option>
                        <option value="국고">🏦 국고</option>
                    </select></td>
                    <td><select class="sheet-cell" data-field="type">
                        <option value="계좌">계좌</option>
                        <option value="투네">투네</option>
                        <option value="슈퍼챗">슈퍼챗</option>
                    </select></td>
                    <td><input type="number" class="sheet-cell" data-field="amount" placeholder="0" step="0.1"></td>
                    <td><input type="text" class="sheet-cell" data-field="memo" placeholder="메모..."></td>
                    <td><span class="sheet-cell readonly">신규</span></td>
                </tr>
            `;
            document.getElementById('totalRows').textContent = '0';
            return;
        }

        let html = '';
        this.donations.forEach((donation, index) => {
            html += this.createTableRow(donation, index + 1);
        });

        // 새 행 추가
        html += this.createNewRow(this.donations.length + 1);

        // 총합 행
        const totalAmount = this.donations.reduce((sum, d) => sum + (parseFloat(d.amount) || 0), 0);
        html += `
            <tr class="total-row">
                <td class="row-number">합계</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">${this.donations.length}건</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">₩${totalAmount.toLocaleString()}</td>
                <td class="sheet-cell readonly">-</td>
                <td class="sheet-cell readonly">-</td>
            </tr>
        `;

        tbody.innerHTML = html;
        document.getElementById('totalRows').textContent = this.donations.length;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }

    createTableRow(donation, rowNum) {
        const time = new Date(donation.time);
        const timeString = time.toISOString().slice(0, 16); // YYYY-MM-DDTHH:mm
        
        return `
            <tr data-row="${rowNum}">
                <td class="row-number">${rowNum}</td>
                <td><input type="datetime-local" class="sheet-cell" data-field="time" value="${timeString}" data-id="${donation.time}"></td>
                <td><input type="text" class="sheet-cell" data-field="donor" value="${donation.donor}" data-id="${donation.time}"></td>
                <td><select class="sheet-cell" data-field="streamer" data-id="${donation.time}">
                    <option value="">스트리머 선택</option>
                    <option value="엄삼용" ${donation.streamer === '엄삼용' ? 'selected' : ''}>🫅 엄삼용</option>
                    <option value="손덕배" ${donation.streamer === '손덕배' ? 'selected' : ''}>🌺 손덕배</option>
                    <option value="연기" ${donation.streamer === '연기' ? 'selected' : ''}>🐧 연기</option>
                    <option value="주옥" ${donation.streamer === '주옥' ? 'selected' : ''}>👺 주옥</option>
                    <option value="불곰" ${donation.streamer === '불곰' ? 'selected' : ''}>🎬 불곰</option>
                    <option value="이효팔" ${donation.streamer === '이효팔' ? 'selected' : ''}>🏝 이효팔</option>
                    <option value="동동" ${donation.streamer === '동동' ? 'selected' : ''}>😎 동동</option>
                    <option value="남붕" ${donation.streamer === '남붕' ? 'selected' : ''}>🤠 남붕</option>
                    <option value="옥긔" ${donation.streamer === '옥긔' ? 'selected' : ''}>🦆 옥긔</option>
                    <option value="국고" ${donation.streamer === '국고' ? 'selected' : ''}>🏦 국고</option>
                </select></td>
                <td><select class="sheet-cell" data-field="type" data-id="${donation.time}">
                    <option value="계좌" ${donation.type === '계좌' ? 'selected' : ''}>계좌</option>
                    <option value="투네" ${donation.type === '투네' ? 'selected' : ''}>투네</option>
                    <option value="슈퍼챗" ${donation.type === '슈퍼챗' ? 'selected' : ''}>슈퍼챗</option>
                </select></td>
                <td><input type="number" class="sheet-cell" data-field="amount" value="${donation.amount}" step="0.1" data-id="${donation.time}"></td>
                <td><input type="text" class="sheet-cell" data-field="memo" value="${donation.memo || ''}" data-id="${donation.time}"></td>
                <td><span class="sheet-cell readonly">완료</span></td>
            </tr>
        `;
    }

    createNewRow(rowNum) {
        return `
            <tr class="new-row" data-row="${rowNum}">
                <td class="row-number">${rowNum}</td>
                <td><input type="datetime-local" class="sheet-cell" data-field="time" data-new="true"></td>
                <td><input type="text" class="sheet-cell" data-field="donor" placeholder="후원자명" data-new="true"></td>
                <td><select class="sheet-cell" data-field="streamer" data-new="true">
                    <option value="">스트리머 선택</option>
                    <option value="엄삼용">🫅 엄삼용</option>
                    <option value="손덕배">🌺 손덕배</option>
                    <option value="연기">🐧 연기</option>
                    <option value="주옥">👺 주옥</option>
                    <option value="불곰">🎬 불곰</option>
                    <option value="이효팔">🏝 이효팔</option>
                    <option value="동동">😎 동동</option>
                    <option value="남붕">🤠 남붕</option>
                    <option value="옥긔">🦆 옥긔</option>
                    <option value="국고">🏦 국고</option>
                </select></td>
                <td><select class="sheet-cell" data-field="type" data-new="true">
                    <option value="계좌">계좌</option>
                    <option value="투네">투네</option>
                    <option value="슈퍼챗">슈퍼챗</option>
                </select></td>
                <td><input type="number" class="sheet-cell" data-field="amount" placeholder="0" step="0.1" data-new="true"></td>
                <td><input type="text" class="sheet-cell" data-field="memo" placeholder="메모..." data-new="true"></td>
                <td><span class="sheet-cell readonly">신규</span></td>
            </tr>
        `;
    }

    handleKeyPress(e) {
        const cell = this.selectedCell;
        if (!cell) return;
        
        const row = cell.closest('tr');
        const cells = Array.from(row.children);
        const currentIndex = cells.indexOf(cell.parentNode);
        const rows = Array.from(row.parentNode.children);
        const rowIndex = rows.indexOf(row);
        
        switch(e.key) {
            case 'ArrowRight':
                e.preventDefault();
                if (currentIndex + 1 < cells.length) {
                    const nextCell = cells[currentIndex + 1].querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'ArrowLeft':
                e.preventDefault();
                if (currentIndex - 1 >= 1) { // Skip row number column
                    const prevCell = cells[currentIndex - 1].querySelector('.sheet-cell');
                    if (prevCell) this.selectCell(prevCell);
                }
                break;
                
            case 'ArrowDown':
                e.preventDefault();
                if (rowIndex + 1 < rows.length) {
                    const nextRow = rows[rowIndex + 1];
                    const nextCell = nextRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (rowIndex - 1 >= 0) {
                    const prevRow = rows[rowIndex - 1];
                    const prevCell = prevRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (prevCell) this.selectCell(prevCell);
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                this.commitCellEdit();
                // Move down to next row
                if (rowIndex + 1 < rows.length) {
                    const nextRow = rows[rowIndex + 1];
                    const nextCell = nextRow.children[currentIndex]?.querySelector('.sheet-cell');
                    if (nextCell) this.selectCell(nextCell);
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                this.cancelCellEdit();
                break;
                
            case 'Delete':
            case 'Backspace':
                e.preventDefault();
                this.clearCell();
                break;
                
            case 'F2':
                e.preventDefault();
                this.startCellEdit();
                break;
                
            default:
                // Start editing with typed character
                if (e.key.length === 1 && !e.ctrlKey && !e.altKey) {
                    this.startCellEdit(e.key);
                }
                break;
        }
    }

    selectCell(cell) {
        // 이전 선택 해제
        if (this.selectedCell) {
            this.selectedCell.classList.remove('selected-cell');
        }

        this.selectedCell = cell;
        cell.classList.add('selected-cell');

        // 셀 참조 업데이트
        const row = cell.closest('tr');
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);
        const cellIndex = Array.from(row.children).indexOf(cell.parentNode);
        
        const colName = String.fromCharCode(65 + cellIndex - 1); // A, B, C...
        document.getElementById('cellReference').textContent = colName + (rowIndex + 1);
        
        // 수식 입력창에 현재 값 표시
        const formulaInput = document.getElementById('formulaInput');
        formulaInput.value = cell.value || cell.textContent || '';
    }
    
    commitCellEdit() {
        const formulaInput = document.getElementById('formulaInput');
        const value = formulaInput.value;
        
        if (this.selectedCell) {
            // Update cell value
            if (this.selectedCell.tagName === 'INPUT') {
                this.selectedCell.value = value;
                // Trigger change event to save data
                this.selectedCell.dispatchEvent(new Event('change'));
            } else if (this.selectedCell.tagName === 'SELECT') {
                this.selectedCell.value = value;
                this.selectedCell.dispatchEvent(new Event('change'));
            } else {
                this.selectedCell.textContent = value;
            }
            
            // Mark as modified
            this.selectedCell.classList.add('modified-cell');
            setTimeout(() => {
                this.selectedCell.classList.remove('modified-cell');
            }, 1000);
            
            // Auto-save if connected
            this.saveChanges();
        }
    }
    
    cancelCellEdit() {
        const formulaInput = document.getElementById('formulaInput');
        if (this.selectedCell) {
            formulaInput.value = this.selectedCell.value || this.selectedCell.textContent || '';
        }
    }
    
    startCellEdit(initialValue = '') {
        if (this.selectedCell && !this.selectedCell.classList.contains('readonly')) {
            const formulaInput = document.getElementById('formulaInput');
            formulaInput.value = initialValue || this.selectedCell.value || this.selectedCell.textContent || '';
            formulaInput.focus();
            formulaInput.select();
        }
    }
    
    clearCell() {
        if (this.selectedCell && !this.selectedCell.classList.contains('readonly')) {
            if (this.selectedCell.tagName === 'INPUT') {
                this.selectedCell.value = '';
            } else if (this.selectedCell.tagName === 'SELECT') {
                this.selectedCell.selectedIndex = 0;
            } else {
                this.selectedCell.textContent = '';
            }
            
            const formulaInput = document.getElementById('formulaInput');
            formulaInput.value = '';
            
            this.selectedCell.classList.add('modified-cell');
            setTimeout(() => {
                this.selectedCell.classList.remove('modified-cell');
            }, 1000);
            
            this.saveChanges();
        }
    }
    
    async saveChanges() {
        // Collect all changes and save them
        if (this.isConnected) {
            try {
                // Auto-save functionality would go here
                console.log('✅ 변경사항 자동 저장됨');
            } catch (error) {
                console.error('저장 실패:', error);
            }
        } else {
            this.saveToLocalStorage();
        }
    }
    
    handleCellChange(cell) {
        // Handle existing row cell changes
        const donationId = cell.dataset.id;
        if (donationId) {
            const field = cell.dataset.field;
            const value = cell.value || cell.textContent;
            
            // Update local data
            const donation = this.donations.find(d => d.time === donationId);
            if (donation) {
                donation[field] = field === 'amount' ? parseFloat(value) || 0 : value;
                this.saveChanges();
            }
        }
    }
    
    handleNewRowChange(cell) {
        // Handle new row cell changes - auto-add when enough data is entered
        const row = cell.closest('tr');
        const donor = row.querySelector('[data-field="donor"]').value.trim();
        const streamer = row.querySelector('[data-field="streamer"]').value;
        const amount = parseFloat(row.querySelector('[data-field="amount"]').value) || 0;
        
        // Auto-add when we have donor, streamer, and amount
        if (donor && streamer && amount > 0) {
            this.addNewRow();
        }
    }

    async addNewRow() {
        const newRow = document.querySelector('.new-row');
        if (!newRow) return;

        const donor = newRow.querySelector('[data-field="donor"]').value.trim();
        const streamer = newRow.querySelector('[data-field="streamer"]').value;
        const type = newRow.querySelector('[data-field="type"]').value;
        const amount = parseFloat(newRow.querySelector('[data-field="amount"]').value) || 0;
        const memo = newRow.querySelector('[data-field="memo"]').value.trim();

        if (!donor || !streamer || amount <= 0) {
            alert('후원자명, 스트리머, 금액을 모두 입력해주세요!');
            return;
        }

        const newDonation = {
            donor,
            streamer,
            type,
            amount,
            memo,
            time: new Date().toISOString()
        };

        try {
            if (this.isConnected) {
                const response = await fetch('/api/donations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newDonation)
                });

                if (response.ok) {
                    console.log('✅ 새 후원 추가 성공');
                    // 서버에서 dataUpdate 이벤트로 자동 업데이트됨
                } else {
                    throw new Error('서버 저장 실패');
                }
            } else {
                // 로컬 저장
                this.donations.unshift(newDonation);
                this.renderSheet();
                this.saveToLocalStorage();
            }
        } catch (error) {
            console.error('후원 추가 실패:', error);
            alert('후원 추가에 실패했습니다.');
        }
    }

    highlightNewRows() {
        // 새로 추가된 행들을 잠시 하이라이트
        const rows = document.querySelectorAll('[data-row]');
        rows.forEach(row => {
            row.style.backgroundColor = '#f0fdf4';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 1000);
        });
    }

    showContextMenu(e) {
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }

    hideContextMenu() {
        document.getElementById('contextMenu').style.display = 'none';
    }

    loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem('donation_data');
            if (saved) {
                this.donations = JSON.parse(saved);
                this.renderSheet();
            }
        } catch (error) {
            console.error('로컬 저장소 로드 실패:', error);
        }
    }

    saveToLocalStorage() {
        try {
            localStorage.setItem('donation_data', JSON.stringify(this.donations));
        } catch (error) {
            console.error('로컬 저장소 저장 실패:', error);
        }
    }
    
    async deleteDonation(donationId) {
        try {
            if (this.isConnected && donationId) {
                const response = await fetch(`/api/donations/${donationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    console.log('✅ 후원 삭제 성공');
                    // 서버에서 dataUpdate 이벤트로 자동 업데이트됨
                } else {
                    throw new Error('서버 삭제 실패');
                }
            } else {
                // 로컬에서 삭제
                this.donations = this.donations.filter(d => d.time !== donationId);
                this.renderSheet();
                this.saveToLocalStorage();
            }
        } catch (error) {
            console.error('후원 삭제 실패:', error);
            alert('후원 삭제에 실패했습니다.');
        }
    }
}

// 전역 함수들
function addNewRow() {
    window.donationSheet.addNewRow();
}

async function saveSheet() {
    try {
        if (window.donationSheet.isConnected) {
            // 서버에 모든 변경사항 저장
            const response = await fetch('/api/donations/bulk', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ donations: window.donationSheet.donations })
            });
            
            if (response.ok) {
                alert('✅ 시트가 서버에 저장되었습니다.');
            } else {
                throw new Error('서버 저장 실패');
            }
        } else {
            // 로컬 저장
            window.donationSheet.saveToLocalStorage();
            alert('✅ 시트가 로컬에 저장되었습니다.');
        }
    } catch (error) {
        console.error('시트 저장 실패:', error);
        alert('❌ 시트 저장에 실패했습니다.');
    }
}

function deleteSelectedRows() {
    const selectedCells = document.querySelectorAll('.sheet-cell.selected-cell');
    if (selectedCells.length === 0) {
        alert('삭제할 행을 선택해주세요.');
        return;
    }
    
    if (confirm(`선택된 ${selectedCells.length}개 행을 삭제하시겠습니까?`)) {
        selectedCells.forEach(cell => {
            const donationId = cell.dataset.id;
            if (donationId) {
                window.donationSheet.deleteDonation(donationId);
            }
        });
    }
}

function exportToExcel() {
    // CSV 형태로 내보내기
    const csvContent = "data:text/csv;charset=utf-8," 
        + "시간,후원자,스트리머,타입,금액,메모\n"
        + window.donationSheet.donations.map(d => 
            `${d.time},${d.donor},${d.streamer},${d.type},${d.amount},"${d.memo || ''}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `후원데이터_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function refreshSheet() {
    window.donationSheet.renderSheet();
}

// 컨텍스트 메뉴 함수들
function editCell() {
    window.donationSheet.startCellEdit();
    window.donationSheet.hideContextMenu();
}

function copyCell() {
    if (window.donationSheet.selectedCell) {
        const value = window.donationSheet.selectedCell.value || window.donationSheet.selectedCell.textContent || '';
        navigator.clipboard.writeText(value).then(() => {
            console.log('✅ 셀 내용 복사됨:', value);
        }).catch(err => {
            console.error('복사 실패:', err);
        });
    }
    window.donationSheet.hideContextMenu();
}

function deleteRow() {
    if (window.donationSheet.selectedCell) {
        const row = window.donationSheet.selectedCell.closest('tr');
        if (row && !row.classList.contains('total-row') && !row.classList.contains('new-row')) {
            if (confirm('이 행을 삭제하시겠습니까?')) {
                const donationId = window.donationSheet.selectedCell.dataset.id;
                window.donationSheet.deleteDonation(donationId);
            }
        }
    }
    window.donationSheet.hideContextMenu();
}

function insertRowAbove() {
    window.donationSheet.addNewRow();
    window.donationSheet.hideContextMenu();
}

function insertRowBelow() {
    window.donationSheet.addNewRow();
    window.donationSheet.hideContextMenu();
}

// 앱 시작
document.addEventListener('DOMContentLoaded', () => {
    window.donationSheet = new DonationSheet();
});
</script>

</body>
</html>