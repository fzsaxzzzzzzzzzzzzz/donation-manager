<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>총액만 스트리머 오버레이</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}

.overlay-container {
    position: relative;
    margin: 20px auto;
    max-width: 600px;
    width: calc(100vw - 40px);
    min-width: 300px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 6px);
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 8px;
    text-align: center;
}


.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
    font-size: 16px;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255,255,255,0.7);
    font-size: 16px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.info-text {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    text-align: center;
    text-shadow: 1px 1px 0 #000000;
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="section-title" id="tableTitle">🏆 스트리머별 후원 현황 🏆</div>
    
    <table class="streamer-table">
        <thead>
            <tr>
                <th>순위</th>
                <th>스트리머</th>
                <th>총 후원</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="3" class="no-data">실시간 연결 중...</td>
            </tr>
        </tbody>
    </table>
    
    <div class="info-text">실시간으로 업데이트됩니다</div>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class TotalOnlyOverlay {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('✅ 총액만 오버레이 서버 연결됨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderTable();
            console.log('📊 초기 데이터 수신:', data.donations?.length || 0, '건');
        });

        this.socket.on('dataUpdate', (data) => {
            this.data = data;
            // 설정 데이터가 포함된 경우 설정도 업데이트
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            this.renderTable();
            console.log('🔄 데이터 업데이트:', data.donations?.length || 0, '건');
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderTable();
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS 변수 설정 (문자열을 숫자로 변환)
        const fontSize = parseInt(this.settings['table-font-size']) || 14;
        const numberSize = parseInt(this.settings['table-number-size']) || 16;
        const textColor = this.settings['table-text-color'] || 'white';
        const opacity = parseInt(this.settings['table-opacity']) || 85;
        
        root.style.setProperty('--table-font-size', fontSize + 'px');
        root.style.setProperty('--table-number-size', numberSize);
        root.style.setProperty('--table-text-color', textColor);
        root.style.setProperty('--table-opacity', opacity);
        
        console.log('🔧 총액만 오버레이 설정 적용됨:', { fontSize, numberSize, textColor, opacity });

        // 테이블 제목 (서버 설정 우선)
        const titleElement = document.getElementById('tableTitle');
        if (titleElement) {
            titleElement.textContent = this.settings.tableTitle || this.settings['table-title'] || '🏆 스트리머별 후원 현황 🏆';
        }
    }

    renderTable() {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // 스트리머별 총액 계산
        const streamerTotals = this.calculateStreamerTotals();
        
        if (streamerTotals.length === 0) {
            this.showNoData();
            return;
        }

        this.displayTable(streamerTotals);
    }

    calculateStreamerTotals() {
        const streamerData = {};
        
        // 스트리머 데이터 초기화 (국고 제외)
        (this.data.streamers || []).forEach(streamer => {
            if (streamer !== '국고' && streamer !== '후원자조정') {
                streamerData[streamer] = {
                    name: streamer,
                    total: 0,
                    emoji: this.data.emojis?.[streamer] || ''
                };
            }
        });

        // 후원 데이터 집계 (모든 타입 합산)
        (this.data.donations || []).forEach(donation => {
            if (streamerData[donation.streamer]) {
                const amountInWon = (parseFloat(donation.amount) || 0) * 10000; // 만원 → 원 변환
                streamerData[donation.streamer].total += amountInWon;
            }
        });

        // 총액 기준 정렬 (0원 스트리머도 포함)
        const sortedStreamers = Object.values(streamerData)
            .sort((a, b) => b.total - a.total);

        console.log('💰 계산된 스트리머 총액:', sortedStreamers.slice(0, 3).map(s => ({
            name: s.name,
            total: s.total
        })));

        return sortedStreamers;
    }

    displayTable(streamerTotals) {
        const tbody = document.getElementById('streamerTableBody');
        
        if (streamerTotals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="no-data">아직 후원이 없습니다.</td></tr>';
            return;
        }

        let html = '';
        streamerTotals.forEach((streamer, index) => {
            const rankNumber = index + 1;
            const rankClass = `rank-${rankNumber <= 3 ? rankNumber : 'other'}`;
            
            // 커스텀 순위 표시
            const rankDisplay = this.getRankDisplay(index);
            
            html += `<tr class="${rankClass}">`;
            html += `<td><span class="rank-number">${rankDisplay}</span></td>`;
            html += `<td class="streamer-name">${streamer.emoji} ${streamer.name}</td>`;
            html += `<td class="amount">${streamer.total.toLocaleString('ko-KR')}원</td>`;
            html += `</tr>`;
        });

        tbody.innerHTML = html;
        console.log('✅ 테이블 렌더링 완료:', streamerTotals.length, '명');
    }

    getRankDisplay(index) {
        const rankNumber = index + 1;
        
        // 디버깅: 순위명 설정 확인
        if (index === 0) {
            console.log('🏆 순위명 설정 확인:', {
                serverRankNames: this.settings.rankNames,
                localStorage1: localStorage.getItem('rank-1-name'),
                localStorage2: localStorage.getItem('rank-2-name'),
                localStorage3: localStorage.getItem('rank-3-name')
            });
        }
        
        // 서버 설정에서 순번명 확인 (우선)
        if (this.settings.rankNames && this.settings.rankNames[rankNumber]) {
            console.log(`📛 서버 설정 사용: ${rankNumber}위 = ${this.settings.rankNames[rankNumber]}`);
            return this.settings.rankNames[rankNumber].trim();
        }
        
        // 로컬 설정에서 순번명 확인 (백업)
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            console.log(`📛 로컬스토리지 사용: ${rankNumber}위 = ${customRankName}`);
            return customRankName.trim();
        }
        
        // 기본 순위명 (하드코딩된 이모지)
        const defaultRanks = ['👑왕자', '🤴귀족', '🧙‍♂️기사', '👨‍🌾농민', '🥺거지', '🐛벌레', '🐜개미', '💨먼지', '🪨흙'];
        const defaultRank = defaultRanks[index] || rankNumber.toString();
        console.log(`📛 기본 순위명 사용: ${rankNumber}위 = ${defaultRank}`);
        return defaultRank;
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="3" class="no-data">아직 후원이 없습니다.</td></tr>';
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="3" class="no-data">서버 연결이 끊어졌습니다...</td></tr>';
    }
}

// 앱 시작
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 총액만 오버레이 시작');
    window.totalOnlyOverlay = new TotalOnlyOverlay();
});
</script>

</body>
</html>