<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>총액만 스트리머 오버레이</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}


.overlay-container {
    position: relative;
    margin: 15px auto;
    max-width: 400px;
    width: calc(100vw - 30px);
    min-width: 280px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* 총액만 있을 때 더 좁은 너비 */
.overlay-container.total-only {
    max-width: 200px;
    min-width: 150px;
}

/* 2열 구조일 때 더 좁은 너비 */
.overlay-container.two-columns {
    max-width: 280px;
    min-width: 200px;
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 4px);
    font-weight: bold;
    margin-bottom: 12px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 6px;
    text-align: center;
}


.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 8px 6px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    height: 36px;
}

/* 순위 열 너비 */
.streamer-table th:first-child,
.streamer-table td:first-child {
    width: 50px;
    min-width: 50px;
}

/* 스트리머 열 너비 - 줄임 */
.streamer-table th:nth-child(2),
.streamer-table td:nth-child(2) {
    width: 80px;
    min-width: 80px;
}

/* 총 후원 열 - 나머지 공간 */
.streamer-table th:last-child,
.streamer-table td:last-child {
    width: auto;
}

/* 순위명 체크 해제시 2열 구조에서 스트리머 열 너비 */
.streamer-table th#rankHeader[style*="none"] ~ th:first-of-type,
.streamer-table td:first-child:not([colspan]) {
    width: 80px;
    min-width: 80px;
}

.streamer-table td {
    padding: 6px 6px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    height: 32px;
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
    font-size: 16px;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

/* 모든 애니메이션 완전 비활성화 */
*,
*::before,
*::after {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    will-change: auto !important;
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 30px 15px;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}
</style>
</head>
<body>


<div class="overlay-container">
    <div class="section-title" id="tableTitle">🏆 스트리머별 후원 현황 🏆</div>
    
    <table class="streamer-table">
        <thead>
            <tr id="tableHeader">
                <th id="rankHeader">순위</th>
                <th>스트리머</th>
                <th>총 후원</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="3" class="no-data">실시간 연결 중...</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class TotalOnlyOverlay {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        
        // 오버레이 전용 설정
        this.overlaySettings = {
            showRankNames: localStorage.getItem('total-overlay-showRankNames') === 'true',
            showEomsamyong: localStorage.getItem('total-overlay-showEomsamyong') === 'true',
            fixEomsamyongFirst: localStorage.getItem('total-overlay-fixEomsamyongFirst') === 'true',
            showOkgi: localStorage.getItem('total-overlay-showOkgi') === 'true',
            fixOkgiLast: localStorage.getItem('total-overlay-fixOkgiLast') === 'true',
            hideGukgo: localStorage.getItem('total-overlay-hideGukgo') === 'true',
            fixGukgoLast: localStorage.getItem('total-overlay-fixGukgoLast') === 'true',
            currency: localStorage.getItem('total-overlay-currency') || 'manwon'
        };
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('✅ 총액만 오버레이 서버 연결됨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderTable();
            console.log('📊 초기 데이터 수신:', data.donations?.length || 0, '건');
        });

        this.socket.on('dataUpdate', (data) => {
            this.data = data;
            // 설정 데이터가 포함된 경우 설정도 업데이트
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            this.renderTable();
            console.log('🔄 데이터 업데이트:', data.donations?.length || 0, '건');
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderTable();
        });

        // 총액 오버레이 전용 설정 업데이트 이벤트
        this.socket.on('totalOverlaySettingsUpdate', (overlaySettings) => {
            console.log('🔄 총액 오버레이 설정 업데이트 수신:', overlaySettings);
            
            // 서버에서 온 설정으로 오버레이 설정 업데이트
            Object.assign(this.overlaySettings, overlaySettings);
            
            // 로컬스토리지에도 저장
            Object.keys(overlaySettings).forEach(key => {
                localStorage.setItem(`total-overlay-${key}`, overlaySettings[key]);
            });
            
            // 설정 변경 후 테이블 다시 렌더링 (데이터가 있을 때만)
            if (this.data && this.data.donations && this.data.streamers) {
                this.renderTable();
                console.log('✅ 설정 적용 후 테이블 렌더링 완료');
            } else {
                console.log('⏳ 데이터 로드 후 설정이 적용될 예정');
            }
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS 변수 설정 (문자열을 숫자로 변환)
        const fontSize = parseInt(this.settings['table-font-size']) || 14;
        const numberSize = parseInt(this.settings['table-number-size']) || 16;
        const textColor = this.settings['table-text-color'] || 'white';
        const opacity = parseInt(this.settings['table-opacity']) || 85;
        
        root.style.setProperty('--table-font-size', fontSize + 'px');
        root.style.setProperty('--table-number-size', numberSize);
        root.style.setProperty('--table-text-color', textColor);
        root.style.setProperty('--table-opacity', opacity);
        
        console.log('🔧 총액만 오버레이 설정 적용됨:', { fontSize, numberSize, textColor, opacity });

        // 테이블 제목 (서버 설정 우선)
        const titleElement = document.getElementById('tableTitle');
        if (titleElement) {
            titleElement.textContent = this.settings.tableTitle || this.settings['table-title'] || '🏆 스트리머별 후원 현황 🏆';
        }
    }

    renderTable() {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // 스트리머별 총액 계산
        const streamerTotals = this.calculateStreamerTotals();
        
        if (streamerTotals.length === 0) {
            this.showNoData();
            return;
        }

        this.displayTable(streamerTotals);
    }

    calculateStreamerTotals() {
        const streamerData = {};
        
        // 스트리머 데이터 초기화
        (this.data.streamers || []).forEach(streamer => {
            // 국고 보이기 말기 설정에 따라 국고 제외/포함 결정
            const shouldSkip = (streamer === '후원자조정') || 
                              (this.overlaySettings.hideGukgo && streamer === '국고');
            
            if (!shouldSkip) {
                streamerData[streamer] = {
                    name: streamer,
                    total: 0,
                    emoji: this.data.emojis?.[streamer] || ''
                };
            }
        });

        // 후원 데이터 집계
        (this.data.donations || []).forEach(donation => {
            if (streamerData[donation.streamer]) {
                const amountInWon = (parseFloat(donation.amount) || 0) * 10000; // 만원 → 원 변환
                streamerData[donation.streamer].total += amountInWon;
            }
        });

        // 기본 정렬 (총액 기준)
        let sortedStreamers = Object.values(streamerData)
            .sort((a, b) => b.total - a.total);

        // 엄삼용 1등 고정 설정 적용
        if (this.overlaySettings.showEomsamyong && this.overlaySettings.fixEomsamyongFirst) {
            const eomsamyongIndex = sortedStreamers.findIndex(s => s.name === '엄삼용');
            if (eomsamyongIndex > 0) { // 1등이 아닐 때만
                const eomsamyong = sortedStreamers.splice(eomsamyongIndex, 1)[0];
                sortedStreamers.unshift(eomsamyong); // 맨 앞으로
            }
        }

        // 옥긔 꼴지 고정 설정 적용
        if (this.overlaySettings.showOkgi && this.overlaySettings.fixOkgiLast) {
            const okgiIndex = sortedStreamers.findIndex(s => s.name === '옥긔');
            if (okgiIndex >= 0 && okgiIndex < sortedStreamers.length - 1) { // 꼴지가 아닐 때만
                const okgi = sortedStreamers.splice(okgiIndex, 1)[0];
                sortedStreamers.push(okgi); // 맨 뒤로
            }
        }

        // 국고 꼴지 고정 설정 적용
        if (!this.overlaySettings.hideGukgo && this.overlaySettings.fixGukgoLast) {
            const gukgoIndex = sortedStreamers.findIndex(s => s.name === '국고');
            if (gukgoIndex >= 0 && gukgoIndex < sortedStreamers.length - 1) { // 꼴지가 아닐 때만
                const gukgo = sortedStreamers.splice(gukgoIndex, 1)[0];
                sortedStreamers.push(gukgo); // 맨 뒤로
            }
        }

        // 엄삼용 보이기 설정 적용
        if (!this.overlaySettings.showEomsamyong) {
            sortedStreamers = sortedStreamers.filter(s => s.name !== '엄삼용');
        }

        // 옥긔 보이기 설정 적용
        if (!this.overlaySettings.showOkgi) {
            sortedStreamers = sortedStreamers.filter(s => s.name !== '옥긔');
        }

        console.log('💰 계산된 스트리머 총액:', sortedStreamers.slice(0, 3).map(s => ({
            name: s.name,
            total: s.total
        })));

        return sortedStreamers;
    }

    displayTable(streamerTotals) {
        const tbody = document.getElementById('streamerTableBody');
        const rankHeader = document.getElementById('rankHeader');
        const showRanks = this.overlaySettings.showRankNames;
        const overlayContainer = document.querySelector('.overlay-container');
        
        // 순위 열 표시/숨김 처리 및 컨테이너 너비 조정
        if (showRanks) {
            rankHeader.style.display = '';
            overlayContainer.classList.remove('total-only', 'two-columns');
            // 3열 구조: 순위(50px) | 스트리머(80px) | 총 후원(auto)
        } else {
            rankHeader.style.display = 'none';
            overlayContainer.classList.remove('total-only');
            overlayContainer.classList.add('two-columns');
            // 2열 구조: 스트리머(80px) | 총 후원(auto)  
        }
        
        if (streamerTotals.length === 0) {
            const colSpan = showRanks ? '3' : '2';
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">아직 후원이 없습니다.</td></tr>`;
            // 데이터가 없을 때는 더 좁게
            overlayContainer.classList.add('total-only');
            overlayContainer.classList.remove('two-columns');
            return;
        }

        let html = '';
        streamerTotals.forEach((streamer, index) => {
            const rankNumber = index + 1;
            const rankClass = `rank-${rankNumber <= 3 ? rankNumber : 'other'}`;
            
            // 금액 표시 형식 결정
            let amountDisplay;
            if (this.overlaySettings.currency === 'won') {
                // 원 단위로 표시
                amountDisplay = `${streamer.total.toLocaleString('ko-KR')}원`;
            } else {
                // 만원 단위로 표시 (소수점 0 제거)
                const manwonAmount = streamer.total / 10000;
                const formattedAmount = manwonAmount % 1 === 0 ? Math.floor(manwonAmount).toLocaleString('ko-KR') : manwonAmount.toLocaleString('ko-KR');
                amountDisplay = `${formattedAmount}만원`;
            }
            
            html += `<tr class="${rankClass}">`;
            
            // 순위명 보이기가 체크된 경우에만 순위 열 표시
            if (showRanks) {
                const rankDisplay = this.getRankDisplay(index);
                html += `<td><span class="rank-number">${rankDisplay}</span></td>`;
            }
            
            html += `<td class="streamer-name">${streamer.emoji} ${streamer.name}</td>`;
            html += `<td class="amount">${amountDisplay}</td>`;
            html += `</tr>`;
        });

        tbody.innerHTML = html;
        console.log('✅ 테이블 렌더링 완료:', streamerTotals.length, '명');
    }

    getRankDisplay(index) {
        const rankNumber = index + 1;
        
        // 디버깅: 순위명 설정 확인
        if (index === 0) {
            console.log('🏆 순위명 설정 확인:', {
                serverRankNames: this.settings.rankNames,
                localStorage1: localStorage.getItem('rank-1-name'),
                localStorage2: localStorage.getItem('rank-2-name'),
                localStorage3: localStorage.getItem('rank-3-name')
            });
        }
        
        // 서버 설정에서 순번명 확인 (우선)
        if (this.settings.rankNames && this.settings.rankNames[rankNumber]) {
            console.log(`📛 서버 설정 사용: ${rankNumber}위 = ${this.settings.rankNames[rankNumber]}`);
            return this.settings.rankNames[rankNumber].trim();
        }
        
        // 로컬 설정에서 순번명 확인 (백업)
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            console.log(`📛 로컬스토리지 사용: ${rankNumber}위 = ${customRankName}`);
            return customRankName.trim();
        }
        
        // 기본 순위명 (하드코딩된 이모지)
        const defaultRanks = ['👑왕자', '🤴귀족', '🧙‍♂️기사', '👨‍🌾농민', '🥺거지', '🐛벌레', '🐜개미', '💨먼지', '🪨흙'];
        const defaultRank = defaultRanks[index] || rankNumber.toString();
        console.log(`📛 기본 순위명 사용: ${rankNumber}위 = ${defaultRank}`);
        return defaultRank;
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        const overlayContainer = document.querySelector('.overlay-container');
        const showRanks = this.overlaySettings.showRankNames;
        const colSpan = showRanks ? '3' : '2';
        
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">아직 후원이 없습니다.</td></tr>`;
        
        // 데이터가 없을 때는 더 좁게
        overlayContainer.classList.add('total-only');
        overlayContainer.classList.remove('two-columns');
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        const overlayContainer = document.querySelector('.overlay-container');
        const showRanks = this.overlaySettings.showRankNames;
        const colSpan = showRanks ? '3' : '2';
        
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">서버 연결이 끊어졌습니다...</td></tr>`;
        
        // 연결이 끊어졌을 때도 더 좁게
        overlayContainer.classList.add('total-only');
        overlayContainer.classList.remove('two-columns');
    }
}

// 앱 시작
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 총액만 오버레이 시작');
    window.totalOnlyOverlay = new TotalOnlyOverlay();
});
</script>

</body>
</html>