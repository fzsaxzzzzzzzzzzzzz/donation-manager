<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì´ì•¡ë§Œ ìŠ¤íŠ¸ë¦¬ë¨¸ ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}

.overlay-container {
    position: relative;
    margin: 20px auto;
    max-width: 600px;
    width: calc(100vw - 40px);
    min-width: 300px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 6px);
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 8px;
    text-align: center;
}


.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
    font-size: 16px;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255,255,255,0.7);
    font-size: 16px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.info-text {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    text-align: center;
    text-shadow: 1px 1px 0 #000000;
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="section-title" id="tableTitle">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</div>
    
    <table class="streamer-table">
        <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                <th>ì´ í›„ì›</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="3" class="no-data">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</td>
            </tr>
        </tbody>
    </table>
    
    <div class="info-text">ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</div>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class TotalOnlyOverlay {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('âœ… ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„œë²„ ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderTable();
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
        });

        this.socket.on('dataUpdate', (data) => {
            this.data = data;
            // ì„¤ì • ë°ì´í„°ê°€ í¬í•¨ëœ ê²½ìš° ì„¤ì •ë„ ì—…ë°ì´íŠ¸
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            this.renderTable();
            console.log('ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸:', data.donations?.length || 0, 'ê±´');
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderTable();
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS ë³€ìˆ˜ ì„¤ì • (ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜)
        const fontSize = parseInt(this.settings['table-font-size']) || 14;
        const numberSize = parseInt(this.settings['table-number-size']) || 16;
        const textColor = this.settings['table-text-color'] || 'white';
        const opacity = parseInt(this.settings['table-opacity']) || 85;
        
        root.style.setProperty('--table-font-size', fontSize + 'px');
        root.style.setProperty('--table-number-size', numberSize);
        root.style.setProperty('--table-text-color', textColor);
        root.style.setProperty('--table-opacity', opacity);
        
        console.log('ğŸ”§ ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„¤ì • ì ìš©ë¨:', { fontSize, numberSize, textColor, opacity });

        // í…Œì´ë¸” ì œëª© (ì„œë²„ ì„¤ì • ìš°ì„ )
        const titleElement = document.getElementById('tableTitle');
        if (titleElement) {
            titleElement.textContent = this.settings.tableTitle || this.settings['table-title'] || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
        }
    }

    renderTable() {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡ ê³„ì‚°
        const streamerTotals = this.calculateStreamerTotals();
        
        if (streamerTotals.length === 0) {
            this.showNoData();
            return;
        }

        this.displayTable(streamerTotals);
    }

    calculateStreamerTotals() {
        const streamerData = {};
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ ë°ì´í„° ì´ˆê¸°í™” (êµ­ê³  ì œì™¸)
        (this.data.streamers || []).forEach(streamer => {
            if (streamer !== 'êµ­ê³ ' && streamer !== 'í›„ì›ìì¡°ì •') {
                streamerData[streamer] = {
                    name: streamer,
                    total: 0,
                    emoji: this.data.emojis?.[streamer] || ''
                };
            }
        });

        // í›„ì› ë°ì´í„° ì§‘ê³„ (ëª¨ë“  íƒ€ì… í•©ì‚°)
        (this.data.donations || []).forEach(donation => {
            if (streamerData[donation.streamer]) {
                const amountInWon = (parseFloat(donation.amount) || 0) * 10000; // ë§Œì› â†’ ì› ë³€í™˜
                streamerData[donation.streamer].total += amountInWon;
            }
        });

        // ì´ì•¡ ê¸°ì¤€ ì •ë ¬ (0ì› ìŠ¤íŠ¸ë¦¬ë¨¸ë„ í¬í•¨)
        const sortedStreamers = Object.values(streamerData)
            .sort((a, b) => b.total - a.total);

        console.log('ğŸ’° ê³„ì‚°ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡:', sortedStreamers.slice(0, 3).map(s => ({
            name: s.name,
            total: s.total
        })));

        return sortedStreamers;
    }

    displayTable(streamerTotals) {
        const tbody = document.getElementById('streamerTableBody');
        
        if (streamerTotals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        let html = '';
        streamerTotals.forEach((streamer, index) => {
            const rankNumber = index + 1;
            const rankClass = `rank-${rankNumber <= 3 ? rankNumber : 'other'}`;
            
            // ì»¤ìŠ¤í…€ ìˆœìœ„ í‘œì‹œ
            const rankDisplay = this.getRankDisplay(index);
            
            html += `<tr class="${rankClass}">`;
            html += `<td><span class="rank-number">${rankDisplay}</span></td>`;
            html += `<td class="streamer-name">${streamer.emoji} ${streamer.name}</td>`;
            html += `<td class="amount">${streamer.total.toLocaleString('ko-KR')}ì›</td>`;
            html += `</tr>`;
        });

        tbody.innerHTML = html;
        console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ:', streamerTotals.length, 'ëª…');
    }

    getRankDisplay(index) {
        const rankNumber = index + 1;
        
        // ë””ë²„ê¹…: ìˆœìœ„ëª… ì„¤ì • í™•ì¸
        if (index === 0) {
            console.log('ğŸ† ìˆœìœ„ëª… ì„¤ì • í™•ì¸:', {
                serverRankNames: this.settings.rankNames,
                localStorage1: localStorage.getItem('rank-1-name'),
                localStorage2: localStorage.getItem('rank-2-name'),
                localStorage3: localStorage.getItem('rank-3-name')
            });
        }
        
        // ì„œë²„ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ìš°ì„ )
        if (this.settings.rankNames && this.settings.rankNames[rankNumber]) {
            console.log(`ğŸ“› ì„œë²„ ì„¤ì • ì‚¬ìš©: ${rankNumber}ìœ„ = ${this.settings.rankNames[rankNumber]}`);
            return this.settings.rankNames[rankNumber].trim();
        }
        
        // ë¡œì»¬ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ë°±ì—…)
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            console.log(`ğŸ“› ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©: ${rankNumber}ìœ„ = ${customRankName}`);
            return customRankName.trim();
        }
        
        // ê¸°ë³¸ ìˆœìœ„ëª… (í•˜ë“œì½”ë”©ëœ ì´ëª¨ì§€)
        const defaultRanks = ['ğŸ‘‘ì™•ì', 'ğŸ¤´ê·€ì¡±', 'ğŸ§™â€â™‚ï¸ê¸°ì‚¬', 'ğŸ‘¨â€ğŸŒ¾ë†ë¯¼', 'ğŸ¥ºê±°ì§€', 'ğŸ›ë²Œë ˆ', 'ğŸœê°œë¯¸', 'ğŸ’¨ë¨¼ì§€', 'ğŸª¨í™'];
        const defaultRank = defaultRanks[index] || rankNumber.toString();
        console.log(`ğŸ“› ê¸°ë³¸ ìˆœìœ„ëª… ì‚¬ìš©: ${rankNumber}ìœ„ = ${defaultRank}`);
        return defaultRank;
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="3" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        tbody.innerHTML = '<tr><td colspan="3" class="no-data">ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤...</td></tr>';
    }
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì‹œì‘');
    window.totalOnlyOverlay = new TotalOnlyOverlay();
});
</script>

</body>
</html>