<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì´ì•¡ë§Œ ìŠ¤íŠ¸ë¦¬ë¨¸ ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}


.overlay-container {
    position: relative;
    margin: 15px auto;
    max-width: 400px;
    width: calc(100vw - 30px);
    min-width: 280px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* ì´ì•¡ë§Œ ìˆì„ ë•Œ ë” ì¢ì€ ë„ˆë¹„ */
.overlay-container.total-only {
    max-width: 200px;
    min-width: 150px;
}

/* 2ì—´ êµ¬ì¡°ì¼ ë•Œ ë” ì¢ì€ ë„ˆë¹„ */
.overlay-container.two-columns {
    max-width: 280px;
    min-width: 200px;
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 4px);
    font-weight: bold;
    margin-bottom: 12px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 6px;
    text-align: center;
}


.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 0;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 8px 6px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    height: 36px;
}

/* ìˆœìœ„ ì—´ ë„ˆë¹„ */
.streamer-table th:first-child,
.streamer-table td:first-child {
    width: 50px;
    min-width: 50px;
}

/* ìŠ¤íŠ¸ë¦¬ë¨¸ ì—´ ë„ˆë¹„ - ì¤„ì„ */
.streamer-table th:nth-child(2),
.streamer-table td:nth-child(2) {
    width: 80px;
    min-width: 80px;
}

/* ì´ í›„ì› ì—´ - ë‚˜ë¨¸ì§€ ê³µê°„ */
.streamer-table th:last-child,
.streamer-table td:last-child {
    width: auto;
}

/* ìˆœìœ„ëª… ì²´í¬ í•´ì œì‹œ 2ì—´ êµ¬ì¡°ì—ì„œ ìŠ¤íŠ¸ë¦¬ë¨¸ ì—´ ë„ˆë¹„ */
.streamer-table th#rankHeader[style*="none"] ~ th:first-of-type,
.streamer-table td:first-child:not([colspan]) {
    width: 80px;
    min-width: 80px;
}

.streamer-table td {
    padding: 6px 6px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    height: 32px;
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
    font-size: 16px;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

/* ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ë¹„í™œì„±í™” */
*,
*::before,
*::after {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    will-change: auto !important;
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 30px 15px;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}
</style>
</head>
<body>


<div class="overlay-container">
    <div class="section-title" id="tableTitle">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</div>
    
    <table class="streamer-table">
        <thead>
            <tr id="tableHeader">
                <th id="rankHeader">ìˆœìœ„</th>
                <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                <th>ì´ í›„ì›</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="3" class="no-data">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class TotalOnlyOverlay {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        
        // ì˜¤ë²„ë ˆì´ ì „ìš© ì„¤ì •
        this.overlaySettings = {
            showRankNames: localStorage.getItem('total-overlay-showRankNames') === 'true',
            showEomsamyong: localStorage.getItem('total-overlay-showEomsamyong') === 'true',
            fixEomsamyongFirst: localStorage.getItem('total-overlay-fixEomsamyongFirst') === 'true',
            showOkgi: localStorage.getItem('total-overlay-showOkgi') === 'true',
            fixOkgiLast: localStorage.getItem('total-overlay-fixOkgiLast') === 'true',
            hideGukgo: localStorage.getItem('total-overlay-hideGukgo') === 'true',
            fixGukgoLast: localStorage.getItem('total-overlay-fixGukgoLast') === 'true',
            currency: localStorage.getItem('total-overlay-currency') || 'manwon'
        };
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('âœ… ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„œë²„ ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderTable();
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
        });

        this.socket.on('dataUpdate', (data) => {
            this.data = data;
            // ì„¤ì • ë°ì´í„°ê°€ í¬í•¨ëœ ê²½ìš° ì„¤ì •ë„ ì—…ë°ì´íŠ¸
            if (data.settings) {
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            this.renderTable();
            console.log('ğŸ”„ ë°ì´í„° ì—…ë°ì´íŠ¸:', data.donations?.length || 0, 'ê±´');
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderTable();
        });

        // ì´ì•¡ ì˜¤ë²„ë ˆì´ ì „ìš© ì„¤ì • ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        this.socket.on('totalOverlaySettingsUpdate', (overlaySettings) => {
            console.log('ğŸ”„ ì´ì•¡ ì˜¤ë²„ë ˆì´ ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', overlaySettings);
            
            // ì„œë²„ì—ì„œ ì˜¨ ì„¤ì •ìœ¼ë¡œ ì˜¤ë²„ë ˆì´ ì„¤ì • ì—…ë°ì´íŠ¸
            Object.assign(this.overlaySettings, overlaySettings);
            
            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥
            Object.keys(overlaySettings).forEach(key => {
                localStorage.setItem(`total-overlay-${key}`, overlaySettings[key]);
            });
            
            // ì„¤ì • ë³€ê²½ í›„ í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§ (ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ)
            if (this.data && this.data.donations && this.data.streamers) {
                this.renderTable();
                console.log('âœ… ì„¤ì • ì ìš© í›„ í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ');
            } else {
                console.log('â³ ë°ì´í„° ë¡œë“œ í›„ ì„¤ì •ì´ ì ìš©ë  ì˜ˆì •');
            }
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS ë³€ìˆ˜ ì„¤ì • (ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜)
        const fontSize = parseInt(this.settings['table-font-size']) || 14;
        const numberSize = parseInt(this.settings['table-number-size']) || 16;
        const textColor = this.settings['table-text-color'] || 'white';
        const opacity = parseInt(this.settings['table-opacity']) || 85;
        
        root.style.setProperty('--table-font-size', fontSize + 'px');
        root.style.setProperty('--table-number-size', numberSize);
        root.style.setProperty('--table-text-color', textColor);
        root.style.setProperty('--table-opacity', opacity);
        
        console.log('ğŸ”§ ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì„¤ì • ì ìš©ë¨:', { fontSize, numberSize, textColor, opacity });

        // í…Œì´ë¸” ì œëª© (ì„œë²„ ì„¤ì • ìš°ì„ )
        const titleElement = document.getElementById('tableTitle');
        if (titleElement) {
            titleElement.textContent = this.settings.tableTitle || this.settings['table-title'] || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
        }
    }

    renderTable() {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì´ì•¡ ê³„ì‚°
        const streamerTotals = this.calculateStreamerTotals();
        
        if (streamerTotals.length === 0) {
            this.showNoData();
            return;
        }

        this.displayTable(streamerTotals);
    }

    calculateStreamerTotals() {
        const streamerData = {};
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ ë°ì´í„° ì´ˆê¸°í™”
        (this.data.streamers || []).forEach(streamer => {
            // êµ­ê³  ë³´ì´ê¸° ë§ê¸° ì„¤ì •ì— ë”°ë¼ êµ­ê³  ì œì™¸/í¬í•¨ ê²°ì •
            const shouldSkip = (streamer === 'í›„ì›ìì¡°ì •') || 
                              (this.overlaySettings.hideGukgo && streamer === 'êµ­ê³ ');
            
            if (!shouldSkip) {
                streamerData[streamer] = {
                    name: streamer,
                    total: 0,
                    emoji: this.data.emojis?.[streamer] || ''
                };
            }
        });

        // í›„ì› ë°ì´í„° ì§‘ê³„
        (this.data.donations || []).forEach(donation => {
            if (streamerData[donation.streamer]) {
                const amountInWon = (parseFloat(donation.amount) || 0) * 10000; // ë§Œì› â†’ ì› ë³€í™˜
                streamerData[donation.streamer].total += amountInWon;
            }
        });

        // ê¸°ë³¸ ì •ë ¬ (ì´ì•¡ ê¸°ì¤€)
        let sortedStreamers = Object.values(streamerData)
            .sort((a, b) => b.total - a.total);

        // ì—„ì‚¼ìš© 1ë“± ê³ ì • ì„¤ì • ì ìš©
        if (this.overlaySettings.showEomsamyong && this.overlaySettings.fixEomsamyongFirst) {
            const eomsamyongIndex = sortedStreamers.findIndex(s => s.name === 'ì—„ì‚¼ìš©');
            if (eomsamyongIndex > 0) { // 1ë“±ì´ ì•„ë‹ ë•Œë§Œ
                const eomsamyong = sortedStreamers.splice(eomsamyongIndex, 1)[0];
                sortedStreamers.unshift(eomsamyong); // ë§¨ ì•ìœ¼ë¡œ
            }
        }

        // ì˜¥ê¸” ê¼´ì§€ ê³ ì • ì„¤ì • ì ìš©
        if (this.overlaySettings.showOkgi && this.overlaySettings.fixOkgiLast) {
            const okgiIndex = sortedStreamers.findIndex(s => s.name === 'ì˜¥ê¸”');
            if (okgiIndex >= 0 && okgiIndex < sortedStreamers.length - 1) { // ê¼´ì§€ê°€ ì•„ë‹ ë•Œë§Œ
                const okgi = sortedStreamers.splice(okgiIndex, 1)[0];
                sortedStreamers.push(okgi); // ë§¨ ë’¤ë¡œ
            }
        }

        // êµ­ê³  ê¼´ì§€ ê³ ì • ì„¤ì • ì ìš©
        if (!this.overlaySettings.hideGukgo && this.overlaySettings.fixGukgoLast) {
            const gukgoIndex = sortedStreamers.findIndex(s => s.name === 'êµ­ê³ ');
            if (gukgoIndex >= 0 && gukgoIndex < sortedStreamers.length - 1) { // ê¼´ì§€ê°€ ì•„ë‹ ë•Œë§Œ
                const gukgo = sortedStreamers.splice(gukgoIndex, 1)[0];
                sortedStreamers.push(gukgo); // ë§¨ ë’¤ë¡œ
            }
        }

        // ì—„ì‚¼ìš© ë³´ì´ê¸° ì„¤ì • ì ìš©
        if (!this.overlaySettings.showEomsamyong) {
            sortedStreamers = sortedStreamers.filter(s => s.name !== 'ì—„ì‚¼ìš©');
        }

        // ì˜¥ê¸” ë³´ì´ê¸° ì„¤ì • ì ìš©
        if (!this.overlaySettings.showOkgi) {
            sortedStreamers = sortedStreamers.filter(s => s.name !== 'ì˜¥ê¸”');
        }

        console.log('ğŸ’° ê³„ì‚°ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ ì´ì•¡:', sortedStreamers.slice(0, 3).map(s => ({
            name: s.name,
            total: s.total
        })));

        return sortedStreamers;
    }

    displayTable(streamerTotals) {
        const tbody = document.getElementById('streamerTableBody');
        const rankHeader = document.getElementById('rankHeader');
        const showRanks = this.overlaySettings.showRankNames;
        const overlayContainer = document.querySelector('.overlay-container');
        
        // ìˆœìœ„ ì—´ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬ ë° ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ì¡°ì •
        if (showRanks) {
            rankHeader.style.display = '';
            overlayContainer.classList.remove('total-only', 'two-columns');
            // 3ì—´ êµ¬ì¡°: ìˆœìœ„(50px) | ìŠ¤íŠ¸ë¦¬ë¨¸(80px) | ì´ í›„ì›(auto)
        } else {
            rankHeader.style.display = 'none';
            overlayContainer.classList.remove('total-only');
            overlayContainer.classList.add('two-columns');
            // 2ì—´ êµ¬ì¡°: ìŠ¤íŠ¸ë¦¬ë¨¸(80px) | ì´ í›„ì›(auto)  
        }
        
        if (streamerTotals.length === 0) {
            const colSpan = showRanks ? '3' : '2';
            tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            // ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ë” ì¢ê²Œ
            overlayContainer.classList.add('total-only');
            overlayContainer.classList.remove('two-columns');
            return;
        }

        let html = '';
        streamerTotals.forEach((streamer, index) => {
            const rankNumber = index + 1;
            const rankClass = `rank-${rankNumber <= 3 ? rankNumber : 'other'}`;
            
            // ê¸ˆì•¡ í‘œì‹œ í˜•ì‹ ê²°ì •
            let amountDisplay;
            if (this.overlaySettings.currency === 'won') {
                // ì› ë‹¨ìœ„ë¡œ í‘œì‹œ
                amountDisplay = `${streamer.total.toLocaleString('ko-KR')}ì›`;
            } else {
                // ë§Œì› ë‹¨ìœ„ë¡œ í‘œì‹œ (ì†Œìˆ˜ì  0 ì œê±°)
                const manwonAmount = streamer.total / 10000;
                const formattedAmount = manwonAmount % 1 === 0 ? Math.floor(manwonAmount).toLocaleString('ko-KR') : manwonAmount.toLocaleString('ko-KR');
                amountDisplay = `${formattedAmount}ë§Œì›`;
            }
            
            html += `<tr class="${rankClass}">`;
            
            // ìˆœìœ„ëª… ë³´ì´ê¸°ê°€ ì²´í¬ëœ ê²½ìš°ì—ë§Œ ìˆœìœ„ ì—´ í‘œì‹œ
            if (showRanks) {
                const rankDisplay = this.getRankDisplay(index);
                html += `<td><span class="rank-number">${rankDisplay}</span></td>`;
            }
            
            html += `<td class="streamer-name">${streamer.emoji} ${streamer.name}</td>`;
            html += `<td class="amount">${amountDisplay}</td>`;
            html += `</tr>`;
        });

        tbody.innerHTML = html;
        console.log('âœ… í…Œì´ë¸” ë Œë”ë§ ì™„ë£Œ:', streamerTotals.length, 'ëª…');
    }

    getRankDisplay(index) {
        const rankNumber = index + 1;
        
        // ë””ë²„ê¹…: ìˆœìœ„ëª… ì„¤ì • í™•ì¸
        if (index === 0) {
            console.log('ğŸ† ìˆœìœ„ëª… ì„¤ì • í™•ì¸:', {
                serverRankNames: this.settings.rankNames,
                localStorage1: localStorage.getItem('rank-1-name'),
                localStorage2: localStorage.getItem('rank-2-name'),
                localStorage3: localStorage.getItem('rank-3-name')
            });
        }
        
        // ì„œë²„ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ìš°ì„ )
        if (this.settings.rankNames && this.settings.rankNames[rankNumber]) {
            console.log(`ğŸ“› ì„œë²„ ì„¤ì • ì‚¬ìš©: ${rankNumber}ìœ„ = ${this.settings.rankNames[rankNumber]}`);
            return this.settings.rankNames[rankNumber].trim();
        }
        
        // ë¡œì»¬ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ë°±ì—…)
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            console.log(`ğŸ“› ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©: ${rankNumber}ìœ„ = ${customRankName}`);
            return customRankName.trim();
        }
        
        // ê¸°ë³¸ ìˆœìœ„ëª… (í•˜ë“œì½”ë”©ëœ ì´ëª¨ì§€)
        const defaultRanks = ['ğŸ‘‘ì™•ì', 'ğŸ¤´ê·€ì¡±', 'ğŸ§™â€â™‚ï¸ê¸°ì‚¬', 'ğŸ‘¨â€ğŸŒ¾ë†ë¯¼', 'ğŸ¥ºê±°ì§€', 'ğŸ›ë²Œë ˆ', 'ğŸœê°œë¯¸', 'ğŸ’¨ë¨¼ì§€', 'ğŸª¨í™'];
        const defaultRank = defaultRanks[index] || rankNumber.toString();
        console.log(`ğŸ“› ê¸°ë³¸ ìˆœìœ„ëª… ì‚¬ìš©: ${rankNumber}ìœ„ = ${defaultRank}`);
        return defaultRank;
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        const overlayContainer = document.querySelector('.overlay-container');
        const showRanks = this.overlaySettings.showRankNames;
        const colSpan = showRanks ? '3' : '2';
        
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        
        // ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” ë” ì¢ê²Œ
        overlayContainer.classList.add('total-only');
        overlayContainer.classList.remove('two-columns');
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        const overlayContainer = document.querySelector('.overlay-container');
        const showRanks = this.overlaySettings.showRankNames;
        const colSpan = showRanks ? '3' : '2';
        
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="no-data">ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤...</td></tr>`;
        
        // ì—°ê²°ì´ ëŠì–´ì¡Œì„ ë•Œë„ ë” ì¢ê²Œ
        overlayContainer.classList.add('total-only');
        overlayContainer.classList.remove('two-columns');
    }
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸš€ ì´ì•¡ë§Œ ì˜¤ë²„ë ˆì´ ì‹œì‘');
    window.totalOnlyOverlay = new TotalOnlyOverlay();
});
</script>

</body>
</html>