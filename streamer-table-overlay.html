<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: transparent;
    color: var(--table-text-color, white);
    overflow: hidden;
    font-size: var(--table-font-size, 14px);
}

.overlay-container {
    position: relative;
    margin: 20px auto;
    max-width: 800px;
    width: calc(100vw - 40px);
    min-width: 400px;
    background: rgba(0, 0, 0, calc(var(--table-opacity, 85) / 100));
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease-in-out;
}

.section-title {
    font-size: calc(var(--table-font-size, 14px) + 6px);
    font-weight: bold;
    margin-bottom: 15px;
    color: #FFD700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    border-bottom: 2px solid #FFD700;
    padding-bottom: 8px;
    text-align: center;
}

.update-time {
    text-align: center;
    font-size: calc(var(--table-font-size, 14px) - 2px);
    color: rgba(255,255,255,0.7);
    margin-bottom: 10px;
    text-shadow: 1px 1px 0 #000000;
}

.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

.streamer-table th {
    background: rgba(255,215,0,0.2);
    color: #FFD700;
    padding: 12px 8px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #FFD700;
    font-size: var(--table-font-size, 14px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.streamer-table td {
    padding: 10px 8px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: var(--table-font-size, 14px);
    color: var(--table-text-color, white);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    transition: background-color 0.3s ease;
}

.streamer-table tr:nth-child(even) {
    background: rgba(255,255,255,0.05);
}

/* í•˜ì´ë¼ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ ì œê±°ë¨ */

.rank-number {
    font-weight: bold;
    color: #FFD700;
    font-size: calc(var(--table-number-size, 16px) * 1px);
}

.rank-1 .rank-number { color: #FFD700; }
.rank-2 .rank-number { color: #C0C0C0; }
.rank-3 .rank-number { color: #CD7F32; }

.streamer-name {
    font-weight: 600;
}

.amount {
    font-weight: bold;
    color: #42b72a;
}

.donation-count {
    font-size: calc(var(--table-font-size, 14px) - 1px);
    opacity: 0.9;
}

.total-summary {
    text-align: center;
    font-size: calc(var(--table-font-size, 14px) + 2px);
    font-weight: bold;
    color: #FFD700;
    background: rgba(255,215,0,0.1);
    padding: 10px;
    border-radius: 8px;
    border: 2px solid #FFD700;
    margin-bottom: 15px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

.info-text {
    font-size: calc(var(--table-font-size, 14px) - 2px);
    color: rgba(255,255,255,0.7);
    margin-bottom: 10px;
    text-align: center;
    text-shadow: 1px 1px 0 #000000;
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    animation: pulse 2s infinite;
    box-shadow: 0 0 10px rgba(66, 183, 42, 0.5);
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
    box-shadow: 0 0 10px rgba(250, 56, 62, 0.5);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255,255,255,0.7);
    font-size: calc(var(--table-font-size, 14px) + 2px);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
}

/* ì´ì•¡ë§Œ ëª¨ë“œì—ì„œ í…Œì´ë¸” ì—´ ìˆ¨ê¸°ê¸° */
.total-only-mode .streamer-table th:nth-child(3),
.total-only-mode .streamer-table th:nth-child(4),
.total-only-mode .streamer-table td:nth-child(3),
.total-only-mode .streamer-table td:nth-child(4) {
    display: none;
}

.total-only-mode .streamer-table th:nth-child(5),
.total-only-mode .streamer-table td:nth-child(5) {
    width: 40%;
}
</style>
</head>
<body>

<div class="overlay-container" id="overlayContainer">
    <div class="section-title" id="tableTitle">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</div>
    
    <div class="update-time" id="updateTime" style="display: none;">
        ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span>
    </div>
    
    <div class="total-summary" id="totalSummary" style="display: none;">
        ì´ í›„ì›ì•¡: â‚©0 (0ê±´)
    </div>
    
    <table class="streamer-table" id="streamerTable">
        <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                <th class="account-column">ê³„ì¢Œí›„ì›</th>
                <th class="toonation-column">íˆ¬ë„¤í›„ì›</th>
                <th class="total-column">ì´ í›„ì›</th>
            </tr>
        </thead>
        <tbody id="streamerTableBody">
            <tr>
                <td colspan="5" class="no-data">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</td>
            </tr>
        </tbody>
    </table>
    
    <div class="info-text">ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</div>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class RealtimeStreamerTable {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        this.previousStreamerTotals = new Map();
        this.totalOnlyMode = false;
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
        this.initializeControls();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('ì‹¤ì‹œê°„ ì„œë²„ì— ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderStreamerTable();
        });

        this.socket.on('dataUpdate', (data) => {
            const previousData = this.data;
            this.data = data;
            
            // ì„¤ì • ë°ì´í„°ê°€ í¬í•¨ëœ ê²½ìš° ì„¤ì •ë„ ì—…ë°ì´íŠ¸
            if (data.settings) {
                console.log('âš™ï¸ [ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸”] ì„¤ì • ì—…ë°ì´íŠ¸ í¬í•¨:', Object.keys(data.settings));
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            
            this.renderStreamerTable(previousData);
        });

        this.socket.on('settingsUpdate', (settings) => {
            this.settings = settings;
            this.applySettings();
            this.renderStreamerTable();
        });
        
        // ì˜¤ë²„ë ˆì´ ì´ì•¡ë§Œ ëª¨ë“œ ì„¤ì • ë°›ê¸°
        this.socket.on('overlayTotalOnlyMode', (isEnabled) => {
            this.totalOnlyMode = isEnabled;
            const overlayContainer = document.getElementById('overlayContainer');
            
            if (this.totalOnlyMode) {
                overlayContainer.classList.add('total-only-mode');
            } else {
                overlayContainer.classList.remove('total-only-mode');
            }
            
            this.renderStreamerTable();
        });
    }

    initializeControls() {
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ˆê¸° ì„¤ì • ë³µì›
        const savedMode = localStorage.getItem('overlayTotalOnlyMode');
        if (savedMode === 'true') {
            this.totalOnlyMode = true;
            const overlayContainer = document.getElementById('overlayContainer');
            overlayContainer.classList.add('total-only-mode');
        }
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS ë³€ìˆ˜ ì„¤ì • (ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜)
        const fontSize = parseInt(this.settings['table-font-size']) || 14;
        const numberSize = parseInt(this.settings['table-number-size']) || 16;
        const textColor = this.settings['table-text-color'] || 'white';
        const opacity = parseInt(this.settings['table-opacity']) || 85;
        
        root.style.setProperty('--table-font-size', fontSize + 'px');
        root.style.setProperty('--table-number-size', numberSize);
        root.style.setProperty('--table-text-color', textColor);
        root.style.setProperty('--table-opacity', opacity);
        
        console.log('ğŸ”§ í…Œì´ë¸” ì„¤ì • ì ìš©ë¨:', { fontSize, numberSize, textColor, opacity });

        // í…Œì´ë¸” ì œëª© (ì„œë²„ ì„¤ì • ìš°ì„ )
        const titleElement = document.getElementById('tableTitle');
        titleElement.textContent = this.settings.tableTitle || this.settings['table-title'] || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
        
        // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ ì—¬ë¶€ (ì„œë²„ ì„¤ì • ìš°ì„ )
        const showUpdateTime = this.settings.showUpdateTime ?? (this.settings['show-update-time'] === 'true');
        document.getElementById('updateTime').style.display = showUpdateTime ? 'block' : 'none';
        
        // ì´í•© í–‰ í‘œì‹œ ì—¬ë¶€ (ì„œë²„ ì„¤ì • ìš°ì„ )
        const showTotalRow = this.settings.showTotalRow ?? (this.settings['show-total-row'] === 'true');
        document.getElementById('totalSummary').style.display = showTotalRow ? 'block' : 'none';
    }

    renderStreamerTable(previousData = null) {
        if (!this.data || !this.data.donations || !this.data.streamers) {
            this.showNoData();
            return;
        }

        // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í†µê³„ ê³„ì‚°
        const streamerStats = this.calculateStreamerStats();
        
        if (streamerStats.length === 0) {
            this.showNoData();
            return;
        }

        // ìˆ¨ê²¨ì§„ ìŠ¤íŠ¸ë¦¬ë¨¸ í•„í„°ë§
        const hiddenStreamers = this.getHiddenStreamers();
        const visibleStats = streamerStats.filter(stat => 
            !hiddenStreamers.includes(stat.streamer)
        );

        this.displayStreamerTable(visibleStats);
        this.updateSummary(visibleStats);
        this.updateLastUpdate();
    }

    calculateStreamerStats() {
        // ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼í•œ ë¡œì§ ì ìš©
        const hiddenStreamers = this.getHiddenStreamers();
        const summaryStreamers = (this.data.streamers || []).filter(s => s !== 'êµ­ê³ ' && s !== 'í›„ì›ìì¡°ì •' && !hiddenStreamers.includes(s));
        const streamerData = {};
        
        // ìŠ¤íŠ¸ë¦¬ë¨¸ ë°ì´í„° ì´ˆê¸°í™”
        summaryStreamers.forEach(s => { 
            streamerData[s] = { name: s, account: 0, toonation: 0, total: 0 }; 
        });
        
        // í›„ì› ë°ì´í„° ì§‘ê³„
        (this.data.donations || []).forEach(d => {
            if (streamerData.hasOwnProperty(d.streamer)) {
                const amountInWon = (parseFloat(d.amount) || 0) * 10000; // ë§Œì› â†’ ì› ë³€í™˜
                
                if (this.totalOnlyMode) {
                    // ì´ì•¡ë§Œ ëª¨ë“œ: ëª¨ë“  íƒ€ì…ì˜ í›„ì›ì„ ì´ì•¡ì— í•©ì‚°
                    streamerData[d.streamer].total += amountInWon;
                } else {
                    // ì¼ë°˜ ëª¨ë“œ: íƒ€ì…ë³„ë¡œ ë¶„ë¦¬ ì§‘ê³„
                    if (d.type === 'ê³„ì¢Œ') streamerData[d.streamer].account += amountInWon;
                    else if (d.type === 'íˆ¬ë„¤') streamerData[d.streamer].toonation += amountInWon;
                }
            }
        });
        
        // ì´ì•¡ ê³„ì‚° í›„ ì •ë ¬
        let sortedStreamers = Object.values(streamerData).map(data => { 
            if (!this.totalOnlyMode) {
                // ì¼ë°˜ ëª¨ë“œ: ê³„ì¢Œ + íˆ¬ë„¤ë¡œ ì´ì•¡ ê³„ì‚°
                data.total = data.account + data.toonation; 
            }
            // ì´ì•¡ë§Œ ëª¨ë“œì—ì„œëŠ” ì´ë¯¸ totalì— ëª¨ë“  í›„ì›ì´ í•©ì‚°ë˜ì–´ ìˆìŒ
            return data; 
        }).sort((a, b) => b.total - a.total);

        // ê¸°ì¡´ í˜•ì‹ì— ë§ê²Œ ë³€í™˜
        const result = sortedStreamers.map(data => ({
            streamer: data.name,
            account: data.account,
            toonation: data.toonation,
            total: data.total,
            emoji: this.data.emojis?.[data.name] || ''
        }));
        
        return result;
    }

    getHiddenStreamers() {
        try {
            return JSON.parse(this.settings['hidden-streamers'] || '[]');
        } catch {
            return [];
        }
    }

    // ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ ì œê±°ë¨

    displayStreamerTable(streamerStats) {
        const tbody = document.getElementById('streamerTableBody');
        
        if (streamerStats.length === 0) {
            const colspan = this.totalOnlyMode ? '3' : '5';
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="no-data">í‘œì‹œí•  ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        let html = '';
        streamerStats.forEach((stat, index) => {
            // ì»¤ìŠ¤í…€ ìˆœë²ˆëª… ì ìš© (ìƒì„¸ í…Œì´ë¸”ê³¼ ë™ì¼)
            const rankName = this.getRankName(index);
            const rankClass = ` rank-${(index + 1) <= 3 ? (index + 1) : 'other'}`;
            
            html += `<tr class="${rankClass}">`;
            html += `<td><span class="rank-number">${rankName}</span></td>`;
            html += `<td class="streamer-name">${stat.emoji} ${stat.streamer}</td>`;
            
            if (!this.totalOnlyMode) {
                html += `<td class="amount account-column">${stat.account.toLocaleString('ko-KR')}</td>`;
                html += `<td class="amount toonation-column">${stat.toonation.toLocaleString('ko-KR')}</td>`;
            }
            
            html += `<td class="amount total-column">${stat.total.toLocaleString('ko-KR')}</td>`;
            html += `</tr>`;
        });
        
        tbody.innerHTML = html;
    }

    getRankName(index) {
        const rankNumber = index + 1;
        
        // ì„œë²„ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ìš°ì„ )
        if (this.settings.rankNames && this.settings.rankNames[rankNumber]) {
            return this.settings.rankNames[rankNumber].trim();
        }
        
        // ë¡œì»¬ ì„¤ì •ì—ì„œ ìˆœë²ˆëª… í™•ì¸ (ë°±ì—…)
        const customRankName = localStorage.getItem(`rank-${rankNumber}-name`);
        if (customRankName && customRankName.trim() !== '') {
            return customRankName.trim();
        }
        
        // ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ«ìë¡œ í‘œì‹œ
        return rankNumber.toString();
    }

    updateSummary(streamerStats) {
        if (this.settings.showTotalRow ?? (this.settings['show-total-row'] === 'true')) {
            if (this.totalOnlyMode) {
                // ì´ì•¡ë§Œ ëª¨ë“œ: total í•„ë“œì˜ í•©ê³„ ì‚¬ìš©
                const grandTotal = streamerStats.reduce((sum, stat) => sum + stat.total, 0);
                document.getElementById('totalSummary').innerHTML = 
                    `ì´ í›„ì›ì•¡: <strong>${grandTotal.toLocaleString('ko-KR')}ì›</strong>`;
            } else {
                // ì¼ë°˜ ëª¨ë“œ: ê³„ì¢Œ + íˆ¬ë„¤ í•©ê³„ ì‚¬ìš©
                const totalAccount = streamerStats.reduce((sum, stat) => sum + stat.account, 0);
                const totalToonation = streamerStats.reduce((sum, stat) => sum + stat.toonation, 0);
                const grandTotal = totalAccount + totalToonation;
                document.getElementById('totalSummary').innerHTML = 
                    `ì´ í›„ì›ì•¡: <strong>${grandTotal.toLocaleString('ko-KR')}ì›</strong> (ê³„ì¢Œ: ${totalAccount.toLocaleString('ko-KR')}ì›, íˆ¬ë„¤: ${totalToonation.toLocaleString('ko-KR')}ì›)`;
            }
        }
    }

    updateLastUpdate() {
        if ((this.settings.showUpdateTime ?? (this.settings['show-update-time'] === 'true')) && this.data?.lastUpdated) {
            document.getElementById('lastUpdate').textContent = 
                new Date(this.data.lastUpdated).toLocaleTimeString('ko-KR');
        }
    }

    showNoData() {
        const tbody = document.getElementById('streamerTableBody');
        const colspan = this.totalOnlyMode ? '3' : '5';
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        
        document.getElementById('totalSummary').innerHTML = 'ì´ í›„ì›ì•¡: â‚©0 (0ê±´)';
    }

    showNoConnection() {
        const tbody = document.getElementById('streamerTableBody');
        const colspan = this.totalOnlyMode ? '3' : '5';
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="no-data">ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤...</td></tr>`;
    }
}

// URL íŒŒë¼ë¯¸í„° í™•ì¸ (í…ŒìŠ¤íŠ¸ìš©)
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    // í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™•ì¸
    const testMode = getUrlParameter('test') === '1';
    if (testMode) {
        console.log('í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
    }
    
    window.streamerTable = new RealtimeStreamerTable();
});

// OBSì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ ì œê³µ
window.refreshTable = () => {
    if (window.streamerTable && window.streamerTable.data) {
        window.streamerTable.renderStreamerTable();
    }
};
</script>

</body>
</html>