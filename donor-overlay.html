<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>후원자별 총액 - 방송용 오버레이</title>
<style>
body {
    margin: 0;
    padding: 0 10px 0 0;
    background: transparent;
    font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: none;
    width: calc(100% - 10px);
    transition: all 0.3s ease-in-out;
}

.donor-content {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    line-height: 1.4;
    white-space: pre-line;
    padding: 0;
    transition: all 0.2s ease-in-out;
}

.no-data {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    text-align: center;
    padding: 20px 0;
    transition: all 0.2s ease-in-out;
}

/* 크로마키 지원을 위한 투명 모드 */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container" id="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="no-data">데이터를 불러오는 중...</div>
    </div>
</div>

<script>
let donations = [];
let isTransparentMode = false;
let currentDonorText = '';
let settingsSyncedFromServer = false; // 설정 동기화 플래그

// 모바일 감지
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
console.log('📱 디바이스:', isMobile ? '모바일' : 'PC');

// localStorage 변경 추적을 위한 감시자 (최대 강화)
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
    const oldValue = this.getItem(key);
    const result = originalSetItem.call(this, key, value);
    
    // 모든 localStorage 변경 추적
    console.log(`🔧🔧🔧 localStorage 변경: ${key} = ${value} (이전: ${oldValue})`);
    
    // 오버레이 관련 설정만 특별 추적
    if (key.includes('overlay') || key.includes('font') || key.includes('stroke') || key.includes('align')) {
        console.error(`🚨🚨🚨 오버레이 설정 변경 감지!!! ${key} = ${value}`);
        console.trace('🚨🚨🚨 오버레이 설정 변경 스택:');
    }
    
    return result;
};

// 추가 보안: localStorage 객체 자체 감시
const originalLocalStorage = window.localStorage;
console.log('localStorage 추적 시작됨');

// 정산요약과 동일한 금액 포맷팅
function formatAmount(num) {
    const number = parseFloat(num);
    if (isNaN(number)) return '0';
    return parseFloat(number.toFixed(1)).toString();
}

// 모바일에서 즉시 표시할 테스트 데이터
function showMobileTestData() {
    console.log('📱 모바일 즉시 테스트 데이터 표시');
    
    donations = [
        {
            donor: "모바일테스트",
            streamer: "테스트스트리머",
            type: "계좌",
            amount: 12345,
            time: new Date()
        }
    ];
    
    // 모바일 최적화 설정 즉시 적용
    localStorage.setItem('overlay-font-size', '32');
    localStorage.setItem('overlay-stroke-width', '3');
    localStorage.setItem('overlay-text-align', 'center');
    
    console.log('📱 모바일 설정 적용: 글자 32px, 가운데 정렬');
    updateDisplay();
    applySettings();
}

// 모바일 우선 데이터 로딩: 무조건 표시 보장
async function loadDonationData() {
    console.log('🚀 데이터 로딩 시작...');
    
    // 모바일에서 즉시 테스트 데이터 표시
    if (isMobile) {
        showMobileTestData();
        console.log('📱 모바일 감지: 테스트 데이터 즉시 표시');
    }
    
    try {
        let dataLoaded = false;
        
        // 1. GitHub raw 파일에서 데이터 시도 (가장 최신)
        try {
            console.log('📱 모바일 데이터 로드 시작...');
            const timestamp = Date.now();
            
            // 여러 URL 시도 (모바일 호환성)
            const urls = [
                `https://raw.githubusercontent.com/fzsaxzzzzzzzzzzzzz/donation-manager/main/data.json?t=${timestamp}`,
                `https://api.github.com/repos/fzsaxzzzzzzzzzzzzz/donation-manager/contents/data.json?t=${timestamp}`,
                `https://github.com/fzsaxzzzzzzzzzzzzz/donation-manager/raw/main/data.json?t=${timestamp}`
            ];
            
            let response = null;
            for (let i = 0; i < urls.length; i++) {
                try {
                    console.log(`📱 시도 ${i+1}: ${urls[i]}`);
                    response = await fetch(urls[i], {
                        cache: 'no-cache',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    if (response.ok) {
                        console.log(`✅ URL ${i+1} 성공!`);
                        break;
                    }
                } catch (error) {
                    console.log(`❌ URL ${i+1} 실패:`, error.message);
                    continue;
                }
            }
            if (response.ok) {
                const data = await response.json();
                
                // 후원 데이터 설정
                if (data.donations && Array.isArray(data.donations)) {
                    donations = data.donations.map(d => ({
                        ...d,
                        time: new Date(d.time),
                        amount: parseFloat(d.amount) || 0
                    }));
                }
                
                // 설정 데이터 적용 (최초 1회만)
                if (data.settings && !settingsSyncedFromServer) {
                    console.log('🔄 GitHub에서 설정 동기화 시작:', data.settings);
                    Object.entries(data.settings).forEach(([key, value]) => {
                        if (value !== null && value !== undefined) {
                            console.log(`  설정 적용: ${key} = ${value} (기존: ${localStorage.getItem(key)})`);
                            localStorage.setItem(key, value);
                        }
                    });
                    settingsSyncedFromServer = true;
                    console.log('✅ GitHub에서 설정 동기화 완료 (최초 1회)');
                } else if (data.settings && settingsSyncedFromServer) {
                    console.log('⏸️ GitHub 설정 동기화 스킵됨 (이미 동기화됨)');
                }
                
                console.log('✅ GitHub에서 데이터 로드 성공:', donations.length + '개 후원');
                dataLoaded = true;
            }
        } catch (githubError) {
            console.log('ℹ️ GitHub 데이터 로드 실패, 다른 방법 시도...');
        }
        
        // 2. URL 파라미터에서 데이터 시도
        if (!dataLoaded) {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            
            if (encodedData) {
                try {
                    const dataString = decodeURIComponent(atob(encodedData));
                    const data = JSON.parse(dataString);
                    
                    if (data.donations && Array.isArray(data.donations)) {
                        donations = data.donations.map(d => ({
                            ...d,
                            time: new Date(d.time),
                            amount: parseFloat(d.amount) || 0
                        }));
                    }
                    
                    // 설정 데이터 적용 (최초 1회만)
                    if (data.settings && !settingsSyncedFromServer) {
                        Object.entries(data.settings).forEach(([key, value]) => {
                            if (value !== null && value !== undefined) {
                                localStorage.setItem(key, value);
                            }
                        });
                        settingsSyncedFromServer = true;
                        console.log('✅ URL 파라미터에서 설정 동기화 완료 (최초 1회)');
                    }
                    
                    console.log('✅ URL 파라미터에서 데이터 로드:', donations.length + '개 후원');
                    dataLoaded = true;
                } catch (urlError) {
                    console.log('ℹ️ URL 파라미터 파싱 실패');
                }
            }
        }
        
        // 3. 로컬스토리지에서 데이터 시도
        if (!dataLoaded) {
            const savedDonations = localStorage.getItem('donation_data');
            
            if (savedDonations) {
                donations = JSON.parse(savedDonations).map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
                console.log('✅ 로컬스토리지에서 데이터 로드:', donations.length + '개 후원');
                dataLoaded = true;
            }
        }
        
        // 4. 모든 방법 실패 시 모바일 테스트 데이터
        if (!dataLoaded) {
            console.log('⚠️ 모든 데이터 소스 실패, 모바일 테스트 데이터 사용');
            donations = [
                {
                    donor: "테스트후원자",
                    streamer: "테스트스트리머", 
                    type: "계좌",
                    amount: 110,
                    time: new Date()
                },
                {
                    donor: "모바일테스트",
                    streamer: "모바일스트리머",
                    type: "계좌", 
                    amount: 50,
                    time: new Date()
                }
            ];
            
            // 모바일 테스트용 설정도 적용
            if (!settingsSyncedFromServer) {
                localStorage.setItem('overlay-font-size', '24');
                localStorage.setItem('overlay-stroke-width', '3');
                localStorage.setItem('overlay-text-align', 'center');
                console.log('📱 모바일 테스트 설정 적용');
            }
            
            dataLoaded = true;
        }

        updateDisplay();
    } catch (error) {
        console.error('데이터 로드 실패:', error);
        donations = [];
        updateDisplay();
    }
}

// 정산요약과 동일한 후원자별 총액 계산 로직 (실시간 설정 반영)
function updateDisplay() {
    const donorContentEl = document.getElementById('donor-content');
    
    if (!donations || donations.length === 0) {
        const noDataText = '사랑해요♡';
        if (currentDonorText !== noDataText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line; text-align: ${savedTextAlign};">${noDataText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noDataText;
            }, 50);
        }
        return;
    }

    // 후원자별 계좌 후원 총액 계산 (정산요약과 동일)
    let donorAccountTotals = {};

    donations.forEach(d => {
        if (d.type === '계좌') {
            // 스트리머별 조정은 제외, 후원자별 조정은 포함
            if (d.donor.includes('조정(') && d.streamer !== '후원자조정') {
                return;
            }
            
            // 후원자명에서 (조정+금액) 부분 제거
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(조정')) {
                cleanDonorName = cleanDonorName.replace(/\(조정[^)]*\)/g, '');
            }
            
            const amount = parseFloat(d.amount) || 0;
            donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
        }
    });

    // 그룹화 임계값 실시간 로드 (정산요약과 동일)
    const groupThreshold = parseInt(localStorage.getItem('group-threshold') || '1', 10);
    const amountGroups = {};
    
    for (const donor in donorAccountTotals) {
        const amount = donorAccountTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    const sortedGroups = Object.entries(amountGroups).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    
    if (sortedGroups.length === 0) {
        const noAccountText = '사랑해요♡';
        if (currentDonorText !== noAccountText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line; text-align: ${savedTextAlign};">${noAccountText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noAccountText;
            }, 50);
        }
        return;
    }
    
    // 정산요약과 동일한 형식으로 텍스트 생성 (실시간 그룹화 적용)
    const donorText = "사랑해요♡\n" + sortedGroups.map(([amount, donors]) => {
        const amountStr = `${formatAmount(parseFloat(amount))}만`;
        if (donors.length >= groupThreshold && groupThreshold > 1) {
            return `${donors.map(d => d + '님').join(', ')} ${amountStr}`;
        } else {
            return donors.map(d => `${d}님 ${amountStr}`).join('\n');
        }
    }).join('\n');

    // 내용이 바뀔 때만 부드럽게 업데이트
    if (currentDonorText !== donorText) {
        donorContentEl.style.opacity = '0.8';
        setTimeout(() => {
            const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
            donorContentEl.innerHTML = `<div style="white-space: pre-line; text-align: ${savedTextAlign};">${donorText}</div>`;
            applySettings();
            donorContentEl.style.opacity = '1';
            currentDonorText = donorText;
        }, 50);
    }
}

// 오버레이 설정 적용
function applySettings() {
    const savedFontSize = localStorage.getItem('overlay-font-size') || '16';
    const savedStrokeWidth = localStorage.getItem('overlay-stroke-width') || '2';
    const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
    
    console.log('📋 설정 적용 중:', {
        fontSize: `${savedFontSize}px (localStorage: ${localStorage.getItem('overlay-font-size')})`,
        strokeWidth: `${savedStrokeWidth}px (localStorage: ${localStorage.getItem('overlay-stroke-width')})`,
        textAlign: `${savedTextAlign} (localStorage: ${localStorage.getItem('overlay-text-align')})`
    });
    
    const overlayContainer = document.getElementById('overlay-container');
    const allTextElements = document.querySelectorAll('.donor-content, .no-data');
    
    if (overlayContainer) {
        overlayContainer.style.textAlign = savedTextAlign;
    }
    
    allTextElements.forEach(element => {
        element.style.fontSize = savedFontSize + 'px';
        updateTextShadow(element, savedStrokeWidth);
    });
}

function updateTextShadow(element, strokeWidth) {
    const sw = parseFloat(strokeWidth);
    
    if (sw === 0) {
        element.style.textShadow = 'none';
        return;
    }
    
    // 더 부드러운 외각선을 위해 다중 그림자 사용
    let shadows = [];
    
    // 메인 외각선 (8방향)
    for (let i = 0; i < 8; i++) {
        const angle = (i * Math.PI) / 4;
        const x = Math.cos(angle) * sw;
        const y = Math.sin(angle) * sw;
        shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
    }
    
    // 부드러움을 위한 추가 중간 그림자 (큰 외각선일 때)
    if (sw > 3) {
        for (let i = 0; i < 8; i++) {
            const angle = (i * Math.PI) / 4 + Math.PI / 8; // 중간각도
            const x = Math.cos(angle) * sw * 0.7;
            const y = Math.sin(angle) * sw * 0.7;
            shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
        }
    }
    
    // 블러 효과 추가 (더 부드러운 느낌)
    if (sw > 1) {
        shadows.push(`0 0 ${(sw * 0.5).toFixed(1)}px rgba(0,0,0,0.8)`);
    }
    
    element.style.textShadow = shadows.join(', ');
}

function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
    
    if (isTransparentMode) {
        document.body.style.background = '#00FF00';
    } else {
        document.body.style.background = 'transparent';
    }
}

// 키보드 단축키
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadDonationData();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// 설정 적용 함수 (변경 시에만 호출)
let lastAppliedSettings = {};

function applySettingsIfChanged() {
    const currentSettings = {
        fontSize: localStorage.getItem('overlay-font-size') || '16',
        strokeWidth: localStorage.getItem('overlay-stroke-width') || '2',
        textAlign: localStorage.getItem('overlay-text-align') || 'left'
    };
    
    // 설정이 변경된 경우에만 적용
    if (JSON.stringify(currentSettings) !== JSON.stringify(lastAppliedSettings)) {
        applySettings();
        lastAppliedSettings = currentSettings;
        console.log('🔄 오버레이 설정 변경 감지 및 적용');
    }
}

// 설정 변경 감지 (5초마다, 빈도 감소)
setInterval(() => {
    applySettingsIfChanged();
}, 5000);

// 자동 새로고침 (3초마다)
setInterval(() => {
    try {
        loadDonationData();
    } catch (error) {
        console.error('Auto-refresh failed:', error);
    }
}, 3000);

// 초기 로드 (모바일 우선)
try {
    console.log('🚀 Donor overlay 초기화 시작...');
    
    if (isMobile) {
        // 모바일: 즉시 테스트 데이터 표시
        console.log('📱 모바일 모드: 즉시 초기화');
        showMobileTestData();
        applySettings();
        console.log('✅ 모바일 초기화 완료');
        
        // 백그라운드에서 실제 데이터 로드 시도
        setTimeout(() => {
            loadDonationData();
        }, 2000);
    } else {
        // PC: 기존 방식
        loadDonationData().then(() => {
            setTimeout(() => {
                applySettings();
                applySettingsIfChanged();
                console.log('✅ PC 초기화 완료');
            }, 1000);
        });
    }
} catch (error) {
    console.error('❌ 초기화 실패:', error);
    // 최후의 수단: 강제 테스트 데이터
    showMobileTestData();
}
</script>
</body>
</html>