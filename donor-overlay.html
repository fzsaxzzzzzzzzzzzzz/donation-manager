<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í›„ì›ìë³„ ì´ì•¡ - ë°©ì†¡ìš© ì˜¤ë²„ë ˆì´</title>
<style>
body {
    margin: 0;
    padding: 0 10px 0 0;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: none;
    width: calc(100% - 10px);
    transition: all 0.3s ease-in-out;
}

.donor-content {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    line-height: 1.4;
    white-space: pre-line;
    padding: 0;
    transition: all 0.2s ease-in-out;
}

.no-data {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    text-align: center;
    padding: 20px 0;
    transition: all 0.2s ease-in-out;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì›ì„ ìœ„í•œ íˆ¬ëª… ëª¨ë“œ */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container" id="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
let donations = [];
let isTransparentMode = false;
let currentDonorText = '';
let settingsSyncedFromServer = false; // ì„¤ì • ë™ê¸°í™” í”Œë˜ê·¸

// localStorage ë³€ê²½ ì¶”ì ì„ ìœ„í•œ ê°ì‹œì (ìµœëŒ€ ê°•í™”)
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
    const oldValue = this.getItem(key);
    const result = originalSetItem.call(this, key, value);
    
    // ëª¨ë“  localStorage ë³€ê²½ ì¶”ì 
    console.log(`ğŸ”§ğŸ”§ğŸ”§ localStorage ë³€ê²½: ${key} = ${value} (ì´ì „: ${oldValue})`);
    
    // ì˜¤ë²„ë ˆì´ ê´€ë ¨ ì„¤ì •ë§Œ íŠ¹ë³„ ì¶”ì 
    if (key.includes('overlay') || key.includes('font') || key.includes('stroke') || key.includes('align')) {
        console.error(`ğŸš¨ğŸš¨ğŸš¨ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³€ê²½ ê°ì§€!!! ${key} = ${value}`);
        console.trace('ğŸš¨ğŸš¨ğŸš¨ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³€ê²½ ìŠ¤íƒ:');
    }
    
    return result;
};

// ì¶”ê°€ ë³´ì•ˆ: localStorage ê°ì²´ ìì²´ ê°ì‹œ
const originalLocalStorage = window.localStorage;
console.log('localStorage ì¶”ì  ì‹œì‘ë¨');

// ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ ê¸ˆì•¡ í¬ë§·íŒ…
function formatAmount(num) {
    const number = parseFloat(num);
    if (isNaN(number)) return '0';
    return parseFloat(number.toFixed(1)).toString();
}

// ìš°ì„ ìˆœìœ„ë³„ ë°ì´í„° ë¡œë”©: GitHub raw â†’ URL íŒŒë¼ë¯¸í„° â†’ ë¡œì»¬ìŠ¤í† ë¦¬ì§€
async function loadDonationData() {
    try {
        let dataLoaded = false;
        
        // 1. GitHub raw íŒŒì¼ì—ì„œ ë°ì´í„° ì‹œë„ (ê°€ì¥ ìµœì‹ )
        try {
            const timestamp = Date.now();
            const response = await fetch(`https://raw.githubusercontent.com/fzsaxzzzzzzzzzzzzz/donation-manager/main/data.json?t=${timestamp}&cache=false&v=${Math.random()}`, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                }
            });
            if (response.ok) {
                const data = await response.json();
                
                // í›„ì› ë°ì´í„° ì„¤ì •
                if (data.donations && Array.isArray(data.donations)) {
                    donations = data.donations.map(d => ({
                        ...d,
                        time: new Date(d.time),
                        amount: parseFloat(d.amount) || 0
                    }));
                }
                
                // ì„¤ì • ë°ì´í„° ì ìš© (ìµœì´ˆ 1íšŒë§Œ)
                if (data.settings && !settingsSyncedFromServer) {
                    console.log('ğŸ”„ GitHubì—ì„œ ì„¤ì • ë™ê¸°í™” ì‹œì‘:', data.settings);
                    Object.entries(data.settings).forEach(([key, value]) => {
                        if (value !== null && value !== undefined) {
                            console.log(`  ì„¤ì • ì ìš©: ${key} = ${value} (ê¸°ì¡´: ${localStorage.getItem(key)})`);
                            localStorage.setItem(key, value);
                        }
                    });
                    settingsSyncedFromServer = true;
                    console.log('âœ… GitHubì—ì„œ ì„¤ì • ë™ê¸°í™” ì™„ë£Œ (ìµœì´ˆ 1íšŒ)');
                } else if (data.settings && settingsSyncedFromServer) {
                    console.log('â¸ï¸ GitHub ì„¤ì • ë™ê¸°í™” ìŠ¤í‚µë¨ (ì´ë¯¸ ë™ê¸°í™”ë¨)');
                }
                
                console.log('âœ… GitHubì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', donations.length + 'ê°œ í›„ì›');
                dataLoaded = true;
            }
        } catch (githubError) {
            console.log('â„¹ï¸ GitHub ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë‹¤ë¥¸ ë°©ë²• ì‹œë„...');
        }
        
        // 2. URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ì‹œë„
        if (!dataLoaded) {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            
            if (encodedData) {
                try {
                    const dataString = decodeURIComponent(atob(encodedData));
                    const data = JSON.parse(dataString);
                    
                    if (data.donations && Array.isArray(data.donations)) {
                        donations = data.donations.map(d => ({
                            ...d,
                            time: new Date(d.time),
                            amount: parseFloat(d.amount) || 0
                        }));
                    }
                    
                    // ì„¤ì • ë°ì´í„° ì ìš© (ìµœì´ˆ 1íšŒë§Œ)
                    if (data.settings && !settingsSyncedFromServer) {
                        Object.entries(data.settings).forEach(([key, value]) => {
                            if (value !== null && value !== undefined) {
                                localStorage.setItem(key, value);
                            }
                        });
                        settingsSyncedFromServer = true;
                        console.log('âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¤ì • ë™ê¸°í™” ì™„ë£Œ (ìµœì´ˆ 1íšŒ)');
                    }
                    
                    console.log('âœ… URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ë¡œë“œ:', donations.length + 'ê°œ í›„ì›');
                    dataLoaded = true;
                } catch (urlError) {
                    console.log('â„¹ï¸ URL íŒŒë¼ë¯¸í„° íŒŒì‹± ì‹¤íŒ¨');
                }
            }
        }
        
        // 3. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ì‹œë„
        if (!dataLoaded) {
            const savedDonations = localStorage.getItem('donation_data');
            
            if (savedDonations) {
                donations = JSON.parse(savedDonations).map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
                console.log('âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ:', donations.length + 'ê°œ í›„ì›');
                dataLoaded = true;
            }
        }
        
        // 4. ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ìƒíƒœ
        if (!dataLoaded) {
            donations = [];
            console.log('â„¹ï¸ ëª¨ë“  ë°ì´í„° ì†ŒìŠ¤ ì‹¤íŒ¨, ë¹ˆ ìƒíƒœë¡œ ì‹œì‘');
        }

        updateDisplay();
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        donations = [];
        updateDisplay();
    }
}

// ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í›„ì›ìë³„ ì´ì•¡ ê³„ì‚° ë¡œì§ (ì‹¤ì‹œê°„ ì„¤ì • ë°˜ì˜)
function updateDisplay() {
    const donorContentEl = document.getElementById('donor-content');
    
    if (!donations || donations.length === 0) {
        const noDataText = 'ì‚¬ë‘í•´ìš”â™¡';
        if (currentDonorText !== noDataText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line; text-align: ${savedTextAlign};">${noDataText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noDataText;
            }, 50);
        }
        return;
    }

    // í›„ì›ìë³„ ê³„ì¢Œ í›„ì› ì´ì•¡ ê³„ì‚° (ì •ì‚°ìš”ì•½ê³¼ ë™ì¼)
    let donorAccountTotals = {};

    donations.forEach(d => {
        if (d.type === 'ê³„ì¢Œ') {
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •ì€ ì œì™¸, í›„ì›ìë³„ ì¡°ì •ì€ í¬í•¨
            if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                return;
            }
            
            // í›„ì›ìëª…ì—ì„œ (ì¡°ì •+ê¸ˆì•¡) ë¶€ë¶„ ì œê±°
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(ì¡°ì •')) {
                cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '');
            }
            
            const amount = parseFloat(d.amount) || 0;
            donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
        }
    });

    // ê·¸ë£¹í™” ì„ê³„ê°’ ì‹¤ì‹œê°„ ë¡œë“œ (ì •ì‚°ìš”ì•½ê³¼ ë™ì¼)
    const groupThreshold = parseInt(localStorage.getItem('group-threshold') || '1', 10);
    const amountGroups = {};
    
    for (const donor in donorAccountTotals) {
        const amount = donorAccountTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    const sortedGroups = Object.entries(amountGroups).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    
    if (sortedGroups.length === 0) {
        const noAccountText = 'ì‚¬ë‘í•´ìš”â™¡';
        if (currentDonorText !== noAccountText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line; text-align: ${savedTextAlign};">${noAccountText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noAccountText;
            }, 50);
        }
        return;
    }
    
    // ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ í…ìŠ¤íŠ¸ ìƒì„± (ì‹¤ì‹œê°„ ê·¸ë£¹í™” ì ìš©)
    const donorText = "ì‚¬ë‘í•´ìš”â™¡\n" + sortedGroups.map(([amount, donors]) => {
        const amountStr = `${formatAmount(parseFloat(amount))}ë§Œ`;
        if (donors.length >= groupThreshold && groupThreshold > 1) {
            return `${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`;
        } else {
            return donors.map(d => `${d}ë‹˜ ${amountStr}`).join('\n');
        }
    }).join('\n');

    // ë‚´ìš©ì´ ë°”ë€” ë•Œë§Œ ë¶€ë“œëŸ½ê²Œ ì—…ë°ì´íŠ¸
    if (currentDonorText !== donorText) {
        donorContentEl.style.opacity = '0.8';
        setTimeout(() => {
            const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
            donorContentEl.innerHTML = `<div style="white-space: pre-line; text-align: ${savedTextAlign};">${donorText}</div>`;
            applySettings();
            donorContentEl.style.opacity = '1';
            currentDonorText = donorText;
        }, 50);
    }
}

// ì˜¤ë²„ë ˆì´ ì„¤ì • ì ìš©
function applySettings() {
    const savedFontSize = localStorage.getItem('overlay-font-size') || '16';
    const savedStrokeWidth = localStorage.getItem('overlay-stroke-width') || '2';
    const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
    
    console.log('ğŸ“‹ ì„¤ì • ì ìš© ì¤‘:', {
        fontSize: `${savedFontSize}px (localStorage: ${localStorage.getItem('overlay-font-size')})`,
        strokeWidth: `${savedStrokeWidth}px (localStorage: ${localStorage.getItem('overlay-stroke-width')})`,
        textAlign: `${savedTextAlign} (localStorage: ${localStorage.getItem('overlay-text-align')})`
    });
    
    const overlayContainer = document.getElementById('overlay-container');
    const allTextElements = document.querySelectorAll('.donor-content, .no-data');
    
    if (overlayContainer) {
        overlayContainer.style.textAlign = savedTextAlign;
    }
    
    allTextElements.forEach(element => {
        element.style.fontSize = savedFontSize + 'px';
        updateTextShadow(element, savedStrokeWidth);
    });
}

function updateTextShadow(element, strokeWidth) {
    const sw = parseFloat(strokeWidth);
    
    if (sw === 0) {
        element.style.textShadow = 'none';
        return;
    }
    
    // ë” ë¶€ë“œëŸ¬ìš´ ì™¸ê°ì„ ì„ ìœ„í•´ ë‹¤ì¤‘ ê·¸ë¦¼ì ì‚¬ìš©
    let shadows = [];
    
    // ë©”ì¸ ì™¸ê°ì„  (8ë°©í–¥)
    for (let i = 0; i < 8; i++) {
        const angle = (i * Math.PI) / 4;
        const x = Math.cos(angle) * sw;
        const y = Math.sin(angle) * sw;
        shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
    }
    
    // ë¶€ë“œëŸ¬ì›€ì„ ìœ„í•œ ì¶”ê°€ ì¤‘ê°„ ê·¸ë¦¼ì (í° ì™¸ê°ì„ ì¼ ë•Œ)
    if (sw > 3) {
        for (let i = 0; i < 8; i++) {
            const angle = (i * Math.PI) / 4 + Math.PI / 8; // ì¤‘ê°„ê°ë„
            const x = Math.cos(angle) * sw * 0.7;
            const y = Math.sin(angle) * sw * 0.7;
            shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
        }
    }
    
    // ë¸”ëŸ¬ íš¨ê³¼ ì¶”ê°€ (ë” ë¶€ë“œëŸ¬ìš´ ëŠë‚Œ)
    if (sw > 1) {
        shadows.push(`0 0 ${(sw * 0.5).toFixed(1)}px rgba(0,0,0,0.8)`);
    }
    
    element.style.textShadow = shadows.join(', ');
}

function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
    
    if (isTransparentMode) {
        document.body.style.background = '#00FF00';
    } else {
        document.body.style.background = 'transparent';
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadDonationData();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// ì„¤ì • ì ìš© í•¨ìˆ˜ (ë³€ê²½ ì‹œì—ë§Œ í˜¸ì¶œ)
let lastAppliedSettings = {};

function applySettingsIfChanged() {
    const currentSettings = {
        fontSize: localStorage.getItem('overlay-font-size') || '16',
        strokeWidth: localStorage.getItem('overlay-stroke-width') || '2',
        textAlign: localStorage.getItem('overlay-text-align') || 'left'
    };
    
    // ì„¤ì •ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì ìš©
    if (JSON.stringify(currentSettings) !== JSON.stringify(lastAppliedSettings)) {
        applySettings();
        lastAppliedSettings = currentSettings;
        console.log('ğŸ”„ ì˜¤ë²„ë ˆì´ ì„¤ì • ë³€ê²½ ê°ì§€ ë° ì ìš©');
    }
}

// ì„¤ì • ë³€ê²½ ê°ì§€ (5ì´ˆë§ˆë‹¤, ë¹ˆë„ ê°ì†Œ)
setInterval(() => {
    applySettingsIfChanged();
}, 5000);

// ìë™ ìƒˆë¡œê³ ì¹¨ (3ì´ˆë§ˆë‹¤)
setInterval(() => {
    try {
        loadDonationData();
    } catch (error) {
        console.error('Auto-refresh failed:', error);
    }
}, 3000);

// ì´ˆê¸° ë¡œë“œ
try {
    console.log('Donor overlay initializing...');
    loadDonationData().then(() => {
        // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ì„¤ì • ì ìš©
        setTimeout(() => {
            applySettings();
            applySettingsIfChanged(); // ì´ˆê¸° ì„¤ì • ì €ì¥
            console.log('Donor overlay initialized successfully');
        }, 1000);
    });
} catch (error) {
    console.error('Donor overlay initialization failed:', error);
    document.getElementById('donor-content').innerHTML = 
        '<div class="no-data" style="white-space: pre-line;">âŒ ì´ˆê¸°í™” ì‹¤íŒ¨\nOBSì—ì„œ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”</div>';
}
</script>
</body>
</html>