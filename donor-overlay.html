<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í›„ì›ìë³„ ì´ì•¡ - ë°©ì†¡ìš© ì˜¤ë²„ë ˆì´</title>
<style>
body {
    margin: 0;
    padding: 0;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: none;
    width: 100%;
    transition: all 0.3s ease-in-out;
}

.donor-content {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    line-height: 1.4;
    white-space: pre-line;
    padding: 0;
    transition: all 0.2s ease-in-out;
}

.no-data {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000;
    text-align: center;
    padding: 20px 0;
    transition: all 0.2s ease-in-out;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì›ì„ ìœ„í•œ íˆ¬ëª… ëª¨ë“œ */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container" id="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
let donations = [];
let isTransparentMode = false;
let currentDonorText = '';

// ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ ê¸ˆì•¡ í¬ë§·íŒ…
function formatAmount(num) {
    const number = parseFloat(num);
    if (isNaN(number)) return '0';
    return parseFloat(number.toFixed(1)).toString();
}

// ë©”ì¸ í›„ì› ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
function loadDonationData() {
    try {
        const savedDonations = localStorage.getItem('donation_data');
        
        if (savedDonations) {
            donations = JSON.parse(savedDonations).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
        } else {
            donations = [];
        }

        updateDisplay();
    } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('donor-content').innerHTML = 
            '<div class="no-data" style="white-space: pre-line;">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨\në©”ì¸ í˜ì´ì§€ì—ì„œ í›„ì› ë°ì´í„°ë¥¼ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”</div>';
        applySettings();
    }
}

// ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í›„ì›ìë³„ ì´ì•¡ ê³„ì‚° ë¡œì§ (ì‹¤ì‹œê°„ ì„¤ì • ë°˜ì˜)
function updateDisplay() {
    const donorContentEl = document.getElementById('donor-content');
    
    if (!donations || donations.length === 0) {
        const noDataText = 'ğŸ“‹ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤\në©”ì¸ í˜ì´ì§€ì—ì„œ í›„ì›ì„ ë“±ë¡í•˜ì„¸ìš”';
        if (currentDonorText !== noDataText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line;">${noDataText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noDataText;
            }, 50);
        }
        return;
    }

    // í›„ì›ìë³„ ê³„ì¢Œ í›„ì› ì´ì•¡ ê³„ì‚° (ì •ì‚°ìš”ì•½ê³¼ ë™ì¼)
    let donorAccountTotals = {};

    donations.forEach(d => {
        if (d.type === 'ê³„ì¢Œ') {
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •ì€ ì œì™¸, í›„ì›ìë³„ ì¡°ì •ì€ í¬í•¨
            if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                return;
            }
            
            // í›„ì›ìëª…ì—ì„œ (ì¡°ì •+ê¸ˆì•¡) ë¶€ë¶„ ì œê±°
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(ì¡°ì •')) {
                cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '');
            }
            
            const amount = parseFloat(d.amount) || 0;
            donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
        }
    });

    // ê·¸ë£¹í™” ì„ê³„ê°’ ì‹¤ì‹œê°„ ë¡œë“œ (ì •ì‚°ìš”ì•½ê³¼ ë™ì¼)
    const groupThreshold = parseInt(localStorage.getItem('group-threshold') || '1', 10);
    const amountGroups = {};
    
    for (const donor in donorAccountTotals) {
        const amount = donorAccountTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    const sortedGroups = Object.entries(amountGroups).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    
    if (sortedGroups.length === 0) {
        const noAccountText = 'ğŸ’³ ê³„ì¢Œ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤';
        if (currentDonorText !== noAccountText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                donorContentEl.innerHTML = `<div class="no-data" style="white-space: pre-line;">${noAccountText}</div>`;
                applySettings();
                donorContentEl.style.opacity = '1';
                currentDonorText = noAccountText;
            }, 50);
        }
        return;
    }
    
    // ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ í…ìŠ¤íŠ¸ ìƒì„± (ì‹¤ì‹œê°„ ê·¸ë£¹í™” ì ìš©)
    const donorText = "ì‚¬ë‘í•´ìš”â™¡\n" + sortedGroups.map(([amount, donors]) => {
        const amountStr = `${formatAmount(parseFloat(amount))}ë§Œ`;
        if (donors.length >= groupThreshold && groupThreshold > 1) {
            return `${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`;
        } else {
            return donors.map(d => `${d}ë‹˜ ${amountStr}`).join('\n');
        }
    }).join('\n');

    // ë‚´ìš©ì´ ë°”ë€” ë•Œë§Œ ë¶€ë“œëŸ½ê²Œ ì—…ë°ì´íŠ¸
    if (currentDonorText !== donorText) {
        donorContentEl.style.opacity = '0.8';
        setTimeout(() => {
            donorContentEl.innerHTML = `<div style="white-space: pre-line;">${donorText}</div>`;
            applySettings();
            donorContentEl.style.opacity = '1';
            currentDonorText = donorText;
        }, 50);
    }
}

// ì˜¤ë²„ë ˆì´ ì„¤ì • ì ìš©
function applySettings() {
    const savedFontSize = localStorage.getItem('overlay-font-size') || '16';
    const savedStrokeWidth = localStorage.getItem('overlay-stroke-width') || '2';
    const savedTextAlign = localStorage.getItem('overlay-text-align') || 'left';
    
    const overlayContainer = document.getElementById('overlay-container');
    const allTextElements = document.querySelectorAll('.donor-content, .no-data');
    
    if (overlayContainer) {
        overlayContainer.style.textAlign = savedTextAlign;
    }
    
    allTextElements.forEach(element => {
        element.style.fontSize = savedFontSize + 'px';
        updateTextShadow(element, savedStrokeWidth);
    });
}

function updateTextShadow(element, strokeWidth) {
    const sw = parseFloat(strokeWidth);
    
    if (sw === 0) {
        element.style.textShadow = 'none';
        return;
    }
    
    // ë” ë¶€ë“œëŸ¬ìš´ ì™¸ê°ì„ ì„ ìœ„í•´ ë‹¤ì¤‘ ê·¸ë¦¼ì ì‚¬ìš©
    let shadows = [];
    
    // ë©”ì¸ ì™¸ê°ì„  (8ë°©í–¥)
    for (let i = 0; i < 8; i++) {
        const angle = (i * Math.PI) / 4;
        const x = Math.cos(angle) * sw;
        const y = Math.sin(angle) * sw;
        shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
    }
    
    // ë¶€ë“œëŸ¬ì›€ì„ ìœ„í•œ ì¶”ê°€ ì¤‘ê°„ ê·¸ë¦¼ì (í° ì™¸ê°ì„ ì¼ ë•Œ)
    if (sw > 3) {
        for (let i = 0; i < 8; i++) {
            const angle = (i * Math.PI) / 4 + Math.PI / 8; // ì¤‘ê°„ê°ë„
            const x = Math.cos(angle) * sw * 0.7;
            const y = Math.sin(angle) * sw * 0.7;
            shadows.push(`${x.toFixed(2)}px ${y.toFixed(2)}px 0 #000000`);
        }
    }
    
    // ë¸”ëŸ¬ íš¨ê³¼ ì¶”ê°€ (ë” ë¶€ë“œëŸ¬ìš´ ëŠë‚Œ)
    if (sw > 1) {
        shadows.push(`0 0 ${(sw * 0.5).toFixed(1)}px rgba(0,0,0,0.8)`);
    }
    
    element.style.textShadow = shadows.join(', ');
}

function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
    
    if (isTransparentMode) {
        document.body.style.background = '#00FF00';
    } else {
        document.body.style.background = 'transparent';
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadDonationData();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// ì„¤ì • ë³€ê²½ ê°ì§€ (ì‹¤ì‹œê°„ ì ìš©)
setInterval(() => {
    applySettings();
}, 500);

// ìë™ ìƒˆë¡œê³ ì¹¨ (3ì´ˆë§ˆë‹¤)
setInterval(() => {
    try {
        loadDonationData();
    } catch (error) {
        console.error('Auto-refresh failed:', error);
    }
}, 3000);

// ì´ˆê¸° ë¡œë“œ
try {
    console.log('Donor overlay initializing...');
    applySettings();
    loadDonationData();
    console.log('Donor overlay initialized successfully');
} catch (error) {
    console.error('Donor overlay initialization failed:', error);
    document.getElementById('donor-content').innerHTML = 
        '<div class="no-data" style="white-space: pre-line;">âŒ ì´ˆê¸°í™” ì‹¤íŒ¨\nOBSì—ì„œ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”</div>';
}
</script>
</body>
</html>