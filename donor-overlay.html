<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”´ ì‹¤ì‹œê°„ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 800px;
    width: 100%;
}

.donor-content {
    font-size: var(--overlay-font-size, 18px) !important;
    font-weight: bold;
    color: white;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000, 3px 0px 0 #000000, -3px 0px 0 #000000, 0px 3px 0 #000000, 0px -3px 0 #000000) !important;
    line-height: 1.5;
    white-space: pre-line;
    padding: 0;
    text-align: var(--overlay-text-align, left) !important;
    transition: opacity 0.3s ease;
}

.no-data {
    font-size: var(--overlay-font-size, 20px) !important;
    font-weight: bold;
    color: white !important;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000) !important;
    text-align: var(--overlay-text-align, center) !important;
    padding: 40px 20px;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    font-size: 12px;
    border-radius: 20px;
    background: rgba(0, 255, 0, 0.8);
    color: white;
    z-index: 1000;
}

.connection-status.disconnected {
    background: rgba(255, 0, 0, 0.8);
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì› */
.transparent-mode {
    background: #00FF00;
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="loading">ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<div class="connection-status" id="connectionStatus">ì—°ê²° ì¤‘...</div>

<script>
class RealtimeDonorOverlay {
    constructor() {
        this.socket = io();
        this.donations = [];
        this.settings = {
            'overlay-font-size': 18,
            'overlay-stroke-width': 3,
            'overlay-text-align': 'left'
        };
        this.isConnected = false;
        
        this.initializeSocket();
        this.setupKeyboardControls();
    }
    
    initializeSocket() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('ğŸ”— ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
        });
        
        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            console.log('âŒ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            this.showError('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        });
        
        this.socket.on('initialData', (data) => {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            this.donations = data.donations || [];
            this.settings = { ...this.settings, ...(data.settings || {}) };
            this.applySettings();
            this.updateDisplay();
        });
        
        this.socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
            this.donations = data.donations || [];
            this.updateDisplay();
            this.flashUpdate();
        });
        
        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', settings);
            this.settings = { ...this.settings, ...settings };
            this.applySettings();
            this.updateDisplay();
        });
    }
    
    updateConnectionStatus() {
        const statusEl = document.getElementById('connectionStatus');
        if (this.isConnected) {
            statusEl.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
            statusEl.className = 'connection-status';
        } else {
            statusEl.textContent = 'ğŸ”´ ì—°ê²° ëŠì–´ì§';
            statusEl.className = 'connection-status disconnected';
        }
    }
    
    applySettings() {
        const root = document.documentElement;
        const fontSize = parseInt(this.settings['overlay-font-size']) || 18;
        const strokeWidth = parseFloat(this.settings['overlay-stroke-width']) || 3;
        const textAlign = this.settings['overlay-text-align'] || 'left';
        
        root.style.setProperty('--overlay-font-size', fontSize + 'px');
        root.style.setProperty('--overlay-text-align', textAlign);
        root.style.setProperty('--overlay-text-shadow', 
            `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`
        );
        
        console.log('ğŸ”§ ì„¤ì • ì ìš©ë¨:', { fontSize, strokeWidth, textAlign });
    }
    
    updateDisplay() {
        const contentEl = document.getElementById('donor-content');
        
        if (!this.donations || this.donations.length === 0) {
            contentEl.textContent = 'í›„ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤';
            contentEl.className = 'no-data';
            return;
        }
        
        // í›„ì›ìë³„ ì´ì•¡ ê³„ì‚°
        const donorTotals = {};
        this.donations.forEach(donation => {
            const donor = donation.donor || 'ìµëª…';
            donorTotals[donor] = (donorTotals[donor] || 0) + (parseFloat(donation.amount) || 0);
        });
        
        // ì†Œì•¡ í•„í„°ë§ (1000ì› ë¯¸ë§Œ ì œì™¸) ë° ê¸ˆì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedDonors = Object.entries(donorTotals)
            .filter(([donor, amount]) => amount >= 1000)
            .sort((a, b) => b[1] - a[1]);
        
        if (sortedDonors.length === 0) {
            contentEl.textContent = 'ì‚¬ë‘í•´ìš”â™¡\ní›„ì›ìê°€ ì—†ìŠµë‹ˆë‹¤';
            contentEl.className = 'no-data';
            return;
        }
        
        // í™”ë©´ í‘œì‹œìš© í…ìŠ¤íŠ¸ ìƒì„± (ë§Œì› ë‹¨ìœ„ë¡œ í‘œì‹œ)
        const displayText = sortedDonors
            .map(([donor, amount]) => `${donor}ë‹˜ ${(amount / 10000)}ë§Œ`)
            .join('\n');
        
        // "ì‚¬ë‘í•´ìš”â™¡" ì¸ì‚¬ë§ê³¼ í•¨ê»˜ í‘œì‹œ
        contentEl.textContent = `ì‚¬ë‘í•´ìš”â™¡\n${displayText}`;
        contentEl.className = 'donor-content';
        
        console.log('ğŸ“Š í™”ë©´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', sortedDonors.length, 'ëª…ì˜ í›„ì›ì');
    }
    
    showError(message) {
        const contentEl = document.getElementById('donor-content');
        contentEl.textContent = message;
        contentEl.className = 'no-data';
        contentEl.style.color = '#ffcccb';
    }
    
    flashUpdate() {
        const container = document.querySelector('.overlay-container');
        if (container) {
            container.style.opacity = '0.7';
            setTimeout(() => {
                container.style.opacity = '1';
            }, 200);
        }
    }
    
    setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '1': // Alt+1: ì™¼ìª½ ì •ë ¬
                        this.settings['overlay-text-align'] = 'left';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ì™¼ìª½');
                        break;
                    case '2': // Alt+2: ê°€ìš´ë° ì •ë ¬
                        this.settings['overlay-text-align'] = 'center';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ê°€ìš´ë°');
                        break;
                    case '3': // Alt+3: ì˜¤ë¥¸ìª½ ì •ë ¬
                        this.settings['overlay-text-align'] = 'right';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ì˜¤ë¥¸ìª½');
                        break;
                    case '=': // Alt+=: í°íŠ¸ í¬ê¸° ì¦ê°€
                        this.settings['overlay-font-size'] = Math.min(50, (this.settings['overlay-font-size'] || 18) + 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                    case '-': // Alt+-: í°íŠ¸ í¬ê¸° ê°ì†Œ
                        this.settings['overlay-font-size'] = Math.max(10, (this.settings['overlay-font-size'] || 18) - 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                }
                e.preventDefault();
            }
        });
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¬ ì‹¤ì‹œê°„ í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘');
    new RealtimeDonorOverlay();
});
</script>

</body>
</html>