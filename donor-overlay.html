<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“± í°ë°©ì†¡ìš© í›„ì›ì ì˜¤ë²„ë ˆì´ v2.0</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
    /* ëª¨ë°”ì¼ ìµœì í™”: í•˜ë“œì›¨ì–´ ê°€ì† ìµœì†Œí™” */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}

/* ëª¨ë°”ì¼ ë°°í„°ë¦¬ ì ˆì•½ ìµœì í™” */
@media (max-width: 768px) {
    body {
        padding: 10px;
        font-size: 14px;
        /* GPU ê°€ì† ì™„ì „ ë¹„í™œì„±í™” */
        -webkit-transform: none;
        transform: none;
        will-change: auto;
    }
}

.overlay-container {
    background: transparent;
    max-width: 800px;
    width: 100%;
}

.donor-content {
    font-size: var(--overlay-font-size, 18px) !important;
    font-weight: bold;
    color: white;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000, 3px 0px 0 #000000, -3px 0px 0 #000000, 0px 3px 0 #000000, 0px -3px 0 #000000) !important;
    line-height: var(--overlay-line-height, 1.5);
    white-space: pre-line;
    padding: 0;
    text-align: var(--overlay-text-align, left) !important;
    transition: opacity 0.3s ease;
}

.no-data {
    font-size: var(--overlay-font-size, 20px) !important;
    font-weight: bold;
    color: white !important;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000) !important;
    text-align: var(--overlay-text-align, center) !important;
    padding: 40px 20px;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
}

/* ì¹´ì¹´ì˜¤ë±…í¬ ì „ìš© ìŠ¤íƒ€ì¼ - ìƒì† ì°¨ë‹¨ ë° ì™„ì „ ê²©ë¦¬ */
.kakao-bank-info,
.kakao-bank-info *,
* .kakao-bank-info,
* .kakao-bank-info *,
div .kakao-bank-info,
div .kakao-bank-info *,
.kakao-bank-info div,
.kakao-bank-info div * {
    line-height: 1.0 !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: inherit !important;
    vertical-align: baseline !important;
    border: 0 !important;
    outline: 0 !important;
    background: transparent !important;
}

.kakao-bank-info {
    margin-bottom: 0px !important;
    display: block !important;
}

.kakao-bank-info > div:first-child {
    font-weight: bold !important;
    color: #FFEB3B !important;
    margin-bottom: 0px !important;
    line-height: 1.0 !important;
}

.kakao-bank-info > div:last-child {
    font-size: 90% !important;
    color: white !important;
    line-height: 1.0 !important;
    margin: 0 !important;
}

/* í›„ì›ì í…ìŠ¤íŠ¸ì™€ ì¹´ì¹´ì˜¤ë±…í¬ ê°„ê²© ìµœì í™” */
.donor-text {
    margin-top: 0 !important;
    padding-top: 0 !important;
    line-height: 1.0 !important;
}

/* <br> íƒœê·¸ ê°„ê²© ìµœì í™” - ì™„ì „ ê³ ì • */
.donor-text br,
br {
    line-height: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
    height: 0 !important;
    display: block !important;
}

/* ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ì™„ì „ ë¹„í™œì„±í™” + ê°„ê²© í†µì œ */
* {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    will-change: auto !important;
}

/* ì „ì²´ ê°„ê²© ì™„ì „ í†µì œ - ì¹´ì¹´ì˜¤ë±…í¬ ê´€ë ¨ */
div, span, p, br {
    margin: 0 !important;
    padding: 0 !important;
    line-height: inherit !important;
}

/* ì—°ê²° ìƒíƒœ í‘œì‹œ ì œê±°ë¨ */

/* í¬ë¡œë§ˆí‚¤ ì§€ì› */
.transparent-mode {
    background: #00FF00;
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="loading">ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<!-- ì—°ê²° ìƒíƒœ í‘œì‹œ ì œê±°ë¨ -->

<script>
class RealtimeDonorOverlay {
    constructor() {
        this.socket = io();
        this.donations = [];
        this.settings = {
            'overlay-font-size': 18,
            'overlay-stroke-width': 3,
            'overlay-text-align': 'left',
            'includeSuperchat': localStorage.getItem('include-superchat') === 'true'
        };
        this.isConnected = false;
        
        this.initializeSocket();
        this.setupKeyboardControls();
    }
    
    initializeSocket() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            console.log('ğŸ”— ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
        });
        
        this.socket.on('disconnect', () => {
            this.isConnected = false;
            console.log('âŒ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
            this.showError('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
        });
        
        this.socket.on('initialData', (data) => {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            this.donations = data.donations || [];
            this.settings = { ...this.settings, ...(data.settings || {}) };
            this.applySettings();
            this.updateDisplay();
        });
        
        this.socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data.donations?.length || 0, 'ê±´');
            this.donations = data.donations || [];
            
            // ì„¤ì • ë°ì´í„°ê°€ í¬í•¨ëœ ê²½ìš° ì„¤ì •ë„ ì—…ë°ì´íŠ¸
            if (data.settings) {
                console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸ í¬í•¨:', Object.keys(data.settings));
                this.settings = { ...this.settings, ...data.settings };
                this.applySettings();
            }
            
            this.updateDisplay();
            this.flashUpdate();
        });
        
        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', settings);
            this.settings = { ...this.settings, ...settings };
            this.applySettings();
            this.updateDisplay();
        });
    }
    
    // ì—°ê²° ìƒíƒœ í‘œì‹œ ì œê±°ë¨
    
    applySettings() {
        const root = document.documentElement;
        const fontSize = parseInt(this.settings['overlay-font-size']) || 18;
        const strokeWidth = parseFloat(this.settings['overlay-stroke-width']) || 3;
        const textAlign = this.settings['overlay-text-align'] || 'left';
        const lineHeight = parseFloat(this.settings['overlay-line-height']) || 1.5;
        
        root.style.setProperty('--overlay-font-size', fontSize + 'px');
        root.style.setProperty('--overlay-text-align', textAlign);
        root.style.setProperty('--overlay-line-height', lineHeight);
        root.style.setProperty('--overlay-text-shadow', 
            `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`
        );
        
        console.log('ğŸ”§ ì„¤ì • ì ìš©ë¨:', { fontSize, strokeWidth, textAlign, lineHeight });
    }
    
    updateDisplay() {
        const contentEl = document.getElementById('donor-content');
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ê³„ì¢Œ ì •ë³´ í‘œì‹œ ì—¬ë¶€ í™•ì¸
        const showKakaoBank = this.settings.showKakaoBank !== undefined ? 
            this.settings.showKakaoBank : false;
        
        // ì¹´ì¹´ì˜¤ë±…í¬ í¬ê¸° ì„¤ì •
        const kakaoBankSize = this.settings.kakaoBankSize || 100;
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ì¤„ê°„ê²© ì„¤ì •
        const kakaoBankLineHeight = this.settings.kakaoBankLineHeight || 1.2;
        
        if (!this.donations || this.donations.length === 0) {
            let content = 'ì‚¬ë‘í•´ìš”â™¡';
            
            // ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ ì¶”ê°€ - DOM ì§ì ‘ ìƒì„±
            if (showKakaoBank) {
                contentEl.innerHTML = '';
                
                // ì¹´ì¹´ì˜¤ë±…í¬ DOM ìƒì„±
                const bankDiv = document.createElement('div');
                bankDiv.className = 'kakao-bank-info';
                bankDiv.style.cssText = `font-size: ${kakaoBankSize}%; line-height: 1.0 !important; margin: 0 !important; padding: 0 !important;`;
                
                const bankName = document.createElement('div');
                bankName.textContent = 'ì¹´ì¹´ì˜¤ë±…í¬';
                bankName.style.cssText = 'margin: 0 !important; padding: 0 !important; line-height: 1.0 !important; font-weight: bold; color: #FFEB3B;';
                
                const bankAccount = document.createElement('div');
                bankAccount.textContent = '3333-25-7378436';
                bankAccount.style.cssText = 'margin: 0 !important; padding: 0 !important; line-height: 1.0 !important; font-size: 90%; color: white;';
                
                bankDiv.appendChild(bankName);
                bankDiv.appendChild(bankAccount);
                
                // í…ìŠ¤íŠ¸ DOM ìƒì„±
                const textDiv = document.createElement('div');
                textDiv.className = 'donor-text';
                textDiv.textContent = content;
                textDiv.style.cssText = 'line-height: 1.0 !important; margin: 0 !important; padding: 0 !important;';
                
                contentEl.appendChild(bankDiv);
                contentEl.appendChild(textDiv);
            } else {
                contentEl.textContent = content;
            }
            
            contentEl.className = 'no-data';
            return;
        }
        
        // í›„ì›ìë³„ ì´ì•¡ ê³„ì‚° (ê³„ì¢Œ + ìŠˆí¼ì±— ì˜µì…˜) - ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ ë¡œì§
        const donorAccountTotals = {};
        
        // ìŠˆí¼ì±— í¬í•¨ ì˜µì…˜ í™•ì¸ (ì„œë²„ ì„¤ì • ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ ì„¤ì •)
        const includeSuperchat = this.settings.includeSuperchat !== undefined ? 
            this.settings.includeSuperchat : (localStorage.getItem('include-superchat') === 'true');
            
        this.donations.forEach(d => {
            const amount = parseFloat(d.amount) || 0;
            const shouldInclude = d.type === 'ê³„ì¢Œ' || (includeSuperchat && d.type === 'ìŠˆí¼ì±—');
            
            if (shouldInclude) {
                // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •ì€ ì œì™¸, í›„ì›ìë³„ ì¡°ì •ì€ í¬í•¨
                if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                    // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • â†’ ì œì™¸
                    return;
                }
                
                // í›„ì›ìëª…ì—ì„œ (ì¡°ì •+ê¸ˆì•¡) ë¶€ë¶„ ì œê±°
                let cleanDonorName = d.donor;
                if (cleanDonorName.includes('(ì¡°ì •')) {
                    cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '');
                }
                
                // ê³„ì¢Œí›„ì›ìë‹˜ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ (íŠ¹ë³„ ì²˜ë¦¬)
                if (cleanDonorName === 'ê³„ì¢Œí›„ì›ìë‹˜' || cleanDonorName === 'ê³„ì¢Œí›„ì›ì') {
                    cleanDonorName = 'ê³„ì¢Œí›„ì›ìë‹˜';
                }
                
                donorAccountTotals[cleanDonorName] = (donorAccountTotals[cleanDonorName] || 0) + amount;
            }
        });

        // ê·¸ë£¹í™” ì„ê³„ê°’ ë¡œë“œ (ì„œë²„ ì„¤ì • ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ ì„¤ì •)
        const groupThreshold = this.settings.groupThreshold || parseInt(localStorage.getItem('group-threshold') || '2');
        
        // ê¸ˆì•¡ë³„ ê·¸ë£¹í™”
        const amountGroups = {};
        for (const donor in donorAccountTotals) {
            const amount = donorAccountTotals[donor];
            if (amount > 0) {
                if (!amountGroups[amount]) { 
                    amountGroups[amount] = []; 
                }
                amountGroups[amount].push(donor);
            }
        }

        // ì†Œì•¡ í•„í„°ë§ (0.1ë§Œì› ë¯¸ë§Œ ì œì™¸)
        const filteredGroups = Object.entries(amountGroups).filter(([amount]) => parseFloat(amount) >= 0.1);
        const sortedGroups = filteredGroups.sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
        
        if (sortedGroups.length === 0) {
            contentEl.textContent = 'ì‚¬ë‘í•´ìš”â™¡';
            contentEl.className = 'no-data';
            return;
        }
        
        // ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ í…ìŠ¤íŠ¸ ìƒì„±
        const donorTotalText = sortedGroups.map(([amount, donors]) => {
            const amountStr = `${parseFloat(amount)}ë§Œ`;
            if (donors.length >= groupThreshold) {
                return `${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`;
            } else {
                return donors.map(d => `${d}ë‹˜ ${amountStr}`).join('\n');
            }
        }).join('\n');
        
        // "ì‚¬ë‘í•´ìš”â™¡" ì¸ì‚¬ë§ê³¼ í•¨ê»˜ í‘œì‹œ (ì •ì‚°ìš”ì•½ê³¼ ë™ì¼)
        let finalText = donorTotalText ? `ì‚¬ë‘í•´ìš”â™¡\n${donorTotalText}` : 'ì‚¬ë‘í•´ìš”â™¡';
        
        // ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ ì¶”ê°€ (í›„ì›ìê°€ ìˆì„ ë•Œ) - DOM ì§ì ‘ ì¡°ì‘ ë°©ì‹
        if (showKakaoBank) {
            // DOM ìš”ì†Œ ì§ì ‘ ìƒì„±ìœ¼ë¡œ ì™„ì „í•œ ì œì–´
            contentEl.innerHTML = '';
            
            // ì¹´ì¹´ì˜¤ë±…í¬ ì •ë³´ DOM ìƒì„±
            const bankDiv = document.createElement('div');
            bankDiv.style.cssText = `font-size: ${kakaoBankSize}%; line-height: 1.0 !important; margin: 0 !important; padding: 0 !important; display: block !important;`;
            bankDiv.className = 'kakao-bank-info';
            
            const bankName = document.createElement('div');
            bankName.textContent = 'ì¹´ì¹´ì˜¤ë±…í¬';
            bankName.style.cssText = 'margin: 0 !important; padding: 0 !important; line-height: 1.0 !important; font-weight: bold; color: #FFEB3B;';
            
            const bankAccount = document.createElement('div');
            bankAccount.textContent = '3333-25-7378436';
            bankAccount.style.cssText = 'margin: 0 !important; padding: 0 !important; line-height: 1.0 !important; font-size: 90%; color: white;';
            
            bankDiv.appendChild(bankName);
            bankDiv.appendChild(bankAccount);
            contentEl.appendChild(bankDiv);
            
            // í›„ì›ì í…ìŠ¤íŠ¸ë¥¼ ê° ì¤„ë³„ë¡œ DOM ìƒì„± (br íƒœê·¸ ì™„ì „ ë°°ì œ)
            const textDiv = document.createElement('div');
            textDiv.className = 'donor-text';
            textDiv.style.cssText = 'line-height: 1.0 !important; margin: 0 !important; padding: 0 !important; display: block !important;';
            
            const lines = finalText.split('\\n');
            lines.forEach((line, index) => {
                const lineSpan = document.createElement('span');
                lineSpan.textContent = line;
                lineSpan.style.cssText = 'display: block !important; line-height: 1.0 !important; margin: 0 !important; padding: 0 !important;';
                textDiv.appendChild(lineSpan);
            });
            
            contentEl.appendChild(textDiv);
        } else {
            contentEl.innerHTML = '<div style="line-height: 1.2;">' + finalText.replace(/\n/g, '<br>') + '</div>';
        }
        contentEl.className = 'donor-content';
        
        console.log('ğŸ“Š í™”ë©´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', sortedGroups.length, 'ê°œ ê·¸ë£¹ì˜ í›„ì›ì');
    }
    
    showError(message) {
        const contentEl = document.getElementById('donor-content');
        contentEl.textContent = message;
        contentEl.className = 'no-data';
        contentEl.style.color = '#ffcccb';
    }
    
    flashUpdate() {
        // ëª¨ë°”ì¼ì—ì„œ ë°°í„°ë¦¬ ì ˆì•½ì„ ìœ„í•´ flashUpdate ë¹„í™œì„±í™”
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isSmallScreen = window.innerWidth <= 768;
        
        if (isMobile || isSmallScreen) {
            console.log('ğŸ“± ëª¨ë°”ì¼/ì†Œí™”ë©´ ê°ì§€: flashUpdate ë¹„í™œì„±í™”');
            return;
        }
        
        const container = document.querySelector('.overlay-container');
        if (container) {
            container.style.opacity = '0.7';
            setTimeout(() => {
                container.style.opacity = '1';
            }, 200);
        }
    }
    
    setupKeyboardControls() {
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '1': // Alt+1: ì™¼ìª½ ì •ë ¬
                        this.settings['overlay-text-align'] = 'left';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ì™¼ìª½');
                        break;
                    case '2': // Alt+2: ê°€ìš´ë° ì •ë ¬
                        this.settings['overlay-text-align'] = 'center';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ê°€ìš´ë°');
                        break;
                    case '3': // Alt+3: ì˜¤ë¥¸ìª½ ì •ë ¬
                        this.settings['overlay-text-align'] = 'right';
                        this.applySettings();
                        this.updateDisplay();
                        console.log('ì •ë ¬: ì˜¤ë¥¸ìª½');
                        break;
                    case '=': // Alt+=: í°íŠ¸ í¬ê¸° ì¦ê°€
                        this.settings['overlay-font-size'] = Math.min(50, (this.settings['overlay-font-size'] || 18) + 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                    case '-': // Alt+-: í°íŠ¸ í¬ê¸° ê°ì†Œ
                        this.settings['overlay-font-size'] = Math.max(10, (this.settings['overlay-font-size'] || 18) - 2);
                        this.applySettings();
                        this.updateDisplay();
                        console.log('í°íŠ¸ í¬ê¸°:', this.settings['overlay-font-size']);
                        break;
                }
                e.preventDefault();
            }
        });
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ - Cache Buster v2024082001
document.addEventListener('DOMContentLoaded', () => {
    console.log('ğŸ¬ ì‹¤ì‹œê°„ í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘ - v2024082001 DOMì§ì ‘ì¡°ì‘ë°©ì‹');
    console.log('ğŸ”§ ì¹´ì¹´ì˜¤ë±…í¬ ê°„ê²© ì™„ì „ê³ ì • - bríƒœê·¸ ì™„ì „ë°°ì œ DOMìƒì„±ë°©ì‹ ì ìš©');
    new RealtimeDonorOverlay();
});
</script>

</body>
</html>