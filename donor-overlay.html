<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ”´ ì‹¤ì‹œê°„ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO for Real-time -->
<script src="/socket.io/socket.io.js"></script>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 800px;
    width: 100%;
}

.donor-content {
    font-size: var(--overlay-font-size, 18px) !important;
    font-weight: bold;
    color: white;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000, 3px 0px 0 #000000, -3px 0px 0 #000000, 0px 3px 0 #000000, 0px -3px 0 #000000) !important;
    line-height: 1.5;
    white-space: pre-line;
    padding: 0;
    text-align: var(--overlay-text-align, left) !important;
}

.donor-content * {
    font-size: inherit !important;
    text-align: inherit !important;
}

.no-data {
    font-size: var(--overlay-font-size, 20px) !important;
    font-weight: bold;
    color: #FFD700;
    text-shadow: var(--overlay-text-shadow, 3px 3px 0 #000000, -3px -3px 0 #000000, 3px -3px 0 #000000, -3px 3px 0 #000000) !important;
    text-align: var(--overlay-text-align, center) !important;
    padding: 40px 20px;
}

.loading {
    color: #87CEEB;
    text-align: center;
    font-size: 16px;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì› */
.transparent-mode {
    background: #00FF00;
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
</div>

<script>
let donations = [];
let isTransparentMode = false;
let socket = null;
let isSocketConnected = false;

// ğŸ”´ ì‹¤ì‹œê°„ Socket.io ì—°ê²° ì´ˆê¸°í™”
function initializeRealtimeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isSocketConnected = true;
            console.log('ğŸ”— ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²°ë¨');
        });
        
        socket.on('disconnect', () => {
            isSocketConnected = false;
            console.log('âŒ ì‹¤ì‹œê°„ ì„œë²„ ì—°ê²° ëŠì–´ì§');
        });
        
        socket.on('initialData', (data) => {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            donations = data.donations || [];
            updateDonorDisplay();
        });
        
        socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] í˜„ì¬ ì—°ê²° ìƒíƒœ:', isSocketConnected);
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] ìˆ˜ì‹ ëœ í›„ì› ë°ì´í„°:', data.donations?.length || 0, 'ê±´');
            
            donations = data.donations || [];
            console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] ìƒˆ ë°ì´í„°ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸:', donations.length, 'ê±´');
            updateDonorDisplay();
            
            // localStorage ë™ê¸°í™” (ë¡œì»¬ëª¨ë“œì—ì„œ ë°ì´í„° ë¶€í™œ ë°©ì§€)
            try {
                localStorage.setItem('donation_data', JSON.stringify(donations));
                console.log('ğŸ“± [ì˜¤ë²„ë ˆì´] localStorage ë™ê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ [ì˜¤ë²„ë ˆì´] localStorage ì €ì¥ ì‹¤íŒ¨:', error);
            }
            
            // í™”ë©´ ê¹œë°•ì„ íš¨ê³¼ë¡œ ì—…ë°ì´íŠ¸ í‘œì‹œ
            const container = document.querySelector('.overlay-container');
            if (container) {
                container.style.opacity = '0.7';
                setTimeout(() => {
                    container.style.opacity = '1';
                }, 200);
            }
        });
        
        socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
            applySettings(settings);
            updateDonorDisplay();
        });
        
    } catch (error) {
        console.error('Socket.io ì´ˆê¸°í™” ì‹¤íŒ¨, ì„œë²„ APIë¡œ ë°ì´í„° ë¡œë“œ ì‹œë„:', error);
        loadDataFromServer(); // ì„œë²„ APIì—ì„œ ì§ì ‘ ë¡œë“œ
}

// GitHubì—ì„œ ë°ì´í„° ë¡œë“œ (ë°±ì—…ìš©)
async function loadDataFromGitHub() {
    try {
        console.log('GitHubì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„...');
        
        // GitHub raw íŒŒì¼ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch('https://raw.githubusercontent.com/fzsaxzzzzzzzzzzzzz/donation-manager/main/data.json?t=' + Date.now());
        
        if (response.ok) {
            const data = await response.json();
            console.log('GitHub ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
            
            if (data.donations && Array.isArray(data.donations)) {
                donations = data.donations.map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
            } else {
                donations = [];
            }
            
            // GitHub ì„¤ì •ì„ í•­ìƒ ì ìš© (ë‹¤ë¥¸ PCì—ì„œ ìµœì‹  ì„¤ì • ë™ê¸°í™”)
            if (data.settings && typeof data.settings === 'object') {
                console.log('ğŸ”„ GitHub ì„¤ì • ë™ê¸°í™” ì‹œì‘...');
                Object.entries(data.settings).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) {
                        const oldValue = localStorage.getItem(key);
                        localStorage.setItem(key, value);
                        console.log(`ğŸ“ ì„¤ì • ë™ê¸°í™”: ${key} ${oldValue} â†’ ${value}`);
                    }
                });
                console.log('âœ… GitHub ì„¤ì • ë™ê¸°í™” ì™„ë£Œ');
            }
            
            updateDonorDisplay();
            applyOverlaySettings(); // ì„¤ì • ì ìš©
            return;
        }
    } catch (error) {
        console.log('GitHub ë¡œë“œ ì‹¤íŒ¨, localStorage ì‹œë„...', error);
    }
    
    // GitHub ì‹¤íŒ¨ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‹œë„
    try {
        const savedData = localStorage.getItem('donation_data');
        if (savedData) {
            donations = JSON.parse(savedData).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
            console.log('localStorageì—ì„œ ë°ì´í„° ë¡œë“œ:', donations.length);
        } else {
            donations = [];
        }
    } catch (error) {
        console.error('localStorage ë¡œë“œ ì‹¤íŒ¨:', error);
        donations = [];
    }
    
    updateDonorDisplay();
}

// ì„¤ì • ì ìš© í•¨ìˆ˜
function applyOverlaySettings() {
    try {
        // localStorageì—ì„œ ì„¤ì • ë¡œë“œ
        const fontSize = localStorage.getItem('overlay-font-size') || '18';
        const strokeWidth = localStorage.getItem('overlay-stroke-width') || '3';
        const textAlign = localStorage.getItem('overlay-text-align') || 'left';
        
        console.log('ğŸ”§ ì„¤ì • ì ìš©:', { fontSize, strokeWidth, textAlign });
        
        // ëª¨ë“  í…ìŠ¤íŠ¸ ìš”ì†Œì— ê°•ì œë¡œ ìŠ¤íƒ€ì¼ ì ìš©
        const contentEl = document.getElementById('donor-content');
        const noDataEl = document.querySelector('.no-data');
        
        [contentEl, noDataEl].forEach(el => {
            if (el) {
                // !important íš¨ê³¼ë¥¼ ìœ„í•´ ì§ì ‘ ìŠ¤íƒ€ì¼ ì†ì„± ì„¤ì •
                el.style.fontSize = fontSize + 'px !important';
                el.style.textAlign = textAlign + ' !important';
                
                // í…ìŠ¤íŠ¸ ì‰ë„ìš°(í…Œë‘ë¦¬) ì ìš©
                const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`;
                el.style.textShadow = shadow + ' !important';
                
                console.log('âœ… ìŠ¤íƒ€ì¼ ì ìš©ë¨:', el.className, 'fontSize:', fontSize + 'px');
            }
        });
        
        // ìì‹ ìš”ì†Œë“¤ì—ë„ ì ìš©
        const allTextElements = document.querySelectorAll('.donor-content, .no-data, .donor-content *');
        allTextElements.forEach(el => {
            el.style.fontSize = fontSize + 'px';
            el.style.textAlign = textAlign;
        });
        
        // CSS ë³€ìˆ˜ë„ í•¨ê»˜ ì„¤ì •
        document.documentElement.style.setProperty('--overlay-font-size', fontSize + 'px');
        document.documentElement.style.setProperty('--overlay-stroke-width', strokeWidth + 'px');
        document.documentElement.style.setProperty('--overlay-text-align', textAlign);
        
        // í…ìŠ¤íŠ¸ ì‰ë„ìš° CSS ë³€ìˆ˜ ì„¤ì •
        const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`;
        document.documentElement.style.setProperty('--overlay-text-shadow', shadow);
        
    } catch (error) {
        console.error('âŒ ì„¤ì • ì ìš© ì‹¤íŒ¨:', error);
    }
}

// í™”ë©´ ì—…ë°ì´íŠ¸
function updateDonorDisplay() {
    console.log('ğŸ¨ [ì˜¤ë²„ë ˆì´] updateDonorDisplay ì‹œì‘');
    console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] donations:', donations);
    console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] donations.length:', donations?.length || 0);
    
    const contentEl = document.getElementById('donor-content');
    
    if (!donations || donations.length === 0) {
        console.log('âš ï¸ [ì˜¤ë²„ë ˆì´] í›„ì› ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ');
        contentEl.innerHTML = 'ì‚¬ë‘í•´ìš”â™¡';
        contentEl.className = 'no-data'; // í´ë˜ìŠ¤ ì§ì ‘ ì§€ì •
        applyOverlaySettings(); // ì„¤ì • ì ìš©
        setTimeout(() => {
            applyOverlaySettings(); // í•œ ë²ˆ ë” ì ìš©
        }, 100);
        console.log('âœ… [ì˜¤ë²„ë ˆì´] ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ');
        return;
    }
    
    // í›„ì›ìë³„ ê³„ì¢Œ í›„ì› ì´ì•¡ ê³„ì‚°
    const donorTotals = {};
    console.log('ğŸ’° [ì˜¤ë²„ë ˆì´] í›„ì›ì ì´ì•¡ ê³„ì‚° ì‹œì‘');
    
    donations.forEach(d => {
        console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] í›„ì› ë°ì´í„°:', d);
        if (d.type === 'ê³„ì¢Œ') {
            // í›„ì›ìëª…ì—ì„œ ì¡°ì • ë¶€ë¶„ ì œê±°
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(ì¡°ì •')) {
                cleanDonorName = cleanDonorName.replace(/\(ì¡°ì •[^)]*\)/g, '').trim();
            }
            
            const amount = parseFloat(d.amount) || 0;
            if (amount > 0) {
                donorTotals[cleanDonorName] = (donorTotals[cleanDonorName] || 0) + amount;
                console.log(`ğŸ’° [ì˜¤ë²„ë ˆì´] ${cleanDonorName}: ${amount}ë§Œ (ì´: ${donorTotals[cleanDonorName]}ë§Œ)`);
            }
        }
    });
    
    console.log('ğŸ’° [ì˜¤ë²„ë ˆì´] ìµœì¢… í›„ì›ì ì´ì•¡:', donorTotals);
    
    // ê¸ˆì•¡ìˆœìœ¼ë¡œ ì •ë ¬
    const sortedDonors = Object.entries(donorTotals)
        .filter(([name, amount]) => amount > 0 && name.trim() !== '')
        .sort(([,a], [,b]) => b - a);
    
    console.log('ğŸ† [ì˜¤ë²„ë ˆì´] ì •ë ¬ëœ í›„ì›ì:', sortedDonors);
    
    // í‘œì‹œ í…ìŠ¤íŠ¸ ìƒì„±
    let displayText = "ì‚¬ë‘í•´ìš”â™¡\n";
    if (sortedDonors.length > 0) {
        displayText += sortedDonors.map(([name, amount]) => 
            `${name}ë‹˜ ${parseFloat(amount.toFixed(1))}ë§Œ`
        ).join('\n');
        console.log('âœ¨ [ì˜¤ë²„ë ˆì´] ìƒì„±ëœ í‘œì‹œ í…ìŠ¤íŠ¸:', displayText);
    } else {
        displayText = "ì‚¬ë‘í•´ìš”â™¡";
    }
    
    contentEl.innerHTML = displayText;
    contentEl.className = 'donor-content'; // í´ë˜ìŠ¤ ì§ì ‘ ì§€ì •
    console.log('í™”ë©´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', sortedDonors.length + 'ëª…');
    
    // ì„¤ì • ì¦‰ì‹œ ì ìš©
    applyOverlaySettings();
    
    // 0.1ì´ˆ í›„ í•œ ë²ˆ ë” ì ìš© (DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ í›„)
    setTimeout(() => {
        applyOverlaySettings();
    }, 100);
}

// ì„œë²„ APIì—ì„œ ë°ì´í„° ë¡œë“œ
async function loadDataFromServer() {
    try {
        console.log('ì„œë²„ APIì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„...');
        
        const response = await fetch('/api/data');
        if (response.ok) {
            const data = await response.json();
            console.log('ì„œë²„ API ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
            
            if (data.donations && Array.isArray(data.donations)) {
                donations = data.donations.map(d => ({
                    ...d,
                    time: new Date(d.time),
                    amount: parseFloat(d.amount) || 0
                }));
            } else {
                donations = [];
            }
            
            // localStorage ë™ê¸°í™”
            try {
                localStorage.setItem('donation_data', JSON.stringify(donations));
                console.log('ğŸ“± ì„œë²„ API ë°ì´í„°ë¡œ localStorage ë™ê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('localStorage ì €ì¥ ì‹¤íŒ¨:', error);
            }
            
            updateDonorDisplay();
            applyOverlaySettings();
            return;
        }
    } catch (error) {
        console.log('ì„œë²„ API ë¡œë“œ ì‹¤íŒ¨, localStorage ì‹œë„...', error);
    }
    
    // ì„œë²„ API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‹œë„
    try {
        const savedData = localStorage.getItem('donation_data');
        if (savedData) {
            donations = JSON.parse(savedData).map(d => ({
                ...d,
                time: new Date(d.time),
                amount: parseFloat(d.amount) || 0
            }));
            console.log('localStorageì—ì„œ ë°ì´í„° ë¡œë“œ:', donations.length);
        } else {
            donations = [];
        }
    } catch (error) {
        console.error('localStorage ë¡œë“œ ì‹¤íŒ¨:', error);
        donations = [];
    }
    
    updateDonorDisplay();
}

// í¬ë¡œë§ˆí‚¤ ëª¨ë“œ í† ê¸€
function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            loadDataFromServer();
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// ğŸ”´ ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ì‹œì‘
console.log('ğŸ”´ ì‹¤ì‹œê°„ í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘...');
initializeRealtimeConnection();

// ë°±ì—…ìš© ìë™ ìƒˆë¡œê³ ì¹¨ (ì‹¤ì‹œê°„ ì—°ê²° ì‹¤íŒ¨ ì‹œì—ë§Œ)
setInterval(() => {
    if (!isSocketConnected) {
        console.log('ì‹¤ì‹œê°„ ì—°ê²° ì—†ìŒ, ì„œë²„ APIë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
        loadDataFromServer();
    }
}, 15000); // 15ì´ˆë§ˆë‹¤

// ì„¤ì •ì„ ì£¼ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ê³  ì ìš© (ì‹¤ì‹œê°„ ë°˜ì˜)
setInterval(() => {
    const contentEl = document.getElementById('donor-content');
    if (contentEl) {
        console.log('ğŸ“ í˜„ì¬ ì‹¤ì œ í°íŠ¸í¬ê¸°:', window.getComputedStyle(contentEl).fontSize);
        console.log('ğŸ“ localStorage ì„¤ì •:', localStorage.getItem('overlay-font-size'));
    }
    applyOverlaySettings();
}, 1000);

// ê°•ë ¥í•œ ì„¤ì • ì ìš© í•¨ìˆ˜ (ë§¤ìš° ë¹ˆë²ˆí•˜ê²Œ ì‹¤í–‰) - ì„ì‹œ ë¹„í™œì„±í™”
/*
setInterval(() => {
    const contentEl = document.getElementById('donor-content');
    if (contentEl) {
        const fontSize = localStorage.getItem('overlay-font-size') || '18';
        const textAlign = localStorage.getItem('overlay-text-align') || 'left';
        
        // ë§¤ìš° ê°•ë ¥í•˜ê²Œ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
        const strokeWidth = localStorage.getItem('overlay-stroke-width') || '3';
        const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000, ${strokeWidth}px 0px 0 #000000, -${strokeWidth}px 0px 0 #000000, 0px ${strokeWidth}px 0 #000000, 0px -${strokeWidth}px 0 #000000`;
        
        contentEl.style.cssText = `
            font-size: ${fontSize}px !important;
            text-align: ${textAlign} !important;
            font-weight: bold !important;
            color: white !important;
            line-height: 1.5 !important;
            white-space: pre-line !important;
            text-shadow: ${shadow} !important;
        `;
    }
}, 500); // 0.5ì´ˆë§ˆë‹¤ ê°•ì œ ì ìš©
*/
</script>

</body>
</html>