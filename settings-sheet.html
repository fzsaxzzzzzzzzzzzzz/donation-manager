<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš™ï¸ ì‹¤ì‹œê°„ ì„¤ì • ê´€ë¦¬ ì‹œíŠ¸</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f8f9fa;
    color: #333;
    overflow: auto;
}

.header {
    background: #6f42c1;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header h1 {
    font-size: 1.4rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #42b72a;
    animation: pulse 2s infinite;
}

.status-dot.disconnected {
    background: #fa383e;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.main-content {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
}

.section-header {
    background: #495057;
    color: white;
    padding: 15px 20px;
    font-weight: 600;
    font-size: 1.1rem;
}

.section-content {
    padding: 20px;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.setting-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.setting-label {
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
}

.setting-control {
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
}

.setting-input:focus {
    outline: none;
    border-color: #6f42c1;
}

.setting-value {
    min-width: 60px;
    padding: 6px 10px;
    background: #e9ecef;
    border-radius: 4px;
    font-weight: 600;
    text-align: center;
    color: #495057;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.btn-primary {
    background: #6f42c1;
    color: white;
}

.btn-primary:hover {
    background: #5a359c;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

.action-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 20px;
}

.info-panel {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 0 6px 6px 0;
}

.success-message {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 12px 15px;
    border-radius: 6px;
    margin: 10px 0;
    display: none;
}

.overlay-preview {
    background: #000;
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin-top: 15px;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (max-width: 768px) {
    .settings-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .main-content {
        padding: 15px;
    }
}
</style>
</head>
<body>

<div class="header">
    <h1>âš™ï¸ ì‹¤ì‹œê°„ ì„¤ì • ê´€ë¦¬ ì‹œíŠ¸</h1>
    <div class="connection-status">
        <div class="status-dot" id="connectionDot"></div>
        <span id="connectionText">ì—°ê²° ì¤‘...</span>
    </div>
</div>

<div class="main-content">
    <div class="info-panel">
        <strong>ğŸŒ í¬ë¡œìŠ¤ ë””ë°”ì´ìŠ¤ ì„¤ì • ê´€ë¦¬</strong><br>
        ì´ í˜ì´ì§€ì—ì„œ ë³€ê²½í•œ ì„¤ì •ì€ ëª¨ë“  ì»´í“¨í„°ì™€ ë””ë°”ì´ìŠ¤ì˜ ì˜¤ë²„ë ˆì´ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.
    </div>

    <div id="successMessage" class="success-message"></div>

    <!-- ì˜¤ë²„ë ˆì´ ê¸°ë³¸ ì„¤ì • -->
    <div class="section">
        <div class="section-header">ğŸ¨ ì˜¤ë²„ë ˆì´ ê¸°ë³¸ ì„¤ì •</div>
        <div class="section-content">
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">í°íŠ¸ í¬ê¸°</div>
                    <div class="setting-control">
                        <input type="range" class="setting-input" id="overlay-font-size" min="10" max="50" value="24">
                        <div class="setting-value" id="overlay-font-size-value">24px</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">í…ìŠ¤íŠ¸ í…Œë‘ë¦¬ êµµê¸°</div>
                    <div class="setting-control">
                        <input type="range" class="setting-input" id="overlay-stroke-width" min="0" max="10" value="3">
                        <div class="setting-value" id="overlay-stroke-width-value">3px</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">í…ìŠ¤íŠ¸ ì •ë ¬</div>
                    <div class="setting-control">
                        <select class="setting-input" id="overlay-text-align">
                            <option value="left">ì™¼ìª½ ì •ë ¬</option>
                            <option value="center">ê°€ìš´ë° ì •ë ¬</option>
                            <option value="right">ì˜¤ë¥¸ìª½ ì •ë ¬</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="overlay-preview" id="overlayPreview">
                <div style="font-weight: bold;">ë¯¸ë¦¬ë³´ê¸°: ì‚¬ë‘í•´ìš”â™¡<br>í™ê¸¸ë™ë‹˜ 10ë§Œ<br>ê¹€ì² ìˆ˜ë‹˜ 5ë§Œ</div>
            </div>
        </div>
    </div>

    <!-- í…Œì´ë¸” ì„¤ì • -->
    <div class="section">
        <div class="section-header">ğŸ“Š í…Œì´ë¸” ì„¤ì •</div>
        <div class="section-content">
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">í…Œì´ë¸” íˆ¬ëª…ë„</div>
                    <div class="setting-control">
                        <input type="range" class="setting-input" id="table-opacity" min="0" max="100" value="85">
                        <div class="setting-value" id="table-opacity-value">85%</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">ìˆœìœ„ ìˆ«ì í¬ê¸°</div>
                    <div class="setting-control">
                        <input type="range" class="setting-input" id="table-number-size" min="8" max="30" value="16">
                        <div class="setting-value" id="table-number-size-value">16px</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">í…Œì´ë¸” í°íŠ¸ í¬ê¸°</div>
                    <div class="setting-control">
                        <input type="range" class="setting-input" id="table-font-size" min="8" max="24" value="14">
                        <div class="setting-value" id="table-font-size-value">14px</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">í…ìŠ¤íŠ¸ ìƒ‰ìƒ</div>
                    <div class="setting-control">
                        <input type="color" class="setting-input" id="table-text-color" value="#ffffff">
                        <div class="setting-value" id="table-text-color-value">#ffffff</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">ê·¸ë£¹ ì„ê³„ê°’</div>
                    <div class="setting-control">
                        <input type="number" class="setting-input" id="group-threshold" min="1" max="10" value="2">
                        <div class="setting-value" id="group-threshold-value">2ëª…</div>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">í…Œì´ë¸” ì œëª©</div>
                    <div class="setting-control">
                        <input type="text" class="setting-input" id="table-title" value="ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í‘œì‹œ ì˜µì…˜ -->
    <div class="section">
        <div class="section-header">ğŸ‘ï¸ í‘œì‹œ ì˜µì…˜</div>
        <div class="section-content">
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">ì´ê³„ í–‰ í‘œì‹œ</div>
                    <div class="setting-control">
                        <input type="checkbox" id="show-total-row" checked>
                        <label for="show-total-row">ì´ê³„ í–‰ ë³´ì´ê¸°</label>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ</div>
                    <div class="setting-control">
                        <input type="checkbox" id="show-update-time">
                        <label for="show-update-time">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ë³´ì´ê¸°</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="applyAllSettings()">
            ğŸ’¾ ëª¨ë“  ì„¤ì • ì ìš© ë° ì €ì¥
        </button>
        <button class="btn btn-success" onclick="resetToDefaults()">
            ğŸ”„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
        </button>
        <button class="btn btn-warning" onclick="testOverlays()">
            ğŸ§ª ì˜¤ë²„ë ˆì´ í…ŒìŠ¤íŠ¸
        </button>
    </div>
</div>

<script>
let socket = null;
let isConnected = false;
let currentSettings = {};

// Socket.io ì—°ê²°
function initializeConnection() {
    try {
        socket = io();
        
        socket.on('connect', () => {
            isConnected = true;
            updateConnectionStatus();
            console.log('ì„œë²„ì— ì—°ê²°ë¨');
        });
        
        socket.on('disconnect', () => {
            isConnected = false;
            updateConnectionStatus();
        });
        
        socket.on('initialData', (data) => {
            console.log('ì´ˆê¸° ë°ì´í„° ìˆ˜ì‹ :', data);
            if (data.settings) {
                currentSettings = data.settings;
                loadSettingsToUI();
            }
        });
        
        socket.on('settingsUpdate', (settings) => {
            console.log('ì„¤ì • ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', settings);
            currentSettings = settings;
            loadSettingsToUI();
        });
        
    } catch (error) {
        console.error('Socket.io ì—°ê²° ì‹¤íŒ¨:', error);
    }
}

// ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
function updateConnectionStatus() {
    const dot = document.getElementById('connectionDot');
    const text = document.getElementById('connectionText');
    
    if (isConnected) {
        dot.classList.remove('disconnected');
        text.textContent = 'ì‹¤ì‹œê°„ ì—°ê²°ë¨';
    } else {
        dot.classList.add('disconnected');
        text.textContent = 'ì—°ê²° ëŠê¹€';
    }
}

// UIì—ì„œ ì„¤ì • ë¡œë“œ
function loadSettingsToUI() {
    Object.entries(currentSettings).forEach(([key, value]) => {
        const element = document.getElementById(key);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value === 'true' || value === true;
            } else {
                element.value = value;
            }
            updateValueDisplay(key, value);
        }
    });
    updateOverlayPreview();
}

// ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateValueDisplay(key, value) {
    const valueEl = document.getElementById(key + '-value');
    if (valueEl) {
        if (key.includes('font-size') || key.includes('stroke-width') || key.includes('number-size')) {
            valueEl.textContent = value + 'px';
        } else if (key === 'table-opacity') {
            valueEl.textContent = value + '%';
        } else if (key === 'group-threshold') {
            valueEl.textContent = value + 'ëª…';
        } else if (key === 'table-text-color') {
            valueEl.textContent = value;
            valueEl.style.backgroundColor = value;
            valueEl.style.color = getContrastColor(value);
        } else {
            valueEl.textContent = value;
        }
    }
}

// ëŒ€ë¹„ ìƒ‰ìƒ ê³„ì‚°
function getContrastColor(hexColor) {
    const r = parseInt(hexColor.substr(1, 2), 16);
    const g = parseInt(hexColor.substr(3, 2), 16);
    const b = parseInt(hexColor.substr(5, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 128 ? '#000000' : '#ffffff';
}

// ì˜¤ë²„ë ˆì´ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
function updateOverlayPreview() {
    const preview = document.getElementById('overlayPreview');
    const fontSize = document.getElementById('overlay-font-size')?.value || '24';
    const strokeWidth = document.getElementById('overlay-stroke-width')?.value || '3';
    const textAlign = document.getElementById('overlay-text-align')?.value || 'center';
    
    const shadow = `${strokeWidth}px ${strokeWidth}px 0 #000000, -${strokeWidth}px -${strokeWidth}px 0 #000000, ${strokeWidth}px -${strokeWidth}px 0 #000000, -${strokeWidth}px ${strokeWidth}px 0 #000000`;
    
    preview.style.fontSize = fontSize + 'px';
    preview.style.textAlign = textAlign;
    preview.style.textShadow = shadow;
}

// ëª¨ë“  ì„¤ì • ì ìš©
async function applyAllSettings() {
    try {
        const settings = {};
        
        // ëª¨ë“  ì„¤ì • ìš”ì†Œì—ì„œ ê°’ ìˆ˜ì§‘
        const settingElements = document.querySelectorAll('[id^="overlay-"], [id^="table-"], [id^="show-"], [id^="group-"]');
        
        settingElements.forEach(element => {
            if (element.type === 'checkbox') {
                settings[element.id] = element.checked ? 'true' : 'false';
            } else {
                settings[element.id] = element.value;
            }
        });
        
        console.log('ì ìš©í•  ì„¤ì •:', settings);
        
        // ì„œë²„ì— ì„¤ì • ì „ì†¡
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ settings })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessMessage('âœ… ëª¨ë“  ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            currentSettings = { ...currentSettings, ...settings };
        } else {
            throw new Error(result.error || 'ì„¤ì • ì ìš© ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('ì„¤ì • ì ìš© ì‹¤íŒ¨:', error);
        showSuccessMessage('âŒ ì„¤ì • ì ìš©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
}

// ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
function resetToDefaults() {
    if (confirm('ëª¨ë“  ì„¤ì •ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const defaults = {
            'overlay-font-size': '24',
            'overlay-stroke-width': '3',
            'overlay-text-align': 'center',
            'table-opacity': '85',
            'table-number-size': '16',
            'table-font-size': '14',
            'table-text-color': '#ffffff',
            'group-threshold': '2',
            'show-total-row': 'true',
            'show-update-time': 'false',
            'table-title': 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†'
        };
        
        Object.entries(defaults).forEach(([key, value]) => {
            const element = document.getElementById(key);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value === 'true';
                } else {
                    element.value = value;
                }
                updateValueDisplay(key, value);
            }
        });
        
        updateOverlayPreview();
        applyAllSettings();
    }
}

// ì˜¤ë²„ë ˆì´ í…ŒìŠ¤íŠ¸
function testOverlays() {
    const overlayUrls = [
        '/donor-overlay.html',
        '/overlay-realtime.html',
        '/streamer-table-overlay.html'
    ];
    
    overlayUrls.forEach(url => {
        window.open(url, '_blank', 'width=800,height=600');
    });
    
    showSuccessMessage('ğŸ§ª ì˜¤ë²„ë ˆì´ í…ŒìŠ¤íŠ¸ ì°½ë“¤ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.');
}

// ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
function showSuccessMessage(message, type = 'success') {
    const msgEl = document.getElementById('successMessage');
    msgEl.textContent = message;
    msgEl.className = type === 'error' ? 'error-message' : 'success-message';
    msgEl.style.display = 'block';
    
    setTimeout(() => {
        msgEl.style.display = 'none';
    }, 3000);
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', () => {
    initializeConnection();
    
    // ëª¨ë“  ì„¤ì • ìš”ì†Œì— ë³€ê²½ ì´ë²¤íŠ¸ ì¶”ê°€
    const settingElements = document.querySelectorAll('[id^="overlay-"], [id^="table-"], [id^="show-"], [id^="group-"]');
    
    settingElements.forEach(element => {
        element.addEventListener('input', (e) => {
            updateValueDisplay(e.target.id, e.target.value);
            if (e.target.id.startsWith('overlay-')) {
                updateOverlayPreview();
            }
        });
        
        element.addEventListener('change', (e) => {
            updateValueDisplay(e.target.id, e.target.value);
            if (e.target.id.startsWith('overlay-')) {
                updateOverlayPreview();
            }
        });
    });
});
</script>

</body>
</html>