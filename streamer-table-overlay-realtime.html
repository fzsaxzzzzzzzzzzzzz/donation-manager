<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ìƒì„¸ í…Œì´ë¸” - ì‹¤ì‹œê°„ ì˜¤ë²„ë ˆì´</title>
<style>
body {
    margin: 0;
    padding: 20px;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

/* CSS variables for OBS compatibility */
:root {
    --bg-opacity: 0.85;
    --bg-color-1: 0,0,0;
    --bg-color-2: 30,30,30;
}

.overlay-container {
    background: rgba(0,0,0,0.85);
    border-radius: 8px;
    padding: 20px;
    max-width: 900px;
    border: 2px solid rgba(255,255,255,0.2);
    transition: opacity 0.5s ease-in-out;
}

.overlay-title {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #ffffff;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.streamer-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
    border-radius: 6px;
    overflow: hidden;
}

.streamer-table th {
    background: rgba(64,64,64,0.9);
    color: white;
    padding: 12px 10px;
    text-align: center;
    font-weight: bold;
    font-size: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.3);
}

.streamer-table td {
    padding: 10px;
    text-align: center;
    background: rgba(255,255,255,0.03);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    font-size: 14px;
}

.streamer-table tbody tr:nth-child(1) {
    background: rgba(255,215,0,0.15);
}
.streamer-table tbody tr:nth-child(2) {
    background: rgba(192,192,192,0.15);
}
.streamer-table tbody tr:nth-child(3) {
    background: rgba(205,127,50,0.15);
}

.rank-cell {
    font-weight: bold;
    font-size: 16px;
}

.rank-1 { color: #FFD700; font-weight: bold; }
.rank-2 { color: #C0C0C0; font-weight: bold; }
.rank-3 { color: #CD7F32; font-weight: bold; }

.streamer-name {
    font-weight: 600;
    font-size: 15px;
    color: #ffffff;
}

.amount-cell {
    font-weight: bold;
    color: #4ecdc4;
    font-size: 14px;
}

.total-row {
    background: rgba(64,64,64,0.6);
    border-top: 2px solid rgba(255,255,255,0.3);
    font-weight: bold;
}

.total-row td {
    padding: 12px 10px;
    font-size: 15px;
    color: #ffffff;
}

.update-time {
    text-align: center;
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    margin-top: 15px;
}

.no-data {
    text-align: center;
    color: rgba(255,255,255,0.7);
    font-size: 18px;
    padding: 60px 20px;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì›ì„ ìœ„í•œ íˆ¬ëª… ëª¨ë“œ */
.transparent-mode {
    background: #00FF00; /* í¬ë¡œë§ˆí‚¤ ê·¸ë¦° */
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border: 2px solid rgba(255,255,255,0.8);
}

/* ì—°ê²° ìƒíƒœ í‘œì‹œ */
.connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
}

.connected {
    background: rgba(0, 255, 0, 0.8);
    color: white;
}

.disconnected {
    background: rgba(255, 0, 0, 0.8);
    color: white;
}

.connecting {
    background: rgba(255, 255, 0, 0.8);
    color: black;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .overlay-container {
        max-width: 100%;
        padding: 15px;
    }
    
    .streamer-table th,
    .streamer-table td {
        padding: 8px 6px;
        font-size: 12px;
    }
    
    .overlay-title {
        font-size: 20px;
    }
}
</style>
</head>
<body>

<div class="connection-status connecting" id="connection-status">ì—°ê²° ì¤‘...</div>

<div class="overlay-container" id="overlay-container">
    <div class="overlay-title" id="overlay-title">ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†</div>
    <div id="table-container">
        <div class="no-data">ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
    <div class="update-time" id="update-time">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: --:--</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
// Socket.io ì—°ê²°
const socket = io();

let donationData = [];
let streamerConfig = [];
let emojiConfig = {};
let serverSettings = {};
let serverRankNames = {};
let isTransparentMode = false;
let currentData = [];

// ì—°ê²° ìƒíƒœ ê´€ë¦¬
const connectionStatus = document.getElementById('connection-status');

socket.on('connect', () => {
    console.log('ì„œë²„ì— ì—°ê²°ë¨');
    connectionStatus.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
    connectionStatus.className = 'connection-status connected';
    setTimeout(() => {
        connectionStatus.style.display = 'none';
    }, 3000);
});

socket.on('disconnect', () => {
    console.log('ì„œë²„ ì—°ê²° ëŠì–´ì§');
    connectionStatus.textContent = 'ğŸ”´ ì—°ê²° ëŠì–´ì§';
    connectionStatus.className = 'connection-status disconnected';
    connectionStatus.style.display = 'block';
});

socket.on('connect_error', () => {
    console.log('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    connectionStatus.textContent = 'âš ï¸ ì—°ê²° ì‹¤íŒ¨';
    connectionStatus.className = 'connection-status disconnected';
});

// ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
socket.on('data-updated', (data) => {
    console.log('ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
    donationData = data.donations || [];
    streamerConfig = data.streamers || [];
    emojiConfig = data.emojis || {};
    serverSettings = data.settings || {};
    serverRankNames = data.rankNames || {};
    updateDisplay();
});

socket.on('donation-added', (donation) => {
    console.log('ìƒˆ í›„ì› ì¶”ê°€:', donation);
    // ë°ì´í„°ëŠ” data-updated ì´ë²¤íŠ¸ë¡œ ê°±ì‹ ë¨
});

socket.on('settings-updated', (settings) => {
    console.log('ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
    serverSettings = settings;
    applyTableSettings();
    updateDisplay();
});

socket.on('rank-names-updated', (rankNames) => {
    console.log('ìˆœë²ˆëª… ì—…ë°ì´íŠ¸:', rankNames);
    serverRankNames = rankNames;
    updateDisplay();
});

function applyTableSettings() {
    const overlayContainer = document.querySelector('.overlay-container');
    if (!overlayContainer) return;
    
    // íˆ¬ëª…ë„ ì„¤ì • ì ìš©
    const opacity = (serverSettings.tableOpacity || 85) / 100;
    overlayContainer.style.backgroundColor = `rgba(0,0,0,${opacity})`;
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©
    const preset = serverSettings.tablePreset || 'dark';
    switch (preset) {
        case 'blue':
            overlayContainer.style.backgroundColor = `rgba(0,50,100,${opacity})`;
            break;
        case 'green':
            overlayContainer.style.backgroundColor = `rgba(0,50,0,${opacity})`;
            break;
        case 'purple':
            overlayContainer.style.backgroundColor = `rgba(50,0,100,${opacity})`;
            break;
        case 'dark':
        default:
            overlayContainer.style.backgroundColor = `rgba(0,0,0,${opacity})`;
            break;
    }
}

function updateDisplay() {
    // ì„¤ì • ë¡œë“œ
    const showTotalRow = (serverSettings.showTotalRow || 'true') !== 'false';
    const showUpdateTime = (serverSettings.showUpdateTime || 'false') === 'true';
    const tableTitle = serverSettings.tableTitle || 'ğŸ† ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ í›„ì› í˜„í™© ğŸ†';
    
    // í…Œì´ë¸” ì œëª© ì—…ë°ì´íŠ¸
    document.getElementById('overlay-title').textContent = tableTitle;
    
    // ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ/ìˆ¨ê¸°ê¸°
    const updateTimeEl = document.getElementById('update-time');
    if (showUpdateTime && updateTimeEl) {
        updateTimeEl.style.display = 'block';
        updateTimeEl.textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}`;
    } else if (updateTimeEl) {
        updateTimeEl.style.display = 'none';
    }
    
    if (!donationData || donationData.length === 0) {
        document.getElementById('table-container').innerHTML = 
            '<div class="no-data">ğŸ“‹ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤<br>ë©”ì¸ í˜ì´ì§€ì—ì„œ í›„ì›ì„ ë“±ë¡í•˜ì„¸ìš”</div>';
        return;
    }

    // êµ­ê³ , í›„ì›ìì¡°ì •, ìˆ¨ê²¨ì§„ ìŠ¤íŠ¸ë¦¬ë¨¸ë“¤ì„ ì œì™¸
    const hiddenStreamers = JSON.parse(serverSettings.hiddenStreamers || '[]');
    const summaryStreamers = streamerConfig.filter(s => s !== 'êµ­ê³ ' && s !== 'í›„ì›ìì¡°ì •' && !hiddenStreamers.includes(s));
    const streamerData = {};
    
    // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ë°ì´í„° ì´ˆê¸°í™”
    summaryStreamers.forEach(s => {
        streamerData[s] = { name: s, account: 0, toonation: 0, total: 0 };
    });

    // í›„ì› ë°ì´í„° ì§‘ê³„
    donationData.forEach(d => {
        if (streamerData.hasOwnProperty(d.streamer)) {
            const amountInWon = (parseFloat(d.amount) || 0) * 10000;
            if (d.type === 'ê³„ì¢Œ') {
                streamerData[d.streamer].account += amountInWon;
            } else if (d.type === 'íˆ¬ë„¤') {
                streamerData[d.streamer].toonation += amountInWon;
            }
        }
    });

    // ì´ì•¡ ê³„ì‚° ë° ì •ë ¬
    let sortedStreamers = Object.values(streamerData).map(data => {
        data.total = data.account + data.toonation;
        return data;
    }).sort((a, b) => b.total - a.total);

    const tableContainer = document.getElementById('table-container');
    
    if (sortedStreamers.every(s => s.total === 0)) {
        tableContainer.innerHTML = '<div class="no-data">ğŸ’³ ê³„ì¢Œ/íˆ¬ë„¤ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
    }

    // ì»¤ìŠ¤í…€ ìˆœë²ˆëª… ì ìš©
    function getRankName(index) {
        const rankNumber = index + 1;
        
        // ì„œë²„ì—ì„œ ë°›ì€ ìˆœë²ˆëª… í™•ì¸ (í‚¤ëŠ” ìˆ«ì)
        const customRankName = serverRankNames[rankNumber];
        if (customRankName && customRankName.trim() !== '') {
            const result = customRankName.trim();
            console.log(`Rank ${rankNumber}: ${result}`);
            return result;
        }
        
        // ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ìˆ«ìë¡œ í‘œì‹œ
        console.log(`Rank ${rankNumber}: ${rankNumber} (default)`);
        return rankNumber.toString();
    }

    // ì „ì²´ ì´ì•¡ ê³„ì‚°
    const totalAccount = sortedStreamers.reduce((sum, s) => sum + s.account, 0);
    const totalToonation = sortedStreamers.reduce((sum, s) => sum + s.toonation, 0);
    const grandTotal = totalAccount + totalToonation;

    // ê¸°ì¡´ í…Œì´ë¸”ì´ ìˆëŠ”ì§€ í™•ì¸
    const existingTable = tableContainer.querySelector('.streamer-table');
    
    if (!existingTable || !arraysEqual(currentData, sortedStreamers)) {
        // ì´í•©ê³„ í–‰ HTML (ì˜µì…˜ì— ë”°ë¼)
        let totalRowHtml = '';
        if (showTotalRow) {
            totalRowHtml = `<tr class="total-row">
                <td colspan="2"><strong>ğŸ† ì´ í•©ê³„</strong></td>
                <td class="total-account"><strong>${totalAccount.toLocaleString('ko-KR')}</strong></td>
                <td class="total-toonation"><strong>${totalToonation.toLocaleString('ko-KR')}</strong></td>
                <td class="total-grand"><strong>${grandTotal.toLocaleString('ko-KR')}</strong></td>
            </tr>`;
        }
        
        // í…Œì´ë¸” êµ¬ì¡°ê°€ ì—†ê±°ë‚˜ ìŠ¤íŠ¸ë¦¬ë¨¸ ìˆœì„œê°€ ë°”ë€ ê²½ìš°ë§Œ ì „ì²´ ì¬ìƒì„±
        const tableHtml = `
            <table class="streamer-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">ìˆœìœ„</th>
                        <th style="width: 25%;">ìŠ¤íŠ¸ë¦¬ë¨¸</th>
                        <th style="width: 25%;">ê³„ì¢Œí›„ì›</th>
                        <th style="width: 25%;">íˆ¬ë„¤í›„ì›</th>
                        <th style="width: 25%;">ì´ í›„ì›</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedStreamers.map((data, index) => `
                        <tr>
                            <td class="rank-cell rank-${index + 1 <= 3 ? index + 1 : ''}">${getRankName(index)}</td>
                            <td class="streamer-name">${emojiConfig[data.name] || ''} ${data.name}</td>
                            <td class="amount-cell" data-streamer="${data.name}" data-type="account">${data.account.toLocaleString('ko-KR')}</td>
                            <td class="amount-cell" data-streamer="${data.name}" data-type="toonation">${data.toonation.toLocaleString('ko-KR')}</td>
                            <td class="amount-cell" data-streamer="${data.name}" data-type="total">${data.total.toLocaleString('ko-KR')}</td>
                        </tr>
                    `).join('')}
                    ${totalRowHtml}
                </tbody>
            </table>
            <p style="text-align: center; font-size: 13px; color: rgba(255,255,255,0.7); margin-top: 10px;">
                â€» ìŠˆí¼ì±—(êµ­ê³ )ì„ ì œì™¸í•œ í›„ì› ë‚´ì—­ì…ë‹ˆë‹¤
            </p>
        `;
        tableContainer.innerHTML = tableHtml;
        applySettings();
    } else {
        // ìˆ«ìë§Œ ì—…ë°ì´íŠ¸
        sortedStreamers.forEach((data) => {
            const accountCell = tableContainer.querySelector(`[data-streamer="${data.name}"][data-type="account"]`);
            const toonationCell = tableContainer.querySelector(`[data-streamer="${data.name}"][data-type="toonation"]`);
            const totalCell = tableContainer.querySelector(`[data-streamer="${data.name}"][data-type="total"]`);
            
            if (accountCell) accountCell.textContent = data.account.toLocaleString('ko-KR');
            if (toonationCell) toonationCell.textContent = data.toonation.toLocaleString('ko-KR');
            if (totalCell) totalCell.textContent = data.total.toLocaleString('ko-KR');
        });
        
        // ì´í•©ê³„ ì—…ë°ì´íŠ¸ (í‘œì‹œë˜ëŠ” ê²½ìš°ì—ë§Œ)
        if (showTotalRow) {
            const totalAccountCell = tableContainer.querySelector('.total-account strong');
            const totalToonationCell = tableContainer.querySelector('.total-toonation strong');
            const totalGrandCell = tableContainer.querySelector('.total-grand strong');
            
            if (totalAccountCell) totalAccountCell.textContent = totalAccount.toLocaleString('ko-KR');
            if (totalToonationCell) totalToonationCell.textContent = totalToonation.toLocaleString('ko-KR');
            if (totalGrandCell) totalGrandCell.textContent = grandTotal.toLocaleString('ko-KR');
        }
    }
    
    currentData = [...sortedStreamers];
}

function arraysEqual(a, b) {
    if (a.length !== b.length) return false;
    for (let i = 0; i < a.length; i++) {
        if (a[i].name !== b[i].name) return false;
    }
    return true;
}

function applySettings() {
    const savedOpacity = (serverSettings.tableOverlayOpacity || '85') / 100;
    const savedPreset = serverSettings.tableOverlayPreset || 'dark';
    
    const presets = {
        'dark': { color: '0,0,0' },
        'blue': { color: '25,25,112' },
        'purple': { color: '75,0,130' },
        'green': { color: '0,100,0' },
        'brown': { color: '101,67,33' }
    };
    
    const preset = presets[savedPreset] || presets.dark;
    
    // Apply settings directly to overlay container for OBS compatibility
    const overlayContainer = document.getElementById('overlay-container');
    if (overlayContainer) {
        overlayContainer.style.background = `rgba(${preset.color},${savedOpacity})`;
    }
}

function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
    
    if (isTransparentMode) {
        document.body.style.background = '#00FF00'; // í¬ë¡œë§ˆí‚¤ ê·¸ë¦°
    } else {
        document.body.style.background = 'transparent';
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ìš”ì²­
            socket.emit('request-data');
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// ì´ˆê¸°í™”
console.log('ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë¨¸ í…Œì´ë¸” ì˜¤ë²„ë ˆì´ ì‹œì‘ë¨');
</script>
</body>
</html>