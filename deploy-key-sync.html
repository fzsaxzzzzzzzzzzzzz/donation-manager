<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Keys 기반 동기화</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .step-card {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        
        .step-card.completed {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            color: #856404;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔑 Deploy Keys 기반 안전한 동기화</h1>
        <p>개인 토큰 대신 Deploy Key를 사용한 더 안전한 Git 동기화 방법</p>
        
        <!-- Deploy Keys 장점 -->
        <div class="step-card">
            <h3>✨ Deploy Keys의 장점</h3>
            <ul>
                <li><strong>보안성</strong>: 특정 저장소에만 접근 권한</li>
                <li><strong>권한 제한</strong>: 읽기 전용 또는 쓰기 권한 선택 가능</li>
                <li><strong>토큰 만료 없음</strong>: 개인 토큰과 달리 만료되지 않음</li>
                <li><strong>감사 추적</strong>: 키별로 접근 로그 관리</li>
                <li><strong>팀 공유</strong>: 개인 계정과 독립적</li>
            </ul>
        </div>
        
        <!-- 단계 1: SSH 키 생성 -->
        <div class="step-card" id="step1">
            <h3>1️⃣ SSH 키 페어 생성</h3>
            <p>Deploy Key용 전용 SSH 키를 생성합니다.</p>
            
            <div class="code-block">
                # SSH 키 생성 (Windows)
                ssh-keygen -t ed25519 -C "donation-manager-deploy-key" -f donation-deploy-key
                
                # 또는 RSA 키 (호환성이 더 좋음)
                ssh-keygen -t rsa -b 4096 -C "donation-manager-deploy-key" -f donation-deploy-key
            </div>
            
            <button onclick="generateSSHKey()">SSH 키 생성 도움말</button>
            <button onclick="checkSSHKey()">생성된 키 확인</button>
        </div>
        
        <!-- 단계 2: GitHub에 Deploy Key 등록 -->
        <div class="step-card" id="step2">
            <h3>2️⃣ GitHub에 Deploy Key 등록</h3>
            <p><code>donation-deploy-key.pub</code> 내용을 GitHub에 등록합니다.</p>
            
            <ol>
                <li>GitHub 저장소 → Settings → Deploy keys</li>
                <li>"Add deploy key" 클릭</li>
                <li>Title: "Donation Manager Deploy Key"</li>
                <li>Key: <code>donation-deploy-key.pub</code> 파일 내용 붙여넣기</li>
                <li>"Allow write access" ✅ 체크 (동기화용)</li>
            </ol>
            
            <button onclick="openGitHubDeployKeys()">GitHub Deploy Keys 열기</button>
            <button onclick="testDeployKey()">Deploy Key 테스트</button>
        </div>
        
        <!-- 단계 3: SSH Agent 설정 -->
        <div class="step-card" id="step3">
            <h3>3️⃣ SSH Agent 설정</h3>
            <p>생성한 키를 SSH Agent에 등록합니다.</p>
            
            <div class="code-block">
                # SSH Agent 시작 (Windows)
                eval $(ssh-agent -s)
                
                # 키 등록
                ssh-add donation-deploy-key
                
                # 등록된 키 확인
                ssh-add -l
            </div>
            
            <button onclick="startSSHAgent()">SSH Agent 시작</button>
            <button onclick="addSSHKey()">키 등록</button>
        </div>
        
        <!-- 단계 4: Git 원격 저장소 설정 -->
        <div class="step-card" id="step4">
            <h3>4️⃣ Git 원격 저장소 SSH 설정</h3>
            <p>HTTPS 대신 SSH를 사용하도록 원격 저장소를 변경합니다.</p>
            
            <div class="code-block">
                # 현재 원격 저장소 확인
                git remote -v
                
                # SSH로 변경
                git remote set-url origin git@github.com:fzsaxzzzzzzzzzzzzz/donation-manager.git
                
                # 변경 확인
                git remote -v
            </div>
            
            <button onclick="checkCurrentRemote()">현재 원격 저장소 확인</button>
            <button onclick="changeToSSH()">SSH로 변경</button>
        </div>
        
        <!-- 단계 5: Deploy Key 동기화 테스트 -->
        <div class="step-card" id="step5">
            <h3>5️⃣ Deploy Key 동기화 테스트</h3>
            <p>Deploy Key를 사용한 동기화가 정상 작동하는지 테스트합니다.</p>
            
            <div class="warning">
                <strong>주의:</strong> Deploy Key 사용 시 GitHub API 토큰이 필요하지 않습니다.
                Git 명령어를 직접 사용하여 더 안전하고 빠른 동기화가 가능합니다.
            </div>
            
            <button onclick="testSSHConnection()">SSH 연결 테스트</button>
            <button onclick="testGitPush()">Git Push 테스트</button>
            <button onclick="syncWithDeployKey()">Deploy Key 동기화</button>
        </div>
        
        <!-- 자동화 스크립트 -->
        <div class="step-card">
            <h3>🤖 자동화 스크립트</h3>
            <p>Deploy Key 기반 동기화 자동화를 위한 스크립트</p>
            
            <div class="code-block">
                # sync-with-deploy-key.bat
                @echo off
                echo Deploy Key 기반 동기화 시작...
                
                # 변경사항 확인
                git status
                
                # 스테이징
                git add data.json
                
                # 커밋
                git commit -m "자동 동기화: Deploy Key를 통한 데이터 업데이트"
                
                # 푸시 (Deploy Key 사용)
                git push origin main
                
                echo 동기화 완료!
                pause
            </div>
            
            <button onclick="createSyncScript()">동기화 스크립트 생성</button>
            <button onclick="runSyncScript()">스크립트 실행</button>
        </div>
    </div>

    <script>
        // SSH 키 생성 도움말
        function generateSSHKey() {
            const instructions = `
SSH 키 생성 단계:

1. 터미널 또는 Git Bash를 관리자 권한으로 실행
2. 다음 명령어 실행:
   ssh-keygen -t ed25519 -C "donation-manager-deploy" -f donation-deploy-key
   
3. 패스프레이즈 설정 (선택사항, 보안 강화)
4. 생성된 파일 확인:
   - donation-deploy-key (개인키 - 절대 공유 금지)
   - donation-deploy-key.pub (공개키 - GitHub에 등록)

파일 위치: ${process.cwd() || '현재 디렉토리'}
            `;
            
            alert(instructions);
            markStepCompleted('step1');
        }
        
        // SSH 키 확인
        function checkSSHKey() {
            const checkCommands = `
생성된 SSH 키 확인 명령어:

# 공개키 내용 보기 (GitHub에 등록할 내용)
cat donation-deploy-key.pub

# 개인키 권한 확인
ls -la donation-deploy-key

# SSH 키 지문 확인
ssh-keygen -lf donation-deploy-key.pub
            `;
            
            alert(checkCommands);
        }
        
        // GitHub Deploy Keys 페이지 열기
        function openGitHubDeployKeys() {
            const url = 'https://github.com/fzsaxzzzzzzzzzzzzz/donation-manager/settings/keys';
            window.open(url, '_blank');
            
            setTimeout(() => {
                const instructions = `
Deploy Key 등록 단계:

1. "Add deploy key" 버튼 클릭
2. Title: "Donation Manager Deploy Key"
3. Key 필드에 donation-deploy-key.pub 파일 내용 붙여넣기
4. "Allow write access" 체크박스 선택
5. "Add key" 버튼 클릭

등록 완료 후 "Deploy Key 테스트" 버튼을 클릭하세요.
                `;
                alert(instructions);
            }, 2000);
        }
        
        // Deploy Key 테스트
        function testDeployKey() {
            const testCommand = `
Deploy Key 테스트 명령어:

# SSH 연결 테스트
ssh -T git@github.com

성공 메시지: "Hi username! You've successfully authenticated, but GitHub does not provide shell access."

연결이 성공하면 Deploy Key가 정상 등록된 것입니다.
            `;
            
            alert(testCommand);
            markStepCompleted('step2');
        }
        
        // SSH Agent 시작
        function startSSHAgent() {
            const agentCommands = `
SSH Agent 시작 명령어:

Windows (Git Bash):
eval $(ssh-agent -s)

Windows (PowerShell):
Start-Service ssh-agent
            `;
            
            alert(agentCommands);
        }
        
        // SSH 키 등록
        function addSSHKey() {
            const addCommands = `
SSH 키를 Agent에 등록:

# 키 등록
ssh-add donation-deploy-key

# 패스프레이즈 입력 (설정한 경우)

# 등록 확인
ssh-add -l

등록된 키 목록이 표시되면 성공입니다.
            `;
            
            alert(addCommands);
            markStepCompleted('step3');
        }
        
        // 현재 원격 저장소 확인
        function checkCurrentRemote() {
            const checkCommand = `
현재 Git 원격 저장소 확인:

git remote -v

현재 HTTPS를 사용중인 경우:
origin  https://github.com/fzsaxzzzzzzzzzzzzz/donation-manager.git (fetch)
origin  https://github.com/fzsaxzzzzzzzzzzzzz/donation-manager.git (push)

SSH로 변경 필요: "SSH로 변경" 버튼 클릭
            `;
            
            alert(checkCommand);
        }
        
        // SSH로 변경
        function changeToSSH() {
            const changeCommand = `
원격 저장소를 SSH로 변경:

git remote set-url origin git@github.com:fzsaxzzzzzzzzzzzzz/donation-manager.git

변경 확인:
git remote -v

SSH 형태로 변경되었다면:
origin  git@github.com:fzsaxzzzzzzzzzzzzz/donation-manager.git (fetch)
origin  git@github.com:fzsaxzzzzzzzzzzzzz/donation-manager.git (push)
            `;
            
            alert(changeCommand);
            markStepCompleted('step4');
        }
        
        // SSH 연결 테스트
        function testSSHConnection() {
            const testCommand = `
SSH 연결 테스트:

ssh -T git@github.com

성공 메시지가 나타나면 연결 성공입니다.
            `;
            
            alert(testCommand);
        }
        
        // Git Push 테스트
        function testGitPush() {
            const pushTest = `
Git Push 테스트:

# 테스트 파일 생성
echo "Deploy Key 테스트" > deploy-key-test.txt

# 스테이징
git add deploy-key-test.txt

# 커밋
git commit -m "Deploy Key 테스트 커밋"

# 푸시 (Deploy Key 사용)
git push origin main

# 테스트 파일 삭제
git rm deploy-key-test.txt
git commit -m "테스트 파일 삭제"
git push origin main

푸시가 성공하면 Deploy Key 설정이 완료된 것입니다!
            `;
            
            alert(pushTest);
        }
        
        // Deploy Key 동기화
        async function syncWithDeployKey() {
            const syncInstructions = `
Deploy Key 기반 동기화 방법:

1. 더 이상 GitHub API 토큰이 필요하지 않습니다
2. Git 명령어를 직접 사용하여 동기화
3. SSH 키 기반으로 더 안전한 인증
4. 자동화 스크립트로 편리한 동기화

동기화 명령어:
git add data.json
git commit -m "Deploy Key 동기화: 후원 데이터 업데이트"
git push origin main

이제 GitHub API의 409 에러나 토큰 만료 문제가 없습니다!
            `;
            
            alert(syncInstructions);
            markStepCompleted('step5');
            
            // 성공 메시지 표시
            showSuccessMessage();
        }
        
        // 동기화 스크립트 생성
        function createSyncScript() {
            const script = `@echo off
title Deploy Key 자동 동기화
echo ========================================
echo     Deploy Key 기반 자동 동기화
echo ========================================
echo.

echo 1. Git 상태 확인 중...
git status

echo.
echo 2. data.json 스테이징...
git add data.json

echo.
echo 3. 커밋 생성 중...
git commit -m "자동 동기화: Deploy Key를 통한 데이터 업데이트 - %date% %time%"

echo.
echo 4. GitHub로 푸시 중...
git push origin main

echo.
echo ✅ 동기화 완료!
echo GitHub Pages에서 자동으로 오버레이가 업데이트됩니다.
echo.
pause`;
            
            // 스크립트 다운로드
            const blob = new Blob([script], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sync-with-deploy-key.bat';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('동기화 스크립트가 다운로드되었습니다!\n\n파일: sync-with-deploy-key.bat\n사용법: 더블클릭으로 실행');
        }
        
        // 스크립트 실행
        function runSyncScript() {
            alert('sync-with-deploy-key.bat 파일을 더블클릭하여 실행하세요.\n\n스크립트가 없다면 "동기화 스크립트 생성" 버튼을 먼저 클릭하세요.');
        }
        
        // 단계 완료 표시
        function markStepCompleted(stepId) {
            const stepCard = document.getElementById(stepId);
            if (stepCard) {
                stepCard.classList.add('completed');
            }
        }
        
        // 성공 메시지 표시
        function showSuccessMessage() {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.innerHTML = `
                <h4>🎉 Deploy Key 설정 완료!</h4>
                <p><strong>이제 다음과 같은 장점을 얻었습니다:</strong></p>
                <ul>
                    <li>✅ GitHub API 토큰 불필요</li>
                    <li>✅ 409 충돌 에러 없음</li>
                    <li>✅ 토큰 만료 걱정 없음</li>
                    <li>✅ 더 빠른 Git 동기화</li>
                    <li>✅ 향상된 보안성</li>
                </ul>
                <p>앞으로는 <code>sync-with-deploy-key.bat</code> 스크립트만 실행하면 자동으로 동기화됩니다!</p>
            `;
            
            document.querySelector('.container').appendChild(successDiv);
        }
        
        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Deploy Keys 설정 가이드 로드됨');
        });
    </script>
</body>
</html>