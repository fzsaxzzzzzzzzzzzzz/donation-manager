<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í›„ì›ìë³„ ì´ì•¡ - ì‹¤ì‹œê°„ ì˜¤ë²„ë ˆì´</title>
<style>
/* CSS variables for compatibility */
:root {
    --font-size: 16px;
    --stroke-width: 2px;
}

body {
    margin: 0;
    padding: 0;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: 600px;
    transition: all 0.3s ease-in-out;
    padding: 20px;
    box-sizing: border-box;
}

.donor-content {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000,
        1px 1px 0 #000000,
        -1px -1px 0 #000000,
        1px -1px 0 #000000,
        -1px 1px 0 #000000;
    line-height: 1.4;
    white-space: pre-line;
    transition: all 0.2s ease-in-out;
}

.no-data {
    font-size: 16px;
    font-weight: bold;
    color: white;
    text-shadow: 
        2px 2px 0 #000000,
        -2px -2px 0 #000000,
        2px -2px 0 #000000,
        -2px 2px 0 #000000,
        2px 0px 0 #000000,
        -2px 0px 0 #000000,
        0px 2px 0 #000000,
        0px -2px 0 #000000,
        1px 1px 0 #000000,
        -1px -1px 0 #000000,
        1px -1px 0 #000000,
        -1px 1px 0 #000000;
    text-align: center;
    padding: 40px 20px;
    transition: all 0.2s ease-in-out;
}

/* í¬ë¡œë§ˆí‚¤ ì§€ì›ì„ ìœ„í•œ íˆ¬ëª… ëª¨ë“œ */
.transparent-mode {
    background: #00FF00; /* í¬ë¡œë§ˆí‚¤ ê·¸ë¦° */
}

.transparent-mode .overlay-container {
    background: rgba(0,0,0,0.9);
    border: 2px solid rgba(255,255,255,0.8);
}

/* ì—°ê²° ìƒíƒœ í‘œì‹œ */
.connection-status {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
    z-index: 9999;
}

.connected {
    background: rgba(0, 255, 0, 0.8);
    color: white;
}

.disconnected {
    background: rgba(255, 0, 0, 0.8);
    color: white;
}

.connecting {
    background: rgba(255, 255, 0, 0.8);
    color: black;
}
</style>
</head>
<body>

<div class="connection-status connecting" id="connection-status">ì—°ê²° ì¤‘...</div>

<div class="overlay-container" id="overlay-container">
    <div class="donor-content" id="donor-content">
        <div class="no-data">ì„œë²„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script>
// Socket.io ì—°ê²°
const socket = io();

let donationData = [];
let serverSettings = {};
let isTransparentMode = false;
let currentDonorText = '';

// ì—°ê²° ìƒíƒœ ê´€ë¦¬
const connectionStatus = document.getElementById('connection-status');

socket.on('connect', () => {
    console.log('ì„œë²„ì— ì—°ê²°ë¨');
    connectionStatus.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
    connectionStatus.className = 'connection-status connected';
    setTimeout(() => {
        connectionStatus.style.display = 'none';
    }, 3000);
});

socket.on('disconnect', () => {
    console.log('ì„œë²„ ì—°ê²° ëŠì–´ì§');
    connectionStatus.textContent = 'ğŸ”´ ì—°ê²° ëŠì–´ì§';
    connectionStatus.className = 'connection-status disconnected';
    connectionStatus.style.display = 'block';
});

socket.on('connect_error', () => {
    console.log('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    connectionStatus.textContent = 'âš ï¸ ì—°ê²° ì‹¤íŒ¨';
    connectionStatus.className = 'connection-status disconnected';
});

// ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
socket.on('data-updated', (data) => {
    console.log('ë°ì´í„° ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
    donationData = data.donations || [];
    serverSettings = data.settings || {};
    updateDisplay();
    applySettings();
});

socket.on('donation-added', (donation) => {
    console.log('ìƒˆ í›„ì› ì¶”ê°€:', donation);
    // ë°ì´í„°ëŠ” data-updated ì´ë²¤íŠ¸ë¡œ ê°±ì‹ ë¨
});

socket.on('settings-updated', (settings) => {
    console.log('ì„¤ì • ì—…ë°ì´íŠ¸:', settings);
    serverSettings = settings;
    applySettings();
});

function updateDisplay() {
    const donorContentEl = document.getElementById('donor-content');
    
    if (!donationData || donationData.length === 0) {
        const noDataText = 'ğŸ“‹ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤<br>ë©”ì¸ í˜ì´ì§€ì—ì„œ í›„ì›ì„ ë“±ë¡í•˜ì„¸ìš”';
        if (currentDonorText !== noDataText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                donorContentEl.innerHTML = `<div class="no-data">${noDataText}</div>`;
                applySettings(); // Apply settings to newly created element
                donorContentEl.style.opacity = '1';
                currentDonorText = noDataText;
            }, 50);
        }
        return;
    }

    // í›„ì›ìë³„ ê³„ì¢Œ í›„ì› ì´ì•¡ ê³„ì‚° (íˆ¬ë„¤ ì œì™¸)
    const donorTotals = {};

    donationData.forEach(d => {
        if (d.type === 'ê³„ì¢Œ') { // ê³„ì¢Œ í›„ì›ë§Œ ê³„ì‚°
            // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì •ì€ ì œì™¸, í›„ì›ìë³„ ì¡°ì •ì€ í¬í•¨
            if (d.donor.includes('ì¡°ì •(') && d.streamer !== 'í›„ì›ìì¡°ì •') {
                return; // ìŠ¤íŠ¸ë¦¬ë¨¸ë³„ ì¡°ì • ì œì™¸
            }
            
            // í›„ì›ìëª…ì—ì„œ (ì¡°ì •+ê¸ˆì•¡) ë¶€ë¶„ ì œê±°
            let cleanDonorName = d.donor;
            if (cleanDonorName.includes('(ì¡°ì •')) {
                cleanDonorName = cleanDonorName.replace(/\\(ì¡°ì •[^)]*\\)/g, '');
            }
            
            const amount = parseFloat(d.amount) || 0;
            donorTotals[cleanDonorName] = (donorTotals[cleanDonorName] || 0) + amount;
        }
    });

    // ê·¸ë£¹í™” ì„¤ì • (ì„œë²„ ì„¤ì • ë˜ëŠ” ê¸°ë³¸ê°’ 2)
    const groupThreshold = parseInt(serverSettings.groupThreshold) || 2;
    const amountGroups = {};
    
    for (const donor in donorTotals) {
        const amount = donorTotals[donor];
        if (amount > 0) {
            if (!amountGroups[amount]) { amountGroups[amount] = []; }
            amountGroups[amount].push(donor);
        }
    }

    // ì •ì‚°ìš”ì•½ê³¼ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ìƒì„±
    const sortedGroups = Object.entries(amountGroups).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
    
    if (sortedGroups.length === 0) {
        const noAccountText = 'ğŸ’³ ê³„ì¢Œ í›„ì› ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤';
        if (currentDonorText !== noAccountText) {
            donorContentEl.style.opacity = '0.8';
            setTimeout(() => {
                donorContentEl.innerHTML = `<div class="no-data">${noAccountText}</div>`;
                applySettings(); // Apply settings to newly created element
                donorContentEl.style.opacity = '1';
                currentDonorText = noAccountText;
            }, 50);
        }
        return;
    }
    
    const donorText = "ì‚¬ë‘í•´ìš˜â™¡<br>" + sortedGroups.map(([amount, donors]) => {
        const amountStr = `${formatAmount(parseFloat(amount))}ë§Œ`;
        if (donors.length >= groupThreshold && groupThreshold > 1) {
            return `${donors.map(d => d + 'ë‹˜').join(', ')} ${amountStr}`;
        } else {
            return donors.map(d => `${d}ë‹˜ ${amountStr}`).join('<br>');
        }
    }).join('<br>');

    // ë‚´ìš©ì´ ë°”ë€” ë•Œë§Œ ë¶€ë“œëŸ½ê²Œ ì—…ë°ì´íŠ¸
    if (currentDonorText !== donorText) {
        // ë¶€ë“œëŸ¬ìš´ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ í˜ì´ë“œ íš¨ê³¼
        donorContentEl.style.opacity = '0.8';
        
        setTimeout(() => {
            donorContentEl.innerHTML = `<div>${donorText}</div>`;
            applySettings(); // Reapply settings after content change
            donorContentEl.style.opacity = '1';
            currentDonorText = donorText;
        }, 50);
    }
}

function formatAmount(num) {
    const number = parseFloat(num);
    if (isNaN(number)) return '0';
    return parseFloat(number.toFixed(1)).toString();
}

function applySettings() {
    const fontSize = serverSettings.overlayFontSize || '16';
    const strokeWidth = serverSettings.overlayStrokeWidth || '2';
    const textAlign = serverSettings.overlayTextAlign || 'left';
    
    // Apply font size directly to elements for OBS compatibility
    const donorContent = document.querySelector('.donor-content');
    const noData = document.querySelector('.no-data');
    
    // Apply settings to the container for all content
    const overlayContainer = document.getElementById('overlay-container');
    if (overlayContainer) {
        overlayContainer.style.textAlign = textAlign;
        
        // ì •ë ¬ì— ë”°ë¼ ì»¨í…Œì´ë„ˆ ìœ„ì¹˜ ì¡°ì •
        if (textAlign === 'right') {
            overlayContainer.style.marginLeft = 'auto';
            overlayContainer.style.marginRight = '0';
        } else if (textAlign === 'center') {
            overlayContainer.style.marginLeft = 'auto';
            overlayContainer.style.marginRight = 'auto';
        } else {
            overlayContainer.style.marginLeft = '0';
            overlayContainer.style.marginRight = 'auto';
        }
    }
    
    if (donorContent) {
        donorContent.style.fontSize = fontSize + 'px';
        updateTextShadow(donorContent, strokeWidth);
    }
    if (noData) {
        noData.style.fontSize = fontSize + 'px';
        updateTextShadow(noData, strokeWidth);
    }
}

function updateTextShadow(element, strokeWidth) {
    const sw = strokeWidth + 'px';
    // ë” ì™„ì „í•œ ì™¸ê³½ì„ ì„ ìœ„í•œ 12ë°©í–¥ ê·¸ë¦¼ì
    const textShadow = `
        ${sw} ${sw} 0 #000000,
        -${sw} -${sw} 0 #000000,
        ${sw} -${sw} 0 #000000,
        -${sw} ${sw} 0 #000000,
        ${sw} 0px 0 #000000,
        -${sw} 0px 0 #000000,
        0px ${sw} 0 #000000,
        0px -${sw} 0 #000000,
        ${Math.round(parseFloat(strokeWidth) * 0.7)}px ${Math.round(parseFloat(strokeWidth) * 0.7)}px 0 #000000,
        -${Math.round(parseFloat(strokeWidth) * 0.7)}px -${Math.round(parseFloat(strokeWidth) * 0.7)}px 0 #000000,
        ${Math.round(parseFloat(strokeWidth) * 0.7)}px -${Math.round(parseFloat(strokeWidth) * 0.7)}px 0 #000000,
        -${Math.round(parseFloat(strokeWidth) * 0.7)}px ${Math.round(parseFloat(strokeWidth) * 0.7)}px 0 #000000`;
    element.style.textShadow = textShadow;
}

function toggleTransparent() {
    isTransparentMode = !isTransparentMode;
    document.body.classList.toggle('transparent-mode', isTransparentMode);
    
    if (isTransparentMode) {
        document.body.style.background = '#00FF00'; // í¬ë¡œë§ˆí‚¤ ê·¸ë¦°
    } else {
        document.body.style.background = 'transparent';
    }
}

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', (e) => {
    switch(e.key) {
        case 'F5':
        case 'r':
        case 'R':
            e.preventDefault();
            // ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ìš”ì²­
            socket.emit('request-data');
            break;
        case 't':
        case 'T':
            toggleTransparent();
            break;
    }
});

// ì´ˆê¸°í™”
console.log('ì‹¤ì‹œê°„ í›„ì›ì ì˜¤ë²„ë ˆì´ ì‹œì‘ë¨');
</script>
</body>
</html>