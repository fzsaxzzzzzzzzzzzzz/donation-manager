<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì‹¤ì‹œê°„ í›„ì›ìë³„ ì´ì•¡ ì˜¤ë²„ë ˆì´</title>

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<style>
body {
    margin: 0;
    padding: 0 10px 0 0;
    background: transparent;
    font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    color: white;
    overflow: hidden;
}

.overlay-container {
    background: transparent;
    max-width: none;
    width: calc(100% - 10px);
    transition: all 0.3s ease-in-out;
}

.donor-content {
    font-size: var(--overlay-font-size, 16px);
    font-weight: bold;
    color: white;
    text-shadow: 
        var(--overlay-stroke-width, 2px) var(--overlay-stroke-width, 2px) 0 #000000,
        calc(-1 * var(--overlay-stroke-width, 2px)) calc(-1 * var(--overlay-stroke-width, 2px)) 0 #000000,
        var(--overlay-stroke-width, 2px) calc(-1 * var(--overlay-stroke-width, 2px)) 0 #000000,
        calc(-1 * var(--overlay-stroke-width, 2px)) var(--overlay-stroke-width, 2px) 0 #000000,
        var(--overlay-stroke-width, 2px) 0px 0 #000000,
        calc(-1 * var(--overlay-stroke-width, 2px)) 0px 0 #000000,
        0px var(--overlay-stroke-width, 2px) 0 #000000,
        0px calc(-1 * var(--overlay-stroke-width, 2px)) 0 #000000;
    line-height: 1.4;
    white-space: pre-line;
    padding: 0;
    transition: all 0.2s ease-in-out;
    text-align: var(--overlay-text-align, left);
}

.no-data {
    font-size: var(--overlay-font-size, 16px);
    font-weight: bold;
    color: white;
    text-shadow: 
        var(--overlay-stroke-width, 2px) var(--overlay-stroke-width, 2px) 0 #000000,
        calc(-1 * var(--overlay-stroke-width, 2px)) calc(-1 * var(--overlay-stroke-width, 2px)) 0 #000000,
        var(--overlay-stroke-width, 2px) calc(-1 * var(--overlay-stroke-width, 2px)) 0 #000000,
        calc(-1 * var(--overlay-stroke-width, 2px)) var(--overlay-stroke-width, 2px) 0 #000000;
    text-align: center;
    padding: 20px 0;
}

.donor-item {
    margin-bottom: 8px;
    animation: slideIn 0.5s ease-out;
}

.donor-amount {
    color: #FFD700;
}

.new-donation {
    animation: highlightNew 2s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes highlightNew {
    0% { background: rgba(255, 215, 0, 0.3); }
    50% { background: rgba(255, 215, 0, 0.6); }
    100% { background: transparent; }
}

.connection-indicator {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #42b72a;
    z-index: 1000;
    animation: pulse 2s infinite;
}

.connection-indicator.disconnected {
    background: #fa383e;
    animation: none;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
</style>
</head>
<body>

<div class="overlay-container">
    <div class="donor-content" id="donorContent">
        <div class="no-data">ì‹¤ì‹œê°„ ì—°ê²° ì¤‘...</div>
    </div>
</div>

<div class="connection-indicator" id="connectionIndicator"></div>

<script>
class RealtimeOverlay {
    constructor() {
        this.socket = io();
        this.data = null;
        this.settings = {};
        this.isConnected = false;
        this.previousDonorTotals = new Map();
        
        this.initializeSocketEvents();
        this.updateConnectionStatus();
    }

    initializeSocketEvents() {
        this.socket.on('connect', () => {
            this.isConnected = true;
            this.updateConnectionStatus();
            console.log('ì‹¤ì‹œê°„ ì„œë²„ì— ì—°ê²°ë¨');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.updateConnectionStatus();
            this.showNoConnection();
        });

        this.socket.on('initialData', (data) => {
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] initialData ìˆ˜ì‹ :', data);
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] í›„ì› ë°ì´í„° ìˆ˜:', data?.donations?.length || 0);
            this.data = data;
            this.settings = data.settings || {};
            this.applySettings();
            this.renderDonorTotals();
            console.log('âœ… [ì˜¤ë²„ë ˆì´] initialData ì²˜ë¦¬ ì™„ë£Œ');
        });

        this.socket.on('dataUpdate', (data) => {
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] dataUpdate ìˆ˜ì‹ :', data);
            console.log('ğŸ”„ [ì˜¤ë²„ë ˆì´] í›„ì› ë°ì´í„° ìˆ˜:', data?.donations?.length || 0);
            const previousData = this.data;
            this.data = data;
            this.renderDonorTotals(previousData);
            console.log('âœ… [ì˜¤ë²„ë ˆì´] dataUpdate ì²˜ë¦¬ ì™„ë£Œ');
        });

        this.socket.on('settingsUpdate', (settings) => {
            console.log('âš™ï¸ [ì˜¤ë²„ë ˆì´] settingsUpdate ìˆ˜ì‹ :', settings);
            this.settings = settings;
            this.applySettings();
            this.renderDonorTotals();
        });
    }

    updateConnectionStatus() {
        const indicator = document.getElementById('connectionIndicator');
        
        if (this.isConnected) {
            indicator.classList.remove('disconnected');
        } else {
            indicator.classList.add('disconnected');
        }
    }

    applySettings() {
        const root = document.documentElement;
        
        // CSS ë³€ìˆ˜ ì„¤ì •
        root.style.setProperty('--overlay-font-size', (this.settings['overlay-font-size'] || 16) + 'px');
        root.style.setProperty('--overlay-stroke-width', (this.settings['overlay-stroke-width'] || 2) + 'px');
        root.style.setProperty('--overlay-text-align', this.settings['overlay-text-align'] || 'left');
    }

    renderDonorTotals(previousData = null) {
        console.log('ğŸ¨ [ì˜¤ë²„ë ˆì´] renderDonorTotals ì‹œì‘');
        console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] this.data:', this.data);
        console.log('ğŸ“Š [ì˜¤ë²„ë ˆì´] donations ìˆ˜:', this.data?.donations?.length || 0);
        
        if (!this.data || !this.data.donations) {
            console.log('âš ï¸ [ì˜¤ë²„ë ˆì´] ë°ì´í„° ì—†ìŒ, showNoData í˜¸ì¶œ');
            this.showNoData();
            return;
        }

        // í›„ì›ìë³„ ì´ì•¡ ê³„ì‚°
        const donorTotals = this.calculateDonorTotals();
        console.log('ğŸ’° [ì˜¤ë²„ë ˆì´] ê³„ì‚°ëœ í›„ì›ì ì´ì•¡:', donorTotals);
        
        if (donorTotals.size === 0) {
            console.log('âš ï¸ [ì˜¤ë²„ë ˆì´] í›„ì›ì ì´ì•¡ ì—†ìŒ, showNoData í˜¸ì¶œ');
            this.showNoData();
            return;
        }

        // ì´ì „ ë°ì´í„°ì™€ ë¹„êµí•´ì„œ ìƒˆë¡œìš´ í›„ì› ê°ì§€
        const newDonations = this.detectNewDonations(previousData);
        console.log('ğŸ†• [ì˜¤ë²„ë ˆì´] ìƒˆë¡œìš´ í›„ì›:', newDonations);
        
        this.displayDonorTotals(donorTotals, newDonations);
        console.log('âœ… [ì˜¤ë²„ë ˆì´] renderDonorTotals ì™„ë£Œ');
    }

    calculateDonorTotals() {
        const totals = new Map();
        
        this.data.donations.forEach(donation => {
            const current = totals.get(donation.donor) || 0;
            totals.set(donation.donor, current + donation.amount);
        });

        // ê¸ˆì•¡ ìˆœìœ¼ë¡œ ì •ë ¬
        return new Map([...totals.entries()].sort((a, b) => b[1] - a[1]));
    }

    detectNewDonations(previousData) {
        if (!previousData || !previousData.donations) return new Set();
        
        const newDonationIds = new Set();
        const previousDonationTimes = new Set(
            previousData.donations.map(d => d.time)
        );
        
        this.data.donations.forEach(donation => {
            if (!previousDonationTimes.has(donation.time)) {
                newDonationIds.add(donation.donor);
            }
        });
        
        return newDonationIds;
    }

    displayDonorTotals(donorTotals, newDonations) {
        const container = document.getElementById('donorContent');
        
        let content = '';
        let index = 1;
        
        for (const [donor, total] of donorTotals) {
            const isNew = newDonations.has(donor);
            const newClass = isNew ? ' new-donation' : '';
            
            content += `<div class="donor-item${newClass}">`;
            content += `${index}. ${donor}: `;
            content += `<span class="donor-amount">â‚©${total.toLocaleString()}</span>`;
            content += `</div>`;
            
            index++;
        }
        
        container.innerHTML = content;
        
        // ìƒˆ í›„ì›ì´ ìˆìœ¼ë©´ ìŠ¤í¬ë¡¤ì„ ìœ„ë¡œ
        if (newDonations.size > 0) {
            window.scrollTo(0, 0);
        }
    }

    showNoData() {
        const container = document.getElementById('donorContent');
        container.innerHTML = '<div class="no-data">ì•„ì§ í›„ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    showNoConnection() {
        const container = document.getElementById('donorContent');
        container.innerHTML = '<div class="no-data">ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤...</div>';
    }
}

// URL íŒŒë¼ë¯¸í„° í™•ì¸ (í…ŒìŠ¤íŠ¸ìš©)
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// ì•± ì‹œì‘
document.addEventListener('DOMContentLoaded', () => {
    // í…ŒìŠ¤íŠ¸ ëª¨ë“œ í™•ì¸
    const testMode = getUrlParameter('test') === '1';
    if (testMode) {
        console.log('í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.');
    }
    
    window.overlay = new RealtimeOverlay();
});

// OBSì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ ì œê³µ
window.refreshOverlay = () => {
    if (window.overlay && window.overlay.data) {
        window.overlay.renderDonorTotals();
    }
};
</script>

</body>
</html>